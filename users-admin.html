<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>User Admin ‚Äì Mostlane Portal</title>
  <script src="auth.js"></script>
  <style>
    body {
      font-family: "Segoe UI", sans-serif;
      background: #e6e8eb url('Mostlane_Embossed.png') no-repeat center center fixed;
      background-size: cover;
      margin: 0;
      padding: 30px;
      color: #1f2937;
    }
    h2 {
      text-align: center;
      color: #003366;
    }
    table.user-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      background: rgba(255,255,255,0.9);
      font-size: 14px;
    }
    table.user-table th, table.user-table td {
      border: 1px solid #ccc;
      padding: 8px;
      text-align: center;
    }
    table.user-table th {
      background-color: #004a99;
      color: white;
    }
    .controls {
      margin-top: 15px;
      text-align: center;
    }
    button {
      background-color: #004a99;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 6px;
      font-size: 15px;
      cursor: pointer;
      margin: 4px;
    }
    button:hover { opacity: 0.9; }

    /* Toggle switch */
    .switch {
      position: relative;
      display: inline-block;
      width: 38px;
      height: 20px;
    }
    .switch input { opacity: 0; width: 0; height: 0; }
    .slider {
      position: absolute;
      cursor: pointer;
      top: 0; left: 0; right: 0; bottom: 0;
      background-color: #ccc;
      transition: .3s;
      border-radius: 20px;
    }
    .slider:before {
      position: absolute;
      content: "";
      height: 16px;
      width: 16px;
      left: 2px;
      bottom: 2px;
      background-color: white;
      transition: .3s;
      border-radius: 50%;
    }
    input:checked + .slider { background-color: #004a99; }
    input:checked + .slider:before { transform: translateX(18px); }

    /* Add-user form */
    .add-user {
      background: rgba(255,255,255,0.8);
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
      text-align: center;
    }
    .add-user input {
      padding: 6px;
      margin: 4px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
  </style>
</head>
<body>
  <h2>Users Admin Panel</h2>

  <!-- ‚úÖ Add New User Section -->
  <div class="add-user">
    <h3>Add New User</h3>
    <input type="text" id="newFirstName" placeholder="First Name">
    <input type="text" id="newLastName" placeholder="Last Name">
    <input type="text" id="newUsername" placeholder="Username (e.g. Jamie.Line)">
    <input type="email" id="newEmail" placeholder="Email">
    <input type="password" id="newPassword" placeholder="Password">
    <select id="newEmployment">
      <option value="Employed">Employed</option>
      <option value="Self Employed">Self Employed</option>
    </select>
    <button id="addUserBtn">‚ûï Add User</button>
  </div>

  <!-- ‚úÖ User Table -->
  <table class="user-table" id="usersTable">
    <thead>
      <tr>
        <th>Username</th>
        <th>Status</th>
        <th>Full Access</th>
        <th>Purchase Orders</th>
        <th>Check In/Out</th>
        <th>Holiday</th>
        <th>Forms</th>
        <th>Assets</th>
        <th>Add Site</th>
        <th>Compliance</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <div class="controls">
    <button id="saveBtn">üíæ Save Changes to KV</button>
    <p id="saveStatus" style="margin-top:10px;font-weight:bold;color:#004a99;"></p>
  </div>

  <script>
    const USERS_URL = "https://mostlane-users.jamie-def.workers.dev/users";
    const SAVE_URL = "https://mostlane-users.jamie-def.workers.dev/save";
    let usersData = [];

    // Hash helper
    async function hashPassword(password) {
      const enc = new TextEncoder();
      const data = enc.encode(password.trim());
      const hashBuffer = await crypto.subtle.digest('SHA-256', data);
      return Array.from(new Uint8Array(hashBuffer))
        .map(b => b.toString(16).padStart(2, '0'))
        .join('');
    }

    function makeToggle(value) {
      const checked = (value || "").toLowerCase() === "yes";
      return `
        <td>
          <label class="switch">
            <input type="checkbox" ${checked ? "checked" : ""}>
            <span class="slider"></span>
          </label>
        </td>
      `;
    }

    async function loadUsers() {
      const res = await fetch(USERS_URL + '?v=' + Date.now());
      const data = await res.json();
      usersData = data.Users;
      const tbody = document.querySelector('#usersTable tbody');
      tbody.innerHTML = "";

      usersData.forEach((user, index) => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${user.Username}</td>
          <td>
            <select>
              <option value="Active" ${user.Status === "Active" ? "selected" : ""}>Active</option>
              <option value="Not Active" ${user.Status === "Not Active" ? "selected" : ""}>Not Active</option>
            </select>
          </td>
          ${makeToggle(user.FullAccess)}
          ${makeToggle(user.PurchaseOrders)}
          ${makeToggle(user.CheckInOut)}
          ${makeToggle(user.Holiday)}
          ${makeToggle(user.Forms)}
          ${makeToggle(user.Assets)}
          ${makeToggle(user.AddSite)}
          ${makeToggle(user.Compliance)}
        `;
        tbody.appendChild(row);
      });
    }

    async function saveUsers() {
      const rows = document.querySelectorAll('#usersTable tbody tr');
      rows.forEach((row, i) => {
        const selects = row.querySelectorAll('select');
        const switches = row.querySelectorAll('input[type="checkbox"]');
        usersData[i].Status = selects[0].value;
        usersData[i].FullAccess = switches[0].checked ? "Yes" : "No";
        usersData[i].PurchaseOrders = switches[1].checked ? "Yes" : "No";
        usersData[i].CheckInOut = switches[2].checked ? "Yes" : "No";
        usersData[i].Holiday = switches[3].checked ? "Yes" : "No";
        usersData[i].Forms = switches[4].checked ? "Yes" : "No";
        usersData[i].Assets = switches[5].checked ? "Yes" : "No";
        usersData[i].AddSite = switches[6].checked ? "Yes" : "No";
        usersData[i].Compliance = switches[7].checked ? "Yes" : "No";
      });

      const payload = JSON.stringify({ Users: usersData });
      const res = await fetch(SAVE_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: payload
      });

      const result = await res.json();
      document.getElementById("saveStatus").textContent = result.ok ? "‚úÖ Saved successfully!" : "‚ùå Failed to save.";
    }

    async function addNewUser() {
      const first = document.getElementById("newFirstName").value.trim();
      const last = document.getElementById("newLastName").value.trim();
      const username = document.getElementById("newUsername").value.trim();
      const email = document.getElementById("newEmail").value.trim();
      const password = document.getElementById("newPassword").value.trim();
      const employment = document.getElementById("newEmployment").value;

      if (!first || !last || !username || !password) {
        alert("Please fill in all required fields.");
        return;
      }

      const hashed = await hashPassword(password);

      const newUser = {
        EngineerNumber: (usersData.length + 1).toString(),
        FirstName: first,
        LastName: last,
        Username: username,
        Email: email,
        HashedPassword: hashed,
        VehicleAssigned: "",
        EmploymentType: employment,
        Status: "Active",
        FullAccess: "No",
        PurchaseOrders: "No",
        CheckInOut: "No",
        Holiday: "No",
        Forms: "No",
        Assets: "No",
        AddSite: "No",
        MyDocuments: "No",
        Compliance: "No",
        HoursDashboard: "No",
        SharePointPath: ""
      };

      usersData.push(newUser);
      await saveUsers();
      await loadUsers();

      document.getElementById("saveStatus").textContent = "‚úÖ New user added & saved.";
      document.getElementById("newFirstName").value = "";
      document.getElementById("newLastName").value = "";
      document.getElementById("newUsername").value = "";
      document.getElementById("newEmail").value = "";
      document.getElementById("newPassword").value = "";
    }

    document.getElementById("saveBtn").addEventListener("click", saveUsers);
    document.getElementById("addUserBtn").addEventListener("click", addNewUser);

    // Restrict access ‚Äì only Jamie.Line can load this page
    if (sessionStorage.getItem("mostlaneUser") !== "Jamie.Line") {
      document.body.innerHTML = "<h2 style='color:red;text-align:center;margin-top:50px;'>Access Denied</h2>";
    } else {
      loadUsers();
    }
  </script>
</body>
</html>
