<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Mostlane – Users Admin</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    :root { --ml-blue:#004a99; --ml-blue-2:#0066cc; }
    body {
      margin:0;
      font-family:"Segoe UI", system-ui, Arial, sans-serif;
      color:#1f2937;
      background:#e6e8eb url('Mostlane_Embossed.png') no-repeat center center fixed;
      background-size:180%;
    }
    /* Fixed translucent top bar */
    .topbar {
      position:fixed; top:0; left:0; right:0; z-index:1000;
      backdrop-filter: blur(8px);
      background: rgba(255,255,255,0.6);
      border-bottom: 1px solid rgba(0,0,0,0.08);
      display:flex; align-items:center; justify-content:space-between;
      padding:10px 12px;
    }
    .topbar .title { font-weight:700; color:var(--ml-blue); }
    .topbar .actions { display:flex; gap:8px; }
    .btn {
      border:none; border-radius:8px; padding:10px 14px; cursor:pointer;
      color:#fff; background:var(--ml-blue);
    }
    .btn.secondary { background: #245caa; }
    .btn.ghost { background:transparent; color:var(--ml-blue); border:1px solid var(--ml-blue); }
    .btn:disabled { opacity:.6; cursor:not-allowed; }

    .wrap {
      padding:90px 14px 24px;
      max-width:1100px; margin:0 auto;
    }

    /* Card for user row */
    .user-card {
      background: rgba(255,255,255,0.6);
      border-radius:10px; padding:14px;
      margin:10px 0;
      box-shadow:0 2px 10px rgba(0,0,0,0.05);
    }
    .user-head {
      display:flex; flex-wrap:wrap; gap:10px; align-items:center; justify-content:space-between;
      border-bottom:1px dashed rgba(0,0,0,0.1); padding-bottom:10px; margin-bottom:10px;
    }
    .user-id {
      font-weight:700; color:#0f172a; display:flex; flex-wrap:wrap; gap:10px; align-items:center;
    }
    .pill {
      background: rgba(0,74,153,0.08); color:var(--ml-blue);
      border:1px solid rgba(0,74,153,0.25);
      border-radius:999px; padding:4px 10px; font-size:12px;
    }
    .grid {
      display:grid; gap:10px;
      grid-template-columns: repeat(2, minmax(0,1fr));
    }
    @media (max-width: 720px) {
      .grid { grid-template-columns: 1fr; }
    }

    .field {
      display:flex; flex-direction:column; gap:6px;
      background: rgba(255,255,255,0.6); border:1px solid rgba(0,0,0,0.06);
      border-radius:8px; padding:10px;
    }
    .field label { font-size:12px; color:#475569; }
    .field input, .field select {
      border:1px solid #cbd5e1; border-radius:6px; padding:10px;
      font-size:14px; background:#fff; width:100%;
    }

    /* Toggle switch */
    .toggle {
      position:relative; width:48px; height:26px; flex:0 0 auto;
    }
    .toggle input { display:none; }
    .slider {
      position:absolute; cursor:pointer; inset:0;
      background:#cbd5e1; border-radius:999px; transition:.2s;
    }
    .slider:before {
      content:""; position:absolute; height:20px; width:20px; left:3px; top:3px;
      background:#fff; border-radius:50%; transition:.2s;
      box-shadow:0 1px 3px rgba(0,0,0,0.24);
    }
    .toggle input:checked + .slider { background:var(--ml-blue-2); }
    .toggle input:checked + .slider:before { transform:translateX(22px); }

    .perm-grid {
      display:grid; gap:8px;
      grid-template-columns: repeat(3, minmax(0,1fr));
      margin-top:8px;
    }
    @media (max-width: 900px) { .perm-grid { grid-template-columns: repeat(2, minmax(0,1fr)); } }
    @media (max-width: 520px) { .perm-grid { grid-template-columns: 1fr; } }

    .perm {
      display:flex; align-items:center; justify-content:space-between;
      gap:8px; padding:8px 10px; border:1px solid rgba(0,0,0,0.06);
      background: rgba(255,255,255,0.6); border-radius:8px;
    }
    .perm .name { font-size:13px; color:#0f172a; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
    .hint { font-size:12px; color:#64748b; }

    /* Modal */
    .modal {
      position:fixed; inset:0; display:none; align-items:center; justify-content:center; z-index:2000;
      background:rgba(0,0,0,0.35);
      padding:18px;
    }
    .modal.open { display:flex; }
    .modal-card {
      width:100%; max-width:520px; max-height:90vh; overflow:auto;
      background:#fff; border-radius:12px; padding:16px;
    }
    .modal-head { display:flex; align-items:center; justify-content:space-between; margin-bottom:10px; }
    .modal-head h3 { margin:0; color:var(--ml-blue); }
    .spacer { height:8px; }
    .loading {
      display:flex; align-items:center; gap:8px; color:#334155; font-size:14px; padding:8px 0;
    }
    .loading .dot { width:8px; height:8px; border-radius:50%; background:#334155; animation:b 1s infinite alternate; }
    .loading .dot:nth-child(2){ animation-delay:.2s }
    .loading .dot:nth-child(3){ animation-delay:.4s }
    @keyframes b { to { transform: translateY(-3px); opacity:.5; } }
    .hr { height:1px; background:rgba(0,0,0,0.08); margin:10px 0; }

    .danger { color:#b91c1c; font-size:12px; }
    .ok { color:#166534; font-size:12px; }
  </style>
</head>
<body>

  <!-- Top bar -->
  <div class="topbar">
    <div class="title">Users</div>
    <div class="actions">
      <button id="scanBtn" class="btn ghost" title="Scan portal for new buttons">Scan Pages</button>
      <button id="addBtn" class="btn secondary">Add User</button>
      <button id="saveBtn" class="btn">Save Changes</button>
    </div>
  </div>

  <div class="wrap">
    <div id="status" class="loading" style="display:none;">
      <div class="dot"></div><div class="dot"></div><div class="dot"></div>
      <span>Scanning pages & loading users…</span>
    </div>

    <div id="guardMsg" class="danger" style="display:none;"></div>

    <div id="usersContainer"></div>
  </div>

  <!-- Add User Modal -->
  <div id="addModal" class="modal" aria-hidden="true">
    <div class="modal-card">
      <div class="modal-head">
        <h3>Add New User</h3>
        <button id="closeAdd" class="btn ghost">Close</button>
      </div>
      <div class="grid">
        <div class="field">
          <label>Engineer Number (auto)</label>
          <input id="nu_eng" type="text" readonly />
        </div>
        <div class="field">
          <label>Employment Type</label>
          <select id="nu_emp">
            <option>Employed</option>
            <option>Self Employed</option>
          </select>
        </div>
        <div class="field">
          <label>First Name</label>
          <input id="nu_first" type="text" />
        </div>
        <div class="field">
          <label>Last Name</label>
          <input id="nu_last" type="text" />
        </div>
        <div class="field">
          <label>Username (auto-suggest)</label>
          <input id="nu_user" type="text" placeholder="e.g., First.Last" />
        </div>
        <div class="field">
          <label>Email</label>
          <input id="nu_email" type="email" />
        </div>
        <div class="field">
          <label>Phone Number</label>
          <input id="nu_phone" type="tel" />
        </div>
        <div class="field">
          <label>Hourly Rate (£)</label>
          <input id="nu_rate" type="number" step="0.01" />
        </div>
        <div class="field">
          <label>Vehicle Assigned</label>
          <input id="nu_vehicle" type="text" />
        </div>
        <div class="field" style="grid-column:1/-1;">
          <label>SharePoint Path</label>
          <input id="nu_sp" type="text" placeholder="https://mostlane.sharepoint.com/..." />
        </div>
        <div class="field" style="grid-column:1/-1;">
          <label>Temporary Password (will be hashed)</label>
          <input id="nu_pass" type="password" placeholder="Enter temp password" />
        </div>
      </div>
      <div class="spacer"></div>
      <button id="nu_create" class="btn">Create User</button>
      <div class="spacer"></div>
      <div id="nu_msg" class="hint"></div>
    </div>
  </div>

<script>
/** CONFIG **/
const WORKER_GET = "https://mostlane-users.jamie-def.workers.dev/users";
const WORKER_SAVE = "https://mostlane-users.jamie-def.workers.dev/update-users";
const PORTAL_BASE = "https://portal.mostlane-portal.com/";

/** Access guard: only Jamie.Line */
(function guard(){
  const u = sessionStorage.getItem("mostlaneUser");
  if (u !== "Jamie.Line") {
    document.getElementById('guardMsg').style.display = 'block';
    document.getElementById('guardMsg').textContent =
      "Access restricted. You must be logged in as Jamie.Line to view Users Admin.";
    setTimeout(()=>window.location.href="main.html", 1400);
  }
})();

/** State */
let USERS = [];
let BUTTON_IDS = new Set(); // discovered permission keys
let FULL_PERM_KEY = "FullAccess";

/** UI Helpers */
const $ = sel => document.querySelector(sel);
function showLoading(on=true){
  $('#status').style.display = on ? 'flex' : 'none';
}
function toastOK(msg){ $('#status').innerHTML = `<span class="ok">${msg}</span>`; $('#status').style.display='block'; setTimeout(()=>$('#status').style.display='none',1500); }
function toastERR(msg){ $('#status').innerHTML = `<span class="danger">${msg}</span>`; $('#status').style.display='block'; }

/** Password hash */
async function sha256(text){
  const buf = new TextEncoder().encode((text||"").trim());
  const digest = await crypto.subtle.digest("SHA-256", buf);
  return Array.from(new Uint8Array(digest)).map(b=>b.toString(16).padStart(2,'0')).join('');
}

/** Fetch Users */
async function loadUsers(){
  const r = await fetch(WORKER_GET + "?v=" + Date.now());
  if(!r.ok) throw new Error("Failed to load users");
  const data = await r.json();
  USERS = (data && data.Users) ? data.Users : [];
}

/** Crawl portal to find .html pages (same-origin), then collect <a>/<button> ids */
async function discoverButtons(){
  // start with main.html
  const visited = new Set();
  const queue = [ "main.html" ];
  const pageHrefs = new Set(["main.html"]);

  async function fetchPage(rel){
    const url = new URL(rel, PORTAL_BASE).toString();
    if(visited.has(url)) return;
    visited.add(url);
    try{
      const res = await fetch(url, { mode:'cors' });
      if(!res.ok) return;
      const html = await res.text();
      // collect ids from <a> and <button>
      const ids = Array.from(html.matchAll(/<(a|button)\b[^>]*\sid\s*=\s*["']([^"']+)["']/gi)).map(m=>m[2].trim());
      ids.forEach(id => {
        // don't include empty or generic items
        if(id && id.length < 120) BUTTON_IDS.add(id);
      });
      // crawl more links within same origin, limit to .html
      const links = Array.from(html.matchAll(/\shref\s*=\s*["']([^"']+)["']/gi)).map(m=>m[1]);
      links.forEach(href=>{
        try{
          const u = new URL(href, PORTAL_BASE);
          if(u.origin === new URL(PORTAL_BASE).origin && u.pathname.endsWith(".html")){
            const relPath = u.pathname.split("/").pop(); // only file
            if(!pageHrefs.has(relPath)) {
              pageHrefs.add(relPath);
              queue.push(relPath);
            }
          }
        }catch(e){}
      });
    }catch(e){ /* ignore CORS errors silently */ }
  }

  // breadth-limited crawl
  const LIMIT = 40;
  let steps = 0;
  while(queue.length && steps<LIMIT){
    const next = queue.shift();
    await fetchPage(next);
    steps++;
  }

  // Always include hard-known keys your main page logic already expects
  ["checkinBtn","holidayBtn","purchaseBtn","assetsBtn","my-documents-btn","weeklyBtn","formsBtn","complianceBtn","hours-dashboard-btn","poMenuBtn","usersAdminBtn"].forEach(id=>BUTTON_IDS.add(id));
}

/** Render Users */
function render(){
  const box = $('#usersContainer');
  box.innerHTML = "";
  // Sort by EngineerNumber (numeric if possible)
  USERS.sort((a,b)=> (parseInt(a.EngineerNumber||0)||0) - (parseInt(b.EngineerNumber||0)||0));
  USERS.forEach((u, idx)=>{
    const card = document.createElement('div');
    card.className = "user-card";
    card.dataset.index = idx;

    const name = `${u.FirstName||""} ${u.LastName||""}`.trim() || u.Username || '(No name)';
    const eng = u.EngineerNumber || "";
    const status = (u.Status||"").toLowerCase() || "active";
    const full = (u[FULL_PERM_KEY]||"No").toString().toLowerCase() === "yes";

    card.innerHTML = `
      <div class="user-head">
        <div class="user-id">
          <span>${name}</span>
          <span class="pill">#${eng || "—"}</span>
          <span class="pill">${u.Username||""}</span>
          <span class="pill" style="border-color:${status==='active'?'#16a34a':'#b91c1c'}; background:${status==='active'?'rgba(22,163,74,.08)':'rgba(185,28,28,.08)'}; color:${status==='active'?'#166534':'#b91c1c'}">
            ${status === 'active' ? 'Active' : 'Not Active'}
          </span>
          <span class="pill" style="border-color:${full?'#2563eb':'#94a3b8'}; color:${full?'#1d4ed8':'#475569'}; background:${full?'rgba(37,99,235,.08)':'rgba(148,163,184,.12)'}">
            Full Access: ${full ? 'On' : 'Off'}
          </span>
        </div>
      </div>
      <div class="grid">
        <div class="field">
          <label>First Name</label>
          <input data-k="FirstName" value="${u.FirstName||''}">
        </div>
        <div class="field">
          <label>Last Name</label>
          <input data-k="LastName" value="${u.LastName||''}">
        </div>
        <div class="field">
          <label>Username</label>
          <input data-k="Username" value="${u.Username||''}">
        </div>
        <div class="field">
          <label>Email</label>
          <input data-k="Email" type="email" value="${u.Email||''}">
        </div>
        <div class="field">
          <label>Phone Number</label>
          <input data-k="PhoneNumber" value="${u.PhoneNumber||''}">
        </div>
        <div class="field">
          <label>Hourly Rate (£)</label>
          <input data-k="HourlyRate" type="number" step="0.01" value="${u.HourlyRate||''}">
        </div>
        <div class="field">
          <label>Engineer Number</label>
          <input data-k="EngineerNumber" value="${u.EngineerNumber||''}">
        </div>
        <div class="field">
          <label>Employment Type</label>
          <select data-k="EmploymentType">
            <option ${u.EmploymentType==='Employed'?'selected':''}>Employed</option>
            <option ${u.EmploymentType==='Self Employed'?'selected':''}>Self Employed</option>
          </select>
        </div>
        <div class="field">
          <label>Vehicle Assigned</label>
          <input data-k="VehicleAssigned" value="${u.VehicleAssigned||''}">
        </div>
        <div class="field" style="grid-column:1/-1;">
          <label>SharePoint Path</label>
          <input data-k="SharePointPath" value="${u.SharePointPath||''}">
        </div>
        <div class="field">
          <label>Status</label>
          <select data-k="Status">
            <option ${ (u.Status||'').toLowerCase()==='active' ? 'selected':'' }>Active</option>
            <option ${ (u.Status||'').toLowerCase()==='not active' ? 'selected':'' }>Not Active</option>
          </select>
        </div>
        <div class="field">
          <label>Full Access</label>
          <div class="perm" style="justify-content:flex-start; gap:12px;">
            <span class="name">Enabled</span>
            <label class="toggle">
              <input data-k="${FULL_PERM_KEY}" type="checkbox" ${full?'checked':''}>
              <span class="slider"></span>
            </label>
          </div>
          <div class="hint">When Full Access is ON, all buttons are shown (including Users Admin).</div>
        </div>
      </div>
      <div class="hr"></div>
      <div class="hint">Button Visibility</div>
      <div class="perm-grid">
        ${[...BUTTON_IDS].sort().map(key=>{
          const v = (u[key]||'No').toString().toLowerCase()==='yes';
          return `
            <div class="perm" data-perm="${key}">
              <span class="name">${key}</span>
              <label class="toggle">
                <input type="checkbox" ${v?'checked':''} data-perm="${key}">
                <span class="slider"></span>
              </label>
            </div>
          `;
        }).join('')}
      </div>
      <div class="hr"></div>
      <div class="field">
        <label>Set/Reset Password (optional)</label>
        <input type="password" placeholder="Enter new password to change (leave blank to keep existing)" data-k="__SetPassword">
      </div>
    `;
    box.appendChild(card);
  });
}

/** Save all changes with merge */
async function saveAll(){
  // Build payload
  const out = { Users: [] };
  document.querySelectorAll('.user-card').forEach(card=>{
    const idx = parseInt(card.dataset.index,10);
    const src = USERS[idx] || {};
    const obj = { ...src }; // start from existing (so we don't drop unrendered fields)

    // profile fields
    card.querySelectorAll('[data-k]').forEach(inp=>{
      const key = inp.getAttribute('data-k');
      let val = (inp.value||'').trim();
      if(key === FULL_PERM_KEY){
        val = (inp.checked ? "Yes" : "No");
      }
      if(key === "__SetPassword"){
        // handled after
      }else{
        obj[key] = val;
      }
    });

    // password hashing if provided
    const pass = card.querySelector('[data-k="__SetPassword"]')?.value || "";
    if(pass.trim()){
      // store to HashedPassword
      obj.HashedPassword = ""; // placeholder until hashed
      obj.__PendingPassword = pass.trim();
    }

    // permissions from discovered buttons
    [...BUTTON_IDS].forEach(key=>{
      const chk = card.querySelector(`input[type="checkbox"][data-perm="${key}"]`);
      const on = chk ? chk.checked : false;
      obj[key] = on ? "Yes" : "No";
    });

    out.Users.push(obj);
  });

  // hash any pending passwords
  for (const u of out.Users){
    if(u.__PendingPassword){
      u.HashedPassword = await sha256(u.__PendingPassword);
      delete u.__PendingPassword;
    }
  }

  // Merge save
  const res = await fetch(WORKER_SAVE, {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify(out)
  });
  if(!res.ok){
    const t = await res.text();
    throw new Error("Save failed: " + t);
  }
}

/** Add user modal helpers */
function openAdd(){ $('#addModal').classList.add('open'); }
function closeAdd(){ $('#addModal').classList.remove('open'); }

function nextEngineerNumber(){
  const nums = USERS.map(u=>parseInt(u.EngineerNumber||0,10)).filter(n=>!isNaN(n));
  const max = nums.length ? Math.max(...nums) : 0;
  return String(max + 1);
}

function autosuggestUsername(first,last){
  const f = (first||"").trim().replace(/\s+/g,'');
  const l = (last||"").trim().replace(/\s+/g,'');
  if(!f && !l) return "";
  return `${f}.${l}`;
}

/** Event wiring */
document.getElementById('addBtn').addEventListener('click', ()=>{
  $('#nu_eng').value = nextEngineerNumber();
  $('#nu_first').value = ""; $('#nu_last').value = "";
  $('#nu_user').value = ""; $('#nu_email').value = "";
  $('#nu_phone').value = ""; $('#nu_rate').value = "";
  $('#nu_vehicle').value = ""; $('#nu_sp').value = "";
  $('#nu_pass').value = ""; $('#nu_emp').value = "Employed";
  $('#nu_msg').textContent = "";
  openAdd();
});
document.getElementById('closeAdd').addEventListener('click', closeAdd);
$('#nu_first').addEventListener('input', ()=> {
  $('#nu_user').value = autosuggestUsername($('#nu_first').value, $('#nu_last').value);
});
$('#nu_last').addEventListener('input', ()=> {
  $('#nu_user').value = autosuggestUsername($('#nu_first').value, $('#nu_last').value);
});
document.getElementById('nu_create').addEventListener('click', async ()=>{
  const msg = $('#nu_msg');
  msg.textContent = "";
  const eng = $('#nu_eng').value.trim();
  const emp = $('#nu_emp').value.trim();
  const first = $('#nu_first').value.trim();
  const last = $('#nu_last').value.trim();
  const user = $('#nu_user').value.trim();
  const email = $('#nu_email').value.trim();
  const phone = $('#nu_phone').value.trim();
  const rate = $('#nu_rate').value.trim();
  const veh = $('#nu_vehicle').value.trim();
  const sp = $('#nu_sp').value.trim();
  const pass = $('#nu_pass').value;

  if(!first || !last || !user){
    msg.textContent = "First, Last and Username are required.";
    return;
  }
  const hashed = pass ? await sha256(pass) : "";

  // New user object with safe defaults
  const nu = {
    EngineerNumber: eng,
    FirstName: first,
    LastName: last,
    Username: user,
    Email: email,
    PhoneNumber: phone,
    HourlyRate: rate,
    VehicleAssigned: veh,
    EmploymentType: emp,
    Status: "Active",
    FullAccess: "No",
    SharePointPath: sp,
    HashedPassword: hashed || "",
  };

  // Initialize discovered button permissions to "No"
  [...BUTTON_IDS].forEach(k => nu[k] = "No");

  USERS.push(nu);
  render();
  msg.textContent = "User staged. Click 'Save Changes' to commit.";
});

/** Save button */
document.getElementById('saveBtn').addEventListener('click', async ()=>{
  try{
    showLoading(true);
    await saveAll();
    toastOK("Saved!");
    await loadUsers(); // reload to reflect merge output
    render();
  }catch(e){
    toastERR(e.message||"Save failed");
  }finally{
    showLoading(false);
  }
});

/** Scan button (re-scan pages to discover new buttons, then re-render) */
document.getElementById('scanBtn').addEventListener('click', async ()=>{
  try{
    showLoading(true);
    BUTTON_IDS.clear();
    await discoverButtons();
    render(); // re-render with potentially new toggles
    toastOK("Scan complete");
  }catch(e){
    toastERR("Scan error");
  }finally{
    showLoading(false);
  }
});

/** Boot */
(async function init(){
  try{
    showLoading(true);
    // 1) Discover buttons across portal (from main.html seed, crawl links)
    await discoverButtons();
    // 2) Load users
    await loadUsers();
    // 3) Render
    render();
  }catch(e){
    toastERR("Init failed");
  }finally{
    showLoading(false);
  }
})();
</script>
</body>
</html>
