<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>User Administration ‚Äì Mostlane Portal</title>
  <style>
    :root{
      --ml-blue:#004a99;
      --ml-blue-50:rgba(0,74,153,.08);
      --ink:#1f2937;
      --muted:#4b5563;
      --bg:#e6e8eb;
      --card:#fff;
      --glass:rgba(255,255,255,.75);
      --ok:#1b5e20;
      --ok-bg:#e9f7ef;
      --ok-bd:#c8e6c9;
      --err:#7f1d1d;
      --err-bg:#fee2e2;
      --err-bd:#fecaca;
      --warn:#8a5a00;
      --warn-bg:#fff6e5;
      --warn-bd:#ffe0b2;
    }
    html,body{height:100%}
    body {
      font-family: "Segoe UI", system-ui, -apple-system, Arial, sans-serif;
      background: var(--bg) url('Mostlane_Embossed.png') no-repeat center center fixed;
      background-size: cover;
      margin: 0;
      color: var(--ink);
    }

    /* Top bar */
    .topbar {
      position: sticky; top: 0; z-index: 50;
      background: var(--glass); backdrop-filter: blur(6px);
      box-shadow: 0 2px 10px rgba(0,0,0,.08);
      padding: 10px 14px;
      display: flex; align-items: center; justify-content: space-between;
      gap: 12px;
    }
    .topbar h1{margin:0; font-size:18px; color:var(--ml-blue); font-weight:600}
    .bar-actions{display:flex; gap:10px; align-items:center}
    .btn{
      border:none; border-radius:6px; padding:10px 14px; font-size:14px; cursor:pointer;
    }
    .btn-primary{background:var(--ml-blue); color:#fff}
    .btn-outline{background:#fff; color:var(--ml-blue); border:1px solid var(--ml-blue)}
    .btn-ghost{background:transparent; color:var(--ml-blue); border:1px dashed var(--ml-blue)}
    .btn:disabled{opacity:.6; cursor:not-allowed}

    .mini{
      display:inline-flex; align-items:center; gap:6px;
      font-size:12px; padding:6px 10px; border-radius:999px;
      color:var(--ml-blue); background:#fff; border:1px solid var(--ml-blue);
    }

    /* Banner */
    .banner {
      position: sticky; top: 56px; z-index: 45;
      margin: 10px 14px 0;
      border-radius:6px; padding:10px 12px; display:none;
    }
    .banner.show{display:block}
    .banner.ok{background:var(--ok-bg); border:1px solid var(--ok-bd); color:var(--ok)}
    .banner.err{background:var(--err-bg); border:1px solid var(--err-bd); color:var(--err)}
    .banner.warn{background:var(--warn-bg); border:1px solid var(--warn-bd); color:var(--warn)}
    .banner .close{float:right; cursor:pointer; margin-left:10px; font-weight:700}

    /* Wrap */
    .wrap{
      max-width: 1100px;
      margin: 16px auto 70px;
      padding: 0 14px 30px;
      background: rgba(255,255,255,.7);
      border-radius: 10px;
    }
    .subnote{padding:14px; color:#374151; font-size:14px}

    /* Utility row */
    .util {
      display:flex; flex-wrap:wrap; gap:10px; align-items:center; padding: 0 14px 10px;
    }
    .input{
      background:#fff; border:1px solid #d1d5db; border-radius:6px; padding:10px 12px; font-size:14px;
      min-width:150px;
    }
    .input:focus{outline:none; border-color:var(--ml-blue)}
    .spacer{flex:1}

    /* Cards */
    .user-card{
      background:#fff; border:1px solid #e5e7eb; border-radius:10px; margin:14px; padding:12px;
      box-shadow:0 1px 3px rgba(0,0,0,.04)
    }
    .user-header{
      display:flex; justify-content:space-between; align-items:center; gap:12px;
      color:var(--ml-blue); font-weight:600; margin-bottom:8px
    }
    .user-sub{font-size:13px; color:var(--muted); margin-bottom:6px}
    .grid{
      display:grid; grid-template-columns:repeat(2,minmax(0,1fr)); gap:8px 18px;
    }
    @media (max-width: 700px){ .grid{grid-template-columns:1fr} }

    .section-title{
      margin:10px 2px 4px; font-size:13px; font-weight:600; color:#374151;
      display:flex; align-items:center; gap:6px
    }
    .section-title .pill{
      font-size:11px; background:var(--ml-blue-50); color:var(--ml-blue);
      padding:4px 8px; border-radius:999px; border:1px solid var(--ml-blue)
    }

    .toggle-row{
      display:flex; align-items:center; justify-content:space-between; gap:12px; padding:6px 2px;
    }
    .toggle-row .lbl{font-size:14px; color:#111827; flex:1}
    .toggle-row .path{font-size:11px; color:#6b7280}
    .toggle-row.indent{ padding-left:22px; }

    .switch{ position:relative; display:inline-block; width:44px; height:24px; flex:0 0 auto }
    .switch input{display:none}
    .slider{
      position:absolute; cursor:pointer; inset:0; background:#d1d5db; border-radius:24px; transition:.25s
    }
    .slider:before{
      content:""; position:absolute; height:18px; width:18px; left:3px; bottom:3px;
      background:#fff; border-radius:50%; transition:.25s; box-shadow:0 1px 2px rgba(0,0,0,.15)
    }
    input:checked + .slider{background:var(--ml-blue)}
    input:checked + .slider:before{transform:translateX(20px)}

    /* Modal, Spinner, misc */
    .modal{ position:fixed; inset:0; background:rgba(0,0,0,.35); display:none; align-items:center; justify-content:center; z-index:60 }
    .modal.show{display:flex}
    .modal-card{ background:#fff; width:92%; max-width:480px; max-height:85vh; overflow:auto; border-radius:10px; padding:16px; box-shadow:0 10px 25px rgba(0,0,0,.15) }
    .modal h3{margin:0 0 10px; color:var(--ml-blue); font-size:18px}
    .field{margin-bottom:10px}
    .field label{display:block; font-size:12px; color:#374151; margin-bottom:4px}
    .field input{width:100%; padding:10px; border:1px solid #d1d5db; border-radius:6px; font-size:14px; background:#fff; box-sizing:border-box}
    .modal-actions{display:flex; gap:10px; justify-content:flex-end; margin-top:8px}

    .mask{ position:fixed; inset:0; display:none; align-items:center; justify-content:center; z-index:70; background:rgba(255,255,255,.55); backdrop-filter: blur(2px)}
    .mask.show{display:flex}
    .spinner{
      width:46px; height:46px; border-radius:50%; border:4px solid #c7d2fe; border-top-color: var(--ml-blue); animation:spin 1s linear infinite
    }
    @keyframes spin{ to{ transform: rotate(360deg) } }

    .small{font-size:12px; color:#6b7280}
    .kbd{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; background:#f3f4f6; border:1px solid #e5e7eb; border-radius:4px; padding:1px 4px}

    /* Submenu visibility (we toggle display via JS) */
    .submenu-row{ display:flex; }

    /* NEW: Manage Users modal layout */
    .manage-wrap{
      display:flex; gap:12px;
    }
    .manage-left{
      flex: 1;
      min-width: 240px;
    }
    .manage-right{
      flex: 1;
      min-width: 240px;
      border-left: 1px solid #e5e7eb;
      padding-left: 12px;
    }
    @media (max-width: 820px){
      .manage-wrap{flex-direction:column}
      .manage-right{border-left:none; padding-left:0; border-top:1px solid #e5e7eb; padding-top:12px}
    }
    .user-row{
      display:flex; align-items:center; justify-content:space-between;
      gap:10px; padding:10px; border:1px solid #e5e7eb; border-radius:10px; margin-bottom:8px;
      background:#fff;
    }
    .user-row .who{display:flex; flex-direction:column; gap:2px}
    .user-row .who .t{font-weight:600; color:#111827; font-size:14px}
    .user-row .who .s{font-size:12px; color:#6b7280}
    .chip{
      font-size:11px; padding:4px 8px; border-radius:999px; border:1px solid #d1d5db; background:#f9fafb; color:#374151;
    }
    .chip.active{border-color:#86efac; background:#ecfdf5; color:#166534}
    .chip.inactive{border-color:#fecaca; background:#fef2f2; color:#991b1b}
    .row-actions{display:flex; gap:8px; align-items:center}
  </style>
</head>
<body>

  <!-- Top bar -->
<div class="topbar">

  <!-- Main Menu button + title -->
  <div style="display:flex; align-items:center; gap:10px;">
    <button class="btn btn-outline" onclick="window.location.href='main.html'">
      ‚¨Ö Main Menu
    </button>
    <h1>User Administration</h1>
  </div>

  <div class="bar-actions">
    <button class="btn btn-outline" id="rescanBtn">üîç Rescan Portal</button>
    <button class="btn btn-outline" id="reloadBtn">‚ü≤ Reload Users</button>
    <button class="btn btn-primary" id="saveBtn">üíæ Save Changes</button>

    <!-- NEW: top-level Manage users button -->
    <button class="btn btn-outline" id="manageUsersBtn">üë• Manage users</button>

    <!-- Existing button retained exactly -->
    <button class="btn btn-ghost" id="addUserBtn">‚ûï Add User</button>
  </div>

</div>
  <!-- Banner -->
  <div id="banner" class="banner">
    <span class="close" id="bannerClose">‚úñ</span>
    <span id="bannerText">Status‚Ä¶</span>
  </div>

  <!-- Body -->
  <div class="wrap">
    <div class="subnote">
      This page auto-discovers buttons from <b>main.html</b> (and linked sub-menus),
      then shows matching toggles per user. <b>Full Access</b> overrides everything.
      <div class="small">
        Permissions are stored under stable keys per section, so settings will not reset even if you rename buttons or add emojis.
      </div>
    </div>

    <div class="util">

      <!-- Username dropdown -->
      <select id="userFilter" class="input" style="max-width:180px;">
        <option value="">All Users</option>
      </select>

      <input id="searchBox" class="input" placeholder="Search users (name / username / number)‚Ä¶" />
      <div class="spacer"></div>
      <span class="mini" id="structCount">Scanning‚Ä¶</span>
      <a class="mini" href="main.html" target="_blank" rel="noopener">Open main.html</a>
      <a class="mini" id="debugLink" href="https://mostlane-users.jamie-def.workers.dev/debug/bindings" target="_blank" rel="noopener">Bindings</a>
    </div>

    <div id="list">Loading users‚Ä¶</div>
  </div>

  <!-- Add User Modal (EXISTING - kept) -->
  <div id="addUserModal" class="modal" aria-hidden="true">
    <div class="modal-card">
      <h3>Add New User</h3>
      <div class="field"><label>First Name</label><input id="firstName" type="text" placeholder="First Name" required></div>
      <div class="field"><label>Last Name</label><input id="lastName" type="text" placeholder="Last Name" required></div>
      <div class="field"><label>Email (optional)</label><input id="email" type="email" placeholder="name@company.com"></div>
      <div class="field"><label>Username</label><input id="username" type="text" placeholder="e.g. John.Doe" required></div>
      <div class="field"><label>Password</label><input id="password" type="password" placeholder="Initial password" required></div>
      <div class="field"><label>Role</label><select id="role" class="input"><option value="">-- Select --</option><option value="Office">Office</option><option value="Field">Field</option></select></div>
      <div class="field"><label>Vehicle Assigned (optional)</label><input id="vehicle" type="text" placeholder="e.g. WP64 EJD"></div>
      <div class="field"><label>Employment Type</label><input id="employmentType" type="text" placeholder="Employed / Self Employed"></div>
      <div class="field"><label>SharePoint Path URL</label><input id="sharepoint" type="text" placeholder="Full SharePoint folder link"></div>
      <div class="modal-actions"><button class="btn btn-outline" id="cancelAdd">Cancel</button><button class="btn btn-primary" id="createUserBtn">Create User</button></div>
    </div>
  </div>

  <!-- Manage User Modal (EXISTING - kept) -->
  <div id="manageUserModal" class="modal" aria-hidden="true">
    <div class="modal-card">
      <h3>Manage User</h3>

      <div class="field"><label>Engineer Number</label><input id="mu_engineerNumber" type="text" disabled></div>
      <div class="field"><label>Username</label><input id="mu_username" type="text" disabled></div>

      <div class="field"><label>First Name</label><input id="mu_firstName" type="text"></div>
      <div class="field"><label>Last Name</label><input id="mu_lastName" type="text"></div>
      <div class="field"><label>Email</label><input id="mu_email" type="email"></div>
<div class="field"><label>Role</label><select id="mu_role" class="input"><option value="">-- Select --</option><option value="Office">Office</option><option value="Field">Field</option></select></div>
      <div class="field"><label>Vehicle Assigned</label><input id="mu_vehicle" type="text" placeholder="e.g. WP64 EJD"></div>
      <div class="field"><label>Employment Type</label><input id="mu_employmentType" type="text" placeholder="Employed / Self Employed"></div>
      <div class="field"><label>Status</label><input id="mu_status" type="text" placeholder="Active / Not Active"></div>
      <div class="field"><label>SharePoint Path URL</label><input id="mu_sharepoint" type="text" placeholder="Full SharePoint folder link"></div>

      <div class="field"><label>Reset Password (optional)</label><input id="mu_password" type="password" placeholder="Leave blank to keep existing"></div>

      <div class="modal-actions">
        <button class="btn btn-outline" id="cancelManage">Cancel</button>
        <button class="btn btn-primary" id="saveManageBtn">Save</button>
      </div>
    </div>
  </div>

  <!-- NEW: Manage Users Modal (first-level modal) -->
  <div id="manageUsersModal" class="modal" aria-hidden="true">
    <div class="modal-card" style="max-width: 980px;">
      <h3>Manage users</h3>

      <div class="util" style="padding:0; margin: 6px 0 10px;">
        <input id="muSearch" class="input" placeholder="Search users‚Ä¶" style="flex:1; min-width:180px;">
        <button class="btn btn-outline" id="openAddNewUserBtn">‚ûï Add New User</button>
      </div>

      <div class="manage-wrap">
        <div class="manage-left">
          <div id="muList">Loading‚Ä¶</div>
          <div class="small" style="margin-top:10px;">
            Tip: toggling <span class="kbd">Active</span> only changes that user‚Äôs <span class="kbd">Status</span> field (DELTA safe).
          </div>
        </div>

        <div class="manage-right">
          <div class="small" style="margin-bottom:8px;">Select a user to edit.</div>

          <div class="field"><label>Engineer Number</label><input id="mue_engineerNumber" type="text" disabled></div>
          <div class="field"><label>Username</label><input id="mue_username" type="text" disabled></div>

          <div class="field"><label>First Name</label><input id="mue_firstName" type="text"></div>
          <div class="field"><label>Last Name</label><input id="mue_lastName" type="text"></div>

          <!-- NEW fields (do not break existing Email) -->
          <div class="field"><label>Email Address</label><input id="mue_emailAddress" type="email" placeholder="name@mostlane.com"></div>
          <div class="field"><label>Mobile Number</label><input id="mue_mobileNumber" type="text" placeholder="07‚Ä¶"></div>

          <div class="field"><label>Vehicle Assigned</label><input id="mue_vehicle" type="text" placeholder="e.g. WP64 EJD"></div>
          <div class="field"><label>Employment Type</label><input id="mue_employmentType" type="text" placeholder="Employed / Self Employed"></div>
          <div class="field"><label>Role</label><select id="mue_role" class="input"><option value="">-- Select --</option><option value="Office">Office</option><option value="Field">Field</option></select></div>
          <div class="field"><label>SharePoint Path URL</label><input id="mue_sharepoint" type="text" placeholder="Full SharePoint folder link"></div>

          <div class="field"><label>Status</label><input id="mue_status" type="text" placeholder="Active / Not Active"></div>

          <div class="field"><label>Reset Password (optional)</label><input id="mue_password" type="password" placeholder="Leave blank to keep existing"></div>

          <div class="modal-actions">
            <button class="btn btn-outline" id="closeManageUsersBtn">Close</button>
            <button class="btn btn-primary" id="saveManageUsersBtn">Save user changes</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- NEW: Add New User modal (second-level modal) -->
  <div id="addNewUserModal" class="modal" aria-hidden="true">
    <div class="modal-card">
      <h3>Add New User</h3>

      <div class="field"><label>First Name</label><input id="anu_firstName" type="text" placeholder="First Name" required></div>
      <div class="field"><label>Last Name</label><input id="anu_lastName" type="text" placeholder="Last Name" required></div>

      <div class="field"><label>Username</label><input id="anu_username" type="text" disabled></div>

      <div class="field"><label>Password</label><input id="anu_password" type="password" placeholder="Initial password" required></div>

      <div class="field"><label>Email Address</label><input id="anu_emailAddress" type="email" placeholder="name@mostlane.com"></div>
      <div class="field"><label>Mobile Number</label><input id="anu_mobileNumber" type="text" placeholder="07‚Ä¶"></div>

      <div class="field"><label>Vehicle Assigned (optional)</label><input id="anu_vehicle" type="text" placeholder="e.g. WP64 EJD"></div>
      <div class="field"><label>Employment Type</label><input id="anu_employmentType" type="text" placeholder="Employed / Self Employed"></div>
<div class="field"><label>Role</label><select id="anu_role" class="input"><option value="">-- Select --</option><option value="Office">Office</option><option value="Field">Field</option></select></div>
      <div class="field"><label>SharePoint Path URL</label><input id="anu_sharepoint" type="text" placeholder="Full SharePoint folder link"></div>

      <div class="small" style="margin-top:8px;">
        All page permissions will be set to <span class="kbd">No</span> by default (DELTA safe).
      </div>

      <div class="modal-actions">
        <button class="btn btn-outline" id="anu_cancel">Cancel</button>
        <button class="btn btn-primary" id="anu_create">Create User</button>
      </div>
    </div>
  </div>

  <div class="mask" id="mask"><div class="spinner" aria-label="Loading"></div></div>

  <script>
        const API_BASE = "https://mostlane-users.jamie-def.workers.dev";
    const USERS_URL = API_BASE + "/users";
    const SAVE_URL  = API_BASE + "/save";
    const SAVE_DELTA_URL = API_BASE + "/save-delta";
    const TOKEN     = sessionStorage.getItem("mostlaneToken");
    const CURRENT   = sessionStorage.getItem("mostlaneUser");
    if (!CURRENT) { window.location.href = "login.html"; }

    const banner = document.getElementById('banner');
    const bannerText = document.getElementById('bannerText');
    const bannerClose = document.getElementById('bannerClose');
    const mask = document.getElementById('mask');
    const list = document.getElementById('list');
    const structCount = document.getElementById('structCount');
    const userFilter = document.getElementById('userFilter');
    const searchBox = document.getElementById('searchBox');

    function showMask(on=true){mask.classList.toggle('show',!!on);}
    function showBanner(msg,type='ok'){
      banner.classList.remove('ok','err','warn');
      banner.classList.add(type);
      bannerText.textContent=msg;
      banner.classList.add('show');
      setTimeout(()=>banner.classList.remove('show'),5000);
    }
    bannerClose.addEventListener('click',()=>banner.classList.remove('show'));

    function h(tag,attrs={},...children){
      const el=document.createElement(tag);
      for(const[k,v]of Object.entries(attrs||{})){
        if(k==='class') el.className=v;
        else if(k.startsWith('on')&&typeof v==='function') el.addEventListener(k.slice(2),v);
        else el.setAttribute(k,v);
      }
      for(const c of children){
        if(c==null) continue;
        if(typeof c==='string') el.appendChild(document.createTextNode(c));
        else el.appendChild(c);
      }
      return el;
    }

    function debounce(fn,ms=250){
      let t;return(...args)=>{clearTimeout(t);t=setTimeout(()=>fn(...args),ms);};
    }

    async function sha256Hex(s){
      const enc=new TextEncoder();
      const buf=await crypto.subtle.digest('SHA-256',enc.encode((s||'').trim()));
      return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,'0')).join('');
    }

    function normalizeIdForKey(s){
      return (s||'').trim().toLowerCase().replace(/[^\w]+/g,'');
    }

   // üîë Map DOM id/label/href ‚Üí stable permission key (SAFE VERSION)
function mapToPermKey(id, label, href) {
  const mapByExact = {
  "CheckInOut": "CheckInOut",
    "Projects": "Projects",
    "ProjectsAdmin": "ProjectsAdmin",
  "Vehicles": "Vehicles",
  "Holiday": "Holiday",
  "EngineersHoursMenu": "EngineersHoursMenu",
  "PurchaseOrders": "PurchaseOrders",
  "PurchaseOrders2": "PurchaseOrders",

  // ‚úÖ Purchase Order sub-menu permissions
  "POCreate": "POCreate",
  "MyPOs": "MyPOs",
  "PODirector": "PODirector",
  "POCosting": "POCosting",
  "PO Director": "PODirector",
  "PO Costing": "POCosting",

  "Sites": "Sites",
  "Assets": "Assets",
  "MyDocuments": "MyDocuments",
  "Compliance": "Compliance",
  "HoursDashboard": "HoursDashboard",
  "Users": "Users",
  "Weekly": "Weekly",
  "Forms": "Forms",
  "SLA": "SLA",
  "SLA Menu": "SLA",
  "HolidayAdmin": "HolidayAdmin",
    "MyAssets": "MyAssets",
"SharedAssets": "SharedAssets",
"AssetsAdmin": "AssetsAdmin",
};

  // Direct match on ID or label
  if (id && mapByExact[id]) return mapByExact[id];
  if (label && mapByExact[label]) return mapByExact[label];

  // Only *.html internal pages
  if (href && href.endsWith(".html")) {
    const clean = href.toLowerCase();

    if (clean.includes("sla")) return "SLA";
    if (clean.includes("users")) return "Users";
    if (clean.includes("weekly")) return "Weekly";
    if (clean.includes("assets")) return "Assets";
    if (clean.includes("forms")) return "Forms";
    if (clean.includes("compliance")) return "Compliance";
    if (clean.endsWith("po-menu.html")) return "PurchaseOrders";
    if (clean.includes("sites")) return "Sites";
    if (clean.includes("checkin") || clean.includes("checkout")) return "CheckInOut";
    if (clean.includes("po-costing")) return "POCosting";
if (clean.includes("po-director")) return "PODirector";
  }

  // Allow explicit admin pages
if (id === 'Projects') return 'Projects';
if (id === 'ProjectsAdmin') return 'ProjectsAdmin';

// ‚ùå Reject all other external links
return null;
}
    // üîç Scan main.html + submenus ‚Üí structure with stable keys
    async function scanPortal(){
      const parser=new DOMParser();
      const visited=new Set();
      const struct=[];

      async function scanPage(url,depth=0){
        if(!url || visited.has(url)) return [];
        visited.add(url);
        try{
          const fullUrl = url + (url.includes('?')?'&':'?') + 'v=' + Date.now();
          const res=await fetch(fullUrl,{cache:'no-store'});
          const html=await res.text();
          const doc=parser.parseFromString(html,'text/html');

          // Support emoji buttons as long as they have these classes
          const rawButtons = [
            ...doc.querySelectorAll('a.button,button.button,a.menu-btn,button.menu-btn')
          ];

          const buttons = rawButtons.map(b=>{
            const id = b.id || '';
            const label = (b.textContent || '').trim();
            const hrefAttr = b.getAttribute('href') || '';
            const href = hrefAttr;
            const key = mapToPermKey(id,label,href);
            return { id, label, href, key, subpages: [] };
          }).filter(b => !!b.key); // only keep ones with a key

          if (depth < 2){
            for (const btn of buttons){
              if (btn.href && /\.html$/i.test(btn.href) && !/login\.html/i.test(btn.href)){
                const nextUrl = new URL(btn.href, url).toString();
                const subs = await scanPage(nextUrl, depth+1);
                btn.subpages = subs;
              }
            }
          }

          return buttons;
        }catch(e){
          console.warn('Scan failed for',url,e);
          return [];
        }
      }

      const rootUrl = new URL('main.html', window.location.href).toString();
      struct.push(...await scanPage(rootUrl));
      structCount.textContent = `Discovered ${struct.length} main buttons (deep scan)`;
      return struct;
    }

    async function fetchAllUsers(){
      const res=await fetch(USERS_URL+'?v='+Date.now(),{
        headers: TOKEN ? {'Authorization':'Bearer '+TOKEN} : {}
      });
      if(!res.ok) throw new Error('Failed to fetch users');
      const data=await res.json();
      return data.Users || [];
    }

    async function saveUsers(users){
      const res=await fetch(SAVE_URL,{
        method:'POST',
        headers:Object.assign({'Content-Type':'application/json'},TOKEN?{'Authorization':'Bearer '+TOKEN}:{}),
        body:JSON.stringify({Users:users})
      });
      if(!res.ok){
        const txt=await res.text().catch(()=> '');
        throw new Error('Save failed: '+txt);
      }
    }

    function switchControl(domId,checked,permKey,role){
      const inputAttrs = {
        type:'checkbox',
        id:domId,
        'data-key':permKey,
        'data-role':role || 'main'
      };
      if (checked) inputAttrs.checked = true;
      return h('label',{class:'switch'},
        h('input',inputAttrs),
        h('span',{class:'slider'})
      );
    }

    function toggleRow(user,permKey,label,href,checked,indent=false,role='main',parentKey=null){
      const pathSpan = href ? h('span',{class:'path'},href) : null;
      const rowClasses = ['toggle-row'];
      if (indent) rowClasses.push('indent');
      if (role === 'sub') rowClasses.push('submenu-row');

      const attrs = {class:rowClasses.join(' ')};
      if (role === 'sub' && parentKey) {
        attrs['data-parent'] = parentKey;
      }

      const domId = `${user.Username}::${permKey}__chk`;

      return h('div',attrs,
        h('div',{class:'lbl'},
          label || permKey || '(unnamed)',
          pathSpan ? h('div',null,pathSpan) : null
        ),
        switchControl(domId,!!checked,permKey,role)
      );
    }

    // Manage Modal Logic (EXISTING)
    const manageModal = document.getElementById('manageUserModal');
    let __MANAGING = null;

    const openManage = (user)=>{
      __MANAGING = user;
      document.getElementById('mu_engineerNumber').value = user.EngineerNumber || '';
      document.getElementById('mu_username').value = user.Username || '';
      document.getElementById('mu_firstName').value = user.FirstName || '';
      document.getElementById('mu_lastName').value = user.LastName || '';
      document.getElementById('mu_email').value = user.Email || '';
      document.getElementById('mu_vehicle').value = user.VehicleAssigned || '';
      document.getElementById('mu_employmentType').value = user.EmploymentType || '';
      document.getElementById('mu_status').value = user.Status || '';
      document.getElementById('mu_sharepoint').value = user.SharePointPath || '';
      document.getElementById('mu_password').value = '';
      manageModal.classList.add('show');
      manageModal.setAttribute('aria-hidden','false');
    };
    const closeManage = ()=>{
      manageModal.classList.remove('show');
      manageModal.setAttribute('aria-hidden','true');
      __MANAGING = null;
    };

    document.getElementById('cancelManage').addEventListener('click',closeManage);

    document.getElementById('saveManageBtn').addEventListener('click',async()=>{
      if(!__MANAGING) return;

      try{
        showMask(true);

        // DELTA SAFE: only write fields if they actually changed
        const orig = (__ORIGINAL_USERS || []).find(x => (x.Username||'') === (__MANAGING.Username||'')) || null;

        const setIfChanged = (obj, key, newVal) => {
          const nv = (newVal ?? '');
          const ov = orig ? (orig[key] ?? '') : (obj[key] ?? '');
          if (String(nv) !== String(ov)) obj[key] = nv;
        };

        setIfChanged(__MANAGING, 'FirstName', document.getElementById('mu_firstName').value.trim());
        setIfChanged(__MANAGING, 'LastName', document.getElementById('mu_lastName').value.trim());
        setIfChanged(__MANAGING, 'Email', document.getElementById('mu_email').value.trim());
        setIfChanged(__MANAGING, 'VehicleAssigned', document.getElementById('mu_vehicle').value.trim());
        setIfChanged(__MANAGING, 'EmploymentType', document.getElementById('mu_employmentType').value.trim());
        setIfChanged(__MANAGING, 'Status', document.getElementById('mu_status').value.trim());
        setIfChanged(__MANAGING, 'SharePointPath', document.getElementById('mu_sharepoint').value.trim());
        setIfChanged(__MANAGING, 'Role', document.getElementById('mu_role').value.trim() );

        const newPw = document.getElementById('mu_password').value;
        if(newPw && newPw.trim()){
          const hp = await sha256Hex(newPw);
          if (!orig || String(orig.HashedPassword||'') !== String(hp)) {
            __MANAGING.HashedPassword = hp;
          }
        }

        await saveUsers(__USERS);

        // Update visible fields without re-rendering permissions
        const nameEl = document.getElementById(`name_${__MANAGING.Username}`);
        const subEl = document.getElementById(`sub_${__MANAGING.Username}`);
        if(nameEl){
          nameEl.innerHTML = `${__MANAGING.EngineerNumber ? ('#'+__MANAGING.EngineerNumber+' ‚Äì ') : ''}${__MANAGING.FirstName||''} ${__MANAGING.LastName||''} <span style="color:#6b7280;font-weight:500">(${__MANAGING.Username})</span>`;
        }
        if(subEl){
          subEl.textContent = `${__MANAGING.EmploymentType||''} ¬∑ ${__MANAGING.Status||''} ¬∑ ${__MANAGING.Email||''}`;
        }

        closeManage();
        showBanner('‚úÖ User updated successfully.','ok');
      }catch(err){
        console.error(err);
        showBanner('‚ùå Could not update user. '+(err?.message||''),'err');
      }finally{
        showMask(false);
      }
    });

    function userCard(user,structure){
      const header = h('div',{class:'user-header'},
        h('div',{id:`name_${user.Username}`},
          `${user.EngineerNumber ? ('#'+user.EngineerNumber+' ‚Äì ') : ''}${user.FirstName||''} ${user.LastName||''} `,
          h('span',{style:'color:#6b7280;font-weight:500'},`(${user.Username})`)
        ),
        h('div',null,
          h('div',{style:'display:flex;justify-content:flex-end;margin-bottom:6px'},
            h('button',{class:'btn btn-outline',style:'padding:6px 10px;font-size:12px',onclick:()=>openManage(user)},'‚öô Manage')
          ),
          h('div',{class:'toggle-row'},
            h('span',{class:'lbl'},'Full Access'),
            switchControl(`fa_${user.Username}__chk`,(user.FullAccess||'').toLowerCase()==='yes','FullAccess','fa')
          )
        )
      );

      const sub = h('div',{class:'user-sub',id:`sub_${user.Username}`},
        `${user.EmploymentType||''} ¬∑ ${user.Status||''} ¬∑ ${user.Email||''}`
      );

      const grid = h('div',{class:'grid'});
      grid.appendChild(
        h('div',{class:'section-title'},
          'Main Menu',
          h('span',{class:'pill'},'auto')
        )
      );

      // Main buttons
      structure.forEach(p=>{
        const permKey = p.key || mapToPermKey(p.id,p.label,p.href);
        if (!permKey) return;
        const currentOn = ((user[permKey] || '').toLowerCase() === 'yes');
        grid.appendChild(
          toggleRow(user,permKey,p.label,p.href,currentOn,false,'main',null)
        );
      });

      // Sub menus
      const subs = structure.flatMap(s=>s.subpages || []);
      if (subs.length){
        grid.appendChild(
          h('div',{
            class:'section-title',
            style:'grid-column:1/-1'
          },
          'Sub-menus',
          h('span',{class:'pill'},String(subs.length)))
        );

        structure.forEach(p=>{
          const parentKey = p.key || mapToPermKey(p.id,p.label,p.href);
          if (!parentKey) return;
          (p.subpages || []).forEach(sp=>{
            const sid = sp.key || mapToPermKey(sp.id,sp.label,sp.href);
            if (!sid) return;
            const on = ((user[sid] || '').toLowerCase() === 'yes');
            grid.appendChild(
              toggleRow(user,sid,sp.label,sp.href,on,true,'sub',parentKey)
            );
          });
        });
      }

      return h('div',{class:'user-card'},header,sub,grid);
    }

    function initSubmenuVisibility(){
      // For each user card, tie submenus to their main switches
      document.querySelectorAll('.user-card').forEach(card=>{
        const mains = card.querySelectorAll('input[type="checkbox"][data-role="main"]');
        mains.forEach(main=>{
          const key = main.getAttribute('data-key');
          if (!key) return;
          const rows = card.querySelectorAll(`.submenu-row[data-parent="${key}"]`);
          const sync = ()=>{
  rows.forEach(r=>{
    // Only control visibility via parent menu toggle
    r.style.display = main.checked ? 'flex' : 'none';
  });
};
          main.addEventListener('change', sync);
          // initial state
          sync();
        });
      });
    }

    function renderUsers(users,structure){
      list.innerHTML='';
      if(!users.length){
        list.textContent='No users found.';
        return;
      }
      users.forEach(u=>list.appendChild(userCard(u,structure)));
      initSubmenuVisibility();
    }

    let __USERS = [];
    let __STRUCT = [];
    let __ORIGINAL_USERS = []; // NEW: snapshot for DELTA saving

    async function buildUI(){
      showMask(true);
      try{
        const [users,struct] = await Promise.all([fetchAllUsers(),scanPortal()]);
        __USERS = users;
        __STRUCT = struct;

        // Snapshot (deep copy) for DELTA logic
        __ORIGINAL_USERS = JSON.parse(JSON.stringify(users || []));

        // Populate username dropdown
        userFilter.innerHTML = '<option value="">All Users</option>';
        __USERS.forEach(u=>{
          const uname = u.Username || '';
          if (!uname) return;
          const opt = document.createElement('option');
          opt.value = uname;
          opt.textContent = uname;
          userFilter.appendChild(opt);
        });

        renderUsers(__USERS,__STRUCT);
        refreshManageUsersUI(); // NEW
      }
      catch(err){
        console.error(err);
        list.textContent='Failed to load. Check Worker and network.';
        showBanner('‚ùå Failed to load users or scan portal','err');
      }
      finally{
        showMask(false);
      }
    }
let saving = false;
async function saveAll(){
  if (saving) return;
  if (!__USERS || !__STRUCT) return;

  saving = true;
  showMask(true);

  try {
    const patchUsers = [];

    __USERS.forEach(user => {
      const orig = (__ORIGINAL_USERS || []).find(o => o.Username === user.Username);
      if (!orig) return;

      const card = document.querySelector(`.user-card [id="name_${user.Username}"]`)?.closest('.user-card');
      if (!card) return;

      const changes = {};

      // FULL ACCESS
const faEl = card.querySelector(`input[data-key="FullAccess"]`);
const newFA = faEl && faEl.checked ? 'Yes' : 'No';
      if (String(orig.FullAccess || 'No') !== newFA) {
        changes.FullAccess = newFA;
      }

      // PERMISSIONS
      const checkPerm = (key) => {
const chk = card.querySelector(`input[data-key="${key}"]`);
if (!chk) return;

const uiVal = chk.checked ? 'Yes' : 'No';
        const origVal = orig[key];

// FIX: allow first-time "No" permissions to be saved
if (origVal === undefined && uiVal === 'No') {
  changes[key] = 'No';
  return;
}

        if (String(origVal ?? '') !== uiVal) {
          changes[key] = uiVal;
        }
      };

// ‚úÖ SAVE ALL PERMISSIONS THAT EXIST IN THE UI
const seen = new Set();

card.querySelectorAll('input[type="checkbox"][data-key]').forEach(chk => {
  const key = chk.dataset.key;
  if (!key || key === 'FullAccess') return;
  if (seen.has(key)) return;
  seen.add(key);

  const uiVal = chk.checked ? 'Yes' : 'No';
  const origVal = orig[key];

  // Allow first-time "No"
  if (origVal === undefined && uiVal === 'No') {
    changes[key] = 'No';
    return;
  }

  if (String(origVal ?? '') !== uiVal) {
    changes[key] = uiVal;
  }
});

      if (Object.keys(changes).length) {
        patchUsers.push({
          Username: user.Username,
          Changes: changes
        });
      }
    });

    if (!patchUsers.length) {
      showBanner('‚ÑπÔ∏è No permission changes detected.','warn');
      return;
    }

    const res = await fetch(SAVE_DELTA_URL, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        ...(TOKEN ? { Authorization: 'Bearer ' + TOKEN } : {})
      },
      body: JSON.stringify({ patchUsers })
    });

    if (!res.ok) {
      const t = await res.text();
      throw new Error(t);
    }

    // sync snapshot
    patchUsers.forEach(p => {
      const u = __USERS.find(x => x.Username === p.Username);
      if (u) Object.assign(u, p.Changes);
    });

    __ORIGINAL_USERS = JSON.parse(JSON.stringify(__USERS));
    refreshManageUsersUI();
    showBanner('‚úÖ Permissions updated safely.','ok');

  } catch (err) {
    console.error(err);
    showBanner('‚ùå Permission save failed. ' + (err.message || ''), 'err');
  } finally {
    showMask(false);
    saving = false;
  }
}

    // Modal logic (EXISTING Add User)
    const modal=document.getElementById('addUserModal');
    const openAdd=()=>{modal.classList.add('show');modal.setAttribute('aria-hidden','false');};
    const closeAdd=()=>{modal.classList.remove('show');modal.setAttribute('aria-hidden','true');};

    document.getElementById('addUserBtn').addEventListener('click',openAdd);
    document.getElementById('cancelAdd').addEventListener('click',closeAdd);

    async function createUser(){
      try{
        showMask(true);
        const res=await fetch(USERS_URL+'?v='+Date.now(),{
          headers:TOKEN?{'Authorization':'Bearer '+TOKEN}:{}
        });
        const data=await res.json();
        const users=data.Users||[];
        const maxNum=users.reduce((m,u)=>{
          const n=parseInt(u.EngineerNumber,10);
          return isNaN(n)?m:Math.max(m,n);
        },0);
        const nextNum=String(maxNum+1);

        const firstName=document.getElementById('firstName').value.trim();
        const lastName=document.getElementById('lastName').value.trim();
        const email=document.getElementById('email').value.trim();
        const username=document.getElementById('username').value.trim();
        const password=document.getElementById('password').value;
        const vehicle=document.getElementById('vehicle').value.trim();
        const empType=document.getElementById('employmentType').value.trim();
        const spPath=document.getElementById('sharepoint').value.trim();
        const role = document.getElementById('role').value;

        if(!firstName||!lastName||!username||!password){
          showBanner('‚ùå Please complete First, Last, Username and Password.','err');
          return;
        }

        const hashedPassword=await sha256Hex(password);

        const newUser={
          EngineerNumber:nextNum,
          FirstName:firstName,
          LastName:lastName,
          Username:username,
          Email:email,
          HashedPassword:hashedPassword,
          VehicleAssigned:vehicle,
          EmploymentType:empType||'Employed',
          Status:'Active',
          FullAccess:'No',
            SharePointPath:spPath,
  Role:role
        };

        users.push(newUser);
        await saveUsers(users);
        closeAdd();
        showBanner('‚úÖ User added.','ok');
        buildUI();
      }
      catch(err){
        console.error(err);
        showBanner('‚ùå Could not add user. '+(err?.message||''),'err');
      }
      finally{
        showMask(false);
      }
    }

    document.getElementById('createUserBtn').addEventListener('click',createUser);

    // Combined search + filter
    function applyFilters() {
      const q = (searchBox.value || '').trim().toLowerCase();
      const selected = userFilter.value;

      let filtered = __USERS || [];

      if (selected) {
        filtered = filtered.filter(u => (u.Username || '') === selected);
      }

      if (q) {
        filtered = filtered.filter(u =>
          (u.FirstName || '').toLowerCase().includes(q) ||
          (u.LastName || '').toLowerCase().includes(q) ||
          (u.Username || '').toLowerCase().includes(q) ||
          String(u.EngineerNumber || '').includes(q)
        );
      }

      renderUsers(filtered, __STRUCT);
    }

    searchBox.addEventListener('input', debounce(applyFilters, 150));
    userFilter.addEventListener('change', applyFilters);
        document.getElementById('saveBtn').addEventListener('click',saveAll);
    document.getElementById('reloadBtn').addEventListener('click',buildUI);
    document.getElementById('rescanBtn').addEventListener('click',async()=>{
      showMask(true);
      try{
        __STRUCT = await scanPortal();
        renderUsers(__USERS,__STRUCT);
        showBanner('üîÑ Scan complete. Buttons refreshed.','ok');
      }
      catch(e){
        console.error(e);
        showBanner('‚ùå Scan failed','err');
      }
      finally{
        showMask(false);
      }
    });

    // ==========================================================
    // NEW: Manage users (LIST + EDIT) + Add New User (DELTA SAFE)
    // ==========================================================
    const manageUsersBtn = document.getElementById('manageUsersBtn');
    const manageUsersModal = document.getElementById('manageUsersModal');
    const muList = document.getElementById('muList');
    const muSearch = document.getElementById('muSearch');

    const closeManageUsersBtn = document.getElementById('closeManageUsersBtn');
    const openAddNewUserBtn = document.getElementById('openAddNewUserBtn');

    const addNewUserModal = document.getElementById('addNewUserModal');
    const anu_cancel = document.getElementById('anu_cancel');
    const anu_create = document.getElementById('anu_create');

    let __MUE = null; // currently selected user in manage users modal

    function openManageUsers(){
      manageUsersModal.classList.add('show');
      manageUsersModal.setAttribute('aria-hidden','false');
      refreshManageUsersUI();
    }
    function closeManageUsers(){
      manageUsersModal.classList.remove('show');
      manageUsersModal.setAttribute('aria-hidden','true');
      __MUE = null;
      clearManageUserEditor();
    }

    function openAddNewUser(){
      addNewUserModal.classList.add('show');
      addNewUserModal.setAttribute('aria-hidden','false');
      // reset fields
      document.getElementById('anu_firstName').value = '';
      document.getElementById('anu_lastName').value = '';
      document.getElementById('anu_username').value = '';
      document.getElementById('anu_password').value = '';
      document.getElementById('anu_emailAddress').value = '';
      document.getElementById('anu_mobileNumber').value = '';
      document.getElementById('anu_vehicle').value = '';
      document.getElementById('anu_employmentType').value = '';
      document.getElementById('anu_role').value = '';
      document.getElementById('anu_sharepoint').value = '';
    }
    function closeAddNewUser(){
      addNewUserModal.classList.remove('show');
      addNewUserModal.setAttribute('aria-hidden','true');
    }

    function clearManageUserEditor(){
      document.getElementById('mue_engineerNumber').value = '';
      document.getElementById('mue_username').value = '';
      document.getElementById('mue_firstName').value = '';
      document.getElementById('mue_lastName').value = '';
      document.getElementById('mue_emailAddress').value = '';
      document.getElementById('mue_mobileNumber').value = '';
      document.getElementById('mue_vehicle').value = '';
      document.getElementById('mue_employmentType').value = '';
      document.getElementById('mue_role').value = '';
      document.getElementById('mue_sharepoint').value = '';
      document.getElementById('mue_status').value = '';
      document.getElementById('mue_password').value = '';
    }

    function safeUsernameFromNames(fn, ln){
      const f = (fn||'').trim();
      const l = (ln||'').trim();
      if(!f || !l) return '';
      return `${f}.${l}`.replace(/\s+/g,'').replace(/[^\w.\-]/g,'');
    }

    // Auto-generate username in Add New User modal
    const anu_firstName = document.getElementById('anu_firstName');
    const anu_lastName  = document.getElementById('anu_lastName');
    function syncANUUsername(){
      const u = safeUsernameFromNames(anu_firstName.value, anu_lastName.value);
      document.getElementById('anu_username').value = u;
    }
    anu_firstName.addEventListener('input', syncANUUsername);
    anu_lastName.addEventListener('input', syncANUUsername);

    // Collect all known permission keys from current users + portal scan
    function collectAllPermissionKeys(){
      const keys = new Set();

      // from portal structure
      (__STRUCT || []).forEach(p=>{
        const parentKey = p.key || mapToPermKey(p.id, p.label, p.href);
        if (parentKey) keys.add(parentKey);
        (p.subpages || []).forEach(sp=>{
          const sid = sp.key || mapToPermKey(sp.id, sp.label, sp.href);
          if (sid) keys.add(sid);
        });
      });

      // from existing users (anything that looks like Yes/No)
      (__USERS || []).forEach(u=>{
        Object.keys(u || {}).forEach(k=>{
          const v = u[k];
          if (typeof v === 'string' && (v.toLowerCase()==='yes' || v.toLowerCase()==='no')) {
            // skip core identity fields that can be Yes/No sometimes (rare), but keep FullAccess
            if (k === 'FullAccess') keys.add(k);
            else if (!['Status'].includes(k)) keys.add(k);
          }
        });
      });

      // ensure FullAccess is NOT treated as normal permission in defaults (we set separately)
      keys.delete('FullAccess');

      return Array.from(keys);
    }

    function refreshManageUsersUI(){
      if(!muList) return;

      const q = (muSearch?.value || '').trim().toLowerCase();
      const users = (__USERS || []).slice().sort((a,b)=>{
        const an = parseInt(a.EngineerNumber||'0',10) || 0;
        const bn = parseInt(b.EngineerNumber||'0',10) || 0;
        return an - bn;
      }).filter(u=>{
        if(!q) return true;
        const blob = `${u.FirstName||''} ${u.LastName||''} ${u.Username||''} ${u.EngineerNumber||''}`.toLowerCase();
        return blob.includes(q);
      });

      muList.innerHTML = '';
      if(!users.length){
        muList.textContent = 'No users found.';
        return;
      }

      users.forEach(u=>{
        const status = (u.Status||'').toLowerCase();
        const isActive = status === 'active';

        const row = document.createElement('div');
        row.className = 'user-row';

        const who = document.createElement('div');
        who.className = 'who';
        const t = document.createElement('div');
        t.className = 't';
        t.textContent = `#${u.EngineerNumber || '-'} ‚Äì ${(u.FirstName||'')} ${(u.LastName||'')}`.trim();
        const s = document.createElement('div');
        s.className = 's';
        s.textContent = `${u.Username || ''}`;
        who.appendChild(t);
        who.appendChild(s);

        const chip = document.createElement('span');
        chip.className = 'chip ' + (isActive ? 'active' : 'inactive');
        chip.textContent = isActive ? 'Active' : 'Not Active';

        const actions = document.createElement('div');
        actions.className = 'row-actions';

        // Active toggle (DELTA safe on Status only)
        const sw = switchControl(`mu_status_${u.Username}`, isActive, 'Status', 'manage');
        // We repurpose switchControl but handle change ourselves
        sw.querySelector('input').addEventListener('change', async (e)=>{
          try{
            showMask(true);

            // update only this user Status in the live model
            const target = (__USERS || []).find(x => x.Username === u.Username);
            if(!target) return;

            const newStatus = e.target.checked ? 'Active' : 'Not Active';
            const orig = (__ORIGINAL_USERS || []).find(x => x.Username === u.Username);

            // only write if changed
            if (!orig || String(orig.Status||'') !== String(newStatus)) {
              target.Status = newStatus;
            }

            // save full users, but DELTA safe overall (we use snapshot on permission save; here we persist via saveUsers)
            // For consistency with your current behaviour: we save immediately on toggle.
            const payload = JSON.parse(JSON.stringify(__ORIGINAL_USERS || __USERS || []));
            const idx = payload.findIndex(x => x.Username === u.Username);
            if(idx >= 0){
              // preserve everything else; update Status only if changed
              const existingStatus = payload[idx].Status;
              if (String(existingStatus||'') !== String(newStatus)) payload[idx].Status = newStatus;
            }

            await saveUsers(payload);

            // sync live + snapshot
            __USERS = JSON.parse(JSON.stringify(payload));
            __ORIGINAL_USERS = JSON.parse(JSON.stringify(payload));

            chip.className = 'chip ' + (newStatus === 'Active' ? 'active' : 'inactive');
            chip.textContent = newStatus === 'Active' ? 'Active' : 'Not Active';

            // update main card subline if present
            const subEl = document.getElementById(`sub_${u.Username}`);
            if(subEl){
              const liveNow = (__USERS || []).find(x => x.Username === u.Username) || u;
              subEl.textContent = `${liveNow.EmploymentType||''} ¬∑ ${liveNow.Status||''} ¬∑ ${liveNow.Email||''}`;
            }

            showBanner('‚úÖ Status updated.','ok');
          }catch(err){
            console.error(err);
            showBanner('‚ùå Could not update status. '+(err?.message||''),'err');
            // revert UI
            refreshManageUsersUI();
          }finally{
            showMask(false);
          }
        });

        const editBtn = document.createElement('button');
        editBtn.className = 'btn btn-outline';
        editBtn.style.padding = '6px 10px';
        editBtn.style.fontSize = '12px';
        editBtn.textContent = '‚úèÔ∏è Edit';
        editBtn.addEventListener('click', ()=>{
          __MUE = (__USERS || []).find(x => x.Username === u.Username) || u;

          document.getElementById('mue_engineerNumber').value = __MUE.EngineerNumber || '';
          document.getElementById('mue_username').value = __MUE.Username || '';
          document.getElementById('mue_firstName').value = __MUE.FirstName || '';
          document.getElementById('mue_lastName').value = __MUE.LastName || '';

          // Existing Email field is kept; EmailAddress maps to Email unless you specifically change it
          const emailAddr = (__MUE.EmailAddress ?? __MUE.Email ?? '');
          document.getElementById('mue_emailAddress').value = emailAddr || '';

          document.getElementById('mue_mobileNumber').value = (__MUE.MobileNumber ?? __MUE.Mobile ?? __MUE.Phone ?? '') || '';

          document.getElementById('mue_vehicle').value = __MUE.VehicleAssigned || '';
          document.getElementById('mue_employmentType').value = __MUE.EmploymentType || '';
          document.getElementById('mue_role').value = __MUE.Role || '';
          document.getElementById('mue_sharepoint').value = __MUE.SharePointPath || '';
          document.getElementById('mue_status').value = __MUE.Status || '';
          document.getElementById('mue_password').value = '';
        });

        actions.appendChild(chip);
        actions.appendChild(sw);
        actions.appendChild(editBtn);

        row.appendChild(who);
        row.appendChild(actions);

        muList.appendChild(row);
      });
    }

    if(muSearch){
      muSearch.addEventListener('input', debounce(refreshManageUsersUI, 120));
    }

    document.getElementById('saveManageUsersBtn').addEventListener('click', async ()=>{
      if(!__MUE) {
        showBanner('‚ö†Ô∏è Select a user to edit first.','warn');
        return;
      }
      try{
        showMask(true);

        const orig = (__ORIGINAL_USERS || []).find(x => (x.Username||'') === (__MUE.Username||'')) || null;

        const setIfChanged = (obj, key, newVal) => {
          const nv = (newVal ?? '');
          const ov = orig ? (orig[key] ?? '') : (obj[key] ?? '');
          if (String(nv) !== String(ov)) obj[key] = nv;
        };

        setIfChanged(__MUE, 'FirstName', document.getElementById('mue_firstName').value.trim());
        setIfChanged(__MUE, 'LastName', document.getElementById('mue_lastName').value.trim());

        // EmailAddress + backwards compatibility:
        // - If you edit EmailAddress, we set BOTH EmailAddress and Email to same value (so no page breaks).
        const newEmailAddr = document.getElementById('mue_emailAddress').value.trim();
        if (newEmailAddr) {
          if (!orig || String(orig.EmailAddress ?? '') !== String(newEmailAddr)) __MUE.EmailAddress = newEmailAddr;
          if (!orig || String(orig.Email ?? '') !== String(newEmailAddr)) __MUE.Email = newEmailAddr;
        } else {
          // if user clears it, only clear if it was previously set (DELTA safe)
          if (orig && String(orig.EmailAddress ?? '') !== '') __MUE.EmailAddress = '';
          if (orig && String(orig.Email ?? '') !== '') __MUE.Email = '';
        }

        const newMobile = document.getElementById('mue_mobileNumber').value.trim();
        if (newMobile) {
          if (!orig || String(orig.MobileNumber ?? '') !== String(newMobile)) __MUE.MobileNumber = newMobile;
        } else {
          if (orig && String(orig.MobileNumber ?? '') !== '') __MUE.MobileNumber = '';
        }

        setIfChanged(__MUE, 'VehicleAssigned', document.getElementById('mue_vehicle').value.trim());
        setIfChanged(__MUE, 'EmploymentType', document.getElementById('mue_employmentType').value.trim());
        setIfChanged(__MUE, 'Role', document.getElementById('mue_role').value.trim());
        setIfChanged(__MUE, 'SharePointPath', document.getElementById('mue_sharepoint').value.trim());
        setIfChanged(__MUE, 'Status', document.getElementById('mue_status').value.trim());

        const newPw = document.getElementById('mue_password').value;
        if(newPw && newPw.trim()){
          const hp = await sha256Hex(newPw);
          if (!orig || String(orig.HashedPassword||'') !== String(hp)) {
            __MUE.HashedPassword = hp;
          }
        }

        // Save (full array, but only this user is changed in-memory)
        await saveUsers(__USERS);

        // Sync snapshot to avoid future delta confusion
        __ORIGINAL_USERS = JSON.parse(JSON.stringify(__USERS));

        // Update main card header/sub if visible
        const nameEl = document.getElementById(`name_${__MUE.Username}`);
        const subEl = document.getElementById(`sub_${__MUE.Username}`);
        if(nameEl){
          nameEl.innerHTML = `${__MUE.EngineerNumber ? ('#'+__MUE.EngineerNumber+' ‚Äì ') : ''}${__MUE.FirstName||''} ${__MUE.LastName||''} <span style="color:#6b7280;font-weight:500">(${__MUE.Username})</span>`;
        }
        if(subEl){
          subEl.textContent = `${__MUE.EmploymentType||''} ¬∑ ${__MUE.Status||''} ¬∑ ${__MUE.Email||''}`;
        }

        refreshManageUsersUI();
        showBanner('‚úÖ User details updated.','ok');
      }catch(err){
        console.error(err);
        showBanner('‚ùå Could not save user. '+(err?.message||''),'err');
      }finally{
        showMask(false);
      }
    });

    // Create new user (permissions default No)
    document.getElementById('anu_create').addEventListener('click', async ()=>{
      try{
        showMask(true);

        const res=await fetch(USERS_URL+'?v='+Date.now(),{
          headers:TOKEN?{'Authorization':'Bearer '+TOKEN}:{}
        });
        const data=await res.json();
        const users=data.Users||[];

        const maxNum=users.reduce((m,u)=>{
          const n=parseInt(u.EngineerNumber,10);
          return isNaN(n)?m:Math.max(m,n);
        },0);
        const nextNum=String(maxNum+1);

        const firstName = document.getElementById('anu_firstName').value.trim();
        const lastName  = document.getElementById('anu_lastName').value.trim();
        const username  = document.getElementById('anu_username').value.trim();
        const password  = document.getElementById('anu_password').value;

        const emailAddr = document.getElementById('anu_emailAddress').value.trim();
        const mobileNum = document.getElementById('anu_mobileNumber').value.trim();

        const vehicle   = document.getElementById('anu_vehicle').value.trim();
        const empType   = document.getElementById('anu_employmentType').value.trim();
        const role = document.getElementById('anu_role').value.trim();
        const spPath    = document.getElementById('anu_sharepoint').value.trim();

        if(!firstName || !lastName || !username || !password){
          showBanner('‚ùå Please complete First Name, Last Name, and Password.','err');
          return;
        }

        // Prevent duplicates
        if (users.some(u => (u.Username||'').toLowerCase() === username.toLowerCase())) {
          showBanner('‚ùå That username already exists.','err');
          return;
        }

        const hashedPassword = await sha256Hex(password);

        const newUser = {
          EngineerNumber: nextNum,
          FirstName: firstName,
          LastName: lastName,
          Username: username,

          // Backwards compatible email
          Email: emailAddr || '',
          EmailAddress: emailAddr || '',

          MobileNumber: mobileNum || '',

          HashedPassword: hashedPassword,
          VehicleAssigned: vehicle,
          EmploymentType: empType || 'Employed',
          Role: role || '',
          Status: 'Active',
          FullAccess: 'No',
          SharePointPath: spPath
        };

        // Set ALL permissions to No by default
        const keys = collectAllPermissionKeys();
        keys.forEach(k=>{
          if (!k) return;
          if (typeof newUser[k] === 'undefined') newUser[k] = 'No';
        });

        users.push(newUser);
        await saveUsers(users);

        closeAddNewUser();
        showBanner('‚úÖ User added (all permissions defaulted to No).','ok');

        await buildUI();
      }catch(err){
        console.error(err);
        showBanner('‚ùå Could not add user. '+(err?.message||''),'err');
      }finally{
        showMask(false);
      }
    });

    // Wire up Manage Users modal buttons
    manageUsersBtn.addEventListener('click', openManageUsers);
    closeManageUsersBtn.addEventListener('click', closeManageUsers);
    openAddNewUserBtn.addEventListener('click', openAddNewUser);
    anu_cancel.addEventListener('click', closeAddNewUser);

    // Optional: close modals if clicking backdrop
    manageUsersModal.addEventListener('click', (e)=>{ if(e.target === manageUsersModal) closeManageUsers(); });
    addNewUserModal.addEventListener('click', (e)=>{ if(e.target === addNewUserModal) closeAddNewUser(); });

    // (Your earlier requirement): only Jamie.Line should manage users
    if (CURRENT !== 'Jamie.Line') {
      manageUsersBtn.disabled = true;
      manageUsersBtn.title = 'Only Jamie.Line can manage users';
    }

    (async()=>{await buildUI();})();
  </script>

</body>
</html>
