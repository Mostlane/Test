<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>User Administration â€“ Mostlane Portal</title>
  <script src="auth.js"></script>
  <style>
    body {
      font-family: "Segoe UI", sans-serif;
      background: #e6e8eb url('Mostlane_Embossed.png') no-repeat center center fixed;
      background-size: cover;
      margin: 0; padding: 20px;
    }
    h1 { text-align: center; color: #003366; }
    .user-list {
      background: rgba(255,255,255,0.7);
      padding: 20px;
      border-radius: 8px;
      max-width: 800px;
      margin: 20px auto;
      overflow-y: auto;
    }
    .user-card {
      border: 1px solid #ccc;
      border-radius: 8px;
      margin-bottom: 15px;
      padding: 10px 15px;
      background: white;
    }
    .user-header {
      font-weight: bold;
      margin-bottom: 10px;
      color: #004a99;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .toggle-group { margin: 5px 0 8px 15px; }
    .toggle {
      display: flex;
      align-items: center;
      margin: 6px 0;
    }
    .toggle label {
      flex: 1;
      font-size: 14px;
    }
    .switch {
      position: relative;
      display: inline-block;
      width: 44px;
      height: 24px;
      margin-left: 10px;
    }
    .switch input { display: none; }
    .slider {
      position: absolute;
      cursor: pointer;
      top: 0; left: 0; right: 0; bottom: 0;
      background-color: #ccc;
      border-radius: 24px;
      transition: .4s;
    }
    .slider:before {
      position: absolute;
      content: "";
      height: 18px; width: 18px;
      left: 3px; bottom: 3px;
      background-color: white;
      border-radius: 50%;
      transition: .4s;
    }
    input:checked + .slider { background-color: #004a99; }
    input:checked + .slider:before { transform: translateX(20px); }
    button {
      background: #004a99;
      color: white;
      padding: 10px 20px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      margin-top: 10px;
    }
    button:hover { background: #0066cc; }
    #addUserPopup {
      display: none;
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.4);
      z-index: 100;
      justify-content: center;
      align-items: center;
    }
    #addUserForm {
      background: white;
      padding: 20px;
      border-radius: 8px;
      width: 90%;
      max-width: 400px;
      max-height: 80vh;
      overflow-y: auto;
    }
    input[type=text], input[type=email], input[type=password] {
      width: 100%;
      margin: 5px 0 10px;
      padding: 8px;
      border-radius: 4px;
      border: 1px solid #ccc;
      font-size: 14px;
    }
    .close-btn {
      float: right;
      font-weight: bold;
      cursor: pointer;
      color: #999;
    }
  </style>
</head>
<body>
  <h1>Manage Users</h1>
  <div class="user-list" id="userList">Loading users...</div>
  <div style="text-align:center;">
    <button id="addUserBtn">âž• Add New User</button>
    <button id="saveBtn">ðŸ’¾ Save Changes</button>
  </div>

  <!-- Popup form -->
  <div id="addUserPopup">
    <div id="addUserForm">
      <span class="close-btn" id="closePopup">&times;</span>
      <h3>Add New User</h3>
      <input type="text" id="firstName" placeholder="First Name" required />
      <input type="text" id="lastName" placeholder="Last Name" required />
      <input type="email" id="email" placeholder="Email" />
      <input type="text" id="username" placeholder="Username (e.g. John.Doe)" required />
      <input type="password" id="password" placeholder="Password" required />
      <input type="text" id="vehicle" placeholder="Vehicle Assigned (optional)" />
      <input type="text" id="employmentType" placeholder="Employment Type (Employed/Self Employed)" />
      <input type="text" id="sharepoint" placeholder="SharePoint Path URL" />
      <button id="createUserBtn">Create User</button>
    </div>
  </div>

  <script>
    const workerURL = "https://mostlane-users.jamie-def.workers.dev";
    const currentUser = sessionStorage.getItem("mostlaneUser");

    // Restrict access
    if (!currentUser) window.location.href = "login.html";

    async function fetchUsers() {
      const res = await fetch(workerURL + "/users?v=" + Date.now());
      const data = await res.json();
      return data.Users || [];
    }

    async function scanPortalStructure() {
      const structure = [];
      const parser = new DOMParser();

      const mainRes = await fetch("main.html?v=" + Date.now());
      const mainText = await mainRes.text();
      const mainDoc = parser.parseFromString(mainText, "text/html");
      const buttons = [...mainDoc.querySelectorAll("a.button")];

      for (const btn of buttons) {
        const entry = {
          id: btn.id,
          label: btn.textContent.trim(),
          path: btn.getAttribute("href"),
          subpages: []
        };
        // Try to scan sub-menus
        if (entry.path && entry.path.endsWith(".html") && !entry.path.includes("login.html")) {
          try {
            const subRes = await fetch(entry.path);
            const subText = await subRes.text();
            const subDoc = parser.parseFromString(subText, "text/html");
            const subButtons = [...subDoc.querySelectorAll("a.button")];
            entry.subpages = subButtons.map(s => ({
              id: s.id,
              label: s.textContent.trim(),
              path: s.getAttribute("href")
            }));
          } catch (e) {
            console.warn("No subpage for", entry.path);
          }
        }
        structure.push(entry);
      }
      return structure;
    }

    function createToggle(id, label, checked, indent=false) {
      const div = document.createElement("div");
      div.className = "toggle";
      if (indent) div.style.marginLeft = "25px";
      div.innerHTML = `
        <label>${label}</label>
        <label class="switch">
          <input type="checkbox" id="${id}" ${checked ? "checked" : ""}>
          <span class="slider"></span>
        </label>
      `;
      return div;
    }

    async function buildUI() {
      const [users, structure] = await Promise.all([fetchUsers(), scanPortalStructure()]);
      const list = document.getElementById("userList");
      list.innerHTML = "";

      users.forEach(u => {
        const card = document.createElement("div");
        card.className = "user-card";

        const header = document.createElement("div");
        header.className = "user-header";
        header.innerHTML = `<span>${u.EngineerNumber ? ("#" + u.EngineerNumber + " â€“ ") : ""}${u.FirstName} ${u.LastName}</span>`;
        const faToggle = createToggle(`fa_${u.Username}`, "Full Access", (u.FullAccess||"").toLowerCase()==="yes");
        header.appendChild(faToggle);
        card.appendChild(header);

        const tg = document.createElement("div");
        tg.className = "toggle-group";

        structure.forEach(page => {
          const t = createToggle(`${u.Username}_${page.id}`, page.label, (u[page.id]||"").toLowerCase()==="yes");
          tg.appendChild(t);
          if (page.subpages.length) {
            page.subpages.forEach(sp => {
              const st = createToggle(`${u.Username}_${sp.id}`, sp.label, (u[sp.id]||"").toLowerCase()==="yes", true);
              tg.appendChild(st);
            });
          }
        });

        card.appendChild(tg);
        list.appendChild(card);
      });
    }

    async function saveChanges() {
      const res = await fetch(workerURL + "/users?v=" + Date.now());
      const data = await res.json();
      const users = data.Users;

      users.forEach(u => {
        u.FullAccess = document.getElementById(`fa_${u.Username}`)?.checked ? "Yes" : "No";
        document.querySelectorAll(`[id^="${u.Username}_"]`).forEach(chk => {
          const key = chk.id.split("_")[1];
          u[key] = chk.checked ? "Yes" : "No";
        });
      });

      await fetch(workerURL + "/update-users", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ Users: users })
      });

      alert("âœ… Changes saved successfully!");
    }

    document.getElementById("saveBtn").addEventListener("click", saveChanges);

    // Add new user popup
    const popup = document.getElementById("addUserPopup");
    document.getElementById("addUserBtn").onclick = () => popup.style.display = "flex";
    document.getElementById("closePopup").onclick = () => popup.style.display = "none";

    document.getElementById("createUserBtn").addEventListener("click", async () => {
      const res = await fetch(workerURL + "/users?v=" + Date.now());
      const data = await res.json();
      const users = data.Users;

      const enc = new TextEncoder();
      const pw = document.getElementById("password").value;
      const hashBuffer = await crypto.subtle.digest("SHA-256", enc.encode(pw));
      const hashedPassword = Array.from(new Uint8Array(hashBuffer)).map(b=>b.toString(16).padStart(2,"0")).join("");

      const newEngineerNumber = String(users.length + 1);
      const newUser = {
        EngineerNumber: newEngineerNumber,
        FirstName: document.getElementById("firstName").value,
        LastName: document.getElementById("lastName").value,
        Username: document.getElementById("username").value,
        Email: document.getElementById("email").value,
        HashedPassword: hashedPassword,
        VehicleAssigned: document.getElementById("vehicle").value,
        EmploymentType: document.getElementById("employmentType").value,
        Status: "Active",
        FullAccess: "No",
        SharePointPath: document.getElementById("sharepoint").value
      };

      users.push(newUser);
      await fetch(workerURL + "/update-users", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ Users: users })
      });

      alert("âœ… User added!");
      popup.style.display = "none";
      buildUI();
    });

    buildUI();
  </script>
</body>
</html>
