<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>User Administration ‚Äì Mostlane Portal</title>
  <style>
    :root{
      --ml-blue:#004a99;
      --ml-blue-50:rgba(0,74,153,.08);
      --ink:#1f2937;
      --muted:#4b5563;
      --bg:#e6e8eb;
      --card:#fff;
      --glass:rgba(255,255,255,.75);
      --ok:#1b5e20;
      --ok-bg:#e9f7ef;
      --ok-bd:#c8e6c9;
      --err:#7f1d1d;
      --err-bg:#fee2e2;
      --err-bd:#fecaca;
      --warn:#8a5a00;
      --warn-bg:#fff6e5;
      --warn-bd:#ffe0b2;
    }
    html,body{height:100%}
    body {
      font-family: "Segoe UI", system-ui, -apple-system, Arial, sans-serif;
      background: var(--bg) url('Mostlane_Embossed.png') no-repeat center center fixed;
      background-size: cover;
      margin: 0;
      color: var(--ink);
    }

    /* Top bar */
    .topbar {
      position: sticky; top: 0; z-index: 50;
      background: var(--glass); backdrop-filter: blur(6px);
      box-shadow: 0 2px 10px rgba(0,0,0,.08);
      padding: 10px 14px;
      display: flex; align-items: center; justify-content: space-between;
      gap: 12px;
    }
    .topbar h1{margin:0; font-size:18px; color:var(--ml-blue); font-weight:600}
    .bar-actions{display:flex; gap:10px; align-items:center}
    .btn{
      border:none; border-radius:6px; padding:10px 14px; font-size:14px; cursor:pointer;
    }
    .btn-primary{background:var(--ml-blue); color:#fff}
    .btn-outline{background:#fff; color:var(--ml-blue); border:1px solid var(--ml-blue)}
    .btn-ghost{background:transparent; color:var(--ml-blue); border:1px dashed var(--ml-blue)}
    .btn:disabled{opacity:.6; cursor:not-allowed}

    .mini{
      display:inline-flex; align-items:center; gap:6px;
      font-size:12px; padding:6px 10px; border-radius:999px;
      color:var(--ml-blue); background:#fff; border:1px solid var(--ml-blue);
    }

    /* Banner */
    .banner {
      position: sticky; top: 56px; z-index: 45;
      margin: 10px 14px 0;
      border-radius:6px; padding:10px 12px; display:none;
    }
    .banner.show{display:block}
    .banner.ok{background:var(--ok-bg); border:1px solid var(--ok-bd); color:var(--ok)}
    .banner.err{background:var(--err-bg); border:1px solid var(--err-bd); color:var(--err)}
    .banner.warn{background:var(--warn-bg); border:1px solid var(--warn-bd); color:var(--warn)}
    .banner .close{float:right; cursor:pointer; margin-left:10px; font-weight:700}

    /* Wrap */
    .wrap{
      max-width: 1100px;
      margin: 16px auto 70px;
      padding: 0 14px 30px;
      background: rgba(255,255,255,.7);
      border-radius: 10px;
    }
    .subnote{padding:14px; color:#374151; font-size:14px}

    /* Utility row */
    .util {
      display:flex; flex-wrap:wrap; gap:10px; align-items:center; padding: 0 14px 10px;
    }
    .input{
      background:#fff; border:1px solid #d1d5db; border-radius:6px; padding:10px 12px; font-size:14px;
      min-width:150px;
    }
    .input:focus{outline:none; border-color:var(--ml-blue)}
    .spacer{flex:1}

    /* Cards */
    .user-card{
      background:#fff; border:1px solid #e5e7eb; border-radius:10px; margin:14px; padding:12px;
      box-shadow:0 1px 3px rgba(0,0,0,.04)
    }
    .user-header{
      display:flex; justify-content:space-between; align-items:center; gap:12px;
      color:var(--ml-blue); font-weight:600; margin-bottom:8px
    }
    .user-sub{font-size:13px; color:var(--muted); margin-bottom:6px}
    .grid{
      display:grid; grid-template-columns:repeat(2,minmax(0,1fr)); gap:8px 18px;
    }
    @media (max-width: 700px){ .grid{grid-template-columns:1fr} }

    .section-title{
      margin:10px 2px 4px; font-size:13px; font-weight:600; color:#374151;
      display:flex; align-items:center; gap:6px
    }
    .section-title .pill{
      font-size:11px; background:var(--ml-blue-50); color:var(--ml-blue);
      padding:4px 8px; border-radius:999px; border:1px solid var(--ml-blue)
    }

    .toggle-row{
      display:flex; align-items:center; justify-content:space-between; gap:12px; padding:6px 2px;
    }
    .toggle-row .lbl{font-size:14px; color:#111827; flex:1}
    .toggle-row .path{font-size:11px; color:#6b7280}
    .toggle-row.indent{ padding-left:22px; }

    .switch{ position:relative; display:inline-block; width:44px; height:24px; flex:0 0 auto }
    .switch input{display:none}
    .slider{
      position:absolute; cursor:pointer; inset:0; background:#d1d5db; border-radius:24px; transition:.25s
    }
    .slider:before{
      content:""; position:absolute; height:18px; width:18px; left:3px; bottom:3px;
      background:#fff; border-radius:50%; transition:.25s; box-shadow:0 1px 2px rgba(0,0,0,.15)
    }
    input:checked + .slider{background:var(--ml-blue)}
    input:checked + .slider:before{transform:translateX(20px)}

    /* Modal, Spinner, misc */
    .modal{ position:fixed; inset:0; background:rgba(0,0,0,.35); display:none; align-items:center; justify-content:center; z-index:60 }
    .modal.show{display:flex}
    .modal-card{ background:#fff; width:92%; max-width:480px; max-height:85vh; overflow:auto; border-radius:10px; padding:16px; box-shadow:0 10px 25px rgba(0,0,0,.15) }
    .modal h3{margin:0 0 10px; color:var(--ml-blue); font-size:18px}
    .field{margin-bottom:10px}
    .field label{display:block; font-size:12px; color:#374151; margin-bottom:4px}
    .field input{width:100%; padding:10px; border:1px solid #d1d5db; border-radius:6px; font-size:14px; background:#fff; box-sizing:border-box}
    .modal-actions{display:flex; gap:10px; justify-content:flex-end; margin-top:8px}

    .mask{ position:fixed; inset:0; display:none; align-items:center; justify-content:center; z-index:70; background:rgba(255,255,255,.55); backdrop-filter: blur(2px)}
    .mask.show{display:flex}
    .spinner{
      width:46px; height:46px; border-radius:50%; border:4px solid #c7d2fe; border-top-color: var(--ml-blue); animation:spin 1s linear infinite
    }
    @keyframes spin{ to{ transform: rotate(360deg) } }

    .small{font-size:12px; color:#6b7280}
    .kbd{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; background:#f3f4f6; border:1px solid #e5e7eb; border-radius:4px; padding:1px 4px}

    /* Submenu visibility (we toggle display via JS) */
    .submenu-row{ display:flex; }
  </style>
</head>
<body>

  <!-- Top bar -->
  <div class="topbar">
    <h1>User Administration</h1>
    <div class="bar-actions">
      <button class="btn btn-outline" id="rescanBtn">üîç Rescan Portal</button>
      <button class="btn btn-outline" id="reloadBtn">‚ü≤ Reload Users</button>
      <button class="btn btn-primary" id="saveBtn">üíæ Save Changes</button>
      <button class="btn btn-ghost" id="addUserBtn">‚ûï Add User</button>
    </div>
  </div>

  <!-- Banner -->
  <div id="banner" class="banner">
    <span class="close" id="bannerClose">‚úñ</span>
    <span id="bannerText">Status‚Ä¶</span>
  </div>

  <!-- Body -->
  <div class="wrap">
    <div class="subnote">
      This page auto-discovers buttons from <b>main.html</b> (and linked sub-menus),
      then shows matching toggles per user. <b>Full Access</b> overrides everything.
      <div class="small">
        Permissions are stored under stable keys per section, so settings will not reset even if you rename buttons or add emojis.
      </div>
    </div>

    <div class="util">

      <!-- Username dropdown -->
      <select id="userFilter" class="input" style="max-width:180px;">
        <option value="">All Users</option>
      </select>

      <input id="searchBox" class="input" placeholder="Search users (name / username / number)‚Ä¶" />
      <div class="spacer"></div>
      <span class="mini" id="structCount">Scanning‚Ä¶</span>
      <a class="mini" href="main.html" target="_blank" rel="noopener">Open main.html</a>
      <a class="mini" id="debugLink" href="https://mostlane-users.jamie-def.workers.dev/debug/bindings" target="_blank" rel="noopener">Bindings</a>
    </div>

    <div id="list">Loading users‚Ä¶</div>
  </div>

  <!-- Add User Modal -->

  <div id="addUserModal" class="modal" aria-hidden="true">
    <div class="modal-card">
      <h3>Add New User</h3>
      <div class="field"><label>First Name</label><input id="firstName" type="text" placeholder="First Name" required></div>
      <div class="field"><label>Last Name</label><input id="lastName" type="text" placeholder="Last Name" required></div>
      <div class="field"><label>Email (optional)</label><input id="email" type="email" placeholder="name@company.com"></div>
      <div class="field"><label>Username</label><input id="username" type="text" placeholder="e.g. John.Doe" required></div>
      <div class="field"><label>Password</label><input id="password" type="password" placeholder="Initial password" required></div>
      <div class="field"><label>Vehicle Assigned (optional)</label><input id="vehicle" type="text" placeholder="e.g. WP64 EJD"></div>
      <div class="field"><label>Employment Type</label><input id="employmentType" type="text" placeholder="Employed / Self Employed"></div>
      <div class="field"><label>SharePoint Path URL</label><input id="sharepoint" type="text" placeholder="Full SharePoint folder link"></div>
      <div class="modal-actions"><button class="btn btn-outline" id="cancelAdd">Cancel</button><button class="btn btn-primary" id="createUserBtn">Create User</button></div>
    </div>
  </div>

  <!-- Manage User Modal (ADDED) -->
  <div id="manageUserModal" class="modal" aria-hidden="true">
    <div class="modal-card">
      <h3>Manage User</h3>

      <div class="field"><label>Engineer Number</label><input id="mu_engineerNumber" type="text" disabled></div>
      <div class="field"><label>Username</label><input id="mu_username" type="text" disabled></div>

      <div class="field"><label>First Name</label><input id="mu_firstName" type="text"></div>
      <div class="field"><label>Last Name</label><input id="mu_lastName" type="text"></div>
      <div class="field"><label>Email</label><input id="mu_email" type="email"></div>

      <div class="field"><label>Vehicle Assigned</label><input id="mu_vehicle" type="text" placeholder="e.g. WP64 EJD"></div>
      <div class="field"><label>Employment Type</label><input id="mu_employmentType" type="text" placeholder="Employed / Self Employed"></div>
      <div class="field"><label>Status</label><input id="mu_status" type="text" placeholder="Active / Not Active"></div>
      <div class="field"><label>SharePoint Path URL</label><input id="mu_sharepoint" type="text" placeholder="Full SharePoint folder link"></div>

      <div class="field"><label>Reset Password (optional)</label><input id="mu_password" type="password" placeholder="Leave blank to keep existing"></div>

      <div class="modal-actions">
        <button class="btn btn-outline" id="cancelManage">Cancel</button>
        <button class="btn btn-primary" id="saveManageBtn">Save</button>
      </div>
    </div>
  </div>

  <div class="mask" id="mask"><div class="spinner" aria-label="Loading"></div></div>

  <script>
    const API_BASE = "https://mostlane-users.jamie-def.workers.dev";
    const USERS_URL = API_BASE + "/users";
    const SAVE_URL  = API_BASE + "/save";
    const TOKEN     = sessionStorage.getItem("mostlaneToken");
    const CURRENT   = sessionStorage.getItem("mostlaneUser");
    if (!CURRENT) { window.location.href = "login.html"; }

    const banner = document.getElementById('banner');
    const bannerText = document.getElementById('bannerText');
    const bannerClose = document.getElementById('bannerClose');
    const mask = document.getElementById('mask');
    const list = document.getElementById('list');
    const structCount = document.getElementById('structCount');
    const userFilter = document.getElementById('userFilter');
    const searchBox = document.getElementById('searchBox');

    function showMask(on=true){mask.classList.toggle('show',!!on);}
    function showBanner(msg,type='ok'){
      banner.classList.remove('ok','err','warn');
      banner.classList.add(type);
      bannerText.textContent=msg;
      banner.classList.add('show');
      setTimeout(()=>banner.classList.remove('show'),5000);
    }
    bannerClose.addEventListener('click',()=>banner.classList.remove('show'));

    function h(tag,attrs={},...children){
      const el=document.createElement(tag);
      for(const[k,v]of Object.entries(attrs||{})){
        if(k==='class') el.className=v;
        else if(k.startsWith('on')&&typeof v==='function') el.addEventListener(k.slice(2),v);
        else el.setAttribute(k,v);
      }
      for(const c of children){
        if(c==null) continue;
        if(typeof c==='string') el.appendChild(document.createTextNode(c));
        else el.appendChild(c);
      }
      return el;
    }

    function debounce(fn,ms=250){
      let t;return(...args)=>{clearTimeout(t);t=setTimeout(()=>fn(...args),ms);};
    }

    async function sha256Hex(s){
      const enc=new TextEncoder();
      const buf=await crypto.subtle.digest('SHA-256',enc.encode((s||'').trim()));
      return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,'0')).join('');
    }

    function normalizeIdForKey(s){
      return (s||'').trim().toLowerCase().replace(/[^\w]+/g,'');
    }

   // üîë Map DOM id/label/href ‚Üí stable permission key (SAFE VERSION)
function mapToPermKey(id, label, href) {
  const mapByExact = {
    "CheckInOut": "CheckInOut",
    "Vehicles": "Vehicles",
    "Holiday": "Holiday",
    "EngineersHoursMenu": "EngineersHoursMenu",
    "PurchaseOrders": "PurchaseOrders",
    "PurchaseOrders2": "PurchaseOrders",
    "Sites": "Sites",
    "Assets": "Assets",
    "MyDocuments": "MyDocuments",
    "Compliance": "Compliance",
    "HoursDashboard": "HoursDashboard",
    "Users": "Users",
    "Weekly": "Weekly",
    "Forms": "Forms",
    "SLA": "SLA",
    "SLA Menu": "SLA",
    "HolidayAdmin": "Holiday Admin"
  };

  // Direct match on ID or label
  if (id && mapByExact[id]) return mapByExact[id];
  if (label && mapByExact[label]) return mapByExact[label];

  // Only *.html internal pages
  if (href && href.endsWith(".html")) {
    const clean = href.toLowerCase();

    if (clean.includes("sla")) return "SLA";
    if (clean.includes("users")) return "Users";
    if (clean.includes("weekly")) return "Weekly";
    if (clean.includes("assets")) return "Assets";
    if (clean.includes("forms")) return "Forms";
    if (clean.includes("compliance")) return "Compliance";
    if (clean.includes("purchase")) return "PurchaseOrders";
    if (clean.includes("sites")) return "Sites";
    if (clean.includes("checkin") || clean.includes("checkout")) return "CheckInOut";
  }

  // ‚ùå Reject all external links, javascript:void(), forms, etc.
  return null;
}
    // üîç Scan main.html + submenus ‚Üí structure with stable keys
    async function scanPortal(){
      const parser=new DOMParser();
      const visited=new Set();
      const struct=[];

      async function scanPage(url,depth=0){
        if(!url || visited.has(url)) return [];
        visited.add(url);
        try{
          const fullUrl = url + (url.includes('?')?'&':'?') + 'v=' + Date.now();
          const res=await fetch(fullUrl,{cache:'no-store'});
          const html=await res.text();
          const doc=parser.parseFromString(html,'text/html');

          // Support emoji buttons as long as they have these classes
          const rawButtons = [
            ...doc.querySelectorAll('a.button,button.button,a.menu-btn,button.menu-btn')
          ];

          const buttons = rawButtons.map(b=>{
            const id = b.id || '';
            const label = (b.textContent || '').trim();
            const hrefAttr = b.getAttribute('href') || '';
            const href = hrefAttr;
            const key = mapToPermKey(id,label,href);
            return { id, label, href, key, subpages: [] };
          }).filter(b => !!b.key); // only keep ones with a key

          if (depth < 2){
            for (const btn of buttons){
              if (btn.href && /\.html$/i.test(btn.href) && !/login\.html/i.test(btn.href)){
                const nextUrl = new URL(btn.href, url).toString();
                const subs = await scanPage(nextUrl, depth+1);
                btn.subpages = subs;
              }
            }
          }

          return buttons;
        }catch(e){
          console.warn('Scan failed for',url,e);
          return [];
        }
      }

      const rootUrl = new URL('main.html', window.location.href).toString();
      struct.push(...await scanPage(rootUrl));
      structCount.textContent = `Discovered ${struct.length} main buttons (deep scan)`;
      return struct;
    }

    async function fetchAllUsers(){
      const res=await fetch(USERS_URL+'?v='+Date.now(),{
        headers: TOKEN ? {'Authorization':'Bearer '+TOKEN} : {}
      });
      if(!res.ok) throw new Error('Failed to fetch users');
      const data=await res.json();
      return data.Users || [];
    }

    async function saveUsers(users){
      const res=await fetch(SAVE_URL,{
        method:'POST',
        headers:Object.assign({'Content-Type':'application/json'},TOKEN?{'Authorization':'Bearer '+TOKEN}:{}),
        body:JSON.stringify({Users:users})
      });
      if(!res.ok){
        const txt=await res.text().catch(()=> '');
        throw new Error('Save failed: '+txt);
      }
    }

    function switchControl(domId,checked,permKey,role){
      const inputAttrs = {
        type:'checkbox',
        id:domId,
        'data-key':permKey,
        'data-role':role || 'main'
      };
      if (checked) inputAttrs.checked = true;
      return h('label',{class:'switch'},
        h('input',inputAttrs),
        h('span',{class:'slider'})
      );
    }

    function toggleRow(user,permKey,label,href,checked,indent=false,role='main',parentKey=null){
      const pathSpan = href ? h('span',{class:'path'},href) : null;
      const rowClasses = ['toggle-row'];
      if (indent) rowClasses.push('indent');
      if (role === 'sub') rowClasses.push('submenu-row');

      const attrs = {class:rowClasses.join(' ')};
      if (role === 'sub' && parentKey) {
        attrs['data-parent'] = parentKey;
      }

      const domId = `${user.Username}::${permKey}__chk`;

      return h('div',attrs,
        h('div',{class:'lbl'},
          label || permKey || '(unnamed)',
          pathSpan ? h('div',null,pathSpan) : null
        ),
        switchControl(domId,!!checked,permKey,role)
      );
    }

    // Manage Modal Logic (ADDED)
    const manageModal = document.getElementById('manageUserModal');
    let __MANAGING = null;

    const openManage = (user)=>{
      __MANAGING = user;
      document.getElementById('mu_engineerNumber').value = user.EngineerNumber || '';
      document.getElementById('mu_username').value = user.Username || '';
      document.getElementById('mu_firstName').value = user.FirstName || '';
      document.getElementById('mu_lastName').value = user.LastName || '';
      document.getElementById('mu_email').value = user.Email || '';
      document.getElementById('mu_vehicle').value = user.VehicleAssigned || '';
      document.getElementById('mu_employmentType').value = user.EmploymentType || '';
      document.getElementById('mu_status').value = user.Status || '';
      document.getElementById('mu_sharepoint').value = user.SharePointPath || '';
      document.getElementById('mu_password').value = '';
      manageModal.classList.add('show');
      manageModal.setAttribute('aria-hidden','false');
    };
    const closeManage = ()=>{
      manageModal.classList.remove('show');
      manageModal.setAttribute('aria-hidden','true');
      __MANAGING = null;
    };

    document.getElementById('cancelManage').addEventListener('click',closeManage);

    document.getElementById('saveManageBtn').addEventListener('click',async()=>{
      if(!__MANAGING) return;

      try{
        showMask(true);

        __MANAGING.FirstName = document.getElementById('mu_firstName').value.trim();
        __MANAGING.LastName = document.getElementById('mu_lastName').value.trim();
        __MANAGING.Email = document.getElementById('mu_email').value.trim();
        __MANAGING.VehicleAssigned = document.getElementById('mu_vehicle').value.trim();
        __MANAGING.EmploymentType = document.getElementById('mu_employmentType').value.trim();
        __MANAGING.Status = document.getElementById('mu_status').value.trim();
        __MANAGING.SharePointPath = document.getElementById('mu_sharepoint').value.trim();

        const newPw = document.getElementById('mu_password').value;
        if(newPw && newPw.trim()){
          __MANAGING.HashedPassword = await sha256Hex(newPw);
        }

        await saveUsers(__USERS);

        // Update visible fields without re-rendering permissions (ADDED)
        const nameEl = document.getElementById(`name_${__MANAGING.Username}`);
        const subEl = document.getElementById(`sub_${__MANAGING.Username}`);
        if(nameEl){
          nameEl.innerHTML = `${__MANAGING.EngineerNumber ? ('#'+__MANAGING.EngineerNumber+' ‚Äì ') : ''}${__MANAGING.FirstName||''} ${__MANAGING.LastName||''} <span style="color:#6b7280;font-weight:500">(${__MANAGING.Username})</span>`;
        }
        if(subEl){
          subEl.textContent = `${__MANAGING.EmploymentType||''} ¬∑ ${__MANAGING.Status||''} ¬∑ ${__MANAGING.Email||''}`;
        }

        closeManage();
        showBanner('‚úÖ User updated successfully.','ok');
      }catch(err){
        console.error(err);
        showBanner('‚ùå Could not update user. '+(err?.message||''),'err');
      }finally{
        showMask(false);
      }
    });

    function userCard(user,structure){
      const header = h('div',{class:'user-header'},
        h('div',{id:`name_${user.Username}`},
          `${user.EngineerNumber ? ('#'+user.EngineerNumber+' ‚Äì ') : ''}${user.FirstName||''} ${user.LastName||''} `,
          h('span',{style:'color:#6b7280;font-weight:500'},`(${user.Username})`)
        ),
        h('div',null,
          h('div',{style:'display:flex;justify-content:flex-end;margin-bottom:6px'},
            h('button',{class:'btn btn-outline',style:'padding:6px 10px;font-size:12px',onclick:()=>openManage(user)},'‚öô Manage')
          ),
          h('div',{class:'toggle-row'},
            h('span',{class:'lbl'},'Full Access'),
            switchControl(`fa_${user.Username}__chk`,(user.FullAccess||'').toLowerCase()==='yes','FullAccess','fa')
          )
        )
      );

      const sub = h('div',{class:'user-sub',id:`sub_${user.Username}`},
        `${user.EmploymentType||''} ¬∑ ${user.Status||''} ¬∑ ${user.Email||''}`
      );

      const grid = h('div',{class:'grid'});
      grid.appendChild(
        h('div',{class:'section-title'},
          'Main Menu',
          h('span',{class:'pill'},'auto')
        )
      );

      // Main buttons
      structure.forEach(p=>{
        const permKey = p.key || mapToPermKey(p.id,p.label,p.href);
        if (!permKey) return;
        const currentOn = ((user[permKey] || '').toLowerCase() === 'yes');
        grid.appendChild(
          toggleRow(user,permKey,p.label,p.href,currentOn,false,'main',null)
        );
      });

      // Sub menus
      const subs = structure.flatMap(s=>s.subpages || []);
      if (subs.length){
        grid.appendChild(
          h('div',{
            class:'section-title',
            style:'grid-column:1/-1'
          },
          'Sub-menus',
          h('span',{class:'pill'},String(subs.length)))
        );

        structure.forEach(p=>{
          const parentKey = p.key || mapToPermKey(p.id,p.label,p.href);
          if (!parentKey) return;
          (p.subpages || []).forEach(sp=>{
            const sid = sp.key || mapToPermKey(sp.id,sp.label,sp.href);
            if (!sid) return;
            const on = ((user[sid] || '').toLowerCase() === 'yes');
            grid.appendChild(
              toggleRow(user,sid,sp.label,sp.href,on,true,'sub',parentKey)
            );
          });
        });
      }

      return h('div',{class:'user-card'},header,sub,grid);
    }

    function initSubmenuVisibility(){
      // For each user card, tie submenus to their main switches
      document.querySelectorAll('.user-card').forEach(card=>{
        const mains = card.querySelectorAll('input[type="checkbox"][data-role="main"]');
        mains.forEach(main=>{
          const key = main.getAttribute('data-key');
          if (!key) return;
          const rows = card.querySelectorAll(`.submenu-row[data-parent="${key}"]`);
          const sync = ()=>{
            const show = main.checked;
            rows.forEach(r=>{
              r.style.display = show ? 'flex' : 'none';
            });
          };
          main.addEventListener('change', sync);
          // initial state
          sync();
        });
      });
    }

    function renderUsers(users,structure){
      list.innerHTML='';
      if(!users.length){
        list.textContent='No users found.';
        return;
      }
      users.forEach(u=>list.appendChild(userCard(u,structure)));
      initSubmenuVisibility();
    }

    let __USERS = [];
    let __STRUCT = [];

    async function buildUI(){
      showMask(true);
      try{
        const [users,struct] = await Promise.all([fetchAllUsers(),scanPortal()]);
        __USERS = users;
        __STRUCT = struct;

        // Populate username dropdown
        userFilter.innerHTML = '<option value="">All Users</option>';
        __USERS.forEach(u=>{
          const uname = u.Username || '';
          if (!uname) return;
          const opt = document.createElement('option');
          opt.value = uname;
          opt.textContent = uname;
          userFilter.appendChild(opt);
        });

        renderUsers(__USERS,__STRUCT);
      }
      catch(err){
        console.error(err);
        list.textContent='Failed to load. Check Worker and network.';
        showBanner('‚ùå Failed to load users or scan portal','err');
      }
      finally{
        showMask(false);
      }
    }

    let saving=false;
    async function saveAll(){
      if(saving) return;
      if(!__USERS || !__STRUCT) return;
      saving = true;
      showMask(true);
      try{
        const users = JSON.parse(JSON.stringify(__USERS));

        users.forEach(u=>{
          // Full Access
          const faEl = document.getElementById(`fa_${u.Username}__chk`);
          u.FullAccess = (faEl && faEl.checked) ? 'Yes' : 'No';

          const assign = (permKey)=>{
            if (!permKey) return;
            const chk = document.getElementById(`${u.Username}::${permKey}__chk`);
            const val = (chk && chk.checked) ? 'Yes' : 'No';
            u[permKey] = val;
          };
__STRUCT.forEach(p => {
  const parentKey = p.key || mapToPermKey(p.id, p.label, p.href);
  if (parentKey) assign(parentKey);

  (p.subpages || []).forEach(sp => {
    const sid = sp.key || mapToPermKey(sp.id, sp.label, sp.href);
    if (sid) assign(sid);
  });
});
        });

        await saveUsers(users);
        __USERS = users;
        showBanner('‚úÖ Changes saved successfully.','ok');
      }
      catch(err){
        console.error(err);
        showBanner('‚ùå Save failed. '+(err?.message||''),'err');
      }
      finally{
        showMask(false);
        saving=false;
      }
    }

    // Modal logic
    const modal=document.getElementById('addUserModal');
    const openAdd=()=>{modal.classList.add('show');modal.setAttribute('aria-hidden','false');};
    const closeAdd=()=>{modal.classList.remove('show');modal.setAttribute('aria-hidden','true');};

    document.getElementById('addUserBtn').addEventListener('click',openAdd);
    document.getElementById('cancelAdd').addEventListener('click',closeAdd);

    async function createUser(){
      try{
        showMask(true);
        const res=await fetch(USERS_URL+'?v='+Date.now(),{
          headers:TOKEN?{'Authorization':'Bearer '+TOKEN}:{}
        });
        const data=await res.json();
        const users=data.Users||[];
        const maxNum=users.reduce((m,u)=>{
          const n=parseInt(u.EngineerNumber,10);
          return isNaN(n)?m:Math.max(m,n);
        },0);
        const nextNum=String(maxNum+1);

        const firstName=document.getElementById('firstName').value.trim();
        const lastName=document.getElementById('lastName').value.trim();
        const email=document.getElementById('email').value.trim();
        const username=document.getElementById('username').value.trim();
        const password=document.getElementById('password').value;
        const vehicle=document.getElementById('vehicle').value.trim();
        const empType=document.getElementById('employmentType').value.trim();
        const spPath=document.getElementById('sharepoint').value.trim();

        if(!firstName||!lastName||!username||!password){
          showBanner('‚ùå Please complete First, Last, Username and Password.','err');
          return;
        }

        const hashedPassword=await sha256Hex(password);

        const newUser={
          EngineerNumber:nextNum,
          FirstName:firstName,
          LastName:lastName,
          Username:username,
          Email:email,
          HashedPassword:hashedPassword,
          VehicleAssigned:vehicle,
          EmploymentType:empType||'Employed',
          Status:'Active',
          FullAccess:'No',
          SharePointPath:spPath
        };

        users.push(newUser);
        await saveUsers(users);
        closeAdd();
        showBanner('‚úÖ User added.','ok');
        buildUI();
      }
      catch(err){
        console.error(err);
        showBanner('‚ùå Could not add user. '+(err?.message||''),'err');
      }
      finally{
        showMask(false);
      }
    }

    document.getElementById('createUserBtn').addEventListener('click',createUser);

    // Combined search + filter
    function applyFilters() {
      const q = (searchBox.value || '').trim().toLowerCase();
      const selected = userFilter.value;

      let filtered = __USERS || [];

      if (selected) {
        filtered = filtered.filter(u => (u.Username || '') === selected);
      }

      if (q) {
        filtered = filtered.filter(u =>
          (u.FirstName || '').toLowerCase().includes(q) ||
          (u.LastName || '').toLowerCase().includes(q) ||
          (u.Username || '').toLowerCase().includes(q) ||
          String(u.EngineerNumber || '').includes(q)
        );
      }

      renderUsers(filtered, __STRUCT);
    }

    searchBox.addEventListener('input', debounce(applyFilters, 150));
    userFilter.addEventListener('change', applyFilters);

    document.getElementById('saveBtn').addEventListener('click',saveAll);
    document.getElementById('reloadBtn').addEventListener('click',buildUI);
    document.getElementById('rescanBtn').addEventListener('click',async()=>{
      showMask(true);
      try{
        __STRUCT = await scanPortal();
        renderUsers(__USERS,__STRUCT);
        showBanner('üîÑ Scan complete. Buttons refreshed.','ok');
      }
      catch(e){
        console.error(e);
        showBanner('‚ùå Scan failed','err');
      }
      finally{
        showMask(false);
      }
    });

    (async()=>{await buildUI();})();
  </script>

</body>
</html>
