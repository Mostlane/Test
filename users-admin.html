<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>User Admin â€“ Mostlane Portal</title>
  <script src="auth.js"></script>
  <style>
    body {
      font-family: "Segoe UI", sans-serif;
      background: #e6e8eb url('Mostlane_Embossed.png') no-repeat center center fixed;
      background-size: cover;
      margin: 0; padding: 30px; color: #1f2937;
    }
    h2 { text-align: center; color: #003366; }
    table.user-table {
      width: 100%; border-collapse: collapse; margin-top: 20px;
      background: rgba(255,255,255,0.9); font-size: 14px;
    }
    table.user-table th, table.user-table td {
      border: 1px solid #ccc; padding: 8px; text-align: center;
    }
    table.user-table th { background-color: #004a99; color: white; }
    .controls { margin-top: 15px; text-align: center; }
    button {
      background-color: #004a99; color: white; border: none;
      padding: 10px 20px; border-radius: 6px; font-size: 15px;
      cursor: pointer; margin: 4px;
    }
    button:hover { opacity: 0.9; }

    /* Toggle */
    .switch { position: relative; display: inline-block; width: 38px; height: 20px; }
    .switch input { opacity: 0; width: 0; height: 0; }
    .slider {
      position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0;
      background-color: #ccc; transition: .3s; border-radius: 20px;
    }
    .slider:before {
      position: absolute; content: ""; height: 16px; width: 16px;
      left: 2px; bottom: 2px; background-color: white;
      transition: .3s; border-radius: 50%;
    }
    input:checked + .slider { background-color: #004a99; }
    input:checked + .slider:before { transform: translateX(18px); }

    /* Modal */
    .modal {
      display: none; position: fixed; z-index: 999;
      left: 0; top: 0; width: 100%; height: 100%;
      overflow-y: auto; background-color: rgba(0,0,0,0.6);
    }
    .modal-content {
      background-color: #fff; margin: 60px auto; padding: 20px;
      border-radius: 10px; width: 90%; max-width: 400px;
      box-shadow: 0 0 15px rgba(0,0,0,0.2);
    }
    .modal-content input, .modal-content select {
      width: 95%; margin: 6px 0; padding: 10px;
      border: 1px solid #ccc; border-radius: 5px; font-size: 14px;
    }
    .close { float: right; font-size: 24px; font-weight: bold; color: #555; cursor: pointer; }
    .close:hover { color: #000; }
  </style>
</head>
<body>
  <h2>Users Admin Panel</h2>

  <div class="controls" style="text-align:right;">
    <button id="openAddUser">âž• Add New User</button>
  </div>

  <!-- Add User Popup -->
  <div id="addUserModal" class="modal">
    <div class="modal-content">
      <span class="close">&times;</span>
      <h3>Add New User</h3>
      <input type="text" id="newFirstName" placeholder="First Name" />
      <input type="text" id="newLastName" placeholder="Last Name" />
      <input type="text" id="newUsername" placeholder="Username (e.g. Jamie.Line)" />
      <input type="email" id="newEmail" placeholder="Email" />
      <input type="password" id="newPassword" placeholder="Password" />
      <input type="url" id="newSharePointPath" placeholder="SharePoint URL" />
      <select id="newEmployment">
        <option value="Employed">Employed</option>
        <option value="Self Employed">Self Employed</option>
      </select><br><br>
      <button id="addUserBtn">âœ… Save User</button>
    </div>
  </div>

  <table class="user-table" id="usersTable">
    <thead><tr id="headerRow"></tr></thead>
    <tbody></tbody>
  </table>

  <div class="controls">
    <button id="saveBtn">ðŸ’¾ Save Changes to KV</button>
    <p id="saveStatus" style="margin-top:10px;font-weight:bold;color:#004a99;"></p>
  </div>

  <script>
    const USERS_URL = "https://mostlane-users.jamie-def.workers.dev/users";
    const SAVE_URL  = "https://mostlane-users.jamie-def.workers.dev/save";
    const MAIN_HTML_URL = "https://mostlane.github.io/Test/main.html";

    let usersData = [];
    let buttonFields = [];

    async function hashPassword(pw) {
      const data = new TextEncoder().encode(pw.trim());
      const buf = await crypto.subtle.digest("SHA-256", data);
      return Array.from(new Uint8Array(buf)).map(b => b.toString(16).padStart(2,"0")).join("");
    }
    const makeToggle = (v)=>`<label class="switch"><input type="checkbox" ${(v||"").toLowerCase()==="yes"?"checked":""}><span class="slider"></span></label>`;

    async function loadButtonsFromMain(){
      const html = await fetch(MAIN_HTML_URL+"?v="+Date.now()).then(r=>r.text());
      const doc = new DOMParser().parseFromString(html,"text/html");
      const buttons=[...doc.querySelectorAll("a.button")];
      return buttons.map(b=>({id:b.id,label:b.textContent.trim()}));
    }

    async function loadUsers(){
      buttonFields = await loadButtonsFromMain();
      const res = await fetch(USERS_URL+"?v="+Date.now());
      const data = await res.json();
      usersData = data.Users;
      const header = document.getElementById("headerRow");
      header.innerHTML="<th>Engineer #</th><th>Username</th><th>Status</th><th>Full Access</th>";
      buttonFields.forEach(b=>header.innerHTML+=`<th>${b.label}</th>`);
      const tbody=document.querySelector("#usersTable tbody"); tbody.innerHTML="";
      usersData.forEach(u=>{
        const row=document.createElement("tr");
        row.innerHTML=`<td>${u.EngineerNumber || ''}</td>
          <td>${u.Username}</td>
          <td><select><option ${u.Status==="Active"?"selected":""}>Active</option>
          <option ${u.Status==="Not Active"?"selected":""}>Not Active</option></select></td>
          <td>${makeToggle(u.FullAccess)}</td>`;
        buttonFields.forEach(f=>{
          const key=f.label.replace(/\s+/g,"");
          row.innerHTML+=`<td>${makeToggle(u[key])}</td>`;
        });
        tbody.appendChild(row);
      });
    }

    async function saveUsers(){
      const rows=document.querySelectorAll("#usersTable tbody tr");
      rows.forEach((r,i)=>{
        const selects=r.querySelectorAll("select");
        const checks=r.querySelectorAll("input[type='checkbox']");
        usersData[i].Status=selects[0].value;
        usersData[i].FullAccess=checks[0].checked?"Yes":"No";
        buttonFields.forEach((f,j)=>{
          const key=f.label.replace(/\s+/g,"");
          usersData[i][key]=checks[j+1].checked?"Yes":"No";
        });
      });
      const res=await fetch(SAVE_URL,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({Users:usersData})});
      const result=await res.json();
      document.getElementById("saveStatus").textContent=result.ok?"âœ… Saved successfully!":"âŒ Save failed.";
    }

    async function addNewUser(){
      const f=n=>document.getElementById(n).value.trim();
      if(!f("newFirstName")||!f("newLastName")||!f("newUsername")||!f("newPassword")){alert("Please fill all required fields.");return;}
      const hashed=await hashPassword(f("newPassword"));

      // Automatically allocate next engineer number
      const currentNumbers = usersData
        .map(u => parseInt(u.EngineerNumber || 0))
        .filter(n => !isNaN(n));
      const nextNumber = Math.max(0, ...currentNumbers) + 1;

      const newU={
        EngineerNumber: nextNumber.toString(),
        FirstName:f("newFirstName"),LastName:f("newLastName"),
        Username:f("newUsername"),Email:f("newEmail"),
        HashedPassword:hashed,VehicleAssigned:"",
        EmploymentType:f("newEmployment"),Status:"Active",
        FullAccess:"No", SharePointPath:f("newSharePointPath")
      };
      buttonFields.forEach(fld=>{newU[fld.label.replace(/\s+/g,"")]="No";});
      usersData.push(newU);
      await saveUsers(); await loadUsers();
      ["newFirstName","newLastName","newUsername","newEmail","newPassword","newSharePointPath"].forEach(id=>document.getElementById(id).value="");
      document.getElementById("addUserModal").style.display="none"; document.body.style.overflow="auto";
    }

    // Modal handling
    const modal=document.getElementById("addUserModal"),
          openBtn=document.getElementById("openAddUser"),
          closeBtn=document.querySelector(".close");
    openBtn.onclick=()=>{modal.style.display="block";document.body.style.overflow="hidden";};
    closeBtn.onclick=()=>{modal.style.display="none";document.body.style.overflow="auto";};
    window.onclick=e=>{if(e.target===modal){modal.style.display="none";document.body.style.overflow="auto";}};
    document.getElementById("saveBtn").onclick=saveUsers;
    document.getElementById("addUserBtn").onclick=addNewUser;

    // Restrict access
    if(sessionStorage.getItem("mostlaneUser")!=="Jamie.Line"){
      document.body.innerHTML="<h2 style='color:red;text-align:center;margin-top:50px;'>Access Denied</h2>";
    }else{loadUsers();}
  </script>
</body>
</html>
