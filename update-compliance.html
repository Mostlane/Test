<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Retail Compliance Editor</title>
  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background: url('Mostlane_Embossed.png') no-repeat center center fixed;
      background-size: 180%;
      color: #1f2937;
      background-color: #e6e8eb;
    }
    .container {
      background-color: rgba(255, 255, 255, 0.65);
      margin: 20px auto;
      padding: 20px;
      border-radius: 15px;
      max-width: 95%;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    }
    h1 { text-align: center; color: #0071CE; }
    .logo { display: block; margin: 10px auto 20px auto; max-height: 60px; }

    .banner {
      background-color: #0071CE;
      color: white;
      text-align: center;
      padding: 8px;
      border-radius: 10px;
      display: none;
      margin-bottom: 15px;
    }

    .search-row {
      display: flex;
      justify-content: center;
      margin-bottom: 15px;
      gap: 8px;
    }
    .search-row input {
      padding: 8px;
      border-radius: 5px;
      border: 1px solid #ccc;
      width: 300px;
    }
    .search-row button {
      background-color: #0071CE;
      color: white;
      border: none;
      padding: 8px 15px;
      border-radius: 5px;
      cursor: pointer;
      font-weight: bold;
    }

    .operator {
      text-align: right;
      font-weight: bold;
      color: #333;
      margin-bottom: 10px;
    }

    .store-card {
      background: white;
      border-radius: 10px;
      padding: 15px;
      margin: 15px 0;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    .store-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: #0071CE;
      color: white;
      padding: 8px 12px;
      border-radius: 6px;
      margin-bottom: 10px;
    }
    .store-header a {
      color: white;
      text-decoration: underline;
      font-weight: bold;
    }
    .compliance-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 10px;
      text-align: center;
    }
    .compliance-item {
      background: #f9f9f9;
      border-radius: 8px;
      padding: 8px;
      border: 1px solid #ccc;
    }
    .compliance-item strong {
      display: block;
      margin-bottom: 3px;
      color: #0071CE;
    }
    .shortcut-btn {
      display: inline-block;
      margin-top: 6px;
      padding: 4px 8px;
      border-radius: 5px;
      background: #0071CE;
      color: white;
      cursor: pointer;
      border: none;
      font-size: 13px;
    }

    #reviewBtn {
      display: none;
      background: #0071CE;
      color: white;
      border: none;
      border-radius: 8px;
      padding: 10px 20px;
      font-weight: bold;
      cursor: pointer;
      margin: 20px auto;
      display: block;
    }

    #sendStatus {
      text-align: center;
      font-weight: bold;
      color: #0071CE;
      margin-top: 10px;
    }

    .modal {
      display: none;
      position: fixed;
      z-index: 999;
      left: 0; top: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.5);
    }
    .modal-content {
      background: white;
      border-radius: 10px;
      max-width: 600px;
      margin: 10% auto;
      padding: 20px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.3);
      text-align: left;
      white-space: pre-wrap;
    }
    .modal-content h2 {
      color: #0071CE;
      text-align: center;
    }
    .modal button {
      background: #0071CE;
      color: white;
      border: none;
      border-radius: 5px;
      padding: 8px 14px;
      margin-top: 10px;
      cursor: pointer;
    }
    .close-btn {
      float: right;
      background: #ccc;
      color: black;
    }

  </style>
</head>
<body>
  <div class="container">
    <img src="mostlane-logo.jpg" alt="Mostlane Logo" class="logo">
    <h1>Retail Compliance Editor</h1>
    <div id="banner" class="banner">‚úÖ Data loaded successfully.</div>
    <div class="operator" id="operatorName">Operator: Unknown</div>

    <div class="search-row">
      <input type="text" id="searchInput" placeholder="Enter store name or code..." />
      <button onclick="searchStore()">Search</button>
    </div>

    <div id="storeCards"></div>

    <button id="reviewBtn" onclick="openModal()">üëÄ Review Changes</button>
    <div id="sendStatus"></div>
  </div>

  <div id="previewModal" class="modal">
    <div class="modal-content">
      <button class="close-btn" onclick="closeModal()">X</button>
      <h2>Preview JSON Changes</h2>
      <pre id="jsonPreview"></pre>
      <button onclick="sendToZapier()">Send to Zapier</button>
      <button onclick="closeModal()">Cancel</button>
      <div id="sendStatus"></div>
    </div>
  </div>

  <script>
    const ZAPIER_WEBHOOK = "https://hooks.zapier.com/hooks/catch/20261714/urh99ln/";
    let allCompliance = [];
    let allSites = [];
    let updates = [];

    async function fetchData() {
      try {
        const [compRes, siteRes] = await Promise.all([
          fetch("https://raw.githubusercontent.com/Mostlane/Test/main/Compliance/retail_compliance.json"),
          fetch("https://raw.githubusercontent.com/Mostlane/Test/main/Sites/retail.json")
        ]);
        allCompliance = await compRes.json();
        allSites = await siteRes.json();
        document.getElementById("banner").style.display = "block";
      } catch (e) {
        alert("Failed to load data: " + e.message);
      }
    }

    function getOperatorName() {
      const user = sessionStorage.getItem("mostlaneUser") || "Unknown";
      return user.replace(".", " ");
    }

    document.getElementById("operatorName").textContent = "Operator: " + getOperatorName();

    function searchStore() {
      const query = document.getElementById("searchInput").value.toLowerCase();
      const container = document.getElementById("storeCards");
      container.innerHTML = "";

      const matches = Object.values(allCompliance).filter(s =>
        s.storeName.toLowerCase().includes(query) || s.branchCode.toString().includes(query)
      );

      matches.forEach(store => {
        const site = allSites.find(s => s.branchCode === store.branchCode);
        const spLink = site && site.sharePointURL ? site.sharePointURL : "#";
        const card = document.createElement("div");
        card.className = "store-card";
        card.innerHTML = `
          <div class="store-header">
            <strong>${store.branchCode} ‚Äì ${store.storeName}</strong>
            <a href="${spLink}" target="_blank">Open SharePoint</a>
          </div>
          <div class="compliance-grid">
            ${createComplianceItem("5 Year", store["5_Year"], "5_Year")}
            ${createComplianceItem("PAT", store["PAT"], "PAT")}
            ${createComplianceItem("EM", store["EM"], "EM")}
            ${createComplianceItem("PV", store["PV"], "PV")}
            ${createComplianceItem("EV", store["EV"], "EV")}
            ${createComplianceItem("PUMP", store["PUMP"], "PUMP")}
          </div>
        `;
        container.appendChild(card);
      });
    }

    function createComplianceItem(label, value, key) {
      return `
        <div class="compliance-item">
          <strong>${label}</strong>
          <div>Current: ${value || "-"}</div>
          <button class="shortcut-btn" onclick="updateDate('${key}', ${getMonths(key)})">+${getMonths(key)} mo</button>
        </div>
      `;
    }

    function getMonths(key) {
      if (key === "5_Year") return 60;
      if (key === "PUMP") return 1;
      return 12;
    }

    function updateDate(key, months) {
      const cards = document.querySelectorAll(".store-card");
      cards.forEach(card => {
        const branchCode = card.querySelector(".store-header strong").textContent.split("‚Äì")[0].trim();
        const store = allCompliance[branchCode];
        if (!store) return;
        const oldDate = store[key] ? parseDate(store[key]) : new Date();
        const newDate = new Date(oldDate);
        newDate.setMonth(newDate.getMonth() + months);
        const formatted = newDate.toLocaleDateString("en-GB");
        store[key] = formatted;

        updates.push({ storeCode: branchCode, updates: { [key]: formatted } });
        document.getElementById("reviewBtn").style.display = "block";
      });
    }

    function parseDate(d) {
      if (!d) return new Date();
      const parts = d.split("/");
      return new Date(parts[2], parts[1] - 1, parts[0]);
    }

    function buildChangesPayload() {
      return {
        meta: {
          operator: getOperatorName(),
          deviceId: localStorage.getItem("mostlaneDeviceID") || "unknown-device",
          timestamp: new Date().toISOString()
        },
        updates
      };
    }

    function openModal() {
      const payload = buildChangesPayload();
      document.getElementById("jsonPreview").textContent = JSON.stringify(payload, null, 2);
      document.getElementById("previewModal").style.display = "block";
    }

    function closeModal() {
      document.getElementById("previewModal").style.display = "none";
    }

    async function sendToZapier() {
      const { meta, updates } = buildChangesPayload();
      const s = document.getElementById("sendStatus");
      if (!updates.length) {
        s.textContent = 'No changes to send.';
        return;
      }

      try {
        const payload = JSON.stringify({ meta, updates });
        await fetch(ZAPIER_WEBHOOK, {
          method: 'POST',
          mode: 'no-cors', // bypass CORS
          headers: { 'Content-Type': 'application/json' },
          body: payload
        });
        s.textContent = '‚úÖ Sent to Zapier (check Zapier history to confirm)';
      } catch (err) {
        s.textContent = '‚ùå Failed to send: ' + err.message;
      }
    }

    fetchData();
  </script>
</body>
</html>
