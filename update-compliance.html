<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Retail Compliance Editor â€“ Mostlane Portal</title>
  <style>
    body{
      margin:0;font-family:Arial,Helvetica,sans-serif;color:#1f2937;
      background-color:#e6e8eb;position:relative;min-height:100vh;overflow-x:hidden;
    }
    body::before{
      content:"";position:fixed;inset:0;z-index:-1;
      background:url('Mostlane_Embossed.png') no-repeat center/180%;
    }
    .container{
      background:rgba(255,255,255,0.6);margin:24px auto;padding:20px;
      border-radius:15px;max-width:960px;box-shadow:0 4px 10px rgba(0,0,0,0.1);
    }
    .header{text-align:center;margin-bottom:10px;}
    .logo{max-height:60px;display:block;margin:0 auto 8px auto;}
    h1{margin:6px 0 0 0;color:#0071CE;font-size:24px;}
    .banner{
      background:#e0f7ec;border:1px solid #00a14b;
      color:#006636;font-weight:bold;padding:8px 12px;
      text-align:center;border-radius:8px;margin-bottom:10px;display:none;
    }
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;}
    .field{flex:1 1 220px;min-width:220px;}
    label{font-weight:bold;display:block;margin:6px 0 4px;}
    input[type="text"],input[type="date"]{
      width:100%;padding:8px;border:1px solid #cfd3d8;border-radius:8px;font-size:14px;background:#fff;
    }
    input[readonly]{background:#f3f4f6;}
    .btn{background:#0071CE;color:#fff;border:none;border-radius:8px;padding:10px 14px;font-weight:bold;cursor:pointer;}
    .btn:hover{background:#0062b5;}
    .btn.secondary{background:#e5e7eb;color:#111;}
    .btn.secondary:hover{background:#d7dbe1;}
    .btn.small{padding:6px 10px;font-size:12px;border-radius:6px;}
    .note{color:#6b7280;font-size:12px;}
    details.store{
      background:#ffffffcc;border:1px solid #e5e7eb;border-radius:10px;margin:12px 0;padding:10px 12px;
    }
    details.store[open]{box-shadow:0 2px 10px rgba(0,0,0,0.08);}
    summary{list-style:none;cursor:pointer;font-weight:bold;color:#111827;display:flex;justify-content:space-between;align-items:center;}
    summary::-webkit-details-marker{display:none;}
    .summary-meta{font-weight:normal;color:#374151;font-size:13px;}
    .grid{display:grid;gap:12px;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));margin-top:10px;}
    .line{background:#f9fafb;border:1px solid #e5e7eb;border-radius:10px;padding:10px;}
    .line h4{margin:0 0 8px;font-size:13px;color:#374151;display:flex;justify-content:space-between;align-items:center;}
    .shortcuts{display:flex;gap:6px;flex-wrap:wrap;}
    .status{text-align:center;font-weight:bold;color:#0071CE;margin-top:12px;}
    .modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.5);z-index:999;align-items:center;justify-content:center;padding:16px;}
    .modal .box{background:#fff;border-radius:12px;max-width:760px;width:100%;box-shadow:0 10px 30px rgba(0,0,0,0.25);padding:18px;max-height:85vh;overflow:auto;}
    .modal .head{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;}
    .modal pre{background:#0b1021;color:#d0f0ff;padding:12px;border-radius:8px;overflow:auto;font-size:12px;}
    .closeX{background:#e5e7eb;border:none;border-radius:50%;width:34px;height:34px;cursor:pointer;font-weight:bold;}
    .topbar{display:flex;gap:10px;align-items:end;margin:12px 0 18px;flex-wrap:wrap;}
    #reviewChangesBtn{display:none;margin-top:30px;text-align:center;}
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <img src="mostlane-logo.jpg" class="logo" alt="Mostlane Logo">
      <h1>Retail Compliance Editor</h1>
      <p class="note">Search stores, adjust due dates, then review and submit changes.</p>
    </div>

    <div id="dataBanner" class="banner">âœ… Data loaded successfully.</div>

    <div class="topbar">
      <div class="field" style="max-width:280px;">
        <label for="operatorName">Operator</label>
        <input id="operatorName" type="text" readonly>
      </div>
      <div class="field" style="max-width:420px; position:relative;">
        <label for="searchInput">Search Store</label>
        <input id="searchInput" type="text" placeholder="Enter store code, name or postcodeâ€¦">
        <button id="searchBtn" class="btn small" style="position:absolute;right:6px;bottom:7px;">Search</button>
      </div>
      <button class="btn secondary" id="btnClear">Clear All</button>
    </div>

    <div id="results"></div>
    <div id="reviewChangesBtn" class="status">
      <button class="btn" onclick="openPreview()">ðŸ‘€ Review Changes</button>
    </div>
    <div class="status" id="statusMsg"></div>
  </div>

  <!-- Preview Modal -->
  <div class="modal" id="previewModal">
    <div class="box">
      <div class="head">
        <h3 style="margin:0;color:#0071CE;">Preview JSON Changes</h3>
        <button class="closeX" onclick="closePreview()">âœ•</button>
      </div>
      <div id="previewMeta" class="note" style="margin-bottom:8px;"></div>
      <pre id="previewJSON">{ }</pre>
      <div style="display:flex;gap:10px;margin-top:12px;">
        <button class="btn" onclick="sendToZapier()">ðŸ“¤ Send to Zapier</button>
        <button class="btn secondary" onclick="closePreview()">Cancel</button>
      </div>
      <div class="status" id="sendStatus"></div>
    </div>
  </div>

  <script>
    const DATA_URL_COMP = 'https://raw.githubusercontent.com/Mostlane/Test/main/Compliance/retail_compliance.json';
    const DATA_URL_SITES = 'https://raw.githubusercontent.com/Mostlane/Test/main/Sites/retail.json';
    const ZAPIER_WEBHOOK = 'https://hooks.zapier.com/hooks/catch/20261714/urh99ln/';

    let allData = {}, originalSnapshot = {}, openStores = new Set(), changesMade = false;

    const toISO = d => { if(!d||!d.includes('/'))return''; const[p,q,r]=d.split('/');return`${r}-${q.padStart(2,'0')}-${p.padStart(2,'0')}`; };
    const fromISO = d => { if(!d)return''; const[p,q,r]=d.split('-');return`${r}/${q}/${p}`; };
    const addMonths=(dt,m)=>{let d=new Date(dt);d.setMonth(d.getMonth()+m);return d;};
    const addYears=(dt,y)=>addMonths(dt,y*12);

    function renderStoreCard(store){
      const code=store.branchCode;
      const current={five:store['5_Year']||'',pat:store['PAT']||'',em:store['EM']||'',pv:store['PV']||'',ev:store['EV']||'',pump:store['PUMP']||''};
      if(!originalSnapshot[code])originalSnapshot[code]={...current};
      const spURL=store.sharePointURL||'#';
      const el=document.createElement('details');
      el.className='store'; el.open=true; el.id=`store-${code}`;
      el.innerHTML=`
      <summary><span>${code} â€” ${store.storeName}</span><span class="summary-meta">${store.postcode||''}</span></summary>
      <div class="grid">
        ${buildLine('5 Year','five',code,current.five,'years',5)}
        ${buildLine('PAT','pat',code,current.pat,'months',12)}
        ${buildLine('EM','em',code,current.em,'months',12)}
        ${buildLine('PV','pv',code,current.pv,'months',12)}
        ${buildLine('EV','ev',code,current.ev,'months',12)}
        ${buildLine('Pump','pump',code,current.pump,'months',1)}
      </div>
      <div style="display:flex;gap:10px;margin-top:10px;flex-wrap:wrap;">
        <a class="btn secondary" href="${spURL}" target="_blank" rel="noopener">ðŸ“‚ Open SharePoint Folder</a>
        <button class="btn secondary" data-role="remove-store" data-code="${code}">Remove</button>
      </div>`;
      el.querySelectorAll('button[data-role="add"]').forEach(btn=>btn.addEventListener('click',()=>applyShortcut(btn)));
      el.querySelector('button[data-role="remove-store"]').addEventListener('click',()=>{openStores.delete(code);el.remove();});
      el.querySelectorAll('input[type="date"]').forEach(inp=>{
        inp.addEventListener('change',()=>{changesMade=true;document.getElementById('reviewChangesBtn').style.display='block';});
      });
      document.getElementById('results').appendChild(el);
    }

    function buildLine(label,key,code,val,type,amt){
      return `
      <div class="line">
        <h4><span>${label}</span><span class="shortcuts">
        <button class="btn small" data-role="add" data-target="${code}" data-field="${key}" data-type="${type}" data-amt="${amt}">+${amt}${type==='years'?'y':'m'}</button></span></h4>
        <label>Current</label><input type="text" value="${val}" readonly>
        <label>New</label><input type="date" id="${key}-${code}" value="${toISO(val)}">
      </div>`;
    }

    function applyShortcut(btn){
      const code=btn.dataset.target,field=btn.dataset.field,type=btn.dataset.type,amt=parseInt(btn.dataset.amt);
      const input=document.getElementById(`${field}-${code}`);
      let baseISO=input.value;
      if(!baseISO){
        const cur=originalSnapshot[code];baseISO=toISO(cur[field])||new Date().toISOString().slice(0,10);
      }
      let [y,m,d]=baseISO.split('-').map(Number);let dt=new Date(y,m-1,d);
      dt=(type==='years')?addYears(dt,amt):addMonths(dt,amt);
      input.value=dt.toISOString().slice(0,10);
      changesMade=true;document.getElementById('reviewChangesBtn').style.display='block';
    }

    function searchAndAdd(q){
      q=q.trim().toLowerCase();if(!q)return;
      const matches=Object.values(allData).filter(s=>
        (s.branchCode&&s.branchCode.toLowerCase().includes(q))||
        (s.storeName&&s.storeName.toLowerCase().includes(q))||
        (s.postcode&&s.postcode.toLowerCase().includes(q)));
      if(!matches.length){document.getElementById('statusMsg').textContent='No matching stores found.';return;}
      document.getElementById('statusMsg').textContent='';
      matches.forEach(s=>{if(openStores.has(s.branchCode))return;openStores.add(s.branchCode);renderStoreCard(s);});
    }

    function buildChangesPayload(){
      const updates=[];openStores.forEach(code=>{
        const orig=originalSnapshot[code]||{};const getNew=id=>document.getElementById(`${id}-${code}`)?.value||'';
        const changed={};
        const map=[['five','5_Year'],['pat','PAT'],['em','EM'],['pv','PV'],['ev','EV'],['pump','PUMP']];
        map.forEach(([k,kk])=>{const iso=getNew(k);if(iso&&fromISO(iso)!==(orig[k]||''))changed[kk]=fromISO(iso);});
        if(Object.keys(changed).length)updates.push({storeCode:code,updates:changed});
      });
      const meta={
        operator:(document.getElementById('operatorName').value||'').trim()||'Unknown',
        deviceId:(localStorage.getItem('ml_device_id')||(function(){const id='dev-'+Math.random().toString(36).slice(2);localStorage.setItem('ml_device_id',id);return id;})()),
        timestamp:new Date().toISOString()
      };
      return{meta,updates};
    }

    function openPreview(){
      const {meta,updates}=buildChangesPayload();
      const pre=document.getElementById('previewJSON');const metaBox=document.getElementById('previewMeta');
      const sendStatus=document.getElementById('sendStatus');sendStatus.textContent='';
      pre.textContent=updates.length?JSON.stringify({meta,updates},null,2):'// No changes detected.';
      metaBox.textContent=`Operator: ${meta.operator}  |  Device: ${meta.deviceId}  |  ${new Date(meta.timestamp).toLocaleString()}`;
      document.getElementById('previewModal').style.display='flex';
    }
    function closePreview(){document.getElementById('previewModal').style.display='none';}

    async function sendToZapier(){
      const {meta,updates}=buildChangesPayload();const s=document.getElementById('sendStatus');
      if(!updates.length){s.textContent='No changes to send.';return;}
      try{
        const res=await fetch(ZAPIER_WEBHOOK,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({meta,updates})});
        if(!res.ok)throw new Error(res.statusText);
        s.textContent='âœ… Sent successfully.';
      }catch(e){s.textContent='âŒ Failed to send: '+e.message;}
    }

    document.getElementById('searchBtn').addEventListener('click',()=>searchAndAdd(document.getElementById('searchInput').value));
    document.getElementById('searchInput').addEventListener('keyup',e=>{if(e.key==='Enter')searchAndAdd(e.target.value);});
    document.getElementById('btnClear').addEventListener('click',()=>{document.getElementById('results').innerHTML='';openStores.clear();document.getElementById('reviewChangesBtn').style.display='none';});

    // Load both JSONs and merge SharePoint URLs
    (async()=>{
      try{
        const [compRes, siteRes] = await Promise.all([fetch(DATA_URL_COMP), fetch(DATA_URL_SITES)]);
        const [compData, siteData] = await Promise.all([compRes.json(), siteRes.json()]);
        const siteURLs = {};
        Object.values(siteData).forEach(site=>{
          if(site.branchCode && site.sharePointURL){siteURLs[site.branchCode]=site.sharePointURL;}
        });
        Object.values(compData).forEach(site=>{
          const code=site.branchCode;
          if(siteURLs[code]) site.sharePointURL=siteURLs[code];
        });
        allData = compData;
        document.getElementById('dataBanner').style.display='block';
      }catch(e){
        console.error(e);
        document.getElementById('statusMsg').textContent='âŒ Failed to load site or compliance data.';
      }
    })();

    // Auto-fill operator name
    window.addEventListener('DOMContentLoaded',()=>{
      const user=sessionStorage.getItem('mostlaneUser')||'Unknown';
      document.getElementById('operatorName').value=user.replace('.', ' ');
    });
  </script>
</body>
</html>
