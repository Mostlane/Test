
<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Mostlane Weekly Summary</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { font-family: sans-serif; padding: 20px; background: #f7f9fc; }
    h2 { color: #004a99; }
    .summary { margin-top: 20px; padding: 15px; background: #fff; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    .nav { margin-top: 10px; }
    .nav button { margin: 0 5px; padding: 5px 10px; }
  </style>
</head>
<body>
  <h2>Weekly Summary</h2>
  <div class="nav">
    <button onclick="changeWeek(-7)">← Previous Week</button>
    <span id="weekRange"></span>
    <button onclick="changeWeek(7)">Next Week →</button>
  </div>
  <div id="summary" class="summary">Loading...</div>

  <script>
    const user = sessionStorage.getItem("mostlaneUser");
    if (!user) {
      document.getElementById("summary").innerHTML = "<p style='color:red;'>No user logged in.</p>";
    }

    let currentWeek = getStartOfWeek(new Date());

    function getStartOfWeek(date) {
      const day = date.getDay();
      const diff = date.getDate() - day + (day === 0 ? -6 : 1);
      return new Date(date.setDate(diff));
    }

    function formatDate(date) {
      return date.toISOString().split("T")[0];
    }

    function changeWeek(days) {
      currentWeek.setDate(currentWeek.getDate() + days);
      loadWeek();
    }

    function loadWeek() {
      if (!user) return;
      const start = new Date(currentWeek);
      const end = new Date(currentWeek);
      end.setDate(end.getDate() + 6);
      document.getElementById("weekRange").innerText = formatDate(start) + " to " + formatDate(end);

      fetch("https://raw.githubusercontent.com/Mostlane/Test/refs/heads/main/activity-log.txt")
        .then(r => r.text())
        .then(t => {
          const log = JSON.parse(t)[user] || [];
          const weekLogs = log.filter(e => {
            const d = new Date(e.datetime);
            return d >= start && d <= end;
          });

          summarizeWeek(weekLogs);
        })
        .catch(() => {
          document.getElementById("summary").innerText = "Unable to load log.";
        });
    }

    async function summarizeWeek(logs) {
      const rateMap = await fetch("https://raw.githubusercontent.com/Mostlane/Test/main/rates.txt").then(r => r.text());
      const rateLine = rateMap.split("\n").find(line => line.includes(user));
      const rate = rateLine ? parseFloat(rateLine.split("£")[1]) : 0;

      let standardMins = 0;
      let overtimeMins = 0;
      const dayMap = {};

      logs.forEach(entry => {
        const date = new Date(entry.datetime).toDateString();
        if (!dayMap[date]) dayMap[date] = [];
        dayMap[date].push(entry);
      });

      Object.values(dayMap).forEach(entries => {
        const times = entries.map(e => new Date(e.datetime)).sort((a, b) => a - b);
        const mins = (times[times.length - 1] - times[0]) / 60000;
        if (mins > 600) {
          standardMins += 600;
          overtimeMins += mins - 600;
        } else {
          standardMins += mins;
        }
      });

      // Mileage calc
      const base = new google.maps.LatLng(50.8529, -1.2445);
      const coords = logs.filter(e => e.location_coords).map(e => e.location_coords);
      let paidMiles = 0;
      for (const c of coords) {
        const dest = new google.maps.LatLng(c.lat, c.lon);
        const miles = await new Promise(resolve => {
          const service = new google.maps.DistanceMatrixService();
          service.getDistanceMatrix({
            origins: [base],
            destinations: [dest],
            travelMode: 'DRIVING'
          }, (res, status) => {
            if (status === 'OK') {
              const el = res.rows[0].elements[0];
              if (el.status === 'OK') {
                const rawMiles = el.distance.value / 1609.34;
                resolve(Math.max(0, rawMiles - 10));
              } else resolve(0);
            } else resolve(0);
          });
        });
        paidMiles += miles;
      }

      const stdH = (standardMins / 60).toFixed(2);
      const otH = (overtimeMins / 60).toFixed(2);
      const stdPay = (standardMins / 60 * rate).toFixed(2);
      const otPay = (overtimeMins / 60 * rate * 1.5).toFixed(2);
      const mileagePay = (paidMiles * 0.25).toFixed(2);

      const total = (+stdPay + +otPay + +mileagePay).toFixed(2);
      document.getElementById("summary").innerHTML = `
        <strong>Standard Hours:</strong> ${stdH} hrs (£${stdPay})<br>
        <strong>Overtime:</strong> ${otH} hrs (£${otPay})<br>
        <strong>Paid Mileage:</strong> ${paidMiles.toFixed(1)} mi (£${mileagePay})<br>
        <strong>Total Earnings:</strong> <strong>£${total}</strong>
      `;
    }

    loadWeek();
  </script>
  <script async defer
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAGqOm3qfyYqOx7WXhMzyNZ7kcKNlcWgQM&libraries=places">
  </script>
</body>
</html>
