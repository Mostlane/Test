<!DOCTYPE html>
<html lang="en">
<head>
<script src="auth.js"></script>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Generate Purchase Order Reference</title>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background: #e6e8eb url('Mostlane_Embossed.png') no-repeat center center fixed;
      background-size: cover;
      margin: 0;
      padding: 40px 20px;
      color: #333;
    }
    .main-body {
      max-width: 520px;
      margin: auto;
      background: rgba(255,255,255,0.9);
      padding: 24px 24px 30px;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    h1 {
      text-align: center;
      color: #003366;
      margin: 0 0 16px 0;
    }
    label {
      display: block;
      margin-top: 16px;
      font-weight: bold;
      color: #003366;
    }
    input, select, button, textarea {
      width: 100%;
      padding: 10px;
      font-size: 16px;
      margin-top: 6px;
      border-radius: 6px;
      border: 1px solid #ccc;
      box-sizing: border-box;
    }
    textarea { min-height: 80px; resize: vertical; }
    .row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }
    .button {
      margin-top: 22px;
      padding: 12px;
      width: 100%;
      background-color: rgba(0, 74, 153, 0.8);
      color: white;
      font-size: 18px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
    }
    .subtle {
      margin-top: 8px;
      font-size: 13px;
      color: #666;
    }
    .hidden { display: none; }
  </style>
</head>
<body>
  <div class="main-body">
    <h1>Generate Purchase Order Reference</h1>

    <form id="poForm">
      <label for="engineer">Engineer</label>
      <input type="text" id="engineer" readonly />

      <div class="row">
        <div>
          <label for="date">Date</label>
          <input type="text" id="date" readonly />
        </div>
        <div>
          <label for="workType">Work Type</label>
          <select id="workType" required>
            <option value="Reactive">Reactive</option>
            <option value="Planned">Planned</option>
            <option value="Vehicle Maintenance">Vehicle Maintenance</option>
          </select>
        </div>
      </div>

      <div id="incidentRow">
        <label for="incident">Incident Number</label>
        <input type="text" id="incident" placeholder="Enter incident number">
      </div>

      <div id="siteTypeRow" class="hidden">
        <label for="siteType">Site Type</label>
        <select id="siteType">
          <option value="">Select a Site Type…</option>
          <option value="Retail">Retail</option>
          <option value="ELS">ELS</option>
          <option value="COBRA">COBRA</option>
          <option value="Wenzel’s">Wenzel’s</option>
          <option value="FBC">FBC</option>
        </select>
      </div>

      <div id="siteRow">
        <label for="site">Site</label>
        <select id="site"></select>
      </div>

      <div id="vehicleRow" class="hidden">
        <label for="vehicleReg">Vehicle Registration</label>
        <select id="vehicleReg"></select>
      </div>

      <label for="supplier">Supplier</label>
      <select id="supplier" required></select>

      <label for="desc">Short Description</label>
      <textarea id="desc" placeholder="What is this PO for?" required></textarea>

      <button type="submit" class="button" id="submitBtn">Submit</button>
      <div class="subtle" id="geoStatus">Attempting to get your location…</div>
    </form>
  </div>

  <script>
    const RAW = 'https://raw.githubusercontent.com/Mostlane/Test/main/';
    const SITES_URL = RAW + 'sites.json';
    const SUPPLIERS_URL = RAW + 'suppliers.json';
    const VEHICLES_URL = RAW + 'vehicles.json';
    const WEBHOOK_URL = 'https://hooks.zapier.com/hooks/catch/20261714/u1093v6/';

    const byId = id => document.getElementById(id);
    const cacheBust = url => url + '?v=' + Date.now();
    const fetchJSON = url => fetch(cacheBust(url)).then(r => r.json());
    function dotToSpace(s){ return (s||'').replace(/\./g,' '); }
    function formatDateUK(d=new Date()){
      const dd = String(d.getDate()).padStart(2,'0');
      const mm = String(d.getMonth()+1).padStart(2,'0');
      const yy = d.getFullYear();
      return `${dd}/${mm}/${yy}`;
    }

    let allSites = [];
    function norm(v){ return (v||'').toString().toLowerCase().replace(/\u2019/g,"'").trim(); }

    let geo = { lat: null, lon: null };

    async function init(){
      const username = sessionStorage.getItem('mostlaneUser') || '';
      byId('engineer').value = username ? dotToSpace(username) : 'Unknown';
      byId('date').value = formatDateUK();

      byId('workType').addEventListener('change', e => {
        const val = e.target.value;
        const isReactive = val === 'Reactive';
        const isPlanned = val === 'Planned'; // <---- NEW
        const isVehicle = val === 'Vehicle Maintenance';
        byId('incidentRow').style.display = isReactive ? '' : 'none';
        byId('siteRow').style.display = isVehicle ? 'none' : '';
        byId('vehicleRow').classList.toggle('hidden', !isVehicle);

        // updated condition for site type visibility
        const siteTypeRow = byId('siteTypeRow');
        if (isReactive || isPlanned) { // <---- UPDATED: both Reactive and Planned
          siteTypeRow.classList.remove('hidden');
          populateSites(byId('siteType').value);
        } else {
          siteTypeRow.classList.add('hidden');
          byId('siteType').value = '';
          populateSites();
        }
      });
      byId('workType').dispatchEvent(new Event('change'));

      byId('siteType').addEventListener('change', function(){
        if (byId('workType').value === 'Reactive' || byId('workType').value === 'Planned') { // <---- UPDATED
          populateSites(this.value);
        } else {
          populateSites();
        }
      });

      try {
        const suppliers = await fetchJSON(SUPPLIERS_URL);
        const sel = byId('supplier');
        sel.innerHTML = '';
        suppliers.forEach(s => {
          const opt = document.createElement('option');
          opt.value = s.supplierName;
          opt.textContent = s.supplierName;
          sel.appendChild(opt);
        });
      } catch {
        byId('supplier').innerHTML = '<option value="">(Unable to load suppliers)</option>';
      }

      try {
        const sites = await fetchJSON(SITES_URL);
        allSites = Array.isArray(sites) ? sites : [];
        populateSites();
      } catch {
        byId('site').innerHTML = '<option value="">(Unable to load sites)</option>';
      }

      try {
        const vehicles = await fetchJSON(VEHICLES_URL);
        const sel = byId('vehicleReg');
        sel.innerHTML = '';
        vehicles.forEach(v => {
          const opt = document.createElement('option');
          const reg = v.reg || v.registration || '';
          opt.value = reg;
          opt.textContent = reg;
          sel.appendChild(opt);
        });
      } catch {}

      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
          pos => {
            geo.lat = pos.coords.latitude;
            geo.lon = pos.coords.longitude;
            byId('geoStatus').textContent = `Location captured: ${geo.lat.toFixed(5)}, ${geo.lon.toFixed(5)}`;
          },
          err => {
            byId('geoStatus').textContent = 'Location permission denied. You must allow location to submit a PO.';
          },
          { enableHighAccuracy: true, timeout: 10000, maximumAge: 60000 }
        );
      } else {
        byId('geoStatus').textContent = 'Geolocation not supported on this device.';
      }

      byId('poForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const workType = byId('workType').value;
        const isReactive = workType === 'Reactive';
        const isVehicle = workType === 'Vehicle Maintenance';
        const engineerVal = byId('engineer').value.trim();
        const dateVal = byId('date').value.trim();
        const incidentVal = byId('incident').value.trim();
        const siteVal = byId('site').value;
        const vehicleVal = byId('vehicleReg').value;
        const supplierVal = byId('supplier').value;
        const descVal = byId('desc').value.trim();

        if (!engineerVal) return alert('Engineer is required.');
        if (!dateVal) return alert('Date is required.');
        if (!descVal) return alert('Short Description is required.');
        if (isReactive && !incidentVal) return alert('Incident Number is required for Reactive work.');
        if (!isVehicle && !siteVal) return alert('Please select a site.');
        if (isVehicle && !vehicleVal) return alert('Please select a vehicle registration.');
        if (!supplierVal) return alert('Please select a supplier.');
        if (geo.lat === null || geo.lon === null) return alert('Location is required. Please allow location access and try again.');

        const payload = new URLSearchParams();
        payload.append('engineer', engineerVal);
        payload.append('date', dateVal);
        payload.append('workType', workType);
        if (isReactive) payload.append('incident', incidentVal);
        if (!isVehicle) payload.append('site', siteVal);
        if (isVehicle) payload.append('vehicleReg', vehicleVal);
        payload.append('supplier', supplierVal);
        payload.append('description', descVal);
        payload.append('latitude', String(geo.lat));
        payload.append('longitude', String(geo.lon));

        try {
          await fetch(WEBHOOK_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: payload.toString()
          });
          window.location.href = 'po-added.html';
        } catch (err) {
          alert('Failed to submit. Please check your connection and try again.');
        }
      });
    }

    function populateSites(filterType){
      const sel = byId('site');
      sel.innerHTML = '';
      let list = allSites;
      const f = (filterType||'').trim();
      if (f) list = allSites.filter(s => norm(s.siteType) === norm(f));
      list.forEach(s => {
        const label = [s.jobNumber, s.siteName].filter(Boolean).join(' - ');
        const opt = document.createElement('option');
        opt.value = label || s.siteName || '';
        opt.textContent = label || s.siteName || '';
        sel.appendChild(opt);
      });
      if (!list.length) {
        const opt = document.createElement('option');
        opt.value = '';
        opt.textContent = '(No sites match this type)';
        sel.appendChild(opt);
      }
    }

    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
