<!DOCTYPE html>
<html lang="en">
<head>
  <script src="auth.js"></script>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Generate Purchase Order Reference</title>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background: #e6e8eb url('Mostlane_Embossed.png') no-repeat center center fixed;
      background-size: cover;
      margin: 0;
      padding: 40px 20px;
      color: #333;
    }
    .main-body {
      max-width: 520px;
      margin: auto;
      background: rgba(255,255,255,0.9);
      padding: 24px 24px 30px;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    h1 {
      text-align: center;
      color: #003366;
      margin: 0 0 16px 0;
    }
    label {
      display: block;
      margin-top: 16px;
      font-weight: bold;
      color: #003366;
    }
    input, select, button, textarea {
      width: 100%;
      padding: 10px;
      font-size: 16px;
      margin-top: 6px;
      border-radius: 6px;
      border: 1px solid #ccc;
      box-sizing: border-box;
    }
    textarea { min-height: 80px; resize: vertical; }
    .row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }
    .button {
      margin-top: 22px;
      padding: 12px;
      width: 100%;
      background-color: rgba(0, 74, 153, 0.9);
      color: white;
      font-size: 18px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
    }
    .button[disabled] { opacity: 0.6; cursor: not-allowed; }
    .subtle { margin-top: 8px; font-size: 13px; color: #666; }
    .hidden { display: none; }

    .modal-backdrop {
      position: fixed; inset: 0;
      background: rgba(0,0,0,0.45);
      display: none;
      align-items: center; justify-content: center;
      z-index: 9999;
    }
    .modal {
      background: #fff;
      border-radius: 12px;
      padding: 20px;
      max-width: 420px;
      width: calc(100% - 40px);
      box-shadow: 0 10px 30px rgba(0,0,0,0.25);
      text-align: center;
    }
    .modal h2 { color: #003366; margin: 0 0 8px 0; }
    .modal .po-code { font-weight: 700; font-size: 20px; color: #003366; margin: 8px 0 16px; word-break: break-all; }
    .modal .actions {
      display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 12px;
    }
    .modal button, .modal a {
      padding: 10px; border-radius: 8px; border: none;
      background: rgba(0,74,153,0.9); color: #fff; text-decoration: none; font-size: 16px;
    }
    .modal .close-btn { background: #888; }
  </style>
</head>
<body>
  <div class="main-body">
    <h1>Generate Purchase Order Reference</h1>

    <form id="poForm">
      <label for="engineer">Engineer</label>
      <input type="text" id="engineer" readonly />

      <div class="row">
        <div>
          <label for="date">Date</label>
          <input type="text" id="date" readonly />
        </div>
        <div>
          <label for="workType">Work Type</label>
          <select id="workType" required>
            <option value="Reactive">Reactive</option>
            <option value="Planned">Planned</option>
            <option value="Vehicle Maintenance">Vehicle Maintenance</option>
          </select>
        </div>
      </div>

      <div id="incidentRow">
        <label for="incident">Incident Number</label>
        <input type="text" id="incident" placeholder="Enter incident number">
      </div>

      <div id="siteTypeRow">
        <label for="siteType">Site Type</label>
        <select id="siteType">
          <option value="">All Sites</option>
          <option value="Retail">Retail</option>
          <option value="ELS">ELS</option>
          <option value="COBRA">COBRA</option>
          <option value="Wenzel‚Äôs">Wenzel‚Äôs</option>
          <!-- FBC REMOVED -->
          <option value="Site">Site</option>
        </select>
      </div>

      <div id="siteRow">
        <label for="site">Site</label>
        <select id="site"></select>
        <div class="subtle">(Shown: Site Name ‚Äî uses Site Number internally)</div>
      </div>

      <div id="vehicleRow" class="hidden">
        <label for="vehicleReg">Vehicle Registration</label>
        <select id="vehicleReg"></select>
      </div>

      <label for="supplier">Supplier</label>
      <select id="supplier" required></select>
      <div class="subtle">(Shown: Supplier Name ‚Äî uses Supplier Number internally)</div>

      <label for="desc">Short Description</label>
      <textarea id="desc" placeholder="What is this PO for?" required></textarea>

      <button type="submit" class="button" id="submitBtn">Create PO</button>
      <button type="button" id="personalBtn" class="button" style="background-color:#005bb5;margin-top:10px;">Personal Purchase (Tools etc.)</button>

      <div class="subtle" id="geoStatus">Attempting to get your location‚Ä¶</div>
    </form>
  </div>

  <div class="modal-backdrop" id="modalBackdrop">
    <div class="modal">
      <h2>‚úÖ Purchase Order Created</h2>
      <div class="po-code" id="poCodeText"></div>
      <div class="actions">
        <button id="copyBtn" type="button">Copy</button>
        <a id="viewAllBtn" href="view-pos.html">View All POs</a>
        <button id="closeBtn" class="close-btn" type="button">Close</button>
        <button id="newBtn" type="button">New PO</button>
      </div>
    </div>
  </div>

<script>
  const RAW = 'https://raw.githubusercontent.com/Mostlane/Test/main/';
  const USERS_URL = RAW + 'users.json';
  const SUPPLIERS_URL = RAW + 'suppliers.json';
  const VEHICLES_URL = RAW + 'vehicles.json';

  // ‚úÖ LIVE Mostlane Cloudflare Worker endpoint (POs)
  const CLOUDFLARE_ENDPOINT = 'https://mostlane-pos.jamie-def.workers.dev/add-po';
  const API_KEY = ''; // optional security key if you enable it in the Worker

  // ‚úÖ Cloudflare Worker Site endpoints (for the site dropdown)
  const SITE_API_BASE = 'https://mostlane-pos.jamie-def.workers.dev/get-sites?type=';
  const SITE_ENDPOINTS = {
    retail: SITE_API_BASE + 'retail',
    els: SITE_API_BASE + 'els',
    els_private: SITE_API_BASE + 'els_private',
    cobra: SITE_API_BASE + 'cobra',
    wenzels: SITE_API_BASE + 'wenzels',
    projects: SITE_API_BASE + 'projects'
  };

  // Maps UI values to endpoint keys
  function mapSiteTypeToKey(uiValue) {
    const v = (uiValue || '').toLowerCase().trim();
    if (!v) return ''; // All Sites
    if (v === 'retail') return 'retail';
    if (v === 'els') return 'els';
    if (v === 'cobra') return 'cobra';
    // handle curly apostrophe in ‚ÄúWenzel‚Äôs‚Äù
    if (v.startsWith('wenzel')) return 'wenzels';
    if (v === 'site') return 'projects'; // your "Site" = projects
    // fallback
    return v.replace(/[^a-z0-9]+/g, '_');
  }

  const byId = id => document.getElementById(id);
  const fetchJSON = url => fetch(url + (url.includes('?') ? '&' : '?') + 'v=' + Date.now()).then(r => r.json());
  const dotToSpace = s => (s || '').replace(/\./g, ' ');
  const formatDateUK = (d = new Date()) => `${String(d.getDate()).padStart(2,'0')}/${String(d.getMonth()+1).padStart(2,'0')}/${d.getFullYear()}`;
  const norm = v => (v||'').toString().toLowerCase().trim();

  let engineerCode='', engineerName='', geo={lat:null,lon:null}, allSuppliers=[];
  let lastSites = []; // cache last-loaded list for current filter

  function nextPO(engineerCode, supplierNo, siteSegment, typeLetter){
    const key = `poSeq:${engineerCode}|${supplierNo}|${siteSegment}|${typeLetter}`;
    let n = parseInt(localStorage.getItem(key) || "0",10)+1;
    localStorage.setItem(key,n);
    return `${engineerCode}-${supplierNo}-${siteSegment}-${typeLetter}${n}`;
  }

  async function populateSuppliers(){
    try {
      allSuppliers = await fetchJSON(SUPPLIERS_URL);
      const sel = byId('supplier');
      sel.innerHTML='';
      (allSuppliers || []).forEach(s=>{
        const opt=document.createElement('option');
        opt.value = s.supplierNumber;
        opt.textContent = s.supplierName;
        sel.appendChild(opt);
      });
    } catch { byId('supplier').innerHTML='<option>(Unable to load)</option>'; }
  }

  // Robust getters for site fields from Cloudflare data
  function pick(obj, keys) {
    for (const k of keys) {
      if (obj && obj[k] != null && String(obj[k]).trim() !== '') return obj[k];
    }
    return '';
  }
  function getSiteCode(site) {
    // Expecting siteCode in SITES store; also accept other common keys
    const code = pick(site, ['siteCode','Store Code','StoreCode','Branch Code','branchCode','code','ID','site_number','siteNumber','jobNumber']);
    return String(code || '').padStart(4,'0');
  }
  function getSiteName(site) {
    return pick(site, ['siteName','Store Name','Name','name','site']);
  }

  // Fetch sites for a single key (retail, els, etc.)
  async function fetchSitesForKey(key) {
    const url = SITE_ENDPOINTS[key];
    if (!url) return [];
    try {
      const data = await fetchJSON(url);
      if (!data) return [];
      // data should already be an array from Worker; keep it robust either way
      const arr = Array.isArray(data) ? data : (data?.data && Array.isArray(data.data) ? data.data : Object.values(data||{}));
      return (arr || []).map(s => ({
        code: getSiteCode(s),
        name: getSiteName(s),
        raw: s
      })).filter(x => x.code || x.name);
    } catch (e) {
      console.warn('Sites fetch failed for', key, e);
      return [];
    }
  }

  // Populate the second dropdown depending on selected type
  async function populateSitesFromCloudflare() {
    const siteTypeUI = byId('siteType').value;      // e.g., "", "Retail", "ELS", "COBRA", "Wenzel‚Äôs", "Site"
    const key = mapSiteTypeToKey(siteTypeUI);       // "", or "retail", "els", "cobra", "wenzels", "projects"

    const siteSel = byId('site');
    siteSel.innerHTML = '';

    let list = [];

    if (!key) {
      // All Sites ‚Üí fetch all keys and merge
      const keys = ['retail','els','els_private','cobra','wenzels','projects'];
      const chunks = await Promise.all(keys.map(k => fetchSitesForKey(k)));
      list = chunks.flat();
    } else {
      list = await fetchSitesForKey(key);
    }

    lastSites = list.slice(); // cache

    if (!list.length) {
      const opt = document.createElement('option');
      opt.value = '';
      opt.textContent = '(No options)';
      siteSel.appendChild(opt);
      return;
    }

    // Sort by code (numeric)
    list.sort((a,b) => a.code.localeCompare(b.code, undefined, { numeric: true }));

    list.forEach(s => {
      const opt = document.createElement('option');
      // show like "0126 Lee On Solent"
      const label = [s.code, s.name].filter(Boolean).join(' ');
      opt.textContent = label;
      // Use site code as value (your note says ‚Äúuses Site Number internally‚Äù)
      opt.value = s.code || s.name || '';
      opt.dataset.siteName = s.name || '';
      siteSel.appendChild(opt);
    });
  }

  async function populateVehicles(){
    try {
      const vehicles = await fetchJSON(VEHICLES_URL);
      const sel=byId('vehicleReg'); sel.innerHTML='';
      (vehicles||[]).forEach(v=>{
        const opt=document.createElement('option');
        const reg=(v.reg||v.registration||'').toString().replace(/\s+/g,'');
        opt.value=reg; opt.textContent=v.reg||v.registration||reg;
        sel.appendChild(opt);
      });
    } catch{}
  }

  function showModal(po){ byId('poCodeText').textContent=po; byId('modalBackdrop').style.display='flex'; }
  function hideModal(){ byId('modalBackdrop').style.display='none'; }

  async function init(){
    const username=sessionStorage.getItem('mostlaneUser')||'';
    engineerName=username?dotToSpace(username):'Unknown';
    byId('engineer').value=engineerName;
    byId('date').value=formatDateUK();

    try{
      const users=await fetchJSON(USERS_URL);
      const rec=(users||[]).find(u=>u.Username===username||u.username===username);
      const engNum=rec?.EngineerNumber||rec?.engineerNumber||'';
      const empType=(rec?.EmploymentType||rec?.employmentType||'Employed').toLowerCase();
      const prefix=empType.includes('self')?'SE':'E';
      engineerCode=prefix+String(engNum||'').trim();
    }catch{engineerCode='E0';}

    // Sites now come from Cloudflare Worker
    await populateSitesFromCloudflare();

    await populateSuppliers();
    await populateVehicles();

    if(navigator.geolocation){
      navigator.geolocation.getCurrentPosition(
        pos=>{
          geo.lat=pos.coords.latitude; geo.lon=pos.coords.longitude;
          byId('geoStatus').textContent=`üìç Location captured: ${geo.lat.toFixed(5)}, ${geo.lon.toFixed(5)}`;
        },
        ()=>{byId('geoStatus').textContent='‚ö†Ô∏è Location permission denied. Allow access.';},
        {enableHighAccuracy:true,timeout:10000}
      );
    } else byId('geoStatus').textContent='‚ùå Geolocation not supported.';

    byId('workType').addEventListener('change', e=>{
      const val=e.target.value;
      const isReactive=val==='Reactive';
      const isVehicle=val==='Vehicle Maintenance';
      byId('incidentRow').style.display=isReactive?'':'none';
      byId('siteTypeRow').style.display=isVehicle?'none':'';
      byId('siteRow').style.display=isVehicle?'none':'';
      byId('vehicleRow').classList.toggle('hidden',!isVehicle);
    });

    byId('siteType').addEventListener('change', populateSitesFromCloudflare);

    byId('copyBtn').onclick=()=>navigator.clipboard.writeText(byId('poCodeText').textContent);
    byId('closeBtn').onclick=hideModal;
    byId('newBtn').onclick=()=>{hideModal();byId('poForm').reset();byId('engineer').value=engineerName;byId('date').value=formatDateUK();};

    byId('personalBtn').onclick=()=>{
      const eng=encodeURIComponent(byId('engineer').value||'');
      const date=encodeURIComponent(byId('date').value||'');
      window.open(`https://form.jotform.com/250527962516057?engineer=${eng}&date=${date}`,'_blank');
    };

    byId('poForm').addEventListener('submit',onSubmit);
  }

  async function onSubmit(e){
    e.preventDefault();
    const submitBtn=byId('submitBtn'); submitBtn.disabled=true;
    const workType=byId('workType').value;
    const isVehicle=workType==='Vehicle Maintenance';
    const engineerVal=byId('engineer').value.trim();
    const dateVal=byId('date').value.trim();
    const siteNumber=byId('site').value;
    const vehicleReg=byId('vehicleReg').value;
    const supplierNumber=byId('supplier').value;
    const supplierName=byId('supplier').selectedOptions[0]?.textContent||'';
    const descVal=byId('desc').value.trim();
    const incidentVal=byId('incident').value.trim();

    if(!engineerVal||!dateVal||!descVal||!supplierNumber){alert('All required fields must be completed.');submitBtn.disabled=false;return;}
    if(geo.lat===null||geo.lon===null){alert('Location required. Enable location.');submitBtn.disabled=false;return;}

    const typeLetter=workType==='Reactive'?'R':workType==='Planned'?'P':'V';
    const siteSegment=isVehicle?(vehicleReg||'').replace(/\s+/g,''):siteNumber;
    const poCode=nextPO(engineerCode,supplierNumber,siteSegment,typeLetter);
    showModal(poCode);

    const data = {
      poNumber: poCode,
      engineer: engineerVal,
      engineerCode,
      date: dateVal,
      workType,
      supplierName,
      supplierNumber,
      description: descVal,
      latitude: geo.lat,
      longitude: geo.lon,
      incidentNumber: incidentVal,
      notes: descVal,
      createdAt: new Date().toISOString()
    };

    try {
      const res = await fetch(CLOUDFLARE_ENDPOINT, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          ...(API_KEY ? { 'x-api-key': API_KEY } : {})
        },
        body: JSON.stringify(data),
        cache: 'no-store'
      });
      const result = await res.json();
      if(res.ok) alert(`‚úÖ Purchase Order ${poCode} submitted successfully.`);
      else alert(`‚ö†Ô∏è Failed: ${result?.error || 'Unknown error'}`);
    } catch (err) {
      alert('‚ö†Ô∏è Failed to reach server: ' + err.message);
    } finally {
      submitBtn.disabled = false;
    }
  }

  document.addEventListener('DOMContentLoaded',init);
</script>
</body>
</html>
