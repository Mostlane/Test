<!DOCTYPE html>
<html lang="en">
<head>
  <script src="auth.js"></script>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Generate Purchase Order Reference</title>

  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background: #e6e8eb url('Mostlane_Embossed.png') no-repeat center center fixed;
      background-size: cover;
      margin: 0;
      padding: 40px 20px;
      color: #333;
    }
    .main-body {
      max-width: 520px;
      margin: auto;
      background: rgba(255,255,255,0.9);
      padding: 24px;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    h1 {
      text-align: center;
      color: #003366;
      margin: 0 0 16px 0;
    }
    label {
      display: block;
      margin-top: 16px;
      font-weight: bold;
      color: #003366;
    }
    input, select, textarea, button {
      width: 100%;
      padding: 10px;
      margin-top: 6px;
      font-size: 16px;
      border-radius: 6px;
      border: 1px solid #ccc;
      box-sizing: border-box;
    }
    textarea { min-height: 80px; resize: vertical; }
    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }

    .button {
      margin-top: 22px;
      background-color: rgba(0,74,153,0.9);
      color: #fff;
      border: none;
      padding: 12px;
      border-radius: 8px;
      font-size: 18px;
      cursor: pointer;
    }
    .button[disabled] { opacity: .6; cursor: not-allowed; }

    .readonly-field {
      background: #f3f4f6 !important;
      cursor: default;
    }

    .modal-backdrop {
      position: fixed; inset: 0;
      display: none;
      background: rgba(0,0,0,0.45);
      align-items: center; justify-content: center;
      z-index: 9999;
    }
    .modal {
      background: #fff;
      padding: 20px;
      border-radius: 12px;
      max-width: 420px;
      width: calc(100% - 40px);
      text-align: center;
      box-shadow: 0 10px 30px rgba(0,0,0,0.25);
    }
    .modal .po-code {
      font-size: 20px;
      font-weight: bold;
      color: #003366;
      word-break: break-all;
      margin: 12px 0 20px;
    }
    .modal .actions {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }
  </style>
</head>

<body>
  <div class="main-body">
    <h1>Generate Purchase Order Reference</h1>

    <form id="poForm">

      <label for="engineer">Engineer</label>
      <input type="text" id="engineer" readonly />

      <div class="row">
        <div>
          <label for="date">Date</label>
          <input type="text" id="date" readonly />
        </div>
        <div>
          <label for="workType">Work Type</label>
          <select id="workType">
            <option value="Reactive">Reactive</option>
            <option value="Planned">Planned</option>
            <option value="Vehicle Maintenance">Vehicle Maintenance</option>
          </select>
        </div>
      </div>

      <div id="incidentRow">
        <label for="incident">Incident Number</label>
        <input id="incident" type="text" placeholder="Enter incident number">
      </div>

      <div id="siteTypeRow">
        <label for="siteType">Site Type</label>
        <select id="siteType">
          <option value="">All Sites</option>
          <option value="Retail">Retail</option>
          <option value="ELS">ELS</option>
          <option value="ELS Private">ELS Private</option>
          <option value="Cobra">Cobra</option>
          <option value="Wenzel’s">Wenzel’s</option>
          <option value="Projects">Projects</option>
        </select>

        <input id="siteTypeReadonly" class="readonly-field" readonly style="display:none;margin-top:6px;">
      </div>

      <div id="siteRow">
        <label for="site">Site</label>
        <select id="site"></select>

        <input id="siteReadonly" class="readonly-field" readonly style="display:none;margin-top:6px;">
      </div>

      <div id="vehicleRow" class="hidden">
        <label for="vehicleReg">Vehicle Registration</label>
        <select id="vehicleReg"></select>
      </div>

      <label for="supplier">Supplier</label>
      <select id="supplier"></select>

      <label for="desc">Short Description</label>
      <textarea id="desc" required></textarea>

      <button id="submitBtn" class="button" type="submit">Create PO</button>
      <button id="personalBtn" class="button" type="button" style="margin-top:10px;background:#005bb5;">Personal Purchase</button>

      <div id="geoStatus" style="margin-top:10px;font-size:13px;color:#666;">Attempting to get your location…</div>

    </form>
  </div>

  <!-- MODAL -->
  <div id="modalBackdrop" class="modal-backdrop">
    <div class="modal">
      <h2>Purchase Order Created</h2>
      <div id="poCodeText" class="po-code"></div>
      <div class="actions">
        <button id="copyBtn">Copy</button>
        <a id="viewAllBtn" href="view-pos.html">View All</a>
        <button id="closeBtn">Close</button>
        <button id="newBtn">New</button>
      </div>
    </div>
  </div>

<script>

/* ===========================
    CONSTANTS
=========================== */

const RAW = 'https://raw.githubusercontent.com/Mostlane/Test/main/';
const USERS_URL = RAW + 'users.json';
const VEHICLES_URL = RAW + 'vehicles.json';

const SUPPLIERS_URL = "https://mostlane-po.jamie-def.workers.dev/suppliers";

const ALL_SITES_URL = "https://mostlane-sites.jamie-def.workers.dev";

const CLOUDFLARE_ENDPOINT = "https://mostlane-po.jamie-def.workers.dev/po/create";

const byId = id => document.getElementById(id);
const fetchJSON = url => fetch(url + (url.includes('?')?'&':'?') + 'v=' + Date.now()).then(r => r.json());
const norm = s => (s||'').toString().toLowerCase().trim();
const dotToSpace = s => (s||'').replace(/\./g,' ');

let engineerCode = '';
let engineerName = '';
let geo = {lat:null, lon:null};
let allSuppliers = [];
let jobLinked = {
  active:false, jobId:null, incident:null,
  siteParam:null, siteNumber:null, siteName:null, siteType:null
};

/* ===========================
   SITE MATCHING
=========================== */
function normaliseText(s){
  return (s||'').toString().toLowerCase().replace(/\s+/g,' ').trim();
}

function findBestMatchingSite(param, sites){
  if(!param) return null;
  const raw = param.toString();
  const n = normaliseText(raw);

  // detect 4-digit store number
  const m = raw.match(/\b(\d{4})\b/);
  if(m){
    const num = m[1];
    const exact = sites.find(s => (s.siteNumber||'').toString() === num);
    if(exact) return exact;
  }

  // exact name
  let match = sites.find(s => normaliseText(s.siteName) === n);
  if(match) return match;

  // contains
  match = sites.find(s => n.includes(normaliseText(s.siteName)));
  if(match) return match;

  // reverse contains
  match = sites.find(s => normaliseText(s.siteName).includes(n));
  if(match) return match;

  return null;
}

/* ===========================
   SUPPLIERS
=========================== */
async function populateSuppliers(){
  try {
    const resp = await fetchJSON(SUPPLIERS_URL);
    allSuppliers = resp.data || [];
    const sel = byId('supplier');
    sel.innerHTML = "";

    allSuppliers.forEach(s=>{
      const o = document.createElement('option');
      o.value = s.supplierNumber;
      o.textContent = s.supplierName;
      sel.appendChild(o);
    });

  } catch(err){
    byId('supplier').innerHTML = "<option>Unable to load</option>";
  }
}

/* ===========================
   VEHICLES
=========================== */
async function populateVehicles(){
  try {
    const data = await fetchJSON(VEHICLES_URL);
    const sel = byId('vehicleReg');
    sel.innerHTML = "";

    (data||[]).forEach(v=>{
      const o = document.createElement('option');
      const reg = (v.reg || v.registration || '').replace(/\s+/g,'');
      o.value = reg;
      o.textContent = reg;
      sel.appendChild(o);
    });

  } catch {}
}

/* ===========================
   JOB-LINKED SITE HYDRATION
=========================== */

async function hydrateJobLinkedSite(){
  if(!jobLinked.active || !jobLinked.siteParam) return;

  const siteTypeSelect = byId('siteType');
  const siteTypeReadonly = byId('siteTypeReadonly');
  const siteSelect = byId('site');
  const siteReadonly = byId('siteReadonly');

  // hide selects, show readonly
  siteTypeSelect.style.display = "none";
  siteTypeReadonly.style.display = "block";

  siteSelect.style.display = "none";
  siteReadonly.style.display = "block";

  siteTypeReadonly.value = "Loading…";
  siteReadonly.value = "Matching site…";

  try {
    const sites = await fetchJSON(ALL_SITES_URL);
    if(!Array.isArray(sites)) throw new Error("Worker did not return array");

    const match = findBestMatchingSite(jobLinked.siteParam, sites);
    if(!match){
      siteTypeReadonly.value = "Unknown";
      siteReadonly.value = jobLinked.siteParam + " (No match)";
      return;
    }

    jobLinked.siteNumber = match.siteNumber || "";
    jobLinked.siteName = match.siteName || jobLinked.siteParam;

    // FIXED TYPE MAPPING
    const rawType = (match.storeType || match.client || "").toLowerCase();
    let mapped = "Unknown";
    if(rawType.includes("retail")) mapped = "Retail";
    else if(rawType.includes("els") && rawType.includes("private")) mapped = "ELS Private";
    else if(rawType.includes("els")) mapped = "ELS";
    else if(rawType.includes("cobra")) mapped = "Cobra";
    else if(rawType.includes("wenzel")) mapped = "Wenzel’s";
    else if(rawType.includes("project")) mapped = "Projects";

    jobLinked.siteType = mapped;
    siteTypeReadonly.value = mapped;

    const sn = jobLinked.siteNumber.toString().padStart(4,'0');
    siteReadonly.value = sn + " " + jobLinked.siteName;

    // ensure hidden real selects stay valid for submission
    siteSelect.innerHTML = "";
    const opt = document.createElement('option');
    opt.value = sn;
    opt.textContent = siteReadonly.value;
    siteSelect.appendChild(opt);

    siteTypeSelect.value = mapped;

  } catch(err){
    console.error("Hydration error:", err);
    siteTypeReadonly.value = "Unknown";
    siteReadonly.value = jobLinked.siteParam;
  }
}

/* ===========================
   LOCAL PO NUMBER GENERATOR
=========================== */
function nextPO(engineerCode, supplierNo, siteSeg, typeLetter){
  const key = `poSeq:${engineerCode}|${supplierNo}|${siteSeg}|${typeLetter}`;
  let n = parseInt(localStorage.getItem(key)||"0",10) + 1;
  localStorage.setItem(key, n);
  return `${engineerCode}-${supplierNo}-${siteSeg}-${typeLetter}${n}`;
}

/* ===========================
   INIT
=========================== */
async function init(){
  const username = sessionStorage.getItem("mostlaneUser") || "";
  engineerName = username ? dotToSpace(username) : "Unknown";
  byId("engineer").value = engineerName;

  // Date
  const d = new Date();
  byId('date').value = `${String(d.getDate()).padStart(2,'0')}/${String(d.getMonth()+1).padStart(2,'0')}/${d.getFullYear()}`;

  // Query params
  const params = new URLSearchParams(window.location.search);
  const jobId = params.get("jobId");
  const ref = params.get("ref");
  const siteParam = params.get("site");

  if(jobId){
    jobLinked.active = true;
    jobLinked.jobId = jobId;
    jobLinked.incident = ref || jobId;
    jobLinked.siteParam = siteParam || "";
  }

  // Load engineer code
  try {
    const users = await fetchJSON(USERS_URL);
    const rec = (users||[]).find(u => u.Username===username || u.username===username);
    const num = rec?.EngineerNumber || rec?.engineerNumber || '';
    const empType = (rec?.EmploymentType || rec?.employmentType || 'Employed').toLowerCase();
    const prefix = empType.includes("self") ? "SE" : "E";
    engineerCode = prefix + String(num).trim();
  } catch(err){
    engineerCode = "E0";
  }

  await populateSuppliers();
  await populateVehicles();

  // GEOLOCATION
  if(navigator.geolocation){
    navigator.geolocation.getCurrentPosition(
      pos=>{
        geo.lat = pos.coords.latitude;
        geo.lon = pos.coords.longitude;
        byId('geoStatus').textContent = `Location captured`;
      },
      ()=>{
        byId('geoStatus').textContent = "Location denied";
      },
      {enableHighAccuracy:true, timeout:10000}
    );
  }

  // Work type behaviour
  byId("workType").addEventListener("change", e=>{
    if(jobLinked.active){
      e.target.value = "Reactive";
      return;
    }

    const v = e.target.value;
    const isV = v === "Vehicle Maintenance";

    byId("siteTypeRow").style.display = isV ? "none" : "";
    byId("siteRow").style.display = isV ? "none" : "";
    byId("vehicleRow").classList.toggle("hidden", !isV);
  });

  if(jobLinked.active){
    // lock mode
    byId("workType").value = "Reactive";
    byId("workType").disabled = true;

    const inc = byId("incident");
    inc.value = jobLinked.incident;
    inc.readOnly = true;
    inc.classList.add("readonly-field");

    hydrateJobLinkedSite();
  }
}

/* ===========================
   SUBMIT
=========================== */
async function onSubmit(e){
  e.preventDefault();
  const submitBtn = byId("submitBtn");
  submitBtn.disabled = true;

  const engineerVal = byId("engineer").value;
  const dateVal = byId("date").value;
  const workType = byId("workType").value;
  const supplierNumber = byId("supplier").value;
  const supplierName = byId("supplier").selectedOptions[0]?.textContent || '';
  const desc = byId("desc").value.trim();
  const incidentVal = byId("incident").value.trim();

  if(!desc){
    alert("Description required");
    submitBtn.disabled = false;
    return;
  }

  if(geo.lat === null){
    alert("Location required");
    submitBtn.disabled = false;
    return;
  }

  let siteNumber = byId("site").value;
  if(jobLinked.active && jobLinked.siteNumber){
    siteNumber = jobLinked.siteNumber.toString().padStart(4,'0');
  }

  const typeLetter = workType === "Reactive" ? "R" : workType === "Planned" ? "P" : "V";

  const siteSeg = workType === "Vehicle Maintenance"
      ? (byId("vehicleReg").value || "").replace(/\s+/g,'')
      : (siteNumber || "NONE");

  const poCode = nextPO(engineerCode, supplierNumber, siteSeg, typeLetter);

  byId('poCodeText').textContent = poCode;
  byId('modalBackdrop').style.display = "flex";

  const payload = {
    poNumber: poCode,
    engineer: engineerVal,
    engineerCode,
    date: dateVal,
    workType,
    supplierName,
    supplierNumber,
    description: desc,
    incidentNumber: incidentVal,
    latitude: geo.lat,
    longitude: geo.lon,
    createdAt: new Date().toISOString()
  };

  if(jobLinked.active){
    payload.jobLinked = true;
    payload.jobId = jobLinked.jobId;
    payload.siteNumber = jobLinked.siteNumber;
    payload.siteName = jobLinked.siteName;
    payload.siteType = jobLinked.siteType;
  } else {
    payload.siteNumber = siteNumber;
  }

  try {
    const res = await fetch(CLOUDFLARE_ENDPOINT, {
      method:"POST",
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify(payload)
    });
    const result = await res.json();
    if(!res.ok){
      alert("Server error: " + (result.error||"Unknown"));
    }
  } catch(err){
    alert("Failed to submit: " + err.message);
  }

  submitBtn.disabled = false;
}

/* ===========================
   MODAL BUTTONS
=========================== */
document.addEventListener("DOMContentLoaded", ()=>{
  init();

  byId('poForm').addEventListener('submit', onSubmit);
  byId('copyBtn').onclick = ()=> navigator.clipboard.writeText(byId('poCodeText').textContent);
  byId('closeBtn').onclick = ()=> byId('modalBackdrop').style.display="none";
  byId('newBtn').onclick = ()=>{
    byId('modalBackdrop').style.display="none";
    window.location.reload();
  };
});

</script>
</body>
</html>
