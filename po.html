<!DOCTYPE html>
<html lang="en">
<head>
  <script src="auth.js"></script>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Generate Purchase Order Reference</title>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background: #e6e8eb url('Mostlane_Embossed.png') no-repeat center center fixed;
      background-size: cover;
      margin: 0;
      padding: 40px 20px;
      color: #333;
    }
    .main-body {
      max-width: 520px;
      margin: auto;
      background: rgba(255,255,255,0.9);
      padding: 24px 24px 30px;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    h1 {
      text-align: center;
      color: #003366;
      margin: 0 0 16px 0;
    }
    label {
      display: block;
      margin-top: 16px;
      font-weight: bold;
      color: #003366;
    }
    input, select, button, textarea {
      width: 100%;
      padding: 10px;
      font-size: 16px;
      margin-top: 6px;
      border-radius: 6px;
      border: 1px solid #ccc;
      box-sizing: border-box;
    }
    textarea { min-height: 80px; resize: vertical; }
    .row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }
    .button {
      margin-top: 22px;
      padding: 12px;
      width: 100%;
      background-color: rgba(0, 74, 153, 0.9);
      color: white;
      font-size: 18px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
    }
    .button[disabled] { opacity: 0.6; cursor: not-allowed; }
    .subtle { margin-top: 8px; font-size: 13px; color: #666; }
    .hidden { display: none; }

    .modal-backdrop {
      position: fixed; inset: 0;
      background: rgba(0,0,0,0.45);
      display: none;
      align-items: center; justify-content: center;
      z-index: 9999;
    }
    .modal {
      background: #fff;
      border-radius: 12px;
      padding: 20px;
      max-width: 420px;
      width: calc(100% - 40px);
      box-shadow: 0 10px 30px rgba(0,0,0,0.25);
      text-align: center;
    }
    .modal h2 { color: #003366; margin: 0 0 8px 0; }
    .modal .po-code { font-weight: 700; font-size: 20px; color: #003366; margin: 8px 0 16px; word-break: break-all; }
    .modal .actions {
      display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 12px;
    }
    .modal button, .modal a {
      padding: 10px; border-radius: 8px; border: none;
      background: rgba(0,74,153,0.9); color: #fff; text-decoration: none; font-size: 16px;
    }
    .modal .close-btn { background: #888; }
  </style>
</head>
<body>
  <div class="main-body">
    <h1>Generate Purchase Order Reference</h1>

    <form id="poForm">
      <label for="engineer">Engineer</label>
      <input type="text" id="engineer" readonly />

      <div class="row">
        <div>
          <label for="date">Date</label>
          <input type="text" id="date" readonly />
        </div>
        <div>
          <label for="workType">Work Type</label>
          <select id="workType" required>
            <option value="Reactive">Reactive</option>
            <option value="Planned">Planned</option>
            <option value="Vehicle Maintenance">Vehicle Maintenance</option>
          </select>
        </div>
      </div>

      <div id="incidentRow">
        <label for="incident">Incident Number</label>
        <input type="text" id="incident" placeholder="Enter incident number">
      </div>

      <div id="siteTypeRow">
        <label for="siteType">Site Type</label>
        <select id="siteType">
          <option value="">All Sites</option>
          <option value="Retail">Retail</option>
          <option value="ELS">ELS</option>
          <option value="ELS Private">ELS Private</option>
          <option value="Cobra">Cobra</option>
          <option value="Wenzel‚Äôs">Wenzel‚Äôs</option>
          <option value="Projects">Projects</option>
        </select>
      </div>

      <div id="siteRow">
        <label for="site">Site</label>
        <select id="site"></select>
        <div class="subtle">(Shown: Site Name ‚Äî uses Site Number internally)</div>
      </div>

      <div id="vehicleRow" class="hidden">
        <label for="vehicleReg">Vehicle Registration</label>
        <select id="vehicleReg"></select>
      </div>

      <label for="supplier">Supplier</label>
      <select id="supplier" required></select>
      <div class="subtle">(Shown: Supplier Name ‚Äî uses Supplier Number internally)</div>

      <label for="desc">Short Description</label>
      <textarea id="desc" placeholder="What is this PO for?" required></textarea>

      <button type="submit" class="button" id="submitBtn">Create PO</button>
      <button type="button" id="personalBtn" class="button" style="background-color:#005bb5;margin-top:10px;">Personal Purchase (Tools etc.)</button>

      <div class="subtle" id="geoStatus">Attempting to get your location‚Ä¶</div>
    </form>
  </div>

  <div class="modal-backdrop" id="modalBackdrop">
    <div class="modal">
      <h2>‚úÖ Purchase Order Created</h2>
      <div class="po-code" id="poCodeText"></div>
      <div class="actions">
        <button id="copyBtn" type="button">Copy</button>
        <a id="viewAllBtn" href="view-pos.html">View All POs</a>
        <button id="closeBtn" class="close-btn" type="button">Close</button>
        <button id="newBtn" type="button">New PO</button>
      </div>
    </div>
  </div>
  <script>
  const RAW = 'https://raw.githubusercontent.com/Mostlane/Test/main/';
  const USERS_URL = RAW + 'users.json';
 const SUPPLIERS_URL = "https://mostlane-pos.jamie-def.workers.dev/get-suppliers";
  const VEHICLES_URL = RAW + 'vehicles.json';

  // ‚úÖ Live Cloudflare Worker endpoints
  const SITE_ENDPOINTS = {
    retail: 'https://mostlane-pos.jamie-def.workers.dev/get-sites?type=retail',
    els: 'https://mostlane-pos.jamie-def.workers.dev/get-sites?type=els',
    els_private: 'https://mostlane-pos.jamie-def.workers.dev/get-sites?type=els_private',
    cobra: 'https://mostlane-pos.jamie-def.workers.dev/get-sites?type=cobra',
    wenzels: 'https://mostlane-pos.jamie-def.workers.dev/get-sites?type=wenzels',
    projects: 'https://mostlane-pos.jamie-def.workers.dev/get-sites?type=projects'
  };

  const CLOUDFLARE_ENDPOINT = 'https://mostlane-pos.jamie-def.workers.dev/add-po';
  const API_KEY = '';

  const byId = id => document.getElementById(id);
  const fetchJSON = url => fetch(url + '&v=' + Date.now()).then(r => r.json());
  const dotToSpace = s => (s || '').replace(/\./g, ' ');
  const formatDateUK = (d = new Date()) => `${String(d.getDate()).padStart(2,'0')}/${String(d.getMonth()+1).padStart(2,'0')}/${d.getFullYear()}`;
  const norm = v => (v||'').toString().toLowerCase().trim();

  let engineerCode='', engineerName='', geo={lat:null,lon:null}, allSites=[], allSuppliers=[];

  // =====================================
  //  FETCH + NORMALISE SITE JSON STRUCTURE
  // =====================================
  async function fetchSitesForKey(key) {
    const url = SITE_ENDPOINTS[key];
    if (!url) return [];
    try {
      const data = await fetchJSON(url);
      if (!data) return [];

      let list = [];

      // Flat array (ELS, Cobra, etc.)
      if (Array.isArray(data)) {
        if (data.length === 1 && typeof data[0] === "object" && !Array.isArray(data[0])) {
          const big = data[0];
          for (const code in big) {
            const s = big[code];
            const storeCode = String(s.branchCode || s["Branch Code"] || code || "").padStart(4, "0");
            const storeName = s.storeName || s["Store Name"] || s.siteName || "";
            list.push({ code: storeCode, name: storeName });
          }
        } else {
          data.forEach(s => {
            const storeCode = String(s["Branch Code"] || s.branchCode || s.siteCode || "").padStart(4, "0");
            const storeName = s["Store Name"] || s.storeName || s.siteName || "";
            list.push({ code: storeCode, name: storeName });
          });
        }
      } else if (typeof data === "object") {
        for (const code in data) {
          const s = data[code];
          const storeCode = String(s.branchCode || s["Branch Code"] || code || "").padStart(4, "0");
          const storeName = s.storeName || s["Store Name"] || "";
          list.push({ code: storeCode, name: storeName });
        }
      }

      // Sort numerically ascending
      return list.filter(x => x.code && x.name).sort((a,b)=>Number(a.code)-Number(b.code));
    } catch (e) {
      console.warn("Sites fetch failed for", key, e);
      return [];
    }
  }

  // =====================================
  //     SUPPLIER & VEHICLE POPULATION
  // =====================================
async function populateSuppliers(){
  try {
    allSuppliers = await fetchJSON(SUPPLIERS_URL);
    const sel = byId('supplier');
    sel.innerHTML = '';
    allSuppliers.forEach(s => {
      const opt = document.createElement('option');
      opt.value = s.code;         // ‚¨ÖÔ∏è previously s.supplierNumber
      opt.textContent = s.name;   // ‚¨ÖÔ∏è previously s.supplierName
      sel.appendChild(opt);
    });
  } catch {
    byId('supplier').innerHTML = '<option>(Unable to load)</option>';
  }
}

  async function populateVehicles(){
    try {
      const vehicles = await fetchJSON(VEHICLES_URL);
      const sel=byId('vehicleReg'); sel.innerHTML='';
      (vehicles||[]).forEach(v=>{
        const opt=document.createElement('option');
        const reg=(v.reg||v.registration||'').toString().replace(/\s+/g,'');
        opt.value=reg; opt.textContent=v.reg||v.registration||reg;
        sel.appendChild(opt);
      });
    } catch{}
  }

  // =====================================
  //        SITE SELECTION HANDLER
  // =====================================
  async function populateSites(){
    allSites = [];
    const type = norm(byId('siteType').value);
    if (!type) { byId('site').innerHTML='<option>Select Site Type</option>'; return; }

    const keyMap = {
      'retail':'retail',
      'els':'els',
      'els private':'els_private',
      'cobra':'cobra',
      'wenzel‚Äôs':'wenzels',
      'projects':'projects'
    };
    const key = keyMap[type] || 'retail';
    allSites = await fetchSitesForKey(key);
    const sel = byId('site');
    sel.innerHTML = '';
    allSites.forEach(s => {
      const opt = document.createElement('option');
      opt.value = s.code;
      opt.textContent = `${s.code} ${s.name}`;
      sel.appendChild(opt);
    });
    if (!allSites.length) sel.innerHTML = '<option>(No options)</option>';
  }

  // =====================================
  //           PO NUMBER GENERATION
  // =====================================
  function nextPO(engineerCode, supplierNo, siteSegment, typeLetter){
    const key = `poSeq:${engineerCode}|${supplierNo}|${siteSegment}|${typeLetter}`;
    let n = parseInt(localStorage.getItem(key) || "0",10)+1;
    localStorage.setItem(key,n);
    return `${engineerCode}-${supplierNo}-${siteSegment}-${typeLetter}${n}`;
  }

  function showModal(po){ byId('poCodeText').textContent=po; byId('modalBackdrop').style.display='flex'; }
  function hideModal(){ byId('modalBackdrop').style.display='none'; }

  // =====================================
  //           INITIALISATION LOGIC
  // =====================================
  async function init(){
    const username=sessionStorage.getItem('mostlaneUser')||'';
    engineerName=username?dotToSpace(username):'Unknown';
    byId('engineer').value=engineerName;
    byId('date').value=formatDateUK();

    try{
      const users=await fetchJSON(USERS_URL);
      const rec=(users||[]).find(u=>u.Username===username||u.username===username);
      const engNum=rec?.EngineerNumber||rec?.engineerNumber||'';
      const empType=(rec?.EmploymentType||rec?.employmentType||'Employed').toLowerCase();
      const prefix=empType.includes('self')?'SE':'E';
      engineerCode=prefix+String(engNum||'').trim();
    }catch{engineerCode='E0';}

    await populateSuppliers();
    await populateVehicles();

    if(navigator.geolocation){
      navigator.geolocation.getCurrentPosition(
        pos=>{
          geo.lat=pos.coords.latitude; geo.lon=pos.coords.longitude;
          byId('geoStatus').textContent=`üìç Location captured: ${geo.lat.toFixed(5)}, ${geo.lon.toFixed(5)}`;
        },
        ()=>{byId('geoStatus').textContent='‚ö†Ô∏è Location permission denied. Allow access.';},
        {enableHighAccuracy:true,timeout:10000}
      );
    } else byId('geoStatus').textContent='‚ùå Geolocation not supported.';

    byId('workType').addEventListener('change', e=>{
      const val=e.target.value;
      const isReactive=val==='Reactive';
      const isVehicle=val==='Vehicle Maintenance';
      byId('incidentRow').style.display=isReactive?'':'none';
      byId('siteTypeRow').style.display=isVehicle?'none':'';
      byId('siteRow').style.display=isVehicle?'none':'';
      byId('vehicleRow').classList.toggle('hidden',!isVehicle);
    });

    byId('siteType').addEventListener('change', populateSites);

    byId('copyBtn').onclick=()=>navigator.clipboard.writeText(byId('poCodeText').textContent);
    byId('closeBtn').onclick=hideModal;
    byId('newBtn').onclick=()=>{hideModal();byId('poForm').reset();byId('engineer').value=engineerName;byId('date').value=formatDateUK();};

    byId('personalBtn').onclick=()=>{
      const eng=encodeURIComponent(byId('engineer').value||'');
      const date=encodeURIComponent(byId('date').value||'');
      window.open(`https://form.jotform.com/250527962516057?engineer=${eng}&date=${date}`,'_blank');
    };

    byId('poForm').addEventListener('submit',onSubmit);
  }

  // =====================================
  //              SUBMIT LOGIC
  // =====================================
  async function onSubmit(e){
    e.preventDefault();
    const submitBtn=byId('submitBtn'); submitBtn.disabled=true;
    const workType=byId('workType').value;
    const isVehicle=workType==='Vehicle Maintenance';
    const engineerVal=byId('engineer').value.trim();
    const dateVal=byId('date').value.trim();
    const siteNumber=byId('site').value;
    const vehicleReg=byId('vehicleReg').value;
    const supplierNumber=byId('supplier').value;
    const supplierName=byId('supplier').selectedOptions[0]?.textContent||'';
    const descVal=byId('desc').value.trim();
    const incidentVal=byId('incident').value.trim();

    if(!engineerVal||!dateVal||!descVal||!supplierNumber){
      alert('All required fields must be completed.');
      submitBtn.disabled=false; return;
    }
    if(geo.lat===null||geo.lon===null){
      alert('Location required. Enable location.');
      submitBtn.disabled=false; return;
    }

    const typeLetter=workType==='Reactive'?'R':workType==='Planned'?'P':'V';
    const siteSegment=isVehicle?(vehicleReg||'').replace(/\s+/g,''):siteNumber;
    const poCode=nextPO(engineerCode,supplierNumber,siteSegment,typeLetter);
    showModal(poCode);

    const data = {
      poNumber: poCode,
      engineer: engineerVal,
      engineerCode,
      date: dateVal,
      workType,
      supplierName,
      supplierNumber,
      description: descVal,
      latitude: geo.lat,
      longitude: geo.lon,
      incidentNumber: incidentVal,
      notes: descVal,
      createdAt: new Date().toISOString()
    };

    try {
      const res = await fetch(CLOUDFLARE_ENDPOINT, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          ...(API_KEY ? { 'x-api-key': API_KEY } : {})
        },
        body: JSON.stringify(data),
        cache: 'no-store'
      });
      const result = await res.json();
      if(res.ok) alert(`‚úÖ Purchase Order ${poCode} submitted successfully.`);
      else alert(`‚ö†Ô∏è Failed: ${result?.error || 'Unknown error'}`);
    } catch (err) {
      alert('‚ö†Ô∏è Failed to reach server: ' + err.message);
    } finally {
      submitBtn.disabled = false;
    }
  }

  document.addEventListener('DOMContentLoaded',init);
</script>
</body>
</html>
