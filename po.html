<!DOCTYPE html>
<html lang="en">
<head>
  <script src="auth.js"></script>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Generate Purchase Order Reference</title>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background: #e6e8eb url('Mostlane_Embossed.png') no-repeat center center fixed;
      background-size: cover;
      margin: 0;
      padding: 40px 20px;
      color: #333;
    }
    .main-body {
      max-width: 520px;
      margin: auto;
      background: rgba(255,255,255,0.9);
      padding: 24px 24px 30px;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    h1 {
      text-align: center;
      color: #003366;
      margin: 0 0 16px 0;
    }
    label {
      display: block;
      margin-top: 16px;
      font-weight: bold;
      color: #003366;
    }
    input, select, button, textarea {
      width: 100%;
      padding: 10px;
      font-size: 16px;
      margin-top: 6px;
      border-radius: 6px;
      border: 1px solid #ccc;
      box-sizing: border-box;
    }
    textarea { min-height: 80px; resize: vertical; }
    .row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }
    .button {
      margin-top: 22px;
      padding: 12px;
      width: 100%;
      background-color: rgba(0, 74, 153, 0.9);
      color: white;
      font-size: 18px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
    }
    .button[disabled] { opacity: 0.6; cursor: not-allowed; }
    .subtle { margin-top: 8px; font-size: 13px; color: #666; }
    .hidden { display: none; }
    .readonly-field {
      background: #f3f4f6;
      cursor: default;
    }

    .modal-backdrop {
      position: fixed; inset: 0;
      background: rgba(0,0,0,0.45);
      display: none;
      align-items: center; justify-content: center;
      z-index: 9999;
    }
    .modal {
      background: #fff;
      border-radius: 12px;
      padding: 20px;
      max-width: 420px;
      width: calc(100% - 40px);
      box-shadow: 0 10px 30px rgba(0,0,0,0.25);
      text-align: center;
    }
    .modal h2 { color: #003366; margin: 0 0 8px 0; }
    .modal .po-code { font-weight: 700; font-size: 20px; color: #003366; margin: 8px 0 16px; word-break: break-all; }
    .modal .actions {
      display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 12px;
    }
    .modal button, .modal a {
      padding: 10px; border-radius: 8px; border: none;
      background: rgba(0,74,153,0.9); color: #fff; text-decoration: none; font-size: 16px;
    }
    .modal .close-btn { background: #888; }
  </style>
</head>

<body>
  <div class="main-body">
    <h1>Generate Purchase Order Reference</h1>

    <form id="poForm">
      <label for="engineer">Engineer</label>
      <input type="text" id="engineer" readonly />

      <div class="row">
        <div>
          <label for="date">Date</label>
          <input type="text" id="date" readonly />
        </div>
        <div>
          <label for="workType">Work Type</label>
          <select id="workType" required>
            <option value="Reactive">Reactive</option>
            <option value="Planned">Planned</option>
            <option value="Vehicle Maintenance">Vehicle Maintenance</option>
          </select>
        </div>
      </div>

      <div id="incidentRow">
        <label for="incident">Incident Number</label>
        <input type="text" id="incident">
      </div>

      <div id="siteTypeRow">
        <label for="siteType">Site Type</label>
        <select id="siteType">
          <option value="">All Sites</option>
          <option value="Retail">Retail</option>
          <option value="ELS">ELS</option>
          <option value="ELS Private">ELS Private</option>
          <option value="Cobra">Cobra</option>
          <option value="Wenzelâ€™s">Wenzelâ€™s</option>
          <option value="Projects">Projects</option>
        </select>

        <input id="siteTypeReadonly" class="readonly-field" readonly style="display:none;margin-top:6px;">
      </div>

      <div id="siteRow">
        <label for="site">Site</label>
        <select id="site"></select>

        <input id="siteReadonly" class="readonly-field" readonly style="display:none;margin-top:6px;">
        <div class="subtle">(Shown: Site Name â€“ uses Site Number internally)</div>
      </div>

      <div id="vehicleRow" class="hidden">
        <label for="vehicleReg">Vehicle Registration</label>
        <select id="vehicleReg"></select>
      </div>

      <label for="supplier">Supplier</label>
      <select id="supplier" required></select>

      <label for="desc">Short Description</label>
      <textarea id="desc" required></textarea>

      <button id="submitBtn" type="submit" class="button">Create PO</button>
      <button id="personalBtn" type="button" class="button" style="background:#005bb5;margin-top:10px;">
        Personal Purchase (Tools etc.)
      </button>

      <div class="subtle" id="geoStatus">Attempting to get your locationâ€¦</div>
    </form>
  </div>

  <!-- MODAL -->
  <div class="modal-backdrop" id="modalBackdrop">
    <div class="modal">
      <h2>âœ… Purchase Order Created</h2>
      <div class="po-code" id="poCodeText"></div>
      <div class="actions">
        <button id="copyBtn" type="button">Copy</button>
        <a href="view-pos.html" id="viewAllBtn">View All POs</a>
        <button id="closeBtn" class="close-btn">Close</button>
        <button id="newBtn">New PO</button>
      </div>
    </div>
  </div>

<script>
/* ------------------------------
   CONSTANTS & URLS
------------------------------ */
const RAW = "https://raw.githubusercontent.com/Mostlane/Test/main/";
const USERS_URL = RAW + "users.json";
const VEHICLES_URL = RAW + "vehicles.json";
const SUPPLIERS_URL = "https://mostlane-po.jamie-def.workers.dev/suppliers";

// ALL SITES IN ONE WORKER
const ALL_SITES_URL = "https://mostlane-sites.jamie-def.workers.dev";

const CLOUDFLARE_ENDPOINT = "https://mostlane-po.jamie-def.workers.dev/po/create";

const byId = id => document.getElementById(id);
const fetchJSON = url => fetch(url + "?v=" + Date.now()).then(r => r.json());

/* ------------------------------
   NORMALISATION HELPERS
------------------------------ */
function normalise(s){
  return (s || "").toString().trim().toLowerCase().replace(/\s+/g, " ");
}

/* ------------------------------
   JOB LINKED MODE STORE
------------------------------ */
let jobLinked = {
  active: false,
  jobId: null,
  incident: null,
  siteParam: null,
  siteNumber: null,
  siteName: null,
  siteType: null
};

/* ------------------------------
   SUPPLIERS
------------------------------ */
async function populateSuppliers() {
  try {
    const resp = await fetchJSON(SUPPLIERS_URL);
    const list = resp.data || [];
    const sel = byId("supplier");
    sel.innerHTML = "";
    list.forEach(s => {
      const opt = document.createElement("option");
      opt.value = s.supplierNumber;
      opt.textContent = s.supplierName;
      sel.appendChild(opt);
    });
  } catch {
    byId("supplier").innerHTML = "<option>(Unable to load)</option>";
  }
}

/* ------------------------------
   VEHICLES
------------------------------ */
async function populateVehicles() {
  try {
    const list = await fetchJSON(VEHICLES_URL);
    const sel = byId("vehicleReg");
    sel.innerHTML = "";
    (list || []).forEach(v => {
      const opt = document.createElement("option");
      const reg = (v.reg || v.registration || "").replace(/\s+/g, "");
      opt.value = reg;
      opt.textContent = v.reg || v.registration || reg;
      sel.appendChild(opt);
    });
  } catch {}
}

/* ------------------------------
   MATCH SITE FROM WORKER DATA
------------------------------ */
function matchSite(param, sites){
  if(!param) return null;
  const p = normalise(param);

  // match number in param
  const matchNum = param.match(/\b(\d{4})\b/);
  if(matchNum){
    const sn = matchNum[1];
    const found = sites.find(s => (s.siteNumber || "").toString() === sn);
    if(found) return found;
  }

  // exact name match
  let found = sites.find(s => normalise(s.siteName) === p);
  if(found) return found;

  // param contains site name
  found = sites.find(s => p.includes(normalise(s.siteName)));
  if(found) return found;

  // site name contains param
  found = sites.find(s => normalise(s.siteName).includes(p));
  if(found) return found;

  return null;
}

/* ------------------------------
   NORMALISE SITE TYPE (FINAL FIX)
------------------------------ */
function mapSiteType(raw){
  const t = normalise(raw);

  if(t.includes("retail")) return "Retail";
  if(t.includes("els") && t.includes("private")) return "ELS Private";
  if(t.includes("els")) return "ELS";
  if(t.includes("cobra")) return "Cobra";
  if(t.includes("wenzel")) return "Wenzelâ€™s";
  if(t.includes("project")) return "Projects";

  return "Unknown";
}

/* ------------------------------
   HYDRATE SITE FIELDS (JOB MODE)
------------------------------ */
async function hydrateJobSite(){
  const siteSelect = byId("site");
  const siteRO = byId("siteReadonly");
  const typeSelect = byId("siteType");
  const typeRO = byId("siteTypeReadonly");

  // hide dropdowns, show readonlys
  siteSelect.style.display = "none";
  siteRO.style.display = "block";

  typeSelect.style.display = "none";
  typeRO.style.display = "block";

  siteRO.value = "Matching siteâ€¦";
  typeRO.value = "Loadingâ€¦";

  try {
    const sites = await fetchJSON(ALL_SITES_URL);
    const match = matchSite(jobLinked.siteParam, sites);

    if(!match){
      siteRO.value = jobLinked.siteParam + " (not found)";
      typeRO.value = "Unknown";
      return;
    }

    jobLinked.siteNumber = match.siteNumber;
    jobLinked.siteName = match.siteName;
    jobLinked.siteType = mapSiteType(match.storeType || match.client);

    const sn = match.siteNumber ? match.siteNumber.toString().padStart(4,"0") : "";
    siteRO.value = sn ? `${sn} ${match.siteName}` : match.siteName;
    typeRO.value = jobLinked.siteType;

    // sync hidden selects
    typeSelect.value = jobLinked.siteType;
    siteSelect.innerHTML = "";
    const opt = document.createElement("option");
    opt.value = sn;
    opt.textContent = siteRO.value;
    siteSelect.appendChild(opt);
  }
  catch(err){
    console.error(err);
    siteRO.value = jobLinked.siteParam;
    typeRO.value = "Unknown";
  }
}

/* ------------------------------
   INIT FUNCTION
------------------------------ */
async function init(){
  // engineer name
  const username = sessionStorage.getItem("mostlaneUser") || "";
  const engineerName = username.replace(/\./g, " ");
  byId("engineer").value = engineerName;

  byId("date").value = formatDateUK();

  // detect job mode
  const p = new URLSearchParams(location.search);
  if(p.get("jobId")){
    jobLinked.active = true;
    jobLinked.jobId = p.get("jobId");
    jobLinked.incident = p.get("ref") || jobLinked.jobId;
    jobLinked.siteParam = p.get("site") || "";
  }

  await populateSuppliers();
  await populateVehicles();

  // geolocation
  if(navigator.geolocation){
    navigator.geolocation.getCurrentPosition(
      pos=>{
        geo.lat = pos.coords.latitude;
        geo.lon = pos.coords.longitude;
        byId("geoStatus").textContent = `ðŸ“ ${geo.lat.toFixed(5)}, ${geo.lon.toFixed(5)}`;
      },
      ()=> byId("geoStatus").textContent = "âš ï¸ Location permission denied."
    );
  }

  // normal behaviour
  byId("siteType").addEventListener("change", populateSites);
  byId("workType").addEventListener("change", e=>{
    if(jobLinked.active){
      e.target.value = "Reactive";
      return;
    }
  });

  // job mode overrides
  if(jobLinked.active){
    // lock incident + worktype
    byId("incident").value = jobLinked.incident;
    byId("incident").readOnly = true;
    byId("incident").classList.add("readonly-field");

    const wt = byId("workType");
    wt.value = "Reactive";
    wt.disabled = true;

    hydrateJobSite();
  } else {
    populateSites();
  }

  // modal buttons
  byId("copyBtn").onclick = () =>
    navigator.clipboard.writeText(byId("poCodeText").textContent);

  byId("closeBtn").onclick = () =>
    byId("modalBackdrop").style.display = "none";

  byId("newBtn").onclick = () => location.reload();

  byId("personalBtn").onclick = () => {
    const eng = encodeURIComponent(byId("engineer").value);
    const date = encodeURIComponent(byId("date").value);
    window.open(
      `https://form.jotform.com/250527962516057?engineer=${eng}&date=${date}`,
      "_blank"
    );
  };

  byId("poForm").addEventListener("submit", submitPO);
}

/* ------------------------------
   SUBMIT PO
------------------------------ */
async function submitPO(e){
  e.preventDefault();

  const engineer = byId("engineer").value.trim();
  const dateVal = byId("date").value.trim();
  const desc = byId("desc").value.trim();
  const supplierNum = byId("supplier").value;
  const supplierName = byId("supplier").selectedOptions[0].textContent;
  const incident = byId("incident").value.trim();
  const workType = "Reactive"; // job mode always reactive

  let siteNumber = byId("site").value;

  if(jobLinked.active && jobLinked.siteNumber){
    siteNumber = jobLinked.siteNumber.toString().padStart(4,"0");
  }

  const typeLetter = "R";
  const poCode = `${engineerCode}-${supplierNum}-${siteNumber}-${typeLetter}${Date.now().toString().slice(-4)}`;

  // show modal
  byId("poCodeText").textContent = poCode;
  byId("modalBackdrop").style.display = "flex";

  const payload = {
    poNumber: poCode,
    engineer,
    engineerCode,
    date: dateVal,
    workType,
    supplierNumber: supplierNum,
    supplierName,
    description: desc,
    incidentNumber: incident,
    latitude: geo.lat,
    longitude: geo.lon,
    createdAt: new Date().toISOString()
  };

  if(jobLinked.active){
    payload.jobLinked = true;
    payload.jobId = jobLinked.jobId;
    payload.siteNumber = jobLinked.siteNumber;
    payload.siteName = jobLinked.siteName;
    payload.siteType = jobLinked.siteType;
  }

  try{
    const res = await fetch(CLOUDFLARE_ENDPOINT, {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify(payload)
    });

    if(!res.ok){
      alert("âš  Error submitting PO");
    }
  }
  catch(err){
    alert("âš  Network error submitting PO");
  }
}

document.addEventListener("DOMContentLoaded", init);
</script>

</body>
</html>
