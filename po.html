<!DOCTYPE html>
<html lang="en">
<head>
  <script src="auth.js"></script>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Generate Purchase Order Reference</title>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background: #e6e8eb url('Mostlane_Embossed.png') no-repeat center center fixed;
      background-size: cover;
      margin: 0;
      padding: 40px 20px;
      color: #333;
    }
    .main-body {
      max-width: 520px;
      margin: auto;
      background: rgba(255,255,255,0.9);
      padding: 24px 24px 30px;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      position: relative;
    }
    h1 {
      text-align: center;
      color: #003366;
      margin: 0 0 16px 0;
    }
    label {
      display: block;
      margin-top: 16px;
      font-weight: bold;
      color: #003366;
    }
    input, select, button, textarea {
      width: 100%;
      padding: 10px;
      font-size: 16px;
      margin-top: 6px;
      border-radius: 6px;
      border: 1px solid #ccc;
      box-sizing: border-box;
    }
    textarea { min-height: 80px; resize: vertical; }
    .row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }
    .button {
      margin-top: 22px;
      padding: 12px;
      width: 100%;
      background-color: rgba(0, 74, 153, 0.9);
      color: white;
      font-size: 18px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
    }
    .button[disabled] { opacity: 0.6; cursor: not-allowed; }
    .subtle {
      margin-top: 8px;
      font-size: 13px;
      color: #666;
    }
    .hidden { display: none; }

    /* Confirmation modal */
    .modal-backdrop {
      position: fixed; inset: 0;
      background: rgba(0,0,0,0.45);
      display: none;
      align-items: center; justify-content: center;
      z-index: 9999;
    }
    .modal {
      background: #fff;
      border-radius: 12px;
      padding: 20px;
      max-width: 420px;
      width: calc(100% - 40px);
      box-shadow: 0 10px 30px rgba(0,0,0,0.25);
      text-align: center;
    }
    .modal h2 {
      margin: 0 0 8px 0;
      color: #003366;
      font-size: 20px;
    }
    .modal .po-code {
      font-weight: 700;
      font-size: 20px;
      color: #003366;
      margin: 8px 0 16px;
      word-break: break-all;
    }
    .modal .actions {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-top: 12px;
    }
    .modal button, .modal a {
      padding: 10px; border-radius: 8px; border: none;
      background: rgba(0, 74, 153, 0.9); color: #fff; text-decoration: none;
      font-size: 16px; display: inline-block;
    }
    .modal .close-btn { background: #888; }
  </style>
</head>
<body>
  <div class="main-body">
    <h1>Generate Purchase Order Reference</h1>

    <form id="poForm">
      <label for="engineer">Engineer</label>
      <input type="text" id="engineer" readonly />

      <div class="row">
        <div>
          <label for="date">Date</label>
          <input type="text" id="date" readonly />
        </div>
        <div>
          <label for="workType">Work Type</label>
          <select id="workType" required>
            <option value="Reactive">Reactive</option>
            <option value="Planned">Planned</option>
            <option value="Vehicle Maintenance">Vehicle Maintenance</option>
          </select>
        </div>
      </div>

      <div id="incidentRow">
        <label for="incident">Incident Number</label>
        <input type="text" id="incident" placeholder="Enter incident number">
      </div>

      <div id="siteRow">
        <label for="site">Site</label>
        <select id="site"></select>
        <div class="subtle">(Shown: Site Name ‚Äî uses Site Number internally)</div>
      </div>

      <div id="vehicleRow" class="hidden">
        <label for="vehicleReg">Vehicle Registration</label>
        <select id="vehicleReg"></select>
      </div>

      <label for="supplier">Supplier</label>
      <select id="supplier" required></select>
      <div class="subtle">(Shown: Supplier Name ‚Äî uses Supplier Number internally)</div>

      <label for="desc">Short Description</label>
      <textarea id="desc" placeholder="What is this PO for?" required></textarea>

      <button type="submit" class="button" id="submitBtn">Create PO</button>

      <button type="button" id="personalBtn" class="button" style="background-color:#005bb5;margin-top:10px;">
        Personal Purchase (Tools etc.)
      </button>

      <div class="subtle" id="geoStatus">Attempting to get your location‚Ä¶</div>
    </form>
  </div>

  <!-- Confirmation Modal -->
  <div class="modal-backdrop" id="modalBackdrop" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
    <div class="modal">
      <h2 id="modalTitle">‚úÖ Purchase Order Created</h2>
      <div class="po-code" id="poCodeText">E4-1031-S0001-R27</div>
      <div class="actions">
        <button id="copyBtn" type="button">Copy</button>
        <a id="viewAllBtn" href="view-pos.html">View All POs</a>
        <button id="closeBtn" class="close-btn" type="button">Close</button>
        <button id="newBtn" type="button">New PO</button>
      </div>
    </div>
  </div>

  <script>
    const RAW = 'https://raw.githubusercontent.com/Mostlane/Test/main/';
    const USERS_URL = RAW + 'users.json';
    const SITES_URL = RAW + 'sites.json';
    const SUPPLIERS_URL = RAW + 'suppliers.json';
    const VEHICLES_URL = RAW + 'vehicles.json';
    const WEBHOOK_URL = 'https://hooks.zapier.com/hooks/catch/20261714/2xp7i3r/';

    const byId = id => document.getElementById(id);
    const cacheBust = url => url + (url.includes('?') ? '&' : '?') + 'v=' + Date.now();
    const fetchJSON = url => fetch(cacheBust(url)).then(r => r.json());
    const dotToSpace = s => (s || '').replace(/\./g, ' ');
    const formatDateUK = (d = new Date()) => {
      const dd = String(d.getDate()).padStart(2,'0');
      const mm = String(d.getMonth()+1).padStart(2,'0');
      const yy = d.getFullYear();
      return `${dd}/${mm}/${yy}`;
    };
    function norm(v){ return (v||'').toString().toLowerCase().trim(); }

    let allSites = [], allSuppliers = [];
    let engineerCode = '', engineerName = '';
    let geo = { lat: null, lon: null };

    function nextPO(engineerCode, supplierNo, siteSegment, typeLetter){
      const key = `poSeq:${engineerCode}|${supplierNo}|${siteSegment}|${typeLetter}`;
      let n = parseInt(localStorage.getItem(key) || "0", 10) + 1;
      localStorage.setItem(key, n);
      return `${engineerCode}-${supplierNo}-${siteSegment}-${typeLetter}${n}`;
    }

    async function populateSuppliers(){
      try {
        allSuppliers = await fetchJSON(SUPPLIERS_URL);
        const sel = byId('supplier');
        sel.innerHTML = '';
        allSuppliers.forEach(s => {
          const opt = document.createElement('option');
          opt.value = s.supplierNumber;
          opt.textContent = s.supplierName;
          sel.appendChild(opt);
        });
      } catch {
        byId('supplier').innerHTML = '<option value="">(Unable to load suppliers)</option>';
      }
    }

    async function populateSites(){
      try {
        const sites = await fetchJSON(SITES_URL);
        const sel = byId('site');
        sel.innerHTML = '';
        (sites || []).forEach(s => {
          const shown = [s.siteName, s.jobNumber].filter(Boolean).join(' ‚Äî ');
          const opt = document.createElement('option');
          opt.value = s.jobNumber || '';
          opt.textContent = shown;
          opt.dataset.siteName = s.siteName || '';
          sel.appendChild(opt);
        });
      } catch {
        byId('site').innerHTML = '<option value="">(Unable to load sites)</option>';
      }
    }

    async function populateVehicles(){
      try {
        const vehicles = await fetchJSON(VEHICLES_URL);
        const sel = byId('vehicleReg');
        sel.innerHTML = '';
        (vehicles || []).forEach(v => {
          const opt = document.createElement('option');
          const reg = (v.reg || v.registration || '').toString().replace(/\s+/g,'');
          opt.value = reg;
          opt.textContent = v.reg || v.registration || reg;
          sel.appendChild(opt);
        });
      } catch {}
    }

    function showModal(poCode){
      byId('poCodeText').textContent = poCode;
      byId('modalBackdrop').style.display = 'flex';
    }
    function hideModal(){ byId('modalBackdrop').style.display = 'none'; }

    async function init(){
      const username = sessionStorage.getItem('mostlaneUser') || '';
      engineerName = username ? dotToSpace(username) : 'Unknown';
      byId('engineer').value = engineerName;
      byId('date').value = formatDateUK();

      try {
        const users = await fetchJSON(USERS_URL);
        const record = (users || []).find(u => (u.Username === username) || (u.username === username));
        const engNum = record?.EngineerNumber || record?.engineerNumber || '';
        const empType = (record?.EmploymentType || record?.employmentType || 'Employed').toLowerCase();
        const prefix = empType.includes('self') ? 'SE' : 'E';
        engineerCode = prefix + String(engNum || '').trim();
      } catch { engineerCode = 'E0'; }

      await populateSites();
      await populateSuppliers();
      await populateVehicles();

      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
          pos => {
            geo.lat = pos.coords.latitude;
            geo.lon = pos.coords.longitude;
            byId('geoStatus').textContent = `üìç Location captured: ${geo.lat.toFixed(5)}, ${geo.lon.toFixed(5)}`;
          },
          err => {
            const msgs = {
              1: '‚ö†Ô∏è Permission denied. Please allow location.',
              2: '‚ö†Ô∏è Position unavailable.',
              3: '‚ö†Ô∏è Request timed out.'
            };
            byId('geoStatus').textContent = msgs[err.code] || '‚ö†Ô∏è Unable to get location.';
          },
          { enableHighAccuracy: true, timeout: 15000, maximumAge: 0 }
        );
      } else {
        byId('geoStatus').textContent = '‚ùå Geolocation not supported.';
      }

      byId('copyBtn').addEventListener('click', () => navigator.clipboard.writeText(byId('poCodeText').textContent));
      byId('closeBtn').addEventListener('click', hideModal);
      byId('newBtn').addEventListener('click', () => {
        hideModal();
        byId('poForm').reset();
        byId('engineer').value = engineerName;
        byId('date').value = formatDateUK();
      });

      byId('personalBtn').addEventListener('click', () => {
        const eng = encodeURIComponent(byId('engineer').value || '');
        const date = encodeURIComponent(byId('date').value || '');
        window.open(`https://form.jotform.com/250527962516057?engineer=${eng}&date=${date}`, '_blank');
      });

      byId('poForm').addEventListener('submit', onSubmit);
    }

    async function onSubmit(e){
      e.preventDefault();
      const submitBtn = byId('submitBtn');
      submitBtn.disabled = true;

      const workType = byId('workType').value;
      const isVehicle = workType === 'Vehicle Maintenance';
      const engineerVal = byId('engineer').value.trim();
      const dateVal = byId('date').value.trim();
      const siteNumber = byId('site').value;
      const vehicleReg = byId('vehicleReg').value;
      const supplierNumber = byId('supplier').value;
      const supplierName = byId('supplier').selectedOptions[0]?.textContent || '';
      const descVal = byId('desc').value.trim();

      if (!engineerVal || !dateVal || !descVal || !supplierNumber) {
        alert('All required fields must be completed.');
        submitBtn.disabled = false; return;
      }
      if (geo.lat === null || geo.lon === null) {
        alert('Location is required. Please allow location access and try again.');
        submitBtn.disabled = false; return;
      }

      const typeLetter = (workType === 'Reactive') ? 'R' : (workType === 'Planned') ? 'P' : 'V';
      const siteSegment = isVehicle ? (vehicleReg || '').replace(/\s+/g,'') : siteNumber;
      const poCode = nextPO(engineerCode, supplierNumber, siteSegment, typeLetter);
      showModal(poCode);

      const payload = new URLSearchParams();
      payload.append('poNumber', poCode);
      payload.append('engineer', engineerVal);
      payload.append('engineerCode', engineerCode);
      payload.append('date', dateVal);
      payload.append('workType', workType);
      payload.append('supplierName', supplierName);
      payload.append('supplierNumber', supplierNumber);
      payload.append('description', descVal);
      payload.append('latitude', String(geo.lat));
      payload.append('longitude', String(geo.lon));

      try {
        await fetch(WEBHOOK_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
          body: payload.toString()
        });
        alert(`‚úÖ Purchase Order ${poCode} submitted successfully.`);
      } catch {
        alert('‚ö†Ô∏è Failed to submit to server. Your PO was generated locally.');
      } finally {
        submitBtn.disabled = false;
      }
    }

    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
