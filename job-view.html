<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Job Sheet</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
  body{
    margin:0;
    padding:0;
    font-family:Arial, Helvetica, sans-serif;
    background:#f3f4f6;
  }

  .page{
    width:210mm;
    min-height:297mm;
    margin:0 auto;
    background:#fff;
    padding:18mm;
    box-sizing:border-box;
  }

  h1{
    font-size:20px;
    margin:0 0 10px 0;
    color:#003b82;
  }

  .meta{
    display:grid;
    grid-template-columns:1fr 1fr;
    gap:8px 16px;
    font-size:13px;
    margin-bottom:14px;
  }

  .meta div span{
    font-weight:bold;
  }

  hr{
    border:none;
    border-top:1px solid #d1d5db;
    margin:14px 0;
  }

  h2{
    font-size:15px;
    margin:14px 0 6px;
    color:#003b82;
  }

  .box{
    border:1px solid #d1d5db;
    padding:8px;
    font-size:13px;
  }

  .timeline{
    font-size:12px;
  }

  .timeline div{
    margin-bottom:6px;
  }

  .photos{
    display:grid;
    grid-template-columns:repeat(2,1fr);
    gap:8px;
  }

  .photos img{
    width:100%;
    border:1px solid #d1d5db;
  }

  .signature{
    margin-top:10px;
  }

  .signature img{
    max-width:260px;
    border:1px solid #d1d5db;
  }

  .footer{
    margin-top:18px;
    font-size:11px;
    color:#6b7280;
    text-align:center;
  }

  @media print{
    body{ background:#fff; }
  }
</style>
</head>

<body>
<div class="page" id="page">
  <h1>Job Completion Sheet</h1>

  <div class="meta" id="meta"></div>

  <hr>

  <h2>Description</h2>
  <div class="box" id="description"></div>

  <h2>Activity Timeline</h2>
  <div class="box timeline" id="timeline"></div>

  <h2>Photos</h2>
  <div class="photos" id="photos"></div>

  <h2>Customer Sign-Off</h2>
  <div class="box">
    <p>
      I confirm that the works described above have been completed to my satisfaction.
    </p>
    <div class="signature" id="signature"></div>
  </div>

  <div class="footer">
    Mostlane Construction Ltd • Generated via Mostlane Portal
  </div>
</div>

<script>
const API = "https://mostlane-sla.jamie-def.workers.dev";
const params = new URLSearchParams(location.search);
const jobId = params.get("id");

async function loadJob(){
  const jobRes = await fetch(`${API}/jobs/${jobId}`);
  const job = await jobRes.json();

  const photosRes = await fetch(`${API}/jobs/${jobId}/files`);
  const photosJson = await photosRes.json();

  // META
  document.getElementById("meta").innerHTML = `
    <div><span>Reference:</span> ${job.helpdeskRef || job.id}</div>
    <div><span>Status:</span> ${job.status}</div>
    <div><span>Priority:</span> ${job.priority}</div>
    <div><span>Engineer:</span> ${job.assignedTo || "—"}</div>
    <div><span>SLA Target:</span> ${job.targetAt ? new Date(job.targetAt).toLocaleString() : "—"}</div>
    <div><span>Generated:</span> ${new Date().toLocaleString()}</div>
  `;

  document.getElementById("description").textContent =
    job.description || "—";

  // TIMELINE
  const timeline = [];
  (job.statusHistory || []).forEach(e => {
    timeline.push(`${new Date(e.at).toLocaleString()} — Status: ${e.status}`);
  });
  (job.events || []).forEach(e => {
    if(e.note){
      timeline.push(`${new Date(e.at).toLocaleString()} — Note: ${e.note}`);
    }
  });

  document.getElementById("timeline").innerHTML =
    timeline.length ? timeline.map(t => `<div>${t}</div>`).join("") : "No activity recorded.";

  // PHOTOS
  const photosDiv = document.getElementById("photos");
  (photosJson.files || []).forEach(p => {
    const img = document.createElement("img");
    img.src = p.publicURL;
    photosDiv.appendChild(img);
  });

  // SIGNATURE
  if(job.signature?.fileKey){
    const img = document.createElement("img");
    img.src = `https://pub-0a9aac7bfc6749bbbdbf9660503968e6.r2.dev/${job.signature.fileKey}`;
    document.getElementById("signature").appendChild(img);
    document.getElementById("signature").insertAdjacentHTML(
      "beforeend",
      `<div>Signed by ${job.signature.signedBy} on ${new Date(job.signature.signedAt).toLocaleString()}</div>`
    );
  } else {
    document.getElementById("signature").textContent = "No signature captured.";
  }

  await waitForImages();
  setTimeout(() => window.print(), 400);
}

function waitForImages(){
  const imgs = Array.from(document.images);
  return Promise.all(imgs.map(img =>
    img.complete ? Promise.resolve() : new Promise(res => img.onload = img.onerror = res)
  ));
}

loadJob();
</script>
</body>
</html>
