<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Job Sheet</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
:root{
  --ml-blue:#003b82;
  --ml-grey:#6b7280;
  --ok:#16a34a;
  --bad:#dc2626;
  --border:#e5e7eb;
}

*{box-sizing:border-box}

body{
  font-family: "Segoe UI", system-ui, Arial, sans-serif;
  margin:0;
  padding:24px;
  background:#fff;
  color:#111827;
}
.job-description{
  font-size:16px;
  line-height:1.65;
  font-weight:500;
  color:#020617;
  padding:10px 12px;
  background:#f8fafc;
  border-left:4px solid var(--ml-blue);
  border-radius:6px;
}

.header{
  display:flex;
  align-items:center;
  justify-content:space-between;
  border-bottom:2px solid var(--border);
  padding-bottom:12px;
  margin-bottom:18px;
}

.logo{height:34px}

.h-meta{
  text-align:right;
  font-size:12px;
  color:var(--ml-grey);
}

.section{margin-bottom:22px}

.section h2{
  margin:0 0 10px;
  font-size:15px;
  color:var(--ml-blue);
  border-bottom:1px solid var(--border);
  padding-bottom:4px;
}

.grid{
  display:grid;
  grid-template-columns:repeat(2,1fr);
  gap:8px 18px;
  font-size:13px;
}

.label{color:var(--ml-grey);font-size:12px}
.value{font-weight:600}

.sla-pill{
  display:inline-flex;
  align-items:center;
  padding:6px 10px;
  border-radius:999px;
  font-size:12px;
  font-weight:600;
}
.sla-pill.ok{background:#ecfdf5;color:#166534;border:1px solid #bbf7d0}
.sla-pill.bad{background:#fef2f2;color:#7f1d1d;border:1px solid #fecaca}

.photos{
  display:grid;
  grid-template-columns:repeat(auto-fill,minmax(120px,1fr));
  gap:8px;
}
.photo{
  aspect-ratio:4/3;
  overflow:hidden;
  border-radius:6px;
  border:1px solid var(--border);
}
.photo img{
  width:100%;
  height:100%;
  object-fit:cover;
}

.signature img{
  max-height:80px;
  border:1px solid var(--border);
}

.footer{
  margin-top:30px;
  font-size:11px;
  color:var(--ml-grey);
  text-align:center;
}
</style>
</head>
<body>

<div class="header">
  <img src="data:image/jpeg;base64,YOUR_LOGO_BASE64_HERE" class="logo">
  <div class="h-meta" id="headerMeta"></div>
</div>

<div class="section">
  <h2>Job Details</h2>
  <div class="grid" id="jobDetails"></div>
</div>

<div class="section">
  <h2>SLA</h2>
  <div id="slaBlock"></div>
</div>

<div class="section">
  <h2>Timeline</h2>
  <div id="timeline"></div>
</div>

<div class="section">
  <h2>Notes</h2>
  <div id="notes"></div>
</div>

<div class="section">
  <h2>Photos</h2>
  <div class="photos" id="photos"></div>
</div>

<div class="section">
  <h2>Customer Sign-Off</h2>
  <div class="signature" id="signature"></div>
</div>

<div class="footer">Generated by Mostlane Portal</div>

<script>
const API = "https://mostlane-sla.jamie-def.workers.dev";
const jobId = new URLSearchParams(location.search).get("id");

function cleanName(n){ return (n||"").replace(/\./g," "); }

/* ðŸ”’ CRITICAL FIX â€” INLINE ALL IMAGES */
async function inlineImages(){
  const imgs = [...document.querySelectorAll("img")];
  await Promise.all(imgs.map(async img=>{
    if(!img.src.startsWith("http")) return;
    const res = await fetch(img.src);
    const blob = await res.blob();
    const reader = new FileReader();
    await new Promise(r=>{
      reader.onload = () => { img.src = reader.result; r(); };
      reader.readAsDataURL(blob);
    });
  }));
}

async function load(){
  const job = await fetch(`${API}/jobs/${jobId}`).then(r=>r.json());
  const files = await fetch(`${API}/jobs/${jobId}/files`).then(r=>r.json());

  document.getElementById("headerMeta").innerHTML =
    `Ref: <strong>${job.helpdeskRef}</strong><br>${new Date().toLocaleString()}`;

  document.getElementById("jobDetails").innerHTML = `
    <div><span class="label">Site</span><div class="value">${job.site||job.siteCode||"-"}</div></div>
    <div><span class="label">Engineer</span><div class="value">${cleanName(job.assignedTo)}</div></div>
    <div><span class="label">Priority</span><div class="value">${job.priority}</div></div>
    <div><span class="label">Status</span><div class="value">${job.status}</div></div>
  `;

  document.getElementById("slaBlock").innerHTML =
    `<div class="sla-pill ${job.sla.state==="BREACHED"?"bad":"ok"}">
      ${job.sla.state==="BREACHED"?"SLA Not Achieved":"SLA Achieved"}
    </div>`;

  document.getElementById("timeline").innerHTML =
    (job.statusHistory||[]).map(e=>`<div>${e.status} â€” ${cleanName(e.by)}</div>`).join("");

  document.getElementById("notes").innerHTML =
    (job.events||[]).filter(e=>e.type==="note").map(n=>`<div>${n.note}</div>`).join("") || "<em>No notes</em>";

  document.getElementById("photos").innerHTML =
    (files.files||[]).map(f=>`<div class="photo"><img src="${f.publicURL}"></div>`).join("");

  if(job.signature){
    document.getElementById("signature").innerHTML =
      `<img src="https://pub-0a9aac7bfc6749bbbdbf9660503968e6.r2.dev/${job.signature.fileKey}">`;
  }

  /* ðŸ”¥ THIS LINE FIXES SAFARI */
  await inlineImages();

  const blob = new Blob([document.documentElement.outerHTML], {type:"text/html"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = `Job-${job.helpdeskRef}.html`;
  a.click();
}

load();
</script>
</body>
</html>
