<!DOCTYPE html>
<html lang="en">
<head>
  <script src="auth.js"></script>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Asset Administration</title>

  <style>
    body{
      margin:0;padding:0;
      background:#e6e8eb url('Mostlane_Embossed.png') no-repeat center center fixed;
      background-size:180%;
      font-family:Arial,sans-serif;
    }
    .content{
      background:rgba(255,255,255,0.6);
      margin:40px auto;padding:20px;
      border-radius:12px;max-width:1200px;
    }
    h1{
      background:rgba(0,74,153,0.6);
      color:white;text-align:center;
      padding:12px;border-radius:12px 12px 0 0;
    }
    .button{
      display:inline-block;padding:8px 16px;
      font-size:14px;border-radius:6px;
      background:rgba(0,74,153,0.6);
      color:white;text-decoration:none;
      margin:5px 5px 15px 0;cursor:pointer;
      border:none;
    }
 table{
  width:100%;border-collapse:collapse;
  background:white;font-size:14px;
}
th, td {
  border:1px solid #ccc;
  padding:8px;
  text-align:center; 
  vertical-align:middle;
}
th{background:#f3f4f6;}
.actions button{
  margin-right:5px;padding:4px 8px;font-size:12px;
}

    /* Modal */
    .modal{
      display:none;position:fixed;z-index:999;
      left:0;top:0;width:100%;height:100%;
      background:rgba(0,0,0,0.7);
      justify-content:center;align-items:center;
    }
    .modal-content{
      background:white;padding:20px;border-radius:8px;
      width:90%;max-width:500px;position:relative;
    }
    .modal-content input,
    .modal-content select{
      width:100%;margin:6px 0;padding:8px;
      border:1px solid #ccc;border-radius:4px;
    }
    .modal-content label{
      font-size:13px;
      font-weight:bold;
      margin-top:8px;
      display:block;
    }
    .close-btn{
      position:absolute;top:10px;right:12px;
      font-size:20px;font-weight:bold;
      cursor:pointer;color:#333;
    }
    .disabled{
      opacity:0.4;pointer-events:none;
    }
  </style>

  <script>
    async function checkAccess(){
      const user=sessionStorage.getItem("mostlaneUser");
      const res=await fetch("role-type.txt");
      const text=await res.text();
      const roleLine=text.split("\n").find(l=>l.toLowerCase().includes(user.toLowerCase()));
      if(!roleLine||!roleLine.toLowerCase().includes("office")){
        alert("Access denied. Office users only.");
        window.location.href="main.html";
      }
    }
    checkAccess();
  </script>
</head>

<body>
  <div class="content">
    <a class="button" href="main.html">Main Menu</a>
    <button class="button" onclick="openAddModal()">Add Asset</button>
    <h1>Asset Administration</h1>

    <table id="assetTable">
      <thead>
        <tr>
          <th>ID</th><th>Name</th><th>Category</th><th>Serial</th>
          <th>Value</th><th>Assigned To</th><th>Shared</th><th>Actions</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <!-- MODAL -->
  <div id="assetModal" class="modal">
    <div class="modal-content">
      <span class="close-btn" onclick="closeModal()">×</span>

      <h3 id="modalTitle">Add/Edit Asset</h3>

      <label>Asset ID</label>
      <input id="idField" placeholder="Asset ID">

      <label>Name</label>
      <input id="nameField" placeholder="Name">

      <label>Category</label>
      <input id="categoryField" placeholder="Category">

      <label>Serial</label>
      <input id="serialField" placeholder="Serial">

      <label>Value (£)</label>
      <input id="valueField" placeholder="Value (£)">

      <label>Assigned To</label>
      <select id="assignedField">
        <option value="">-- Select User --</option>
      </select>

      <label>Shared (yes/no)</label>
      <input id="sharedField" placeholder="yes/no">

      <label>Transfer Date</label>
<input id="calibrationField" readonly>

      <div style="text-align:right;margin-top:10px;">
        <button id="saveBtn" class="button" onclick="saveAsset()">Save</button>
        <button class="button" onclick="closeModal()">Cancel</button>
      </div>
    </div>
  </div>

<script>
  const apiBase="https://mostlane-assets.jamie-def.workers.dev";
  let currentEditId=null;
  let portalUsers=[];

  /* ------------
     LOAD USERS
  ------------ */
  async function loadPortalUsers(){
    const res = await fetch("https://mostlane-users.jamie-def.workers.dev/users");
    const raw = await res.text();

    let data;
    try { data = JSON.parse(raw); }
    catch { data = { Users: [] }; }

    portalUsers = (data.Users || [])
      .filter(u =>
        u.Username &&
        u.Username.trim() !== "" &&
        u.FirstName &&
        u.LastName &&
        u.Status !== "Not Active"
      )
      .sort((a,b)=>
        (a.FirstName + " " + a.LastName).localeCompare(b.FirstName + " " + b.LastName)
      );
  }

  /* ------------------------
     POPULATE SELECT DROPDOWN
  --------------------------*/
  function populateUserDropdown(selected=""){
    const sel=document.getElementById("assignedField");
    sel.innerHTML = `<option value="">-- Select User --</option>`;

    portalUsers.forEach(u=>{
      const opt=document.createElement("option");
      opt.value=u.Username;
      opt.textContent = u.FirstName + " " + u.LastName;
      if(u.Username === selected) opt.selected = true;
      sel.appendChild(opt);
    });

    const sharedOpt=document.createElement("option");
    sharedOpt.value="Shared";
    sharedOpt.textContent="Shared";
    if(selected==="Shared") sharedOpt.selected=true;
    sel.appendChild(sharedOpt);
  }

  function validateSaveButton(){
    const saveBtn=document.getElementById("saveBtn");
    const assigned=document.getElementById("assignedField").value;

    if(assigned === ""){
      saveBtn.classList.add("disabled");
    } else {
      saveBtn.classList.remove("disabled");
    }
  }

  /* ------------
     ADD MODAL
  ------------ */
  function openAddModal(){
    currentEditId=null;
    document.getElementById("modalTitle").textContent="Add Asset";

    document.querySelectorAll("#assetModal input").forEach(i=>i.value="");

    populateUserDropdown("");
    validateSaveButton();

    document.getElementById("calibrationField").value =
      new Date().toISOString().slice(0,10);

    document.getElementById("assignedField").onchange = validateSaveButton;

    document.getElementById("assetModal").style.display="flex";
  }

  /* ------------
     EDIT MODAL
  ------------ */
  function openEditModal(asset){
    currentEditId=asset.id;
    document.getElementById("modalTitle").textContent="Edit Asset";

    document.getElementById("idField").value=asset.id;
    document.getElementById("nameField").value=asset.name;
    document.getElementById("categoryField").value=asset.category;
    document.getElementById("serialField").value=asset.serial;
    document.getElementById("valueField").value=asset.value;

    populateUserDropdown(asset.assignedTo);
    validateSaveButton();

    document.getElementById("assignedField").onchange = validateSaveButton;

    document.getElementById("sharedField").value=asset.shared;
    document.getElementById("calibrationField").value =
      new Date().toISOString().slice(0,10);

    document.getElementById("assetModal").style.display="flex";
  }

  function closeModal(){
    document.getElementById("assetModal").style.display="none";
  }

  /* ------------
     LOAD ASSETS
  ------------ */
  async function loadAssets(){
    await loadPortalUsers();

    const res=await fetch(`${apiBase}/assets`);
    const data=await res.json();

    const tbody=document.querySelector("#assetTable tbody");
    tbody.innerHTML="";

    data.assets.forEach(a=>{
      const tr=document.createElement("tr");
      tr.innerHTML=`
        <td>${a.id}</td>
        <td>${a.name}</td>
        <td>${a.category}</td>
        <td>${a.serial}</td>
        <td>${a.value}</td>
        <td>${a.assignedTo}</td>
        <td>${a.shared}</td>
        <td class="actions">
          <button onclick='openEditModal(${JSON.stringify(a)})'>Edit</button>
          <button onclick='deleteAsset("${a.id}")'>Delete</button>
        </td>`;
      tbody.appendChild(tr);
    });
  }

  /* ------------
     SAVE
  ------------ */
  async function saveAsset(){
    const assigned=document.getElementById("assignedField").value;
    if(assigned===""){
      alert("Please select a user before saving.");return;
    }

    const id=document.getElementById("idField").value.trim();

    const body={
      id,
      name:document.getElementById("nameField").value.trim(),
      category:document.getElementById("categoryField").value.trim(),
      serial:document.getElementById("serialField").value.trim(),
      value:document.getElementById("valueField").value.trim(),
      assignedTo:assigned,
      shared:document.getElementById("sharedField").value.trim(),
      calibrationDate:document.getElementById("calibrationField").value.trim()
    };

    const route=currentEditId?"/asset/update":"/asset/add";

    const res=await fetch(`${apiBase}${route}`,{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify(body)
    });

    const r=await res.json();
    alert(r.message||r.error);

    closeModal();loadAssets();
  }

  /* ------------
     DELETE
  ------------ */
  async function deleteAsset(id){
    if(!confirm(`Delete asset ${id}?`))return;

    const res=await fetch(`${apiBase}/asset/delete?id=${id}`,{
      method:"DELETE"
    });

    const r=await res.json();
    alert(r.message||r.error);

    loadAssets();
  }

  loadAssets();
</script>

</body>
</html>
