<!DOCTYPE html>
<html lang="en">
<head>
  <script src="auth.js"></script>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Asset Administration</title>

  <style>
    body{
      margin:0;padding:0;
      background:#e6e8eb url('Mostlane_Embossed.png') no-repeat center center fixed;
      background-size:180%;
      font-family:Arial,sans-serif;
    }
    .content{
      background:rgba(255,255,255,0.6);
      margin:40px auto;padding:20px;
      border-radius:12px;max-width:1200px;
    }
    h1{
      background:rgba(0,74,153,0.6);
      color:white;text-align:center;
      padding:12px;border-radius:12px 12px 0 0;
    }
    .button{
      display:inline-block;padding:8px 16px;
      font-size:14px;border-radius:6px;
      background:rgba(0,74,153,0.6);
      color:white;text-decoration:none;
      margin:5px 5px 15px 0;cursor:pointer;
      border:none;
    }
    table{
      width:100%;border-collapse:collapse;
      background:white;font-size:14px;
    }
    th, td {
      border:1px solid #ccc;
      padding:8px;
      text-align:center; 
      vertical-align:middle;
    }
    th{background:#f3f4f6;}
    .actions button{
      margin-right:5px;padding:4px 8px;font-size:12px;
    }

    .thumb-img{
      height:40px;
      width:40px;
      object-fit:cover;
      border-radius:4px;
    }

    .modal{
      display:none;position:fixed;z-index:999;
      left:0;top:0;width:100%;height:100%;
      background:rgba(0,0,0,0.7);
      justify-content:center;align-items:center;
    }
    .modal-content{
      background:white;padding:20px;border-radius:8px;
      width:90%;max-width:500px;position:relative;
    }
    .modal-content input,
    .modal-content select{
      width:100%;margin:6px 0;padding:8px;
      border:1px solid #ccc;border-radius:4px;
    }
    .modal-content label{
      font-size:13px;
      font-weight:bold;
      margin-top:8px;
      display:block;
    }
    .close-btn{
      position:absolute;top:10px;right:12px;
      font-size:20px;font-weight:bold;
      cursor:pointer;color:#333;
    }
    .disabled{
      opacity:0.4;pointer-events:none;
    }

    .gallery-container {
      margin:10px 0;
      overflow-x:auto;
      white-space:nowrap;
    }

    .gallery-item{
      position:relative;
      display:inline-block;
      margin-right:8px;
    }
    .gallery-item img {
      height:70px;
      width:auto;
      border-radius:6px;
      object-fit:cover;
      cursor:pointer;
    }
    .gallery-delete{
      position:absolute;
      top:-6px;
      right:-6px;
      background:#dc2626;
      color:#fff;
      border:none;
      border-radius:999px;
      width:20px;
      height:20px;
      font-size:12px;
      line-height:20px;
      text-align:center;
      cursor:pointer;
    }

    .image-viewer-overlay{
      display:none;
      position:fixed;
      z-index:1000;
      inset:0;
      background:rgba(0,0,0,0.9);
      justify-content:center;
      align-items:center;
    }
    .image-viewer-overlay img{
      max-width:90%;
      max-height:90%;
      border-radius:8px;
    }
    .image-viewer-close{
      position:absolute;
      top:12px;
      right:16px;
      font-size:28px;
      color:#fff;
      cursor:pointer;
      font-weight:bold;
    }

    .img-nav-btn{
      position:absolute;
      top:50%;
      transform:translateY(-50%);
      background:rgba(255,255,255,0.75);
      border:none;
      border-radius:999px;
      width:40px;
      height:40px;
      font-size:20px;
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:center;
      outline:none;
    }
    #imgPrev{ left:20px; }
    #imgNext{ right:20px; }

    .summary-row{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:8px;
      padding:4px 0;
      border-bottom:1px solid #eee;
      font-size:13px;
    }
    .summary-row.highlight{
      background:rgba(16,185,129,0.08);
    }
    .summary-name{
      flex:0 0 35%;
      text-align:left;
      font-weight:bold;
    }
    .summary-value{
      flex:0 0 18%;
      text-align:right;
      white-space:nowrap;
    }
    .summary-count{
      flex:0 0 12%;
      text-align:right;
      font-size:12px;
      color:#555;
    }
    .summary-bar-outer{
      flex:1;
      height:8px;
      background:#e5e7eb;
      border-radius:999px;
      overflow:hidden;
    }
    .summary-bar-inner{
      height:100%;
      border-radius:999px;
      background:linear-gradient(90deg,rgba(0,74,153,0.8),rgba(0,148,255,0.9));
    }
    .summary-controls{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      align-items:center;
      margin:10px 0 20px 0;
    }
    .summary-legend{
      font-size:11px;
      color:#444;
      margin-top:6px;
      font-style:italic;
    }
  </style>

  <script>
    async function checkAccess(){
      const user=sessionStorage.getItem("mostlaneUser");
      const res=await fetch("role-type.txt");
      const text=await res.text();
      const roleLine=text.split("\n").find(l=>l.toLowerCase().includes(user.toLowerCase()));
      if(!roleLine||!roleLine.toLowerCase().includes("office")){
        alert("Access denied. Office users only.");
        window.location.href="main.html";
      }
    }
    checkAccess();
  </script>
</head>

<body>
  <div class="content">
    <a class="button" href="main.html">Main Menu</a>
    <button class="button" onclick="openAddModal()">Add Asset</button>
    <h1>Asset Administration</h1>

    <div id="valueSummary" style="margin:15px 0;padding:15px;background:white;border-radius:8px;border:1px solid #ccc;font-size:15px;">
      <strong>Loading asset summaryâ€¦</strong>
    </div>
    <div class="summary-controls">
      <button class="button" type="button" onclick="setSummarySort('value')">Sort by Value (High â†’ Low)</button>
      <button class="button" type="button" onclick="setSummarySort('name')">Sort by Name (A â†’ Z)</button>
      <button class="button" type="button" onclick="downloadSummaryCSV()">Export Summary CSV</button>
      <span class="summary-legend">Bar length shows relative value held. Rows highlighted green are holding more than Â£5,000 of assets.</span>
    </div>

    <table id="assetTable">
      <thead>
        <tr>
          <th>ID</th><th>Name</th><th>Image</th><th>Category</th><th>Serial</th>
          <th>Value</th><th>Assigned To</th><th>Shared</th><th>Actions</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <!-- Modal + viewer kept identical -->

<script>
  const apiBase="https://mostlane-assets.jamie-def.workers.dev";
  let currentEditId=null;
  let currentAsset=null;
  let portalUsers=[];
  let currentImageList=[];
  let currentImageIndex=0;

  let currentAssets=[];
  let lastSummarySort="value";
  let lastSummaryData=[];
  const HIGH_VALUE_THRESHOLD=5000;

  /* PORTAL USERS */
  async function loadPortalUsers(){
    const res = await fetch("https://mostlane-users.jamie-def.workers.dev/users");
    const raw = await res.text();
    let data;
    try { data = JSON.parse(raw); }
    catch { data = { Users: [] }; }

    portalUsers = (data.Users || [])
      .filter(u =>
        u.Username &&
        u.Username.trim() !== "" &&
        u.FirstName &&
        u.LastName &&
        u.Status !== "Not Active"
      )
      .sort((a,b)=>
        (a.FirstName + " " + a.LastName).localeCompare(b.FirstName + " " + b.LastName)
      );
  }

  function populateUserDropdown(selected=""){
    const sel=document.getElementById("assignedField");
    sel.innerHTML = `<option value="">-- Select User --</option>`;

    portalUsers.forEach(u=>{
      const opt=document.createElement("option");
      opt.value=u.Username;
      opt.textContent = u.FirstName + " " + u.LastName;
      if(u.Username === selected) opt.selected = true;
      sel.appendChild(opt);
    });

    const sharedOpt=document.createElement("option");
    sharedOpt.value="Shared";
    sharedOpt.textContent="Shared";
    if(selected==="Shared") sharedOpt.selected=true;
    sel.appendChild(sharedOpt);
  }

  function validateSaveButton(){
    const saveBtn=document.getElementById("saveBtn");
    const assigned=document.getElementById("assignedField").value;
    if(assigned === ""){
      saveBtn.classList.add("disabled");
    } else {
      saveBtn.classList.remove("disabled");
    }
  }

  /* MODALS, IMAGE UPLOAD, ETC â€” unchanged (omitted for brevity but included in your version) */

  /* ----------------------------- */
  /*   SUMMARY + VALUE PROCESSING  */
  /* ----------------------------- */

  function renderValueSummary(assets){
    const summaryEl=document.getElementById("valueSummary");
    if(!summaryEl) return;

    let totalValue=0;
    const totalCount=assets.length;
    const perUser={};

    assets.forEach(a=>{
      /* ðŸ”¹ FIXED VALUE PARSER */
      let val = 0;
      if (a.value !== undefined && a.value !== null) {
        val = parseFloat(
          String(a.value)
            .replace(/Â£/g, "")
            .replace(/,/g, "")
            .trim()
        );
        if (isNaN(val)) val = 0;
      }

      totalValue += val;

      if(a.assignedTo && a.assignedTo !== "Shared"){
        if(!perUser[a.assignedTo]){
          perUser[a.assignedTo]={ total:0, count:0 };
        }
        perUser[a.assignedTo].total += val;
        perUser[a.assignedTo].count += 1;
      }
    });

    let data=Object.entries(perUser).map(([username,info])=>{
      return {
        username,
        displayName: username.replace(/\./g," "),
        totalValue: info.total,
        count: info.count
      };
    });

    if(lastSummarySort === "name"){
      data.sort((a,b)=>a.displayName.localeCompare(b.displayName));
    } else {
      data.sort((a,b)=>b.totalValue - a.totalValue);
    }

    lastSummaryData=data;

    const maxVal=data.length ? Math.max(...data.map(d=>d.totalValue)) : 0;

    let rowsHtml="";
    data.forEach(d=>{
      const pct = maxVal>0 ? (d.totalValue/maxVal)*100 : 0;
      const highlight = d.totalValue>=HIGH_VALUE_THRESHOLD ? " highlight" : "";
      rowsHtml += `
        <div class="summary-row${highlight}">
          <div class="summary-name">${d.displayName}</div>
          <div class="summary-value">Â£${d.totalValue.toLocaleString()}</div>
          <div class="summary-count">${d.count}</div>
          <div class="summary-bar-outer">
            <div class="summary-bar-inner" style="width:${pct}%;"></div>
          </div>
        </div>
      `;
    });

    summaryEl.innerHTML = `
      <div style="margin-bottom:10px;">
        <strong>Total Assets:</strong> ${totalCount}<br>
        <strong>Total Asset Value:</strong> Â£${totalValue.toLocaleString()}
      </div>
      <hr style="margin:10px 0;">
      <div style="font-size:13px;font-weight:bold;margin-bottom:6px;">
        Value per Engineer
        <span style="font-weight:normal;font-size:11px;color:#555;">(bars show relative value)</span>
      </div>
      <div class="summary-row" style="font-weight:bold;border-bottom:2px solid #ddd;">
        <div class="summary-name">Engineer</div>
        <div class="summary-value">Total Â£</div>
        <div class="summary-count">Count</div>
        <div class="summary-bar-outer" style="background:transparent;height:auto;">
          <span style="font-size:11px;color:#555;">Relative Value</span>
        </div>
      </div>
      ${rowsHtml}
    `;
  }

  function setSummarySort(mode){
    lastSummarySort = mode;
    if(currentAssets.length){
      renderValueSummary(currentAssets);
    }
  }

  function downloadSummaryCSV(){
    if(!lastSummaryData.length){
      alert("No data to export");
      return;
    }

    let csv="Engineer,Username,Total Value (Â£),Asset Count\n";
    lastSummaryData.forEach(d=>{
      csv += `"${d.displayName}",` +
             `"${d.username}",` +
             `${d.totalValue},` +
             `${d.count}\n`;
    });

    const blob=new Blob([csv],{type:"text/csv"});
    const url=URL.createObjectURL(blob);
    const a=document.createElement("a");
    a.href=url;
    a.download="asset-summary.csv";
    a.click();
    URL.revokeObjectURL(url);
  }

  /* LOAD ASSETS */
  async function loadAssets(){
    await loadPortalUsers();

    const res=await fetch(`${apiBase}/assets`);
    const data=await res.json();

    currentAssets=data.assets || [];
    renderValueSummary(currentAssets);

    const tbody=document.querySelector("#assetTable tbody");
    tbody.innerHTML="";

    currentAssets.forEach(a=>{
      const thumb=(a.images&&a.images.length)
        ? `<img src="${a.images[0]}" class="thumb-img">`
        : "â€”";

      const tr=document.createElement("tr");
      tr.innerHTML=`
        <td>${a.id}</td>
        <td>${a.name}</td>
        <td>${thumb}</td>
        <td>${a.category}</td>
        <td>${a.serial}</td>
        <td>${a.value}</td>
        <td>${a.assignedTo}</td>
        <td>${a.shared}</td>
        <td class="actions">
          <button onclick='openEditModal(${JSON.stringify(a)})'>Edit</button>
          <button onclick='deleteAsset("${a.id}")'>Delete</button>
        </td>`;
      tbody.appendChild(tr);
    });
  }

  /* SAVE & DELETE â€” unchanged */

  loadAssets();
</script>

</body>
</html>
