<!DOCTYPE html>
<html lang="en">
<head>
  <script src="auth.js"></script>
  <meta charset="UTF-8" />
  <title>Holiday Admin – Mostlane</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>

  <style>
    :root{
      --ml-blue:#003366;
      --ml-accent:#1a73e8;
      --ml-bg:#e6e8eb;
      --ink:#0f172a;
      --muted:#64748b;
      --card:rgba(255,255,255,0.9);
      --border:#e5e7eb;
      --good:#15803d;
      --warn:#b45309;
      --bad:#b00020;

      --cell:28px;
      --nameCol:220px;
      --dayCol:28px;
    }

    html,body{width:100%;max-width:100%;overflow-x:hidden;}
    body{
      margin:0;
      padding:22px;
      font-family:"Segoe UI",system-ui,Roboto,Arial,sans-serif;
      background:var(--ml-bg) url('Mostlane_Embossed.png') no-repeat center center fixed;
      background-size:180% auto;
      color:var(--ink);
    }

    .shell{
      max-width:1400px;
      margin:0 auto;
      background:rgba(255,255,255,0.92);
      border-radius:14px;
      box-shadow:0 12px 28px rgba(0,0,0,0.12);
      overflow:hidden;
      border:1px solid rgba(0,0,0,0.06);
    }

    header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
      padding:16px 18px;
      border-bottom:1px solid var(--border);
      background:linear-gradient(90deg,#fff,#f7f9fc);
    }
    header h1{margin:0;font-size:20px;color:var(--ml-blue);}
    .btn{
      border:1px solid rgba(0,0,0,0.08);
      background:#eef2f9;
      color:#0f172a;
      padding:10px 12px;
      border-radius:10px;
      cursor:pointer;
      font-weight:700;
      font-size:14px;
    }
    .btnPrimary{
      background:rgba(0,74,153,0.85);
      color:#fff;
      border:none;
    }
    .btnSmall{padding:6px 10px;font-size:12px;border-radius:8px;font-weight:700}
    .btnDanger{background:rgba(176,0,32,0.9);color:#fff;border:none}
    .btnOk{background:rgba(21,128,61,0.9);color:#fff;border:none}
    .btn:hover{filter:brightness(0.98)}

    .content{padding:18px;}
    .row{display:flex;gap:14px;flex-wrap:wrap;align-items:flex-start}
    .panel{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:14px;
      padding:14px;
      box-shadow:0 6px 18px rgba(0,0,0,0.06);
    }

    .panel h2{
      margin:0 0 10px 0;
      font-size:16px;
      color:var(--ml-blue);
    }

    .controls{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
    }
    select,input{
      height:40px;
      padding:8px 12px;
      border-radius:10px;
      border:1px solid #cbd5e1;
      background:#fff;
      font-size:14px;
    }
    .pill{
      display:inline-flex;align-items:center;gap:8px;
      padding:8px 12px;border-radius:999px;
      background:#f8fbff;border:1px solid var(--border);
      font-weight:700;color:#0f172a;
    }
    .muted{color:var(--muted)}

    table{
      width:100%;
      border-collapse:separate;
      border-spacing:0;
      overflow:hidden;
      border:1px solid var(--border);
      border-radius:12px;
      background:#fff;
    }
    th,td{
      padding:10px 10px;
      border-bottom:1px solid #eef2f7;
      font-size:13px;
      text-align:left;
      vertical-align:middle;
    }
    thead th{background:#f7f9fc;color:#0f172a;font-weight:800}
    .tag{display:inline-block;padding:3px 8px;border-radius:999px;font-size:12px;font-weight:800;border:1px solid rgba(0,0,0,0.08)}
    .tagPending{color:var(--warn);background:rgba(180,83,9,0.1)}
    .tagApproved{color:var(--good);background:rgba(21,128,61,0.1)}
    .tagRejected{color:var(--bad);background:rgba(176,0,32,0.08)}

    .calWrap{
      overflow:auto;
      border:1px solid var(--border);
      border-radius:14px;
      background:#fff;
    }

    .calHeader, .calRow{
      display:grid;
      grid-template-columns: var(--nameCol) repeat(31, var(--dayCol));
      min-width: calc(var(--nameCol) + 31 * var(--dayCol));
      border-bottom:1px solid #eef2f7;
    }

    .calHeader{
      position:sticky;
      top:0;
      z-index:5;
      background:#f7f9fc;
    }

    .nameCell{
      padding:8px 10px;
      font-weight:800;
      color:#0f172a;
      border-right:1px solid #eef2f7;
      display:flex;
      align-items:center;
      gap:8px;
      background:inherit;
      position:sticky;
      left:0;
      z-index:6;
    }
    .dayCell{
      width:var(--dayCol);
      height:var(--cell);
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:12px;
      color:#334155;
      border-right:1px solid #f1f5f9;
    }
    .calRow .dayCell{background:#fff}
    .dayCell.weekend{background:#f8fafc;color:#94a3b8}

    .evHoliday{background:rgba(0,74,153,0.20)}
    .evSick{background:rgba(180,83,9,0.18)}
    .evUnpaid{background:rgba(176,0,32,0.15)}
    .evCompulsory{background:rgba(15,23,42,0.10)}
    .evBank{background:rgba(26,115,232,0.18)}
    .evShutdown{background:rgba(0,0,0,0.10)}
    .evWorked{outline:2px solid rgba(21,128,61,0.55); outline-offset:-2px}

    .tooltip{
      position:fixed;
      z-index:9999;
      background:rgba(15,23,42,0.95);
      color:#fff;
      padding:10px 12px;
      border-radius:10px;
      font-size:12px;
      max-width:260px;
      pointer-events:none;
      transform:translate(10px,10px);
      display:none;
    }

    .split{display:flex;gap:14px;flex-wrap:wrap}
    .col{flex:1;min-width:320px}
    .listRow{display:flex;gap:8px;align-items:center;margin:8px 0}
    .listRow input{flex:1}
    .listRow .btnSmall{flex:0}

    @media(max-width:900px){
      body{padding:14px}
      :root{ --nameCol:200px; --dayCol:26px; }
    }
  </style>
</head>

<body>
  <div class="shell">
    <header>
      <h1>Holiday Admin</h1>

      <div class="controls">
        <button class="btn" onclick="location.href='main.html'">Main Menu</button>

        <button id="prevMonth" class="btn">◀</button>
        <div class="pill"><span id="monthLabel">—</span></div>
        <button id="nextMonth" class="btn">▶</button>

        <select id="yearSel"></select>

        <button id="refreshBtn" class="btn btnPrimary">Refresh</button>
      </div>
    </header>

    <div class="content">
      <div class="row">
        <div class="panel" style="flex:1;min-width:420px;">
          <h2>Pending Approvals</h2>
          <div class="muted" id="pendingHint" style="margin-bottom:8px;">—</div>
          <div style="overflow:auto;">
            <table>
              <thead>
                <tr>
                  <th>Engineer</th>
                  <th>Dates</th>
                  <th>Days</th>
                  <th>Type</th>
                  <th>Note</th>
                  <th style="width:170px;">Actions</th>
                </tr>
              </thead>
              <tbody id="pendingTbody"></tbody>
            </table>
          </div>
        </div>

        <div class="panel" style="flex:0.9;min-width:380px;">
          <h2>Allowance Overview</h2>
          <div class="muted" id="allowanceHint" style="margin-bottom:8px;">Year totals (includes bank holidays + shutdown; credited back if worked).</div>
          <div style="overflow:auto;max-height:420px;">
            <table>
              <thead>
                <tr>
                  <th>Engineer</th>
                  <th>Allowance</th>
                  <th>Used</th>
                  <th>Remaining</th>
                  <th style="width:120px;">Edit</th>
                </tr>
              </thead>
              <tbody id="allowTbody"></tbody>
            </table>
          </div>
        </div>
      </div>

      <div class="row" style="margin-top:14px;">
        <div class="panel" style="flex:1;min-width:600px;">
          <h2>Month View</h2>
          <div class="muted" id="calHint" style="margin-bottom:10px;">Approved leave shown in blue. Bank holidays and shutdown shown; holiday requests override system days visually.</div>

          <div class="calWrap" id="calWrap"></div>
        </div>
      </div>

      <div class="row" style="margin-top:14px;">
        <div class="panel" style="flex:1;min-width:600px;">
          <h2>Bank Holidays & Company Shutdown</h2>
          <div class="split">
            <div class="col">
              <div class="muted" style="margin-bottom:6px;">Bank Holidays (manage from here)</div>
              <div class="listRow">
                <input type="date" id="bhDate">
                <input type="text" id="bhLabel" placeholder="Label (e.g. Christmas Day)">
                <button class="btn btnSmall btnPrimary" id="addBH">Add</button>
              </div>
              <div id="bhList"></div>
            </div>

            <div class="col">
              <div class="muted" style="margin-bottom:6px;">Company Shutdown</div>
              <div class="listRow">
                <input type="date" id="sdDate">
                <input type="text" id="sdLabel" placeholder="Label (e.g. Christmas Shutdown)">
                <button class="btn btnSmall btnPrimary" id="addSD">Add</button>
              </div>
              <div id="sdList"></div>
            </div>
          </div>
          <div class="muted" style="margin-top:10px;">
            Tip: mark a system day as "worked" from the month grid by clicking the day cell (bank holiday/shutdown only).
          </div>
        </div>
      </div>

      <div id="status" class="muted" style="margin-top:12px;"></div>
    </div>
  </div>

  <div class="tooltip" id="tooltip"></div>

<script>
const API = "https://mostlane-holidays.jamie-def.workers.dev";
const user = sessionStorage.getItem("mostlaneUser");

const HOLIDAY_ADMINS = [
  "Jamie.Line",
  "Joe.Line",
  "Greg.Line",
  "Megan.Line"
];

if (!user) {
  alert("Session expired. Please log in again.");
  location.href = "login.html";
}

if (!HOLIDAY_ADMINS.includes(user)) {
  alert("You are not authorised to access Holiday Admin.");
  location.href = "main.html";
}

const $ = (id)=>document.getElementById(id);

let state = {
  year: new Date().getFullYear(),
  month: new Date().getMonth() + 1,
  config: { bankholidays: [], shutdown: [], defaultAllowance: 28, allowances:{} },
  allRequests: [],
  summary: null,
  calendar: null
};

const monthNames = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];

function fmtMonthLabel(){
  $("monthLabel").textContent = `${monthNames[state.month-1]} ${state.year}`;
}

function setStatus(msg){ $("status").textContent = msg || ""; }

async function apiGET(path){
  const role = HOLIDAY_ADMINS.includes(user) ? "Admin" : "Engineer";
  const res = await fetch(`${API}${path}`, {
    headers: { "X-User": user, "X-Role": role },
    cache: "no-store"
  });
  if (!res.ok) throw new Error(await res.text());
  return res.json();
}

async function apiPOST(path, body){
  const role = HOLIDAY_ADMINS.includes(user) ? "Admin" : "Engineer";
  const res = await fetch(`${API}${path}`, {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      "X-User": user,
      "X-Role": role
    },
    body: JSON.stringify(body)
  });
  if (!res.ok) throw new Error(await res.text());
  return res.json();
}

function buildYearOptions(){
  const sel = $("yearSel");
  sel.innerHTML = "";
  const now = new Date().getFullYear();
  for (let y = now - 1; y <= now + 2; y++){
    const opt = document.createElement("option");
    opt.value = y;
    opt.textContent = y;
    if (y === state.year) opt.selected = true;
    sel.appendChild(opt);
  }
  sel.onchange = () => { state.year = parseInt(sel.value,10); refreshAll(); };
}

function renderPending(){
  const tbody = $("pendingTbody");
  tbody.innerHTML = "";

  const pending = state.allRequests
    .filter(r => (r.year ?? state.year) === state.year && r.status === "Pending")
    .sort((a,b)=>(a.submittedAt||"").localeCompare(b.submittedAt||""));

  $("pendingHint").textContent = pending.length ? `${pending.length} pending request(s).` : "No pending requests.";

  for (const r of pending){
    const tr = document.createElement("tr");
    const name = (r.username || "").replace(".", " ");
    const note = (r.notes || "").replace(/</g,"&lt;");
    tr.innerHTML = `
      <td><b>${name}</b><div class="muted" style="font-size:12px;">${r.username}</div></td>
      <td>${r.start} → ${r.end}</td>
      <td>${Number(r.days||0).toFixed(0)}</td>
      <td>${r.type || "Annual Leave"}</td>
      <td>${note || "<span class='muted'>—</span>"}</td>
      <td>
        <button class="btn btnSmall btnOk" data-act="approve" data-id="${r.id}">Approve</button>
        <button class="btn btnSmall btnDanger" data-act="reject" data-id="${r.id}">Decline</button>
      </td>
    `;
    tbody.appendChild(tr);
  }

  tbody.querySelectorAll("button[data-act]").forEach(btn=>{
    btn.onclick = async () => {
      const id = btn.getAttribute("data-id");
      const act = btn.getAttribute("data-act");
      try{
        setStatus("Saving…");
        await apiPOST(act === "approve" ? `/holiday/approve?year=${state.year}` : `/holiday/reject?year=${state.year}`, { id });
        await refreshAll();
        setStatus("");
      }catch(e){
        alert("Action failed: " + e.message);
        setStatus("");
      }
    };
  });
}

function renderAllowance(){
  const tbody = $("allowTbody");
  tbody.innerHTML = "";
  if (!state.summary?.engineers) return;

  for (const e of state.summary.engineers){
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td><b>${e.name}</b><div class="muted" style="font-size:12px;">${e.username}</div></td>
      <td>${Number(e.allowance||0).toFixed(0)}</td>
      <td>${Number(e.used||0).toFixed(0)}</td>
      <td><b>${Number(e.remaining||0).toFixed(0)}</b></td>
      <td>
        <button class="btn btnSmall" data-edit="${e.username}">Edit</button>
      </td>
    `;
    tbody.appendChild(tr);
  }

  tbody.querySelectorAll("button[data-edit]").forEach(b=>{
    b.onclick = async ()=>{
      const username = b.getAttribute("data-edit");
      const current = state.summary.engineers.find(x=>x.username===username)?.allowance ?? 28;
      const val = prompt(`Set allowance for ${username} (${state.year})`, String(current));
      if (val === null) return;
      const num = Number(val);
      if (!Number.isFinite(num)) { alert("Invalid number"); return; }

      try{
        setStatus("Saving allowance…");
        await apiPOST(`/holiday/set-allowance?year=${state.year}`, { username, allowance: num });
        await refreshAll();
        setStatus("");
      }catch(e){
        alert("Save failed: " + e.message);
        setStatus("");
      }
    };
  });
}

function dayIsWeekend(year, month, day){
  const d = new Date(Date.UTC(year, month-1, day));
  const wd = d.getUTCDay();
  return wd === 0 || wd === 6;
}
function isoForDay(year, month, day){
  const d = new Date(Date.UTC(year, month-1, day));
  return d.toISOString().split("T")[0];
}

function classForCell(cell){
  if (!cell) return "";
  if (cell.kind === "holiday") {
    const t = (cell.type || "").toLowerCase();
    if (t.includes("sick")) return "evSick";
    if (t.includes("unpaid")) return "evUnpaid";
    if (t.includes("compulsory")) return "evCompulsory";
    return "evHoliday";
  }
  if (cell.kind === "bankholiday") return "evBank" + (cell.worked ? " evWorked" : "");
  if (cell.kind === "shutdown") return "evShutdown" + (cell.worked ? " evWorked" : "");
  return "";
}

function tooltipShow(html, x, y){
  const t = $("tooltip");
  t.innerHTML = html;
  t.style.left = x + "px";
  t.style.top = y + "px";
  t.style.display = "block";
}
function tooltipHide(){
  $("tooltip").style.display = "none";
}

function renderCalendar(){
  const wrap = $("calWrap");
  wrap.innerHTML = "";

  const cal = state.calendar;
  if (!cal) return;

  const daysInMonth = cal.daysInMonth;

  const head = document.createElement("div");
  head.className = "calHeader";
  head.style.gridTemplateColumns = `var(--nameCol) repeat(${daysInMonth}, var(--dayCol))`;
  head.innerHTML = `<div class="nameCell">Engineer</div>` + Array.from({length:daysInMonth}, (_,i)=>{
    const day = i+1;
    const wk = dayIsWeekend(state.year, state.month, day) ? " weekend" : "";
    return `<div class="dayCell${wk}">${day}</div>`;
  }).join("");
  wrap.appendChild(head);

  for (const eng of cal.engineers){
    const row = document.createElement("div");
    row.className = "calRow";
    row.style.gridTemplateColumns = `var(--nameCol) repeat(${daysInMonth}, var(--dayCol))`;

    const remaining = (state.summary?.engineers || []).find(x=>x.username===eng.username)?.remaining;
    const remTxt = (Number.isFinite(remaining)) ? `<span class="tag" style="margin-left:auto;background:#eef2f9;">${remaining} left</span>` : "";

    row.innerHTML = `
      <div class="nameCell">
        <span>${eng.name}</span>
        ${remTxt}
      </div>
    ` + Array.from({length:daysInMonth}, (_,i)=>{
      const day = i+1;
      const di = isoForDay(state.year, state.month, day);
      const wk = dayIsWeekend(state.year, state.month, day) ? " weekend" : "";
      const cell = eng.cells?.[di];
      const cls = classForCell(cell);
      const data = cell ? encodeURIComponent(JSON.stringify({ ...cell, date: di, username: eng.username })) : "";
      return `<div class="dayCell${wk} ${cls}" data-cell="${data}"></div>`;
    }).join("");

    wrap.appendChild(row);
  }

  wrap.querySelectorAll(".dayCell").forEach(el=>{
    const raw = el.getAttribute("data-cell");
    if (!raw) return;

    let cell;
    try{ cell = JSON.parse(decodeURIComponent(raw)); }catch{ return; }

    el.addEventListener("mousemove", (ev)=>{
      const title = cell.kind === "holiday"
        ? `${cell.type || "Holiday"}`
        : (cell.kind === "bankholiday" ? "Bank Holiday" : "Company Shutdown");

      const sub = cell.kind === "holiday"
        ? (cell.note ? `<div style="margin-top:6px;color:#cbd5e1;">${String(cell.note).replace(/</g,"&lt;")}</div>` : "")
        : `<div style="margin-top:6px;color:#cbd5e1;">${cell.label || ""}</div>`;

      const extra = (cell.kind === "bankholiday" || cell.kind === "shutdown")
        ? `<div style="margin-top:6px;color:#cbd5e1;">Status: <b>${cell.worked ? "Worked (credited)" : "Deducted"}</b><br><span style="opacity:0.85;">Click to toggle</span></div>`
        : "";

      tooltipShow(`<b>${title}</b><div style="margin-top:4px;opacity:0.9;">${cell.date}</div>${sub}${extra}`, ev.clientX, ev.clientY);
    });
    el.addEventListener("mouseleave", tooltipHide);

    el.addEventListener("click", async ()=>{
      if (!(cell.kind === "bankholiday" || cell.kind === "shutdown")) return;

      const kind = cell.kind;
      const worked = !cell.worked;

      try{
        setStatus("Updating worked status…");
        await apiPOST(`/holiday/toggle-worked?year=${state.year}`, {
          kind,
          username: cell.username,
          date: cell.date,
          worked
        });
        await refreshAll();
        setStatus("");
      }catch(e){
        alert("Toggle failed: " + e.message);
        setStatus("");
      }
    });
  });
}

function renderConfigLists(){
  const bhDiv = $("bhList");
  bhDiv.innerHTML = "";
  const bank = (state.config.bankholidays || []).slice().sort((a,b)=>String(a.date).localeCompare(String(b.date)));
  for (const b of bank){
    const row = document.createElement("div");
    row.className = "listRow";
    row.innerHTML = `
      <input type="date" value="${b.date}">
      <input type="text" value="${(b.label||"").replace(/"/g,"&quot;")}">
      <button class="btn btnSmall btnDanger">Delete</button>
      <button class="btn btnSmall btnPrimary">Save</button>
    `;
    const [dateEl, labelEl, delBtn, saveBtn] = row.querySelectorAll("input,button");
    delBtn.onclick = async ()=>{
      state.config.bankholidays = state.config.bankholidays.filter(x=>!(x.date===b.date && (x.label||"")===(b.label||"")));
      await saveBank();
    };
    saveBtn.onclick = async ()=>{
      const nd = dateEl.value;
      const nl = labelEl.value.trim();
      if (!nd) return alert("Date required");
      const idx = state.config.bankholidays.findIndex(x=>x.date===b.date && (x.label||"")===(b.label||""));
      if (idx >= 0) state.config.bankholidays[idx] = { date: nd, label: nl || "Bank Holiday" };
      await saveBank();
    };
    bhDiv.appendChild(row);
  }

  const sdDiv = $("sdList");
  sdDiv.innerHTML = "";
  const shut = (state.config.shutdown || []).slice().sort((a,b)=>String(a.date).localeCompare(String(b.date)));
  for (const s of shut){
    const row = document.createElement("div");
    row.className = "listRow";
    row.innerHTML = `
      <input type="date" value="${s.date}">
      <input type="text" value="${(s.label||"").replace(/"/g,"&quot;")}">
      <button class="btn btnSmall btnDanger">Delete</button>
      <button class="btn btnSmall btnPrimary">Save</button>
    `;
    const [dateEl, labelEl, delBtn, saveBtn] = row.querySelectorAll("input,button");
    delBtn.onclick = async ()=>{
      state.config.shutdown = state.config.shutdown.filter(x=>!(x.date===s.date && (x.label||"")===(s.label||"")));
      await saveShutdown();
    };
    saveBtn.onclick = async ()=>{
      const nd = dateEl.value;
      const nl = labelEl.value.trim();
      if (!nd) return alert("Date required");
      const idx = state.config.shutdown.findIndex(x=>x.date===s.date && (x.label||"")===(s.label||""));
      if (idx >= 0) state.config.shutdown[idx] = { date: nd, label: nl || "Company Shutdown" };
      await saveShutdown();
    };
    sdDiv.appendChild(row);
  }
}

async function saveBank(){
  try{
    setStatus("Saving bank holidays…");
    await apiPOST(`/holiday/set-bankholidays?year=${state.year}`, { days: state.config.bankholidays });
    await loadConfig();
    await refreshAll();
    setStatus("");
  }catch(e){
    alert("Save failed: " + e.message);
    setStatus("");
  }
}
async function saveShutdown(){
  try{
    setStatus("Saving shutdown days…");
    await apiPOST(`/holiday/set-shutdown?year=${state.year}`, { days: state.config.shutdown });
    await loadConfig();
    await refreshAll();
    setStatus("");
  }catch(e){
    alert("Save failed: " + e.message);
    setStatus("");
  }
}

$("addBH").onclick = async ()=>{
  const d = $("bhDate").value;
  const l = $("bhLabel").value.trim() || "Bank Holiday";
  if (!d) return alert("Choose a date");

  const existing = (state.config.bankholidays || []).some(x => x.date === d);
  if (existing) return alert("That date is already listed.");

  try {
    setStatus("Saving bank holiday…");
    const next = [...(state.config.bankholidays || []), { date:d, label:l }];
    await apiPOST(`/holiday/set-bankholidays?year=${state.year}`, { days: next });

    $("bhDate").value = "";
    $("bhLabel").value = "";

    await loadConfig();
    await refreshAll();
    setStatus("");
  } catch (e) {
    alert("Save failed: " + e.message);
    setStatus("");
  }
};

$("addSD").onclick = async ()=>{
  const d = $("sdDate").value;
  const l = $("sdLabel").value.trim() || "Company Shutdown";
  if (!d) return alert("Choose a date");

  const existing = (state.config.shutdown || []).some(x => x.date === d);
  if (existing) return alert("That date is already listed.");

  try {
    setStatus("Saving shutdown…");
    const next = [...(state.config.shutdown || []), { date:d, label:l }];
    await apiPOST(`/holiday/set-shutdown?year=${state.year}`, { days: next });

    $("sdDate").value = "";
    $("sdLabel").value = "";

    await loadConfig();
    await refreshAll();
    setStatus("");
  } catch (e) {
    alert("Save failed: " + e.message);
    setStatus("");
  }
};

async function loadConfig(){
  const fresh = await apiGET(`/holiday/config?year=${state.year}&t=${Date.now()}`);
  state.config = {
    ...fresh,
    bankholidays: Array.isArray(fresh.bankholidays) ? [...fresh.bankholidays] : [],
    shutdown: Array.isArray(fresh.shutdown) ? [...fresh.shutdown] : []
  };
  renderConfigLists();
}
async function loadRequests(){
  state.allRequests = await apiGET(`/holiday/all?year=${state.year}&t=${Date.now()}`);
}
async function loadSummary(){
  state.summary = await apiGET(`/holiday/admin-summary?year=${state.year}&t=${Date.now()}`);
}
async function loadCalendar(){
  state.calendar = await apiGET(`/holiday/calendar?year=${state.year}&month=${state.month}&t=${Date.now()}`);
}

async function refreshAll(){
  fmtMonthLabel();
  try{
    setStatus("Loading…");
    await Promise.all([loadConfig(), loadRequests(), loadSummary(), loadCalendar()]);
    renderPending();
    renderAllowance();
    renderCalendar();
    setStatus("");
  }catch(e){
    setStatus("");
    alert("Load failed: " + e.message);
  }
}

$("prevMonth").onclick = ()=> {
  state.month--;
  if (state.month < 1){ state.month = 12; state.year--; $("yearSel").value = state.year; }
  refreshAll();
};
$("nextMonth").onclick = ()=> {
  state.month++;
  if (state.month > 12){ state.month = 1; state.year++; $("yearSel").value = state.year; }
  refreshAll();
};
$("refreshBtn").onclick = refreshAll;

buildYearOptions();
fmtMonthLabel();
refreshAll();
</script>

</body>
</html>
