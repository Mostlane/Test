<!DOCTYPE html>
<html lang="en">
<head>
  <script src="auth.js"></script>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>My Purchase Orders</title>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background: #e6e8eb url('Mostlane_Embossed.png') no-repeat center center fixed;
      background-size: cover;
      margin: 0;
      padding: 20px;
      color: #333;
    }
    .container {
      max-width: 950px;
      margin: auto;
      background: rgba(255,255,255,0.9);
      padding: 25px;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    h1 {
      text-align: center;
      color: #003366;
      margin-top: 0;
      margin-bottom: 25px;
    }
    .top-bar {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
      margin-bottom: 20px;
    }
    button {
      background-color: rgba(0,74,153,0.9);
      color: #fff;
      border: none;
      padding: 10px 16px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 15px;
      white-space: nowrap;
    }
    select {
      background: #fff;
      color: #003366;
      border: 1px solid #ccc;
      border-radius: 8px;
      padding: 8px 10px;
      font-size: 15px;
    }
    .week-header {
      background: #003366;
      color: #fff;
      padding: 8px 12px;
      border-radius: 6px;
      margin-top: 25px;
      font-weight: bold;
    }
    .table-wrapper {
      overflow-x: auto;
      margin-top: 8px;
      border-radius: 8px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      min-width: 600px;
    }
    th, td {
      text-align: left;
      padding: 10px 8px;
      border-bottom: 1px solid #ddd;
      font-size: 15px;
    }
    th {
      background-color: #f0f3f8;
      color: #003366;
    }
    tr:hover {
      background-color: #f9f9f9;
    }
    .map-link {
      color: #003366;
      text-decoration: none;
      font-size: 18px;
    }
    @media (max-width: 700px) {
      body { padding: 10px; }
      .container { padding: 15px; border-radius: 10px; }
      h1 { font-size: 20px; }
      th, td { font-size: 13px; padding: 8px 6px; }
      .top-bar { flex-direction: column; align-items: stretch; gap: 12px; }
      button, select { width: 100%; }
      .week-header { font-size: 14px; text-align: center; }
    }

    /* Offline modal */
    #offlineModal {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.55);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 99999;
      font-family: Segoe UI, sans-serif;
    }
    #offlineModal .content {
      background: #fff;
      padding: 24px;
      border-radius: 12px;
      width: calc(100% - 60px);
      max-width: 420px;
      text-align: center;
      box-shadow: 0 10px 30px rgba(0,0,0,0.25);
    }
    #offlineModal h2 {
      color:#003366;
      margin-top:0;
    }
    #offlineModal p {
      font-size: 16px;
      color:#333;
      margin: 6px 0;
    }
    #offlineModal a {
      color:#003b82;
      text-decoration:none;
      font-weight:bold;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>My Purchase Orders</h1>

    <div class="top-bar">
      <button onclick="window.location.href='main.html'">Main Menu</button>

      <div>
        <label for="supplierFilter"><strong>Filter by Supplier:</strong></label>
        <select id="supplierFilter">
          <option value="">All Suppliers</option>
        </select>
      </div>

      <div>
        <label for="dateRange"><strong>Show:</strong></label>
        <select id="dateRange">
          <option value="7">Last 7 Days</option>
          <option value="14">Last 14 Days</option>
          <option value="30" selected>Last 30 Days</option>
          <option value="60">Last 60 Days</option>
          <option value="90">Last 90 Days</option>
          <option value="all">All</option>
        </select>
      </div>
    </div>

    <div id="poContainer">Loading...</div>
  </div>

  <!-- OFFLINE WARNING MODAL -->
  <div id="offlineModal">
    <div class="content">
      <h2>‚ö†Ô∏è Offline Mode</h2>
      <p>You are currently offline and may not be able to view or refresh your Purchase Orders.</p>
      <p>If you urgently need a PO number while offline, please contact the office:</p>
      <p style="font-size: 20px; font-weight: bold; margin: 12px 0;">
        üìû <a href="tel:02380262000">02380 262000</a>
      </p>
      <p style="font-size: 14px; color:#666; margin-top:12px;">
        This message will disappear when your connection returns.
      </p>
    </div>
  </div>

  <script>
  // === ENDPOINTS ===
  const CLOUDFLARE_ENDPOINT = 'https://mostlane-po.jamie-def.workers.dev/get-po'; // list POs
  const USERS_URL = 'https://raw.githubusercontent.com/Mostlane/Test/main/users.json';

  const dotToSpace = s => (s || '').replace(/\./g, ' ');

  // üóì Parse UK date (DD/MM/YYYY)
  function parseUKDate(dateStr) {
    if (!dateStr) return null;
    if (dateStr.includes('/')) {
      // DD/MM/YYYY
      const [d, m, y] = dateStr.split('/');
      if (!d || !m || !y) return null;
      return new Date(`${y}-${m}-${d}T00:00:00`);
    } else if (dateStr.includes('-')) {
      // YYYY-MM-DD (ISO date)
      const [y, m, d] = dateStr.split('-');
      if (!y || !m || !d) return null;
      return new Date(`${y}-${m}-${d}T00:00:00`);
    }
    return null;
  }

  function formatDateDisplay(dateStr) {
    const d = parseUKDate(dateStr);
    if (!d || isNaN(d)) return '';
    return d.toLocaleDateString('en-GB', { day: '2-digit', month: 'short', year: 'numeric' });
  }

  function getWeekStart(dateStr) {
    const d = parseUKDate(dateStr);
    if (!d || isNaN(d)) return 'Unknown';
    const day = d.getDay(); // 0 = Sun, 1 = Mon
    const diff = d.getDate() - day + (day === 0 ? -6 : 1); // back to Monday
    const monday = new Date(d.setDate(diff));
    return monday.toISOString().split('T')[0]; // YYYY-MM-DD
  }

  // üîé Date filter
  function filterByDate(pos, range) {
    if (range === 'all') return pos;
    const days = parseInt(range);
    const cutoff = new Date();
    cutoff.setDate(cutoff.getDate() - days);
    return pos.filter(p => {
      const d = parseUKDate(p.date);
      return d && d >= cutoff;
    });
  }

  // üîê Permission check: FullAccess == "Yes" OR myposhtml == "Yes"
  async function ensurePOPermission() {
    const container = document.getElementById('poContainer');
    const username = sessionStorage.getItem('mostlaneUser') || '';

    if (!username) {
      container.innerHTML = `<p style="color:#b91c1c;font-weight:bold;">You are not logged in.</p>`;
      throw new Error('No logged-in user');
    }

    try {
      const res = await fetch(USERS_URL + '?v=' + Date.now(), { cache: 'no-store' });
      const json = await res.json();
      const usersArr = json.Users || json || [];
      const rec = usersArr.find(u => u.Username === username || u.username === username);

      if (!rec) {
        container.innerHTML = `<p style="color:#b91c1c;font-weight:bold;">User record not found in permissions list.</p>`;
        throw new Error('User not found');
      }

      const fullAccess = (rec.FullAccess || '').toString().toLowerCase() === 'yes';
      const myPO = (rec['myposhtml'] || rec['mypos'] || '').toString().toLowerCase() === 'yes';

      if (!fullAccess && !myPO) {
        container.innerHTML = `<p style="color:#b91c1c;font-weight:bold;">
          You do not have permission to view purchase orders.<br/>
          Please contact the office if you believe this is incorrect.
        </p>`;
        throw new Error('No permission for My POs');
      }
    } catch (err) {
      if (!container.innerHTML) {
        container.innerHTML = `<p style="color:#b45309;font-weight:bold;">
          ‚ö†Ô∏è Unable to verify permissions. Please try again or contact the office.
        </p>`;
      }
      throw err;
    }
  }

  async function loadPOs() {
    const container = document.getElementById('poContainer');
    const supplierFilter = document.getElementById('supplierFilter');
    const dateRange = document.getElementById('dateRange');
    const username = sessionStorage.getItem('mostlaneUser') || '';
    const engineerName = dotToSpace(username);

    if (!navigator.onLine) {
      container.textContent = '‚ö†Ô∏è Offline ‚Äì cannot load Purchase Orders.';
      return;
    }

    try {
      const res = await fetch(CLOUDFLARE_ENDPOINT, { cache: 'no-store' });
      const data = await res.json();
      const myPOs = (Array.isArray(data) ? data : data.data || []).filter(po => po.engineer === engineerName);

      // Populate supplier filter
      const suppliers = [...new Set(myPOs.map(p => p.supplierName))].sort();
      suppliers.forEach(name => {
        const opt = document.createElement('option');
        opt.value = name;
        opt.textContent = name;
        supplierFilter.appendChild(opt);
      });

      // Default filter render
      const initial = filterByDate(myPOs, dateRange.value);
      renderPOs(initial);

      supplierFilter.addEventListener('change', () => {
        const supplierVal = supplierFilter.value;
        const dateVal = dateRange.value;
        let filtered = filterByDate(myPOs, dateVal);
        if (supplierVal) filtered = filtered.filter(p => p.supplierName === supplierVal);
        renderPOs(filtered);
      });

      dateRange.addEventListener('change', () => {
        const supplierVal = supplierFilter.value;
        const dateVal = dateRange.value;
        let filtered = filterByDate(myPOs, dateVal);
        if (supplierVal) filtered = filtered.filter(p => p.supplierName === supplierVal);
        renderPOs(filtered);
      });

    } catch (err) {
      container.textContent = '‚ö†Ô∏è Failed to load POs: ' + err.message;
    }
  }

  function renderPOs(pos) {
    const container = document.getElementById('poContainer');
    container.innerHTML = '';

    if (!pos.length) {
      container.textContent = 'No Purchase Orders found.';
      return;
    }

    const grouped = {};
    pos.forEach(p => {
      const weekStart = getWeekStart(p.date);
      if (!grouped[weekStart]) grouped[weekStart] = [];
      grouped[weekStart].push(p);
    });

    const sortedWeeks = Object.keys(grouped).sort((a, b) => new Date(b) - new Date(a));

    sortedWeeks.forEach(weekStart => {
      const header = document.createElement('div');
      header.className = 'week-header';

      if (weekStart === 'Unknown') {
        header.textContent = 'Unknown Date';
      } else {
        const monday = parseUKDate(weekStart); // weekStart is YYYY-MM-DD
        const sunday = new Date(monday);
        sunday.setDate(sunday.getDate() + 6);
        const weekText = `Week of ${formatDateDisplay(weekStart)} ‚Üí ${formatDateDisplay(sunday.toISOString().split('T')[0])}`;
        header.textContent = weekText;
      }

      container.appendChild(header);

      const wrapper = document.createElement('div');
      wrapper.className = 'table-wrapper';

      const rowsHtml = grouped[weekStart]
        .sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt))
        .map(po => `
          <tr>
            <td>${formatDateDisplay(po.date)}</td>
            <td>${po.poNumber}</td>
            <td>${po.supplierName}</td>
            <td>${po.description}</td>
            <td>${po.workType}</td>
            <td>${
              po.latitude && po.longitude
                ? `<a class="map-link" href="https://www.google.com/maps?q=${po.latitude},${po.longitude}" target="_blank">üìç</a>`
                : ''
            }</td>
          </tr>
        `).join('');

      const table = document.createElement('table');
      table.innerHTML = `
        <thead>
          <tr>
            <th>Date</th>
            <th>PO Number</th>
            <th>Supplier</th>
            <th>Description</th>
            <th>Type</th>
            <th>Map</th>
          </tr>
        </thead>
        <tbody>${rowsHtml}</tbody>
      `;

      wrapper.appendChild(table);
      container.appendChild(wrapper);
    });
  }

  // Offline modal helpers
  function showOfflineModal() {
    document.getElementById('offlineModal').style.display = 'flex';
  }
  function hideOfflineModal() {
    document.getElementById('offlineModal').style.display = 'none';
  }

  // Init
  document.addEventListener('DOMContentLoaded', async () => {
    // Offline state at load
    if (!navigator.onLine) showOfflineModal();

    window.addEventListener('offline', showOfflineModal);
    window.addEventListener('online', hideOfflineModal);

    try {
      await ensurePOPermission();
      await loadPOs();
    } catch (e) {
      // permission or other fatal error already shown in UI
      console.warn(e);
    }
  });
  </script>
</body>
</html>
