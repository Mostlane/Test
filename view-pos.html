<!DOCTYPE html>
<html lang="en">
<head>
  <script src="auth.js"></script>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>My Purchase Orders</title>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background: #e6e8eb url('Mostlane_Embossed.png') no-repeat center center fixed;
      background-size: cover;
      margin: 0;
      padding: 20px;
      color: #333;
    }
    .container {
      max-width: 950px;
      margin: auto;
      background: rgba(255,255,255,0.9);
      padding: 25px;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    h1 {
      text-align: center;
      color: #003366;
      margin-top: 0;
      margin-bottom: 25px;
    }
    .top-bar {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
      margin-bottom: 20px;
    }
    button {
      background-color: rgba(0,74,153,0.9);
      color: #fff;
      border: none;
      padding: 10px 16px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 15px;
      white-space: nowrap;
    }
    select {
      background: #fff;
      color: #003366;
      border: 1px solid #ccc;
      border-radius: 8px;
      padding: 8px 10px;
      font-size: 15px;
    }
    .week-header {
      background: #003366;
      color: #fff;
      padding: 8px 12px;
      border-radius: 6px;
      margin-top: 25px;
      font-weight: bold;
    }
    .table-wrapper {
      overflow-x: auto;
      margin-top: 8px;
      border-radius: 8px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      min-width: 600px;
    }
    th, td {
      text-align: left;
      padding: 10px 8px;
      border-bottom: 1px solid #ddd;
      font-size: 15px;
    }
    th {
      background-color: #f0f3f8;
      color: #003366;
    }
    tr:hover {
      background-color: #f9f9f9;
    }
    .map-link {
      color: #003366;
      text-decoration: none;
      font-size: 18px;
    }
    @media (max-width: 700px) {
      body { padding: 10px; }
      .container { padding: 15px; border-radius: 10px; }
      h1 { font-size: 20px; }
      th, td { font-size: 13px; padding: 8px 6px; }
      .top-bar { flex-direction: column; align-items: stretch; gap: 12px; }
      button, select { width: 100%; }
      .week-header { font-size: 14px; text-align: center; }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>My Purchase Orders</h1>

    <div class="top-bar">
      <button onclick="window.location.href='main.html'">Main Menu</button>

      <div>
        <label for="supplierFilter"><strong>Filter by Supplier:</strong></label>
        <select id="supplierFilter">
          <option value="">All Suppliers</option>
        </select>
      </div>

      <div>
        <label for="dateRange"><strong>Show:</strong></label>
        <select id="dateRange">
          <option value="7">Last 7 Days</option>
          <option value="14">Last 14 Days</option>
          <option value="30" selected>Last 30 Days</option>
          <option value="60">Last 60 Days</option>
          <option value="90">Last 90 Days</option>
          <option value="all">All</option>
        </select>
      </div>
    </div>

    <div id="poContainer">Loading...</div>
  </div>

  <script>
  const CLOUDFLARE_ENDPOINT = 'https://mostlane-pos.jamie-def.workers.dev/get-po';
  const dotToSpace = s => (s || '').replace(/\./g, ' ');

  // üóì Parse UK date (DD/MM/YYYY)
  function parseUKDate(dateStr) {
    if (!dateStr) return null;
    const [d, m, y] = dateStr.split('/');
    if (!d || !m || !y) return null;
    return new Date(`${y}-${m}-${d}T00:00:00`);
  }
  function formatDateDisplay(dateStr) {
    const d = parseUKDate(dateStr);
    if (!d || isNaN(d)) return '';
    return d.toLocaleDateString('en-GB', { day: '2-digit', month: 'short', year: 'numeric' });
  }
  function getWeekStart(dateStr) {
    const d = parseUKDate(dateStr);
    if (!d || isNaN(d)) return 'Unknown';
    const day = d.getDay();
    const diff = d.getDate() - day + (day === 0 ? -6 : 1);
    const monday = new Date(d.setDate(diff));
    return monday.toISOString().split('T')[0];
  }

  // üîé Date filter
  function filterByDate(pos, range) {
    if (range === 'all') return pos;
    const days = parseInt(range);
    const cutoff = new Date();
    cutoff.setDate(cutoff.getDate() - days);
    return pos.filter(p => {
      const d = parseUKDate(p.date);
      return d && d >= cutoff;
    });
  }

  async function loadPOs() {
    const container = document.getElementById('poContainer');
    const supplierFilter = document.getElementById('supplierFilter');
    const dateRange = document.getElementById('dateRange');
    const username = sessionStorage.getItem('mostlaneUser') || '';
    const engineerName = dotToSpace(username);

    try {
      const res = await fetch(CLOUDFLARE_ENDPOINT, { cache: 'no-store' });
      const data = await res.json();
      const myPOs = data.filter(po => po.engineer === engineerName);

      // Populate supplier filter
      const suppliers = [...new Set(myPOs.map(p => p.supplierName))].sort();
      suppliers.forEach(name => {
        const opt = document.createElement('option');
        opt.value = name; opt.textContent = name;
        supplierFilter.appendChild(opt);
      });

      // Default filter render
      const filtered = filterByDate(myPOs, dateRange.value);
      renderPOs(filtered);

      supplierFilter.addEventListener('change', () => {
        const supplierVal = supplierFilter.value;
        const dateVal = dateRange.value;
        let filtered = filterByDate(myPOs, dateVal);
        if (supplierVal) filtered = filtered.filter(p => p.supplierName === supplierVal);
        renderPOs(filtered);
      });

      dateRange.addEventListener('change', () => {
        const supplierVal = supplierFilter.value;
        const dateVal = dateRange.value;
        let filtered = filterByDate(myPOs, dateVal);
        if (supplierVal) filtered = filtered.filter(p => p.supplierName === supplierVal);
        renderPOs(filtered);
      });

    } catch (err) {
      container.textContent = '‚ö†Ô∏è Failed to load POs: ' + err.message;
    }
  }

  function renderPOs(pos) {
    const container = document.getElementById('poContainer');
    container.innerHTML = '';

    if (!pos.length) {
      container.textContent = 'No Purchase Orders found.';
      return;
    }

    const grouped = {};
    pos.forEach(p => {
      const weekStart = getWeekStart(p.date);
      if (!grouped[weekStart]) grouped[weekStart] = [];
      grouped[weekStart].push(p);
    });

    const sortedWeeks = Object.keys(grouped).sort((a,b)=>new Date(b)-new Date(a));

    sortedWeeks.forEach(weekStart => {
      const weekEnd = new Date(weekStart);
      weekEnd.setDate(weekEnd.getDate() + 6);

      const header = document.createElement('div');
      header.className = 'week-header';
      const weekText = weekStart === 'Unknown'
        ? 'Unknown Date'
        : `Week of ${formatDateDisplay(weekStart)} ‚Üí ${formatDateDisplay(weekEnd.toISOString().split('T')[0])}`;
      header.textContent = weekText;
      container.appendChild(header);

      const wrapper = document.createElement('div');
      wrapper.className = 'table-wrapper';

      const table = document.createElement('table');
      table.innerHTML = `
        <thead>
          <tr>
            <th>Date</th>
            <th>PO Number</th>
            <th>Supplier</th>
            <th>Description</th>
            <th>Type</th>
            <th>Map</th>
          </tr>
        </thead>
        <tbody>
          ${grouped[weekStart]
            .sort((a,b)=>new Date(b.createdAt)-new Date(a.createdAt))
            .map(po => `
              <tr>
                <td>${formatDateDisplay(po.date)}</td>
                <td>${po.poNumber}</td>
                <td>${po.supplierName}</td>
                <td>${po.description}</td>
                <td>${po.workType}</td>
                <td>${
                  po.latitude && po.longitude
                    ? `<a class="map-link" href="https://www.google.com/maps?q=${po.latitude},${po.longitude}" target="_blank">üìç</a>`
                    : ''
                }</td>
              </tr>
            `).join('')}
        </tbody>`;
      wrapper.appendChild(table);
      container.appendChild(wrapper);
    });
  }

  document.addEventListener('DOMContentLoaded', loadPOs);
  </script>
</body>
</html>
