<!DOCTYPE html>
<html lang="en">
<head>
  <script src="auth.js"></script>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>View Purchase Orders</title>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background: #e6e8eb url('Mostlane_Embossed.png') no-repeat center center fixed;
      background-size: cover;
      margin: 0;
      padding: 20px;
      color: #333;
    }
    .container {
      max-width: 1100px;
      margin: auto;
      background: rgba(255,255,255,0.9);
      padding: 24px;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    h1 {
      text-align: center;
      color: #003366;
      margin: 0 0 16px 0;
    }
    .top-bar,
    .filters {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      margin-bottom: 14px;
    }
    .filters > * {
      margin-right: 8px;
    }
    button {
      background-color: rgba(0,74,153,0.9);
      color: #fff;
      border: none;
      padding: 10px 16px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 15px;
      white-space: nowrap;
    }
    select,
    input[type="search"] {
      background: #fff;
      color: #003366;
      border: 1px solid #ccc;
      border-radius: 8px;
      padding: 8px 10px;
      font-size: 15px;
    }
    .inline {
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }
    .muted {
      color: #666;
      font-size: 13px;
    }
    .section-title {
      background: #003366;
      color: #fff;
      padding: 8px 12px;
      border-radius: 6px;
      font-weight: bold;
      margin-top: 16px;
    }
    .table-wrapper {
      overflow-x: auto;
      border-radius: 8px;
      margin-top: 8px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      min-width: 860px;
    }
    th,
    td {
      text-align: left;
      padding: 10px 8px;
      border-bottom: 1px solid #ddd;
      font-size: 15px;
      vertical-align: middle;
    }
    th {
      background-color: #f0f3f8;
      color: #003366;
    }
    tr:hover {
      background-color: #f9f9f9;
    }
    .right {
      text-align: right;
    }
    .nowrap {
      white-space: nowrap;
    }
    .map-link {
      color: #003366;
      text-decoration: none;
      font-size: 18px;
    }
    @media (max-width: 750px) {
      body {
        padding: 10px;
      }
      .container {
        padding: 15px;
      }
      th,
      td {
        font-size: 13px;
        padding: 8px 6px;
      }
      button,
      select,
      input {
        width: 100%;
      }
      .top-bar,
      .filters {
        flex-direction: column;
        align-items: stretch;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>View Purchase Orders</h1>

    <div class="top-bar">
      <button onclick="window.location.href='main.html'">Main Menu</button>
      <div class="muted" id="statusText">Loading‚Ä¶</div>
    </div>

    <div class="filters">
      <div>
        <label for="engineerFilter"><strong>Engineer:</strong></label>
        <select id="engineerFilter">
          <option value="">All Engineers</option>
        </select>
      </div>

      <div>
        <label for="supplierFilter"><strong>Supplier:</strong></label>
        <select id="supplierFilter">
          <option value="">All Suppliers</option>
        </select>
      </div>

      <div>
        <label for="jobFilter"><strong>Job / Site Key:</strong></label>
        <select id="jobFilter">
          <option value="">All Jobs</option>
        </select>
      </div>

      <div>
        <label for="dateRange"><strong>Show:</strong></label>
        <select id="dateRange">
          <option value="7">Last 7 Days</option>
          <option value="14">Last 14 Days</option>
          <option value="30" selected>Last 30 Days</option>
          <option value="60">Last 60 Days</option>
          <option value="90">Last 90 Days</option>
          <option value="all">All</option>
        </select>
      </div>

      <div class="inline">
        <label for="searchBox"><strong>Search:</strong></label>
        <input id="searchBox" type="search" placeholder="PO number, description, incident‚Ä¶" />
      </div>
    </div>

    <div class="section-title">All Purchase Orders</div>
    <div class="table-wrapper">
      <table id="poTable">
        <thead>
          <tr>
            <th>Date</th>
            <th>PO Number</th>
            <th>Engineer</th>
            <th>Supplier</th>
            <th>Job / Site Key</th>
            <th>Work Type</th>
            <th>Description</th>
            <th>Incident</th>
            <th>Map</th>
          </tr>
        </thead>
        <tbody>
          <!-- filled by JS -->
        </tbody>
      </table>
    </div>
  </div>

  <script>
    // ======== CONFIG ========
    const GET_URL = "https://mostlane-po.jamie-def.workers.dev/po/list";

    // ======== UTILS ========
    const dotToSpace = (s) => (s || "").replace(/\./g, " ");

    // Parse UK date (DD/MM/YYYY) to Date
    function parseUKDate(dateStr) {
      if (!dateStr) return null;
      const parts = dateStr.split("/");
      if (parts.length !== 3) return null;
      const [d, m, y] = parts;
      if (!d || !m || !y) return null;
      return new Date(`${y}-${m}-${d}T00:00:00`);
    }

    function formatDateDisplay(dateStr) {
      const d = parseUKDate(dateStr);
      if (!d || isNaN(d)) return "";
      return d.toLocaleDateString("en-GB", {
        day: "2-digit",
        month: "short",
        year: "numeric",
      });
    }

    // Job / Site key = 3rd segment of PO number (e.g. E01-1234-S0001-R1 -> S0001)
    function getJobKey(poNumber) {
      const num = String(poNumber || "");
      const parts = num.split("-");
      if (parts.length >= 3) return parts[2];
      return "";
    }

    function byId(id) {
      return document.getElementById(id);
    }

    // Date range filter
    function filterByDate(list, range) {
      if (range === "all") return list;
      const days = parseInt(range, 10);
      if (isNaN(days)) return list;
      const cutoff = new Date();
      cutoff.setDate(cutoff.getDate() - days);
      return list.filter((p) => {
        const d = parseUKDate(p.date);
        return d && d >= cutoff;
      });
    }

    // ======== STATE ========
    let ALL_POS = [];
    let FILTERED_POS = [];

    // ======== FILTER + RENDER ========
    function applyFilters() {
      const engineerVal = byId("engineerFilter").value;
      const supplierVal = byId("supplierFilter").value;
      const jobVal = byId("jobFilter").value;
      const dateVal = byId("dateRange").value;
      const searchVal = (byId("searchBox").value || "").toLowerCase().trim();

      let list = filterByDate(ALL_POS, dateVal);

      if (engineerVal) {
        list = list.filter((p) => (p.engineer || "") === engineerVal);
      }
      if (supplierVal) {
        list = list.filter((p) => (p.supplierName || "") === supplierVal);
      }
      if (jobVal) {
        list = list.filter((p) => p.jobKey === jobVal);
      }
      if (searchVal) {
        list = list.filter((p) => {
          const hay = [
            p.poNumber,
            p.description,
            p.incidentNumber,
            p.workType,
            p.engineer,
            p.supplierName,
            p.jobKey,
          ]
            .join(" ")
            .toLowerCase();
          return hay.includes(searchVal);
        });
      }

      FILTERED_POS = list;
      renderTable();
      updateStatus();
      populateDropdownsFromFiltered(); // keep options in sync with visible set
    }

    function updateStatus() {
      const status = byId("statusText");
      const uniqueJobs = new Set(FILTERED_POS.map((p) => p.jobKey || "").filter(Boolean)).size;
      status.textContent = `${FILTERED_POS.length} PO(s) | ${uniqueJobs} job(s)`;
    }

    function renderTable() {
      const tbody = document.querySelector("#poTable tbody");
      tbody.innerHTML = "";

      const rows = [...FILTERED_POS].sort((a, b) => {
        const da = parseUKDate(a.date);
        const db = parseUKDate(b.date);
        return (db || 0) - (da || 0);
      });

      if (!rows.length) {
        const tr = document.createElement("tr");
        const td = document.createElement("td");
        td.colSpan = 9;
        td.textContent = "No Purchase Orders match your filters.";
        tr.appendChild(td);
        tbody.appendChild(tr);
        return;
      }

      rows.forEach((p) => {
        const tr = document.createElement("tr");

        const mapCell =
          p.latitude != null && p.longitude != null
            ? `<a class="map-link" href="https://www.google.com/maps?q=${p.latitude},${p.longitude}" target="_blank">üìç</a>`
            : "";

        tr.innerHTML = `
          <td class="nowrap">${formatDateDisplay(p.date)}</td>
          <td class="nowrap">${p.poNumber || ""}</td>
          <td>${p.engineer || ""}</td>
          <td>${p.supplierName || ""}</td>
          <td class="nowrap">${p.jobKey || ""}</td>
          <td>${p.workType || ""}</td>
          <td>${p.description || ""}</td>
          <td>${p.incidentNumber || ""}</td>
          <td class="nowrap">${mapCell}</td>
        `;

        tbody.appendChild(tr);
      });
    }

    // Populate dropdowns from ALL_POS initially, and keep their values when filters change
    function populateDropdownsInitial() {
      const engSel = byId("engineerFilter");
      const supSel = byId("supplierFilter");
      const jobSel = byId("jobFilter");

      const engineers = [...new Set(ALL_POS.map((p) => p.engineer).filter(Boolean))].sort();
      const suppliers = [...new Set(ALL_POS.map((p) => p.supplierName).filter(Boolean))].sort();
      const jobs = [...new Set(ALL_POS.map((p) => p.jobKey).filter(Boolean))].sort();

      engSel.innerHTML = '<option value="">All Engineers</option>';
      engineers.forEach((e) => {
        const opt = document.createElement("option");
        opt.value = e;
        opt.textContent = e;
        engSel.appendChild(opt);
      });

      supSel.innerHTML = '<option value="">All Suppliers</option>';
      suppliers.forEach((s) => {
        const opt = document.createElement("option");
        opt.value = s;
        opt.textContent = s;
        supSel.appendChild(opt);
      });

      jobSel.innerHTML = '<option value="">All Jobs</option>';
      jobs.forEach((j) => {
        const opt = document.createElement("option");
        opt.value = j;
        opt.textContent = j;
        jobSel.appendChild(opt);
      });
    }

    // After filtering, we keep dropdowns limited to what's in FILTERED_POS
    function populateDropdownsFromFiltered() {
      const engSel = byId("engineerFilter");
      const supSel = byId("supplierFilter");
      const jobSel = byId("jobFilter");

      const keepEng = engSel.value;
      const keepSup = supSel.value;
      const keepJob = jobSel.value;

      const engineers = [...new Set(FILTERED_POS.map((p) => p.engineer).filter(Boolean))].sort();
      const suppliers = [...new Set(FILTERED_POS.map((p) => p.supplierName).filter(Boolean))].sort();
      const jobs = [...new Set(FILTERED_POS.map((p) => p.jobKey).filter(Boolean))].sort();

      engSel.innerHTML = '<option value="">All Engineers</option>';
      engineers.forEach((e) => {
        const opt = document.createElement("option");
        opt.value = e;
        opt.textContent = e;
        engSel.appendChild(opt);
      });

      supSel.innerHTML = '<option value="">All Suppliers</option>';
      suppliers.forEach((s) => {
        const opt = document.createElement("option");
        opt.value = s;
        opt.textContent = s;
        supSel.appendChild(opt);
      });

      jobSel.innerHTML = '<option value="">All Jobs</option>';
      jobs.forEach((j) => {
        const opt = document.createElement("option");
        opt.value = j;
        opt.textContent = j;
        jobSel.appendChild(opt);
      });

      // restore previous selections if still valid
      if ([...engSel.options].some((o) => o.value === keepEng)) engSel.value = keepEng;
      if ([...supSel.options].some((o) => o.value === keepSup)) supSel.value = keepSup;
      if ([...jobSel.options].some((o) => o.value === keepJob)) jobSel.value = keepJob;
    }

    // ======== INIT ========
    async function init() {
      const status = byId("statusText");
      status.textContent = "Loading‚Ä¶";

      try {
        const res = await fetch(GET_URL, { cache: "no-store" });
        const json = await res.json();

        // Worker returns { ok, count, data } ‚Äì but also tolerate raw array
        let list = json.data || json || [];
        if (!Array.isArray(list)) list = [];

        ALL_POS = list.map((p) => {
          const jobKey = getJobKey(p.poNumber);
          return {
            ...p,
            engineer: p.engineer || "",
            supplierName: p.supplierName || "",
            workType: p.workType || "",
            description: p.description || "",
            incidentNumber: p.incidentNumber || "",
            date: p.date || (p.createdAt ? new Date(p.createdAt).toLocaleDateString("en-GB") : ""),
            jobKey,
          };
        });

        populateDropdownsInitial();

        // Wire up filters
        ["engineerFilter", "supplierFilter", "jobFilter", "dateRange", "searchBox"].forEach(
          (id) => {
            const el = byId(id);
            el.addEventListener("change", applyFilters);
            el.addEventListener("input", applyFilters);
          }
        );

        FILTERED_POS = ALL_POS.slice();
        renderTable();
        updateStatus();
      } catch (err) {
        status.textContent = "‚ö†Ô∏è Failed to load POs: " + err.message;
        console.error(err);
      }
    }

    document.addEventListener("DOMContentLoaded", init);
  </script>
</body>
</html>
