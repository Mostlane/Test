<!DOCTYPE html>
<html>
<head>
  <title>Main Menu</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" type="image/x-icon" href="favicon.ico">
  <link rel="shortcut icon" type="image/x-icon" href="favicon.ico">

  <script>
    if (sessionStorage.getItem("mostlaneLoggedIn") !== "true") {
      window.location.href = "login.html";
    }
  </script>

  <style>
    html, body { height: 100%; margin: 0; padding: 0; }

    body.main-body {
      font-family: "Segoe UI", sans-serif;
      background: #e6e8eb url('Mostlane_Embossed.png') no-repeat center center fixed;
      background-size: cover;
      padding: 25px 0;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    #user-display {
      font-size: 18px;
      font-weight: bold;
      color: #003366;
      margin-bottom: 18px;
    }

    .menu-grid {
      width: 92%;
      max-width: 850px;
      display: grid;
      gap: 18px;
      grid-template-columns: repeat(2, 1fr);
    }

    @media (min-width: 800px) {
      .menu-grid { grid-template-columns: repeat(3, 1fr); }
    }

    a.button {
      display: flex !important;
      align-items: center;
      gap: 12px;

      padding: 18px 20px;
      background: linear-gradient(180deg, #1A4F8F 0%, #003468 100%);
      border-radius: 14px;

      box-shadow:
        0 4px 10px rgba(0,0,0,0.25),
        inset 0 1px 2px rgba(255,255,255,0.15);

      text-decoration: none;
      color: #ffffff;
      font-weight: 600;
      font-size: 17px;
      transition: 0.2s ease;
    }

    a.button:hover {
      transform: translateY(-2px);
      box-shadow:
        0 7px 14px rgba(0,0,0,0.30),
        inset 0 1px 2px rgba(255,255,255,0.20);
    }

    .emoji { font-size: 2rem; }

    .hidden { display: none !important; }
  </style>
</head>

<body class="main-body">

  <div id="user-display">You are logged in as <span id="userName"></span></div>

  <script>
    const userDisplay = sessionStorage.getItem("mostlaneUsername");
    if (userDisplay) document.getElementById("userName").textContent = userDisplay;
  </script>

  <div class="menu-grid" id="menuGrid">

    <!-- EXACT ORIGINAL ORDER -->
    <a class="button hidden" id="CheckInOut" href="index.html"><span class="emoji">ğŸ•’</span> Check In / Out</a>
    <a class="button hidden" id="Vehicles" href="vehicles.html"><span class="emoji">ğŸš</span> Vehicles</a>
    <a class="button hidden" id="Holiday" href="holiday.html"><span class="emoji">ğŸ“…</span> Holiday Requests</a>
    <a class="button hidden" id="EngineersHoursMenu" href="engineers-hours-menu.html"><span class="emoji">ğŸ› ï¸</span> Engineers Hours Menu</a>
    <a class="button hidden" id="PurchaseOrders" href="purchase.html"><span class="emoji">ğŸ§¾</span> Generate Purchase Order Reference</a>
    <a class="button hidden" id="Sites" href="sites.html"><span class="emoji">ğŸ“</span> Manage Sites</a>
    <a class="button hidden" id="Assets" href="asset-menu.html"><span class="emoji">âš™ï¸</span> Plant & Equipment</a>
    <a class="button hidden" id="MyDocuments" href="#"><span class="emoji">ğŸ“„</span> My Documents</a>
    <a class="button hidden" id="Weekly" href="weekly.html"><span class="emoji">ğŸ“Š</span> Weekly Summary</a>
    <a class="button hidden" id="Forms" href="forms.html"><span class="emoji">ğŸ“</span> Forms</a>
    <a class="button hidden" id="Compliance" href="compliance.html"><span class="emoji">âœ”ï¸</span> Compliance</a>
    <a class="button hidden" id="HoursDashboard" href="hours-dashboard-simple-v2.html"><span class="emoji">â³</span> Hours Dashboard</a>
    <a class="button hidden" id="PurchaseOrders2" href="po-menu.html"><span class="emoji">ğŸ’·</span> Purchase Orders</a>
    <a class="button hidden" id="Users" href="users-admin.html"><span class="emoji">ğŸ‘¥</span> Users</a>

    <a class="button" href="#" onclick="sessionStorage.clear(); window.location.href='login.html';">
      <span class="emoji">ğŸšª</span> Logout
    </a>

  </div>

  <!-- STRICT PERMISSIONS LOGIC -->
  <script>
    document.addEventListener("DOMContentLoaded", async () => {

      const username = sessionStorage.getItem("mostlaneUsername"); // FIXED
      if (!username) return;

      try {
        const res = await fetch(
          "https://mostlane-users.jamie-def.workers.dev/user?u=" + encodeURIComponent(username)
        );
        const data = await res.json();
        if (!data.found) return;

        const user = data.user;

        // STRICT, STABLE PERMISSION KEYS
        const stableKeys = [
          "CheckInOut",
          "Vehicles",
          "Holiday",
          "EngineersHoursMenu",
          "PurchaseOrders",
          "Sites",
          "Assets",
          "MyDocuments",
          "Weekly",
          "Forms",
          "Compliance",
          "HoursDashboard",
          "Users"
        ];

        // Hide all by default
        stableKeys.forEach(key => {
          const btn = document.getElementById(key);
          if (btn) btn.classList.add("hidden");
        });

        // Show only allowed
        stableKeys.forEach(key => {
          const btn = document.getElementById(key);
          if (!btn) return;

          if (user[key] && user[key].toString().toLowerCase() === "yes") {
            btn.classList.remove("hidden");
          }
        });

        // Special case: My Documents
        const docsBtn = document.getElementById("MyDocuments");
        if (docsBtn && user.MyDocuments === "Yes" && user.SharePointPath) {
          docsBtn.href = user.SharePointPath;
        }

      } catch (err) {
        console.error("Permissions failed:", err);
      }

    });
  </script>

</body>
</html>
