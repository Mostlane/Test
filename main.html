<!DOCTYPE html>
<html>
<head>
<title>Main Menu</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="style.css">
<script>
  if (sessionStorage.getItem("mostlaneLoggedIn") !== "true") {
    window.location.href = "login.html";
  }
</script>
</head>

<body class="main-body">
<div id="statusBox" style="margin-bottom: 20px; font-weight: bold; color: #004a99;"></div>
<script>
  const currentUser = sessionStorage.getItem("mostlaneUser");
  const status = localStorage.getItem("mostlaneStatus_" + currentUser);
  const site = localStorage.getItem("mostlaneSite_" + currentUser);
  const timestamp = localStorage.getItem("mostlaneTimestamp_" + currentUser);
  let statusText = "Status unknown";
  if (status === "checked-in") {
    statusText = "Checked In" + (site ? ` at ${site}` : "");
  } else if (status === "checked-out") {
    statusText = "Last Checkout: " + (timestamp ? timestamp : "unknown time");
    if (site) statusText += " at " + site;
  }
  document.getElementById("statusBox").textContent = "Current Status: " + statusText;
</script>

<div id="user-display" style="margin-bottom: 20px; font-size: 16px; font-weight: bold; color: #003366;"></div>
<script>
  const user = sessionStorage.getItem("mostlaneUser");
  if (user) {
    document.getElementById("user-display").textContent = "You are logged in as " + user;
  }
</script>

<style>
  html, body { height: 100%; }
  .main-body {
    font-family: "Segoe UI", sans-serif;
    background: #e6e8eb url('Mostlane_Embossed.png') no-repeat center center fixed;
    background-size: cover;
    margin: 0;
    padding: 40px 20px;
    min-height: 100vh;
    display: flex;
    flex-direction: column;
    align-items: center;
  }
  .button {
    display: block;
    margin: 10px auto;
    padding: 12px 20px;
    font-size: 16px;
    text-align: center;
    color: #ffffff;
    background-color: rgba(0, 74, 153, 0.6);
    text-decoration: none;
    border-radius: 6px;
    width: 90%;
    max-width: 300px;
  }
</style>

<!-- ✅ BUTTONS -->
<a class="button" href="index.html" id="checkinBtn">Check In / Out</a>
<a class="button" href="holiday.html" id="holidayBtn">Holiday Requests</a>
<a class="button" href="purchase.html" id="purchaseBtn">Generate Purchase Order Reference</a>
<a class="button" href="my-assets.html" id="assetsBtn">Plant &amp; Equipment</a>
<a class="button" href="#" id="my-documents-btn">My Documents</a>
<a class="button" href="weekly.html" id="weeklyBtn">Weekly Summary</a>
<a class="button" href="forms.html" id="formsBtn">Forms</a>
<a class="button" href="compliance.html" id="complianceBtn">Compliance</a>
<a class="button" href="hours-dashboard-simple-v2.html" id="hours-dashboard-btn">Hours Dashboard</a>
<a class="button" href="po-menu.html" id="poMenuBtn">Purchase Orders</a>
<a class="button" href="#" onclick="sessionStorage.clear(); window.location.href='login.html';">Logout</a>

<!-- ✅ PERMISSION LOGIC -->
<script>
document.addEventListener('DOMContentLoaded', async () => {
  const username = sessionStorage.getItem("mostlaneUser");
  if (!username) return;

  try {
    const res = await fetch("https://raw.githubusercontent.com/Mostlane/Test/main/users.json?v=" + Date.now());
    const data = await res.json();
    const users = data.Users || [];
    const user = users.find(u => u.Username === username);
    if (!user) return;

    const full = (user.FullAccess || "").toLowerCase() === "yes";

    function toggle(id, key) {
      const el = document.getElementById(id);
      if (!el) return;
      if (full) {
        el.style.display = "block"; // Show everything for FullAccess
        return;
      }
      if ((user[key] || "").toLowerCase() !== "yes") {
        el.style.display = "none";
      }
    }

    // Apply permissions from users.json
    toggle("checkinBtn", "CheckInOut");
    toggle("holidayBtn", "Holiday");
    toggle("purchaseBtn", "PurchaseOrders");
    toggle("poMenuBtn", "PurchaseOrders");
    toggle("assetsBtn", "Assets");
    toggle("formsBtn", "Forms");
    toggle("my-documents-btn", "MyDocuments");
    toggle("complianceBtn", "Compliance");
    toggle("hours-dashboard-btn", "HoursDashboard");
    toggle("weeklyBtn", "Weekly"); // Optional future expansion

    // Optional: Auto-link My Documents button to user SharePointPath
    const docBtn = document.getElementById("my-documents-btn");
    if (docBtn && user.SharePointPath) {
      docBtn.href = user.SharePointPath;
    }

  } catch (err) {
    console.error("Failed to load permissions", err);
  }
});
</script>

</body>
</html>
