<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>Main Menu</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <link rel="icon" type="image/x-icon" href="favicon.ico">
  <link rel="shortcut icon" type="image/x-icon" href="favicon.ico">

  <script src="auth.js"></script>

  <style>
    html, body { height: 100%; margin: 0; padding: 0; }

    body.main-body {
      font-family: "Segoe UI", sans-serif;
      background: #e6e8eb url('Mostlane_Embossed.png') no-repeat center center fixed;
      background-size: cover;
      padding: 25px 0;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    #user-display {
      font-size: 18px;
      font-weight: bold;
      margin-bottom: 20px;
      color: #003b82;
    }

    .menu-container {
      width: 90%;
      max-width: 600px;
      background: rgba(255, 255, 255, 0.9);
      padding: 25px;
      border-radius: 12px;
      box-shadow: 0px 4px 8px rgba(0,0,0,0.2);
    }

    .menu-btn {
      width: 100%;
      padding: 18px;
      margin: 10px 0;
      font-size: 18px;
      font-weight: bold;
      border-radius: 10px;
      background: #003b82;
      color: white;
      border: none;
      cursor: pointer;
      transition: 0.2s;
    }

    .menu-btn:hover {
      background: #0059c9;
    }

    .hidden { display: none !important; }
  </style>
</head>

<body class="main-body">
  <div id="user-display">Loading...</div>

  <div class="menu-container">

    <button id="checkin" class="menu-btn hidden" onclick="location.href='checkin.html'">ğŸ•’ Check In / Out</button>
    <button id="holiday" class="menu-btn hidden" onclick="location.href='holiday.html'">ğŸ“… Holiday Requests</button>
    <button id="purchaseorders" class="menu-btn hidden" onclick="location.href='purchase.html'">ğŸ§¾ Generate PO Reference</button>
    <button id="assets" class="menu-btn hidden" onclick="location.href='asset-menu.html'">âš™ Plant & Equipment</button>
    <button id="forms" class="menu-btn hidden" onclick="location.href='forms.html'">ğŸ“ Forms</button>
    <button id="users" class="menu-btn hidden" onclick="location.href='user-admin.html'">ğŸ‘¥ Users</button>
    <button id="compliance" class="menu-btn hidden" onclick="location.href='compliance-menu.html'">âœ” Compliance</button>
    <button id="hoursdashboard" class="menu-btn hidden" onclick="location.href='weekly.html'">ğŸ“Š Hours Dashboard</button>
    <button id="weekly" class="menu-btn hidden" onclick="location.href='weekly.html'">ğŸ“Š Weekly Summary</button>
    <button id="sites" class="menu-btn hidden" onclick="location.href='add-site.html'">ğŸ“ Manage Sites</button>
    <button id="vehicles" class="menu-btn hidden" onclick="location.href='vehicles.html'">ğŸš Vehicles</button>
    <button id="mydocuments" class="menu-btn hidden" onclick="location.href='documents.html'">ğŸ“„ My Documents</button>

    <button class="menu-btn" onclick="logout()">ğŸšª Logout</button>
  </div>

  <script>
    // AUTHORISATION BLOCK
    if (sessionStorage.getItem("mostlaneLoggedIn") !== "true") {
      window.location.href = "login.html";
    }

    const loggedInUser = sessionStorage.getItem("mostlaneUsername");

    document.getElementById("user-display").textContent = loggedInUser
      ? "Logged in as: " + loggedInUser.replace(".", " ")
      : "Logged in";

    // STABLE PERMISSION KEYS ONLY (option A)
    const permissionMap = {
      "CheckInOut": "checkin",
      "Holiday": "holiday",
      "PurchaseOrders": "purchaseorders",
      "Assets": "assets",
      "Forms": "forms",
      "Users": "users",
      "Compliance": "compliance",
      "HoursDashboard": "hoursdashboard",
      "Weekly": "weekly",
      "Sites": "sites",
      "Vehicles": "vehicles",
      "MyDocuments": "mydocuments"
    };

    async function loadPermissions() {
      try {
        const res = await fetch("https://mostlane-users.jamie-def.workers.dev/users");
        const data = await res.json();
        const user = data.Users.find(u => u.Username === loggedInUser);

        if (!user) return;

        // Loop through ONLY the stable keys above
        Object.entries(permissionMap).forEach(([jsonKey, btnId]) => {
          const btn = document.getElementById(btnId);

          if (!btn) return;

          if (user[jsonKey] && user[jsonKey].toString().toLowerCase() === "yes") {
            btn.classList.remove("hidden");
          } else {
            btn.classList.add("hidden");
          }
        });
      }
      catch (err) {
        console.error("Permission load error:", err);
      }
    }

    loadPermissions();

    function logout() {
      sessionStorage.clear();
      window.location.href = "login.html";
    }
  </script>
</body>
</html>
