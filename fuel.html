
<!DOCTYPE html>
<html>
<head>
  <title>Fuel & Expenses</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="style.css">
  <style>
    body {
      font-family: "Segoe UI", sans-serif;
      background: #e6e8eb url('Mostlane_Embossed.png') no-repeat center center fixed;
      background-size: 180%;
      padding: 40px 20px;
      color: #003366;
    }
    .form-container {
      background: rgba(255,255,255,0.6);
      padding: 20px;
      border-radius: 10px;
      max-width: 900px;
      margin: auto;
    }
    h1 {
      text-align: center;
      margin-bottom: 30px;
    }
    input, button {
      width: 100%;
      padding: 10px;
      margin: 6px 0;
      border-radius: 6px;
      border: 1px solid #ccc;
    }
    .button {
      background: #004a99;
      color: white;
      cursor: pointer;
    }
    .section {
      margin-bottom: 25px;
    }
    .postcode-entry {
      display: flex;
      gap: 10px;
    }
    .postcode-entry input {
      flex: 1;
    }
  </style>
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCvcvG15HB6XBJBbnHifjL8jZtsSE5m0i4&libraries=places"></script>
</head>
<body>
  <div class="form-container">
    <h1>Fuel & Expenses</h1>
    <div class="section">
      <label>Engineer Name</label>
      <input type="text" id="engineer" readonly>
      <label>Week Commencing</label>
      <input type="date" id="week">
    </div>

    <div class="section">
      <label>Enter Site Postcodes (in order of visit)</label>
      <div id="postcodeList">
        <div class="postcode-entry"><input type="text" class="postcode" placeholder="e.g. BH15 2BS"></div>
      </div>
      <button class="button" onclick="addPostcode()">+ Add Another Site</button>
    </div>

    <div class="section">
      <button class="button" onclick="calculateRoute()">Calculate Mileage</button>
    </div>

    <div class="section">
      <label>Total Mileage (inc. return to PO15 5RQ)</label>
      <input type="text" id="totalMiles" readonly>
      <label>Chargeable Mileage (minus 20 miles)</label>
      <input type="text" id="chargeableMiles" readonly>
      <label>Fuel Claim (£0.25 per mile)</label>
      <input type="text" id="fuelClaim" readonly>
    </div>
  </div>

  <script>
    document.getElementById("engineer").value = sessionStorage.getItem("engineerName") || "";

    function addPostcode() {
      const div = document.createElement("div");
      div.className = "postcode-entry";
      div.innerHTML = '<input type="text" class="postcode" placeholder="e.g. PO12 3AX">';
      document.getElementById("postcodeList").appendChild(div);
    }

    function calculateRoute() {
      const postcodes = Array.from(document.querySelectorAll(".postcode"))
        .map(input => input.value.trim())
        .filter(Boolean);

      if (postcodes.length === 0) {
        alert("Please enter at least one site postcode.");
        return;
      }

      const directionsService = new google.maps.DirectionsService();
      const start = "PO15 5RQ";
      const end = "PO15 5RQ";
      const waypoints = postcodes.map(p => ({ location: p, stopover: true }));

      directionsService.route({
        origin: start,
        destination: end,
        waypoints: waypoints,
        optimizeWaypoints: false,
        travelMode: google.maps.TravelMode.DRIVING
      }, function(response, status) {
        if (status === google.maps.DirectionsStatus.OK) {
          let totalMeters = 0;
          const legs = response.routes[0].legs;
          for (let leg of legs) {
            totalMeters += leg.distance.value;
          }
          const totalMiles = totalMeters / 1609.34;
          const chargeable = Math.max(totalMiles - 20, 0);
          const claim = chargeable * 0.25;

          document.getElementById("totalMiles").value = totalMiles.toFixed(2);
          document.getElementById("chargeableMiles").value = chargeable.toFixed(2);
          document.getElementById("fuelClaim").value = "£" + claim.toFixed(2);
        } else {
          alert("Could not calculate route. Check postcodes and try again.");
        }
      });
    }
  </script>
</body>
</html>
