<!DOCTYPE html>
<html lang="en">
<head>
  <script src="auth.js"></script>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>⚙️ Settings – Mostlane Portal</title>
  <style>
    :root{
      --ml-blue:#003366;
      --ml-blue-2:#004a99;
      --panel-bg:rgba(255,255,255,0.6);
      --text:#1f2937;
      --muted:#6b7280;
      --ok:#0f9d58;
      --warn:#d97706;
      --err:#d32f2f;
      --chip:#eef2f7;
      --radius:12px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: 'Segoe UI', system-ui, -apple-system, Arial, sans-serif;
      color:var(--text);
      background:#e6e8eb url('Mostlane_Embossed.png') no-repeat center/180% fixed;
      min-height:100vh;
    }
    .wrap{
      max-width:1100px;
      margin:20px auto 60px;
      background:var(--panel-bg);
      border-radius:var(--radius);
      box-shadow:0 6px 24px rgba(0,0,0,.15);
      overflow:hidden;
    }
    .topbar{
      display:flex; align-items:center; gap:12px; flex-wrap:wrap;
      padding:16px 18px; background:rgba(255,255,255,.75); border-bottom:1px solid #ddd;
    }
    .title{font-weight:700; font-size:20px; color:var(--ml-blue); flex:1}
    .btn{
      background:var(--ml-blue); color:#fff; border:none; border-radius:8px; padding:10px 14px; font-weight:600; cursor:pointer;
    }
    .btn.alt{background:var(--ml-blue-2)}
    .btn.ghost{background:transparent; color:var(--ml-blue); border:1px solid var(--ml-blue)}
    .userpill{
      background:#fff; border:1px solid #d7dbe3; padding:8px 12px; border-radius:999px; color:#374151; font-size:14px;
    }
    .tabs{
      display:flex; gap:6px; overflow:auto; padding:10px 10px 0; background:rgba(255,255,255,.55);
      border-bottom:1px solid #e5e7eb;
    }
    .tab{
      padding:10px 14px; border:1px solid #cbd5e1; background:#fff; border-bottom:none; border-top-left-radius:10px; border-top-right-radius:10px; cursor:pointer; color:#334155;
      white-space:nowrap;
    }
    .tab.active{ background:#f8fafc; color:var(--ml-blue); font-weight:700; }
    .content{ padding:16px; background:#f8fafc; }
    .grid{
      display:grid; gap:12px;
    }
    @media(min-width:900px){ .grid.cols-2{ grid-template-columns: 1fr 1fr; } }
    .card{
      background:#fff; border:1px solid #e5e7eb; border-radius:12px; padding:16px;
    }
    .card h3{ margin:0 0 10px 0; color:var(--ml-blue) }
    .toolbar{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin-bottom:12px }
    input[type="text"], input[type="password"], input[type="number"], input[type="email"], select, textarea{
      width:100%; padding:10px 12px; border:1px solid #cbd5e1; border-radius:8px; font-size:15px; background:#fff;
    }
    table{
      width:100%; border-collapse:separate; border-spacing:0; border:1px solid #e5e7eb; border-radius:10px; overflow:hidden; background:#fff;
    }
    th, td{ padding:10px 12px; border-bottom:1px solid #eef2f7; font-size:14px; vertical-align:middle }
    th{ background:#f1f5f9; text-align:left; color:#334155 }
    tr:last-child td{ border-bottom:none }
    .chip{ display:inline-block; padding:4px 8px; border-radius:999px; background:var(--chip); font-size:12px; color:#374151; }
    .switch{ position:relative; width:44px; height:24px; background:#cbd5e1; border-radius:999px; cursor:pointer; transition:.2s }
    .switch.on{ background:var(--ml-blue) }
    .switch .knob{ position:absolute; top:2px; left:2px; width:20px; height:20px; background:#fff; border-radius:50%; transition:.2s }
    .switch.on .knob{ left:22px }
    .row-actions{ display:flex; gap:8px; flex-wrap:wrap }
    .note{ color:var(--muted); font-size:13px }
    .matrix{ overflow:auto; }
    .matrix table{ min-width:720px }
    .tag{ font-size:12px; background:#f3f4f6; padding:3px 8px; border-radius:999px; border:1px solid #e5e7eb }
    .radio-group{ display:flex; gap:8px; flex-wrap:wrap }
    /* Modal */
    .backdrop{ position:fixed; inset:0; background:rgba(0,0,0,.45); display:none; align-items:center; justify-content:center; z-index:9999 }
    .modal{ background:#fff; width:min(560px, calc(100% - 24px)); border-radius:12px; padding:16px; box-shadow:0 12px 40px rgba(0,0,0,.25) }
    .modal h3{ margin:0 0 10px 0; color:var(--ml-blue) }
    .modal .actions{ display:flex; gap:10px; justify-content:flex-end; margin-top:12px }
    /* Toast */
    .toast{ position:fixed; bottom:18px; left:50%; transform:translateX(-50%); background:#111827; color:#fff; padding:10px 14px; border-radius:999px; opacity:0; pointer-events:none; transition:.25s; z-index:99999; font-size:14px }
    .toast.show{ opacity:1 }
    /* Mobile tables -> cards (Users & Sites) */
    @media(max-width:700px){
      table.responsive{ display:block }
      table.responsive thead{ display:none }
      table.responsive tbody{ display:grid; gap:10px }
      table.responsive tr{ display:block; border:1px solid #e5e7eb; border-radius:10px; overflow:hidden; background:#fff }
      table.responsive td{ display:flex; justify-content:space-between; gap:10px; border-bottom:1px solid #eef2f7 }
      table.responsive td::before{ content:attr(data-label); font-weight:600; color:#475569 }
      table.responsive tr td:last-child{ border-bottom:none }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <div class="title">⚙️ Settings</div>
      <a class="btn ghost" href="main.html">Main Menu</a>
      <div class="userpill" id="whoami">Signed in: …</div>
    </div>

    <div class="tabs" id="tabs">
      <div class="tab active" data-tab="users">👥 Users</div>
      <div class="tab" data-tab="pages">🌐 Pages</div>
      <div class="tab" data-tab="sites">🏗 Sites</div>
      <div class="tab" data-tab="vehicles">🚐 Vehicles</div>
      <div class="tab" data-tab="system">⚙️ System</div>
    </div>

    <div class="content">
      <!-- USERS -->
      <section id="panel-users">
        <div class="toolbar">
          <input type="text" id="userSearch" placeholder="Search users… (name, username, role)"/>
          <button class="btn" id="btnAddUser">+ Add User</button>
          <label class="chip"><input type="checkbox" id="toggleDeleted" /> Show deleted</label>
        </div>
        <div class="card">
          <h3>All Users</h3>
          <div class="note">Tap Active to toggle; Edit to change details; Delete to soft-delete (restorable).</div>
          <div id="usersTableWrap"></div>
        </div>
      </section>

      <!-- PAGES -->
      <section id="panel-pages" style="display:none">
        <div class="toolbar">
          <button class="btn alt" id="btnReloadPages">Reload Pages</button>
          <span class="chip" id="pagesCount">0 pages</span>
        </div>
        <div class="card">
          <h3>Page Access Matrix</h3>
          <div class="note">Toggle which pages each user can access. Click “Save Changes” to persist.</div>
          <div class="matrix" id="pagesMatrix"></div>
          <div style="margin-top:10px; display:flex; gap:10px; justify-content:flex-end">
            <button class="btn" id="btnSavePermissions">Save Changes</button>
          </div>
        </div>
      </section>

      <!-- SITES -->
      <section id="panel-sites" style="display:none">
        <div class="toolbar">
          <div class="radio-group">
            <label class="tag"><input type="radio" name="siteType" value="retail" checked> Retail</label>
            <label class="tag"><input type="radio" name="siteType" value="els"> ELS</label>
            <label class="tag"><input type="radio" name="siteType" value="wenzels"> Wenzel’s</label>
            <label class="tag"><input type="radio" name="siteType" value="cobra"> COBRA</label>
            <label class="tag"><input type="radio" name="siteType" value="fbc"> FBC</label>
            <label class="tag"><input type="radio" name="siteType" value="misc"> Site</label>
          </div>
          <div style="flex:1"></div>
          <input type="text" id="siteSearch" placeholder="Search sites… (name, code, postcode)"/>
          <button class="btn" id="btnAddSite">+ Add Site</button>
        </div>
        <div class="card">
          <h3>Sites</h3>
          <div id="sitesTableWrap"></div>
        </div>
      </section>

      <!-- VEHICLES (reads from users’ profiles if present) -->
      <section id="panel-vehicles" style="display:none">
        <div class="card">
          <h3>Vehicles</h3>
          <div class="note">If your users JSON includes vehicle assignments, they’ll show here.</div>
          <div id="vehiclesWrap"></div>
        </div>
      </section>

      <!-- SYSTEM -->
      <section id="panel-system" style="display:none">
        <div class="grid cols-2">
          <div class="card">
            <h3>Global Config</h3>
            <label>SharePoint Root Path
              <input type="text" id="cfgSharePoint" placeholder="Mostlane Shared Documents > …"/>
            </label>
            <label>HQ Postcode
              <input type="text" id="cfgPostcode" placeholder="PO15 5RQ"/>
            </label>
            <label>Google Maps API Key
              <input type="password" id="cfgMapsKey" placeholder="••••••••"/>
            </label>
            <div class="grid cols-2">
              <label>VAT Rate %
                <input type="number" id="cfgVAT" step="0.01" placeholder="20"/>
              </label>
              <label>Mileage Rate (£/mile)
                <input type="number" id="cfgMileage" step="0.01" placeholder="0.25"/>
              </label>
            </div>
            <div style="margin-top:12px; display:flex; gap:10px; justify-content:flex-end">
              <button class="btn" id="btnSaveConfig">Save Config</button>
            </div>
            <div class="note" id="cfgNote">Tip: If your Worker doesn’t yet have /update-config, this button will warn you.</div>
          </div>

          <div class="card">
            <h3>Security</h3>
            <div class="note">Later we can enable API key enforcement on your Worker and per-page rate limits.</div>
            <ul>
              <li>Restrict Worker CORS to <strong>mostlane.github.io</strong> (done)</li>
              <li>Session-based access via <strong>auth.js</strong> (already in your portal)</li>
              <li>Optional <strong>x-api-key</strong> header on admin routes (easy to add anytime)</li>
            </ul>
          </div>
        </div>
      </section>
    </div>
  </div>

  <!-- Add/Edit User Modal -->
  <div class="backdrop" id="userModal">
    <div class="modal">
      <h3 id="userModalTitle">Add User</h3>
      <div class="grid cols-2">
        <label>Username
          <input type="text" id="uUsername" placeholder="jamie.line">
        </label>
        <label>Display Name
          <input type="text" id="uDisplay" placeholder="Jamie Line">
        </label>
        <label>Email
          <input type="email" id="uEmail" placeholder="name@mostlane.com">
        </label>
        <label>Role
          <select id="uRole">
            <option>Director</option>
            <option>Admin</option>
            <option>Office</option>
            <option>Field</option>
          </select>
        </label>
        <label>Password (SHA-256 will be stored)
          <input type="password" id="uPassword" placeholder="Leave blank to keep existing">
        </label>
        <label>Active
          <select id="uActive">
            <option value="true">true</option>
            <option value="false">false</option>
          </select>
        </label>
      </div>
      <div class="actions">
        <button class="btn ghost" id="userCancel">Cancel</button>
        <button class="btn" id="userSave">Save</button>
      </div>
    </div>
  </div>

  <!-- Add/Edit Site Modal -->
  <div class="backdrop" id="siteModal">
    <div class="modal">
      <h3 id="siteModalTitle">Add Site</h3>
      <div class="grid cols-2">
        <label>Site Code
          <input type="text" id="sCode" placeholder="0006">
        </label>
        <label>Site Name
          <input type="text" id="sName" placeholder="Co-op Portsmouth Elm Grove">
        </label>
        <label>Postcode
          <input type="text" id="sPostcode" placeholder="PO15 5RQ">
        </label>
        <label>Address
          <input type="text" id="sAddress" placeholder="Unit A5, Segensworth Business Centre">
        </label>
      </div>
      <div class="actions">
        <button class="btn ghost" id="siteCancel">Cancel</button>
        <button class="btn" id="siteSave">Save</button>
      </div>
    </div>
  </div>

  <div class="toast" id="toast">Saved</div>

  <script>
    const WORKER = 'https://mostlane-pos.jamie-def.workers.dev';

    const $ = sel => document.querySelector(sel);
    const $$ = sel => document.querySelectorAll(sel);
    const toast = (msg)=>{ const t=$('#toast'); t.textContent=msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),1800); };

    let currentTab = 'users';
    let allUsers = [];
    let showDeleted = false;
    let pagesList = []; // from /get-pages
    let pageMatrixEdits = {}; // username -> { path: boolean }
    let currentSiteType = 'retail';
    let currentSites = [];

    function dotToSpace(s){ return (s||'').replace(/\./g,' '); }
    function getUser(){ return sessionStorage.getItem('mostlaneUser') || ''; }

    // ---------- Tabs ----------
    $$('#tabs .tab').forEach(tab => {
      tab.addEventListener('click', ()=>{
        $$('#tabs .tab').forEach(t=>t.classList.remove('active'));
        tab.classList.add('active');
        const name = tab.dataset.tab;
        ['users','pages','sites','vehicles','system'].forEach(p=>{
          const el = $('#panel-'+p);
          el.style.display = (p===name)?'block':'none';
        });
        currentTab = name;
        if(name==='pages'){ loadPages(); }
        if(name==='sites'){ loadSites(); }
        if(name==='vehicles'){ renderVehicles(); }
        if(name==='system'){ loadConfig(); }
      });
    });

    // ---------- Init ----------
    document.addEventListener('DOMContentLoaded', async ()=>{
      // Show signed-in user
      const u = getUser();
      $('#whoami').textContent = 'Signed in: ' + (u ? dotToSpace(u) : 'Unknown');

      await loadUsers();
      bindUsersUI();
      bindPagesUI();
      bindSitesUI();
      bindSystemUI();
    });

    // ---------- USERS ----------
    async function loadUsers(){
      const res = await fetch(WORKER + '/get-users', { cache:'no-store' });
      allUsers = await res.json();
      renderUsers();
    }
    function renderUsers(){
      const query = ($('#userSearch').value||'').toLowerCase().trim();
      const filtered = (allUsers||[])
        .filter(u => showDeleted ? true : !u.deleted)
        .filter(u => {
          if(!query) return true;
          return [u.username,u.displayName,u.role,u.email].filter(Boolean).some(x=>x.toLowerCase().includes(query));
        });

      let html = `
        <table class="responsive">
          <thead><tr>
            <th>Username</th><th>Display</th><th>Role</th><th>Active</th><th>Actions</th>
          </tr></thead>
          <tbody>
      `;
      filtered.forEach(u=>{
        const active = !!(u.active ?? true);
        html += `
          <tr>
            <td data-label="Username"><span class="chip">${u.username||''}</span></td>
            <td data-label="Display">${u.displayName||''}</td>
            <td data-label="Role">${u.role||''}</td>
            <td data-label="Active">
              <div class="switch ${active?'on':''}" data-username="${u.username}" data-type="active"><div class="knob"></div></div>
            </td>
            <td data-label="Actions">
              <div class="row-actions">
                <button class="btn ghost" data-act="edit" data-username="${u.username}">Edit</button>
                ${u.deleted
                  ? `<button class="btn" data-act="restore" data-username="${u.username}">Restore</button>`
                  : `<button class="btn alt" data-act="delete" data-username="${u.username}">Delete</button>`
                }
              </div>
            </td>
          </tr>
        `;
      });
      html += `</tbody></table>`;
      $('#usersTableWrap').innerHTML = html;

      // Switch handlers
      $$('#usersTableWrap .switch').forEach(sw=>{
        sw.addEventListener('click', async ()=>{
          const username = sw.dataset.username;
          const on = !sw.classList.contains('on');
          sw.classList.toggle('on', on);
          await saveUser({ username, active:on });
          toast(`User ${username}: active=${on}`);
        });
      });

      // Action buttons
      $$('#usersTableWrap [data-act]').forEach(btn=>{
        btn.addEventListener('click', async ()=>{
          const act = btn.dataset.act;
          const username = btn.dataset.username;
          if(act==='edit'){ openUserModal(username); }
          if(act==='delete'){
            if(!confirm(`Delete ${username}? (Soft delete)`)) return;
            await fetch(WORKER + '/delete-user', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({ username }) });
            await loadUsers(); toast(`Deleted ${username}`);
          }
          if(act==='restore'){
            await fetch(WORKER + '/restore-user', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({ username }) });
            await loadUsers(); toast(`Restored ${username}`);
          }
        });
      });
    }
    function bindUsersUI(){
      $('#userSearch').addEventListener('input', renderUsers);
      $('#toggleDeleted').addEventListener('change', e=>{ showDeleted=e.target.checked; renderUsers(); });
      $('#btnAddUser').addEventListener('click', ()=>openUserModal());
      // Modal controls
      $('#userCancel').addEventListener('click', closeUserModal);
      $('#userModal').addEventListener('click', e=>{ if(e.target.id==='userModal') closeUserModal(); });
      $('#userSave').addEventListener('click', saveUserFromModal);
    }
    function openUserModal(username){
      const isEdit = !!username;
      $('#userModalTitle').textContent = isEdit? 'Edit User' : 'Add User';
      const u = isEdit ? (allUsers.find(x=>x.username===username)||{}) : {};
      $('#uUsername').value = u.username||'';
      $('#uUsername').disabled = isEdit;
      $('#uDisplay').value = u.displayName||'';
      $('#uEmail').value = u.email||'';
      $('#uRole').value = u.role||'Field';
      $('#uPassword').value = '';
      $('#uActive').value = String(u.active ?? true);
      $('#userModal').style.display='flex';
    }
    function closeUserModal(){ $('#userModal').style.display='none'; }

    async function sha256(text){
      const enc = new TextEncoder().encode(text);
      const buf = await crypto.subtle.digest('SHA-256', enc);
      return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,'0')).join('');
    }
    async function saveUserFromModal(){
      const username = $('#uUsername').value.trim();
      const displayName = $('#uDisplay').value.trim();
      const email = $('#uEmail').value.trim();
      const role = $('#uRole').value.trim();
      const active = $('#uActive').value==='true';
      let payload = { username, displayName, email, role, active };

      const pwd = $('#uPassword').value;
      if(pwd){ payload.passwordHash = await sha256(pwd); }

      const isEdit = !!(allUsers.find(x=>x.username===username));
      if(!username){ alert('Username is required'); return; }

      if(isEdit){
        await saveUser(payload);
        toast('User updated');
      }else{
        payload.createdAt = new Date().toISOString();
        await fetch(WORKER + '/add-user', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(payload) });
        toast('User added');
      }
      closeUserModal();
      await loadUsers();
    }
    async function saveUser(patch){
      await fetch(WORKER + '/update-user', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(patch) });
    }

    // ---------- PAGES ----------
    function bindPagesUI(){
      $('#btnReloadPages').addEventListener('click', loadPages);
      $('#btnSavePermissions').addEventListener('click', savePermissions);
    }
    async function loadPages(){
      // Load users & pages
      const [usrRes, pgRes] = await Promise.all([
        fetch(WORKER + '/get-users', { cache:'no-store' }),
        fetch(WORKER + '/get-pages', { cache:'no-store' })
      ]);
      allUsers = await usrRes.json();
      const data = await pgRes.json();
      pagesList = data.pages || [];
      $('#pagesCount').textContent = (pagesList.length||0) + ' pages';
      renderPagesMatrix();
    }
    function renderPagesMatrix(){
      // Build header
      let html = `<table><thead><tr><th>User</th>`;
      pagesList.forEach(p=>{ html += `<th title="${p.path}">${p.name}</th>`; });
      html += `</tr></thead><tbody>`;

      pageMatrixEdits = {};
      (allUsers||[]).filter(u=>!u.deleted).forEach(u=>{
        const perms = (u.permissions && typeof u.permissions==='object') ? u.permissions : {};
        pageMatrixEdits[u.username] = {...perms};
        html += `<tr><td><span class="chip">${u.username}</span></td>`;
        pagesList.forEach(p=>{
          const checked = !!perms[p.path];
          html += `<td style="text-align:center"><input type="checkbox" data-u="${u.username}" data-path="${p.path}" ${checked?'checked':''}></td>`;
        });
        html += `</tr>`;
      });

      html += `</tbody></table>`;
      $('#pagesMatrix').innerHTML = html;

      // Bind checkbox changes
      $$('#pagesMatrix input[type="checkbox"]').forEach(ch=>{
        ch.addEventListener('change', ()=>{
          const uname = ch.dataset.u;
          const path = ch.dataset.path;
          pageMatrixEdits[uname] = pageMatrixEdits[uname] || {};
          pageMatrixEdits[uname][path] = ch.checked;
        });
      });
    }
    async function savePermissions(){
      const ops = [];
      Object.keys(pageMatrixEdits).forEach(username=>{
        ops.push(fetch(WORKER + '/update-user', {
          method:'POST', headers:{'Content-Type':'application/json'},
          body:JSON.stringify({ username, permissions: pageMatrixEdits[username] })
        }));
      });
      await Promise.all(ops);
      toast('Permissions saved');
    }

    // ---------- SITES ----------
    function bindSitesUI(){
      $$('input[name="siteType"]').forEach(r=>{
        r.addEventListener('change', async ()=>{
          currentSiteType = r.value;
          await loadSites();
        });
      });
      $('#siteSearch').addEventListener('input', renderSites);
      $('#btnAddSite').addEventListener('click', ()=>openSiteModal());
      // Modal controls
      $('#siteCancel').addEventListener('click', closeSiteModal);
      $('#siteModal').addEventListener('click', e=>{ if(e.target.id==='siteModal') closeSiteModal(); });
      $('#siteSave').addEventListener('click', saveSiteFromModal);
    }
    async function loadSites(){
      const res = await fetch(`${WORKER}/get-sites?type=${encodeURIComponent(currentSiteType)}`, { cache:'no-store' });
      currentSites = await res.json();
      renderSites();
    }
    function renderSites(){
      const q = ($('#siteSearch').value||'').toLowerCase().trim();
      const filtered = (currentSites||[]).filter(s=>{
        if(!q) return true;
        return [s.siteCode,s.siteName,s.postcode,s.address].filter(Boolean).some(x=>x.toLowerCase().includes(q));
      });

      let html = `
        <table class="responsive">
          <thead><tr>
            <th>Code</th><th>Name</th><th>Postcode</th><th>Address</th><th>Actions</th>
          </tr></thead><tbody>
      `;
      filtered.forEach(s=>{
        html += `
          <tr>
            <td data-label="Code"><span class="chip">${s.siteCode||''}</span></td>
            <td data-label="Name">${s.siteName||''}</td>
            <td data-label="Postcode">${s.postcode||''}</td>
            <td data-label="Address">${s.address||''}</td>
            <td data-label="Actions">
              <div class="row-actions">
                <button class="btn ghost" data-sact="edit" data-code="${s.siteCode||''}">Edit</button>
                <button class="btn alt" data-sact="delete" data-code="${s.siteCode||''}">Delete</button>
              </div>
            </td>
          </tr>
        `;
      });
      html += `</tbody></table>`;
      $('#sitesTableWrap').innerHTML = html;

      $$('#sitesTableWrap [data-sact]').forEach(b=>{
        b.addEventListener('click', async ()=>{
          const act = b.dataset.sact;
          const code = b.dataset.code;
          const rec = (currentSites||[]).find(s=>s.siteCode===code) || {};
          if(act==='edit'){ openSiteModal(rec); }
          if(act==='delete'){
            if(!confirm(`Delete site ${code}? (Soft delete)`)) return;
            await fetch(`${WORKER}/delete-site?type=${encodeURIComponent(currentSiteType)}`, {
              method:'POST', headers:{'Content-Type':'application/json'},
              body:JSON.stringify({ siteCode: code })
            });
            await loadSites(); toast(`Deleted ${code}`);
          }
        });
      });
    }
    function openSiteModal(rec){
      const isEdit = !!rec;
      $('#siteModalTitle').textContent = isEdit ? 'Edit Site' : 'Add Site';
      $('#sCode').value = rec?.siteCode || '';
      $('#sCode').disabled = !!rec?.siteCode;
      $('#sName').value = rec?.siteName || '';
      $('#sPostcode').value = rec?.postcode || '';
      $('#sAddress').value = rec?.address || '';
      $('#siteModal').style.display = 'flex';
    }
    function closeSiteModal(){ $('#siteModal').style.display='none'; }
    async function saveSiteFromModal(){
      const body = {
        siteCode: $('#sCode').value.trim(),
        siteName: $('#sName').value.trim(),
        postcode: $('#sPostcode').value.trim(),
        address: $('#sAddress').value.trim()
      };
      if(!body.siteCode || !body.siteName){ alert('Site Code & Name required'); return; }

      const isEdit = !!(currentSites.find(s=>s.siteCode===body.siteCode));
      const url = isEdit ? `${WORKER}/update-site?type=${encodeURIComponent(currentSiteType)}` :
                           `${WORKER}/add-site?type=${encodeURIComponent(currentSiteType)}`;
      await fetch(url, { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(body) });
      closeSiteModal(); await loadSites(); toast(isEdit?'Site updated':'Site added');
    }

    // ---------- VEHICLES ----------
    function renderVehicles(){
      // If vehicles are embedded in users (e.g., user.vehicleReg), map them:
      const rows = [];
      (allUsers||[]).forEach(u=>{
        const reg = u.vehicleReg || u.vehicle || '';
        if(reg){
          rows.push(`<tr>
            <td data-label="User"><span class="chip">${u.username}</span></td>
            <td data-label="Vehicle">${reg}</td>
            <td data-label="Role">${u.role||''}</td>
            <td data-label="Active">${(u.active??true)?'Yes':'No'}</td>
          </tr>`);
        }
      });
      const html = rows.length
        ? `<table class="responsive">
            <thead><tr><th>User</th><th>Vehicle</th><th>Role</th><th>Active</th></tr></thead>
            <tbody>${rows.join('')}</tbody>
           </table>`
        : `<div class="note">No vehicle assignments found in user records (fields like <code>vehicleReg</code>).</div>`;
      $('#vehiclesWrap').innerHTML = html;
    }

    // ---------- SYSTEM ----------
    function bindSystemUI(){
      $('#btnSaveConfig').addEventListener('click', saveConfig);
    }
    async function loadConfig(){
      try{
        const res = await fetch(WORKER + '/get-config', { cache:'no-store' });
        const cfg = await res.json();
        $('#cfgSharePoint').value = cfg.sharepointRoot || '';
        $('#cfgPostcode').value = cfg.hqPostcode || '';
        $('#cfgMapsKey').value = cfg.mapsApiKey || '';
        $('#cfgVAT').value = (cfg.vatRate ?? 20);
        $('#cfgMileage').value = (cfg.mileageRate ?? 0.25);
      }catch(e){
        // silently ignore
      }
    }
    async function saveConfig(){
      const cfg = {
        sharepointRoot: $('#cfgSharePoint').value.trim(),
        hqPostcode: $('#cfgPostcode').value.trim(),
        mapsApiKey: $('#cfgMapsKey').value.trim(),
        vatRate: parseFloat($('#cfgVAT').value || '20'),
        mileageRate: parseFloat($('#cfgMileage').value || '0.25'),
        updatedAt: new Date().toISOString()
      };
      try{
        const res = await fetch(WORKER + '/update-config', {
          method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(cfg)
        });
        if(res.ok){ toast('Config saved'); }
        else{ toast('Your Worker has no /update-config yet'); alert('Add /update-config in Worker to save.'); }
      }catch(err){ toast('Failed to save'); }
    }
  </script>
</body>
</html>
