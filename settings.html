<!DOCTYPE html>
<html lang="en">
<head>
  <script src="auth.js"></script>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>‚öôÔ∏è Settings ‚Äì Mostlane Portal</title>
  <style>
    :root{
      --ml-blue:#003366;
      --ml-blue-2:#004a99;
      --panel-bg:rgba(255,255,255,0.6);
      --text:#1f2937;
      --muted:#6b7280;
      --ok:#0f9d58;
      --warn:#d97706;
      --err:#d32f2f;
      --chip:#eef2f7;
      --radius:12px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: 'Segoe UI', system-ui, -apple-system, Arial, sans-serif;
      color:var(--text);
      background:#e6e8eb url('Mostlane_Embossed.png') no-repeat center/180% fixed;
      min-height:100vh;
    }
    .wrap{
      max-width:1100px;
      margin:20px auto 60px;
      background:var(--panel-bg);
      border-radius:var(--radius);
      box-shadow:0 6px 24px rgba(0,0,0,.15);
      overflow:hidden;
    }
    .topbar{
      display:flex; align-items:center; gap:12px; flex-wrap:wrap;
      padding:16px 18px; background:rgba(255,255,255,.75); border-bottom:1px solid #ddd;
    }
    .title{font-weight:700; font-size:20px; color:var(--ml-blue); flex:1}
    .btn{
      background:var(--ml-blue); color:#fff; border:none; border-radius:8px; padding:10px 14px; font-weight:600; cursor:pointer;
    }
    .btn.alt{background:var(--ml-blue-2)}
    .btn.ghost{background:transparent; color:var(--ml-blue); border:1px solid var(--ml-blue)}
    .userpill{
      background:#fff; border:1px solid #d7dbe3; padding:8px 12px; border-radius:999px; color:#374151; font-size:14px;
    }
    .tabs{
      display:flex; gap:6px; overflow:auto; padding:10px 10px 0; background:rgba(255,255,255,.55);
      border-bottom:1px solid #e5e7eb;
    }
    .tab{
      padding:10px 14px; border:1px solid #cbd5e1; background:#fff; border-bottom:none; border-top-left-radius:10px; border-top-right-radius:10px; cursor:pointer; color:#334155;
      white-space:nowrap;
    }
    .tab.active{ background:#f8fafc; color:var(--ml-blue); font-weight:700; }
    .content{ padding:16px; background:#f8fafc; }
    .grid{
      display:grid; gap:12px;
    }
    @media(min-width:900px){ .grid.cols-2{ grid-template-columns: 1fr 1fr; } }
    .card{
      background:#fff; border:1px solid #e5e7eb; border-radius:12px; padding:16px;
    }
    .card h3{ margin:0 0 10px 0; color:var(--ml-blue) }
    .toolbar{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin-bottom:12px }
    input[type="text"], input[type="password"], input[type="number"], input[type="email"], select, textarea{
      width:100%; padding:10px 12px; border:1px solid #cbd5e1; border-radius:8px; font-size:15px; background:#fff;
    }
    table{
      width:100%; border-collapse:separate; border-spacing:0; border:1px solid #e5e7eb; border-radius:10px; overflow:hidden; background:#fff;
    }
    th, td{ padding:10px 12px; border-bottom:1px solid #eef2f7; font-size:14px; vertical-align:middle }
    th{ background:#f1f5f9; text-align:left; color:#334155 }
    tr:last-child td{ border-bottom:none }
    .chip{ display:inline-block; padding:4px 8px; border-radius:999px; background:var(--chip); font-size:12px; color:#374151; }
    .switch{ position:relative; width:44px; height:24px; background:#cbd5e1; border-radius:999px; cursor:pointer; transition:.2s }
    .switch.on{ background:var(--ml-blue) }
    .switch .knob{ position:absolute; top:2px; left:2px; width:20px; height:20px; background:#fff; border-radius:50%; transition:.2s }
    .switch.on .knob{ left:22px }
    .row-actions{ display:flex; gap:8px; flex-wrap:wrap }
    .note{ color:var(--muted); font-size:13px }
    .matrix{ overflow:auto; }
    .matrix table{ min-width:720px }
    .tag{ font-size:12px; background:#f3f4f6; padding:3px 8px; border-radius:999px; border:1px solid #e5e7eb }
    .radio-group{ display:flex; gap:8px; flex-wrap:wrap }
    .backdrop{ position:fixed; inset:0; background:rgba(0,0,0,.45); display:none; align-items:center; justify-content:center; z-index:9999 }
    .modal{ background:#fff; width:min(560px, calc(100% - 24px)); border-radius:12px; padding:16px; box-shadow:0 12px 40px rgba(0,0,0,.25) }
    .modal h3{ margin:0 0 10px 0; color:var(--ml-blue) }
    .modal .actions{ display:flex; gap:10px; justify-content:flex-end; margin-top:12px }
    .toast{ position:fixed; bottom:18px; left:50%; transform:translateX(-50%); background:#111827; color:#fff; padding:10px 14px; border-radius:999px; opacity:0; pointer-events:none; transition:.25s; z-index:99999; font-size:14px }
    .toast.show{ opacity:1 }
    @media(max-width:700px){
      table.responsive{ display:block }
      table.responsive thead{ display:none }
      table.responsive tbody{ display:grid; gap:10px }
      table.responsive tr{ display:block; border:1px solid #e5e7eb; border-radius:10px; overflow:hidden; background:#fff }
      table.responsive td{ display:flex; justify-content:space-between; gap:10px; border-bottom:1px solid #eef2f7 }
      table.responsive td::before{ content:attr(data-label); font-weight:600; color:#475569 }
      table.responsive tr td:last-child{ border-bottom:none }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <div class="title">‚öôÔ∏è Settings</div>
      <a class="btn ghost" href="main.html">Main Menu</a>
      <div class="userpill" id="whoami">Signed in: ‚Ä¶</div>
    </div>

    <div class="tabs" id="tabs">
      <div class="tab active" data-tab="users">üë• Users</div>
      <div class="tab" data-tab="pages">üåê Pages</div>
      <div class="tab" data-tab="sites">üèó Sites</div>
      <div class="tab" data-tab="vehicles">üöê Vehicles</div>
      <div class="tab" data-tab="system">‚öôÔ∏è System</div>
    </div>

    <div class="content">
      <!-- USERS -->
      <section id="panel-users">
        <div class="toolbar">
          <input type="text" id="userSearch" placeholder="Search users‚Ä¶ (name, username, role)"/>
          <button class="btn" id="btnAddUser">+ Add User</button>
          <label class="chip"><input type="checkbox" id="toggleDeleted" /> Show deleted</label>
        </div>
        <div class="card">
          <h3>All Users</h3>
          <div class="note">Tap Active to toggle; Edit to change details; Delete to soft-delete (restorable).</div>
          <div id="usersTableWrap"></div>
        </div>
      </section>

      <!-- other tabs unchanged (Pages, Sites, Vehicles, System) -->
      <section id="panel-pages" style="display:none"><div class="card"><h3>Pages</h3><div class="note">Page permissions coming next build.</div></div></section>
      <section id="panel-sites" style="display:none"><div class="card"><h3>Sites</h3><div id="sitesTableWrap" class="note">Will load per JSON type.</div></div></section>
      <section id="panel-vehicles" style="display:none"><div class="card"><h3>Vehicles</h3><div id="vehiclesWrap" class="note">Linked from users‚Äô vehicle assignments.</div></div></section>
      <section id="panel-system" style="display:none"><div class="card"><h3>System Config</h3><div class="note">Central portal configuration options go here.</div></div></section>
    </div>
  </div>

  <div class="toast" id="toast">Saved</div>

  <script>
    const WORKER='https://mostlane-pos.jamie-def.workers.dev';
    const $=s=>document.querySelector(s);
    const $$=s=>document.querySelectorAll(s);
    const toast=msg=>{const t=$('#toast');t.textContent=msg;t.classList.add('show');setTimeout(()=>t.classList.remove('show'),1800);};

    let allUsers=[],showDeleted=false;

    document.addEventListener('DOMContentLoaded',async()=>{
      const u=sessionStorage.getItem('mostlaneUser')||'';
      $('#whoami').textContent='Signed in: '+(u||'Unknown');
      await loadUsers();
    });

    async function loadUsers(){
      const res=await fetch(WORKER+'/get-users',{cache:'no-store'});
      allUsers=await res.json();
      renderUsers();
    }

    function renderUsers(){
      const q=($('#userSearch').value||'').toLowerCase().trim();
      const filtered=(allUsers||[])
        .filter(u=>showDeleted?true:!u.deleted)
        .filter(u=>{
          if(!q)return true;
          return [u.Username,u.FirstName,u.LastName,u.Email,u.EmploymentType].filter(Boolean).some(x=>x.toLowerCase().includes(q));
        });

      let html=`<table class="responsive"><thead><tr>
      <th>Username</th><th>Name</th><th>Employment</th><th>Status</th><th>Vehicle</th><th>Actions</th>
      </tr></thead><tbody>`;

      filtered.forEach(u=>{
        const username=u.Username||'';
        const name=[u.FirstName,u.LastName].filter(Boolean).join(' ');
        const employment=u.EmploymentType||'';
        const status=u.Status||'';
        const vehicle=u.VehicleAssigned||'';
        html+=`
        <tr>
          <td data-label="Username"><span class="chip">${username}</span></td>
          <td data-label="Name">${name}</td>
          <td data-label="Employment">${employment}</td>
          <td data-label="Status">${status}</td>
          <td data-label="Vehicle">${vehicle}</td>
          <td data-label="Actions">
            <div class="row-actions">
              <button class="btn ghost" data-act="edit" data-username="${username}">Edit</button>
              ${status.toLowerCase()==='active'
                ?`<button class="btn alt" data-act="deactivate" data-username="${username}">Deactivate</button>`
                :`<button class="btn" data-act="activate" data-username="${username}">Activate</button>`}
            </div>
          </td>
        </tr>`;
      });
      html+=`</tbody></table>`;
      $('#usersTableWrap').innerHTML=html;

      $$('#usersTableWrap [data-act]').forEach(b=>{
        b.addEventListener('click',()=>{
          const act=b.dataset.act,uname=b.dataset.username;
          toast(`Clicked ${act} on ${uname}`);
        });
      });
    }

    $('#userSearch').addEventListener('input',renderUsers);
    $('#toggleDeleted').addEventListener('change',e=>{showDeleted=e.target.checked;renderUsers();});
  </script>
</body>
</html>
