<!DOCTYPE html>

<html>
<head>
<script src="auth.js"></script>
<meta charset="utf-8"/>
<title>Add Site Location</title>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<style>
    body {
      margin: 0;
      padding: 0;
      background: #e6e8eb url('Mostlane_Embossed.png') no-repeat center center fixed;
      background-size: cover;
      font-family: 'Segoe UI', sans-serif;
    }
    .container {
      max-width: 600px;
      margin: 40px auto;
      background: rgba(255,255,255,0.95);
      padding: 25px;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    h2 {
      color: #004a99;
      margin-bottom: 20px;
    }
    label {
      display: block;
      margin-top: 15px;
      font-weight: bold;
    }
    input[type="text"], input[type="number"] {
      width: 100%;
      padding: 8px;
      margin-top: 5px;
      border-radius: 6px;
      border: 1px solid #ccc;
    }
    button {
      background: #004a99;
      color: white;
      padding: 10px 20px;
      border: none;
      border-radius: 6px;
      font-size: 16px;
      margin-top: 20px;
    }
    #map {
      height: 300px;
      margin-top: 15px;
      border-radius: 6px;
    }
    .hidden { display: none; }
    .distanceBox {
      margin-top: 10px;
      font-weight: bold;
      color: #004a99;
    }
  </style>
</head>
<body>
<div class="container" id="formContainer">
<h2>Add New Site Location</h2>
<form id="siteForm">
<label for="siteName">Site Name</label>
<input id="siteName" name="siteName" required="" type="text"/><label for="siteType">Site Type</label><select id="siteType" name="siteType" required=""><option value="Retail">Retail</option><option value="ELS">ELS</option><option value="COBRA">COBRA</option><option value="Wenzel’s">Wenzel’s</option><option value="Site">Site</option></select>
<label for="postcodeLookup">Search Postcode</label>
<input id="postcodeLookup" placeholder="e.g. PO15 5RQ" type="text"/>
<button onclick="lookupPostcode()" type="button">Find on Map</button>
<label for="streetAddress">Street Address</label>
<input id="streetAddress" name="streetAddress" readonly="" required="" type="text"/>
<label for="postcodeField">Postcode</label>
<input id="postcodeField" name="postcode" readonly="" required="" type="text"/>
<label for="latitude">Latitude</label>
<input id="latitude" name="latitude" readonly="" required="" type="text"/>
<label for="longitude">Longitude</label>
<input id="longitude" name="longitude" readonly="" required="" type="text"/>
<input id="mileageFromHQ" name="mileageFromHQ" type="hidden"/>
<input id="driveTime" name="driveTime" type="hidden"/>
<p style="margin-top:10px; font-weight:bold;">Starting Postcode: PO15 5RQ</p>
<div id="map" style="height:300px; min-height:300px; background:#f0f0f0; border-radius:6px;"></div>
<button onclick="calculateDistance()" type="button">Calculate Mileage</button>
<div class="distanceBox" id="distanceOutput"></div>
<button type="submit">Submit Site</button>
</form>
</div>
<div class="container hidden" id="blockedContainer">
<h2>Access Denied</h2>
<p>This page is only available to office staff.</p>
</div>
<script>
  let map, marker = null, destination = null;
  let hq;

  function getPostcodeFromComponents(components) {
    const pc = components.find(c => c.types && c.types.indexOf("postal_code") !== -1);
    return pc ? pc.long_name : "";
  }

  function stripPostcodeFromAddress(formatted, postcode) {
    if (!postcode) return formatted;
    try {
      const esc = postcode.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
      const re = new RegExp(esc, 'i');
      let s = formatted.replace(re, '').replace(/\s{2,}/g, ' ');
      s = s.replace(/\s,\s/g, ', ').replace(/,\s*,/g, ',').replace(/\s*,\s*$/,'').trim();
      return s;
    } catch(e) {
      return formatted;
    }
  }

  function initMap() {
    hq = new google.maps.LatLng(50.861735, -1.247463);
    map = new google.maps.Map(document.getElementById("map"), {
      center: hq,
      zoom: 8
    });

    map.addListener("click", (e) => {
      const lat = e.latLng.lat().toFixed(6);
      const lng = e.latLng.lng().toFixed(6);
      document.getElementById("latitude").value = lat;
      document.getElementById("longitude").value = lng;

      destination = new google.maps.LatLng(parseFloat(lat), parseFloat(lng));
      placeMarker(destination);
      calculateDistance();

      const geocoder = new google.maps.Geocoder();
      geocoder.geocode({ location: destination }, (results, status) => {
        if (status === "OK" && results[0]) {
          const postcode = getPostcodeFromComponents(results[0].address_components);
          document.getElementById("postcodeField").value = postcode;
          const addr = stripPostcodeFromAddress(results[0].formatted_address, postcode);
          document.getElementById("streetAddress").value = addr;
        }
      });
    });
  }

  function placeMarker(location) {
    if (marker) marker.setMap(null);
    marker = new google.maps.Marker({ position: location, map: map });
  }

  function lookupPostcode() {
    const postcode = document.getElementById("postcodeLookup").value;
    const geocoder = new google.maps.Geocoder();
    geocoder.geocode({ address: postcode }, (results, status) => {
      if (status === "OK") {
        const result = results[0];
        map.setCenter(result.geometry.location);
        map.setZoom(14);

        const pc = getPostcodeFromComponents(result.address_components);
        document.getElementById("postcodeField").value = pc;
        const addr = stripPostcodeFromAddress(result.formatted_address, pc);
        document.getElementById("streetAddress").value = addr;

        document.getElementById("latitude").value = result.geometry.location.lat().toFixed(6);
        document.getElementById("longitude").value = result.geometry.location.lng().toFixed(6);
      } else {
        alert("Postcode not found: " + status);
      }
    });
  }

  function calculateDistance() {
    if (!destination || !hq) return;
    const service = new google.maps.DistanceMatrixService();
    service.getDistanceMatrix({
      origins: [hq],
      destinations: [destination],
      travelMode: 'DRIVING'
    }, (res, status) => {
      if (status === "OK") {
        const element = res.rows[0].elements[0];
        if (element.status === "OK") {
          const miles = (element.distance.value / 1609.34).toFixed(1);
          const duration = element.duration.text;
          document.getElementById("distanceOutput").innerText =
            `Distance from Mostlane Office: ${miles} miles (${duration})`;
          document.getElementById("mileageFromHQ").value = miles;
          document.getElementById("driveTime").value = duration;
        }
      }
    });
  }

  document.getElementById("siteForm").addEventListener("submit", function(e) {
    e.preventDefault();

    const siteName = document.getElementById("siteName").value;
    const siteType = document.getElementById("siteType").value;
    const streetAddress = document.getElementById("streetAddress").value;
    const postcode = document.getElementById("postcodeField").value;
    const latitude = document.getElementById("latitude").value;
    const longitude = document.getElementById("longitude").value;
    const mileage = document.getElementById("mileageFromHQ").value;
    const driveTime = document.getElementById("driveTime").value;

    const formData = new URLSearchParams();
    formData.append("siteName", siteName);
    formData.append("siteType", siteType);
    formData.append("streetAddress", streetAddress);
    formData.append("postcode", postcode);
    formData.append("latitude", latitude);
    formData.append("longitude", longitude);
    formData.append("mileageFromHQ", mileage);
    formData.append("driveTime", driveTime);

    fetch("https://hooks.zapier.com/hooks/catch/20261714/2nxko8i/", {
      method: "POST",
      headers: { "Content-Type": "application/x-www-form-urlencoded" },
      body: formData.toString()
    })
    .then(r => r.json())
    .then(data => {
      sessionStorage.setItem("lastJobNumber", data.jobNumber || "N/A");
      sessionStorage.setItem("lastSiteName", data.siteName || siteName);
      sessionStorage.setItem("lastStreetAddress", data.streetAddress || streetAddress);
      sessionStorage.setItem("lastPostcode", data.postcode || postcode);
      sessionStorage.setItem("lastLatitude", data.latitude || latitude);
      sessionStorage.setItem("lastLongitude", data.longitude || longitude);
      sessionStorage.setItem("lastMileage", data.mileageFromHQ || mileage);
      sessionStorage.setItem("lastDriveTime", data.driveTime || driveTime);
      window.location.href = "site-added.html";
    })
    .catch(err => {
      alert("Failed to submit. Please try again.");
      console.error(err);
    });
  });
</script>
<script async="" defer="" id="mapsScript" src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAGqOm3qfyYqOx7WXhMzyNZ7kcKNlcWgQM&amp;callback=initMap">
</script>
</body>
</html>