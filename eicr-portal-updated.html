<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Mostlane Compliance Portal</title>
  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background-image: url('Mostlane_Embossed.png');
      background-size: cover;
      background-attachment: fixed;
      background-repeat: no-repeat;
      background-position: center;
    }
    .header {
      background-color: rgba(0, 73, 133, 0.9);
      padding: 20px;
      text-align: center;
      position: relative;
    }
    .header img {
      height: 60px;
    }
    .header h1 {
      color: white;
      margin: 10px 0 0;
      font-size: 28px;
    }
    .summary {
      display: flex;
      justify-content: space-around;
      flex-wrap: wrap;
      padding: 20px;
      background: rgba(255, 255, 255, 0.9);
    }
    .summary div {
      flex: 1;
      min-width: 140px;
      margin: 10px;
      padding: 15px;
      border-radius: 12px;
      text-align: center;
      font-weight: bold;
      color: white;
    }
    .green { background-color: #4CAF50; }
    .red { background-color: #F44336; }
    .blue { background-color: #2196F3; }
    .orange { background-color: #FF9800; }
    .table-container {
      padding: 20px;
      background: rgba(255, 255, 255, 0.95);
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }
    th, td {
      padding: 10px;
      border-bottom: 1px solid #ddd;
      text-align: left;
    }
    th {
      background-color: #004985;
      color: white;
      position: sticky;
      top: 0;
    }
    tr:hover {
      background-color: #f1f1f1;
    }
    .search-container {
      text-align: center;
      padding: 15px;
    }
    .search-container input {
      padding: 10px;
      width: 300px;
      font-size: 16px;
      border-radius: 6px;
      border: 1px solid #ccc;
    }
    a {
      color: #004985;
      text-decoration: underline;
    }
  </style>
</head>
<body>
  <div class="header">
    <img src="mostlane-logo.jpeg" alt="Mostlane Logo" />
    <h1>Compliance Portal</h1>
  </div>

  <div class="summary" id="summary">
    <!-- Summary boxes dynamically added -->
  </div>

  <div class="search-container">
    <input type="text" id="searchBox" placeholder="Search by store number, site name, or postcode" />
  </div>

  <div class="table-container">
    <table id="complianceTable">
      <thead>
        <tr>
          <th>Store Number</th>
          <th>Site Name</th>
          <th>Postcode</th>
          <th>EICR Due</th>
          <th>PAT Due</th>
          <th>Forecourt Due</th>
          <th>EM Lights Due</th>
          <th>EV Due</th>
          <th>PV Due</th>
          <th>Outcome</th>
          <th>Report</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <script>
    async function loadData() {
      const res = await fetch('eicr-log.json');
      const data = await res.json();
      const table = document.querySelector('#complianceTable tbody');
      const summary = {
        satisfactory: 0,
        unsatisfactory: 0,
        due30: 0,
        due90: 0,
        due365: 0
      };
      const today = new Date();

      data.forEach(site => {
        const tr = document.createElement('tr');
        const createDateCell = (dateStr) => {
          if (!dateStr) return '';
          const d = new Date(dateStr);
          return `${d.getDate().toString().padStart(2,'0')}/${(d.getMonth()+1).toString().padStart(2,'0')}/${d.getFullYear()}`;
        };
        const dateCheck = (d) => {
          if (!d) return;
          const date = new Date(d);
          const diff = (date - today) / (1000 * 60 * 60 * 24);
          if (diff < 0) return;
          if (diff <= 30) summary.due30++;
          if (diff <= 90) summary.due90++;
          if (diff <= 365) summary.due365++;
        };

        tr.innerHTML = `
          <td>${site.storeNumber}</td>
          <td>${site.siteName}</td>
          <td>${site.postcode || ''}</td>
          <td>${createDateCell(site.fiveYrDueDate)}</td>
          <td>${createDateCell(site.patDueDate)}</td>
          <td>${createDateCell(site.forecourtDueDate)}</td>
          <td>${createDateCell(site.emDueDate)}</td>
          <td>${createDateCell(site.evDueDate)}</td>
          <td>${createDateCell(site.pvDueDate)}</td>
          <td>${site.outcome || ''}</td>
          <td>${site.reportURL ? `<a href="${site.reportURL}" target="_blank">View</a>` : ''}</td>
        `;

        ['fiveYrDueDate','patDueDate','forecourtDueDate','emDueDate','evDueDate','pvDueDate'].forEach(f => dateCheck(site[f]));
        if (site.outcome?.toLowerCase().includes('satisfactory')) summary.satisfactory++;
        if (site.outcome?.toLowerCase().includes('unsatisfactory')) summary.unsatisfactory++;
        table.appendChild(tr);
      });

      document.getElementById('summary').innerHTML = `
        <div class="green">Satisfactory: ${summary.satisfactory}</div>
        <div class="red">Unsatisfactory: ${summary.unsatisfactory}</div>
        <div class="blue">Due in 30 Days: ${summary.due30}</div>
        <div class="orange">Due in 90 Days: ${summary.due90}</div>
        <div class="blue">Due in 365 Days: ${summary.due365}</div>
      `;
    }

    document.getElementById('searchBox').addEventListener('input', function () {
      const val = this.value.toLowerCase();
      document.querySelectorAll('#complianceTable tbody tr').forEach(row => {
        const match = [...row.children].some(td => td.textContent.toLowerCase().includes(val));
        row.style.display = match ? '' : 'none';
      });
    });

    loadData();
  </script>
</body>
</html>
