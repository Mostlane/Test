<!DOCTYPE html>
<html lang="en">
<head>
  <script src="auth.js"></script>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Projects Admin – Mostlane</title>

  <style>
    body{
      margin:0;
      font-family:"Segoe UI",system-ui,-apple-system,Arial,sans-serif;
      background:#e6e8eb url('Mostlane_Embossed.png') no-repeat center center fixed;
      background-size:cover;
      color:#1f2937;
    }

    .topbar{
      position:sticky; top:0; z-index:10;
      background:rgba(255,255,255,.75);
      backdrop-filter:blur(6px);
      box-shadow:0 2px 10px rgba(0,0,0,.08);
      padding:10px 14px;
      display:flex;
      justify-content:space-between;
      align-items:center;
    }

    .btn{
      border:none;
      border-radius:10px;
      padding:10px 14px;
      font-size:14px;
      font-weight:600;
      cursor:pointer;
    }
    .btn-outline{background:#fff;border:1px solid #004a99;color:#004a99}
    .btn-primary{background:#004a99;color:#fff}
    .btn-warn{background:#8a5a00;color:#fff}
    .btn-danger{background:#7f1d1d;color:#fff}

    .wrap{
      max-width:1200px;
      margin:16px auto 70px;
      padding:14px;
      background:rgba(255,255,255,.7);
      border-radius:12px;
    }

    .grid{
      display:grid;
      gap:12px;
      grid-template-columns:1fr 1.2fr;
    }
    @media(max-width:900px){
      .grid{grid-template-columns:1fr}
    }

    .card{
      background:#fff;
      border:1px solid #e5e7eb;
      border-radius:12px;
      padding:14px;
    }

    .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .input{
      padding:10px;
      border:1px solid #d1d5db;
      border-radius:8px;
      font-size:14px;
    }
    select.input{background:#fff}

    .muted{font-size:12px;color:#6b7280}

    .proj-row{
      padding:12px;
      border:1px solid #e5e7eb;
      border-radius:12px;
      margin-top:10px;
      cursor:pointer;
      background:#fff;
    }
    .proj-row.active{border-color:#004a99;background:#f0f6ff}

    .pill{
      display:inline-block;
      padding:4px 10px;
      border-radius:999px;
      font-size:12px;
      border:1px solid #d1d5db;
      background:#f9fafb;
    }
    .pill.active{background:#ecfdf5;color:#166534;border-color:#86efac}
    .pill.archived{background:#fef2f2;color:#991b1b;border-color:#fecaca}
    .pill.hidden{background:#fef2f2;color:#991b1b;border-color:#fecaca}
    .pill.section{background:#fff;border-style:dashed}

    table{
      width:100%;
      border-collapse:collapse;
      margin-top:12px;
    }
    th,td{
      padding:10px;
      border-bottom:1px solid #e5e7eb;
      font-size:14px;
      text-align:left;
      vertical-align:top;
    }
    th{
      font-size:12px;
      text-transform:uppercase;
      color:#374151;
      letter-spacing:.04em;
    }
    .actions{display:flex;gap:8px;flex-wrap:wrap}

    /* ===== Modal ===== */
    .modal{
      position:fixed; inset:0;
      display:none;
      background:rgba(0,0,0,.55);
      z-index:60;
    }
    .modal.show{display:flex}
    .modal-box{
      background:#fff;
      width:min(760px, 92%);
      margin:auto;
      border-radius:14px;
      box-shadow:0 20px 40px rgba(0,0,0,.25);
      overflow:hidden;
    }
    .modal-head{
      padding:12px 14px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      border-bottom:1px solid #e5e7eb;
    }
    .modal-body{padding:14px}
    .modal-foot{
      padding:12px 14px;
      border-top:1px solid #e5e7eb;
      display:flex;
      gap:10px;
      justify-content:flex-end;
      flex-wrap:wrap;
    }
    .field{
      display:grid;
      grid-template-columns:160px 1fr;
      gap:10px;
      align-items:center;
      margin:10px 0;
    }
    @media(max-width:620px){
      .field{grid-template-columns:1fr}
    }
  </style>
</head>

<body>

<div class="topbar">
  <div class="row">
    <button class="btn btn-outline" onclick="location.href='main.html'">⬅ Main Menu</button>
    <strong style="color:#004a99">Projects Admin</strong>
  </div>
  <button class="btn btn-outline" onclick="loadProjects()">⟲ Reload</button>
</div>

<div class="wrap">
  <div class="grid">

    <!-- LEFT: PROJECTS -->
    <div class="card">
      <strong>Create project</strong>
      <div class="row" style="margin-top:10px">
        <input id="p_name" class="input" placeholder="Project name" style="flex:1;min-width:240px">
        <input id="p_store" class="input" placeholder="Store no" style="width:140px">
        <input id="p_client" class="input" placeholder="Client" style="width:180px">
        <button class="btn btn-primary" onclick="createProject()">➕ Create</button>
      </div>

      <hr style="margin:16px 0">

      <strong>Projects</strong>
      <div class="muted">Admin sees Active + Archived.</div>
      <div id="projectsList"></div>
    </div>

    <!-- RIGHT: FILES -->
    <div class="card">
      <strong id="projectTitle">Select a project</strong>
      <div class="row" id="projectActions" style="margin-top:8px;display:none">
        <button class="btn btn-warn" id="archiveBtn" onclick="archiveProject()">Archive</button>
        <button class="btn btn-primary" id="unarchiveBtn" onclick="unarchiveProject()">Unarchive</button>
        <button class="btn btn-outline" onclick="renameProject()">Rename</button>
      </div>

      <div id="filePanel" style="display:none;margin-top:16px">
        <div class="row" style="margin-bottom:8px">
          <input id="f_title" class="input" placeholder="File title (optional)" style="flex:1;min-width:220px">
          <input id="f_category" class="input" placeholder="Category (optional)" style="width:180px">

          <select id="f_section" class="input" style="width:190px">
            <option value="drawings">Drawings</option>
            <option value="health_safety">Health & Safety</option>
            <option value="documents" selected>Documents</option>
            <option value="images">Images</option>
            <option value="other">Other</option>
          </select>

          <input id="f_file" type="file" class="input" style="flex:1;min-width:240px">
          <button class="btn btn-primary" onclick="uploadFile()">⬆ Upload</button>
        </div>

        <div class="muted">Tip: “Section” is mandatory for correct sorting in Projects.</div>

        <table>
          <thead>
            <tr>
              <th>File</th>
              <th>Meta</th>
              <th>Status</th>
              <th style="width:310px">Actions</th>
            </tr>
          </thead>
          <tbody id="filesTbody">
            <tr><td colspan="4" class="muted">No project selected.</td></tr>
          </tbody>
        </table>
      </div>
    </div>

  </div>
</div>

<!-- Edit File Modal -->
<div class="modal" id="editModal" aria-hidden="true">
  <div class="modal-box">
    <div class="modal-head">
      <strong>Edit file</strong>
      <button class="btn btn-outline" onclick="closeEdit()">✕ Close</button>
    </div>
    <div class="modal-body">
      <div class="muted" id="editMeta"></div>

      <div class="field">
        <div><strong>Title</strong></div>
        <input class="input" id="edit_title" placeholder="(optional)">
      </div>

      <div class="field">
        <div><strong>Category</strong></div>
        <input class="input" id="edit_category" placeholder="(optional)">
      </div>

      <div class="field">
        <div><strong>Section</strong></div>
        <select class="input" id="edit_section">
          <option value="drawings">Drawings</option>
          <option value="health_safety">Health & Safety</option>
          <option value="documents">Documents</option>
          <option value="images">Images</option>
          <option value="other">Other</option>
        </select>
      </div>

      <div class="field">
        <div><strong>Display name</strong></div>
        <input class="input" id="edit_name" placeholder="Filename shown to users">
      </div>

      <div class="muted" style="margin-top:10px">
        Note: Changing “Display name” does not move the R2 object — it just changes the filename users see on download.
      </div>
    </div>
    <div class="modal-foot">
      <button class="btn btn-outline" onclick="closeEdit()">Cancel</button>
      <button class="btn btn-primary" onclick="saveEdit()">Save changes</button>
    </div>
  </div>
</div>

<script>
const API = "https://projects-ml-portal.jamie-def.workers.dev";
const USER = sessionStorage.getItem("mostlaneUser");
const ADMIN_TOKEN = "Hbdkwnainj2758";
if(!USER) location.href="login.html";

let CURRENT_PROJECT = null;
let CURRENT_FILES = [];
let EDITING_FILE = null;

function headers(extra={}){
  return {
    Authorization:"Bearer "+USER,
    "X-Admin-Token": ADMIN_TOKEN,
    ...extra
  };
}

function fmtStatusPill(p){
  const status = (p.status || "active");
  return `<span class="pill ${status === "archived" ? "archived" : "active"}">${status.toUpperCase()}</span>`;
}

function sectionLabel(key){
  switch(String(key||"").toLowerCase()){
    case "drawings": return "Drawings";
    case "health_safety": return "Health & Safety";
    case "documents": return "Documents";
    case "images": return "Images";
    default: return "Other";
  }
}

function loadProjects(){
  fetch(API+"/projects",{headers: headers()})
    .then(r=>r.json())
    .then(d=>{
      const list=document.getElementById("projectsList");
      list.innerHTML="";
      (d.projects||[]).forEach(p=>{
        const div=document.createElement("div");
        div.className="proj-row"+(CURRENT_PROJECT?.id===p.id?" active":"");
        div.innerHTML=`
          <div style="display:flex;justify-content:space-between;gap:10px;align-items:flex-start">
            <div>
              <div style="font-weight:800">${escapeHtml(p.name)}</div>
              <div class="muted">#${escapeHtml(p.storeNumber||"-")} · ${escapeHtml(p.client||"")}</div>
            </div>
            <div>${fmtStatusPill(p)}</div>
          </div>
        `;
        div.onclick=()=>selectProject(p);
        list.appendChild(div);
      });
    })
    .catch(err=>console.error(err));
}

function selectProject(p){
  CURRENT_PROJECT=p;
  document.getElementById("projectTitle").textContent=p.name;
  document.getElementById("projectActions").style.display="flex";
  document.getElementById("filePanel").style.display="block";

  const status = (p.status || "active");
  document.getElementById("archiveBtn").style.display = (status === "active") ? "inline-block" : "none";
  document.getElementById("unarchiveBtn").style.display = (status === "archived") ? "inline-block" : "none";

  loadFiles();
  loadProjects();
}

function loadFiles(){
  if(!CURRENT_PROJECT) return;

  fetch(`${API}/projects/${encodeURIComponent(CURRENT_PROJECT.id)}/files`,{headers: headers()})
    .then(r=>r.json())
    .then(d=>{
      CURRENT_FILES = d.files || [];
      renderFiles(CURRENT_FILES);
    })
    .catch(err=>console.error(err));
}

function renderFiles(files){
  const tb=document.getElementById("filesTbody");
  tb.innerHTML="";

  if(!files.length){
    tb.innerHTML = `<tr><td colspan="4" class="muted">No files yet.</td></tr>`;
    return;
  }

  files.forEach(f=>{
    const tr=document.createElement("tr");

    const title = f.title || f.name;
    const metaLine = [
      f.category ? escapeHtml(f.category) : "",
      f.section ? `Section: ${escapeHtml(sectionLabel(f.section))}` : ""
    ].filter(Boolean).join(" · ");

    const statusPill = f.hidden
      ? `<span class="pill hidden">HIDDEN</span>`
      : `<span class="pill active">VISIBLE</span>`;

    tr.innerHTML=`
      <td>
        <div style="font-weight:800">${escapeHtml(title)}</div>
        <div class="muted">${escapeHtml(f.name || "")}</div>
      </td>
      <td>
        <div class="muted">${metaLine || ""}</div>
        <div class="muted">${escapeHtml(f.uploadedBy||"")} · ${escapeHtml(f.uploadedAt||"")}</div>
      </td>
      <td>${statusPill}</td>
      <td class="actions">
        <button class="btn btn-outline" onclick="openEdit('${f.id}')">Edit</button>
        <button class="btn btn-warn" onclick="toggleHide('${f.id}', ${f.hidden ? "false" : "true"})">${f.hidden ? "Unhide" : "Hide"}</button>
        <button class="btn btn-danger" onclick="deleteFile('${f.id}')">Delete</button>
      </td>
    `;

    tb.appendChild(tr);
  });
}

function createProject(){
  const name = (p_name.value||"").trim();
  if(!name) return alert("Project name required");

  fetch(API+"/projects",{
    method:"POST",
    headers:{...headers(), "Content-Type":"application/json"},
    body:JSON.stringify({
      name,
      storeNumber:(p_store.value||"").trim(),
      client:(p_client.value||"").trim()
    })
  })
  .then(r=>r.json())
  .then(()=>{
    p_name.value=""; p_store.value=""; p_client.value="";
    loadProjects();
  })
  .catch(err=>alert(err.message || "Create failed"));
}

function uploadFile(){
  if(!CURRENT_PROJECT) return alert("Select a project first");
  const file = (f_file.files||[])[0];
  if(!file) return alert("Choose a file");

  const section = (f_section.value||"").trim();
  if(!section) return alert("Choose a section");

  const fd=new FormData();
  fd.append("file", file);
  fd.append("title", (f_title.value||"").trim());
  fd.append("category", (f_category.value||"").trim());
  fd.append("section", section);

  fetch(`${API}/projects/${encodeURIComponent(CURRENT_PROJECT.id)}/upload`,{
    method:"POST",
    headers: headers(), // note: no Content-Type here (browser sets boundary)
    body: fd
  })
  .then(r=>r.json().then(j=>({ok:r.ok,j})))
  .then(({ok,j})=>{
    if(!ok) throw new Error(j.error || "Upload failed");
    f_file.value=""; f_title.value=""; f_category.value="";
    loadFiles();
  })
  .catch(err=>alert(err.message || "Upload failed"));
}

function archiveProject(){
  if(!CURRENT_PROJECT) return;
  fetch(`${API}/projects/${encodeURIComponent(CURRENT_PROJECT.id)}/archive`,{
    method:"POST",
    headers:{...headers(),"Content-Type":"application/json"},
    body:JSON.stringify({status:"archived"})
  }).then(()=>{ loadProjects(); loadFiles(); });
}

function unarchiveProject(){
  if(!CURRENT_PROJECT) return;
  fetch(`${API}/projects/${encodeURIComponent(CURRENT_PROJECT.id)}/archive`,{
    method:"POST",
    headers:{...headers(),"Content-Type":"application/json"},
    body:JSON.stringify({status:"active"})
  }).then(()=>{ loadProjects(); loadFiles(); });
}

function renameProject(){
  if(!CURRENT_PROJECT) return;
  const name = prompt("New project name", CURRENT_PROJECT.name);
  if(!name) return;

  fetch(`${API}/projects/${encodeURIComponent(CURRENT_PROJECT.id)}/rename`,{
    method:"POST",
    headers:{...headers(),"Content-Type":"application/json"},
    body:JSON.stringify({name})
  })
  .then(r=>r.json())
  .then(d=>{
    CURRENT_PROJECT = d.project || CURRENT_PROJECT;
    document.getElementById("projectTitle").textContent = CURRENT_PROJECT.name;
    loadProjects();
  })
  .catch(err=>alert(err.message || "Rename failed"));
}

function toggleHide(id, hidden){
  fetch(`${API}/files/${encodeURIComponent(id)}/hide`,{
    method:"POST",
    headers:{...headers(),"Content-Type":"application/json"},
    body:JSON.stringify({hidden})
  }).then(r=>r.json().then(j=>({ok:r.ok,j})))
    .then(({ok,j})=>{
      if(!ok) throw new Error(j.error||"Hide failed");
      loadFiles();
    })
    .catch(err=>alert(err.message||"Hide failed"));
}

function deleteFile(id){
  if(!confirm("Permanently delete this file?")) return;
  fetch(`${API}/files/${encodeURIComponent(id)}`,{
    method:"DELETE",
    headers: headers()
  })
  .then(r=>r.json().then(j=>({ok:r.ok,j})))
  .then(({ok,j})=>{
    if(!ok) throw new Error(j.error||"Delete failed");
    loadFiles();
  })
  .catch(err=>alert(err.message||"Delete failed"));
}

/* ===== Edit modal ===== */
const editModal = document.getElementById("editModal");
const editMeta = document.getElementById("editMeta");
const edit_title = document.getElementById("edit_title");
const edit_category = document.getElementById("edit_category");
const edit_section = document.getElementById("edit_section");
const edit_name = document.getElementById("edit_name");

function openEdit(fileId){
  const f = CURRENT_FILES.find(x=>x.id===fileId);
  if(!f) return;

  EDITING_FILE = f;
  editMeta.textContent = `ID: ${f.id} • Uploaded: ${f.uploadedAt || ""} • By: ${f.uploadedBy || ""}`;

  edit_title.value = f.title || "";
  edit_category.value = f.category || "";
  edit_section.value = (f.section || "documents");
  edit_name.value = f.name || "";

  editModal.classList.add("show");
}

function closeEdit(){
  EDITING_FILE = null;
  editModal.classList.remove("show");
}

function saveEdit(){
  if(!EDITING_FILE) return;

  const payload = {
    title: (edit_title.value||"").trim(),
    category: (edit_category.value||"").trim(),
    section: (edit_section.value||"").trim(),
    name: (edit_name.value||"").trim()
  };

  fetch(`${API}/files/${encodeURIComponent(EDITING_FILE.id)}/rename`,{
    method:"POST",
    headers:{...headers(),"Content-Type":"application/json"},
    body:JSON.stringify(payload)
  })
  .then(r=>r.json().then(j=>({ok:r.ok,j})))
  .then(({ok,j})=>{
    if(!ok) throw new Error(j.error||"Save failed");
    closeEdit();
    loadFiles();
  })
  .catch(err=>alert(err.message||"Save failed"));
}

function escapeHtml(s){
  return String(s ?? "")
    .replace(/&/g,"&amp;").replace(/</g,"&lt;")
    .replace(/>/g,"&gt;").replace(/"/g,"&quot;")
    .replace(/'/g,"&#039;");
}

loadProjects();
</script>

</body>
</html>
