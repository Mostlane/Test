<!DOCTYPE html>
<html lang="en">
<head>
  <script src="auth.js"></script>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Projects Admin – Mostlane</title>

  <style>
    body{
      margin:0;
      font-family:"Segoe UI",system-ui,-apple-system,Arial,sans-serif;
      background:#e6e8eb url('Mostlane_Embossed.png') no-repeat center center fixed;
      background-size:cover;
      color:#1f2937;
    }
    .topbar{
      position:sticky; top:0; z-index:10;
      background:rgba(255,255,255,.75);
      backdrop-filter:blur(6px);
      box-shadow:0 2px 10px rgba(0,0,0,.08);
      padding:10px 14px;
      display:flex; align-items:center; justify-content:space-between;
    }
    .btn{border:none;border-radius:8px;padding:10px 14px;font-size:14px;cursor:pointer}
    .btn-outline{background:#fff;border:1px solid #004a99;color:#004a99}
    .btn-primary{background:#004a99;color:#fff}
    .warn{background:#8a5a00;color:#fff}
    .danger{background:#7f1d1d;color:#fff}
    .ok{background:#1b5e20;color:#fff}
    .wrap{
      max-width:1100px;
      margin:16px auto 70px;
      padding:14px;
      background:rgba(255,255,255,.70);
      border-radius:12px;
    }
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .input{padding:10px 12px;border:1px solid #d1d5db;border-radius:8px;background:#fff;font-size:14px}
    .card{background:#fff;border:1px solid #e5e7eb;border-radius:12px;padding:12px;margin-top:12px}
    .grid{display:grid;gap:10px;grid-template-columns:repeat(2,minmax(0,1fr))}
    @media (max-width:800px){.grid{grid-template-columns:1fr}}
    .muted{color:#6b7280;font-size:12px}
    .pill{display:inline-block;padding:4px 8px;border-radius:999px;font-size:12px;border:1px solid #d1d5db;background:#f9fafb}
    .pill.active{background:#ecfdf5;color:#166534;border-color:#86efac}
    .pill.archived{background:#fef2f2;color:#991b1b;border-color:#fecaca}
    table{width:100%;border-collapse:collapse}
    th,td{padding:10px;border-bottom:1px solid #e5e7eb;font-size:14px}
    th{text-transform:uppercase;font-size:12px;color:#374151}
    .actions{display:flex;gap:8px;flex-wrap:wrap}
    .mask{
      position:fixed; inset:0;
      display:none; align-items:center; justify-content:center;
      background:rgba(255,255,255,.55);
      backdrop-filter:blur(2px);
      z-index:50;
    }
    .mask.show{display:flex}
    .spinner{
      width:46px;height:46px;
      border-radius:50%;
      border:4px solid #c7d2fe;
      border-top-color:#004a99;
      animation:spin 1s linear infinite
    }
    @keyframes spin{to{transform:rotate(360deg)}}
    .banner{display:none;margin-bottom:12px;padding:10px;border-radius:10px}
    .banner.ok{background:#e9f7ef;color:#1b5e20}
    .banner.err{background:#fee2e2;color:#7f1d1d}
    .banner.show{display:block}
  </style>
</head>

<body>

<div class="topbar">
  <div class="row">
    <button class="btn btn-outline" onclick="location.href='main.html'">⬅ Main Menu</button>
    <strong style="color:#004a99">Projects Admin</strong>
  </div>
  <button class="btn btn-outline" onclick="loadProjects()">⟲ Reload</button>
</div>

<div class="wrap">
  <div class="banner" id="banner"></div>

  <div class="card">
    <div class="row">
      <input class="input" id="p_name" placeholder="Project name" style="flex:1">
      <input class="input" id="p_store" placeholder="Store no">
      <input class="input" id="p_client" placeholder="Client">
      <button class="btn btn-primary" onclick="createProject()">➕ Create</button>
    </div>
  </div>

  <div class="grid">
    <div class="card">
      <strong>Projects</strong>
      <div id="projectsList"></div>
    </div>

    <div class="card">
      <div class="row" style="justify-content:space-between">
        <div>
          <strong id="selTitle">Select a project</strong>
          <div class="muted" id="selMeta"></div>
        </div>
      </div>

      <div id="filePanel" style="display:none;margin-top:12px">
        <div class="row">
          <input class="input" id="f_title" placeholder="Title">
          <input class="input" id="f_category" placeholder="Category">
          <input class="input" id="f_file" type="file">
          <button class="btn btn-primary" onclick="uploadFile()">⬆ Upload</button>
        </div>

        <table style="margin-top:12px">
          <thead>
            <tr>
              <th>File</th>
              <th>Meta</th>
              <th>Status</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="filesTbody"></tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<div class="mask" id="mask"><div class="spinner"></div></div>

<script>
const API = "https://projects-ml-portal.jamie-def.workers.dev";
const USER = sessionStorage.getItem("mostlaneUser");
const ADMIN_TOKEN = "Hbdkwnainj2758";

if(!USER) location.href="login.html";

let CURRENT_PROJECT = null;

const mask = document.getElementById("mask");
const banner = document.getElementById("banner");

function showMask(v){ mask.classList.toggle("show",v); }
function msg(text,type="ok"){
  banner.textContent=text;
  banner.className="banner show "+type;
  setTimeout(()=>banner.classList.remove("show"),4000);
}

async function api(path, opts={}){
  const res = await fetch(API+path,{
    ...opts,
    headers:{
      Authorization:"Bearer "+USER,
      ...(opts.headers||{})
    }
  });
  const j = await res.json().catch(()=>({}));
  if(!res.ok) throw new Error(j.error||"Error");
  return j;
}

async function loadProjects(){
  showMask(true);
  try{
    const d = await api("/projects");
    const list = document.getElementById("projectsList");
    list.innerHTML="";
    d.projects.forEach(p=>{
      const div=document.createElement("div");
      div.className="row";
      div.style.cursor="pointer";
      div.innerHTML=`<strong>${p.name}</strong><span class="pill ${p.status}">${p.status}</span>`;
      div.onclick=()=>selectProject(p.id);
      list.appendChild(div);
    });
  }catch(e){ msg(e.message,"err"); }
  finally{ showMask(false); }
}

async function selectProject(id){
  showMask(true);
  try{
    const d = await api(`/projects/${id}/files`);
    CURRENT_PROJECT=d.project;
    document.getElementById("selTitle").textContent=CURRENT_PROJECT.name;
    document.getElementById("filePanel").style.display="block";
    renderFiles(d.files||[]);
  }catch(e){ msg(e.message,"err"); }
  finally{ showMask(false); }
}

function renderFiles(files){
  const tb=document.getElementById("filesTbody");
  tb.innerHTML="";
  files.forEach(f=>{
    const tr=document.createElement("tr");
    tr.innerHTML=`
      <td><strong>${f.name}</strong><div class="muted">${f.title||""}</div></td>
      <td class="muted">${f.category||""}<br>${f.uploadedAt||""}</td>
      <td><span class="pill ${f.hidden?"archived":"active"}">${f.hidden?"Hidden":"Active"}</span></td>
      <td class="actions">
        <button class="btn btn-outline" onclick="downloadFile('${f.id}')">⬇ Download</button>
      </td>
    `;
    tb.appendChild(tr);
  });
}

function downloadFile(id){
  const a=document.createElement("a");
  a.href=`${API}/download/${id}?u=${encodeURIComponent(USER)}`;
  a.download="";
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
}

async function uploadFile(){
  if(!CURRENT_PROJECT) return msg("Select a project first","err");
  const fileInput=document.getElementById("f_file");
  const file=fileInput.files[0];
  if(!file) return msg("Choose a file","err");

  const fd=new FormData();
  fd.append("file",file);
  fd.append("title",document.getElementById("f_title").value);
  fd.append("category",document.getElementById("f_category").value);

  showMask(true);
  try{
    await fetch(`${API}/projects/${CURRENT_PROJECT.id}/upload`,{
      method:"POST",
      headers:{
        Authorization:"Bearer "+USER,
        "X-Admin-Token":ADMIN_TOKEN
      },
      body:fd
    });
    fileInput.value="";
    msg("Uploaded");
    selectProject(CURRENT_PROJECT.id);
  }catch(e){ msg(e.message,"err"); }
  finally{ showMask(false); }
}

async function createProject(){
  const name=p_name.value.trim();
  if(!name) return msg("Name required","err");
  showMask(true);
  try{
    await api("/projects",{method:"POST",headers:{"X-Admin-Token":ADMIN_TOKEN},body:JSON.stringify({
      name,
      storeNumber:p_store.value,
      client:p_client.value
    })});
    p_name.value=p_store.value=p_client.value="";
    loadProjects();
  }catch(e){ msg(e.message,"err"); }
  finally{ showMask(false); }
}

loadProjects();
</script>

</body>
</html>
