<!DOCTYPE html>
<html lang="en">
<head>
  <script src="auth.js"></script>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Projects Admin ‚Äì Mostlane</title>

  <style>
    body{
      margin:0;
      font-family:"Segoe UI",system-ui,-apple-system,Arial,sans-serif;
      background:#e6e8eb url('Mostlane_Embossed.png') no-repeat center center fixed;
      background-size:cover;
      color:#1f2937;
    }
    .topbar{
      position:sticky;top:0;z-index:10;
      background:rgba(255,255,255,.75);
      backdrop-filter:blur(6px);
      box-shadow:0 2px 10px rgba(0,0,0,.08);
      padding:10px 14px;
      display:flex;justify-content:space-between;align-items:center;
    }
    .btn{border:none;border-radius:8px;padding:10px 14px;font-size:14px;cursor:pointer;font-weight:600}
    .btn-outline{background:#fff;border:1px solid #004a99;color:#004a99}
    .btn-primary{background:#004a99;color:#fff}
    .warn{background:#8a5a00;color:#fff}
    .danger{background:#7f1d1d;color:#fff}
    .ok{background:#1b5e20;color:#fff}

    .wrap{
      max-width:1100px;
      margin:16px auto 70px;
      padding:14px;
      background:rgba(255,255,255,.70);
      border-radius:12px;
    }
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .input{padding:10px 12px;border:1px solid #d1d5db;border-radius:8px;background:#fff;font-size:14px}
    .card{background:#fff;border:1px solid #e5e7eb;border-radius:12px;padding:12px;margin-top:12px}
    .grid{display:grid;gap:12px;grid-template-columns:repeat(2,minmax(0,1fr))}
    @media(max-width:900px){.grid{grid-template-columns:1fr}}

    .muted{color:#6b7280;font-size:12px}
    .pill{padding:4px 8px;border-radius:999px;font-size:12px;border:1px solid #d1d5db}
    .pill.active{background:#ecfdf5;color:#166534;border-color:#86efac}
    .pill.archived{background:#fef2f2;color:#991b1b;border-color:#fecaca}

    table{width:100%;border-collapse:collapse}
    th,td{padding:10px;border-bottom:1px solid #e5e7eb;font-size:14px;text-align:left}
    th{font-size:12px;text-transform:uppercase;color:#374151}

    .actions{display:flex;gap:8px;flex-wrap:wrap}

    /* Viewer modal */
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;z-index:50}
    .modal.show{display:flex}
    .modal-box{
      background:#fff;
      width:92%;
      height:92%;
      margin:auto;
      border-radius:14px;
      display:flex;
      flex-direction:column;
      box-shadow:0 20px 40px rgba(0,0,0,.3);
    }
    .modal-head{
      padding:12px 14px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      border-bottom:1px solid #e5e7eb;
    }
    .modal-body{flex:1;overflow:hidden}
    .modal-body iframe{width:100%;height:100%;border:none}

    #downloadFrame{display:none;width:0;height:0;border:0}
  </style>
</head>

<body>

<div class="topbar">
  <div class="row">
    <button class="btn btn-outline" onclick="location.href='main.html'">‚¨Ö Main Menu</button>
    <strong style="color:#004a99">Projects Admin</strong>
  </div>
  <button class="btn btn-outline" onclick="loadProjects()">‚ü≤ Reload</button>
</div>

<div class="wrap">

  <!-- Create project -->
  <div class="card">
    <div class="row">
      <input class="input" id="p_name" placeholder="Project name" style="flex:1">
      <input class="input" id="p_store" placeholder="Store no" style="width:140px">
      <input class="input" id="p_client" placeholder="Client" style="width:180px">
      <button class="btn btn-primary" onclick="createProject()">‚ûï Create</button>
    </div>
  </div>

  <div class="grid">

    <!-- Project list -->
    <div class="card">
      <strong>Projects</strong>
      <div id="projectsList"></div>
    </div>

    <!-- File manager -->
    <div class="card">
      <strong id="selTitle">Select a project</strong>
      <div class="muted" id="selMeta"></div>

      <div id="filePanel" style="display:none;margin-top:10px">
        <div class="row">
          <input class="input" id="f_title" placeholder="Title">
          <input class="input" id="f_category" placeholder="Category">
          <input class="input" id="f_file" type="file">
          <button class="btn btn-primary" onclick="uploadFile()">‚¨Ü Upload</button>
        </div>

        <table style="margin-top:12px">
          <thead>
            <tr>
              <th>File</th>
              <th>Meta</th>
              <th>Status</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="filesTbody"></tbody>
        </table>
      </div>
    </div>

  </div>
</div>

<!-- Viewer -->
<div class="modal" id="viewer">
  <div class="modal-box">
    <div class="modal-head">
      <strong id="viewerTitle"></strong>
      <button class="btn btn-outline" onclick="closeViewer()">‚úï Close</button>
    </div>
    <div class="modal-body">
      <iframe id="viewerFrame"></iframe>
    </div>
  </div>
</div>

<iframe id="downloadFrame"></iframe>

<script>
const API = "https://projects-ml-portal.jamie-def.workers.dev";
const USER = sessionStorage.getItem("mostlaneUser");
const ADMIN_TOKEN = "Hbdkwnainj2758"; // must match worker

if(!USER) location.href="login.html";

let SELECTED = null;

const projectsList = document.getElementById("projectsList");
const filesTbody = document.getElementById("filesTbody");
const selTitle = document.getElementById("selTitle");
const selMeta = document.getElementById("selMeta");
const filePanel = document.getElementById("filePanel");

const viewer = document.getElementById("viewer");
const viewerFrame = document.getElementById("viewerFrame");
const viewerTitle = document.getElementById("viewerTitle");
const downloadFrame = document.getElementById("downloadFrame");

function headers(extra={}){
  return {
    "Authorization":"Bearer "+USER,
    "X-Admin-Token":ADMIN_TOKEN,
    ...extra
  };
}

function loadProjects(){
  projectsList.innerHTML="";
  fetch(API+"/projects",{headers:headers()})
    .then(r=>r.json())
    .then(d=>{
      d.projects.forEach(p=>{
        const div=document.createElement("div");
        div.className="row";
        div.style.justifyContent="space-between";
        div.style.padding="10px";
        div.style.border="1px solid #e5e7eb";
        div.style.borderRadius="10px";
        div.style.marginTop="8px";
        div.style.cursor="pointer";
        div.innerHTML=`
          <div><strong>${p.name}</strong><div class="muted">${p.client||""}</div></div>
          <span class="pill ${p.status==="archived"?"archived":"active"}">${p.status||"active"}</span>
        `;
        div.onclick=()=>selectProject(p.id);
        projectsList.appendChild(div);
      });
    });
}

function selectProject(id){
  fetch(`${API}/projects/${id}/files`,{headers:headers()})
    .then(r=>r.json())
    .then(d=>{
      SELECTED=d.project;
      selTitle.textContent=SELECTED.name;
      selMeta.textContent=`Updated: ${SELECTED.updatedAt}`;
      filePanel.style.display="block";
      renderFiles(d.files||[]);
    });
}

function renderFiles(files){
  filesTbody.innerHTML="";
  if(!files.length){
    filesTbody.innerHTML=`<tr><td colspan="4" class="muted">No files</td></tr>`;
    return;
  }

  files.forEach(f=>{
    const tr=document.createElement("tr");
    tr.innerHTML=`
      <td><strong>${f.name}</strong><div class="muted">${f.title||""}</div></td>
      <td class="muted">${f.category||""}<br>${f.uploadedAt||""}</td>
      <td><span class="pill ${f.hidden?"archived":"active"}">${f.hidden?"Hidden":"Active"}</span></td>
      <td class="actions">
        <button class="btn btn-outline">üëÅ View</button>
        <button class="btn btn-outline">‚¨á Download</button>
        <button class="btn warn">${f.hidden?"Unhide":"Hide"}</button>
        <button class="btn danger">Delete</button>
      </td>
    `;
    tr.querySelector(".btn-outline").onclick=()=>downloadFrame.src=`${API}/download/${f.id}?u=${encodeURIComponent(USER)}`;
    tr.querySelectorAll(".btn-outline")[0].onclick=()=>openViewer(f);
    tr.querySelector(".warn").onclick=()=>toggleHide(f);
    tr.querySelector(".danger").onclick=()=>deleteFile(f.id);
    filesTbody.appendChild(tr);
  });
}

function openViewer(f){
  viewerTitle.textContent=f.name;
  viewerFrame.src=`${API}/download/${f.id}?inline=1&u=${encodeURIComponent(USER)}`;
  viewer.classList.add("show");
}
function closeViewer(){
  viewerFrame.src="";
  viewer.classList.remove("show");
}

function createProject(){
  fetch(API+"/projects",{
    method:"POST",
    headers:{...headers(), "Content-Type":"application/json"},
    body:JSON.stringify({
      name:p_name.value,
      storeNumber:p_store.value,
      client:p_client.value
    })
  }).then(()=>loadProjects());
}

function uploadFile(){
  const fd=new FormData();
  fd.append("file",f_file.files[0]);
  fd.append("title",f_title.value);
  fd.append("category",f_category.value);

  fetch(`${API}/projects/${SELECTED.id}/upload`,{
    method:"POST",
    headers:headers(),
    body:fd
  }).then(()=>selectProject(SELECTED.id));
}

function toggleHide(f){
  fetch(`${API}/files/${f.id}/hide`,{
    method:"POST",
    headers:{...headers(),"Content-Type":"application/json"},
    body:JSON.stringify({hidden:!f.hidden})
  }).then(()=>selectProject(SELECTED.id));
}

function deleteFile(id){
  if(!confirm("Delete permanently?"))return;
  fetch(`${API}/files/${id}`,{method:"DELETE",headers:headers()})
    .then(()=>selectProject(SELECTED.id));
}

loadProjects();
</script>

</body>
</html>
