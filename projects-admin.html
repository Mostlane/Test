<!DOCTYPE html>
<html lang="en">
<head>
  <script src="auth.js"></script>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Projects Admin â€“ Mostlane</title>

  <style>
    body{
      margin:0;
      font-family:"Segoe UI",system-ui,-apple-system,Arial,sans-serif;
      background:#e6e8eb url('Mostlane_Embossed.png') no-repeat center center fixed;
      background-size:cover;
      color:#1f2937;
    }
    .topbar{
      position:sticky; top:0; z-index:10;
      background:rgba(255,255,255,.75);
      backdrop-filter:blur(6px);
      box-shadow:0 2px 10px rgba(0,0,0,.08);
      padding:10px 14px;
      display:flex; justify-content:space-between; align-items:center;
    }
    .btn{border:none;border-radius:8px;padding:10px 14px;font-size:14px;cursor:pointer}
    .btn-outline{background:#fff;border:1px solid #004a99;color:#004a99}
    .btn-primary{background:#004a99;color:#fff}
    .wrap{
      max-width:1100px;margin:16px auto 70px;padding:14px;
      background:rgba(255,255,255,.7);border-radius:12px;
    }
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .input{padding:10px;border:1px solid #d1d5db;border-radius:8px;font-size:14px}
    .card{background:#fff;border:1px solid #e5e7eb;border-radius:12px;padding:12px;margin-top:12px}
    .grid{display:grid;gap:12px;grid-template-columns:1fr 1fr}
    @media(max-width:800px){.grid{grid-template-columns:1fr}}
    table{width:100%;border-collapse:collapse;margin-top:12px}
    th,td{padding:10px;border-bottom:1px solid #e5e7eb;font-size:14px}
    th{font-size:12px;text-transform:uppercase;color:#374151}
    .pill{padding:4px 8px;border-radius:999px;font-size:12px;border:1px solid #d1d5db}
    .pill.active{background:#ecfdf5;color:#166534;border-color:#86efac}
    .actions{display:flex;gap:8px}
    .mask{
      position:fixed; inset:0;
      display:none; align-items:center; justify-content:center;
      background:rgba(255,255,255,.6);
      backdrop-filter:blur(2px);
      z-index:50;
    }
    .mask.show{display:flex}
    .spinner{
      width:40px;height:40px;border-radius:50%;
      border:4px solid #c7d2fe;border-top-color:#004a99;
      animation:spin 1s linear infinite
    }
    @keyframes spin{to{transform:rotate(360deg)}}
    .banner{display:none;padding:10px;border-radius:10px;margin-bottom:12px}
    .banner.ok{background:#e9f7ef;color:#1b5e20}
    .banner.err{background:#fee2e2;color:#7f1d1d}
    .banner.show{display:block}
  </style>
</head>

<body>

<div class="topbar">
  <button class="btn btn-outline" onclick="location.href='main.html'">â¬… Main Menu</button>
  <strong style="color:#004a99">Projects Admin</strong>
  <button class="btn btn-outline" onclick="loadProjects()">âŸ² Reload</button>
</div>

<div class="wrap">
  <div id="banner" class="banner"></div>

  <div class="card">
    <div class="row">
      <input id="p_name" class="input" placeholder="Project name" style="flex:1">
      <input id="p_store" class="input" placeholder="Store no">
      <input id="p_client" class="input" placeholder="Client">
      <button class="btn btn-primary" onclick="createProject()">âž• Create</button>
    </div>
  </div>

  <div class="grid">
    <div class="card">
      <strong>Projects</strong>
      <div id="projectsList"></div>
    </div>

    <div class="card">
      <strong id="selTitle">Select a project</strong>

      <div id="uploadPanel" style="display:none;margin-top:12px">
        <div class="row">
          <input id="f_title" class="input" placeholder="Title">
          <input id="f_category" class="input" placeholder="Category">
          <input id="f_file" type="file" class="input">
          <button class="btn btn-primary" onclick="uploadFile()">â¬† Upload</button>
        </div>

        <table>
          <thead>
            <tr>
              <th>File</th>
              <th>Meta</th>
              <th>Status</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="filesTbody"></tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<div id="mask" class="mask"><div class="spinner"></div></div>

<script>
const API = "https://projects-ml-portal.jamie-def.workers.dev";
const USER = sessionStorage.getItem("mostlaneUser");
const ADMIN_TOKEN = "Hbdkwnainj2758";

if(!USER) location.href="login.html";

let CURRENT_PROJECT = null;

const mask = document.getElementById("mask");
const banner = document.getElementById("banner");

function showMask(v){ mask.classList.toggle("show",v); }
function showMsg(t,type="ok"){
  banner.textContent=t;
  banner.className="banner show "+type;
  setTimeout(()=>banner.classList.remove("show"),4000);
}

/* ðŸ”’ SAFE API WRAPPER */
async function api(path, opts = {}){
  const res = await fetch(`${API}/${path.replace(/^\/+/,"")}`,{
    method: opts.method || "GET",
    headers:{
      Authorization: "Bearer " + USER,
      ...(ADMIN_TOKEN ? { "X-Admin-Token": ADMIN_TOKEN } : {}),
      ...(opts.headers || {})
    },
    body: opts.body
  });
  const data = await res.json().catch(()=>({}));
  if(!res.ok) throw new Error(data.error || "Request failed");
  return data;
}

async function loadProjects(){
  showMask(true);
  try{
    const d = await api("projects");
    const list = document.getElementById("projectsList");
    list.innerHTML="";
    d.projects.forEach(p=>{
      const div=document.createElement("div");
      div.style.cursor="pointer";
      div.innerHTML=`<strong>${p.name}</strong>`;
      div.onclick=()=>selectProject(p.id);
      list.appendChild(div);
    });
  }catch(e){ showMsg(e.message,"err"); }
  finally{ showMask(false); }
}

async function selectProject(id){
  showMask(true);
  try{
    const d = await api(`projects/${id}/files`);
    CURRENT_PROJECT = d.project;
    document.getElementById("selTitle").textContent = CURRENT_PROJECT.name;
    document.getElementById("uploadPanel").style.display="block";
    renderFiles(d.files||[]);
  }catch(e){ showMsg(e.message,"err"); }
  finally{ showMask(false); }
}

function renderFiles(files){
  const tb=document.getElementById("filesTbody");
  tb.innerHTML="";
  files.forEach(f=>{
    const tr=document.createElement("tr");
    tr.innerHTML=`
      <td><strong>${f.name}</strong><div class="muted">${f.title||""}</div></td>
      <td>${f.category||""}<br>${f.uploadedAt||""}</td>
      <td><span class="pill active">Active</span></td>
      <td class="actions">
        <button class="btn btn-outline" onclick="downloadFile('${f.id}')">â¬‡ Download</button>
      </td>
    `;
    tb.appendChild(tr);
  });
}

function downloadFile(id){
  const a=document.createElement("a");
  a.href=`${API}/download/${id}?u=${encodeURIComponent(USER)}`;
  a.download="";
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
}

async function uploadFile(){
  if(!CURRENT_PROJECT) return showMsg("Select a project","err");
  const file=f_file.files[0];
  if(!file) return showMsg("Choose a file","err");

  const fd=new FormData();
  fd.append("file",file);
  fd.append("title",f_title.value);
  fd.append("category",f_category.value);

  showMask(true);
  try{
    await api(`projects/${CURRENT_PROJECT.id}/upload`,{
      method:"POST",
      body:fd
    });
    showMsg("Uploaded");
    f_file.value="";
    selectProject(CURRENT_PROJECT.id);
  }catch(e){ showMsg(e.message,"err"); }
  finally{ showMask(false); }
}

async function createProject(){
  if(!p_name.value.trim()) return showMsg("Name required","err");
  showMask(true);
  try{
    await api("projects",{
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body:JSON.stringify({
        name:p_name.value,
        storeNumber:p_store.value,
        client:p_client.value
      })
    });
    p_name.value=p_store.value=p_client.value="";
    loadProjects();
  }catch(e){ showMsg(e.message,"err"); }
  finally{ showMask(false); }
}

loadProjects();
</script>

</body>
</html>
