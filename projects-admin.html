<!DOCTYPE html>
<html lang="en">
<head>
  <script src="auth.js"></script>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Projects Admin â€“ Mostlane</title>

  <style>
    :root{
      --blue:#004a99;
      --bg:#e6e8eb;
      --card:#ffffff;
      --border:#e5e7eb;
      --text:#1f2937;
      --muted:#6b7280;
      --danger:#7f1d1d;
      --warn:#8a5a00;
    }

    *{box-sizing:border-box}

    body{
      margin:0;
      font-family:"Segoe UI",system-ui,-apple-system,Arial,sans-serif;
      background:var(--bg) url('Mostlane_Embossed.png') no-repeat center center fixed;
      background-size:cover;
      color:var(--text);
    }

    /* ================= TOP BAR ================= */
    .topbar{
      position:sticky;
      top:0;
      z-index:10;
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding:12px 16px;
      background:rgba(255,255,255,.75);
      backdrop-filter:blur(6px);
      box-shadow:0 2px 10px rgba(0,0,0,.08);
    }

    .topbar .left{
      display:flex;
      gap:10px;
      align-items:center;
    }

    /* ================= BUTTONS ================= */
    .btn{
      border:1px solid var(--border);
      background:#fff;
      border-radius:999px;
      padding:8px 14px;
      font-size:13px;
      font-weight:600;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      gap:6px;
      white-space:nowrap;
    }
    .btn.primary{background:var(--blue);color:#fff;border-color:var(--blue)}
    .btn.warn{background:var(--warn);color:#fff;border-color:var(--warn)}
    .btn.danger{background:var(--danger);color:#fff;border-color:var(--danger)}
    .btn.icon{padding:8px;width:36px;height:36px;justify-content:center}
    .btn.sm{padding:6px 10px;font-size:12px}

    /* ================= LAYOUT ================= */
    .wrap{
      max-width:1200px;
      margin:16px auto 80px;
      padding:14px;
      background:rgba(255,255,255,.7);
      border-radius:14px;
    }

    .grid{
      display:grid;
      gap:14px;
      grid-template-columns:1fr 1.25fr;
    }
    @media(max-width:900px){
      .grid{grid-template-columns:1fr}
    }

    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:14px;
      padding:16px;
    }

    .row{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
    }

    .input, select{
      padding:10px;
      border:1px solid #d1d5db;
      border-radius:10px;
      font-size:14px;
      background:#fff;
    }

    .muted{font-size:12px;color:var(--muted)}

    /* ================= PROJECT LIST ================= */
    .project-item{
      border:1px solid var(--border);
      border-radius:12px;
      padding:12px;
      margin-top:10px;
      cursor:pointer;
      display:flex;
      justify-content:space-between;
      gap:10px;
    }
    .project-item.active{
      border-color:var(--blue);
      background:#f0f6ff;
    }

    /* ================= PILLS ================= */
    .pill{
      padding:4px 10px;
      border-radius:999px;
      font-size:12px;
      border:1px solid var(--border);
      display:inline-flex;
      align-items:center;
      gap:6px;
    }
    .pill.active{background:#ecfdf5;color:#166534;border-color:#86efac}
    .pill.archived{background:#fef2f2;color:#991b1b;border-color:#fecaca}
    .pill.hidden{background:#fff7ed;color:#9a3412;border-color:#fed7aa}
    .pill.lock{background:#fef2f2;color:#991b1b;border-color:#fecaca}

    /* ================= FILE TABLE ================= */
    table{
      width:100%;
      border-collapse:collapse;
      margin-top:14px;
    }
    th,td{
      padding:10px;
      border-bottom:1px solid var(--border);
      font-size:14px;
      vertical-align:top;
    }
    th{
      font-size:12px;
      text-transform:uppercase;
      color:#374151;
      letter-spacing:.04em;
    }

    .actions{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      justify-content:flex-end;
    }

    /* ================= MODAL ================= */
    .modal{
      position:fixed;
      inset:0;
      display:none;
      background:rgba(0,0,0,.55);
      z-index:50;
    }
    .modal.show{display:flex}

    .modal-box{
      background:#fff;
      width:560px;
      max-width:94%;
      margin:auto;
      border-radius:16px;
      overflow:hidden;
      box-shadow:0 20px 40px rgba(0,0,0,.25);
    }

    .modal-head,
    .modal-foot{
      padding:12px 16px;
      border-bottom:1px solid var(--border);
      display:flex;
      justify-content:space-between;
      align-items:center;
    }
    .modal-foot{border-top:1px solid var(--border);border-bottom:none}

    .modal-body{padding:16px}

    label{
      font-size:12px;
      font-weight:700;
      color:var(--muted);
      display:block;
      margin:12px 0 6px;
    }
  </style>
</head>

<body>

<!-- ================= TOP BAR ================= -->
<div class="topbar">
  <div class="left">
    <button class="btn icon" onclick="location.href='main.html'">â¬…</button>
    <strong style="color:var(--blue)">Projects Admin</strong>
  </div>
  <button class="btn" onclick="loadProjects()">âŸ² Reload</button>
</div>

<div class="wrap">
  <div class="grid">

    <!-- ========== LEFT: PROJECTS ========== -->
    <div class="card">
      <strong>Create project</strong>

      <div class="row" style="margin-top:10px">
        <input id="p_name" class="input" placeholder="Project name" style="flex:1">
        <input id="p_store" class="input" placeholder="Store #">
        <input id="p_client" class="input" placeholder="Client">
        <button class="btn primary" onclick="createProject()">âž• Create</button>
      </div>

      <hr style="margin:16px 0">

      <strong>Projects</strong>
      <div class="muted">Admin view shows active & archived</div>
      <div id="projectsList"></div>
    </div>

    <!-- ========== RIGHT: FILES ========== -->
    <div class="card">
      <div class="row" style="justify-content:space-between">
        <div>
          <strong id="projectTitle">Select a project</strong>
          <div class="muted" id="projectMeta"></div>
        </div>
        <div class="row" id="projectActions" style="display:none">
          <button class="btn warn sm" onclick="archiveProject()">Archive</button>
          <button class="btn primary sm" onclick="unarchiveProject()">Unarchive</button>
          <button class="btn sm" onclick="renameProject()">Rename</button>
        </div>
      </div>

      <div id="filePanel" style="display:none;margin-top:16px">
        <div class="row">
          <select id="f_section">
            <option>Documents</option>
            <option>Drawings</option>
            <option>Images</option>
            <option>H&S</option>
            <option>Other</option>
          </select>
          <input id="f_title" class="input" placeholder="File title" style="flex:1">
          <input id="f_category" class="input" placeholder="Category">
          <input id="f_file" type="file" class="input" style="flex:1">
          <button class="btn primary" onclick="uploadFile()">â¬† Upload</button>
        </div>

        <table>
          <thead>
            <tr>
              <th>File</th>
              <th>Meta</th>
              <th>Status</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="filesTbody"></tbody>
        </table>
      </div>
    </div>

  </div>
</div>

<!-- ================= EDIT FILE MODAL ================= -->
<div class="modal" id="editModal">
  <div class="modal-box">
    <div class="modal-head">
      <strong>Edit file</strong>
      <button class="btn sm" onclick="closeEdit()">âœ•</button>
    </div>

    <div class="modal-body">
      <div class="muted" id="editHint"></div>

      <label>Display title</label>
      <input id="edit_title" class="input" style="width:100%">

      <label>Category</label>
      <input id="edit_category" class="input" style="width:100%">

      <label>Section</label>
      <select id="edit_section" style="width:100%">
        <option>Documents</option>
        <option>Drawings</option>
        <option>Images</option>
        <option>H&S</option>
        <option>Other</option>
      </select>

      <label>Displayed filename</label>
      <input id="edit_name" class="input" style="width:100%">

      <label>Download permission</label>
      <div class="row">
        <span class="pill lock" id="dlBadge" style="display:none">ðŸ”’ View only</span>
        <label style="font-size:13px">
          <input type="checkbox" id="edit_downloadable"> Allow downloads
        </label>
      </div>
    </div>

    <div class="modal-foot">
      <button class="btn" onclick="closeEdit()">Cancel</button>
      <button class="btn primary" onclick="saveEdit()">Save</button>
    </div>
  </div>
</div>

<script>
const API = "https://projects-ml-portal.jamie-def.workers.dev";
const USER = sessionStorage.getItem("mostlaneUser");
const ADMIN_TOKEN = "Hbdkwnainj2758";
if(!USER) location.href="login.html";

let CURRENT_PROJECT = null;
let CURRENT_FILES = [];
let EDIT_FILE = null;

const projectsList = document.getElementById("projectsList");
const filesTbody = document.getElementById("filesTbody");
const projectTitle = document.getElementById("projectTitle");
const projectMeta = document.getElementById("projectMeta");
const projectActions = document.getElementById("projectActions");
const filePanel = document.getElementById("filePanel");

const editModal = document.getElementById("editModal");
const editHint = document.getElementById("editHint");
const edit_title = document.getElementById("edit_title");
const edit_category = document.getElementById("edit_category");
const edit_section = document.getElementById("edit_section");
const edit_name = document.getElementById("edit_name");
const edit_downloadable = document.getElementById("edit_downloadable");
const dlBadge = document.getElementById("dlBadge");

function fmtDate(iso){
  if(!iso) return "";
  try{
    const d = new Date(iso);
    return new Intl.DateTimeFormat("en-GB", {
      day:"2-digit", month:"short", year:"numeric",
      hour:"2-digit", minute:"2-digit"
    }).format(d);
  }catch{ return iso; }
}

function esc(s){
  return String(s ?? "")
    .replace(/&/g,"&amp;").replace(/</g,"&lt;")
    .replace(/>/g,"&gt;").replace(/"/g,"&quot;")
    .replace(/'/g,"&#039;");
}

function headers(extra={}){
  return {
    Authorization:"Bearer "+USER,
    "X-Admin-Token":ADMIN_TOKEN,
    ...extra
  };
}

async function apiJson(path, opts={}){
  const res = await fetch(API+path, {
    ...opts,
    headers: { ...(opts.headers||{}), Authorization: "Bearer "+USER, ...(opts.headers?.["X-Admin-Token"] ? {} : {}) }
  });
  const data = await res.json().catch(()=>({}));
  if(!res.ok) throw new Error(data.error || "Request failed");
  return data;
}

function loadProjects(){
  fetch(API+"/projects", { headers: headers() })
    .then(r=>r.json())
    .then(d=>{
      projectsList.innerHTML="";
      (d.projects||[]).forEach(p=>{
        const div = document.createElement("div");
        div.className = "proj-row" + (CURRENT_PROJECT?.id===p.id ? " active" : "");
        const status = (p.status||"active").toLowerCase();

        div.innerHTML = `
          <div>
            <div style="font-weight:900">${esc(p.name)}</div>
            <div class="muted">#${esc(p.storeNumber||"-")} Â· ${esc(p.client||"")}</div>
            <div class="muted" style="margin-top:4px">Updated: ${esc(fmtDate(p.updatedAt || p.createdAt || ""))}</div>
          </div>
          <div>
            <span class="pill ${status==="archived"?"archived":"active"}">${status==="archived"?"Archived":"Active"}</span>
          </div>
        `;
        div.onclick = ()=>selectProject(p.id);
        projectsList.appendChild(div);
      });
    })
    .catch(err=>alert(err.message));
}

function selectProject(projectId){
  fetch(`${API}/projects/${encodeURIComponent(projectId)}/files`, { headers: headers() })
    .then(r=>r.json())
    .then(d=>{
      CURRENT_PROJECT = d.project;
      CURRENT_FILES = d.files || [];

      projectTitle.textContent = CURRENT_PROJECT.name;
      projectMeta.textContent = `ID: ${CURRENT_PROJECT.id} Â· Updated: ${fmtDate(CURRENT_PROJECT.updatedAt || CURRENT_PROJECT.createdAt || "")}`;
      projectActions.style.display = "flex";
      filePanel.style.display = "block";

      renderFiles();
      loadProjects();
    })
    .catch(err=>alert(err.message));
}

function renderFiles(){
  filesTbody.innerHTML = "";
  if(!CURRENT_FILES.length){
    filesTbody.innerHTML = `<tr><td colspan="4" class="muted">No files yet.</td></tr>`;
    return;
  }

  CURRENT_FILES.forEach(f=>{
    const tr = document.createElement("tr");

    const downloadable = (typeof f.downloadable === "undefined") ? true : !!f.downloadable;

    const statusPills = [];
    statusPills.push(`<span class="pill ${f.hidden ? "hidden" : "active"}">${f.hidden ? "Hidden" : "Visible"}</span>`);
    if(!downloadable) statusPills.push(`<span class="pill lock">ðŸ”’ View only</span>`);

    tr.innerHTML = `
      <td>
        <div style="font-weight:900">${esc(f.title || f.name)}</div>
        <div class="muted">${esc(f.name || "")}</div>
      </td>
      <td>
        <div><span class="pill">${esc((f.section||"Documents"))}</span></div>
        ${f.category ? `<div class="muted" style="margin-top:6px">${esc(f.category)}</div>` : ``}
        <div class="muted" style="margin-top:6px">${esc(f.uploadedBy||"")} Â· ${esc(fmtDate(f.uploadedAt||""))}</div>
      </td>
      <td>${statusPills.join(" ")}</td>
      <td class="actions">
        <button class="btn btn-outline btn-sm" onclick="downloadAdmin('${f.id}')">â¬‡ Download</button>
        <button class="btn btn-outline btn-sm" onclick="openEdit('${f.id}')">âœŽ Edit</button>
        <button class="btn btn-warn btn-sm" onclick="toggleHide('${f.id}', ${!f.hidden})">${f.hidden ? "Unhide" : "Hide"}</button>
        <button class="btn btn-danger btn-sm" onclick="deleteFile('${f.id}')">Delete</button>
      </td>
    `;
    filesTbody.appendChild(tr);
  });
}

function downloadAdmin(fileId){
  // admin download (still uses same endpoint)
  const a = document.createElement("a");
  a.href = `${API}/download/${encodeURIComponent(fileId)}?u=${encodeURIComponent(USER)}`;
  a.target = "_blank";
  document.body.appendChild(a);
  a.click();
  a.remove();
}

function createProject(){
  const name = document.getElementById("p_name").value.trim();
  const storeNumber = document.getElementById("p_store").value.trim();
  const client = document.getElementById("p_client").value.trim();
  if(!name) return alert("Project name required");

  fetch(API+"/projects",{
    method:"POST",
    headers:{...headers(), "Content-Type":"application/json"},
    body:JSON.stringify({ name, storeNumber, client })
  })
  .then(r=>r.json())
  .then(()=>{
    document.getElementById("p_name").value="";
    document.getElementById("p_store").value="";
    document.getElementById("p_client").value="";
    loadProjects();
  })
  .catch(err=>alert(err.message));
}

function uploadFile(){
  if(!CURRENT_PROJECT) return alert("Select a project first");
  const fileInput = document.getElementById("f_file");
  const file = fileInput.files?.[0];
  if(!file) return alert("Choose a file");

  const fd = new FormData();
  fd.append("file", file);
  fd.append("title", document.getElementById("f_title").value.trim());
  fd.append("category", document.getElementById("f_category").value.trim());
  fd.append("section", document.getElementById("f_section").value.trim());
  // Option A default is true. If later you want a per-upload toggle, add it here.

  fetch(`${API}/projects/${encodeURIComponent(CURRENT_PROJECT.id)}/upload`,{
    method:"POST",
    headers: headers(), // âœ… IMPORTANT: do NOT set Content-Type for FormData
    body: fd
  })
  .then(r=>r.json())
  .then(()=>{
    document.getElementById("f_title").value="";
    document.getElementById("f_category").value="";
    fileInput.value="";
    selectProject(CURRENT_PROJECT.id);
  })
  .catch(err=>alert(err.message));
}

function renameProject(){
  if(!CURRENT_PROJECT) return;
  const name = prompt("New project name", CURRENT_PROJECT.name);
  if(!name) return;

  fetch(`${API}/projects/${encodeURIComponent(CURRENT_PROJECT.id)}/rename`,{
    method:"POST",
    headers:{...headers(), "Content-Type":"application/json"},
    body: JSON.stringify({
      name,
      storeNumber: CURRENT_PROJECT.storeNumber || "",
      client: CURRENT_PROJECT.client || ""
    })
  })
  .then(r=>r.json())
  .then(()=>selectProject(CURRENT_PROJECT.id))
  .catch(err=>alert(err.message));
}

function archiveProject(){
  if(!CURRENT_PROJECT) return;
  fetch(`${API}/projects/${encodeURIComponent(CURRENT_PROJECT.id)}/archive`,{
    method:"POST",
    headers:{...headers(), "Content-Type":"application/json"},
    body: JSON.stringify({ status:"archived" })
  })
  .then(()=>selectProject(CURRENT_PROJECT.id))
  .catch(err=>alert(err.message));
}

function unarchiveProject(){
  if(!CURRENT_PROJECT) return;
  fetch(`${API}/projects/${encodeURIComponent(CURRENT_PROJECT.id)}/archive`,{
    method:"POST",
    headers:{...headers(), "Content-Type":"application/json"},
    body: JSON.stringify({ status:"active" })
  })
  .then(()=>selectProject(CURRENT_PROJECT.id))
  .catch(err=>alert(err.message));
}

function toggleHide(id, hidden){
  fetch(`${API}/files/${encodeURIComponent(id)}/hide`,{
    method:"POST",
    headers:{...headers(), "Content-Type":"application/json"},
    body: JSON.stringify({ hidden })
  })
  .then(()=>selectProject(CURRENT_PROJECT.id))
  .catch(err=>alert(err.message));
}

function deleteFile(id){
  if(!confirm("Permanently delete this file?")) return;
  fetch(`${API}/files/${encodeURIComponent(id)}`,{
    method:"DELETE",
    headers: headers()
  })
  .then(()=>selectProject(CURRENT_PROJECT.id))
  .catch(err=>alert(err.message));
}

/* --------- Edit modal --------- */
function openEdit(fileId){
  const f = CURRENT_FILES.find(x=>x.id===fileId);
  if(!f) return;

  EDIT_FILE = f;

  editHint.textContent = `${f.id} Â· ${f.name}`;
  edit_title.value = f.title || "";
  edit_category.value = f.category || "";
  edit_section.value = (f.section || "Documents").trim() || "Documents";
  edit_name.value = f.name || "";

  const downloadable = (typeof f.downloadable === "undefined") ? true : !!f.downloadable;
  edit_downloadable.checked = downloadable;
  dlBadge.style.display = downloadable ? "none" : "inline-flex";

  edit_downloadable.onchange = ()=> {
    dlBadge.style.display = edit_downloadable.checked ? "none" : "inline-flex";
  };

  editModal.classList.add("show");
}

function closeEdit(){
  EDIT_FILE = null;
  editModal.classList.remove("show");
}

function saveEdit(){
  if(!EDIT_FILE) return;

  const payload = {
    title: edit_title.value.trim(),
    category: edit_category.value.trim(),
    section: edit_section.value.trim(),
    name: edit_name.value.trim(),
    downloadable: !!edit_downloadable.checked
  };

  fetch(`${API}/files/${encodeURIComponent(EDIT_FILE.id)}/rename`,{
    method:"POST",
    headers:{...headers(), "Content-Type":"application/json"},
    body: JSON.stringify(payload)
  })
  .then(()=> {
    closeEdit();
    selectProject(CURRENT_PROJECT.id);
  })
  .catch(err=>alert(err.message));
}

loadProjects();
</script>

</body>
</html>
