<!DOCTYPE html>
<html lang="en">
<head>
  <script src="auth.js"></script>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Projects Admin – Mostlane</title>

  <style>
    body{
      margin:0;
      font-family:"Segoe UI",system-ui,-apple-system,Arial,sans-serif;
      background:#e6e8eb url('Mostlane_Embossed.png') no-repeat center center fixed;
      background-size:cover;
      color:#1f2937;
    }

    .topbar{
      position:sticky; top:0; z-index:10;
      background:rgba(255,255,255,.75);
      backdrop-filter:blur(6px);
      box-shadow:0 2px 10px rgba(0,0,0,.08);
      padding:10px 14px;
      display:flex;
      justify-content:space-between;
      align-items:center;
    }

    .btn{
      border:none;
      border-radius:10px;
      padding:10px 14px;
      font-size:14px;
      font-weight:600;
      cursor:pointer;
    }
    .btn-outline{background:#fff;border:1px solid #004a99;color:#004a99}
    .btn-primary{background:#004a99;color:#fff}
    .btn-warn{background:#8a5a00;color:#fff}
    .btn-danger{background:#7f1d1d;color:#fff}

    .wrap{
      max-width:1200px;
      margin:16px auto 70px;
      padding:14px;
      background:rgba(255,255,255,.7);
      border-radius:12px;
    }

    .grid{
      display:grid;
      gap:12px;
      grid-template-columns:1fr 1.2fr;
    }
    @media(max-width:900px){
      .grid{grid-template-columns:1fr}
    }

    .card{
      background:#fff;
      border:1px solid #e5e7eb;
      border-radius:12px;
      padding:14px;
    }

    .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .input{
      padding:10px;
      border:1px solid #d1d5db;
      border-radius:8px;
      font-size:14px;
    }

    .muted{font-size:12px;color:#6b7280}

    .proj-row{
      padding:12px;
      border:1px solid #e5e7eb;
      border-radius:12px;
      margin-top:10px;
      cursor:pointer;
    }
    .proj-row.active{border-color:#004a99;background:#f0f6ff}

    .pill{
      padding:4px 10px;
      border-radius:999px;
      font-size:12px;
      border:1px solid #d1d5db;
    }
    .pill.active{background:#ecfdf5;color:#166534;border-color:#86efac}
    .pill.archived{background:#fef2f2;color:#991b1b;border-color:#fecaca}

    table{
      width:100%;
      border-collapse:collapse;
      margin-top:12px;
    }
    th,td{
      padding:10px;
      border-bottom:1px solid #e5e7eb;
      font-size:14px;
      text-align:left;
      vertical-align:top;
    }
    th{
      font-size:12px;
      text-transform:uppercase;
      color:#374151;
    }
    .actions{display:flex;gap:8px;flex-wrap:wrap}
  </style>
</head>

<body>

<div class="topbar">
  <div class="row">
    <button class="btn btn-outline" onclick="location.href='main.html'">⬅ Main Menu</button>
    <strong style="color:#004a99">Projects Admin</strong>
  </div>
  <button class="btn btn-outline" onclick="loadProjects()">⟲ Reload</button>
</div>

<div class="wrap">
  <div class="grid">

    <!-- LEFT -->
    <div class="card">
      <strong>Create project</strong>
      <div class="row" style="margin-top:10px">
        <input id="p_name" class="input" placeholder="Project name" style="flex:1">
        <input id="p_store" class="input" placeholder="Store no">
        <input id="p_client" class="input" placeholder="Client">
        <button class="btn btn-primary" onclick="createProject()">➕ Create</button>
      </div>

      <hr style="margin:16px 0">

      <strong>Projects</strong>
      <div id="projectsList"></div>
    </div>

    <!-- RIGHT -->
    <div class="card">
      <strong id="projectTitle">Select a project</strong>
      <div class="row" id="projectActions" style="margin-top:8px;display:none">
        <button class="btn btn-warn" onclick="archiveProject()">Archive</button>
        <button class="btn btn-primary" onclick="unarchiveProject()">Unarchive</button>
        <button class="btn btn-outline" onclick="renameProject()">Rename</button>
      </div>

      <div id="filePanel" style="display:none;margin-top:16px">
        <div class="row">
          <input id="f_title" class="input" placeholder="File title">
          <input id="f_category" class="input" placeholder="Category">
          <input id="f_file" type="file" class="input">
          <button class="btn btn-primary" onclick="uploadFile()">⬆ Upload</button>
        </div>

        <table>
          <thead>
            <tr>
              <th>File</th>
              <th>Meta</th>
              <th>Status</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="filesTbody"></tbody>
        </table>
      </div>
    </div>

  </div>
</div>

<script>
const API = "https://projects-ml-portal.jamie-def.workers.dev";
const USER = sessionStorage.getItem("mostlaneUser");
const ADMIN_TOKEN = "Hbdkwnainj2758";
if(!USER) location.href="login.html";

let CURRENT_PROJECT = null;

function headers(extra={}){
  return {
    Authorization:"Bearer "+USER,
    "X-Admin-Token":ADMIN_TOKEN,
    ...extra
  };
}

/* ---------- PROJECTS ---------- */

function loadProjects(){
  fetch(API+"/projects",{headers:{Authorization:"Bearer "+USER}})
    .then(r=>r.json())
    .then(d=>{
      const list=document.getElementById("projectsList");
      list.innerHTML="";
      d.projects.forEach(p=>{
        const div=document.createElement("div");
        div.className="proj-row"+(CURRENT_PROJECT?.id===p.id?" active":"");
        div.innerHTML=`
          <strong>${p.name}</strong><br>
          <span class="pill ${p.status}">${p.status}</span>
        `;
        div.onclick=()=>selectProject(p);
        list.appendChild(div);
      });
    });
}

function selectProject(p){
  CURRENT_PROJECT=p;
  document.getElementById("projectTitle").textContent=p.name;
  document.getElementById("projectActions").style.display="flex";
  document.getElementById("filePanel").style.display="block";
  loadFiles();
  loadProjects();
}

function createProject(){
  fetch(API+"/projects",{
    method:"POST",
    headers:{...headers(),"Content-Type":"application/json"},
    body:JSON.stringify({
      name:p_name.value,
      storeNumber:p_store.value,
      client:p_client.value
    })
  }).then(()=>{ p_name.value=p_store.value=p_client.value=""; loadProjects(); });
}

function renameProject(){
  const name=prompt("New project name",CURRENT_PROJECT.name);
  if(!name) return;

  fetch(`${API}/projects/${CURRENT_PROJECT.id}/rename`,{
    method:"POST",
    headers:{...headers(),"Content-Type":"application/json"},
    body:JSON.stringify({ name })
  }).then(()=>loadProjects());
}

function archiveProject(){
  fetch(`${API}/projects/${CURRENT_PROJECT.id}/archive`,{
    method:"POST",
    headers:{...headers(),"Content-Type":"application/json"},
    body:JSON.stringify({ status:"archived" })
  }).then(()=>loadProjects());
}

function unarchiveProject(){
  fetch(`${API}/projects/${CURRENT_PROJECT.id}/archive`,{
    method:"POST",
    headers:{...headers(),"Content-Type":"application/json"},
    body:JSON.stringify({ status:"active" })
  }).then(()=>loadProjects());
}

/* ---------- FILES ---------- */

function loadFiles(){
  fetch(`${API}/projects/${CURRENT_PROJECT.id}/files`,{headers:{Authorization:"Bearer "+USER}})
    .then(r=>r.json())
    .then(d=>{
      const tb=document.getElementById("filesTbody");
      tb.innerHTML="";
      d.files.forEach(f=>{
        const tr=document.createElement("tr");
        tr.innerHTML=`
          <td>
            <strong>${f.title||f.name}</strong><br>
            <span class="muted">${f.name}</span>
          </td>
          <td>${f.category||""}</td>
          <td><span class="pill ${f.hidden?"archived":"active"}">${f.hidden?"Hidden":"Active"}</span></td>
          <td class="actions">
            <button class="btn btn-outline" onclick="renameFile('${f.id}','${(f.title||"").replace(/'/g,"")}')">Rename</button>
            <button class="btn btn-warn" onclick="toggleHide('${f.id}',${!f.hidden})">${f.hidden?"Unhide":"Hide"}</button>
            <button class="btn btn-danger" onclick="deleteFile('${f.id}')">Delete</button>
          </td>
        `;
        tb.appendChild(tr);
      });
    });
}

function uploadFile(){
  const fd=new FormData();
  fd.append("file",f_file.files[0]);
  fd.append("title",f_title.value);
  fd.append("category",f_category.value);

  fetch(`${API}/projects/${CURRENT_PROJECT.id}/upload`,{
    method:"POST",
    headers:headers(),
    body:fd
  }).then(()=>{ f_file.value=f_title.value=f_category.value=""; loadFiles(); });
}

function renameFile(id,current){
  const title=prompt("New file title",current);
  if(title===null) return;

  fetch(`${API}/files/${id}/rename`,{
    method:"POST",
    headers:{...headers(),"Content-Type":"application/json"},
    body:JSON.stringify({ title })
  }).then(()=>loadFiles());
}

function toggleHide(id,hidden){
  fetch(`${API}/files/${id}/hide`,{
    method:"POST",
    headers:{...headers(),"Content-Type":"application/json"},
    body:JSON.stringify({ hidden })
  }).then(()=>loadFiles());
}

function deleteFile(id){
  if(!confirm("Permanently delete this file?")) return;
  fetch(`${API}/files/${id}`,{
    method:"DELETE",
    headers:headers()
  }).then(()=>loadFiles());
}

loadProjects();
</script>

</body>
</html>
