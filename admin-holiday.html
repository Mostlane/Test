<script>
const token = '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';
const username = 'Mostlane';
const repo = 'Test';
const filePath = 'holiday-log.json';

const formatDate = dateStr => {
  const d = new Date(dateStr);
  const day = String(d.getDate()).padStart(2, '0');
  const month = String(d.getMonth() + 1).padStart(2, '0');
  const year = d.getFullYear();
  return `${day}-${month}-${year}`;
};

async function fetchLogData() {
  const res = await fetch(`https://raw.githubusercontent.com/${username}/${repo}/main/${filePath}`);
  return await res.json();
}

async function loadData() {
  const logs = await fetchLogData();
  renderRequests(logs);
  renderCalendar(logs);
}

function renderRequests(logs) {
  const container = document.getElementById("holidayRequests");
  container.innerHTML = "";

  logs.forEach(entry => {
    const div = document.createElement("div");
    div.className = "request";

    div.innerHTML = `
      <strong>${entry.name.replace('.', ' ')}</strong><br>
      <strong>Type:</strong> ${entry.type}<br>
      <strong>Start:</strong> ${formatDate(entry.start)}<br>
      <strong>End:</strong> ${formatDate(entry.end)}<br>
      <strong>Status:</strong> ${entry.status}<br>
      <strong>Notes:</strong> ${entry.notes || "None"}<br><br>
      <button class="btn approve" onclick="handleAction('${entry.name}','${entry.start}','${entry.end}','Approved')">Approve</button>
      <button class="btn decline" onclick="handleAction('${entry.name}','${entry.start}','${entry.end}','Declined')">Decline</button>
    `;

    container.appendChild(div);
  });
}

async function handleAction(name, start, end, action) {
  const logs = await fetchLogData();
  logs.forEach(e => {
    if (e.name === name && e.start === start && e.end === end) {
      e.status = action;
    }
  });

  const content = btoa(unescape(encodeURIComponent(JSON.stringify(logs, null, 2))));
  const sha = await getFileSHA();

  await fetch(`https://api.github.com/repos/${username}/${repo}/contents/${filePath}`, {
    method: "PUT",
    headers: {
      "Authorization": `Bearer ${token}`,
      "Content-Type": "application/json"
    },
    body: JSON.stringify({
      message: `${action} holiday for ${name}`,
      content,
      sha
    })
  });

  alert(`${action} ${name.replace('.', ' ')} for ${formatDate(start)} to ${formatDate(end)}`);
  location.reload();
}

async function getFileSHA() {
  const res = await fetch(`https://api.github.com/repos/${username}/${repo}/contents/${filePath}`, {
    headers: { "Authorization": `Bearer ${token}` }
  });
  const json = await res.json();
  return json.sha;
}

function renderCalendar(logs) {
  const grouped = {};
  logs.forEach(entry => {
    const start = new Date(entry.start);
    const end = new Date(entry.end);
    const current = new Date(start);
    while (current <= end) {
      const key = current.toISOString().split('T')[0];
      if (!grouped[key]) grouped[key] = [];
      grouped[key].push(`${entry.name.replace('.', ' ')} â€“ ${entry.type}`);
      current.setDate(current.getDate() + 1);
    }
  });

  const calendar = document.getElementById("calendarView");
  calendar.innerHTML = "";
  Object.keys(grouped).sort().forEach(date => {
    const div = document.createElement("div");
    const isClash = grouped[date].length > 1;
    div.className = `calendar-day${isClash ? " clash" : ""}`;
    div.innerHTML = `<strong>${formatDate(date)}</strong><br>` +
      grouped[date].map(name => `<div class="holiday-entry">${name}</div>`).join("");
    calendar.appendChild(div);
  });
}

loadData();
</script>
