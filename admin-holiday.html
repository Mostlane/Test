
<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Holiday Admin</title>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background: #e6e8eb url('Mostlane_Embossed.png') no-repeat center center fixed;
      background-size: 180%;
      padding: 40px 20px;
    }
    .container {
      max-width: 1000px;
      margin: auto;
      background: rgba(255,255,255,0.6);
      padding: 30px;
      border-radius: 10px;
    }
    h2 {
      color: #003366;
      text-align: center;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }
    th, td {
      padding: 10px;
      text-align: left;
      background-color: white;
      border-bottom: 1px solid #ccc;
    }
    th {
      background-color: #003366;
      color: white;
    }
    button {
      padding: 6px 10px;
      margin-right: 5px;
      border: none;
      border-radius: 4px;
      background-color: #004a99;
      color: white;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>Holiday Admin Panel</h2>
    <table>
      <thead>
        <tr>
          <th>Engineer</th>
          <th>Start</th>
          <th>End</th>
          <th>Type</th>
          <th>Notes</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody id="admin-rows">
        <tr><td colspan="6">Loading...</td></tr>
      </tbody>
    </table>
  </div>
  
<script>
const allowedUsers = ["Jamie.Line", "Greg.Line", "Joe.Line"];
const currentUser = sessionStorage.getItem("mostlaneUser");
if (!allowedUsers.includes(currentUser)) {
  document.body.innerHTML = "<h2 style='text-align:center;'>Access Denied</h2>";
}

const GITHUB_TOKEN = "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";
const REPO = "Mostlane/Test";
const LOG_FILE = "holiday-log.json";
const SUMMARY_FILE = "holiday-summary.json";

async function fetchLog() {
  const res = await fetch("https://raw.githubusercontent.com/" + REPO + "/main/" + LOG_FILE);
  return res.json();
}

function format(dateStr) {
  const date = new Date(dateStr);
  return date.toISOString().split("T")[0];
}

function calcDays(start, end) {
  const s = new Date(start);
  const e = new Date(end);
  return Math.round((e - s) / 86400000) + 1;
}

function buildSummary(log) {
  const summary = {};
  log.forEach(row => {
    const { name, start, end, type, status } = row;
    if (!summary[name]) {
      summary[name] = {
        available: 28,
        used: 0,
        booked: 0,
        shutdown: 0,
        bankholidays: 0,
        accumulated: 0,
        remaining: 28,
        approved: [],
        pending: [],
        shutdownDates: [],
        bankHolidayDates: []
      };
    }

    const days = calcDays(start, end);
    const today = new Date().toISOString().split("T")[0];

    if (status === "Approved") {
      if (type === "Bank Holiday") {
        summary[name].bankholidays += days;
        summary[name].bankHolidayDates.push(start);
      } else if (type === "Compulsory Leave") {
        summary[name].shutdown += days;
        summary[name].shutdownDates.push(start);
      } else if (type === "Annual Leave" || type === "Sick Leave") {
        if (start >= today) {
          summary[name].booked += days;
          summary[name].approved.push({ date: start, type, duration: days });
        } else {
          summary[name].used += days;
        }
      }
    } else if (status === "Pending") {
      summary[name].pending.push({ date: start, type, duration: days });
    }

    summary[name].accumulated = summary[name].used + summary[name].booked + summary[name].shutdown + summary[name].bankholidays;
    summary[name].remaining = summary[name].available - summary[name].accumulated;
  });

  return summary;
}

async function uploadToGitHub(path, contentObj, commitMessage) {
  const getSHA = await fetch("https://api.github.com/repos/" + REPO + "/contents/" + path, {
    headers: { Authorization: "token " + GITHUB_TOKEN }
  }).then(r => r.json()).then(d => d.sha);

  const content = btoa(unescape(encodeURIComponent(JSON.stringify(contentObj, null, 2))));

  return fetch("https://api.github.com/repos/" + REPO + "/contents/" + path, {
    method: "PUT",
    headers: {
      Authorization: "token " + GITHUB_TOKEN,
      "Content-Type": "application/json"
    },
    body: JSON.stringify({
      message: commitMessage,
      committer: { name: "Mostlane Bot", email: "admin@mostlane.com" },
      content,
      sha: getSHA
    })
  });
}

async function approve(index) {
  const log = await fetchLog();
  log[index].status = "Approved";
  await uploadToGitHub(LOG_FILE, log, "Approved request by admin");
  const summary = buildSummary(log);
  await uploadToGitHub(SUMMARY_FILE, summary, "Updated summary after approval");
  alert("Approved and updated.");
  location.reload();
}

async function reject(index) {
  const log = await fetchLog();
  log[index].status = "Rejected";
  await uploadToGitHub(LOG_FILE, log, "Rejected request by admin");
  alert("Rejected.");
  location.reload();
}

async function populateTable() {
  const table = document.getElementById("admin-rows");
  const log = await fetchLog();
  table.innerHTML = "";
  log.forEach((row, i) => {
    if (row.status === "Pending") {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${row.name}</td>
        <td>${row.start}</td>
        <td>${row.end}</td>
        <td>${row.type}</td>
        <td>${row.notes}</td>
        <td>
          <button onclick="approve(${i})">Approve</button>
          <button onclick="reject(${i})">Reject</button>
        </td>
      `;
      table.appendChild(tr);
    }
  });
}

document.addEventListener("DOMContentLoaded", populateTable);
</script>

</body>
</html>
