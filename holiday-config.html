<!DOCTYPE html>
<html lang="en">
<head>
<script src="auth.js"></script>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Holiday Configuration</title>

<style>
  body{
    font-family:'Segoe UI',sans-serif;
    background:#e6e8eb url('Mostlane_Embossed.png') no-repeat center center fixed;
    background-size:180%;
    margin:0;
    padding:40px 20px;
  }

  .container{
    max-width:900px;
    margin:auto;
  }

  .section{
    background:rgba(255,255,255,0.7);
    padding:30px;
    border-radius:8px;
    margin-bottom:20px;
  }

  h2{
    text-align:center;
    color:#003366;
    margin-top:0;
  }

  label{
    display:block;
    margin-top:15px;
    font-weight:bold;
  }

  input{
    width:100%;
    padding:10px;
    margin-top:6px;
    font-size:16px;
  }

  button{
    margin-top:20px;
    padding:12px;
    width:100%;
    background:#004a99;
    color:white;
    font-size:16px;
    border:none;
    border-radius:6px;
    cursor:pointer;
  }

  ul{
    padding-left:18px;
    font-size:14px;
  }
</style>
</head>

<body>

<div style="text-align:right; margin-bottom:20px;">
  <button onclick="location.href='main.html'" style="width:auto;">Main Menu</button>
</div>

<div class="container">

  <div class="section">
    <h2>Holiday Settings</h2>

    <label>Annual Allowance (Days)</label>
    <input type="number" id="allowance">

    <label>Bank Holidays (YYYY-MM-DD)</label>
    <input id="bankInput" placeholder="e.g. 2025-12-25">
    <button onclick="addBank()">Add Bank Holiday</button>
    <ul id="bankList"></ul>

    <label>Shutdown Days (YYYY-MM-DD)</label>
    <input id="shutdownInput" placeholder="e.g. 2025-12-24">
    <button onclick="addShutdown()">Add Shutdown Day</button>
    <ul id="shutdownList"></ul>

    <button onclick="saveConfig()">Save Configuration</button>
  </div>

</div>

<script>
const API = "https://mostlane-holidays.jamie-def.workers.dev";
const username = sessionStorage.getItem("mostlaneUser");
const role = sessionStorage.getItem("mostlaneRole");

// ----------------------------
// ðŸ” HARD SESSION GUARD
// ----------------------------
if (!username) {
  alert("Session expired. Please log in again.");
  location.href = "login.html";
}

// ----------------------------
// ðŸ” PERMISSION CHECK
// FullAccess OR HolidayAdmin allowed
// ----------------------------
(async () => {
  const res = await fetch(
    "https://mostlane-users.jamie-def.workers.dev/user?u=" +
    encodeURIComponent(username)
  );
  const data = await res.json();

  if (!data.found) {
    alert("User not found");
    location.href = "main.html";
    return;
  }

  const u = data.user;
  const fullAccess = (u.FullAccess || "").toLowerCase() === "yes";
  const holidayAdmin =
    (u.HolidayAdmin || "").toLowerCase() === "yes" ||
    (u.HolidayAdminAccess || "").toLowerCase() === "yes";

  if (!fullAccess && !holidayAdmin) {
    alert("Access denied");
    location.href = "main.html";
  }
})();

// ----------------------------
// ðŸ“¦ CONFIG MODEL
// ----------------------------
let config = {
  allowance: 28,
  bankHolidays: [],
  shutdownDays: []
};

function render(){
  allowance.value = config.allowance;
  bankList.innerHTML = config.bankHolidays.map(d=>`<li>${d}</li>`).join("");
  shutdownList.innerHTML = config.shutdownDays.map(d=>`<li>${d}</li>`).join("");
}

// ----------------------------
// ðŸ”„ LOAD CONFIG
// ----------------------------
async function load(){
  const res = await fetch(API + "/holiday/config", {
    headers:{
      "X-User": username,
      "X-Role": role
    }
  });

  if (res.ok) {
    config = await res.json();
  }

  render();
}

// ----------------------------
// âž• ADD ITEMS
// ----------------------------
function addBank(){
  if(bankInput.value){
    if (!config.bankHolidays.includes(bankInput.value))
      config.bankHolidays.push(bankInput.value);
    bankInput.value="";
    render();
  }
}

function addShutdown(){
  if(shutdownInput.value){
    if (!config.shutdownDays.includes(shutdownInput.value))
      config.shutdownDays.push(shutdownInput.value);
    shutdownInput.value="";
    render();
  }
}

// ----------------------------
// ðŸ’¾ SAVE CONFIG
// ----------------------------
async function saveConfig(){
  config.allowance = Number(allowance.value) || 28;

  await fetch(API + "/holiday/config", {
    method:"POST",
    headers:{
      "Content-Type":"application/json",
      "X-User": username,
      "X-Role": role
    },
    body:JSON.stringify(config)
  });

  alert("Holiday configuration saved");
}

load();
</script>

</body>
</html>
