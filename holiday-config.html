const corsHeaders = {
  "Access-Control-Allow-Origin": "*",
  "Access-Control-Allow-Methods": "GET, POST, OPTIONS",
  "Access-Control-Allow-Headers": "Content-Type, X-User, X-Role"
};

export default {
  async fetch(req, env) {
    // --------------------
    // CORS PREFLIGHT
    // --------------------
    if (req.method === "OPTIONS") {
      return new Response(null, { headers: corsHeaders });
    }

    const url = new URL(req.url);
    const path = url.pathname;
    const method = req.method;

    const user = req.headers.get("X-User");
    const role = req.headers.get("X-Role");

    if (!user) {
      return new Response("Unauthorised", {
        status: 401,
        headers: corsHeaders
      });
    }

    // ---------------------------
    // SUBMIT HOLIDAY REQUEST
    // ---------------------------
    if (path === "/holiday/request" && method === "POST") {
      const body = await req.json();

      const id = `H-${Date.now()}`;
      const start = body.start;
      const end = body.end;

      const days =
        (new Date(end) - new Date(start)) / (1000 * 60 * 60 * 24) + 1;

      const entry = {
        id,
        engineer: user.replace(".", " "),
        username: user,
        start,
        end,
        days,
        type: body.type,
        notes: body.notes || "",
        status: "Pending",
        submittedAt: new Date().toISOString(),
        approvedBy: null,
        decisionAt: null
      };

      await env.HOLIDAYS_KV.put(`holiday:${id}`, JSON.stringify(entry));

      await env.HOLIDAY_LOG_KV.put(
        `log:${id}:001`,
        JSON.stringify({
          requestId: id,
          action: "Submitted",
          by: user,
          timestamp: new Date().toISOString()
        })
      );

      return new Response(
        JSON.stringify({ success: true, id }),
        { headers: corsHeaders }
      );
    }

    // ---------------------------
    // MY HOLIDAYS
    // ---------------------------
    if (path === "/holiday/my" && method === "GET") {
      const list = await env.HOLIDAYS_KV.list({ prefix: "holiday:" });
      const results = [];

      for (const key of list.keys) {
        const item = JSON.parse(await env.HOLIDAYS_KV.get(key.name));
        if (item.username === user) results.push(item);
      }

      return new Response(JSON.stringify(results), { headers: corsHeaders });
    }

    // ---------------------------
    // SUMMARY
    // ---------------------------
    if (path === "/holiday/summary" && method === "GET") {
      const config = JSON.parse(
        (await env.HOLIDAY_CONFIG_KV.get("config")) ||
        JSON.stringify({ allowance: 28 })
      );

      const list = await env.HOLIDAYS_KV.list({ prefix: "holiday:" });
      let used = 0;

      for (const key of list.keys) {
        const h = JSON.parse(await env.HOLIDAYS_KV.get(key.name));
        if (h.username === user && h.status === "Approved") {
          used += h.days;
        }
      }

      return new Response(
        JSON.stringify({
          allowance: config.allowance,
          used,
          remaining: config.allowance - used
        }),
        { headers: corsHeaders }
      );
    }

    // ---------------------------
    // ADMIN â€“ ALL HOLIDAYS
    // ---------------------------
    if (path === "/holiday/all" && method === "GET") {
      if (!["Admin", "Director"].includes(role)) {
        return new Response("Forbidden", {
          status: 403,
          headers: corsHeaders
        });
      }

      const list = await env.HOLIDAYS_KV.list({ prefix: "holiday:" });
      const results = [];

      for (const key of list.keys) {
        results.push(JSON.parse(await env.HOLIDAYS_KV.get(key.name)));
      }

      return new Response(JSON.stringify(results), { headers: corsHeaders });
    }

    // ---------------------------
    // APPROVE / REJECT
    // ---------------------------
    if (
      ["/holiday/approve", "/holiday/reject"].includes(path) &&
      method === "POST"
    ) {
      if (!["Admin", "Director"].includes(role)) {
        return new Response("Forbidden", {
          status: 403,
          headers: corsHeaders
        });
      }

      const { id } = await req.json();
      const record = JSON.parse(
        await env.HOLIDAYS_KV.get(`holiday:${id}`)
      );

      record.status = path.endsWith("approve") ? "Approved" : "Rejected";
      record.approvedBy = user;
      record.decisionAt = new Date().toISOString();

      await env.HOLIDAYS_KV.put(`holiday:${id}`, JSON.stringify(record));

      await env.HOLIDAY_LOG_KV.put(
        `log:${id}:${Date.now()}`,
        JSON.stringify({
          requestId: id,
          action: record.status,
          by: user,
          timestamp: new Date().toISOString()
        })
      );

      return new Response(JSON.stringify({ success: true }), {
        headers: corsHeaders
      });
    }

    return new Response("Not Found", { status: 404, headers: corsHeaders });
  }
};
