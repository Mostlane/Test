<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Mostlane • My Jobs</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="auth.js"></script>

  <style>
    :root{
      --ml-blue:#003b82;
      --ml-blue-light:#1e66ff;
      --ml-bg:#e6e8eb;
      --panel:rgba(255,255,255,0.9);
      --text:#0f172a;
      --muted:#6b7280;
      --border:#d1d5db;
      --ok:#16a34a;
      --warn:#f97316;
      --bad:#dc2626;
    }
    *{box-sizing:border-box;}
    html,body{
      margin:0;padding:0;
      font-family:system-ui,-apple-system,"Segoe UI",Roboto,Arial,sans-serif;
      color:var(--text);
      background:#e6e8eb url('Mostlane_Embossed.png') no-repeat center center fixed;
      background-size:180%;
    }
    .shell{
      max-width:1100px;
      margin:24px auto;
      padding:0 16px;
    }
    .card{
      background:var(--panel);
      border-radius:14px;
      box-shadow:0 12px 28px rgba(0,0,0,0.12);
      border:1px solid rgba(15,23,42,0.05);
      overflow:hidden;
    }
    header.main-header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding:16px 20px;
      background:linear-gradient(90deg,#ffffff,#f3f4f6);
      border-bottom:1px solid #e5e7eb;
    }
    header h1{
      margin:0;
      font-size:20px;
      color:var(--ml-blue);
    }
    header .sub{
      font-size:12px;
      color:var(--muted);
    }
    .btn{
      border-radius:999px;
      padding:8px 14px;
      font-size:13px;
      border:1px solid #d1d5db;
      background:#f9fafb;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      gap:6px;
      text-decoration:none;
      color:var(--text);
      font-weight:500;
      white-space:nowrap;
      user-select:none;
      -webkit-user-select:none;
      -webkit-touch-callout:none;
      touch-action:manipulation;
    }
    .btn.primary{
      background:var(--ml-blue);
      color:#fff;
      border-color:var(--ml-blue);
    }
    .content{
      padding:14px 18px 16px;
    }

    /* === Controls === */
    .nav-row{
      display:flex;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
      margin-bottom:10px;
    }
    .nav-row .btn{
      flex:1 1 180px;
      justify-content:center;
    }
    .hint{
      text-align:center;
      font-size:11px;
      color:var(--muted);
      margin-top:4px;
      margin-bottom:12px;
    }

    /* === Timeline Styles === */
    .day-group{
      margin-top:18px;
    }
    .day-banner{
      position:sticky;
      top:0;
      z-index:5;
      background:#f1f5f9;
      padding:6px 12px;
      font-size:12px;
      font-weight:600;
      color:#334155;
      border-radius:8px;
      margin-bottom:8px;
      border:1px solid #e5e7eb;
    }
    .job-card{
      background:#fff;
      border:1px solid #e5e7eb;
      border-radius:12px;
      padding:12px;
      margin-bottom:10px;
      box-shadow:0 4px 10px rgba(0,0,0,0.05);
    }
    .job-top{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:8px;
      margin-bottom:6px;
    }
    .ref{
      font-family:monospace;
      font-size:12px;
      background:#f9fafb;
      padding:2px 6px;
      border-radius:999px;
      display:inline-block;
    }
    .priority-badge{
      border-radius:999px;
      padding:2px 7px;
      font-size:11px;
      font-weight:600;
      display:inline-flex;
      align-items:center;
    }
    .p1{background:#fef2f2;color:#b91c1c;}
    .p2{background:#fffbeb;color:#92400e;}
    .p3{background:#ecfdf5;color:#166534;}
    .p4{background:#eff6ff;color:#1d4ed8;}

    .job-desc{
      font-size:14px;
      font-weight:500;
    }
    .job-site{
      font-size:12px;
      color:var(--muted);
      margin-top:2px;
    }
    .job-meta{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      margin-top:10px;
      align-items:center;
    }
    .sla-badge{
      border-radius:999px;
      padding:3px 8px;
      font-size:11px;
      display:inline-flex;
      align-items:center;
      gap:4px;
      font-variant-numeric:tabular-nums;
      white-space:nowrap;
    }
    .sla-green{background:#ecfdf5;color:#166534;}
    .sla-amber{background:#fffbeb;color:#92400e;}
    .sla-red{background:#fef2f2;color:#b91c1c;}
    .sla-none{background:#e5e7eb;color:#4b5563;}

    .status-pill{
      border-radius:999px;
      padding:3px 8px;
      font-size:11px;
      display:inline-flex;
      align-items:center;
      gap:4px;
      background:#e5e7eb;
      color:#111827;
    }
    .status-open{background:#dcfce7;color:#166534;}
    .status-overdue{background:#fee2e2;color:#b91c1c;}
    .status-complete{background:#e5e7eb;color:#374151;}

    .small{font-size:11px;}
    .muted{color:var(--muted);}

    /* === Modal === */
    .modal-backdrop{
      position:fixed;
      inset:0;
      background:rgba(15,23,42,0.45);
      display:none;
      align-items:center;
      justify-content:center;
      padding:16px;
      z-index:9999;
    }
    .modal-card{
      width:min(520px, 100%);
      background:rgba(255,255,255,0.95);
      border:1px solid rgba(15,23,42,0.08);
      border-radius:14px;
      box-shadow:0 18px 40px rgba(0,0,0,0.18);
      padding:14px;
    }
    .modal-title{
      margin:0 0 6px 0;
      font-size:16px;
      color:var(--ml-blue);
    }
    .modal-sub{
      margin:0 0 12px 0;
      font-size:12px;
      color:var(--muted);
    }
    .modal-actions{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
    }
    .modal-actions .btn{
      flex:1 1 140px;
      justify-content:center;
    }
    .btn.danger{
      background:#fff;
      border-color:#ef4444;
      color:#b91c1c;
    }
  </style>
</head>

<body>
<div class="shell">
  <div class="card">
    <header class="main-header">
      <div>
        <h1>My Jobs</h1>
        <div class="sub" id="userLabel">Engineer</div>
      </div>
      <a href="sla-main.html" class="btn">← Back to SLA Board</a>
    </header>

    <div class="content">
      <div class="nav-row">
        <button type="button" class="btn" id="prevWeekBtn">← Previous Week</button>
        <button type="button" class="btn" id="nextWeekBtn">Next Week →</button>
      </div>
      <div class="hint">Tip: Hold either button for 3 seconds to load 30 / 60 / 90 day history</div>

      <div id="jobsTimeline"></div>

      <div id="statusBar" class="muted small" style="text-align:center;padding:12px">
        Loading jobs…
      </div>
    </div>
  </div>
</div>

<div class="modal-backdrop" id="rangeModal" role="dialog" aria-modal="true" aria-hidden="true">
  <div class="modal-card">
    <h3 class="modal-title">Load job history</h3>
    <p class="modal-sub">Choose a range to load. Jobs are grouped by date.</p>
    <div class="modal-actions">
      <button type="button" class="btn" id="load30Btn">Last 30 days</button>
      <button type="button" class="btn" id="load60Btn">Last 60 days</button>
      <button type="button" class="btn" id="load90Btn">Last 90 days</button>
      <button type="button" class="btn danger" id="closeModalBtn">Cancel</button>
    </div>
  </div>
</div>

<script>
const SLA_API = "https://mostlane-sla.jamie-def.workers.dev";

let countdownTimerId = null;

let anchorDate = new Date();
let loadedDates = new Set();
let loadedRanges = new Set();
let loading = false;

const $ = id => document.getElementById(id);

function getEngineer(){
  return sessionStorage.getItem("mostlaneUser") ||
         sessionStorage.getItem("mostlaneUsername") ||
         sessionStorage.getItem("username") || "";
}

function parseDate(v){
  if(!v) return null;
  const d = new Date(v);
  return isNaN(d) ? null : d;
}

function computeSlaCountdown(targetISO){
  if(!targetISO){
    return {text:"—", cls:"sla-badge sla-none", status:"none"};
  }
  const now = new Date();
  const target = parseDate(targetISO);
  if(!target){
    return {text:"—", cls:"sla-badge sla-none", status:"none"};
  }

  let diff = target - now;
  const overdue = diff < 0;
  if(overdue) diff = -diff;

  const secs = Math.floor(diff/1000);
  const days = Math.floor(secs/86400);
  const hours = Math.floor((secs%86400)/3600);
  const mins = Math.floor((secs%3600)/60);

  let label = overdue ? "+" : "";
  if(days>0){
    label += `${days}d ${String(hours).padStart(2,"0")}h`;
  } else {
    label += `${String(hours).padStart(2,"0")}:${String(mins).padStart(2,"0")}`;
  }

  const hoursLeft = (target - now) / 3600000;
  let cls = "sla-badge sla-green";
  let status = "ok";

  if(overdue || hoursLeft <= 0){
    cls = "sla-badge sla-red";
    status = "overdue";
  } else if(hoursLeft <= 1){
    cls = "sla-badge sla-red";
    status = "overdueSoon";
  } else if(hoursLeft <= 4){
    cls = "sla-badge sla-amber";
    status = "warn";
  }

  return {
    text: (overdue ? "Overdue " : "Due in ") + label,
    cls,
    status
  };
}

function statusClass(status, slaStatus){
  const s = (status || "").toLowerCase();
  if(s.includes("complete") || s.includes("closed")){
    return "status-pill status-complete";
  }
  if(slaStatus === "overdue" || slaStatus === "overdueSoon"){
    return "status-pill status-overdue";
  }
  return "status-pill status-open";
}

function isoDate(d){
  return d.toISOString().slice(0,10);
}

function startOfWeek(d){
  const date = new Date(d);
  date.setHours(0,0,0,0);
  const day = date.getDay() || 7;
  if(day !== 1) date.setDate(date.getDate() - (day - 1));
  return date;
}
function endOfWeek(d){
  const s = startOfWeek(d);
  const e = new Date(s);
  e.setDate(e.getDate() + 6);
  e.setHours(0,0,0,0);
  return e;
}
function addDays(d, n){
  const x = new Date(d);
  x.setDate(x.getDate() + n);
  return x;
}
function endOfToday(){
  const d = new Date();
  d.setHours(23,59,59,999);
  return d;
}
function renderDay(dateStr, jobs, mode){
  const container = $("jobsTimeline");

  const group = document.createElement("div");
  group.className = "day-group";

  const banner = document.createElement("div");
  banner.className = "day-banner";
  banner.textContent = new Date(dateStr).toLocaleDateString("en-GB", {
    weekday:"long", day:"2-digit", month:"short", year:"numeric"
  });

  group.appendChild(banner);

  if(!jobs.length){
    const empty = document.createElement("div");
    empty.className = "muted small";
    empty.style.padding = "8px 12px";
    empty.textContent = "No jobs";
    group.appendChild(empty);
  }

  for(const job of jobs){
    const target = job.targetAt || job.sla?.targetAt;
    const slaInfo = computeSlaCountdown(target);

    const card = document.createElement("div");
    card.className = "job-card";
    card.innerHTML = `
      <div class="job-top">
        <span class="ref">${job.helpdeskRef || job.id}</span>
        <span class="priority-badge ${job.priority?.toLowerCase() || "p4"}">${job.priority || "P4"}</span>
      </div>

      <div class="job-desc">${job.description || ""}</div>
      <div class="job-site">${job.siteName || job.address || ""}</div>

      <div class="job-meta">
        <span class="${slaInfo.cls}" data-sla-target="${target || ""}">
          ${slaInfo.text}
        </span>
        <span class="${statusClass(job.status, slaInfo.status)}">
          ${job.status || "Open"}
        </span>
        <a class="btn primary" href="job-view.html?jobId=${encodeURIComponent(job.id)}">Open</a>
      </div>
    `;
    group.appendChild(card);
  }

  if(mode === "prepend"){
    container.prepend(group);
  }else{
    container.appendChild(group);
  }
}

async function loadDay(dateObj, mode){
  const engineer = getEngineer();
  if(!engineer){
    $("statusBar").textContent = "No logged-in engineer.";
    return;
  }

  const dateStr = isoDate(dateObj);
  if(loadedDates.has(dateStr)) return;

  try{
    const res = await fetch(
      `${SLA_API}/jobs/for-engineer?engineer=${encodeURIComponent(engineer)}&date=${encodeURIComponent(dateStr)}`,
      { cache:"no-store" }
    );
    const list = await res.json();

    renderDay(dateStr, Array.isArray(list) ? list : [], mode);
    loadedDates.add(dateStr);
    startCountdownLoop();
  }catch(err){
    console.error(err);
    $("statusBar").textContent = "Error loading jobs.";
  }
}

async function loadWeek(direction){
  if(loading) return;
  loading = true;

  try{
    const base = new Date(anchorDate);
    base.setDate(base.getDate() + (direction * 7));
/* ===== FUTURE WEEK GUARD (ADD THIS BLOCK) ===== */
if(direction > 0 && startOfWeek(base) > endOfToday()){
  $("statusBar").textContent = "Cannot load future weeks.";
  return;
}
/* ===== END GUARD ===== */
    const from = startOfWeek(base);
    const to = endOfWeek(base);

    const rangeKey = `${isoDate(from)}:${isoDate(to)}`;
    if(loadedRanges.has(rangeKey)){
      $("statusBar").textContent = "Week already loaded.";
      return;
    }

    $("statusBar").textContent = "Loading week…";

    const days = [];
    for(let i=0;i<7;i++) days.push(addDays(from, i));

    if(direction < 0){
      days.reverse();
      for(const d of days) await loadDay(d, "append");
    }else{
      for(const d of days) await loadDay(d, "prepend");
    }

    loadedRanges.add(rangeKey);
    anchorDate = base;
    $("statusBar").textContent = "Ready";
  }finally{
    loading = false;
  }
}

async function loadLastNDays(n){
  if(loading) return;
  loading = true;

  try{
    $("statusBar").textContent = `Loading last ${n} days…`;
    const today = new Date();
    today.setHours(0,0,0,0);

    for(let i=0;i<n;i++){
      const d = addDays(today, -i);
      await loadDay(d, "append");
    }

    $("statusBar").textContent = "Ready";
  }finally{
    loading = false;
  }
}

function startCountdownLoop(){
  if(countdownTimerId) clearInterval(countdownTimerId);

  const tick = () => {
    document.querySelectorAll(".sla-badge[data-sla-target]").forEach(el => {
      const iso = el.getAttribute("data-sla-target");
      const info = computeSlaCountdown(iso);
      el.textContent = info.text;
      el.className = info.cls;
    });
  };
  tick();
  countdownTimerId = setInterval(tick, 1000);
}

/* Modal helpers */
function openModal(){
  const m = $("rangeModal");
  m.style.display = "flex";
  m.setAttribute("aria-hidden","false");
}
function closeModal(){
  const m = $("rangeModal");
  m.style.display = "none";
  m.setAttribute("aria-hidden","true");
}

/* FIXED: Long-press that DOES NOT kill normal taps */
function addLongPress(el, onLongPress){
  let timer = null;

  const start = () => {
    timer = setTimeout(() => {
      timer = null;
      onLongPress();
    }, 3000);
  };
  const cancel = () => {
    if(timer){
      clearTimeout(timer);
      timer = null;
    }
  };

  el.addEventListener("pointerdown", start);
  el.addEventListener("pointerup", cancel);
  el.addEventListener("pointercancel", cancel);
  el.addEventListener("pointerleave", cancel);
}

function init(){
  const engineer = getEngineer();
  $("userLabel").textContent = engineer ? `Logged in as ${engineer}` : "Engineer";

  const prevBtn = $("prevWeekBtn");
  const nextBtn = $("nextWeekBtn");

  // Tap = week navigation (guaranteed to fire)
  prevBtn.addEventListener("click", () => loadWeek(-1));
  nextBtn.addEventListener("click", () => loadWeek(+1));

  // Hold (3s) = modal
  addLongPress(prevBtn, openModal);
  addLongPress(nextBtn, openModal);

  // Modal actions
  $("load30Btn").addEventListener("click", async () => { closeModal(); await loadLastNDays(30); });
  $("load60Btn").addEventListener("click", async () => { closeModal(); await loadLastNDays(60); });
  $("load90Btn").addEventListener("click", async () => { closeModal(); await loadLastNDays(90); });
  $("closeModalBtn").addEventListener("click", closeModal);

  $("rangeModal").addEventListener("click", (e) => {
    if(e.target && e.target.id === "rangeModal") closeModal();
  });

  // Initial load: current week (newest first so today is near the top)
  (async () => {
    $("statusBar").textContent = "Loading this week…";
    anchorDate = new Date();

    const from = startOfWeek(anchorDate);
    const to = endOfWeek(anchorDate);
    const rangeKey = `${isoDate(from)}:${isoDate(to)}`;

    const days = [];
    for(let i=0;i<7;i++) days.push(addDays(from, i));
    days.reverse();

    loading = true;
    try{
      for(const d of days) await loadDay(d, "append");
      loadedRanges.add(rangeKey);
      $("statusBar").textContent = "Ready";
    }finally{
      loading = false;
    }
  })();
}

window.addEventListener("DOMContentLoaded", init);
</script>
</body>
</html>
