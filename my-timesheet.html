<!DOCTYPE html>
<html lang="en">
<head>
<script src="auth.js"></script>
<meta charset="UTF-8" />
<title>My Timesheet – Mostlane</title>

<style>
  body {
    font-family: Arial, sans-serif;
    background: #e6e8eb url('Mostlane_Embossed.png') no-repeat center center fixed;
    background-size: 180%;
    padding: 20px;
  }
  .container {
    background: rgba(255,255,255,0.9);
    padding: 20px;
    border-radius: 12px;
    max-width: 950px;
    margin: auto;
  }
  h2 { color:#003366; text-align:center; }
  .week-nav {
    display:flex; justify-content:space-between; margin-bottom:15px;
  }
  .week-nav button {
    background:#003366; color:white; border:none;
    padding:8px 16px; border-radius:6px; cursor:pointer;
  }
  table { width:100%; border-collapse:collapse; font-size:14px; }
  table, th, td { border:1px solid #ccc; }
  th { background:#003366; color:white; }
  th, td { padding:8px; text-align:center; }
  .submitted { text-align:center; color:green; font-weight:bold; }
</style>
</head>

<body>
<div class="container">
  <h2>Weekly Timesheet</h2>
  <div class="submitted" id="submittedStamp" style="display:none;">✅ Submitted</div>

  <div class="week-nav">
    <button onclick="changeWeek(-1)">← Previous Week</button>
    <div id="weekLabel">Loading…</div>
    <button onclick="changeWeek(1)">Next Week →</button>
  </div>

  <table>
    <thead>
      <tr>
        <th>Date</th>
        <th>Site(s)</th>
        <th>Standard Hours</th>
        <th>Overtime</th>
        <th>Fuel (£)</th>
        <th>Standard Pay (£)</th>
        <th>Overtime Pay (£)</th>
        <th>Total Pay (£)</th>
      </tr>
    </thead>
    <tbody id="timesheetBody"></tbody>
  </table>
</div>

<script>
const WORKER_BASE = "https://ckeck-in-out.jamie-def.workers.dev";
let weekOffset = 0;

function getMonday(d){
  d=new Date(d);
  const day=d.getDay();
  const diff=d.getDate()-(day===0?6:day-1);
  d.setDate(diff); d.setHours(0,0,0,0);
  return d;
}

function changeWeek(n){ weekOffset+=n; renderTimesheet(); }

async function getText(url){ return fetch(url).then(r=>r.text()); }

async function renderTimesheet(){
  const rawUser=sessionStorage.getItem("mostlaneUser")||"Unknown";
  const weekStart=getMonday(new Date());
  weekStart.setDate(weekStart.getDate()+weekOffset*7);
  const weekEnd=new Date(weekStart); weekEnd.setDate(weekEnd.getDate()+6);

  document.getElementById("weekLabel").innerText =
    `${weekStart.toISOString().slice(0,10)} → ${weekEnd.toISOString().slice(0,10)}`;

  const events = await fetch(
    `${WORKER_BASE}/events?user=${encodeURIComponent(rawUser)}`
  ).then(r=>r.json());

  const ratesTxt = await getText("https://raw.githubusercontent.com/Mostlane/Test/main/logs/rates.txt");
  const rateLine = ratesTxt.split("\n").find(l=>l.startsWith(rawUser));
  const rate = rateLine ? parseFloat(rateLine.split("£")[1]) : 0;

  const days={};
  events.forEach(e=>{
    const d=new Date(e.datetime);
    if(d<weekStart||d>weekEnd) return;
    const key=d.toISOString().slice(0,10);
    if(!days[key]) days[key]=[];
    days[key].push(e);
  });

  const body=document.getElementById("timesheetBody");
  body.innerHTML="";

  Object.keys(days).sort().forEach(day=>{
    const logs=days[day].sort((a,b)=>new Date(a.datetime)-new Date(b.datetime));
    const ins=logs.filter(l=>l.type==="checkin");
    const outs=logs.filter(l=>l.type==="checkout");
    if(!ins.length||!outs.length) return;

    const start=new Date(ins[0].datetime);
    const end=new Date(outs[outs.length-1].datetime);
    const hours=(end-start)/36e5;

    const std=Math.min(10,hours);
    const ot=Math.max(0,hours-10);

    const sites=[...new Set(logs.map(l=>l.matchedSite?.siteName).filter(Boolean))].join(", ");
    const miles=logs.find(l=>l.matchedSite?.mileageFromHQ)?.matchedSite.mileageFromHQ||0;
    const fuel=Math.max(0,miles-10)*0.25;

    const stdPay=std*rate;
    const otPay=ot*rate*1.5;

    const row=document.createElement("tr");
    row.innerHTML=`
      <td>${day}</td>
      <td>${sites||"—"}</td>
      <td>${std.toFixed(2)}</td>
      <td>${ot.toFixed(2)}</td>
      <td>£${fuel.toFixed(2)}</td>
      <td>£${stdPay.toFixed(2)}</td>
      <td>£${otPay.toFixed(2)}</td>
      <td>£${(stdPay+otPay+fuel).toFixed(2)}</td>
    `;
    body.appendChild(row);
  });
}

renderTimesheet();
</script>
</body>
</html>
