<!doctype html>
<html><head>
  <meta charset="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Job</title>
  <link rel="stylesheet" href="../style.css"/>
  <link rel="icon" href="favicon.ico">
  <link rel="apple-touch-icon" href="icon-180.png">
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#003366">
  <script>
    if('serviceWorker' in navigator){ navigator.serviceWorker.register('sw.js').catch(()=>{}); }
  </script>

  <style>
/* Portal-native FSM skin */
.fsm-body {
  background: #e6e8eb url('../Mostlane_Embossed.png') no-repeat fixed;
  background-size: 180% auto;
  margin: 0;
  min-height: 100vh;
  font-family: Arial, sans-serif;
}
.fsm-wrap {
  max-width: 820px;
  margin: 0 auto;
  padding: 16px;
  text-align: left;
}
.fsm-header {
  background-color: #003366; /* portal blue */
  color: #fff;
  border-radius: 8px;
  padding: 10px 14px;
  display:flex; align-items:center; gap:10px;
}
.fsm-header img { height: 38px; width: auto; }
.fsm-header .title { font-size: 18px; font-weight: 700; margin: 0; }
.fsm-box {
  background: rgba(255,255,255,0.60);
  border-radius: 12px;
  padding: 14px;
  margin: 16px 0;
  box-shadow: 0 8px 24px rgba(0,0,0,0.08);
}
.fsm-grid2 { display: grid; grid-template-columns: 1fr; gap: 12px; }
@media (min-width: 720px) { .fsm-grid2 { grid-template-columns: 1fr 1fr; } }
.fsm-kpi { background: rgba(255,255,255,0.70); border-radius: 12px; padding: 12px; }
.fsm-kpi .v { font-weight: 800; font-size: 24px; }
.fsm-kpi .l { color: #5f6876; font-size: 12px; margin-top: 4px; }
.fsm-input, .fsm-select, .fsm-textarea {
  width: 100%; padding: 12px 14px; border-radius: 10px;
  border: 1px solid #d6dbe1; background: #fff; font-size: 15px;
}
.fsm-btn { display:inline-block; padding:12px 16px; border-radius: 10px; border:1px solid #003366;
           background:#e6f0fa; color:#003366; font-weight:700; text-decoration:none; }
.fsm-btn.primary { background:#003366; color:#fff; }
.fsm-row { display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
.fsm-card { background: rgba(255,255,255,0.70); border-radius: 12px; padding: 12px; margin: 10px 0; }
.fsm-meta { color:#5f6876; font-size:12px; }
.fsm-chip { font-size:12px; padding:6px 10px; border-radius:999px; color:#fff; font-weight:800; display:inline-block; }
.fsm-New { background:#9aa7b6 } .fsm-Assigned { background:#003366 } .fsm-InProgress { background:#f1a331 }
.fsm-Completed { background:#23966e } .fsm-OnHold { background:#7d8694 } .fsm-Cancelled { background:#a1a7b2 }
.fsm-footer { text-align:center; padding-bottom: 40px; color:#5f6876; font-size:12px }

.fsm-header .nav { margin-left:auto; display:flex; gap:8px; }
.fsm-link { display:inline-block; padding:8px 12px; border-radius:8px; text-decoration:none;
            background:#e6f0fa; color:#003366; border:1px solid #003366; font-weight:700; font-size:13px; }
.fsm-link.primary { background:#003366; color:#fff; }
.menu-buttons { display:grid; gap:12px; grid-template-columns:1fr; }
@media(min-width:700px){ .menu-buttons{ grid-template-columns:1fr 1fr; } }
.big-btn { display:block; text-align:center; padding:18px; font-size:16px; font-weight:800;
           background:#e6f0fa; color:#003366; border:1px solid #003366; border-radius:12px; text-decoration:none; }

</style>
  <script defer src="assets/app.js"></script>
  <script>
  let job=null;
  function load(){
    const id=new URL(location.href).searchParams.get('id');
    const arr=MFSM.loadJobs(); job=arr.find(x=>x.id===id);
    if(!job){ document.getElementById('wrap').innerHTML='<div class="fsm-box">Job not found.</div>'; return; }
    document.getElementById('jid').textContent=job.id;
    document.getElementById('title').value=job.title||'';
    document.getElementById('site').value=job.site||'';
    document.getElementById('desc').value=job.description||'';
    document.getElementById('status').value=job.status||'New';
    document.getElementById('sla').value=job.slaHours||'';
    document.getElementById('due').value=job.dueDate? new Date(job.dueDate).toISOString().slice(0,16):'';
    const engs=MFSM.loadEngineers();
    const sel=document.getElementById('assignee'); sel.innerHTML='<option value="">—</option>'+engs.map(e=>`<option value="${e.id}">${e.name}</option>`).join('');
    if(job.assignee) sel.value=job.assignee;
    document.getElementById('meta').textContent = 'Created '+new Date(job.createdAt).toLocaleString()+' · Updated '+new Date(job.updatedAt||job.createdAt).toLocaleString();
    document.getElementById('stchip').textContent=job.status; document.getElementById('stchip').className='fsm-chip fsm-'+job.status.replace(' ','');
    renderNotes();
  }
  function save(){
    job.title=document.getElementById('title').value.trim();
    job.site=document.getElementById('site').value.trim();
    job.description=document.getElementById('desc').value.trim();
    job.status=document.getElementById('status').value;
    job.slaHours=Number(document.getElementById('sla').value)||'';
    job.dueDate=document.getElementById('due').value? new Date(document.getElementById('due').value).toISOString():'';
    job.assignee=document.getElementById('assignee').value||'';
    job.updatedAt=new Date().toISOString();
    const arr=MFSM.loadJobs(); arr[arr.findIndex(x=>x.id===job.id)]=job; MFSM.saveJobs(arr);
    const s=MFSM.loadSettings(); MFSM.postZap(s.webhookJobUpdate, {event:'job_update', job});
    load();
  }
  function addNote(){
    const t=document.getElementById('note').value.trim(); if(!t) return;
    job.notes=job.notes||[]; job.notes.push({ts:new Date().toISOString(), text:t});
    job.updatedAt=new Date().toISOString();
    const arr=MFSM.loadJobs(); arr[arr.findIndex(x=>x.id===job.id)]=job; MFSM.saveJobs(arr);
    document.getElementById('note').value=''; renderNotes();
  }
  function renderNotes(){
    const box=document.getElementById('notes'); box.innerHTML='';
    (job.notes||[]).slice().reverse().forEach(n=>{ const d=document.createElement('div'); d.className='fsm-card'; d.innerHTML=`<div class="fsm-meta">${new Date(n.ts).toLocaleString()}</div><div>${n.text}</div>`; box.appendChild(d); });
  }
  document.addEventListener('DOMContentLoaded',load);
  </script>
</head>
<body class="fsm-body">
  <div class="fsm-wrap" id="wrap">
    

  <div class="fsm-header">
    <a class="logo-link" href="menu.html" aria-label="FSM Menu">
      <img src="../mostlane-logo.jpg" alt="Mostlane logo" style="height:38px;width:auto"/>
    </a>
    <h2 class="title">Job</h2>
    <div class="nav" style="margin-left:auto;display:flex;gap:8px">
      <a class="fsm-link" href="../index.html">Home</a>
      <a class="fsm-link" href="menu.html">Menu</a>
      <a class="fsm-link primary" href="#" onclick="if(history.length>1){history.back();}else{location.href='index.html';}return false;">Back</a>
    </div>
  </div>


    <div class="fsm-box">
      <div class="fsm-row" style="justify-content:space-between">
        <strong id="jid"></strong>
        <span id="stchip" class="fsm-chip">Status</span>
      </div>
      <div class="fsm-grid2">
        <div><div class="fsm-meta">Title</div><input id="title" class="fsm-input"/></div>
        <div><div class="fsm-meta">Site</div><input id="site" class="fsm-input"/></div>
        <div><div class="fsm-meta">Status</div>
          <select id="status" class="fsm-select"><option>New</option><option>Assigned</option><option>In Progress</option><option>On Hold</option><option>Completed</option><option>Cancelled</option></select>
        </div>
        <div><div class="fsm-meta">Assignee</div><select id="assignee" class="fsm-select"></select></div>
        <div><div class="fsm-meta">SLA (h)</div><input id="sla" type="number" class="fsm-input"/></div>
        <div><div class="fsm-meta">Due</div><input id="due" type="datetime-local" class="fsm-input"/></div>
      </div>
      <div class="fsm-meta" id="meta" style="margin-top:6px"></div>
      <div class="fsm-row" style="margin-top:10px">
        <a class="fsm-btn primary" onclick="save()">Save</a>
      </div>
    </div>
    <div class="fsm-box">
      <div class="fsm-meta">Description</div>
      <textarea id="desc" class="fsm-textarea" rows="5"></textarea>
    </div>
    <div class="fsm-box">
      <h3 style="margin:0 0 8px">Notes</h3>
      <div class="fsm-row"><input id="note" class="fsm-input" placeholder="Add note"/><a class="fsm-btn" onclick="addNote()">Add</a></div>
      <div id="notes" style="margin-top:8px"></div>
    </div>
    <div class="fsm-footer">Mostlane Portal – FSM</div>
  </div>
</body></html>
