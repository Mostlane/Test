<script src="auth.js"></script>
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Time Analysis – Mostlane</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<style>
/* existing styles preserved */
.financeCol{white-space:nowrap}
.table-wrap{overflow-x:auto}
.notice{margin-top:10px;font-size:13px;color:#92400e}
</style>
</head>

<body>
<div class="shell">
<header>
<h1>Time Analysis</h1>
<a href="main.html">Main Menu</a>
</header>

<div class="content">

<div class="card">
  <div class="controls">
    <input type="date" id="startDate">
    <input type="date" id="endDate">
    <button onclick="calculate()">Calculate</button>
  </div>
</div>

<div class="card table-wrap">
<table>
<thead>
<tr>
<th>Engineer</th>
<th>Days</th>
<th>Avg (h)</th>
<th>Min</th>
<th>Max</th>

<th class="financeCol">OT from Travel (h)</th>
<th class="financeCol">OT Cost (£)</th>
<th class="financeCol">Potential Saving (£)</th>
<th class="financeCol">Total Driving Cost (£)</th>
</tr>
</thead>
<tbody id="results"></tbody>
</table>

<div class="notice" id="financeNotice" style="display:none">
Financial data is restricted to Directors.
</div>
</div>
</div>
</div>

<script>
const WORKER_URL = "https://average-hours.jamie-def.workers.dev";
const $ = id => document.getElementById(id);

function getUser(){
  return (
    sessionStorage.getItem("mostlaneUser") ||
    localStorage.getItem("mostlaneUser") ||
    ""
  );
}

async function calculate(){
  const start = $("startDate").value;
  const end = $("endDate").value;
  const tbody = $("results");

  tbody.innerHTML = "<tr><td colspan='9'>Loading…</td></tr>";

  const res = await fetch(`${WORKER_URL}?start=${start}&end=${end}`,{
    headers:{ "X-User": getUser() }
  });

  const data = await res.json();
  tbody.innerHTML = "";

  if (!data.engineers?.length){
    tbody.innerHTML = "<tr><td colspan='9'>No data</td></tr>";
    return;
  }

  if (!data.costsEnabled){
    document.querySelectorAll(".financeCol").forEach(c=>c.style.display="none");
    $("financeNotice").style.display="block";
  }

  data.engineers.forEach(e=>{
    const tr=document.createElement("tr");
    tr.innerHTML=`
      <td>${e.engineer}</td>
      <td>${e.days}</td>
      <td>${e.average.toFixed(2)}</td>
      <td>${e.min.toFixed(2)}</td>
      <td>${e.max.toFixed(2)}</td>

      ${data.costsEnabled ? `
      <td>${e.travelCausedOT.toFixed(2)}</td>
      <td>£${e.travelOTCost.toFixed(2)}</td>
      <td>£${e.potentialSaving.toFixed(2)}</td>
      <td>£${e.totalDrivingCost.toFixed(2)}</td>
      ` : ``}
    `;
    tbody.appendChild(tr);
  });
}
</script>
</body>
</html>
