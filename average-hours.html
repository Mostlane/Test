<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Time Analysis – Mostlane</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<script src="auth.js"></script>

<style>
*,*::before,*::after{box-sizing:border-box}
:root{
  --ml-blue:#003366;
  --ml-accent:#1a73e8;
  --ml-bg:#e6e8eb;
  --ink:#27313a;
  --card:#ffffffee;
  --border:#e8edf3;
  --muted:#6b7280;
}
body{
  font-family:"Segoe UI",system-ui,Roboto,Arial,sans-serif;
  background:var(--ml-bg) url('Mostlane_Embossed.png') no-repeat center center fixed;
  background-size:180% auto;
  margin:0;
  padding:20px;
  color:var(--ink);
}
.shell{
  max-width:1300px;
  margin:0 auto;
  background:rgba(255,255,255,0.94);
  border-radius:14px;
  box-shadow:0 12px 28px rgba(0,0,0,0.12);
  overflow:hidden;
}
header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  padding:18px 22px;
  border-bottom:1px solid var(--border);
  background:linear-gradient(90deg,#fff,#f7f9fc);
}
header h1{margin:0;font-size:22px;color:var(--ml-blue)}
header a{
  background:var(--ml-accent);
  color:#fff;
  text-decoration:none;
  padding:10px 16px;
  border-radius:10px;
  font-weight:600;
}
.content{padding:20px}
.card{
  background:var(--card);
  border:1px solid var(--border);
  border-radius:14px;
  padding:16px;
  margin-bottom:16px;
}
.controls{
  display:flex;
  gap:12px;
  flex-wrap:wrap;
  align-items:end;
}
label{font-size:13px;color:#334155;display:block;margin-bottom:6px}
input{
  font-size:15px;
  border:1px solid #cbd5e1;
  border-radius:10px;
  padding:10px 12px;
  height:40px;
}
button{
  font-size:15px;
  font-weight:600;
  border:0;
  border-radius:10px;
  padding:12px 18px;
  cursor:pointer;
  background:var(--ml-accent);
  color:#fff;
}
.toggle{
  display:flex;
  gap:6px;
}
.toggle button{
  background:#eef2f9;
  color:#0f172a;
}
.toggle button.active{
  background:var(--ml-accent);
  color:#fff;
}
.table-wrap{overflow-x:auto}
table{
  width:100%;
  border-collapse:collapse;
  min-width:1100px;
}
th,td{
  padding:10px 8px;
  border-bottom:1px solid var(--border);
  text-align:center;
  font-size:14px;
  white-space:nowrap;
}
th{color:var(--ml-blue);font-weight:600}
td:first-child,th:first-child{text-align:left}
tfoot td{
  font-weight:700;
  background:#f8fafc;
}
.muted{color:var(--muted);font-size:13px}
.notice{margin-top:10px;font-size:13px;color:#92400e}
</style>
</head>

<body>
<div class="shell">
<header>
  <h1>Time Analysis</h1>
  <a href="main.html">Main Menu</a>
</header>

<div class="content">

<div class="card">
  <div class="controls">
    <div>
      <label>Start date</label>
      <input type="date" id="startDate">
    </div>
    <div>
      <label>End date</label>
      <input type="date" id="endDate">
    </div>
    <div class="toggle">
      <button id="onsiteBtn" class="active">On-site</button>
      <button id="travelBtn">Travel</button>
    </div>
    <div>
      <button id="calcBtn">Calculate</button>
    </div>
  </div>
  <div class="muted" id="modeHint" style="margin-top:8px">
    Overtime starts 10h after leaving home (current policy)
  </div>
</div>

<div class="card table-wrap">
<table>
<thead>
<tr>
  <th>Engineer</th>
  <th>Days</th>
  <th>Avg (h)</th>
  <th>Min</th>
  <th>Max</th>
  <th class="finance">OT from Travel (h)</th>
  <th class="finance">OT Cost (£)</th>
  <th class="finance">Potential Saving (£)</th>
  <th class="finance">Total Driving Cost (£)</th>
</tr>
</thead>

<tbody id="results">
<tr><td colspan="9" class="muted">Select a date range</td></tr>
</tbody>

<tfoot id="totals" style="display:none">
<tr>
  <td>Totals</td>
  <td id="tDays"></td>
  <td></td>
  <td></td>
  <td></td>
  <td id="tOT"></td>
  <td id="tOTCost"></td>
  <td id="tSaving"></td>
  <td id="tDriveCost"></td>
</tr>
</tfoot>
</table>

<div class="notice" id="financeNotice" style="display:none">
  Financial data is restricted to Directors.
</div>
</div>

</div>
</div>

<script>
const WORKER_URL="https://average-hours.jamie-def.workers.dev";
const $=id=>document.getElementById(id);
let metric="onsite";

function getUser(){
  return sessionStorage.getItem("mostlaneUser") || localStorage.getItem("mostlaneUser") || "";
}
function todayMinus(d){
  const x=new Date();x.setDate(x.getDate()-d);return x.toISOString().split("T")[0];
}

window.addEventListener("DOMContentLoaded",()=>{
  $("startDate").value=todayMinus(42);
  $("endDate").value=todayMinus(1);
  $("calcBtn").onclick=calculate;

  $("onsiteBtn").onclick=()=>setMetric("onsite");
  $("travelBtn").onclick=()=>setMetric("travel");
});

function setMetric(m){
  metric=m;
  $("onsiteBtn").classList.toggle("active",m==="onsite");
  $("travelBtn").classList.toggle("active",m==="travel");
  $("modeHint").textContent =
    m==="onsite"
      ? "On-site time (arrive first site → leave last site)"
      : "Travel time (to + from work)";
}

async function calculate(){
  const tbody=$("results");
  const tfoot=$("totals");
  tbody.innerHTML=`<tr><td colspan="9">Loading…</td></tr>`;
  tfoot.style.display="none";

  const res=await fetch(
    `${WORKER_URL}?start=${$("startDate").value}&end=${$("endDate").value}&metric=${metric}`,
    {headers:{"X-User":getUser()}}
  );
  const data=await res.json();
  tbody.innerHTML="";

  if(!data.engineers?.length){
    tbody.innerHTML=`<tr><td colspan="9">No data</td></tr>`;
    return;
  }

  if(!data.costsEnabled){
    document.querySelectorAll(".finance").forEach(e=>e.style.display="none");
    $("financeNotice").style.display="block";
  }

  let sumDays=0,sumOT=0,sumOTCost=0,sumSaving=0,sumDrive=0;

  data.engineers.forEach(e=>{
    sumDays+=e.days||0;
    sumOT+=e.travelCausedOT||0;
    sumOTCost+=e.travelOTCost||0;
    sumSaving+=e.potentialSaving||0;
    sumDrive+=e.totalDrivingCost||0;

    const tr=document.createElement("tr");
    tr.innerHTML=`
      <td>${e.engineer}</td>
      <td>${e.days}</td>
      <td>${e.average.toFixed(2)}</td>
      <td>${e.min.toFixed(2)}</td>
      <td>${e.max.toFixed(2)}</td>
      ${data.costsEnabled?`
        <td>${e.travelCausedOT.toFixed(2)}</td>
        <td>£${e.travelOTCost.toFixed(2)}</td>
        <td>£${e.potentialSaving.toFixed(2)}</td>
        <td>£${e.totalDrivingCost.toFixed(2)}</td>`:""}
    `;
    tbody.appendChild(tr);
  });

  if(data.costsEnabled){
    $("tDays").textContent=sumDays;
    $("tOT").textContent=sumOT.toFixed(2);
    $("tOTCost").textContent="£"+sumOTCost.toFixed(2);
    $("tSaving").textContent="£"+sumSaving.toFixed(2);
    $("tDriveCost").textContent="£"+sumDrive.toFixed(2);
    tfoot.style.display="";
  }
}
</script>
</body>
</html>
