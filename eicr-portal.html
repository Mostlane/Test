<!DOCTYPE html>
<html lang="en">
<head>
  <script src="auth.js"></script>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Retail Compliance Portal</title>
  <style>
    /* âœ… Embossed background stays fixed at all times */
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      color: #1f2937;
      background-color: #e6e8eb;
      position: relative;
      min-height: 100vh;
      overflow-x: hidden;
    }

    body::before {
      content: "";
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background-image: url('Mostlane_Embossed.png');
      background-repeat: no-repeat;
      background-position: center;
      background-size: 180%;
      opacity: 1;
      z-index: -1;
    }

    .container {
      background-color: rgba(255, 255, 255, 0.6);
      margin: 20px auto;
      padding: 20px;
      border-radius: 15px;
      max-width: 95%;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    }
    h1 { text-align: center; color: #0071CE; margin-top: 0; }
    .logo { display: block; margin: 10px auto 20px auto; max-height: 60px; }
    .summary-bubbles, .filter-bubbles {
      display: flex; flex-wrap: wrap; justify-content: center; margin-bottom: 20px;
    }
    .bubble {
      background-color: #0071CE; color: white; border: none;
      padding: 10px 20px; margin: 5px; border-radius: 30px;
      cursor: pointer; font-weight: bold; transition: 0.2s;
    }
    .bubble:hover { opacity: 0.85; }
    .bubble.active { background-color: #28a745; }

    .search-container { text-align: center; margin-bottom: 10px; }
    .search-input {
      padding: 8px; width: 300px; border-radius: 20px; border: 1px solid #ccc;
    }

    .table-wrapper {
      overflow-x: auto;
      overflow-y: auto;
      max-height: 70vh;
      width: 100%;
    }

    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    th, td { border: 1px solid #999; padding: 8px; text-align: center; font-size: 14px; }
    th { background-color: #0071CE; color: white; }

    thead th {
      position: sticky;
      top: 0;
      background-color: #0071CE;
      color: white;
      z-index: 5;
    }

    tr:nth-child(even) { background-color: rgba(255,255,255,0.7); }
    tr:nth-child(odd) { background-color: rgba(255,255,255,0.5); }

    /* ---------- Popup Modals ---------- */
    .modal {
      display: none; position: fixed; z-index: 999;
      left: 0; top: 0; width: 100%; height: 100%;
      background-color: rgba(0,0,0,0.5);
    }
    .modal-content {
      background-color: white; border-radius: 10px;
      max-width: 400px; margin: 10% auto; padding: 20px;
      text-align: left; box-shadow: 0 4px 10px rgba(0,0,0,0.3);
    }
    .modal h2 { margin-top: 0; color: #0071CE; text-align: center; }
    .modal label { display: block; margin: 6px 0; }
    .modal input[type="date"] {
      width: 100%; padding: 6px; border: 1px solid #ccc; border-radius: 5px;
    }
    .modal button {
      background-color: #0071CE; color: white; border: none;
      padding: 8px 16px; border-radius: 6px; cursor: pointer;
      margin-top: 10px; font-weight: bold;
    }
    .modal .close-btn { background-color: #ccc; color: #000; margin-left: 10px; }
    @media (max-width:768px){
      .search-input{width:90%;font-size:16px}
      th,td{font-size:12px;padding:6px}
    }
  </style>
</head>

<body>
  <div class="container">
    <img src="mostlane-logo.jpg" alt="Mostlane Logo" class="logo">
    <h1>Mostlane Retail Compliance Portal</h1>

    <div class="summary-bubbles">
      <button class="bubble" onclick="setDueActive(this);filterByDays(30)">Due in 30 Days</button>
      <button class="bubble" onclick="setDueActive(this);filterByDays(90)">Due in 90 Days</button>
      <button class="bubble" onclick="setDueActive(this);filterByDays(365)">Due in 365 Days</button>
      <button class="bubble" onclick="openModal()">Search by Date/Type</button>
      <button class="bubble" onclick="clearFilters()">Clear</button>
      <!-- âœ… Export button -->
      <button class="bubble" onclick="openExportModal()">Export to CSV</button>
    </div>

    <div class="filter-bubbles">
      <button class="bubble" onclick="setCategory('fiveYear', this)">5 Year</button>
      <button class="bubble" onclick="setCategory('pat', this)">PAT</button>
      <button class="bubble" onclick="setCategory('em', this)">EM</button>
      <button class="bubble" onclick="setCategory('pv', this)">PV</button>
      <button class="bubble" onclick="setCategory('ev', this)">EV</button>
      <button class="bubble" onclick="setCategory('pump', this)">Pump</button>
    </div>

    <div class="search-container">
      <input class="search-input" type="text" id="searchBar"
             placeholder="Search store name, number or postcode..."
             onkeyup="searchTable()">
    </div>

    <div class="table-wrapper">
      <table>
        <thead>
          <tr>
            <th>Store Code</th>
            <th>Site Name</th>
            <th>Postcode</th>
            <th>Status</th>
            <th>5 Year</th>
            <th>PAT</th>
            <th>EM</th>
            <th>PV</th>
            <th>EV</th>
            <th>Pump</th>
          </tr>
        </thead>
        <tbody id="tableBody"></tbody>
      </table>
    </div>
  </div>

  <!-- Existing Search Modal (untouched) -->
  <div id="searchModal" class="modal">
    <div class="modal-content">
      <h2>Search by Date / Type</h2>
      <label><input type="checkbox" class="typeCheck" value="fiveYear"> 5 Year</label>
      <label><input type="checkbox" class="typeCheck" value="pat"> PAT</label>
      <label><input type="checkbox" class="typeCheck" value="em"> EM</label>
      <label><input type="checkbox" class="typeCheck" value="pv"> PV</label>
      <label><input type="checkbox" class="typeCheck" value="ev"> EV</label>
      <label><input type="checkbox" class="typeCheck" value="pump"> Pump</label>
      <br>
      <label>From: <input type="date" id="fromDate"></label>
      <label>To: <input type="date" id="toDate"></label>
      <br>
      <button onclick="runDateSearch()">Search</button>
      <button class="close-btn" onclick="closeModal()">Close</button>
    </div>
  </div>

  <!-- âœ… New Export Modal -->
  <div id="exportModal" class="modal">
    <div class="modal-content">
      <h2>Export Options</h2>
      <p>Select which columns to include and an optional date range:</p>

      <label><input type="checkbox" class="exportCheck" value="fiveYear" checked> 5 Year</label>
      <label><input type="checkbox" class="exportCheck" value="pat" checked> PAT</label>
      <label><input type="checkbox" class="exportCheck" value="em" checked> EM</label>
      <label><input type="checkbox" class="exportCheck" value="pv" checked> PV</label>
      <label><input type="checkbox" class="exportCheck" value="ev" checked> EV</label>
      <label><input type="checkbox" class="exportCheck" value="pump" checked> Pump</label>
      <br>
      <label>From: <input type="date" id="exportFrom"></label>
      <label>To: <input type="date" id="exportTo"></label>
      <br>
      <button onclick="runExport()">Export</button>
      <button class="close-btn" onclick="closeExportModal()">Cancel</button>
    </div>
  </div>

  <script>
    let allData = [];
    let activeCategory = 'fiveYear';
    const filterBubbles = document.querySelectorAll(".filter-bubbles .bubble");
    const dueButtons = document.querySelectorAll(".summary-bubbles .bubble");
    let currentData = [];

    async function fetchData() {
      const res = await fetch('https://raw.githubusercontent.com/Mostlane/Test/main/Compliance/retail_compliance.json');
      const raw = await res.json();
      allData = Object.values(raw).map(r => ({
        storeCode: r.branchCode,
        siteName: r.storeName,
        postcode: r.postcode,
        fiveYear: r["5_Year"] || "",
        pat: r["PAT"] || "",
        em: r["EM"] || "",
        pv: r["PV"] || "",
        ev: r["EV"] || "",
        pump: r["PUMP"] || ""
      }));
      renderTable(allData);
    }

    function parseDate(d) {
      if (!d) return null;
      const parts = d.split('/');
      if (parts.length === 3) {
        const [day, month, year] = parts.map(Number);
        return new Date(year, month - 1, day);
      }
      return new Date(d);
    }

    function getStatus(entry) {
      const now = new Date();
      const dates = [entry.fiveYear, entry.pat, entry.em, entry.pv, entry.ev, entry.pump]
        .map(parseDate)
        .filter(Boolean);
      let isRed = false, isAmber = false;
      dates.forEach(dt => {
        if (dt < now) isRed = true;
        else if ((dt - now) / (1000 * 60 * 60 * 24) <= 30) isAmber = true;
      });
      return isRed ? 'ðŸ”´' : isAmber ? 'ðŸŸ¡' : 'ðŸŸ¢';
    }

    function renderTable(data) {
      currentData = data.slice();
      const tbody = document.getElementById('tableBody');
      tbody.innerHTML = '';
      data.forEach(entry => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${entry.storeCode}</td>
          <td>${entry.siteName}</td>
          <td>${entry.postcode}</td>
          <td>${getStatus(entry)}</td>
          <td>${entry.fiveYear}</td>
          <td>${entry.pat}</td>
          <td>${entry.em}</td>
          <td>${entry.pv}</td>
          <td>${entry.ev}</td>
          <td>${entry.pump}</td>
        `;
        tbody.appendChild(tr);
      });
    }

    function filterByDays(days) {
      const now = new Date();
      const future = new Date(now);
      future.setDate(now.getDate() + days);
      const filtered = allData.filter(entry => {
        const date = parseDate(entry[activeCategory]);
        return date && date <= future;
      });
      renderTable(filtered);
    }

    function clearFilters() {
      renderTable(allData);
      filterBubbles.forEach(b => b.classList.remove('active'));
      dueButtons.forEach(b => b.classList.remove('active'));
    }

    function setCategory(field, btn) {
      activeCategory = field;
      filterBubbles.forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
    }

    function setDueActive(btn) {
      dueButtons.forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
    }

    function searchTable() {
      const q = document.getElementById('searchBar').value.toLowerCase();
      const filtered = allData.filter(e =>
        e.siteName.toLowerCase().includes(q) ||
        e.postcode.toLowerCase().includes(q) ||
        e.storeCode.toString().includes(q)
      );
      renderTable(filtered);
    }

    function openModal() { document.getElementById('searchModal').style.display = 'block'; }
    function closeModal() { document.getElementById('searchModal').style.display = 'none'; }

    function openExportModal() { document.getElementById('exportModal').style.display = 'block'; }
    function closeExportModal() { document.getElementById('exportModal').style.display = 'none'; }

    function runDateSearch() {
      const from = parseDate(document.getElementById('fromDate').value.split('-').reverse().join('/'));
      const to = parseDate(document.getElementById('toDate').value.split('-').reverse().join('/'));
      const selectedTypes = Array.from(document.querySelectorAll('.typeCheck:checked')).map(c => c.value);

      if (selectedTypes.length === 0) {
        alert('Please select at least one compliance type.');
        return;
      }

      const filtered = allData.filter(entry => {
        return selectedTypes.some(type => {
          const d = parseDate(entry[type]);
          return d && (!from || d >= from) && (!to || d <= to);
        });
      });

      closeModal();
      renderTable(filtered);
    }

    /* âœ… Export logic with selectable columns + date filter */
    function runExport() {
      const selectedCols = Array.from(document.querySelectorAll('.exportCheck:checked')).map(c => c.value);
      const from = parseDate(document.getElementById('exportFrom').value.split('-').reverse().join('/'));
      const to = parseDate(document.getElementById('exportTo').value.split('-').reverse().join('/'));

      let dataToExport = currentData;

      if (from || to) {
        dataToExport = dataToExport.filter(entry =>
          selectedCols.some(col => {
            const d = parseDate(entry[col]);
            return d && (!from || d >= from) && (!to || d <= to);
          })
        );
      }

      const headers = ["Store Code","Site Name","Postcode","Status",...selectedCols.map(c=>c.toUpperCase())];
      const rows = dataToExport.map(e => {
        const row = [e.storeCode, e.siteName, e.postcode, getStatus(e)];
        selectedCols.forEach(c => row.push(e[c] || ""));
        return row;
      });

      const esc = (v) => {
        const s = String(v ?? "");
        return /[",\n]/.test(s) ? `"${s.replace(/"/g,'""')}"` : s;
      };

      const csv = [headers.map(esc).join(','), ...rows.map(r => r.map(esc).join(','))].join('\n');
      const blob = new Blob(["\uFEFF" + csv], { type: "text/csv;charset=utf-8;" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      const ts = new Date().toISOString().slice(0,19).replace(/[:T]/g,'-');
      a.download = `Mostlane_Compliance_Export_${ts}.csv`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
      closeExportModal();
    }

    fetchData();
  </script>
</body>
</html>
