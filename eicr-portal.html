<!DOCTYPE html>
<html lang="en">
<head>
  <script src="auth.js"></script>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>The Southern Co-op Compliance Portal</title>
  <style>
    body{
      margin:0;font-family:Arial,sans-serif;color:#1f2937;
      background-color:#e6e8eb;position:relative;min-height:100vh;overflow-x:hidden;
    }
    body::before{
      content:"";position:fixed;top:0;left:0;right:0;bottom:0;
      background:url('Mostlane_Embossed.png') no-repeat center/180%;z-index:-1;
    }
    .container{
      background-color:rgba(255,255,255,0.6);margin:20px auto;padding:20px;
      border-radius:15px;max-width:95%;box-shadow:0 4px 10px rgba(0,0,0,0.1);
    }
    h1{text-align:center;color:#0071CE;margin-top:0}
    .logo{display:block;margin:10px auto 20px auto;max-height:60px}
    .summary-bubbles,.filter-bubbles{
      display:flex;flex-wrap:wrap;justify-content:center;margin-bottom:20px;
    }
    .bubble{
      background-color:#0071CE;color:white;border:none;
      padding:10px 20px;margin:5px;border-radius:30px;
      cursor:pointer;font-weight:bold;transition:0.2s;
    }
    .bubble:hover{opacity:0.85}
    .bubble.active{background-color:#28a745}
    .search-container{text-align:center;margin-bottom:10px}
    .search-input{padding:8px;width:300px;border-radius:20px;border:1px solid #ccc}
    .table-wrapper{overflow-x:auto;overflow-y:auto;max-height:70vh;width:100%}
    table{width:100%;border-collapse:collapse;margin-top:20px}
    th,td{border:1px solid #999;padding:8px;text-align:center;font-size:14px}
    th{background:#0071CE;color:#fff;position:sticky;top:0;z-index:5}
    tr:nth-child(even){background:rgba(255,255,255,0.7)}
    tr:nth-child(odd){background:rgba(255,255,255,0.5)}
    .sp-btn{
      display:inline-block;padding:6px 10px;border-radius:6px;background:#0071CE;color:#fff;
      text-decoration:none;font-weight:bold;border:0;cursor:pointer
    }
    .sp-btn:hover{opacity:.9}

    .backbar{display:flex;justify-content:flex-start;align-items:center;margin-bottom:10px;}
    .backlink{
      display:inline-flex;align-items:center;gap:8px;
      background:#0071CE;color:#fff;text-decoration:none;
      padding:8px 14px;border-radius:30px;font-weight:bold;
    }
    .backlink:hover{opacity:.9}

    /* üîß NEW: edit/save button styles */
    #editBtn,#saveBtn{
      background:#0071CE;color:#fff;border:none;padding:8px 16px;
      border-radius:20px;cursor:pointer;font-weight:bold;margin-left:10px;
    }
    #editBtn:hover,#saveBtn:hover{opacity:.9;}
    [contenteditable="true"]{background:#fff6d1;}

    .modal{
      display:none;position:fixed;z-index:999;left:0;top:0;width:100%;height:100%;
      background:rgba(0,0,0,0.5);
    }
    .modal-content{
      background:#fff;border-radius:10px;max-width:420px;margin:6% auto;padding:20px;
      box-shadow:0 4px 10px rgba(0,0,0,0.3);
    }
    .modal h2{margin-top:0;color:#0071CE;text-align:center}
    .modal label{display:block;margin:6px 0}
    .modal input[type="date"], .modal select{
      width:100%;padding:6px;border:1px solid #ccc;border-radius:5px
    }
    .modal button{
      background:#0071CE;color:#fff;border:none;padding:8px 16px;border-radius:6px;
      cursor:pointer;margin-top:10px;font-weight:bold;
    }
    .modal .close-btn{background:#ccc;color:#000;margin-left:10px}
    .range-btn{
      background:#e6e8eb;color:#000;margin:3px;padding:6px 10px;border:none;
      border-radius:6px;cursor:pointer;transition:0.2s;
    }
    .range-btn.active{background:#0071CE;color:#fff}
    .summary-box{
      border:1px solid #ddd;border-radius:10px;margin:10px 0;padding:10px;background:#fff;
    }
    .summary-title{
      font-weight:bold;border-bottom:1px solid #ddd;padding-bottom:6px;margin-bottom:10px;
      color:#0071CE;text-transform:capitalize;
    }

    /* Filter summary bar */
    .filter-summary{
      background:rgba(255,255,255,0.8);
      border:1px solid #e5e7eb;border-radius:10px;
      padding:8px 12px;margin:10px auto;max-width:95%;
      text-align:center;color:#1f2937;font-size:14px;
      opacity:0;transition:opacity .5s ease;pointer-events:none;
    }
    .filter-summary.visible{opacity:1;pointer-events:auto;}

    @media(max-width:768px){
      .search-input{width:90%;font-size:16px}
      th,td{font-size:12px;padding:6px}
      .modal-content{max-width:90%}
    }
  </style>
</head>
<body>
  <div class="container">

    <div class="backbar">
      <a class="backlink" href="https://mostlane.github.io/Test/compliance.html">
        <span aria-hidden="true">‚Üê</span> Back
      </a>

      <!-- üîß NEW: Edit/Save buttons -->
      <div>
        <button id="editBtn">Edit</button>
        <button id="saveBtn" style="display:none;">Save Changes</button>
      </div>
    </div>

    <img src="mostlane-logo.jpg" alt="Mostlane Logo" class="logo">
    <h1>The Southern Co-op Compliance Portal</h1>

    <!-- ‚úÖ everything below stays unchanged -->
    <!-- your entire table, modals, and existing JS remain intact -->

  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script>
  /* all your existing JavaScript above remains untouched */

  /* üîß NEW: Edit/Save logic */
  const EDIT_PIN = "2025"; // Change if needed
  let editMode = false;

  document.addEventListener("DOMContentLoaded",()=>{
    const editBtn=document.getElementById("editBtn");
    const saveBtn=document.getElementById("saveBtn");

    editBtn.addEventListener("click",()=>{
      const pin=prompt("Enter edit PIN:");
      if(pin===EDIT_PIN){
        editMode=true;
        saveBtn.style.display="inline-block";
        enableEditing(true);
        alert("‚úÖ Edit mode enabled. You can now edit compliance dates.");
      }else{
        alert("Incorrect PIN ‚ùå");
      }
    });

    saveBtn.addEventListener("click",()=>{
      const table=document.querySelector("table");
      const headers=[...table.querySelectorAll("th")].map(th=>th.innerText.trim());
      const rows=[...table.querySelectorAll("tbody tr")];

      const data=rows.map(r=>{
        const cells=[...r.querySelectorAll("td")];
        const rec={};
        headers.forEach((h,i)=>rec[h]=cells[i].innerText.trim());
        return rec;
      });

      const grouped={};
      for(const rec of data){
        const type=rec["Store Type"];
        if(!grouped[type])grouped[type]=[];
        grouped[type].push(rec);
      }

      const fileMap={
        "Retail":"retail_compliance.json",
        "ELS":"els_compliance.json",
        "ELS Private":"els_private_compliance.json",
        "Cobra":"cobra_compliance.json",
        "Wenzel's":"wenzels_compliance.json"
      };

      Object.entries(grouped).forEach(([type,entries])=>{
        const payload={
          file:`Test/Compliance/${fileMap[type]}`,
          updatedBy:sessionStorage.getItem("mostlaneUser")||"Unknown",
          timestamp:new Date().toISOString(),
          data:entries
        };
        fetch("https://hooks.zapier.com/hooks/catch/20261714/xxxxxxx/",{
          method:"POST",
          headers:{"Content-Type":"application/json"},
          body:JSON.stringify(payload)
        }).then(r=>{
          if(r.ok)console.log(`‚úÖ ${type} data sent`);
          else console.error(`‚ùå failed for ${type}`);
        });
      });

      alert("Changes sent for update.");
      enableEditing(false);
      saveBtn.style.display="none";
      editMode=false;
    });

    function enableEditing(state){
      const editableCols=["5 Year","PAT","EM","PV","EV","Pump"];
      document.querySelectorAll("table tbody tr").forEach(row=>{
        [...row.children].forEach((td,i)=>{
          const header=document.querySelectorAll("table thead th")[i].innerText.trim();
          if(state && editableCols.includes(header)) td.contentEditable=true;
          else td.contentEditable=false;
        });
      });
    }
  });

  /* ‚úÖ your original fetchData(); stays right here */
  fetchData();
  </script>
</body>
</html>
