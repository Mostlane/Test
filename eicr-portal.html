<!DOCTYPE html>
<html lang="en">
<head>
  <script src="auth.js"></script>
  <meta charset="UTF-8" />
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>The Southern Co-op Compliance Portal</title>

  <link rel="icon" type="image/x-icon" href="favicon.ico">
  <link rel="shortcut icon" type="image/x-icon" href="favicon.ico">

  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      color: #1f2937;
      background-color: #e6e8eb;
      position: relative;
      min-height: 100vh;
      overflow-x: hidden;
    }
    body::before {
      content: "";
      position: fixed;
      inset: 0;
      background: url('Mostlane_Embossed.png') no-repeat center/180%;
      z-index: -1;
    }
    .container {
      background-color: rgba(255,255,255,0.6);
      margin: 20px auto;
      padding: 20px;
      border-radius: 15px;
      max-width: 95%;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
    }
    h1 { text-align: center; color: #0071CE; margin-top: 0; }
    .logo { display: block; margin: 10px auto 20px auto; max-height: 60px; }

    .backbar, .summary-bubbles, .filter-bubbles, .search-container, .utilbar {
      display:flex; flex-wrap:wrap; gap:10px; align-items:center; justify-content:flex-start; margin-bottom:10px;
    }
    .summary-bubbles, .filter-bubbles { justify-content:center; margin-bottom: 14px; }

    .backlink, .bubble, .btn {
      display:inline-flex; align-items:center; gap:8px;
      background:#0071CE; color:#fff; text-decoration:none;
      padding:8px 14px; border-radius:30px; font-weight:bold; border:0; cursor:pointer;
    }
    .bubble:hover, .btn:hover, .backlink:hover { opacity:.9; }
    .bubble.active { background:#28a745; }

    .search-input { padding:8px; width:300px; border-radius:20px; border:1px solid #ccc; }

    .table-wrapper { overflow-x:auto; overflow-y:auto; max-height:70vh; width:100%; }
    table { width:100%; border-collapse:collapse; margin-top:10px; }
    th, td { border:1px solid #999; padding:8px; text-align:center; font-size:14px; }
    th { background:#0071CE; color:#fff; position:sticky; top:0; z-index:5; }
    tr:nth-child(even){ background:rgba(255,255,255,0.7); }
    tr:nth-child(odd){ background:rgba(255,255,255,0.5); }
    .sp-btn{
      display:inline-block; padding:6px 10px; border-radius:6px; background:#0071CE; color:#fff;
      text-decoration:none; font-weight:bold; border:0; cursor:pointer;
    }
    [contenteditable="true"]{ background:#fff6d1; }

    .info { font-size:12px; color:#374151; display:flex; gap:12px; align-items:center; flex-wrap:wrap; margin:6px 0 10px; }

    .modal {
      display:none; position:fixed; z-index:999; inset:0; background:rgba(0,0,0,0.5);
      overflow-y:auto; -webkit-overflow-scrolling:touch;
    }
    .modal-content {
      background:#fff; border-radius:10px; max-width:560px; width:92%;
      margin:40px auto; padding:20px; box-shadow:0 4px 10px rgba(0, 0, 0, 0.3); position:relative;
    }
    .modal h2 { margin:0 0 10px; color:#0071CE; text-align:center; }
    .modal label { display:block; margin:6px 0; }
    .modal input[type="text"], .modal input[type="date"], .modal select {
      width:100%; padding:8px; border:1px solid #ccc; border-radius:6px; box-sizing:border-box;
    }
    .modal .row{ display:grid; grid-template-columns:1fr 1fr; gap:10px; }
    .modal .actions{ display:flex; gap:10px; justify-content:flex-end; margin-top:12px; }
    .modal .btn { border-radius:6px; }

    .filter-summary {
      background:rgba(255,255,255,0.8); border:1px solid #e5e7eb; border-radius:10px;
      padding:8px 12px; margin:10px auto; max-width:95%; text-align:center; color:#1f2937;
      font-size:14px; opacity:0; transition:opacity .3s ease; pointer-events:none;
    }
    .filter-summary.visible { opacity:1; pointer-events:auto; }

    .loading { text-align:center; padding:20px; font-size:16px; color:#0071CE; }
    .error { text-align:center; padding:20px; font-size:16px; color:#ff0000; }

    /* Row state colouring that persists until manual reload */
    tr.row-updating    { background: #eaf6ff !important; }
    tr.row-updated-ok  { background: #d7ffd9 !important; }
    tr.row-update-fail { background: #ffecec !important; }

    @media (max-width:768px){
      .search-input{ width:90%; font-size:16px; }
      th,td{ font-size:12px; padding:6px; }
      .modal-content{ max-width:92%; }
      .modal .row{ grid-template-columns:1fr; }
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Top bar -->
    <div class="backbar">
      <a class="backlink" href="https://mostlane.github.io/Test/compliance.html">‚Üê Back</a>
      <button id="reloadBtn" class="btn" title="Reload live data">Reload</button>
      <span id="liveNote" class="info">Live (no cache) ‚Ä¢ <span id="loadedCount">0</span> records loaded</span>

      <!-- Edit cluster -->
      <button id="editBtn" class="btn">Edit</button>
      <button id="saveBtn" class="btn" style="display:none;">Save Changes</button>
      <button id="addSiteBtn" class="btn" style="display:none;">Add Site</button>
      <button id="deleteSiteBtn" class="btn" style="display:none;">Delete Site</button>
    </div>

    <img src="mostlane-logo.jpg" alt="Mostlane Logo" class="logo">
    <h1>The Southern Co-op Compliance Portal</h1>

    <!-- Summary bubbles -->
    <div class="summary-bubbles">
      <button class="bubble" id="overdueBtn">Overdue</button>
      <button class="bubble" data-days="30">Due in 30 Days</button>
      <button class="bubble" data-days="90">Due in 90 Days</button>
      <button class="bubble" data-days="365">Due in 365 Days</button>
      <button class="bubble" id="searchModalBtn">Search by Date/Type</button>
      <button class="bubble" id="clearBtn">Clear</button>
      <button class="bubble" id="exportBtn">Export to Excel</button>
      <button class="bubble" id="summaryBtn">%</button>
    </div>

    <!-- Store type filters -->
    <div class="filter-bubbles" id="storeTypeFilters">
      <button class="bubble active" data-storetype="ALL">Show All</button>
      <button class="bubble" data-storetype="Retail">Retail</button>
      <button class="bubble" data-storetype="ELS">ELS</button>
      <button class="bubble" data-storetype="ELS Private">ELS Private</button>
      <button class="bubble" data-storetype="Cobra">Cobra</button>
      <button class="bubble" data-storetype="Wenzel's">Wenzel's</button>
    </div>

    <!-- Compliance type filters -->
    <div class="filter-bubbles" id="complianceFilters">
      <button class="bubble" data-cat="fiveYear">5 Year</button>
      <button class="bubble" data-cat="pat">PAT</button>
      <button class="bubble" data-cat="em">EM</button>
      <button class="bubble" data-cat="pv">PV</button>
      <button class="bubble" data-cat="ev">EV</button>
      <button class="bubble" data-cat="pump">Pump</button>
    </div>

    <div id="filterSummary" class="filter-summary"></div>

    <!-- Search bar -->
    <div class="search-container" style="justify-content:center;">
      <input class="search-input" id="searchBar" placeholder="Search store name, number or postcode..." />
    </div>

    <div class="table-wrapper">
      <table>
        <thead>
          <tr>
            <th>Store Code</th><th>Site Name</th><th>Store Type</th><th>Postcode</th><th>Status</th>
            <th>5 Year</th><th>PAT</th><th>EM</th><th>PV</th><th>EV</th><th>Pump</th><th>SharePoint</th>
          </tr>
        </thead>
        <tbody id="tableBody"><tr><td colspan="12" class="loading">Loading data‚Ä¶</td></tr></tbody>
      </table>
    </div>
  </div>

  <!-- XLSX for export -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <script>
/* =========================
   Hard settings / endpoints
   ========================= */
const EDIT_PIN = "2025";
const WORKER_BASE = "https://mostlane-pos.jamie-def.workers.dev/Compliance";
const CLOUDFLARE_GET = (key) => \`\${WORKER_BASE}/\${key}\`;
const CLOUDFLARE_UPDATE = \`\${WORKER_BASE}/update\`;
const CLOUDFLARE_DELETE = \`\${WORKER_BASE}/delete\`;

/* Kill any service workers that might cache */
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.getRegistrations().then(regs => regs.forEach(r => r.unregister()));
}

/* ===== State ===== */
let allData = [];       // full set (normalised)
let currentData = [];   // filtered / searched view
let editMode = false;
let activeStoreType = 'ALL';
const activeCategories = new Set();

/* ===== Helpers ===== */
function bust(url){
  const u = new URL(url);
  u.searchParams.set('v', Date.now() + Math.random());
  return u.toString();
}

async function fetchNoCacheJSON(url) {
  try {
    const res = await fetch(bust(url), {
      cache: 'no-store',
      mode: 'cors'
    });
    if (!res.ok) return null;
    return await res.json();
  } catch (e) {
    console.error('fetchNoCacheJSON error:', e);
    return null;
  }
}

function pad4(v){ return String(v ?? "").replace(/\\D/g,"").padStart(4,"0"); }
function pick(o, keys){ for (const k of keys){ if(o && o[k]!=null && String(o[k]).trim()!=="") return o[k]; } return ""; }

function normaliseRecord(raw, label){
  const rawCode = pick(raw, ["branchCode","Branch Code","BranchCode","Store Code","StoreCode","Branch","Code","ID"]);
  const storeCode = pad4(rawCode || "");
  const siteName  = pick(raw, ["Store Name","storeName","Site Name","siteName","Name"]);
  const postcode  = pick(raw, ["Postcode","postcode","Post Code","ZIP"]);
  const fiveYear  = pick(raw, ["5_Year","5 Year","5year","FiveYear"]);
  const pat       = pick(raw, ["PAT","Pat"]);
  const em        = pick(raw, ["EM","Emergency Lighting","EmergencyLighting"]);
  const pv        = pick(raw, ["PV","Photovoltaic"]);
  const ev        = pick(raw, ["EV","EVCP","EV_Charge"]);
  const pump      = pick(raw, ["PUMP","Pump"]);
  const sharePoint= pick(raw, ["SharePoint","SharePointURL","sharePointURL","sharePoint","SP"]);

  return {
    storeCode,
    siteName,
    postcode,
    storeType: label,
    fiveYear, pat, em, pv, ev, pump,
    sharePoint
  };
}

function parseDate(d) {
  if (!d) return null;
  const s = String(d).trim().replace(/^\\*/, '');
  if (!s) return null;
  if (/^\\d{1,2}\\/\\d{1,2}\\/\\d{2,4}$/.test(s)) {
    const [dd, mm, yy] = s.split('/');
    const y = yy.length === 2 ? (2000 + Number(yy)) : Number(yy);
    return new Date(y, Number(mm)-1, Number(dd));
  }
  const dt = new Date(s);
  return isNaN(dt) ? null : dt;
}

function getStatus(e){
  const now = new Date();
  const ds = [e.fiveYear, e.pat, e.em, e.pv, e.ev, e.pump].map(parseDate).filter(Boolean);
  let red=false, amber=false;
  for (const dt of ds) {
    if (dt < now) { red = true; break; }
    if ((dt - now) / 86400000 <= 30) amber = true;
  }
  return red ? 'üî¥' : amber ? 'üü°' : 'üü¢';
}

/* ============ Rendering ============ */
function renderTable(d){
  currentData = d;
  const tb = document.getElementById('tableBody');
  tb.innerHTML = '';
  const frag = document.createDocumentFragment();

  d.forEach(e=>{
    if (!e.storeCode || !e.siteName) return;
    const tr = document.createElement('tr');
    tr.dataset.code = e.storeCode;
    tr.innerHTML = `
      <td>${e.storeCode}</td><td>${e.siteName}</td><td>${e.storeType}</td>
      <td>${e.postcode}</td><td>${getStatus(e)}</td>
      <td>${e.fiveYear || ''}</td><td>${e.pat || ''}</td><td>${e.em || ''}</td>
      <td>${e.pv || ''}</td><td>${e.ev || ''}</td><td>${e.pump || ''}</td>
      <td>${e.sharePoint ? `<a class="sp-btn" href="${e.sharePoint}" target="_blank">Open</a>` : ''}</td>
    `;
    frag.appendChild(tr);
  });

  tb.appendChild(frag);
  document.getElementById('loadedCount').textContent = d.length;
  if (editMode) enableEditing(true);
}

/* apply filters + re-render */
function applyFilters(){
  let data = [...allData];
  if (activeStoreType !== 'ALL') data = data.filter(e=>e.storeType === activeStoreType);
  if (activeCategories.size > 0) {
    data = data.filter(e=>{
      for (const cat of activeCategories) {
        const val = e[cat]; if (!val || String(val).trim()==="") return false;
      }
      return true;
    });
  }
  const q = document.getElementById('searchBar').value.toLowerCase().trim();
  if (q) {
    data = data.filter(e =>
      (e.storeCode || '').toLowerCase().includes(q) ||
      (e.siteName || '').toLowerCase().includes(q) ||
      (e.postcode || '').toLowerCase().includes(q)
    );
  }
  renderTable(data);
  updateFilterSummary();
}

function updateFilterSummary(){
  const el = document.getElementById('filterSummary');
  const cats = activeCategories.size ? Array.from(activeCategories).join(', ') : 'None';
  el.textContent = `Store Type: ${activeStoreType} | Compliance: ${cats} | Showing ${currentData.length} of ${allData.length}`;
  el.classList.add('visible');
}

/* ============ Progressive Live Loads ============ */
const SOURCES = [
  { path: 'retail',      label: 'Retail' },
  { path: 'els',         label: 'ELS' },
  { path: 'els_private', label: 'ELS Private' },
  { path: 'cobra',       label: 'Cobra' },
  { path: 'wenzels',     label: "Wenzel's" }
];

async function fetchOneSource(s){
  const j = await fetchNoCacheJSON(CLOUDFLARE_GET(s.path));
  if (!j) return [];
  let arr = [];
  if (Array.isArray(j) && j.length === 1 && typeof j[0] === 'object' && !Array.isArray(j[0])) {
    arr = Object.values(j[0]);
  } else if (Array.isArray(j)) {
    arr = j;
  } else if (j && Array.isArray(j.data)) {
    arr = j.data;
  } else if (j && typeof j === 'object') {
    arr = Object.values(j);
  }
  return arr
    .map(r => normaliseRecord(r, s.label))
    .filter(r => r.storeCode && r.siteName && r.storeName !== '');
}

async function fetchAllProgressive(){
  allData = [];
  renderTable([]);
  const tb = document.getElementById('tableBody');
  tb.innerHTML = '<tr><td colspan="12" class="loading">Loading data‚Ä¶</td></tr>';

  for (const s of SOURCES){
    const chunk = await fetchOneSource(s).catch(err => {
      console.error('fetchOneSource error for', s.path, err);
      return [];
    });
    if (chunk.length){
      allData = allData.concat(chunk);
      applyFilters();
    }
  }
  if (!allData.length) {
    tb.innerHTML = '<tr><td colspan="12" class="error">No data returned.</td></tr>';
  }
}

/* ============ Edit / Save / Add / Delete ============ */
function enableEditing(state){
  const editableCols = ["5 Year","PAT","EM","PV","EV","Pump"];
  document.querySelectorAll("table tbody tr").forEach(row=>{
    [...row.children].forEach((td,i)=>{
      const header = document.querySelectorAll("thead th")[i].textContent.trim();
      if (state && editableCols.includes(header)) {
        td.contentEditable = true;
        td.style.background = "#fff6d1";
        td.addEventListener("input", ()=> row.dataset.changed = "true", { once:true });
      } else {
        td.contentEditable = false;
        td.style.background = "";
      }
    });
    if (!state) row.removeAttribute("data-changed");
  });
}

/* ‚Äî‚Äî Canonical KV keys (accept various headers, write consistent fields) ‚Äî‚Äî */
const KEY_CANONICAL = {
  "5 Year": "5_Year",
  "5_Year": "5_Year",
  "PAT": "PAT",
  "EM": "EM",
  "PV": "PV",
  "EV": "EV",
  "Pump": "PUMP",
  "PUMP": "PUMP",
  "SharePoint": "sharePointURL",
  "SharePointURL": "sharePointURL",
  "sharePointURL": "sharePointURL"
};

/* ‚Äî‚Äî strict normaliser for KV category names (fixes Wenzel's) ‚Äî‚Äî */
function normaliseTypeLabel(label) {
  return String(label || "")
    .toLowerCase()
    .replace(/[^a-z0-9]+/ig, "_")
    .replace(/^_+|_+$/g, "")
    .replace(/_+/g, "_");
}

/* Robust KV normaliser used for verification reads */
function toKVObject(raw){
  if (!raw) return {};
  if (Array.isArray(raw)) {
    if (raw.length === 1 && typeof raw[0] === 'object' && !Array.isArray(raw[0])) return raw[0];
    // If array of rows, convert to map by code if possible
    const out = {};
    for (const r of raw) {
      const code = String(r?.branchCode || r?.["Branch Code"] || r?.["Store Code"] || "").padStart(4,"0");
      if (code) out[code] = r;
    }
    return out;
  }
  if (typeof raw === 'object') return raw;
  return {};
}

/* After-write verification: confirm KV holds the exact new value(s) */
async function verifyWrite(storeType, branchCode, fields){
  try{
    const latest = await fetchNoCacheJSON(CLOUDFLARE_GET(storeType)); // e.g. /Compliance/retail
    const obj = toKVObject(latest);
    const code = String(branchCode).padStart(4,"0");
    const rec = obj[code] || {};
    // Every field we wrote must match round-trip
    for (const [k,v] of Object.entries(fields)){
      const got = (rec[k] ?? "").toString().trim();
      const want = (v ?? "").toString().trim();
      if (got !== want) return false;
    }
    return true;
  }catch(e){
    console.warn("verifyWrite error", e);
    return false;
  }
}

async function saveEditInstant(row){
  const storeCode = row.children[0].textContent.trim();
  const storeType = normaliseTypeLabel(row.children[2].textContent.trim());
  const headers = [...document.querySelectorAll("thead th")].map(th => th.textContent.trim());
  const record = {};
  [...row.children].forEach((td,i)=> record[headers[i]] = td.textContent.trim());

  const editableHeaders = ["5 Year","5_Year","PAT","EM","PV","EV","Pump","PUMP","SharePoint","SharePointURL","sharePointURL"];
  const fields = {};
  editableHeaders.forEach(h => {
    if (h in record) {
      const canon = KEY_CANONICAL[h] || h;
      fields[canon] = record[h];
    }
  });

  const payload = {
    updates: [{
      storeType,
      branchCode: storeCode.padStart(4,"0"),
      fields
    }]
  };

  // Show "updating" state and keep until we verify
  row.classList.remove("row-updated-ok","row-update-fail");
  row.classList.add("row-updating");

  let ok = false;
  try {
    const res = await fetch(CLOUDFLARE_UPDATE, {
      method: "POST",
      headers: { "Content-Type": "application/json", "Cache-Control": "no-store" },
      body: JSON.stringify(payload)
    });
    // If worker didn't 200, mark fail immediately
    if (!res.ok) throw new Error("Worker update returned HTTP " + res.status);

    // Read-after-write verification against KV
    ok = await verifyWrite(storeType, storeCode, fields);

  } catch (e) {
    console.error("Update error:", e);
    ok = false;
  }

  // Persist row colouring until next manual reload
  row.classList.remove("row-updating");
  if (ok) {
    row.classList.add("row-updated-ok");   // green and persistent until Reload
  } else {
    row.classList.add("row-update-fail");  // red and persistent until Reload
  }
}

/* Add Site modal */
function openAddSiteModal(){
  const modal = document.createElement('div');
  modal.className = 'modal';
  modal.innerHTML = `
    <div class="modal-content">
      <h2>Add Site</h2>
      <div class="row">
        <div>
          <label>Store Type</label>
          <select id="add_storeType">
            <option>Retail</option><option>ELS</option><option>ELS Private</option>
            <option>Cobra</option><option>Wenzel's</option>
          </select>
        </div>
        <div>
          <label>Store Code (4 digits)</label>
          <input id="add_code" type="text" placeholder="e.g. 0123" />
        </div>
      </div>
      <label>Site Name</label><input id="add_name" type="text" placeholder="Site name" />
      <label>Postcode</label><input id="add_postcode" type="text" placeholder="e.g. PO15 5RQ" />
      <div class="row">
        <div><label>5 Year</label><input id="add_five" type="text" placeholder="dd/mm/yyyy" /></div>
        <div><label>PAT</label><input id="add_pat" type="text" placeholder="dd/mm/yyyy" /></div>
      </div>
      <div class="row">
        <div><label>EM</label><input id="add_em" type="text" placeholder="dd/mm/yyyy" /></div>
        <div><label>PV</label><input id="add_pv" type="text" placeholder="dd/mm/yyyy" /></div>
      </div>
      <div class="row">
        <div><label>EV</label><input id="add_ev" type="text" placeholder="dd/mm/yyyy" /></div>
        <div><label>Pump</label><input id="add_pump" type="text" placeholder="dd/mm/yyyy" /></div>
      </div>
      <label>SharePoint URL</label><input id="add_sp" type="text" placeholder="https://..." />
      <div class="actions">
        <button class="btn" id="add_save">Save</button>
        <button class="btn" style="background:#ccc;color:#000;" id="add_cancel">Cancel</button>
      </div>
    </div>`;
  document.body.appendChild(modal);
  modal.style.display = 'block';

  modal.querySelector('#add_cancel').onclick = ()=> modal.remove();
  modal.querySelector('#add_save').onclick = async ()=>{
    const typeRaw = modal.querySelector('#add_storeType').value;
    const type = normaliseTypeLabel(typeRaw);
    const code = (modal.querySelector('#add_code').value || '').padStart(4, '0');
    const name = modal.querySelector('#add_name').value || '';
    if (!/^\d{4}$/.test(code)) return alert("Store Code must be 4 digits.");
    if (!name) return alert("Site Name is required.");

    const payload = {
      updates: [{
        storeType: type,
        branchCode: code,
        fields: {
          "Store Name": name,
          "Postcode": modal.querySelector('#add_postcode').value || '',
          "5_Year":  modal.querySelector('#add_five').value || '',
          "PAT":     modal.querySelector('#add_pat').value || '',
          "EM":      modal.querySelector('#add_em').value || '',
          "PV":      modal.querySelector('#add_pv').value || '',
          "EV":      modal.querySelector('#add_ev').value || '',
          "PUMP":    modal.querySelector('#add_pump').value || '',
          "sharePointURL": modal.querySelector('#add_sp').value || ''
        }
      }]
    };

    try{
      await fetch(CLOUDFLARE_UPDATE, {
        method: "POST",
        headers: { "Content-Type":"application/json", "Cache-Control":"no-store" },
        body: JSON.stringify(payload)
      });
      modal.remove();
      alert("‚úÖ Site added.");
      // Do not auto-reload; user can press Reload if they want
    }catch(e){
      console.error(e);
      alert("‚ùå Failed to add site.");
    }
  };
}

/* Delete Site modal */
function openDeleteSiteModal(){
  const modal = document.createElement('div');
  modal.className = 'modal';
  modal.innerHTML = `
    <div class="modal-content">
      <h2>Delete Site</h2>
      <div class="row">
        <div>
          <label>Store Type</label>
          <select id="del_storeType">
            <option>Retail</option><option>ELS</option><option>ELS Private</option>
            <option>Cobra</option><option>Wenzel's</option>
          </select>
        </div>
        <div>
          <label>Store Code (4 digits)</label>
          <input id="del_code" type="text" placeholder="e.g. 0123" />
        </div>
      </div>
      <div class="actions">
        <button class="btn" style="background:#d9534f" id="del_go">Delete</button>
        <button class="btn" style="background:#ccc;color:#000;" id="del_cancel">Cancel</button>
      </div>
    </div>`;
  document.body.appendChild(modal);
  modal.style.display='block';

  modal.querySelector('#del_cancel').onclick = ()=> modal.remove();
  modal.querySelector('#del_go').onclick = async ()=>{
    const type = normaliseTypeLabel(modal.querySelector('#del_storeType').value);
    const code = (modal.querySelector('#del_code').value || '').padStart(4, '0');
    if (!/^\d{4}$/.test(code)) return alert("Store Code must be 4 digits.");

    try{
      const res = await fetch(CLOUDFLARE_DELETE, {
        method: "POST",
        headers: { "Content-Type": "application/json", "Cache-Control":"no-store" },
        body: JSON.stringify({ storeType: type, branchCode: code })
      });
      await res.json().catch(()=>({}));
      modal.remove();
      alert("üóëÔ∏è Site deleted (if it existed).");
    }catch(e){
      console.error(e);
      alert("‚ùå Failed to delete site.");
    }
  };
}

/* ============ Date Filters / Search / Summary / Export ============ */
function filterOverdue(){
  const now = new Date();
  const filtered = allData.filter(e => {
    return [e.fiveYear,e.pat,e.em,e.pv,e.ev,e.pump]
      .map(parseDate).filter(Boolean).some(d => d < now);
  });
  renderTable(filtered);
  updateFilterSummary();
}
function filterDueWithin(days){
  const now = new Date();
  const end = new Date(now.getTime() + days*86400000);
  const filtered = allData.filter(e => {
    return [e.fiveYear,e.pat,e.em,e.pv,e.ev,e.pump]
      .map(parseDate).filter(Boolean).some(d => d >= now && d <= end);
  });
  renderTable(filtered);
  updateFilterSummary();
}

function openSearchModal(){
  const modal = document.createElement('div');
  modal.className = 'modal';
  modal.innerHTML = `
    <div class="modal-content">
      <h2>Search by Date/Type</h2>
      <label>Compliance Type:</label>
      <select id="searchType">
        <option value="">All</option>
        <option value="fiveYear">5 Year</option>
        <option value="pat">PAT</option>
        <option value="em">EM</option>
        <option value="pv">PV</option>
        <option value="ev">EV</option>
        <option value="pump">Pump</option>
      </select>
      <label>From Date:</label>
      <input type="date" id="fromDate">
      <label>To Date:</label>
      <input type="date" id="toDate">
      <div class="actions">
        <button class="btn" id="go">Search</button>
        <button class="btn" style="background:#ccc;color:#000;" id="close">Close</button>
      </div>
    </div>`;
  document.body.appendChild(modal);
  modal.style.display='block';
  modal.querySelector('#close').onclick = ()=> modal.remove();
  modal.querySelector('#go').onclick = ()=>{
    const type = document.getElementById('searchType').value;
    const from = parseDate(document.getElementById('fromDate').value);
    const to   = parseDate(document.getElementById('toDate').value);

    let filtered = [...allData];
    if (type) filtered = filtered.filter(e => e[type] && String(e[type]).trim()!=='');
    if (from || to) {
      filtered = filtered.filter(e => {
        const keys = type ? [type] : ['fiveYear','pat','em','pv','ev','pump'];
        return keys.some(k => {
          const d = parseDate(e[k]); if (!d) return false;
          return (!from || d >= from) && (!to || d <= to);
        });
      });
    }
    renderTable(filtered);
    updateFilterSummary();
    modal.remove();
  };
}

function clearFilters(){
  activeStoreType = 'ALL';
  activeCategories.clear();
  document.querySelectorAll('#storeTypeFilters .bubble, #complianceFilters .bubble').forEach(b=>b.classList.remove('active'));
  document.querySelector('#storeTypeFilters .bubble[data-storetype="ALL"]').classList.add('active');
  document.getElementById('searchBar').value = '';
  applyFilters();
}

function openSummaryModal(){
  const groups = {};
  const now = new Date();
  currentData.forEach(e=>{
    const key = e.storeType || 'Unknown';
    if (!groups[key]) groups[key] = { total:0, GREEN:0, AMBER:0, RED:0 };
    groups[key].total++;
    let red=false, amber=false;
    [e.fiveYear,e.pat,e.em,e.pv,e.ev,e.pump].map(parseDate).filter(Boolean).forEach(dt=>{
      if(dt<now) red=true; else if ((dt-now)/86400000 <= 30) amber=true;
    });
    const s = red ? 'RED' : amber ? 'AMBER' : 'GREEN';
    groups[key][s]++;
  });

  const order = ["Retail","ELS","ELS Private","Cobra","Wenzel's","Unknown"];
  const rows = order.filter(k=>groups[k]).map(k=>{
    const g = groups[k], t = g.total || 1;
    const pct = n => ( (n*100/t).toFixed(1) + '%' );
    return `
      <div style="border:1px solid #ddd; border-radius:10px; margin:10px 0; padding:10px; background:#fff;">
        <div style="font-weight:bold; border-bottom:1px solid #ddd; padding-bottom:6px; margin-bottom:10px; color:#0071CE; text-transform:capitalize;">${k}</div>
        <div>Total: <b>${g.total}</b></div>
        <div>üü¢ GREEN: <b>${g.GREEN}</b> (${pct(g.GREEN)})</div>
        <div>üü° AMBER: <b>${g.AMBER}</b> (${pct(g.AMBER)})</div>
        <div>üî¥ RED: <b>${g.RED}</b> (${pct(g.RED)})</div>
      </div>`;
  });

  const modal = document.createElement('div');
  modal.className = 'modal';
  modal.innerHTML = `
    <div class="modal-content">
      <h2>Compliance Summary</h2>
      ${rows.join('') || '<p>No data.</p>'}
      <div class="actions"><button class="btn" style="background:#ccc;color:#000;" id="close">Close</button></div>
    </div>`;
  document.body.appendChild(modal);
  modal.style.display='block';
  modal.querySelector('#close').onclick = ()=> modal.remove();
}

function exportExcel(){
  const wb = XLSX.utils.book_new();
  const wsData = [];

  wsData.push(["The Southern Co-op Compliance Portal Export"]);
  const uname = (sessionStorage.getItem("mostlaneUser") || "Unknown").replace(/\\./g, " ");
  wsData.push(["Exported by:", uname]);
  wsData.push(["Date/Time:", new Date().toLocaleString("en-GB")]);

  const cats = activeCategories.size ? Array.from(activeCategories).join(', ') : 'None';
  wsData.push(["Active Filters:", `Store Type: ${activeStoreType} | Compliance: ${cats}`]);
  wsData.push([]);

  const headers = [
    "Store Code","Site Name","Store Type","Postcode","Status",
    "5 Year","PAT","EM","PV","EV","Pump","SharePoint"
  ];
  wsData.push(headers);

  currentData.forEach(e=>{
    wsData.push([
      e.storeCode, e.siteName, e.storeType, e.postcode, getStatus(e),
      e.fiveYear || "", e.pat || "", e.em || "", e.pv || "", e.ev || "", e.pump || "",
      e.sharePoint ? "Open File" : ""
    ]);
  });

  const ws = XLSX.utils.aoa_to_sheet(wsData);
  const sharePointCol = headers.indexOf("SharePoint");
  if (sharePointCol !== -1) {
    currentData.forEach((e, i) => {
      const cell = XLSX.utils.encode_cell({ r: i + 5, c: sharePointCol });
      if (ws[cell] && e.sharePoint) ws[cell].l = { Target: e.sharePoint, Tooltip: "Open file" };
    });
  }

  XLSX.utils.book_append_sheet(wb, ws, activeStoreType === 'ALL' ? 'All Data' : activeStoreType);
  const datePart = new Date().toISOString().slice(0,16).replace(/[:T]/g,'-');
  const fileName = `Compliance_Export_${activeStoreType === 'ALL' ? 'All' : activeStoreType}_${datePart}.xlsx`;
  XLSX.writeFile(wb, fileName);
}

/* ============ Wiring UI ============ */
document.addEventListener('DOMContentLoaded', () => {
  // Buttons
  document.getElementById('reloadBtn').onclick = fetchAllProgressive;
  document.getElementById('overdueBtn').onclick = ()=> {
    document.querySelectorAll('.summary-bubbles .bubble').forEach(b=>b.classList.remove('active'));
    document.getElementById('overdueBtn').classList.add('active');
    filterOverdue();
  };
  document.querySelectorAll('.summary-bubbles .bubble[data-days]').forEach(b=>{
    b.onclick = ()=>{
      document.querySelectorAll('.summary-bubbles .bubble').forEach(x=>x.classList.remove('active'));
      b.classList.add('active');
      filterDueWithin(Number(b.dataset.days));
    };
  });
  document.getElementById('searchModalBtn').onclick = openSearchModal;
  document.getElementById('clearBtn').onclick = ()=>{
    document.querySelectorAll('.summary-bubbles .bubble').forEach(b=>b.classList.remove('active'));
    clearFilters();
  };
  document.getElementById('exportBtn').onclick = exportExcel;
  document.getElementById('summaryBtn').onclick = openSummaryModal;

  // Store type filters
  document.querySelectorAll('#storeTypeFilters .bubble').forEach(b=>{
    b.onclick = ()=>{
      document.querySelectorAll('#storeTypeFilters .bubble').forEach(x=>x.classList.remove('active'));
      b.classList.add('active');
      activeStoreType = b.dataset.storetype;
      applyFilters();
    };
  });

  // Compliance filters
  document.querySelectorAll('#complianceFilters .bubble').forEach(b=>{
    b.onclick = ()=>{
      const cat = b.dataset.cat;
      if (activeCategories.has(cat)) { activeCategories.delete(cat); b.classList.remove('active'); }
      else { activeCategories.add(cat); b.classList.add('active'); }
      applyFilters();
    };
  });

  // Search bar (debounced)
  const searchBar = document.getElementById('searchBar');
  let t;
  searchBar.addEventListener('input', ()=>{
    clearTimeout(t);
    t = setTimeout(applyFilters, 120);
  });

  // Edit flow
  const editBtn = document.getElementById('editBtn');
  const saveBtn = document.getElementById('saveBtn');
  const addBtn  = document.getElementById('addSiteBtn');
  const delBtn  = document.getElementById('deleteSiteBtn');

  editBtn.onclick = ()=>{
    const pin = prompt("Enter edit PIN:");
    if (pin === EDIT_PIN) {
      editMode = true;
      enableEditing(true);
      editBtn.style.display = "none";
      saveBtn.style.display = "inline-flex";
      addBtn.style.display  = "inline-flex";
      delBtn.style.display  = "inline-flex";
      alert("‚úÖ Edit mode enabled.");
    } else {
      alert("‚ùå Incorrect PIN");
    }
  };

  saveBtn.onclick = async ()=>{
    const changed = [...document.querySelectorAll("tbody tr[data-changed='true']")];
    if (!changed.length) return alert("No changes detected.");
    alert("‚úÖ Changes queued ‚Äî sending now.");
    // Save each changed row (row-level verification + colouring)
    for (const r of changed) { await saveEditInstant(r); }
    // Exit edit mode but DO NOT auto-reload (lets green/red persist)
    enableEditing(false);
    editMode = false;
    editBtn.style.display = "inline-flex";
    saveBtn.style.display = "none";
    addBtn.style.display  = "none";
    delBtn.style.display  = "none";
  };

  addBtn.onclick = openAddSiteModal;
  delBtn.onclick = openDeleteSiteModal;

  // initial fetch
  fetchAllProgressive();
});

// DEBUG LOGGER ‚Äî shows update results on-screen for iPhone use
window.addEventListener("message", e => {
  if (e.data && e.data.__updateDebug) {
    alert("Debug:\n" + JSON.stringify(e.data.__updateDebug, null, 2));
  }
});

const oldSaveEditInstant = saveEditInstant;
saveEditInstant = async function(row) {
  try {
    await oldSaveEditInstant(row);
  } catch (err) {
    alert("Save error: " + err.message);
  }
  // Post a tiny debug payload (code + normalised storeType)
  const storeCode = row.children[0].textContent.trim();
  const storeType = normaliseTypeLabel(row.children[2].textContent.trim());
  window.postMessage({__updateDebug: {storeCode, storeType}}, "*");
};
  </script>
</body>
</html>
