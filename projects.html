<!DOCTYPE html>
<html lang="en">
<head>
  <script src="auth.js"></script>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Projects ‚Äì Mostlane</title>

  <style>
    body{
      margin:0;
      font-family:"Segoe UI",system-ui,-apple-system,Arial,sans-serif;
      background:#e6e8eb url('Mostlane_Embossed.png') no-repeat center center fixed;
      background-size:cover;
      color:#1f2937;
    }
    .topbar{
      position:sticky; top:0; z-index:10;
      background:rgba(255,255,255,.75);
      backdrop-filter:blur(6px);
      box-shadow:0 2px 10px rgba(0,0,0,.08);
      padding:10px 14px;
      display:flex; justify-content:space-between;
    }
    .btn{border:none;border-radius:10px;padding:10px 14px;font-size:14px;cursor:pointer}
    .btn-outline{background:#fff;border:1px solid #004a99;color:#004a99}
    .btn-primary{background:#004a99;color:#fff}
    .wrap{
      max-width:1100px;margin:16px auto;padding:14px;
      background:rgba(255,255,255,.7);border-radius:12px;
    }
    .grid{display:grid;gap:12px;grid-template-columns:1fr 1fr}
    @media(max-width:900px){.grid{grid-template-columns:1fr}}
    .card{background:#fff;border-radius:12px;padding:12px}
    .proj-row,.file-row{
      border:1px solid #e5e7eb;border-radius:12px;padding:10px;margin-top:10px;
      display:flex;justify-content:space-between;gap:10px;cursor:pointer;
    }
    .file-name{font-weight:600}
    .file-meta{font-size:12px;color:#6b7280}
    .actions{display:flex;gap:8px}
    .mask{
      position:fixed;inset:0;display:none;align-items:center;justify-content:center;
      background:rgba(0,0,0,.45);z-index:50;
    }
    .mask.show{display:flex}

    /* üî• MODAL */
    .modal{
      background:#fff;border-radius:14px;
      width:min(95vw,900px);height:min(90vh,800px);
      display:flex;flex-direction:column;
      overflow:hidden;
    }
    .modal-header{
      padding:10px 14px;
      display:flex;justify-content:space-between;align-items:center;
      border-bottom:1px solid #e5e7eb;
    }
    .modal-body{
      flex:1;overflow:auto;background:#f9fafb;
    }
    .modal-body iframe,
    .modal-body img{
      width:100%;height:100%;border:none;
    }
  </style>
</head>

<body>

<div class="topbar">
  <button class="btn btn-outline" onclick="location.href='main.html'">‚¨Ö Main Menu</button>
  <strong style="color:#004a99">Projects</strong>
</div>

<div class="wrap">
  <div class="grid">
    <div class="card">
      <strong>Projects</strong>
      <div id="projectsList"></div>
    </div>

    <div class="card">
      <strong id="selTitle">Select a project</strong>
      <div id="filesList"></div>
    </div>
  </div>
</div>

<!-- üî• FILE VIEW MODAL -->
<div class="mask" id="viewerMask">
  <div class="modal">
    <div class="modal-header">
      <strong id="viewerTitle">Viewing file</strong>
      <button class="btn btn-outline" onclick="closeViewer()">‚úï Close</button>
    </div>
    <div class="modal-body" id="viewerBody"></div>
  </div>
</div>

<script>
const API = "https://projects-ml-portal.jamie-def.workers.dev";
const USER = sessionStorage.getItem("mostlaneUser");
if(!USER) location.href="login.html";

const projectsList = document.getElementById("projectsList");
const filesList = document.getElementById("filesList");
const selTitle = document.getElementById("selTitle");

const viewerMask = document.getElementById("viewerMask");
const viewerBody = document.getElementById("viewerBody");
const viewerTitle = document.getElementById("viewerTitle");

function apiGet(path){
  return fetch(API+path,{
    headers:{Authorization:"Bearer "+USER},
    cache:"no-store"
  }).then(r=>r.json().then(j=>{
    if(!r.ok) throw new Error(j.error||"Error");
    return j;
  }));
}

function openViewer(file){
  viewerTitle.textContent = file.title || file.name;
  viewerBody.innerHTML = "";

  const ext = (file.name||"").toLowerCase();

  if(ext.endsWith(".pdf")){
    viewerBody.innerHTML =
      `<iframe src="${API}/download/${file.id}?inline=1"></iframe>`;
  }
  else if(ext.match(/\.(png|jpg|jpeg|webp|gif)$/)){
    viewerBody.innerHTML =
      `<img src="${API}/download/${file.id}?inline=1">`;
  }
  else{
    viewerBody.innerHTML = `
      <div style="padding:20px">
        <p>This file type can‚Äôt be previewed.</p>
        <a class="btn btn-primary" href="${API}/download/${file.id}">‚¨á Download</a>
      </div>
    `;
  }

  viewerMask.classList.add("show");
}

function closeViewer(){
  viewerMask.classList.remove("show");
  viewerBody.innerHTML="";
}

async function loadProjects(){
  const d = await apiGet("/projects");
  projectsList.innerHTML="";
  d.projects.forEach(p=>{
    const r=document.createElement("div");
    r.className="proj-row";
    r.innerHTML=`<div><strong>${p.name}</strong><div class="file-meta">${p.client||""}</div></div>`;
    r.onclick=()=>selectProject(p.id);
    projectsList.appendChild(r);
  });
}

async function selectProject(id){
  const d = await apiGet(`/projects/${id}/files`);
  selTitle.textContent=d.project.name;
  filesList.innerHTML="";

  d.files.forEach(f=>{
    const r=document.createElement("div");
    r.className="file-row";
    r.innerHTML=`
      <div>
        <div class="file-name">${f.title||f.name}</div>
        <div class="file-meta">${f.name}</div>
      </div>
      <div class="actions">
        <button class="btn btn-primary">üëÅ View</button>
        <button class="btn btn-outline">‚¨á</button>
      </div>
    `;
    r.querySelector(".btn-primary").onclick=()=>openViewer(f);
    r.querySelector(".btn-outline").onclick=()=>window.open(`${API}/download/${f.id}`);
    filesList.appendChild(r);
  });
}

loadProjects();
</script>

</body>
</html>
