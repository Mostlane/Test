<!DOCTYPE html>
<html lang="en">
<head>
  <script src="auth.js"></script>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>PO Costing</title>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background: #e6e8eb url('Mostlane_Embossed.png') no-repeat center center fixed;
      background-size: cover;
      margin: 0;
      padding: 20px;
      color: #333;
    }
    .container {
      max-width: 1100px;
      margin: auto;
      background: rgba(255,255,255,0.9);
      padding: 24px;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    h1 {
      text-align: center;
      color: #003366;
      margin: 0 0 16px 0;
    }
    .top-bar, .filters {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      margin-bottom: 14px;
    }
    .filters > * { margin-right: 8px; }
    button, .tab-btn {
      background-color: rgba(0,74,153,0.9);
      color: #fff; border: none;
      padding: 10px 16px; border-radius: 8px;
      cursor: pointer; font-size: 15px; white-space: nowrap;
    }
    .tab-btn.inactive { background: #7a8aa6; }
    select, input[type="search"], input[type="number"] {
      background: #fff; color: #003366;
      border: 1px solid #ccc; border-radius: 8px;
      padding: 8px 10px; font-size: 15px;
    }
    .tabs { display: flex; gap: 8px; margin: 10px 0 16px; }
    .section-title {
      background: #003366; color: #fff;
      padding: 8px 12px; border-radius: 6px; font-weight: bold;
      margin-top: 16px;
    }
    .table-wrapper {
      overflow-x: auto; border-radius: 8px; margin-top: 8px;
    }
    table { width: 100%; border-collapse: collapse; min-width: 860px; }
    th, td {
      text-align: left; padding: 10px 8px;
      border-bottom: 1px solid #ddd; font-size: 15px;
      vertical-align: middle;
    }
    th { background-color: #f0f3f8; color: #003366; }
    tr:hover { background-color: #f9f9f9; }
    .map-link { color: #003366; text-decoration: none; font-size: 18px; }
    .right { text-align: right; }
    .nowrap { white-space: nowrap; }
    .muted { color: #666; font-size: 13px; }
    .status { font-size: 12px; }
    .save-btn { padding: 6px 10px; }
    .inline {
      display: inline-flex; align-items: center; gap: 8px;
    }
    .vat-label { font-size: 13px; color: #003366; }
    @media (max-width: 750px) {
      body { padding: 10px; }
      .container { padding: 15px; }
      th, td { font-size: 13px; padding: 8px 6px; }
      button, .tab-btn, select, input { width: 100%; }
      .top-bar, .filters { flex-direction: column; align-items: stretch; }
      .tabs { flex-direction: column; }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>PO Costing</h1>

    <div class="top-bar">
      <button onclick="window.location.href='main.html'">Main Menu</button>
      <div class="tabs">
        <button id="toCostBtn" class="tab-btn">To Cost</button>
        <button id="costedBtn" class="tab-btn inactive">Costed Entries</button>
      </div>
    </div>

    <div class="filters">
      <div>
        <label for="supplierFilter"><strong>Supplier:</strong></label>
        <select id="supplierFilter">
          <option value="">All Suppliers</option>
        </select>
      </div>
      <div>
        <label for="dateRange"><strong>Show:</strong></label>
        <select id="dateRange">
          <option value="7">Last 7 Days</option>
          <option value="14">Last 14 Days</option>
          <option value="30" selected>Last 30 Days</option>
          <option value="60">Last 60 Days</option>
          <option value="90">Last 90 Days</option>
          <option value="all">All</option>
        </select>
      </div>
      <div class="inline">
        <label for="searchBox"><strong>Search:</strong></label>
        <input id="searchBox" type="search" placeholder="PO number or description‚Ä¶" />
      </div>
      <div class="muted" id="statusText"></div>
    </div>

    <div id="tabContent"></div>
  </div>

  <script>
  // ----- Config -----
  const GET_URL = 'https://mostlane-pos.jamie-def.workers.dev/get-po';
  const UPDATE_URL = 'https://mostlane-pos.jamie-def.workers.dev/update-po';

  // ----- Utils -----
  const dotToSpace = s => (s || '').replace(/\./g, ' ');
  function parseUKDate(dateStr) {
    if (!dateStr) return null;
    const [d, m, y] = dateStr.split('/');
    if (!d || !m || !y) return null;
    return new Date(`${y}-${m}-${d}T00:00:00`);
  }
  function formatDateDisplay(dateStr) {
    const d = parseUKDate(dateStr);
    if (!d || isNaN(d)) return '';
    return d.toLocaleDateString('en-GB', { day: '2-digit', month: 'short', year: 'numeric' });
  }
  function formatGBP(n) {
    if (n === null || n === undefined || isNaN(n)) return '';
    return '¬£' + Number(n).toFixed(2);
  }
  function byId(id){ return document.getElementById(id); }

  // ----- State -----
  let allPOs = [];
  let currentTab = 'toCost'; // 'toCost' | 'costed'
  let engineerName = '';

  // ----- Filters -----
  function filterByDate(pos, range) {
    if (range === 'all') return pos;
    const days = parseInt(range);
    const cutoff = new Date();
    cutoff.setDate(cutoff.getDate() - days);
    return pos.filter(p => {
      const d = parseUKDate(p.date);
      return d && d >= cutoff;
    });
  }
  function applyAllFilters(base) {
    const supplierVal = byId('supplierFilter').value;
    const dateVal = byId('dateRange').value;
    const searchVal = (byId('searchBox').value || '').toLowerCase().trim();

    let out = filterByDate(base, dateVal);
    if (supplierVal) out = out.filter(p => (p.supplierName || '') === supplierVal);
    if (searchVal) {
      out = out.filter(p => {
        const hay = [p.poNumber, p.description, p.supplierName].join(' ').toLowerCase();
        return hay.includes(searchVal);
      });
    }
    return out;
  }

  // ----- Renderers -----
  function render() {
    const content = byId('tabContent');
    content.innerHTML = '';

    const uncosted = allPOs.filter(p => !(Number(p.costGross) > 0 || Number(p.costNet) > 0));
    const costed   = allPOs.filter(p =>  (Number(p.costGross) > 0 || Number(p.costNet) > 0));

    // Populate supplier filter from *all* POs
    const supSel = byId('supplierFilter');
    const currentSupplier = supSel.value;
    supSel.innerHTML = '<option value="">All Suppliers</option>';
    [...new Set(allPOs.map(p => p.supplierName).filter(Boolean))].sort()
      .forEach(name => {
        const opt = document.createElement('option');
        opt.value = name; opt.textContent = name;
        supSel.appendChild(opt);
      });
    // restore selection
    supSel.value = currentSupplier;

    // Apply filters
    const list = currentTab === 'toCost' ? applyAllFilters(uncosted) : applyAllFilters(costed);

    byId('statusText').textContent = `${list.length} item(s)`;

    const title = document.createElement('div');
    title.className = 'section-title';
    title.textContent = currentTab === 'toCost' ? 'To Cost' : 'Costed Entries';
    content.appendChild(title);

    const wrap = document.createElement('div');
    wrap.className = 'table-wrapper';
    const table = document.createElement('table');

    if (currentTab === 'toCost') {
      table.innerHTML = `
        <thead>
          <tr>
            <th>Date</th>
            <th>PO Number</th>
            <th>Supplier</th>
            <th>Description</th>
            <th class="right">Net</th>
            <th class="right">Gross</th>
            <th>VAT @20%</th>
            <th>Map</th>
            <th></th>
          </tr>
        </thead>
        <tbody>
          ${list
            .sort((a,b)=> new Date(b.createdAt) - new Date(a.createdAt))
            .map(p => {
              const id = p.poNumber.replace(/[^A-Za-z0-9]/g,'_');
              const mapCell = (p.latitude && p.longitude)
                ? `<a class="map-link" href="https://www.google.com/maps?q=${p.latitude},${p.longitude}" target="_blank">üìç</a>`
                : '';
              return `
              <tr data-po="${p.poNumber}">
                <td class="nowrap">${formatDateDisplay(p.date)}</td>
                <td class="nowrap">${p.poNumber}</td>
                <td>${p.supplierName || ''}</td>
                <td>${p.description || ''}</td>
                <td class="right">
                  <input type="number" step="0.01" id="net-${id}" placeholder="0.00"
                    oninput="onNetChanged('${id}')" />
                </td>
                <td class="right">
                  <input type="number" step="0.01" id="gross-${id}" placeholder="0.00"
                    oninput="onGrossChanged('${id}')" />
                </td>
                <td class="nowrap">
                  <label class="vat-label">
                    <input type="checkbox" id="vat-${id}" checked onchange="onVATToggle('${id}')" />
                    20%
                  </label>
                </td>
                <td class="nowrap">${mapCell}</td>
                <td class="nowrap">
                  <button class="save-btn" onclick="saveCost('${p.poNumber}','${id}')">üíæ Save</button>
                </td>
              </tr>`;
            }).join('')}
        </tbody>`;
    } else {
      table.innerHTML = `
        <thead>
          <tr>
            <th>Date Costed</th>
            <th>PO Number</th>
            <th>Supplier</th>
            <th>Description</th>
            <th class="right">Net</th>
            <th class="right">VAT</th>
            <th class="right">Gross</th>
            <th>Map</th>
          </tr>
        </thead>
        <tbody>
          ${list
            .sort((a,b)=> new Date(b.costedAt || b.createdAt) - new Date(a.costedAt || a.createdAt))
            .map(p => {
              const vatRate = (p.vatRate ?? 0.2);
              const net = Number(p.costNet || 0);
              const gross = Number(p.costGross || 0);
              const vat = gross && net ? (gross - net) : Number((net * vatRate).toFixed(2));
              const mapCell = (p.latitude && p.longitude)
                ? `<a class="map-link" href="https://www.google.com/maps?q=${p.latitude},${p.longitude}" target="_blank">üìç</a>`
                : '';
              const costedAtTxt = p.costedAt
                ? new Date(p.costedAt).toLocaleString('en-GB', { hour12:false })
                : '';
              return `
              <tr>
                <td class="nowrap">${costedAtTxt}</td>
                <td class="nowrap">${p.poNumber}</td>
                <td>${p.supplierName || ''}</td>
                <td>${p.description || ''}</td>
                <td class="right">${formatGBP(net)}</td>
                <td class="right">${formatGBP(vat)}</td>
                <td class="right">${formatGBP(gross || (net*(1+vatRate)))}</td>
                <td class="nowrap">${mapCell}</td>
              </tr>`;
            }).join('')}
        </tbody>`;
    }

    wrap.appendChild(table);
    content.appendChild(wrap);
  }

  // ----- VAT auto-calc handlers (per row) -----
  function readInputs(id) {
    const netEl = byId(`net-${id}`);
    const grossEl = byId(`gross-${id}`);
    const vatEl = byId(`vat-${id}`);
    const net = parseFloat(netEl.value);
    const gross = parseFloat(grossEl.value);
    const vatOn = !!vatEl?.checked;
    const vatRate = vatOn ? 0.2 : 0.0;
    return { netEl, grossEl, vatEl, net, gross, vatRate };
  }
  function onNetChanged(id) {
    const { net, grossEl, vatRate } = readInputs(id);
    if (!isNaN(net)) grossEl.value = (net * (1 + vatRate)).toFixed(2);
  }
  function onGrossChanged(id) {
    const { gross, netEl, vatRate } = readInputs(id);
    if (!isNaN(gross)) netEl.value = (gross / (1 + vatRate)).toFixed(2);
  }
  function onVATToggle(id) {
    const { netEl, grossEl, vatRate } = readInputs(id);
    const net = parseFloat(netEl.value);
    const gross = parseFloat(grossEl.value);
    if (!isNaN(net) && (isNaN(gross) || document.activeElement === netEl)) {
      grossEl.value = (net * (1 + vatRate)).toFixed(2);
    } else if (!isNaN(gross)) {
      netEl.value = (gross / (1 + vatRate)).toFixed(2);
    }
  }

  // ----- Save to Cloudflare -----
  async function saveCost(poNumber, id) {
    const row = document.querySelector(`tr[data-po="${poNumber}"]`);
    const saveBtn = row?.querySelector('.save-btn');
    const { net, gross, vatRate } = readInputs(id);

    if (isNaN(net) && isNaN(gross)) { alert('Enter Net or Gross.'); return; }

    const netVal = isNaN(net) ? (gross / (1 + vatRate)) : net;
    const grossVal = isNaN(gross) ? (net * (1 + vatRate)) : gross;

    try {
      if (saveBtn) { saveBtn.disabled = true; saveBtn.textContent = 'Saving‚Ä¶'; }

      const payload = {
        poNumber,
        costNet: Number(netVal.toFixed(2)),
        costGross: Number(grossVal.toFixed(2)),
        vatRate,
        costedBy: engineerName || 'Office',
      };

      const res = await fetch(UPDATE_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload),
        cache: 'no-store'
      });

      const result = await res.json();
      if (!res.ok) throw new Error(result?.error || 'Update failed');

      // Merge back into local state for instant UI update
      const idx = allPOs.findIndex(p => p.poNumber === poNumber);
      if (idx >= 0) {
        allPOs[idx].costNet = payload.costNet;
        allPOs[idx].costGross = payload.costGross;
        allPOs[idx].vatRate = payload.vatRate;
        allPOs[idx].costedBy = payload.costedBy;
        allPOs[idx].costedAt = new Date().toISOString();
      }
      render();
    } catch (e) {
      alert('‚ö†Ô∏è Save failed: ' + e.message);
    } finally {
      if (saveBtn) { saveBtn.disabled = false; saveBtn.textContent = 'üíæ Save'; }
    }
  }

  // ----- Load + events -----
  async function init() {
    const username = sessionStorage.getItem('mostlaneUser') || '';
    engineerName = dotToSpace(username) || 'Office';

    byId('toCostBtn').addEventListener('click', () => {
      currentTab = 'toCost';
      byId('toCostBtn').classList.remove('inactive');
      byId('costedBtn').classList.add('inactive');
      render();
    });
    byId('costedBtn').addEventListener('click', () => {
      currentTab = 'costed';
      byId('costedBtn').classList.remove('inactive');
      byId('toCostBtn').classList.add('inactive');
      render();
    });

    ['supplierFilter','dateRange','searchBox'].forEach(id => {
      byId(id).addEventListener('input', render);
      byId(id).addEventListener('change', render);
    });

    try {
      const res = await fetch(GET_URL, { cache: 'no-store' });
      allPOs = await res.json();
      render();
    } catch (err) {
      byId('tabContent').innerHTML = '‚ö†Ô∏è Failed to load POs: ' + err.message;
    }
  }

  document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
