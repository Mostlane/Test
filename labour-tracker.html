<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>Mostlane ‚Ä¢ Labour Cost Tracker</title>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <link rel="icon" type="image/x-icon" href="favicon.ico">
  <script src="auth.js"></script>

  <!-- PDF generator -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

  <style>
    :root{
      --ml-blue:#003b82;
      --ml-blue2:#0057c2;
      --text:#0f172a;
      --muted:#6b7280;
      --ok:#16a34a;
      --warn:#f97316;
      --bad:#dc2626;
      --panel:rgba(255,255,255,0.60);
      --panel-strong:rgba(255,255,255,0.88);
      --stroke:rgba(15,23,42,0.12);
      --shadow:0 10px 26px rgba(0,0,0,0.16);
      --radius:14px;
    }

    html,body{height:100%; margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; color:var(--text);}
    body{
      background:#e6e8eb url('Mostlane_Embossed.png') no-repeat center center fixed;
      background-size:180%;
      padding:14px;
      box-sizing:border-box;
    }

    .wrap{max-width:1180px; margin:0 auto;}

    /* Top bar */
    .topbar{
      display:flex; gap:10px; align-items:center; justify-content:space-between;
      margin-bottom:12px;
      flex-wrap:wrap;
    }
    .brand{display:flex; align-items:center; gap:10px;}
    .brand img{height:34px; width:auto; border-radius:8px; box-shadow:0 4px 12px rgba(0,0,0,0.12);}
    .title{
      font-weight:900; letter-spacing:0.2px; font-size:18px;
      background:rgba(0,59,130,0.70); color:#fff;
      padding:10px 14px; border-radius:12px; box-shadow:var(--shadow);
      display:inline-block;
    }
    .userline{font-size:13px; color:var(--muted); margin-top:4px}
    .btnrow{display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end;}

    .btn{
      border:0; cursor:pointer; user-select:none;
      background:var(--ml-blue);
      color:#fff; padding:11px 12px; border-radius:12px;
      box-shadow:0 6px 16px rgba(0,0,0,0.16);
      font-weight:900; font-size:13px;
    }
    .btn.secondary{background:rgba(15,23,42,0.75);}
    .btn.light{background:rgba(255,255,255,0.88); color:var(--text); border:1px solid var(--stroke);}
    .btn.danger{background:var(--bad);}
    .btn:disabled{opacity:0.55; cursor:not-allowed; box-shadow:none;}

    /* Layout: desktop 2-col, mobile single */
    .grid{display:grid; gap:12px;}
    @media(min-width:980px){ .grid{grid-template-columns: 1.1fr 0.9fr;} }

    .panel{
      background:var(--panel);
      border:1px solid var(--stroke);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:14px;
      backdrop-filter: blur(5px);
    }
    .panel h2{
      margin:0 0 10px 0;
      font-size:15px; font-weight:1100;
      display:flex; align-items:center; gap:8px;
    }

    .row{display:flex; gap:10px; flex-wrap:wrap;}
    .field{flex:1; min-width:180px;}
    @media(max-width:520px){ .field{min-width:140px;} }

    label{display:block; font-size:12px; font-weight:1000; color:rgba(15,23,42,0.85); margin:0 0 6px 2px;}
    input,select{
      width:100%;
      padding:12px 12px;
      border-radius:12px;
      border:1px solid var(--stroke);
      background:rgba(255,255,255,0.88);
      outline:none;
      font-size:14px;
      box-sizing:border-box;
      min-height:44px;
    }

    .hint{font-size:12px; color:var(--muted); margin-top:6px;}
    .muted{color:var(--muted);}
    .hr{height:1px; background:rgba(15,23,42,0.12); margin:12px 0;}

    .kpis{display:grid; grid-template-columns:repeat(3,1fr); gap:10px; margin-top:10px;}
    @media(max-width:860px){ .kpis{grid-template-columns:1fr;} }
    .kpi{
      background:rgba(255,255,255,0.82);
      border:1px solid var(--stroke);
      border-radius:14px;
      padding:12px;
    }
    .kpi .k{font-size:12px; color:var(--muted); font-weight:1000;}
    .kpi .v{font-size:20px; font-weight:1200; margin-top:2px;}
    .kpi .s{font-size:12px; color:var(--muted); margin-top:4px;}

    .toggle{
      display:flex; align-items:center; gap:10px;
      background:rgba(255,255,255,0.82);
      border:1px solid var(--stroke);
      border-radius:14px;
      padding:10px 12px;
      min-height:44px;
      box-sizing:border-box;
      flex:1;
    }
    .toggle input{width:18px; height:18px; margin:0;}
    .toggle span{font-size:13px; font-weight:1000;}
    .toggle small{display:block; font-size:12px; color:var(--muted); font-weight:800; margin-top:2px;}

    .calcbox{
      background:rgba(255,255,255,0.82);
      border:1px solid var(--stroke);
      border-radius:14px;
      padding:12px;
      display:grid;
      gap:6px;
      margin-top:10px;
    }
    .calcrow{display:flex; justify-content:space-between; gap:12px; font-size:13px;}
    .calcrow b{font-weight:1200;}
    .calcTotal{
      margin-top:4px;
      padding-top:8px;
      border-top:1px solid rgba(15,23,42,0.12);
      font-size:15px;
      font-weight:1200;
    }

    table{width:100%; border-collapse:separate; border-spacing:0; overflow:hidden; border-radius:14px;}
    th,td{padding:10px; border-bottom:1px solid rgba(15,23,42,0.10); font-size:13px; vertical-align:top;}
    th{background:rgba(0,59,130,0.70); color:#fff; font-weight:1200; text-align:left;}
    tr:last-child td{border-bottom:none;}
    .right{text-align:right;}
    .pill{
      display:inline-block; padding:4px 8px; border-radius:999px;
      background:rgba(0,59,130,0.10); border:1px solid rgba(0,59,130,0.18);
      font-size:12px; font-weight:1000;
    }
    .actions{display:flex; gap:6px; justify-content:flex-end; flex-wrap:wrap;}
    .smallbtn{
      padding:9px 10px; border-radius:10px; font-size:12px; font-weight:1100;
      border:1px solid var(--stroke); background:rgba(255,255,255,0.88); cursor:pointer;
      min-height:40px;
    }
    .smallbtn.danger{background:rgba(220,38,38,0.14); border-color:rgba(220,38,38,0.25);}
    .smallbtn.ok{background:rgba(22,163,74,0.14); border-color:rgba(22,163,74,0.25);}
    .smallbtn.warn{background:rgba(245,158,11,0.14); border-color:rgba(245,158,11,0.25);}

    .notice{
      background:rgba(245,158,11,0.12);
      border:1px solid rgba(245,158,11,0.28);
      border-radius:14px;
      padding:10px 12px;
      font-size:12px;
      color:rgba(15,23,42,0.85);
      font-weight:900;
      margin-top:10px;
    }

    /* Mobile sticky action bar */
    .stickybar{
      position:sticky;
      bottom:0;
      margin-top:12px;
      background:rgba(255,255,255,0.70);
      border:1px solid rgba(255,255,255,0.40);
      border-radius:14px;
      padding:10px;
      box-shadow:0 10px 26px rgba(0,0,0,0.18);
      backdrop-filter: blur(6px);
      display:flex;
      gap:10px;
      justify-content:space-between;
      align-items:center;
    }
    @media(min-width:980px){
      .stickybar{position:static; box-shadow:none; background:transparent; border:none; padding:0; margin-top:0;}
    }

    /* Modal */
    .modal-backdrop{
      position:fixed; inset:0; background:rgba(0,0,0,0.45);
      display:none; align-items:center; justify-content:center; padding:14px;
      z-index:9999;
    }
    .modal{
      width:min(960px, 100%);
      background:rgba(255,255,255,0.94);
      border:1px solid rgba(255,255,255,0.5);
      border-radius:16px;
      box-shadow:0 14px 40px rgba(0,0,0,0.35);
      padding:14px;
      max-height:86vh;
      overflow:auto;
    }
    .modal h3{margin:0 0 10px 0; font-size:15px; font-weight:1200;}
    .modal .close{
      float:right; border:0; background:transparent; cursor:pointer;
      font-size:18px; font-weight:1200; color:rgba(15,23,42,0.7);
    }
    .two{display:grid; grid-template-columns:1fr 1fr; gap:10px;}
    @media(max-width:860px){ .two{grid-template-columns:1fr;} }

    /* Report print container styling */
    .report-shell{
      background:#fff;
      border:1px solid rgba(15,23,42,0.12);
      border-radius:14px;
      padding:14px;
    }
    .report-header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      border-bottom:2px solid rgba(0,59,130,0.18);
      padding-bottom:10px;
      margin-bottom:10px;
    }
    .report-header img{
      height:34px; width:auto; border-radius:8px;
    }
    .report-title{
      font-weight:1200;
      font-size:16px;
      margin:0;
    }
    .report-meta{
      font-size:12px;
      color:rgba(15,23,42,0.72);
      font-weight:900;
      margin-top:4px;
    }
    .badge{
      display:inline-block;
      padding:6px 10px;
      border-radius:999px;
      background:rgba(0,59,130,0.10);
      border:1px solid rgba(0,59,130,0.18);
      font-weight:1000;
      font-size:12px;
      white-space:nowrap;
    }

    .report-kpis{
      display:grid;
      grid-template-columns:repeat(4, 1fr);
      gap:10px;
      margin-top:10px;
    }
    @media(max-width:860px){ .report-kpis{grid-template-columns:1fr;} }

    .report-kpi{
      border:1px solid rgba(15,23,42,0.12);
      border-radius:12px;
      padding:10px;
      background:rgba(0,0,0,0.02);
    }
    .report-kpi .k{font-size:12px; color:rgba(15,23,42,0.62); font-weight:1000;}
    .report-kpi .v{font-size:18px; font-weight:1200; margin-top:2px;}

    .scrollbox{
      overflow:auto;
      -webkit-overflow-scrolling:touch;
      max-height:360px;
    }
    @media(max-width:980px){ .scrollbox{max-height:260px;} }

    .mobile-table-wrap{overflow:auto; -webkit-overflow-scrolling:touch;}

    /* Map */
    #mapCanvas{
      width:100%;
      height:320px;
      border-radius:14px;
      border:1px solid rgba(15,23,42,0.12);
      background:#f3f4f6;
    }
    @media(max-width:520px){ #mapCanvas{height:260px;} }

    .chip{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:8px 10px;
      border-radius:999px;
      background:rgba(255,255,255,0.9);
      border:1px solid rgba(15,23,42,0.12);
      font-weight:1000;
      font-size:12px;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div>
        <div class="brand">
          <img src="mostlane-logo.jpg" alt="Mostlane" />
          <div>
            <div class="title">Labour Cost Tracker</div>
            <div class="userline" id="userLine">Signed in</div>
          </div>
        </div>
      </div>

      <div class="btnrow">
        <button class="btn light" id="btnReports">üìÑ Reports</button>
        <button class="btn light" id="btnManage">‚öôÔ∏è Manage</button>
        <button class="btn secondary" id="btnRefresh">Refresh</button>
        <button class="btn" id="btnMainMenu">Main Menu</button>
      </div>
    </div>

    <div class="grid">
      <!-- LEFT: Add Entry -->
      <div class="panel">
        <h2>üßæ Add Labour Entry</h2>

        <div class="row">
          <div class="field">
            <label>Date</label>
            <input type="date" id="entryDate"/>
          </div>
          <div class="field">
            <label>Job</label>
            <select id="entryJob"></select>
            <div class="hint" id="jobMilesHint"></div>
          </div>
        </div>

        <div class="row">
          <div class="field">
            <label>Engineer</label>
            <select id="entryEng"></select>
          </div>

          <div class="field">
            <label>Mode</label>
            <select id="entryMode">
              <option value="hourly">Hourly (hours √ó rate)</option>
              <option value="daily">Daily (days √ó day rate)</option>
            </select>
          </div>
        </div>

        <div class="row" id="hourlyRow">
          <div class="field">
            <label>Hours</label>
            <input type="number" id="entryHours" min="0" step="0.25" placeholder="e.g. 8, 10.5, 12"/>
          </div>

          <div class="field">
            <label>Hourly Rate (¬£)</label>
            <input type="number" id="entryHourRate" min="0" step="0.01" placeholder="Auto-filled (editable)"/>
          </div>
        </div>

        <div class="row" id="dailyRow" style="display:none;">
          <div class="field">
            <label>Days</label>
            <input type="number" id="entryDays" min="0" step="0.25" placeholder="e.g. 1, 0.5"/>
          </div>

          <div class="field">
            <label>Day Rate (¬£)</label>
            <input type="number" id="entryDayRate" min="0" step="0.01" placeholder="Auto-filled (editable)"/>
          </div>
        </div>

        <div class="row">
          <div class="toggle" id="otWrap">
            <input type="checkbox" id="entryOT"/>
            <div>
              <span>Apply Overtime</span>
              <small>1.5√ó after 10 hours</small>
            </div>
          </div>

          <div class="toggle" id="fuelWrap">
            <input type="checkbox" id="entryFuel"/>
            <div>
              <span>Claim Fuel</span>
              <small id="fuelSmall">¬£0.25/mile ‚Ä¢ needs job mileage</small>
            </div>
          </div>
        </div>

        <div class="row">
          <div class="toggle" style="justify-content:space-between; flex:1;">
            <div>
              <span>Total (Labour + Fuel)</span>
              <small>Preview before submit</small>
            </div>
            <div style="font-weight:1200; font-size:15px;" id="previewTotal">¬£0.00</div>
          </div>
        </div>

        <div class="calcbox">
          <div class="calcrow"><span>Labour (Normal Cost)</span><b id="pNormCost">¬£0.00</b></div>
          <div class="calcrow"><span>Labour (OT Cost)</span><b id="pOtCost">¬£0.00</b></div>
          <div class="calcrow"><span>Fuel Cost</span><b id="pFuelCost">¬£0.00</b></div>
          <div class="calcTotal calcrow"><span>Total</span><b id="pTotal">¬£0.00</b></div>
          <div class="hint muted" id="previewBreakdown"></div>
        </div>

        <div class="stickybar">
          <div class="muted" style="font-weight:1000;">Tip: inactive jobs/engineers are hidden from dropdowns.</div>
          <button class="btn" id="btnSubmit" style="min-width:160px;">Submit Entry</button>
        </div>

        <div class="notice">
          Day-rate entries are stored accurately by converting: <b>hours = days √ó 10</b> and <b>rate = dayRate √∑ 10</b>.
          Fuel is calculated from the saved job round-trip mileage √ó ¬£0.25.
        </div>
      </div>

      <!-- RIGHT: Dashboard -->
      <div class="panel">
        <h2>üìä Dashboard</h2>

        <div class="row">
          <div class="field">
            <label>From</label>
            <input type="date" id="fromDate"/>
          </div>
          <div class="field">
            <label>To</label>
            <input type="date" id="toDate"/>
          </div>
        </div>

        <div class="kpis">
          <div class="kpi">
            <div class="k">Total (range)</div>
            <div class="v" id="kpiRange">¬£0.00</div>
            <div class="s" id="kpiRangeS">0 entries</div>
          </div>
          <div class="kpi">
            <div class="k">This Week (Mon‚ÄìSun)</div>
            <div class="v" id="kpiWeek">¬£0.00</div>
            <div class="s" id="kpiWeekS">0 entries</div>
          </div>
          <div class="kpi">
            <div class="k">This Month</div>
            <div class="v" id="kpiMonth">¬£0.00</div>
            <div class="s" id="kpiMonthS">0 entries</div>
          </div>
        </div>

        <div class="hr"></div>

        <div class="muted" style="font-weight:1100; margin-bottom:8px;">Entries (range)</div>
        <div class="scrollbox mobile-table-wrap">
          <table>
            <thead>
              <tr>
                <th style="min-width:92px;">Date</th>
                <th style="min-width:150px;">Job</th>
                <th style="min-width:140px;">Engineer</th>
                <th style="min-width:110px;" class="right">Labour</th>
                <th style="min-width:90px;" class="right">Fuel</th>
                <th style="min-width:120px;" class="right">Total</th>
                <th style="min-width:110px;" class="right">Action</th>
              </tr>
            </thead>
            <tbody id="entriesBody"></tbody>
          </table>
        </div>

        <div class="hr"></div>

        <div class="two">
          <div>
            <div class="muted" style="font-weight:1200; margin-bottom:8px;">By Job (Total)</div>
            <div id="byJob"></div>
          </div>
          <div>
            <div class="muted" style="font-weight:1200; margin-bottom:8px;">By Engineer (Total)</div>
            <div id="byEng"></div>
          </div>
        </div>

        <div class="hr"></div>

        <div class="muted" style="font-weight:1200; margin-bottom:8px;">Engineer √ó Job Matrix (Total)</div>
        <div class="mobile-table-wrap" id="matrix"></div>
      </div>
    </div>
  </div>

  <!-- Manage modal -->
  <div class="modal-backdrop" id="manageBg" role="dialog" aria-modal="true">
    <div class="modal">
      <button class="close" id="manageClose" aria-label="Close">‚úï</button>
      <h3>Manage Jobs & Engineers</h3>

      <div class="two">
        <!-- JOBS -->
        <div class="panel" style="background:rgba(255,255,255,0.74); box-shadow:none;">
          <h2>üèóÔ∏è Jobs</h2>

          <div class="row">
            <div class="field">
              <label>Job Name</label>
              <input type="text" id="jobNameInput" placeholder="e.g. Lamborghini Poole"/>
            </div>
          </div>

          <div class="row">
            <div class="field">
              <label>Round Trip Miles (auto)</label>
              <input type="number" id="jobMilesInput" min="0" step="0.1" placeholder="Use Set Location on map"/>
              <div class="hint">Office origin: <b>PO15 5RQ</b> (round trip).</div>
            </div>
          </div>

          <div class="row" style="align-items:center; justify-content:space-between;">
            <button class="btn light" id="btnSetLocation">üìç Set Location on Map</button>
            <div class="chip" id="locChip">No location set</div>
          </div>

          <div class="row" style="justify-content:flex-end;">
            <button class="btn" id="btnSaveJob">Save Job</button>
          </div>

          <div class="hr"></div>
          <div id="jobsList"></div>
        </div>

        <!-- ENGINEERS -->
        <div class="panel" style="background:rgba(255,255,255,0.74); box-shadow:none;">
          <h2>üßë‚Äçüîß Engineers</h2>

          <div class="row">
            <div class="field">
              <label>Name</label>
              <input type="text" id="engNameInput" placeholder="e.g. Connor"/>
            </div>
            <div class="field">
              <label>Type</label>
              <select id="engTypeInput">
                <option value="core">Core</option>
                <option value="adHoc">Ad-hoc</option>
              </select>
            </div>
          </div>

          <div class="row">
            <div class="field">
              <label>Default Day Rate (¬£)</label>
              <input type="number" id="engDayInput" min="0" step="0.01" placeholder="e.g. 225"/>
            </div>
            <div class="field">
              <label>Default Hourly Rate (¬£)</label>
              <input type="number" id="engHourInput" min="0" step="0.01" placeholder="e.g. 25"/>
            </div>
          </div>

          <div class="row" style="justify-content:flex-end;">
            <button class="btn" id="btnSaveEng">Save Engineer</button>
          </div>

          <div class="hr"></div>
          <div id="engList"></div>
        </div>
      </div>

      <div class="hr"></div>
      <div class="row" style="justify-content:flex-end;">
        <button class="btn secondary" id="manageCloseBottom">Close</button>
      </div>
    </div>
  </div>

  <!-- Map modal -->
  <div class="modal-backdrop" id="mapBg" role="dialog" aria-modal="true">
    <div class="modal">
      <button class="close" id="mapClose" aria-label="Close">‚úï</button>
      <h3>Set Job Location (Round Trip Mileage from PO15 5RQ)</h3>

      <div class="hint" style="margin-bottom:10px;">
        Click on the map to drop/move the pin. We‚Äôll calculate mileage using Google Distance Matrix (driving).
      </div>

      <div id="mapCanvas"></div>

      <div class="row" style="margin-top:10px;">
        <div class="field">
          <label>Selected Round Trip Miles</label>
          <input type="number" id="mapMilesOut" readonly />
        </div>
        <div class="field">
          <label>Selected Lat/Lng</label>
          <input type="text" id="mapLatLngOut" readonly />
        </div>
      </div>

      <div class="row" style="justify-content:flex-end; margin-top:10px;">
        <button class="btn light" id="btnUseLocation">Use This Location</button>
      </div>
    </div>
  </div>

  <!-- Reports modal -->
  <div class="modal-backdrop" id="reportsBg" role="dialog" aria-modal="true">
    <div class="modal">
      <button class="close" id="reportsClose" aria-label="Close">‚úï</button>
      <h3>Reports</h3>

      <div class="panel" style="background:rgba(255,255,255,0.74); box-shadow:none;">
        <div class="row">
          <div class="field">
            <label>Report Type</label>
            <select id="repType">
              <option value="eng_week">Engineer ‚Ä¢ Weekly</option>
              <option value="eng_month">Engineer ‚Ä¢ Monthly</option>
              <option value="eng_job_range">Engineer ‚Ä¢ Specific Job ‚Ä¢ Date Range</option>
              <option value="job_week">Job ‚Ä¢ Weekly</option>
              <option value="job_month">Job ‚Ä¢ Monthly</option>
              <option value="job_range">Job ‚Ä¢ Date Range</option>
              <option value="job_engineers_range">Job ‚Ä¢ Engineers Breakdown ‚Ä¢ Date Range</option>
            </select>
          </div>
          <div class="field" id="repEngWrap">
            <label>Engineer</label>
            <select id="repEngineer"></select>
          </div>
        </div>

        <div class="row">
          <div class="field" id="repJobWrap">
            <label>Job</label>
            <select id="repJob"></select>
          </div>

          <div class="field" id="repWeekWrap">
            <label>Week (any date in week)</label>
            <input type="date" id="repWeekDate"/>
          </div>

          <div class="field" id="repMonthWrap" style="display:none;">
            <label>Month</label>
            <input type="month" id="repMonth"/>
          </div>
        </div>

        <div class="row" id="repRangeWrap" style="display:none;">
          <div class="field">
            <label>From</label>
            <input type="date" id="repFrom"/>
          </div>
          <div class="field">
            <label>To</label>
            <input type="date" id="repTo"/>
          </div>
        </div>

        <div class="row" style="justify-content:flex-end;">
          <button class="btn light" id="btnBuildReport">Build Report</button>
          <button class="btn" id="btnDownloadPDF" disabled>Download PDF</button>
        </div>

        <div class="hint">
          Report totals include <b>Labour + Fuel</b>, and show a split.
        </div>
      </div>

      <div class="hr"></div>

      <div id="reportPreview" class="report-shell">
        <div class="muted">Build a report to preview it here.</div>
      </div>
    </div>
  </div>

<script>
/* =========================
   CONFIG
========================= */
const API_BASE = "https://labourhours.jamie-def.workers.dev";

// Put your Maps key here:
const MAPS_API_KEY = "AIzaSyANo2Q7OehYzHTTgMTxRr5ISamf5IradcM";

// Office origin for mileage:
const OFFICE_POSTCODE = "PO15 5RQ";
const FUEL_RATE = 0.25;

/* =========================
   Maps loader (on-demand)
========================= */
let mapsLoaded = false;
function loadGoogleMapsOnce() {
  return new Promise((resolve, reject) => {
    if (mapsLoaded && window.google && google.maps) return resolve();
    if (!MAPS_API_KEY || MAPS_API_KEY.includes("PASTE_")) {
      return reject(new Error("Google Maps API key not set in MAPS_API_KEY."));
    }
    const existing = document.querySelector('script[data-maps="1"]');
    if (existing) {
      existing.addEventListener("load", () => resolve());
      existing.addEventListener("error", () => reject(new Error("Failed to load Google Maps script.")));
      return;
    }
    const s = document.createElement("script");
    s.dataset.maps = "1";
    s.src = `https://maps.googleapis.com/maps/api/js?key=${encodeURIComponent(MAPS_API_KEY)}&libraries=places`;
    s.onload = () => { mapsLoaded = true; resolve(); };
    s.onerror = () => reject(new Error("Failed to load Google Maps script."));
    document.head.appendChild(s);
  });
}

/* =========================
   Auth headers
========================= */
function getAuthContext(){
  const fromSession = {
    username: sessionStorage.getItem("mostlaneUser") || sessionStorage.getItem("username") || "",
    role: sessionStorage.getItem("mostlaneRole") || sessionStorage.getItem("role") || ""
  };
  const fromLocal = {
    username: localStorage.getItem("mostlaneUser") || localStorage.getItem("username") || "",
    role: localStorage.getItem("mostlaneRole") || localStorage.getItem("role") || ""
  };
  let exposed = {};
  try{
    const u = window.MostlaneAuth?.getUser?.();
    if(u){
      exposed.username = u.username || u.user || "";
      exposed.role = u.role || "";
    }
  }catch(e){}
  const username = exposed.username || fromSession.username || fromLocal.username || "Director";
  const role = exposed.role || fromSession.role || fromLocal.role || "Director";
  return { username, role };
}
function authHeaders(){
  const { username } = getAuthContext();
  return {
    "Content-Type": "application/json",
    "X-User": username,
    "X-Role": "Director"
  };
}

/* =========================
   Helpers
========================= */
function gbp(n){
  const v = Number(n || 0);
  return v.toLocaleString("en-GB",{style:"currency",currency:"GBP"});
}
function escapeHtml(s){
  return String(s ?? "")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}
function todayISO(){
  const d = new Date();
  const yyyy = d.getFullYear();
  const mm = String(d.getMonth()+1).padStart(2,"0");
  const dd = String(d.getDate()).padStart(2,"0");
  return `${yyyy}-${mm}-${dd}`;
}
function parseISODate(s){
  const [y,m,d] = s.split("-").map(Number);
  return new Date(y, m-1, d, 0,0,0,0);
}
function startOfWeekISO(dateISO){
  const d = parseISODate(dateISO);
  const day = (d.getDay() + 6) % 7; // Mon=0..Sun=6
  d.setDate(d.getDate() - day);
  return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")}`;
}
function endOfWeekISO(dateISO){
  const s = parseISODate(startOfWeekISO(dateISO));
  s.setDate(s.getDate() + 6);
  return `${s.getFullYear()}-${String(s.getMonth()+1).padStart(2,"0")}-${String(s.getDate()).padStart(2,"0")}`;
}
function monthKey(dateISO){ return dateISO.slice(0,7); }
function sum(arr, fn){ return arr.reduce((a,x)=>a + (fn?fn(x):Number(x||0)), 0); }

/* =========================
   API
========================= */
async function apiGet(path){
  const res = await fetch(`${API_BASE}${path}`, { headers: authHeaders() });
  if(!res.ok){
    const t = await res.text().catch(()=> "");
    throw new Error(`GET ${path} failed (${res.status}): ${t}`);
  }
  return await res.json();
}
async function apiPost(path, body){
  const res = await fetch(`${API_BASE}${path}`, {
    method:"POST",
    headers: authHeaders(),
    body: JSON.stringify(body)
  });
  if(!res.ok){
    const t = await res.text().catch(()=> "");
    throw new Error(`POST ${path} failed (${res.status}): ${t}`);
  }
  return await res.json();
}
async function apiPatch(path, body){
  const res = await fetch(`${API_BASE}${path}`, {
    method:"PATCH",
    headers: authHeaders(),
    body: JSON.stringify(body)
  });
  if(!res.ok){
    const t = await res.text().catch(()=> "");
    throw new Error(`PATCH ${path} failed (${res.status}): ${t}`);
  }
  return await res.json();
}
async function apiDelete(path){
  const res = await fetch(`${API_BASE}${path}`, {
    method:"DELETE",
    headers: authHeaders()
  });
  if(!res.ok){
    const t = await res.text().catch(()=> "");
    throw new Error(`DELETE ${path} failed (${res.status}): ${t}`);
  }
  return await res.json();
}

/* =========================
   State
========================= */
let jobs = [];
let engineers = [];
let entries = [];

let editingJobId = null;
let editingEngId = null;

let currentJobLocation = null; // { lat, lng }
let currentJobMiles = 0;

let map, marker, distanceSvc;
let mapSelected = { lat: null, lng: null, roundTripMiles: 0 };

/* =========================
   DOM
========================= */
const userLine = document.getElementById("userLine");

const entryDate = document.getElementById("entryDate");
const entryJob = document.getElementById("entryJob");
const entryEng = document.getElementById("entryEng");
const entryMode = document.getElementById("entryMode");

const hourlyRow = document.getElementById("hourlyRow");
const dailyRow = document.getElementById("dailyRow");

const entryHours = document.getElementById("entryHours");
const entryHourRate = document.getElementById("entryHourRate");
const entryDays = document.getElementById("entryDays");
const entryDayRate = document.getElementById("entryDayRate");

const entryOT = document.getElementById("entryOT");
const entryFuel = document.getElementById("entryFuel");
const otWrap = document.getElementById("otWrap");
const fuelSmall = document.getElementById("fuelSmall");
const jobMilesHint = document.getElementById("jobMilesHint");

const previewTotal = document.getElementById("previewTotal");
const pNormCost = document.getElementById("pNormCost");
const pOtCost = document.getElementById("pOtCost");
const pFuelCost = document.getElementById("pFuelCost");
const pTotal = document.getElementById("pTotal");
const previewBreakdown = document.getElementById("previewBreakdown");

const btnSubmit = document.getElementById("btnSubmit");

const fromDate = document.getElementById("fromDate");
const toDate = document.getElementById("toDate");

const kpiRange = document.getElementById("kpiRange");
const kpiRangeS = document.getElementById("kpiRangeS");
const kpiWeek = document.getElementById("kpiWeek");
const kpiWeekS = document.getElementById("kpiWeekS");
const kpiMonth = document.getElementById("kpiMonth");
const kpiMonthS = document.getElementById("kpiMonthS");

const entriesBody = document.getElementById("entriesBody");
const byJob = document.getElementById("byJob");
const byEng = document.getElementById("byEng");
const matrix = document.getElementById("matrix");

const btnMainMenu = document.getElementById("btnMainMenu");
const btnManage = document.getElementById("btnManage");
const btnReports = document.getElementById("btnReports");
const btnRefresh = document.getElementById("btnRefresh");

/* Manage modal */
const manageBg = document.getElementById("manageBg");
const manageClose = document.getElementById("manageClose");
const manageCloseBottom = document.getElementById("manageCloseBottom");

const jobNameInput = document.getElementById("jobNameInput");
const jobMilesInput = document.getElementById("jobMilesInput");
const btnSetLocation = document.getElementById("btnSetLocation");
const btnSaveJob = document.getElementById("btnSaveJob");
const locChip = document.getElementById("locChip");
const jobsList = document.getElementById("jobsList");

const engNameInput = document.getElementById("engNameInput");
const engTypeInput = document.getElementById("engTypeInput");
const engDayInput = document.getElementById("engDayInput");
const engHourInput = document.getElementById("engHourInput");
const btnSaveEng = document.getElementById("btnSaveEng");
const engList = document.getElementById("engList");

/* Map modal */
const mapBg = document.getElementById("mapBg");
const mapClose = document.getElementById("mapClose");
const mapCanvas = document.getElementById("mapCanvas");
const mapMilesOut = document.getElementById("mapMilesOut");
const mapLatLngOut = document.getElementById("mapLatLngOut");
const btnUseLocation = document.getElementById("btnUseLocation");

/* Reports modal */
const reportsBg = document.getElementById("reportsBg");
const reportsClose = document.getElementById("reportsClose");
const repType = document.getElementById("repType");
const repEngineer = document.getElementById("repEngineer");
const repJob = document.getElementById("repJob");
const repWeekDate = document.getElementById("repWeekDate");
const repMonth = document.getElementById("repMonth");
const repFrom = document.getElementById("repFrom");
const repTo = document.getElementById("repTo");

const repEngWrap = document.getElementById("repEngWrap");
const repJobWrap = document.getElementById("repJobWrap");
const repWeekWrap = document.getElementById("repWeekWrap");
const repMonthWrap = document.getElementById("repMonthWrap");
const repRangeWrap = document.getElementById("repRangeWrap");

const btnBuildReport = document.getElementById("btnBuildReport");
const btnDownloadPDF = document.getElementById("btnDownloadPDF");
const reportPreview = document.getElementById("reportPreview");

/* =========================
   UI helpers
========================= */
function fillSelect(sel, items, includeEmpty=false, emptyLabel="(Select)"){
  sel.innerHTML = "";
  if(includeEmpty){
    const o = document.createElement("option");
    o.value = "";
    o.textContent = emptyLabel;
    sel.appendChild(o);
  }
  for(const it of items){
    const o = document.createElement("option");
    o.value = it.id;
    o.textContent = it.name;
    sel.appendChild(o);
  }
}

function jobById(id){ return jobs.find(j=>j.id===id) || null; }
function engById(id){ return engineers.find(e=>e.id===id) || null; }
function jobName(id){ return jobById(id)?.name || "Unknown job"; }
function engName(id){ return engById(id)?.name || "Unknown"; }

function setUserLine(){
  const { username } = getAuthContext();
  userLine.textContent = `Signed in as ${username} (Director)`;
}

/* =========================
   Filtering active items
========================= */
function activeJobs(){ return jobs.filter(j => j.active !== false); }
function activeEngineers(){ return engineers.filter(e => e.active !== false); }

/* =========================
   Fuel / miles in UI
========================= */
function getSelectedJobMiles(){
  const j = jobById(entryJob.value);
  const miles = Number(j?.roundTripMiles || 0);
  return miles;
}
function updateJobMilesHint(){
  const miles = getSelectedJobMiles();
  if(entryJob.value && miles > 0){
    jobMilesHint.innerHTML = `Saved round trip mileage: <b>${miles.toFixed(1)} miles</b>`;
    fuelSmall.textContent = `¬£0.25/mile ‚Ä¢ ${miles.toFixed(1)} miles round trip`;
    entryFuel.disabled = false;
  }else if(entryJob.value){
    jobMilesHint.innerHTML = `<span class="muted">No mileage saved for this job yet (set it in Manage).</span>`;
    fuelSmall.textContent = `¬£0.25/mile ‚Ä¢ needs job mileage`;
    entryFuel.checked = false;
    entryFuel.disabled = true;
  }else{
    jobMilesHint.innerHTML = ``;
    fuelSmall.textContent = `¬£0.25/mile ‚Ä¢ needs job mileage`;
    entryFuel.checked = false;
    entryFuel.disabled = true;
  }
}

/* =========================
   Live calculation (Labour + Fuel)
========================= */
function calcPreview(){
  const mode = entryMode.value;

  let hours = 0;
  let rate = 0;
  let overtimeApplied = false;

  if(mode === "hourly"){
    hours = Number(entryHours.value || 0);
    rate = Number(entryHourRate.value || 0);
    overtimeApplied = !!entryOT.checked;
  }else{
    const days = Number(entryDays.value || 0);
    const dayRate = Number(entryDayRate.value || 0);

    hours = days * 10;
    rate = dayRate > 0 ? (dayRate / 10) : 0;
    overtimeApplied = false;
  }

  let normalHours = hours;
  let overtimeHours = 0;

  if(overtimeApplied && hours > 10){
    normalHours = 10;
    overtimeHours = hours - 10;
  }

  const normalCost = normalHours * rate;
  const overtimeCost = overtimeHours * (rate * 1.5);
  const labourCost = normalCost + overtimeCost;

  const miles = (entryFuel.checked ? getSelectedJobMiles() : 0);
  const fuelCost = miles * FUEL_RATE;

  const total = labourCost + fuelCost;

  pNormCost.textContent = gbp(normalCost);
  pOtCost.textContent = gbp(overtimeCost);
  pFuelCost.textContent = gbp(fuelCost);
  pTotal.textContent = gbp(total);
  previewTotal.textContent = gbp(total);

  previewBreakdown.textContent =
    `Labour: ${gbp(labourCost)} ‚Ä¢ Fuel: ${gbp(fuelCost)} (${miles ? miles.toFixed(1) : "0.0"} miles)`;

  return { hours, rate, overtimeApplied, labourCost, fuelApplied: !!entryFuel.checked, miles, fuelCost, total };
}

function fillRatesFromEngineer(){
  const e = engById(entryEng.value);
  if(!e) return;
  if(entryMode.value === "hourly"){
    if(entryHourRate.value === "") entryHourRate.value = Number(e.defaultHourRate || 0) || "";
  }else{
    if(entryDayRate.value === "") entryDayRate.value = Number(e.defaultDayRate || 0) || "";
  }
}

function applyModeUI(){
  const mode = entryMode.value;
  if(mode === "hourly"){
    hourlyRow.style.display = "";
    dailyRow.style.display = "none";
    entryOT.disabled = false;
    otWrap.style.opacity = "1";
  }else{
    hourlyRow.style.display = "none";
    dailyRow.style.display = "";
    entryOT.checked = false;
    entryOT.disabled = true;
    otWrap.style.opacity = "0.6";
  }
  fillRatesFromEngineer();
  calcPreview();
}

/* =========================
   Load core data
========================= */
async function loadJobsEngineers(){
  jobs = await apiGet("/labour/jobs");
  engineers = await apiGet("/labour/engineers");

  jobs.sort((a,b)=> a.name.localeCompare(b.name));
  engineers.sort((a,b)=> a.name.localeCompare(b.name));

  // Only active show in dropdowns
  fillSelect(entryJob, activeJobs(), true, "(Select job)");
  fillSelect(entryEng, activeEngineers(), true, "(Select engineer)");

  // Reports dropdowns also only active by default
  fillSelect(repJob, activeJobs(), true, "(Select job)");
  fillSelect(repEngineer, activeEngineers(), true, "(Select engineer)");
}

async function loadEntriesRange(from, to){
  const qs = `?from=${encodeURIComponent(from)}&to=${encodeURIComponent(to)}`;
  const list = await apiGet(`/labour/entries${qs}`);
  list.sort((a,b)=> (a.date===b.date ? String(b.createdAt||"").localeCompare(String(a.createdAt||"")) : (a.date<b.date?1:-1)));
  return list;
}

/* =========================
   Dashboard render
========================= */
function renderEntries(){
  entriesBody.innerHTML = "";
  if(entries.length === 0){
    const tr = document.createElement("tr");
    tr.innerHTML = `<td colspan="7" class="muted">No entries in this date range.</td>`;
    entriesBody.appendChild(tr);
    return;
  }
  for(const x of entries){
    const labour = Number(x.labourCost ?? (Number(x.totalCost||0) - Number(x.fuelCost||0))) || 0;
    const fuel = Number(x.fuelCost||0);
    const total = Number(x.totalCost||0);
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td><span class="pill">${escapeHtml(x.date)}</span></td>
      <td style="font-weight:1100;">${escapeHtml(jobName(x.jobId))}</td>
      <td style="font-weight:1100;">${escapeHtml(engName(x.engineerId))}</td>
      <td class="right" style="font-weight:1100;">${gbp(labour)}</td>
      <td class="right">${gbp(fuel)}</td>
      <td class="right" style="font-weight:1200;">${gbp(total)}</td>
      <td class="right"><button class="smallbtn danger" data-del="${x.id}">Delete</button></td>
    `;
    entriesBody.appendChild(tr);
  }
}

function summarise(list){
  const byJob = new Map();
  const byEng = new Map();
  const byEngJob = new Map();

  for(const e of list){
    const j = e.jobId;
    const p = e.engineerId;
    const cost = Number(e.totalCost||0);
    byJob.set(j, (byJob.get(j)||0) + cost);
    byEng.set(p, (byEng.get(p)||0) + cost);
    const key = `${p}__${j}`;
    byEngJob.set(key, (byEngJob.get(key)||0) + cost);
  }
  return { byJob, byEng, byEngJob };
}

function renderMapTable(map, labelLeft, nameFn){
  const rows = Array.from(map.entries()).map(([id,total])=>({id,total})).sort((a,b)=>b.total-a.total);
  if(rows.length === 0) return `<div class="muted">No data.</div>`;
  let html = `<div class="mobile-table-wrap"><table><thead><tr><th>${labelLeft}</th><th class="right">Total</th></tr></thead><tbody>`;
  for(const r of rows){
    html += `<tr><td style="font-weight:1200;">${escapeHtml(nameFn(r.id))}</td><td class="right" style="font-weight:1200;">${gbp(r.total)}</td></tr>`;
  }
  html += `</tbody></table></div>`;
  return html;
}

function renderMatrix(byEngJob){
  if(engineers.length === 0 || jobs.length === 0){
    return `<div class="muted">Add jobs and engineers to see the matrix.</div>`;
  }

  const colTotals = new Map();
  const rowTotals = new Map();
  for(const eng of engineers) rowTotals.set(eng.id, 0);
  for(const job of jobs) colTotals.set(job.id, 0);

  for(const [key,val] of byEngJob.entries()){
    const [p,j] = key.split("__");
    rowTotals.set(p, (rowTotals.get(p)||0) + val);
    colTotals.set(j, (colTotals.get(j)||0) + val);
  }

  let html = `<div class="mobile-table-wrap"><table><thead><tr><th>Engineer</th>`;
  for(const job of jobs){
    html += `<th class="right">${escapeHtml(job.name)}</th>`;
  }
  html += `<th class="right">Total</th></tr></thead><tbody>`;

  for(const eng of engineers){
    html += `<tr><td style="font-weight:1200;">${escapeHtml(eng.name)}${eng.active===false ? " (Inactive)" : ""}</td>`;
    for(const job of jobs){
      const key = `${eng.id}__${job.id}`;
      const val = byEngJob.get(key) || 0;
      html += `<td class="right">${val ? gbp(val) : "‚Äî"}</td>`;
    }
    html += `<td class="right" style="font-weight:1200;">${gbp(rowTotals.get(eng.id)||0)}</td></tr>`;
  }

  html += `</tbody><tfoot><tr><th>Total</th>`;
  let grand = 0;
  for(const job of jobs){
    const t = colTotals.get(job.id)||0;
    grand += t;
    html += `<th class="right">${gbp(t)}</th>`;
  }
  html += `<th class="right">${gbp(grand)}</th></tr></tfoot></table></div>`;
  return html;
}

function renderKPIs(){
  const from = fromDate.value;
  const to = toDate.value;
  const rangeTotal = sum(entries, e=>Number(e.totalCost||0));
  kpiRange.textContent = gbp(rangeTotal);kpiRangeS.textContent = `${entries.length} entries (${from} to ${to})`;

  const t = todayISO();
  const ws = startOfWeekISO(t);
  const we = endOfWeekISO(t);
  const mk = monthKey(t);

  const week = entries.filter(e => e.date >= ws && e.date <= we);
  const month = entries.filter(e => monthKey(e.date) === mk);

  kpiWeek.textContent = gbp(sum(week, e=>Number(e.totalCost||0)));
  kpiWeekS.textContent = `${week.length} entries`;

  kpiMonth.textContent = gbp(sum(month, e=>Number(e.totalCost||0)));
  kpiMonthS.textContent = `${month.length} entries`;
}

/* =========================
   Manage modal logic (Jobs)
========================= */
function openManage(){ manageBg.style.display="flex"; renderManageLists(); }
function closeManage(){ manageBg.style.display="none"; }

function resetJobForm(){
  editingJobId = null;
  currentJobLocation = null;
  currentJobMiles = 0;
  jobNameInput.value = "";
  jobMilesInput.value = "";
  locChip.textContent = "No location set";
  btnSaveJob.textContent = "Save Job";
}

function resetEngForm(){
  editingEngId = null;
  engNameInput.value = "";
  engTypeInput.value = "core";
  engDayInput.value = "";
  engHourInput.value = "";
  btnSaveEng.textContent = "Save Engineer";
}

function renderManageLists(){
  // Jobs list (active + inactive)
  jobsList.innerHTML = "";
  if(jobs.length === 0){
    jobsList.innerHTML = `<div class="muted">No jobs yet.</div>`;
  }else{
    for(const j of jobs){
      const row = document.createElement("div");
      row.className="row";
      row.style.alignItems="center";
      row.style.justifyContent="space-between";
      row.style.marginBottom="8px";

      const miles = Number(j.roundTripMiles||0);
      const loc = j.location?.lat != null ? `${Number(j.location.lat).toFixed(5)}, ${Number(j.location.lng).toFixed(5)}` : "‚Äî";

      row.innerHTML = `
        <div>
          <div style="font-weight:1200;">
            ${escapeHtml(j.name)}
            <span class="pill" style="margin-left:6px;">${j.active===false ? "Inactive" : "Active"}</span>
          </div>
          <div class="muted" style="font-size:12px;">Miles (RT): ${miles ? miles.toFixed(1) : "‚Äî"} ‚Ä¢ Location: ${escapeHtml(loc)}</div>
        </div>
        <div class="actions">
          <button class="smallbtn warn" data-editjob="${j.id}">Edit</button>
          <button class="smallbtn ${j.active===false ? "ok" : "warn"}" data-togglejob="${j.id}">
            ${j.active===false ? "Set Active" : "Set Inactive"}
          </button>
          <button class="smallbtn danger" data-deljob="${j.id}">Delete</button>
        </div>
      `;
      jobsList.appendChild(row);
    }
  }

  // Engineers list
  engList.innerHTML = "";
  if(engineers.length === 0){
    engList.innerHTML = `<div class="muted">No engineers yet.</div>`;
  }else{
    for(const e of engineers){
      const row = document.createElement("div");
      row.className="row";
      row.style.alignItems="center";
      row.style.justifyContent="space-between";
      row.style.marginBottom="8px";
      row.innerHTML = `
        <div>
          <div style="font-weight:1200;">
            ${escapeHtml(e.name)}
            <span class="pill" style="margin-left:6px;">${escapeHtml(e.type||"core")}</span>
            <span class="pill" style="margin-left:6px;">${e.active===false ? "Inactive" : "Active"}</span>
          </div>
          <div class="muted" style="font-size:12px;">Day: ${gbp(e.defaultDayRate)} ‚Ä¢ Hour: ${gbp(e.defaultHourRate)}</div>
        </div>
        <div class="actions">
          <button class="smallbtn warn" data-editeng="${e.id}">Edit</button>
          <button class="smallbtn ${e.active===false ? "ok" : "warn"}" data-toggleeng="${e.id}">
            ${e.active===false ? "Set Active" : "Set Inactive"}
          </button>
          <button class="smallbtn danger" data-deleng="${e.id}">Delete</button>
        </div>
      `;
      engList.appendChild(row);
    }
  }
}

async function saveJob(){
  const name = (jobNameInput.value||"").trim();
  const miles = Number(jobMilesInput.value||0);

  if(!name) return alert("Enter a job name.");

  btnSaveJob.disabled = true;
  try{
    if(!editingJobId){
      await apiPost("/labour/jobs", {
        name,
        roundTripMiles: miles,
        location: currentJobLocation
      });
    }else{
      await apiPatch("/labour/jobs", {
        id: editingJobId,
        name,
        roundTripMiles: miles,
        location: currentJobLocation
      });
    }

    resetJobForm();
    await refreshAll();
  }catch(err){
    alert(String(err.message || err));
  }finally{
    btnSaveJob.disabled = false;
  }
}

async function toggleJobActive(id){
  const j = jobById(id);
  if(!j) return;
  await apiPatch("/labour/jobs", { id, active: !(j.active !== false) ? true : false });
  await refreshAll();
}

async function editJob(id){
  const j = jobById(id);
  if(!j) return;
  editingJobId = j.id;
  jobNameInput.value = j.name || "";
  jobMilesInput.value = Number(j.roundTripMiles||0) || "";
  currentJobLocation = j.location || null;
  currentJobMiles = Number(j.roundTripMiles||0) || 0;
  locChip.textContent = currentJobLocation ? `Location set ‚Ä¢ ${currentJobMiles.toFixed(1)}mi RT` : "No location set";
  btnSaveJob.textContent = "Save Changes";
}

async function delJob(id){
  if(!confirm("Delete this job? This cannot be undone.")) return;
  await apiDelete(`/labour/jobs?id=${encodeURIComponent(id)}`);
  if(editingJobId === id) resetJobForm();
  await refreshAll();
}

/* =========================
   Manage modal logic (Engineers)
========================= */
async function saveEngineer(){
  const name = (engNameInput.value||"").trim();
  const type = engTypeInput.value || "core";
  const day = Number(engDayInput.value||0);
  const hour = Number(engHourInput.value||0);

  if(!name) return alert("Enter engineer name.");
  if(!(day>0) && !(hour>0)) return alert("Enter a day rate and/or hourly rate.");

  btnSaveEng.disabled = true;
  try{
    if(!editingEngId){
      await apiPost("/labour/engineers", { name, type, defaultDayRate: day, defaultHourRate: hour });
    }else{
      await apiPatch("/labour/engineers", { id: editingEngId, name, defaultDayRate: day, defaultHourRate: hour });
    }
    resetEngForm();
    await refreshAll();
  }catch(err){
    alert(String(err.message || err));
  }finally{
    btnSaveEng.disabled = false;
  }
}

async function toggleEngActive(id){
  const e = engById(id);
  if(!e) return;
  await apiPatch("/labour/engineers", { id, active: !(e.active !== false) ? true : false });
  await refreshAll();
}

async function editEng(id){
  const e = engById(id);
  if(!e) return;
  editingEngId = e.id;
  engNameInput.value = e.name || "";
  engTypeInput.value = e.type || "core";
  engDayInput.value = Number(e.defaultDayRate||0) || "";
  engHourInput.value = Number(e.defaultHourRate||0) || "";
  btnSaveEng.textContent = "Save Changes";
}

async function delEng(id){
  if(!confirm("Delete this engineer? Existing entries will show as Unknown.")) return;
  await apiDelete(`/labour/engineers?id=${encodeURIComponent(id)}`);
  if(editingEngId === id) resetEngForm();
  await refreshAll();
}

/* =========================
   Map modal logic
========================= */
function openMap(){
  mapBg.style.display = "flex";
}
function closeMap(){
  mapBg.style.display = "none";
}

async function initMapUI(){
  await loadGoogleMapsOnce();

  distanceSvc = new google.maps.DistanceMatrixService();

  const defaultCenter = { lat: 50.853, lng: -1.205 }; // near Fareham
  const start = currentJobLocation || defaultCenter;

  map = new google.maps.Map(mapCanvas, {
    center: start,
    zoom: currentJobLocation ? 13 : 11,
    mapTypeControl: false,
    streetViewControl: false,
    fullscreenControl: false
  });

  marker = new google.maps.Marker({
    position: start,
    map: map,
    draggable: true
  });

  const setPos = async (latLng) => {
    marker.setPosition(latLng);
    map.panTo(latLng);
    const lat = latLng.lat();
    const lng = latLng.lng();
    mapLatLngOut.value = `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
    const miles = await calcRoundTripMiles(lat, lng).catch(()=>0);
    mapMilesOut.value = miles ? miles.toFixed(1) : "";
    mapSelected = { lat, lng, roundTripMiles: miles || 0 };
  };

  // Click map sets marker
  map.addListener("click", (e) => setPos(e.latLng));
  marker.addListener("dragend", (e) => setPos(e.latLng));

  // Set initial
  await setPos(marker.getPosition());
}

function calcRoundTripMiles(lat, lng){
  return new Promise((resolve, reject) => {
    distanceSvc.getDistanceMatrix({
      origins: [OFFICE_POSTCODE],
      destinations: [{ lat, lng }],
      travelMode: google.maps.TravelMode.DRIVING,
      unitSystem: google.maps.UnitSystem.IMPERIAL
    }, (res, status) => {
      if(status !== "OK") return reject(new Error("DistanceMatrix failed: " + status));
      const el = res?.rows?.[0]?.elements?.[0];
      if(!el || el.status !== "OK") return resolve(0);
      const meters = el.distance.value;
      const oneWayMiles = meters / 1609.344;
      resolve(oneWayMiles * 2);
    });
  });
}

function applySelectedLocation(){
  if(mapSelected.lat == null) return;
  currentJobLocation = { lat: mapSelected.lat, lng: mapSelected.lng };
  currentJobMiles = Number(mapSelected.roundTripMiles || 0);
  jobMilesInput.value = currentJobMiles ? currentJobMiles.toFixed(1) : "";
  locChip.textContent = currentJobLocation ? `Location set ‚Ä¢ ${currentJobMiles.toFixed(1)}mi RT` : "No location set";
  closeMap();
}

/* =========================
   Submit entry
========================= */
async function submitEntry(){
  const date = entryDate.value;
  const jobId = entryJob.value;
  const engineerId = entryEng.value;

  if(!date) return alert("Pick a date.");
  if(!jobId) return alert("Select a job.");
  if(!engineerId) return alert("Select an engineer.");

  const mode = entryMode.value;
  const preview = calcPreview();

  if(mode === "hourly"){
    const hrs = Number(entryHours.value || 0);
    const rate = Number(entryHourRate.value || 0);
    if(!(hrs > 0)) return alert("Enter hours.");
    if(!(rate > 0)) return alert("Enter hourly rate.");
  }else{
    const days = Number(entryDays.value || 0);
    const dayRate = Number(entryDayRate.value || 0);
    if(!(days > 0)) return alert("Enter days.");
    if(!(dayRate > 0)) return alert("Enter day rate.");
  }

  // Fuel requires mileage
  const miles = getSelectedJobMiles();
  if(entryFuel.checked && !(miles > 0)){
    return alert("This job has no saved mileage yet. Set it in Manage ‚Üí Set Location on Map.");
  }

  btnSubmit.disabled = true;
  try{
    await apiPost("/labour/entries", {
      date,
      jobId,
      engineerId,
      hours: preview.hours,
      rateUsed: preview.rate,
      overtimeApplied: preview.overtimeApplied,
      fuelApplied: preview.fuelApplied,
      jobRoundTripMiles: miles
    });

    entryHours.value = "";
    entryDays.value = "";
    entryFuel.checked = false;
    calcPreview();

    await refreshAll();
  }catch(err){
    alert(String(err.message || err));
  }finally{
    btnSubmit.disabled = false;
  }
}

/* =========================
   Refresh all
========================= */
async function refreshAll(){
  btnRefresh.disabled = true;
  btnSubmit.disabled = true;
  try{
    await loadJobsEngineers();

    if(!entryDate.value) entryDate.value = todayISO();

    fillRatesFromEngineer();
    applyModeUI();
    updateJobMilesHint();

    const from = fromDate.value;
    const to = toDate.value;
    entries = await loadEntriesRange(from, to);

    renderEntries();
    renderKPIs();

    const sums = summarise(entries);
    byJob.innerHTML = renderMapTable(sums.byJob, "Job", jobName);
    byEng.innerHTML = renderMapTable(sums.byEng, "Engineer", engName);
    matrix.innerHTML = renderMatrix(sums.byEngJob);

    renderManageLists();
  }catch(err){
    alert(String(err.message || err));
  }finally{
    btnRefresh.disabled = false;
    btnSubmit.disabled = false;
  }
}

/* =========================
   Delete entry
========================= */
async function deleteEntry(id){
  if(!confirm("Delete this labour entry?")) return;
  await apiDelete(`/labour/entries?id=${encodeURIComponent(id)}`);
  await refreshAll();
}

/* =========================
   Reports
========================= */
function openReports(){
  reportsBg.style.display="flex";
  btnDownloadPDF.disabled = true;
  repWeekDate.value = todayISO();
  repMonth.value = monthKey(todayISO());
  repFrom.value = fromDate.value || startOfWeekISO(todayISO());
  repTo.value = toDate.value || endOfWeekISO(todayISO());
  updateReportUI();
}
function closeReports(){ reportsBg.style.display="none"; }

function updateReportUI(){
  const t = repType.value;
  const needsEng = t.startsWith("eng_");
  const needsWeek = t.endsWith("_week");
  const needsMonth = t.endsWith("_month");
  const needsRange = t.includes("range");

  repEngWrap.style.display = needsEng ? "" : "none";
  repJobWrap.style.display = (t === "eng_job_range" || t.startsWith("job_")) ? "" : "none";
  repWeekWrap.style.display = needsWeek ? "" : "none";
  repMonthWrap.style.display = needsMonth ? "" : "none";
  repRangeWrap.style.display = needsRange ? "" : "none";
}

function computeReportRange(){
  const t = repType.value;
  if(t.endsWith("_week")){
    const anyDate = repWeekDate.value || todayISO();
    return { from: startOfWeekISO(anyDate), to: endOfWeekISO(anyDate) };
  }
  if(t.endsWith("_month")){
    const ym = repMonth.value || monthKey(todayISO());
    const [y,m] = ym.split("-").map(Number);
    const first = `${y}-${String(m).padStart(2,"0")}-01`;
    const d = new Date(y, m, 0);
    const last = `${y}-${String(m).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")}`;
    return { from: first, to: last };
  }
  return {
    from: repFrom.value || startOfWeekISO(todayISO()),
    to: repTo.value || endOfWeekISO(todayISO())
  };
}

function breakdownTotals(list){
  const labour = sum(list, e=>Number(e.labourCost ?? (Number(e.totalCost||0)-Number(e.fuelCost||0)) || 0));
  const fuel = sum(list, e=>Number(e.fuelCost||0));
  const total = sum(list, e=>Number(e.totalCost||0));
  const hours = sum(list, e=>Number(e.hours||0));
  const normalHours = sum(list, e=>Number(e.normalHours||0));
  const overtimeHours = sum(list, e=>Number(e.overtimeHours||0));
  return { labour, fuel, total, hours, normalHours, overtimeHours };
}

function groupByCost(list, keyFn){
  const map = new Map();
  for(const x of list){
    const k = keyFn(x);
    map.set(k, (map.get(k)||0) + Number(x.totalCost||0));
  }
  return map;
}

function renderSimpleTable(map, leftHeader, nameFn){
  const rows = Array.from(map.entries()).map(([k,v])=>({k,v})).sort((a,b)=>b.v-a.v);
  if(rows.length===0) return `<div class="muted">No data.</div>`;
  let html = `<table><thead><tr><th>${escapeHtml(leftHeader)}</th><th class="right">Total</th></tr></thead><tbody>`;
  for(const r of rows){
    html += `<tr><td style="font-weight:1100;">${escapeHtml(nameFn ? nameFn(r.k) : r.k)}</td><td class="right" style="font-weight:1100;">${gbp(r.v)}</td></tr>`;
  }
  html += `</tbody></table>`;
  return html;
}

function reportFilename(title, from, to){
  const safe = title.replace(/[^\w\s-]/g,"").replace(/\s+/g," ").trim().replaceAll(" ","_");
  return `Mostlane_${safe}_${from}_to_${to}.pdf`;
}

async function buildReport(){
  btnBuildReport.disabled = true;
  btnDownloadPDF.disabled = true;
  reportPreview.innerHTML = `<div class="muted">Building report‚Ä¶</div>`;

  try{
    const type = repType.value;
    const { from, to } = computeReportRange();
    const all = await loadEntriesRange(from, to);

    const engId = repEngineer.value;
    const jobId = repJob.value;

    let filtered = all.slice();

    if(type.startsWith("eng_")){
      if(!engId) throw new Error("Select an engineer.");
      filtered = filtered.filter(e => e.engineerId === engId);
    }
    if(type.startsWith("job_")){
      if(!jobId) throw new Error("Select a job.");
      filtered = filtered.filter(e => e.jobId === jobId);
    }
    if(type === "eng_job_range"){
      if(!engId) throw new Error("Select an engineer.");
      if(!jobId) throw new Error("Select a job.");
      filtered = filtered.filter(e => e.engineerId === engId && e.jobId === jobId);
    }

    const totals = breakdownTotals(filtered);

    let title = "Labour Report";
    if(type === "eng_week" || type === "eng_month") title = `Engineer Labour Report ‚Äì ${engName(engId)}`;
    if(type === "eng_job_range") title = `Engineer √ó Job Labour Report ‚Äì ${engName(engId)} ‚Äì ${jobName(jobId)}`;
    if(type === "job_week" || type === "job_month" || type === "job_range") title = `Job Labour Report ‚Äì ${jobName(jobId)}`;
    if(type === "job_engineers_range") title = `Job Engineers Breakdown ‚Äì ${jobName(jobId)}`;

    const byJobMap = groupByCost(filtered, e=>e.jobId);
    const byEngMap = groupByCost(filtered, e=>e.engineerId);

    const metaLine = `
      <div class="report-meta">
        Date range: <b>${escapeHtml(from)}</b> ‚Üí <b>${escapeHtml(to)}</b> ‚Ä¢ Entries: <b>${filtered.length}</b>
      </div>
    `;

    const headerBadges = [];
    if(type.startsWith("eng_")) headerBadges.push(`<span class="badge">Engineer: ${escapeHtml(engName(engId))}</span>`);
    if(type.startsWith("job_") || type === "eng_job_range") headerBadges.push(`<span class="badge">Job: ${escapeHtml(jobName(jobId))}</span>`);
    headerBadges.push(`<span class="badge">Generated: ${escapeHtml(new Date().toLocaleString("en-GB"))}</span>`);

    const logoUrl = (location.origin + location.pathname.replace(/\/[^\/]*$/, "") + "/mostlane-logo.jpg");

    const html = `
      <div id="pdfRoot">
        <div class="report-header">
          <div style="display:flex; align-items:center; gap:10px;">
            <img src="${escapeHtml(logoUrl)}" crossOrigin="anonymous" alt="Mostlane"/>
            <div>
              <div class="report-title">${escapeHtml(title)}</div>
              ${metaLine}
            </div>
          </div>
          <div style="display:flex; flex-direction:column; gap:6px; align-items:flex-end;">
            ${headerBadges.join("")}
          </div>
        </div>

        <div class="report-kpis">
          <div class="report-kpi"><div class="k">Total</div><div class="v">${gbp(totals.total)}</div></div>
          <div class="report-kpi"><div class="k">Labour</div><div class="v">${gbp(totals.labour)}</div></div>
          <div class="report-kpi"><div class="k">Fuel</div><div class="v">${gbp(totals.fuel)}</div></div>
          <div class="report-kpi"><div class="k">Hours (OT)</div><div class="v">${totals.hours.toFixed(2)} <span style="font-size:12px; color:rgba(15,23,42,0.65); font-weight:1000;">(${totals.overtimeHours.toFixed(2)} OT)</span></div></div>
        </div>

        <div style="display:grid; gap:10px; margin-top:12px;">
          <div class="two">
            <div>
              <div style="font-weight:1200; margin:8px 0;">Cost Breakdown by Job (Total)</div>
              ${renderSimpleTable(byJobMap, "Job", jobName)}
            </div>
            <div>
              <div style="font-weight:1200; margin:8px 0;">Cost Breakdown by Engineer (Total)</div>
              ${renderSimpleTable(byEngMap, "Engineer", engName)}
            </div>
          </div>

          <div style="margin-top:8px;">
            <div style="font-weight:1200; margin-bottom:8px;">Entries</div>
            <table>
              <thead>
                <tr>
                  <th style="min-width:90px;">Date</th>
                  <th>Job</th>
                  <th>Engineer</th>
                  <th class="right">Labour</th>
                  <th class="right">Fuel</th>
                  <th class="right">Total</th>
                </tr>
              </thead>
              <tbody>
                ${filtered.sort((a,b)=> a.date===b.date ? 0 : (a.date<b.date?-1:1)).map(e=>{
                  const labour = Number(e.labourCost ?? (Number(e.totalCost||0)-Number(e.fuelCost||0)) || 0);
                  const fuel = Number(e.fuelCost||0);
                  return `
                    <tr>
                      <td><span class="pill">${escapeHtml(e.date)}</span></td>
                      <td style="font-weight:1100;">${escapeHtml(jobName(e.jobId))}</td>
                      <td style="font-weight:1100;">${escapeHtml(engName(e.engineerId))}</td>
                      <td class="right">${gbp(labour)}</td>
                      <td class="right">${gbp(fuel)}</td>
                      <td class="right" style="font-weight:1200;">${gbp(Number(e.totalCost||0))}</td>
                    </tr>
                  `;
                }).join("")}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    `;

    reportPreview.innerHTML = html;

    const filename = reportFilename(title, from, to);
    btnDownloadPDF.onclick = () => downloadReportPDF(filename);
    btnDownloadPDF.disabled = false;

  }catch(err){
    reportPreview.innerHTML = `<div class="muted">${escapeHtml(err.message || String(err))}</div>`;
  }finally{
    btnBuildReport.disabled = false;
  }
}

async function downloadReportPDF(filename){
  const root = document.getElementById("pdfRoot");
  if(!root) return;

  btnDownloadPDF.disabled = true;
  btnDownloadPDF.textContent = "Generating‚Ä¶";

  try{
    const opt = {
      margin:       10,
      filename:     filename,
      image:        { type: 'jpeg', quality: 0.95 },
      html2canvas:  { scale: 2, useCORS: true, allowTaint: true, backgroundColor: "#ffffff" },
      jsPDF:        { unit: 'mm', format: 'a4', orientation: 'portrait' }
    };
    await html2pdf().set(opt).from(root).save();
  }catch(err){
    alert(String(err.message || err));
  }finally{
    btnDownloadPDF.textContent = "Download PDF";
    btnDownloadPDF.disabled = false;
  }
}

/* =========================
   Boot
========================= */
(function init(){
  setUserLine();

  entryDate.value = todayISO();

  // default dashboard range = this week
  const t = todayISO();
  fromDate.value = startOfWeekISO(t);
  toDate.value = endOfWeekISO(t);

  // events
  btnMainMenu.addEventListener("click", ()=> window.location.href = "main.html");
  btnManage.addEventListener("click", ()=>{ openManage(); });
  btnReports.addEventListener("click", openReports);
  btnRefresh.addEventListener("click", refreshAll);

  manageClose.addEventListener("click", closeManage);
  manageCloseBottom.addEventListener("click", closeManage);
  manageBg.addEventListener("click", (e)=>{ if(e.target===manageBg) closeManage(); });

  btnSaveJob.addEventListener("click", saveJob);
  btnSaveEng.addEventListener("click", saveEngineer);

  entryMode.addEventListener("change", ()=>{
    entryHours.value=""; entryDays.value="";
    entryHourRate.value=""; entryDayRate.value="";
    applyModeUI();
  });
  entryEng.addEventListener("change", ()=>{
    if(entryMode.value==="hourly") entryHourRate.value="";
    else entryDayRate.value="";
    fillRatesFromEngineer();
    calcPreview();
  });

  entryJob.addEventListener("change", ()=>{
    updateJobMilesHint();
    calcPreview();
  });

  entryHours.addEventListener("input", calcPreview);
  entryHourRate.addEventListener("input", calcPreview);
  entryDays.addEventListener("input", calcPreview);
  entryDayRate.addEventListener("input", calcPreview);
  entryOT.addEventListener("change", calcPreview);
  entryFuel.addEventListener("change", calcPreview);

  btnSubmit.addEventListener("click", submitEntry);

  fromDate.addEventListener("change", refreshAll);
  toDate.addEventListener("change", refreshAll);

  entriesBody.addEventListener("click", async (e)=>{
    const b = e.target.closest("button");
    if(!b) return;
    const id = b.dataset.del;
    if(id){ try{ await deleteEntry(id);}catch(err){alert(err.message||err);} }
  });

  // Manage list buttons (event delegation)
  manageBg.addEventListener("click", async (e)=>{
    const b = e.target.closest("button");
    if(!b) return;

    if(b.dataset.editjob){ await editJob(b.dataset.editjob); }
    if(b.dataset.togglejob){ await toggleJobActive(b.dataset.togglejob); }
    if(b.dataset.deljob){ await delJob(b.dataset.deljob); }

    if(b.dataset.editeng){ await editEng(b.dataset.editeng); }
    if(b.dataset.toggleeng){ await toggleEngActive(b.dataset.toggleeng); }
    if(b.dataset.deleng){ await delEng(b.dataset.deleng); }
  });

  // Map modal
  mapClose.addEventListener("click", closeMap);
  mapBg.addEventListener("click", (e)=>{ if(e.target===mapBg) closeMap(); });

  btnSetLocation.addEventListener("click", async ()=>{
    try{
      openMap();
      await initMapUI();
    }catch(err){
      alert(String(err.message||err));
      closeMap();
    }
  });

  btnUseLocation.addEventListener("click", applySelectedLocation);

  // Reports modal
  reportsClose.addEventListener("click", closeReports);
  reportsBg.addEventListener("click", (e)=>{ if(e.target===reportsBg) closeReports(); });

  repType.addEventListener("change", updateReportUI);
  btnBuildReport.addEventListener("click", buildReport);

  // Defaults
  repWeekDate.value = todayISO();
  repMonth.value = monthKey(todayISO());
  repFrom.value = fromDate.value;
  repTo.value = toDate.value;

  // Initial load
  refreshAll();
  resetJobForm();
  resetEngForm();
})();
</script>
</body>
</html>
