<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Engineer Timesheets – Mostlane</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
  *,*::before,*::after{box-sizing:border-box}
  :root{
    --ml-blue:#003366;--ml-accent:#1a73e8;--ml-ink:#1f2937;--ml-bg:#e6e8eb;
    --card:#ffffffee;--muted:#64748b;--ok:#0c7d27;--bad:#b00020;--border:#e7edf5;
    --blue-1:#0c3a6b; --blue-2:#19579b; --blue-3:#1f6fce;
  }
  html,body{height:100%}
  body{
    margin:0;font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif;color:var(--ml-ink);
    background:var(--ml-bg) url('Mostlane_Embossed.png') no-repeat center center fixed;background-size:180% auto;
  }
  .shell{max-width:1200px;margin:34px auto;padding:0 16px}
  .panel{
    background:var(--card);border:1px solid var(--border);border-radius:14px;
    box-shadow:0 12px 28px rgba(0,0,0,.12);overflow:hidden;
  }
  header{
    display:flex;align-items:center;gap:12px;justify-content:space-between;flex-wrap:wrap;
    padding:14px 18px;border-bottom:1px solid var(--border);background:linear-gradient(90deg,#fff,#f7f9fc);
  }
  header .left{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
  h1{font-size:18px;color:var(--ml-blue);margin:0 10px 0 0}
  .ctrl{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  select,input,button{
    font-size:14px;border:1px solid #cfd7e3;border-radius:10px;padding:8px 10px;background:#fff
  }
  input[type="date"]{height:36px}
  .btn{cursor:pointer;font-weight:600}
  .btn-ghost{background:#eef2f9;border-color:#d7e1ee}
  .btn-primary{background:var(--ml-accent);color:#fff;border:0}
  .badge{font-size:12px;border:1px solid var(--border);padding:4px 8px;border-radius:999px;background:#fff}
  main{padding:16px 18px}
  /* ===== Blue Stat Cards ===== */
  .statsRow{
    display:grid;grid-template-columns:repeat(8,1fr);gap:10px;margin-bottom:14px
  }
  @media (max-width:1100px){.statsRow{grid-template-columns:repeat(4,1fr)}}
  @media (max-width:650px){.statsRow{grid-template-columns:repeat(2,1fr)}}
  .stat{
    position:relative;border-radius:12px;padding:12px 12px 10px 12px;color:#fff;
    background:linear-gradient(145deg,var(--blue-1),var(--blue-3));
    border:1px solid rgba(255,255,255,.18);
    box-shadow:0 10px 20px rgba(0,0,0,.18);
  }
  .stat .label{font-size:12px;opacity:.95;letter-spacing:.02em}
  .stat .value{font-size:20px;font-weight:800;margin-top:4px}
  .stat .sub{font-size:11px;opacity:.9;margin-top:2px}
  .stat:hover{filter:brightness(1.03)}
  .stat .i{position:absolute;top:8px;right:8px;cursor:help;font-weight:700;background:rgba(255,255,255,.18);
    border-radius:50%;width:20px;height:20px;display:flex;align-items:center;justify-content:center}
  .tooltip{position:relative;display:inline-block}
  .tooltip .tip{
    visibility:hidden;opacity:0;transition:opacity .15s ease;
    position:absolute;z-index:10;right:0;top:26px;min-width:220px;max-width:360px;
    background:#0b1f39;color:#fff;font-size:12px;padding:8px 10px;border-radius:8px;box-shadow:0 10px 16px rgba(0,0,0,.25)
  }
  .tooltip:hover .tip{visibility:visible;opacity:1}

  .toolbar{display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap;margin:8px 0 12px}
  .muted{color:var(--muted)}
  .table-wrap{overflow:auto;border:1px solid var(--border);border-radius:10px}
  table{width:100%;border-collapse:separate;border-spacing:0;min-width:980px}
  thead th{
    position:sticky;top:0;background:#f7fbff;border-bottom:1px solid var(--border);
    font-size:12px;text-transform:uppercase;letter-spacing:.02em;color:#324055;padding:10px 8px;text-align:left
  }
  tbody td{padding:10px 8px;border-bottom:1px solid #f0f3f8;vertical-align:top;font-size:14px}
  tfoot td{padding:12px 8px;font-weight:700;background:#fafcff;border-top:1px solid var(--border)}
  .center{text-align:center}
  .right{text-align:right}
  .flag{font-weight:700}
  .flag.enh{color:#0c7d27}
  .flag.no{color:#b00020}
  .note-dot{
    display:inline-flex;align-items:center;justify-content:center;width:20px;height:20px;border-radius:50%;
    border:1px solid #d7e1ee;background:#fff;cursor:pointer
  }
  .note-dot.has{background:#fff2c2;border-color:#ffd18b}
  .empty{padding:16px;border:1px dashed #d8dee9;border-radius:10px;background:#fff}
  .footer{padding:12px 18px;border-top:1px solid var(--border);display:flex;justify-content:space-between;align-items:center;gap:8px;background:#fcfdff}
  a.link{color:var(--ml-accent);text-decoration:none}

  /* Notes list */
  .notes-panel{margin-top:14px;border:1px solid var(--border);border-radius:12px;background:#fff}
  .notes-head{display:flex;justify-content:space-between;align-items:center;padding:10px 12px;border-bottom:1px solid var(--border);background:#f7fbff}
  .notes-body{padding:12px}
  .note-item{padding:10px 12px;border:1px solid #eef2f7;border-radius:10px;margin-bottom:8px;background:#fff}
  .note-meta{display:flex;gap:10px;align-items:center;font-size:12px;color:#516075}
  .badge-vis{font-size:11px;border-radius:999px;padding:2px 8px;border:1px solid #d7e1ee;background:#f7fbff}
</style>
</head>
<body>
<div class="shell">
  <div class="panel">
    <header>
      <div class="left">
        <h1>Engineer Timesheets</h1>
        <span class="badge" id="badgeWeek">Week: –</span>
        <span class="badge" id="badgeRole">Role: Engineer</span>
      </div>
      <div class="ctrl">
        <button class="btn btn-ghost" id="prevWeek">◀ Prev</button>
        <input type="date" id="weekPicker" />
        <button class="btn btn-ghost" id="nextWeek">Next ▶</button>
        <select id="engineerSelect" title="Engineer"></select>
        <select id="roleSelect" title="Role">
          <option value="engineer" selected>Engineer</option>
          <option value="office">Office</option>
        </select>
        <button class="btn btn-primary" id="refreshBtn">Refresh</button>
      </div>
    </header>

    <main>
      <!-- ===== Weekly Summary (blue cards) ===== -->
      <section class="statsRow" aria-label="Weekly summary statistics">
        <div class="stat">
          <div class="label">Total Hours</div>
          <div class="value" id="st_total">0.00h</div>
          <div class="sub" id="st_days">0 days logged</div>
          <div class="tooltip i">i<span class="tip">Sum of Standard + Overtime for the selected week.</span></div>
        </div>
        <div class="stat">
          <div class="label">Standard Hours</div>
          <div class="value" id="st_std">0.00h</div>
          <div class="sub">Before overtime</div>
          <div class="tooltip i">i<span class="tip">Total non-overtime hours recorded.</span></div>
        </div>
        <div class="stat">
          <div class="label">Overtime Hours</div>
          <div class="value" id="st_ot">0.00h</div>
          <div class="sub" id="st_otp">0%</div>
          <div class="tooltip i">i<span class="tip">All hours beyond standard for the week.</span></div>
        </div>
        <div class="stat">
          <div class="label">Travel Hours</div>
          <div class="value" id="st_travel">0.00h</div>
          <div class="sub" id="st_travelParts">to / from</div>
          <div class="tooltip i">i<span class="tip">Combined travel to first site + from last site.</span></div>
        </div>
        <div class="stat">
          <div class="label">Avg Hours / Day</div>
          <div class="value" id="st_avg">0.00h</div>
          <div class="sub">Based on worked days</div>
          <div class="tooltip i">i<span class="tip">Total hours divided by number of worked days this week.</span></div>
        </div>
        <div class="stat">
          <div class="label">Enhanced OT Days</div>
          <div class="value" id="st_enhDays">0</div>
          <div class="sub" id="st_enhPct">0%</div>
          <div class="tooltip i">i<span class="tip">Count of days with Enhanced Overtime active.</span></div>
        </div>
        <div class="stat">
          <div class="label">Productivity</div>
          <div class="value" id="st_prod">0%</div>
          <div class="sub">vs 50h baseline</div>
          <div class="tooltip i">i<span class="tip">Total hours compared to a 50h weekly baseline.</span></div>
        </div>
        <div class="stat">
          <div class="label">Entries in File</div>
          <div class="value" id="st_records">0</div>
          <div class="sub">All-time count</div>
          <div class="tooltip i">i<span class="tip">Total number of records loaded from the JSON file.</span></div>
        </div>
      </section>

      <div class="toolbar">
        <div class="muted" id="dataHint">Loading logs…</div>
      </div>

      <div class="table-wrap" id="tableWrap" style="display:none;">
        <table id="timesTable" aria-label="Weekly timesheet table">
          <thead>
            <tr>
              <th style="min-width:110px;">Day</th>
              <th>Date</th>
              <th>Vehicle</th>
              <th>Leave&nbsp;Home</th>
              <th>Arrive&nbsp;First</th>
              <th>Leave&nbsp;Last</th>
              <th>Arrive&nbsp;Home</th>
              <th class="center">Lunch</th>
              <th class="right">Std&nbsp;h</th>
              <th class="right">OT&nbsp;h</th>
              <th class="right">Travel&nbsp;(to/from/total)</th>
              <th class="center">Enhanced</th>
              <th class="center">Notes</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
          <tfoot>
            <tr>
              <td colspan="8" class="right">Totals</td>
              <td class="right" id="t_std">0.00</td>
              <td class="right" id="t_ot">0.00</td>
              <td class="right" id="t_travel">0.00</td>
              <td class="center" id="t_enh">0</td>
              <td></td>
            </tr>
          </tfoot>
        </table>
      </div>

      <div id="emptyState" class="empty" style="display:none;">
        No times logged for this engineer in the selected week.
      </div>

      <!-- ===== Notes Summary ===== -->
      <section class="notes-panel" id="notesPanel" style="display:none;">
        <div class="notes-head">
          <strong>Notes Summary</strong>
          <span class="muted" id="notesMeta">–</span>
        </div>
        <div class="notes-body" id="notesBody"></div>
      </section>
    </main>

    <div class="footer">
      <div class="muted">Source: json_logs/hours/hours-log.json</div>
      <a class="link" id="compareLink" href="view-timesheet-summary.html">Open comparison page ↗</a>
    </div>
  </div>
</div>

<script>
/* ===== Config / Utils ===== */
const HOURS_URL = "https://raw.githubusercontent.com/Mostlane/Test/main/json_logs/hours/hours-log.json";
const $ = (id)=>document.getElementById(id);
const toISO=(d)=>d.toISOString().split("T")[0];
const parseNum=(v)=>v==null||v===""?0:(isNaN(+v)?0:+v);

function mondayOf(dateStr){
  const d = dateStr? new Date(dateStr+"T12:00:00"): new Date();
  const day = (d.getDay()+6)%7; d.setDate(d.getDate()-day); d.setHours(12,0,0,0); return d;
}
function addDays(d,n){const x=new Date(d);x.setDate(x.getDate()+n);return x;}
function fmtDateNice(dateStr){const d=new Date(dateStr+"T12:00:00");return d.toLocaleDateString("en-GB",{weekday:"short",day:"2-digit",month:"short"});}

/* ===== State ===== */
let ALL={entries:[]}, ENGINEERS=[];
let state={role:"engineer", engineer:"", weekStart:mondayOf().toISOString().split("T")[0]};

/* ===== Data ===== */
async function fetchLogs(){
  $("dataHint").textContent = "Loading logs…";
  try{
    const r = await fetch(HOURS_URL,{cache:"no-store"});
    ALL = await r.json();
    if(!Array.isArray(ALL.entries)) ALL.entries=[];
    $("dataHint").textContent = `Loaded ${ALL.entries.length} records`;
    $("st_records").textContent = ALL.entries.length;
  }catch(e){
    $("dataHint").textContent = "Could not load logs.";
    ALL = {entries:[]};
    $("st_records").textContent = 0;
  }
}

function buildEngineerList(){
  const set = new Set();
  ALL.entries.forEach(e=>{ if(e.engineer) set.add(e.engineer.trim()); });
  ENGINEERS = Array.from(set).sort((a,b)=>a.localeCompare(b));
  const sel = $("engineerSelect");
  sel.innerHTML = "";
  ENGINEERS.forEach(name=>{
    const o=document.createElement("option"); o.value=name; o.textContent=name; sel.appendChild(o);
  });
  const existing = ENGINEERS.includes(state.engineer)? state.engineer : ENGINEERS[0] || "";
  state.engineer = existing; sel.value = state.engineer;
}

function setWeekUI(){
  const d=new Date(state.weekStart+"T12:00:00"); const weekEnd=addDays(d,6);
  $("weekPicker").value = toISO(d);
  $("badgeWeek").textContent = `Week: ${d.toLocaleDateString("en-GB",{day:"2-digit",month:"short"})} – ${weekEnd.toLocaleDateString("en-GB",{day:"2-digit",month:"short",year:"numeric"})}`;
}
function setRoleUI(){
  $("roleSelect").value = state.role;
  $("badgeRole").textContent = `Role: ${state.role==="office"?"Office":"Engineer"}`;
}

/* ===== Filtering ===== */
function entriesForEngineerWeek(name, weekStart){
  const start = new Date(weekStart+"T12:00:00");
  const dates = Array.from({length:7}, (_,i)=> toISO(addDays(start,i)));
  const byDate = new Map();
  ALL.entries.forEach(e=>{
    if(!e || !e.engineer || !e.date) return;
    if(e.engineer.trim() !== name.trim()) return;
    if(dates.includes(e.date)) byDate.set(e.date, e);
  });
  return { dates, byDate };
}

/* ===== Render Table + Stats + Notes ===== */
function renderAll(){
  const { dates, byDate } = entriesForEngineerWeek(state.engineer, state.weekStart);
  const tb = $("tbody"); tb.innerHTML = "";

  let sumStd=0, sumOT=0, sumTravel=0, sumTravelTo=0, sumTravelFrom=0, enhDays=0, worked=0;
  const notesVisible = []; // for notes panel (respecting role)

  dates.forEach(dateStr=>{
    const e = byDate.get(dateStr);
    const dayNice = fmtDateNice(dateStr);

    if(e){
      const lunch = e.deductLunch ? "30m" : "—";
      const enh = String(e.enhancedOvertimePreview||"").toLowerCase().startsWith("y");

      const std = parseNum(e.standardHours);
      const ot = parseNum(e.overtimeHours);
      const tTo = parseNum(e.travelToHours);
      const tFrom = parseNum(e.travelFromHours);
      const tTot = parseNum(e.totalTravelHours);

      sumStd += std; sumOT += ot; sumTravel += tTot; sumTravelTo += tTo; sumTravelFrom += tFrom;
      enhDays += enh ? 1 : 0; worked += 1;

      const noteOK = (state.role === "office") || !!e.noteVisible;
      const hasNote = (e.notes||"").trim().length>0 && noteOK;
      if(hasNote){
        notesVisible.push({
          date: e.date, day: e.day||dayNice, text: e.notes.trim(),
          visible: !!e.noteVisible
        });
      }

      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td><strong>${dayNice}</strong></td>
        <td class="muted">${e.date}</td>
        <td>${e.vehicle||""}</td>
        <td>${e.leaveHome||""}</td>
        <td>${e.arriveFirstSite||""}</td>
        <td>${e.leaveLastSite||""}</td>
        <td>${e.arriveHome||""}</td>
        <td class="center">${lunch}</td>
        <td class="right">${std.toFixed(2)}</td>
        <td class="right">${ot.toFixed(2)}</td>
        <td class="right">${tTo.toFixed(2)} / ${tFrom.toFixed(2)} / ${tTot.toFixed(2)}</td>
        <td class="center"><span class="flag ${enh?'enh':'no'}">${enh?'✓':'—'}</span></td>
        <td class="center">
          <span class="note-dot ${hasNote?'has':''}" title="${hasNote?'Click to view note':'No visible note'}">📝</span>
        </td>
      `;
      tb.appendChild(tr);
    } else {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td><strong>${dayNice}</strong></td>
        <td class="muted">${dateStr}</td>
        <td colspan="11" class="muted">– no entry –</td>
      `;
      tb.appendChild(tr);
    }
  });

  // Totals (table footer)
  $("t_std").textContent = sumStd.toFixed(2);
  $("t_ot").textContent = sumOT.toFixed(2);
  $("t_travel").textContent = sumTravel.toFixed(2);
  $("t_enh").textContent = enhDays;

  const hasAny = worked>0;
  $("tableWrap").style.display = hasAny ? "block" : "none";
  $("emptyState").style.display = hasAny ? "none" : "block";

  // ===== Summary Stats (blue cards)
  const totalH = sumStd + sumOT;
  $("st_total").textContent = totalH.toFixed(2) + "h";
  $("st_days").textContent = worked + " " + (worked===1?"day":"days") + " logged";
  $("st_std").textContent = sumStd.toFixed(2) + "h";
  $("st_ot").textContent = sumOT.toFixed(2) + "h";
  $("st_otp").textContent = (totalH>0 ? ((sumOT/totalH)*100).toFixed(0) : 0) + "%";
  $("st_travel").textContent = sumTravel.toFixed(2) + "h";
  $("st_travelParts").textContent = `${sumTravelTo.toFixed(2)}h to • ${sumTravelFrom.toFixed(2)}h from`;
  $("st_avg").textContent = (worked>0 ? (totalH/worked) : 0).toFixed(2) + "h";
  $("st_enhDays").textContent = enhDays;
  $("st_enhPct").textContent = (worked>0 ? ((enhDays/worked)*100).toFixed(0) : 0) + "%";
  $("st_prod").textContent = ((totalH/50)*100).toFixed(0) + "%";

  // ===== Notes panel
  const notesPanel = $("notesPanel");
  const notesBody = $("notesBody");
  const notesMeta = $("notesMeta");
  notesBody.innerHTML = "";
  if(notesVisible.length){
    notesPanel.style.display = "block";
    notesMeta.textContent = `${notesVisible.length} note${notesVisible.length>1?'s':''} this week`;
    notesVisible.sort((a,b)=> a.date.localeCompare(b.date));
    notesVisible.forEach(n=>{
      const div = document.createElement("div");
      div.className = "note-item";
      div.innerHTML = `
        <div class="note-meta">
          <strong>${n.day}</strong>
          <span class="muted">${n.date}</span>
          <span class="badge-vis">${n.visible ? "👁 Visible to engineer" : "🔒 Office only"}</span>
        </div>
        <div style="margin-top:6px;white-space:pre-wrap">${(n.text||"").replace(/</g,"&lt;")}</div>
      `;
      notesBody.appendChild(div);
    });
  }else{
    notesPanel.style.display = "none";
  }

  // Comparison page link
  $("compareLink").href = `view-timesheet-summary.html?week=${encodeURIComponent(state.weekStart)}&engineer=${encodeURIComponent(state.engineer)}`;
}

/* ===== Events ===== */
$("prevWeek").onclick=()=>{const d=addDays(new Date(state.weekStart+"T12:00:00"),-7);state.weekStart=toISO(d);setWeekUI();renderAll();};
$("nextWeek").onclick=()=>{const d=addDays(new Date(state.weekStart+"T12:00:00"),+7);state.weekStart=toISO(d);setWeekUI();renderAll();};
$("weekPicker").addEventListener("change",()=>{const monday=mondayOf($("weekPicker").value);state.weekStart=toISO(monday);setWeekUI();renderAll();});
$("engineerSelect").addEventListener("change",()=>{state.engineer=$("engineerSelect").value;renderAll();});
$("roleSelect").addEventListener("change",()=>{state.role=$("roleSelect").value;setRoleUI();renderAll();});
$("refreshBtn").onclick=async()=>{await fetchLogs();buildEngineerList();renderAll();};

/* ===== Boot ===== */
(async function init(){
  state.weekStart = toISO(mondayOf());
  setWeekUI(); setRoleUI();
  await fetchLogs();
  buildEngineerList();
  renderAll();
})();
</script>
</body>
</html>
