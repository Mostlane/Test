<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Mostlane ‚Ä¢ Advanced Hours Dashboard v3</title>
<link rel="preconnect" href="https://cdn.jsdelivr.net" />
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<style>
  :root{
    --bg:#0f172a; --panel:#111827; --panelEdge:#0b1222; --text:#e5e7eb; --muted:#9ca3af;
    --ok:#10b981; --warn:#f59e0b; --bad:#ef4444;
    --blue:#3b82f6; --indigo:#6366f1; --cyan:#22d3ee; --yellow:#facc15;
  }
  body{margin:0;background:linear-gradient(180deg,#0b132a,#0a0f1f);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
  .wrap{display:grid;grid-template-columns: 1fr 320px; gap:16px; padding:16px}
  .area{display:grid; grid-template-columns: repeat(2,minmax(0,1fr)); gap:16px}
  .panel{background:var(--panel); border:1px solid #1f2937; border-radius:10px; padding:14px; box-shadow:inset 0 0 0 1px var(--panelEdge), 0 6px 16px rgba(0,0,0,.35)}
  .title{font-weight:600; font-size:14px; color:var(--muted); margin-bottom:8px}
  .kpiGrid{display:grid; grid-template-columns: repeat(4,1fr); gap:16px; margin-bottom:16px}
  .kpi .num{font-size:28px; font-weight:800}
  .kpi .sub{color:var(--muted); font-size:12px}
  .leaderboard .row{display:flex; justify-content:space-between; padding:6px 0; border-bottom:1px dashed #334155}
  .leaderboard .row:last-child{border-bottom:none}
  .pill{display:inline-block; font-size:11px; border-radius:999px; padding:2px 8px}
  .ok{background:#04281e;color:#34d399} .warn{background:#422d14;color:#fbbf24} .bad{background:#3b0e0e;color:#fca5a5}
  .topbar{grid-column:1/3; display:flex; justify-content:space-between; align-items:center; margin-bottom:4px}
  .btn{appearance:none; border:1px solid #334155; background:#0b132a; color:#fff; padding:8px 10px; border-radius:8px; cursor:pointer}
  .highlight{font-size:18px;font-weight:700;color:var(--blue)}
  @media(max-width:1100px){ .wrap{grid-template-columns:1fr} .area{grid-template-columns:1fr} .kpiGrid{grid-template-columns:repeat(2,1fr)} }
</style>
</head>
<body>
  <div class="wrap">
    <div class="area">
      <div class="topbar" style="grid-column:1/3">
        <div>
          <div style="font-weight:700;font-size:20px">Team Dashboard v3</div>
          <div style="margin-top:6px">
            üèÜ Top Engineer ‚Äì This Week: <span class="highlight" id="topWeek">‚Äì</span><br>
            üèÜ Top Engineer ‚Äì Last 6 Weeks: <span class="highlight" id="topHist">‚Äì</span>
          </div>
        </div>
        <a href="hours-dashboard-simple-v2.html" class="btn">Simple View</a>
      </div>

      <!-- KPI TILES -->
      <div class="panel kpiGrid" style="grid-column:1/3">
        <div class="panel kpi"><div class="num" id="kpi-engineers">‚Äì</div><div class="sub">Engineers</div></div>
        <div class="panel kpi"><div class="num" id="kpi-worked">‚Äì</div><div class="sub">Hours worked so far</div></div>
        <div class="panel kpi"><div class="num" id="kpi-pred">‚Äì</div><div class="sub">Predicted total this week</div></div>
        <div class="panel kpi"><div class="num" id="kpi-remaining">‚Äì</div><div class="sub">Team hours remaining</div></div>
      </div>

      <!-- Charts -->
      <div class="panel"><div class="title">Team progress</div><canvas id="progressTeam" height="100"></canvas></div>
      <div class="panel"><div class="title">Avg engineer vs 40h cap</div><canvas id="progressAvg" height="100"></canvas></div>
      <div class="panel"><div class="title">Risk distribution</div><canvas id="donutRisk" height="120"></canvas></div>
      <div class="panel"><div class="title">By engineer</div><canvas id="stackedByEngineer" height="140"></canvas></div>
      <div class="panel" style="grid-column:1/3"><div class="title">Hours by day</div><canvas id="byDay" height="140"></canvas></div>
    </div>

    <!-- Right Column Leaderboards -->
    <div class="panel leaderboard" style="max-height:calc(100vh - 32px);overflow:auto">
      <div class="title">Leaderboards ‚Ä¢ This Week</div>
      <div id="lb-week"></div>
      <div class="title" style="margin-top:12px">Leaderboards ‚Ä¢ Last 6 Weeks</div>
      <div id="lb-hist"></div>
    </div>
  </div>

<script>
const CAP=40;
const engineers=[
  {name:"Jamie Line", worked:24, predicted:44, onsite:19, drive:5, mileage:210, overtime:4, weekend:0, score:77, vancheck:"done", history:[41,43,45,44,42,46], checks:[1,1,1,1,1,0], scores:[75,78,80,76,77,78]},
  {name:"Chris Cooke", worked:22, predicted:42, onsite:18, drive:4, mileage:180, overtime:2, weekend:0, score:82, vancheck:"missed", history:[40,41,43,42,42,40], checks:[1,1,1,1,1,1], scores:[80,82,83,81,80,79]},
  {name:"Bradley Graham", worked:18, predicted:39, onsite:15, drive:3, mileage:150, overtime:0, weekend:4, score:65, vancheck:"done", history:[37,39,38,40,39,37], checks:[1,0,1,1,0,1], scores:[66,67,64,65,66,67]},
  {name:"Connor Brady", worked:20, predicted:38, onsite:16, drive:4, mileage:200, overtime:1, weekend:0, score:70, vancheck:"done", history:[36,38,37,39,38,36], checks:[1,1,1,0,1,1], scores:[70,71,72,69,70,71]},
  {name:"Ciprian", worked:17, predicted:34, onsite:14, drive:3, mileage:170, overtime:0, weekend:0, score:85, vancheck:"done", history:[33,34,35,34,33,36], checks:[1,1,1,1,1,1], scores:[84,85,83,86,84,85]}
];

// Composite weekly scoring
function weeklyScore(e){
  let s=100;
  if(e.overtime) s-=2*e.overtime;
  if(e.weekend) s-=e.weekend*1.5;
  const eff=e.onsite/(e.onsite+e.drive);
  if(eff<0.8) s-=10;
  if(eff>0.9) s+=5;
  if(e.score<70) s-=(70-e.score);
  if(e.vancheck!=="done") s-=20;
  return s;
}
function historicScore(e){
  let s=100;
  const avgHours=e.history.reduce((a,b)=>a+b,0)/e.history.length;
  if(avgHours>CAP) s-=2*(avgHours-CAP);
  const eff=e.onsite/(e.onsite+e.drive);
  if(eff<0.8) s-=5;
  const avgScore=e.scores.reduce((a,b)=>a+b,0)/e.scores.length;
  if(avgScore<70) s-=(70-avgScore);
  const checks=e.checks.reduce((a,b)=>a+b,0)/e.checks.length;
  if(checks<1) s-=20*(1-checks);
  return s;
}

const weekTop=engineers.map(e=>({name:e.name,score:weeklyScore(e)})).sort((a,b)=>b.score-a.score)[0];
const histTop=engineers.map(e=>({name:e.name,score:historicScore(e)})).sort((a,b)=>b.score-a.score)[0];
document.getElementById('topWeek').textContent=weekTop.name+" ("+weekTop.score.toFixed(0)+")";
document.getElementById('topHist').textContent=histTop.name+" ("+histTop.score.toFixed(0)+")";

// KPIs
const teamWorked=engineers.reduce((s,e)=>s+e.worked,0);
const teamPred=engineers.reduce((s,e)=>s+e.predicted,0);
document.getElementById('kpi-engineers').textContent=engineers.length;
document.getElementById('kpi-worked').textContent=teamWorked+"h";
document.getElementById('kpi-pred').textContent=teamPred+"h";
document.getElementById('kpi-remaining').textContent=Math.max(0,engineers.length*CAP-teamPred)+"h";

// Leaderboards rendering
function pill(val,type){return `<span class="pill ${type}">${val}</span>`}
function renderLeaderboards(){
  const lbw=document.getElementById('lb-week'); lbw.innerHTML="";
  const lbh=document.getElementById('lb-hist'); lbh.innerHTML="";
  // Weekly leaderboards
  addBoard(lbw,"Highest Hours",engineers.sort((a,b)=>b.predicted-a.predicted).map(e=>`${e.name} ${e.predicted}h`));
  addBoard(lbw,"Overtime",engineers.sort((a,b)=>b.overtime-a.overtime).map(e=>`${e.name} ${e.overtime}h`));
  addBoard(lbw,"Efficiency",engineers.sort((a,b)=>(b.onsite/(b.onsite+b.drive))-(a.onsite/(a.onsite+a.drive))).map(e=>`${e.name} ${(100*e.onsite/(e.onsite+e.drive)).toFixed(0)}%`));
  addBoard(lbw,"Driving Score",engineers.sort((a,b)=>b.score-a.score).map(e=>`${e.name} ${e.score}`));
  addBoard(lbw,"Van Checks",engineers.map(e=>`${e.name} ${e.vancheck==="done"?"‚úÖ":"‚ùå"}`));
  // Historic leaderboards
  addBoard(lbh,"Avg Weekly Hours",engineers.sort((a,b)=>avg(b.history)-avg(a.history)).map(e=>`${e.name} ${avg(e.history).toFixed(0)}h`));
  addBoard(lbh,"Overtime (6wks)",engineers.sort((a,b)=>b.overtime-a.overtime).map(e=>`${e.name} ${(e.overtime*6).toFixed(1)}h`));
  addBoard(lbh,"Efficiency Avg",engineers.sort((a,b)=>(b.onsite/(b.onsite+b.drive))-(a.onsite/(a.onsite+a.drive))).map(e=>`${e.name} ${(100*e.onsite/(e.onsite+e.drive)).toFixed(0)}%`));
  addBoard(lbh,"Driving Score Avg",engineers.sort((a,b)=>avg(b.scores)-avg(a.scores)).map(e=>`${e.name} ${avg(e.scores).toFixed(0)}`));
  addBoard(lbh,"Van Checks Avg",engineers.sort((a,b)=>avg(b.checks)-avg(a.checks)).map(e=>`${e.name} ${(100*avg(e.checks)).toFixed(0)}%`));
}
function addBoard(container,title,rows){
  const div=document.createElement('div');
  div.innerHTML=`<div style="font-weight:600;margin-top:10px">${title}</div>`+rows.map(r=>`<div class='row'>${r}</div>`).join("");
  container.appendChild(div);
}
function avg(arr){return arr.reduce((a,b)=>a+b,0)/arr.length}

renderLeaderboards();

// Charts (team/hours by day) kept simple dummy
new Chart(document.getElementById('progressTeam').getContext('2d'),{type:'bar',data:{labels:['Team'],datasets:[{label:'Worked',data:[teamWorked],backgroundColor:'#2563eb'}]}});
new Chart(document.getElementById('progressAvg').getContext('2d'),{type:'bar',data:{labels:['Avg engineer'],datasets:[{data:[teamPred/engineers.length],backgroundColor:'#10b981'}]}});
new Chart(document.getElementById('donutRisk').getContext('2d'),{type:'doughnut',data:{labels:['On track','Close','Over'],datasets:[{data:[3,1,1],backgroundColor:['#10b981','#f59e0b','#ef4444']} ]}});
new Chart(document.getElementById('stackedByEngineer').getContext('2d'),{type:'bar',data:{labels:engineers.map(e=>e.name),datasets:[{label:'Worked',data:engineers.map(e=>e.worked),backgroundColor:'#3b82f6'}]}});
new Chart(document.getElementById('byDay').getContext('2d'),{type:'bar',data:{labels:['Mon','Tue','Wed','Thu','Fri'],datasets:engineers.map((e,i)=>({label:e.name,data:e.history.slice(0,5),backgroundColor:['#3b82f6','#6366f1','#22d3ee','#facc15','#14b8a6'][i%5]}))}});
</script>
</body>
</html>
