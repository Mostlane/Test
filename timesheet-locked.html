<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>My Timesheet ‚Äì Mostlane</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>

<!-- PDF LIBRARY -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

<style>
:root{
  --ml-blue:#003366;
  --ml-accent:#1a73e8;
  --ml-ink:#27313a;
  --ml-bg:#e6e8eb;
  --muted:#6b7280;
  --border:#e5e7eb;
  --ok:#15803d;
  --warn:#b91c1c;
}

html,body{margin:0;padding:0;width:100%;overflow-x:hidden;}

body{
  font-family:"Segoe UI",system-ui,Roboto,Arial,sans-serif;
  background:var(--ml-bg) url('Mostlane_Embossed.png') no-repeat center center fixed;
  background-size:180% auto;
  padding:16px;
  color:var(--ml-ink);
}

.shell{
  max-width:900px;
  margin:0 auto;
  background:rgba(255,255,255,0.94);
  border-radius:16px;
  box-shadow:0 12px 28px rgba(0,0,0,0.12);
  overflow:hidden;
}

header{
  padding:18px;
  text-align:center;
}

header h1{
  margin:0 0 12px 0;
  color:var(--ml-blue);
}

header a, header button{
  display:block;
  width:100%;
  margin-top:8px;
  padding:10px;
  border-radius:10px;
  font-weight:600;
  border:none;
}

header a{
  background:var(--ml-accent);
  color:#fff;
  text-decoration:none;
}

header button{
  background:#003366;
  color:#fff;
  cursor:pointer;
}

.content{padding:18px;}

.controls{
  display:grid;
  grid-template-columns:1fr;
  gap:10px;
  margin-bottom:20px;
}

.controls button,.controls .pill{
  padding:10px;
  border-radius:12px;
  border:1px solid var(--border);
  background:#f8fafc;
  font-weight:600;
  text-align:center;
}

.day-group{margin-bottom:22px;}

.day-header{
  font-weight:700;
  color:#111827;
  border-bottom:2px solid #e5e7eb;
  padding-bottom:6px;
  margin-bottom:12px;
}

.session-card{
  background:#fff;
  border-radius:14px;
  padding:14px 16px;
  margin-bottom:12px;
  border:1px solid #eef2f7;
  box-shadow:
    0 1px 2px rgba(0,0,0,0.04),
    0 6px 16px rgba(0,0,0,0.06);
}

.session-time{
  font-size:18px;
  font-weight:700;
  color:var(--ml-blue);
}

.session-hours{
  margin-top:6px;
  font-size:13px;
  font-weight:600;
}

.session-hours span{margin-right:14px;}

.location{
  margin-top:8px;
  font-size:13px;
  display:flex;
  align-items:center;
  gap:6px;
}

.location a{
  color:var(--ml-accent);
  text-decoration:none;
  font-weight:600;
}

.verified{color:var(--ok);font-weight:700;}
.unknown{color:var(--warn);}

.summary{
  margin-top:20px;
  display:grid;
  gap:10px;
}

.summary div{
  padding:10px;
  border-radius:12px;
  background:#f8fafc;
  border:1px solid var(--border);
  font-weight:600;
  display:flex;
  justify-content:space-between;
}

.note{
  margin-top:12px;
  font-size:13px;
  color:#6b7280;
}
</style>
</head>

<body>
<div class="shell" id="pdfRoot">
<header>
  <h1>My Weekly Timesheet</h1>
  <a href="main.html">Main Menu</a>
  <button id="exportBtn">üìÑ Export PDF</button>
</header>

<div class="content">
<div class="controls">
  <button id="prevWeek">‚óÄ Previous Week</button>
  <div class="pill">Week Commencing: <span id="weekLabel">‚Äî</span></div>
  <button id="nextWeek">Next Week ‚ñ∂</button>
  <div class="pill">Engineer: <span id="engineerName">‚Äî</span></div>
</div>

<div id="sessions"></div>

<div class="summary">
  <div><span>Standard</span><span id="sumStd">0.00 h</span></div>
  <div><span>Overtime</span><span id="sumOT">0.00 h</span></div>
  <div><span>Total</span><span id="sumTotal">0.00 h</span></div>
</div>

<div class="note">
  Sessions are calculated from <b>check-in ‚Üí check-out</b>.
</div>

<div id="status" class="note"></div>
</div>
</div>

<script>
/* ---------- helpers ---------- */
function ordinal(n){
  const s=["th","st","nd","rd"],v=n%100;
  return n+(s[(v-20)%10]||s[v]||s[0]);
}
function friendlyDate(d){
  return d.toLocaleDateString("en-GB",{weekday:"long",month:"short"})+
         " "+ordinal(d.getDate());
}
function time(d){return d.toISOString().slice(11,16);}
function startOfWeek(d){
  d=new Date(d);const day=d.getDay()||7;
  d.setDate(d.getDate()-day+1);d.setHours(0,0,0,0);return d;
}
function endOfWeek(d){
  d=new Date(d);d.setDate(d.getDate()+6);d.setHours(23,59,59,999);return d;
}
function hours(a,b){return (b-a)/36e5;}

/* ---------- config ---------- */
const EVENTS_WORKER="https://ckeck-in-out.jamie-def.workers.dev";
const SITES_WORKER="https://mostlane-sites.jamie-def.workers.dev";

const user=sessionStorage.getItem("mostlaneUser")||sessionStorage.getItem("mostlaneUsername");

/* ---------- dom ---------- */
const weekLabel=document.getElementById("weekLabel");
const engineerName=document.getElementById("engineerName");
const sessionsEl=document.getElementById("sessions");
const sumStd=document.getElementById("sumStd");
const sumOT=document.getElementById("sumOT");
const sumTotal=document.getElementById("sumTotal");
const statusEl=document.getElementById("status");

engineerName.textContent=user||"‚Äî";

let currentWeek=startOfWeek(new Date());
let ALL_SITES=[];

/* ---------- site matching ---------- */
function findSite(evt){
  if(evt.matchedSite) return evt.matchedSite;
  if(!evt.lat||!evt.lon) return null;

  let best=null,bestD=Infinity;
  for(const s of ALL_SITES){
    if(!s.lat||!s.lon) continue;
    const d=(evt.lat-s.lat)**2+(evt.lon-s.lon)**2;
    if(d<bestD){bestD=d;best=s;}
  }
  return best;
}

/* ---------- main ---------- */
async function loadWeek(){
  if(!user){statusEl.textContent="Not logged in.";return;}

  if(!ALL_SITES.length){
    const r=await fetch(`${SITES_WORKER}/get-sites?category=all`);
    ALL_SITES=await r.json();
  }

  weekLabel.textContent=friendlyDate(currentWeek);
  sessionsEl.innerHTML="";
  statusEl.textContent="Loading‚Ä¶";

  const res=await fetch(`${EVENTS_WORKER}/events?user=${encodeURIComponent(user)}`);
  const all=await res.json();

  const weekEvents=all.filter(e=>{
    const d=new Date(e.datetime);
    return d>=currentWeek && d<=endOfWeek(currentWeek);
  });

  const byDay={};
  weekEvents.forEach(e=>{
    const d=new Date(e.datetime);
    const k=d.toISOString().slice(0,10);
    (byDay[k]??=[]).push({...e,d});
  });

  let total=0,std=0,ot=0;

  Object.keys(byDay).sort().forEach(dayKey=>{
    const list=byDay[dayKey].sort((a,b)=>a.d-b.d);
    const group=document.createElement("div");
    group.className="day-group";
    group.innerHTML=`<div class="day-header">${friendlyDate(list[0].d)}</div>`;

    let remainingStd=8;

    for(let i=0;i<list.length-1;i++){
      if(list[i].type==="checkin" && list[i+1].type==="checkout"){
        const h=hours(list[i].d,list[i+1].d);
        const s=Math.min(h,remainingStd);
        const o=Math.max(h-s,0);
        remainingStd-=s;

        total+=h;std+=s;ot+=o;

        const mapURL=`https://www.google.com/maps?q=${list[i].lat},${list[i].lon}`;

        let locationHTML=list[i].matchedSite
          ? `üìç ${list[i].matchedSite.siteName} <span class="verified">‚úî Verified</span>`
          : list[i].nearestSite
            ? `üìç Near ${list[i].nearestSite.siteName}`
            : `üìç <span class="unknown">Unknown location</span>`;

        group.innerHTML+=`
          <div class="session-card">
            <div class="session-time">${time(list[i].d)} ‚Üí ${time(list[i+1].d)}</div>
            <div class="session-hours">
              <span>Total ${h.toFixed(2)}</span>
              <span>Std ${s.toFixed(2)}</span>
              <span>OT ${o.toFixed(2)}</span>
            </div>
            <div class="location">${locationHTML}</div>
            <div class="location"><a href="${mapURL}" target="_blank">View on map</a></div>
          </div>`;
      }
    }

    /* ----- travel time (first + last) ----- */
    let travelMin=0;
    const first=findSite(list[0]);
    const last=findSite(list[list.length-1]);

    if(first?.travelTimeFromHQMinutes) travelMin+=first.travelTimeFromHQMinutes;
    if(last?.travelTimeFromHQMinutes && last!==first) travelMin+=last.travelTimeFromHQMinutes;

    if(travelMin){
      const h=travelMin/60;
      total+=h;std+=h;

      group.innerHTML+=`
        <div class="session-card">
          <div class="session-time">üöó Travel Time</div>
          <div class="session-hours">
            <span>${travelMin} min (${h.toFixed(2)} h)</span>
          </div>
        </div>`;
    }

    sessionsEl.appendChild(group);
  });

  sumStd.textContent=std.toFixed(2)+" h";
  sumOT.textContent=ot.toFixed(2)+" h";
  sumTotal.textContent=total.toFixed(2)+" h";
  statusEl.textContent="";
}

document.getElementById("prevWeek").onclick=()=>{currentWeek.setDate(currentWeek.getDate()-7);loadWeek();};
document.getElementById("nextWeek").onclick=()=>{currentWeek.setDate(currentWeek.getDate()+7);loadWeek();};

/* ---------- PDF ---------- */
document.getElementById("exportBtn").onclick=()=>{
  const wc=friendlyDate(currentWeek).replace(/\s+/g,"_");
  html2pdf().set({
    margin:10,
    filename:`Timesheet_${user||"Engineer"}_${wc}.pdf`,
    image:{type:"jpeg",quality:0.98},
    html2canvas:{scale:2,useCORS:true},
    jsPDF:{unit:"mm",format:"a4",orientation:"portrait"}
  }).from(document.getElementById("pdfRoot")).save();
};

loadWeek();
</script>

</body>
</html>
