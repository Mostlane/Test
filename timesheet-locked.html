<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Mostlane â€¢ Locked Timesheet</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <style>
    body {
      margin: 0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: #e6e8eb url('Mostlane_Embossed.png') no-repeat center center fixed;
      background-size: cover;
      color: #1f2937;
    }

    .wrap {
      max-width: 900px;
      margin: 24px auto;
      background: rgba(255,255,255,0.7);
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 8px 24px rgba(0,0,0,0.08);
    }

    h1 {
      margin-top: 0;
      font-size: 22px;
    }

    .day {
      background: #fff;
      border-radius: 10px;
      padding: 14px;
      margin-bottom: 14px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.06);
    }

    .day h3 {
      margin: 0 0 8px 0;
      font-size: 16px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 14px;
    }

    th, td {
      padding: 8px;
      border-bottom: 1px solid #e5e7eb;
      text-align: left;
    }

    th {
      color: #6b7280;
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: .05em;
    }

    .summary {
      margin-top: 10px;
      font-weight: 600;
      font-size: 14px;
    }

    .muted {
      color: #6b7280;
      font-weight: 500;
    }

    .total {
      font-size: 18px;
      font-weight: 700;
      margin-top: 20px;
      text-align: right;
    }

    .badge {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 999px;
      background: #eef2ff;
      color: #3730a3;
      font-size: 12px;
      font-weight: 700;
    }
  </style>
</head>

<body>
<div class="wrap">
  <h1>Weekly Timesheet (Locked)</h1>
  <div id="timesheet"></div>
  <div class="total" id="grandTotal"></div>
</div>

<script>
/* ================= CONFIG ================= */

const WORKER_BASE = "https://mostlane-sites.jamie-def.workers.dev";

/* ================= HELPERS ================= */

function groupByDay(events) {
  const out = {};
  for (const e of events) {
    const d = e.datetime.split("T")[0];
    if (!out[d]) out[d] = [];
    out[d].push(e);
  }
  return out;
}

function minutesToHM(mins) {
  const h = Math.floor(mins / 60);
  const m = mins % 60;
  return m ? `${h}h ${m}m` : `${h}h`;
}

function diffHours(start, end) {
  return (new Date(end) - new Date(start)) / 36e5;
}

function nearestSite(lat, lon, sites) {
  let best = null;
  let bestDist = Infinity;

  for (const s of sites) {
    if (!s.lat || !s.lon) continue;
    const d =
      Math.pow(lat - s.lat, 2) +
      Math.pow(lon - s.lon, 2);
    if (d < bestDist) {
      bestDist = d;
      best = s;
    }
  }
  return best;
}

/* ================= LOAD DATA ================= */

async function loadSites() {
  const r = await fetch(`${WORKER_BASE}/get-sites?category=all`);
  return await r.json();
}

// MOCK: replace with your real activity log source
async function loadCheckEvents() {
  return await fetch("activity-log.json").then(r => r.json());
}

/* ================= MAIN ================= */

(async () => {
  const sites = await loadSites();
  const events = await loadCheckEvents();

  // Match each event to nearest site
  for (const e of events) {
    if (e.lat && e.lon) {
      e.matchedSite = nearestSite(e.lat, e.lon, sites);
    }
  }

  const byDay = groupByDay(events);
  const container = document.getElementById("timesheet");

  let weeklyTotal = 0;

  Object.keys(byDay).sort().forEach(date => {
    const dayEvents = byDay[date]
      .sort((a,b)=>new Date(a.datetime)-new Date(b.datetime));

    let dayWorked = 0;
    let travelMinutes = 0;

    for (let i = 0; i < dayEvents.length; i += 2) {
      const checkin = dayEvents[i];
      const checkout = dayEvents[i + 1];
      if (!checkout) continue;

      const baseHours = diffHours(checkin.datetime, checkout.datetime);
      dayWorked += baseHours;

      const isFirst = i === 0;
      const isLast  = i === dayEvents.length - 2;

      if (
        isFirst &&
        checkin.matchedSite &&
        Number.isFinite(checkin.matchedSite.travelTimeFromHQMinutes)
      ) {
        travelMinutes += checkin.matchedSite.travelTimeFromHQMinutes;
      }

      if (
        isLast &&
        checkout.matchedSite &&
        Number.isFinite(checkout.matchedSite.travelTimeFromHQMinutes)
      ) {
        travelMinutes += checkout.matchedSite.travelTimeFromHQMinutes;
      }
    }

    const travelHours = travelMinutes / 60;
    const dayTotal = dayWorked + travelHours;
    weeklyTotal += dayTotal;

    /* ===== RENDER DAY ===== */

    const div = document.createElement("div");
    div.className = "day";

    div.innerHTML = `
      <h3>${date}</h3>
      <table>
        <thead>
          <tr>
            <th>Type</th>
            <th>Time</th>
            <th>Site</th>
          </tr>
        </thead>
        <tbody>
          ${dayEvents.map(e=>`
            <tr>
              <td>${e.type}</td>
              <td>${new Date(e.datetime).toLocaleTimeString()}</td>
              <td>
                ${e.matchedSite
                  ? `<span class="badge">${e.matchedSite.siteName}</span>`
                  : `<span class="muted">Unknown</span>`}
              </td>
            </tr>
          `).join("")}
        </tbody>
      </table>

      <div class="summary">
        Worked: ${dayWorked.toFixed(2)}h<br>
        Travel: ${travelMinutes
          ? minutesToHM(travelMinutes)
          : "0h"}<br>
        <strong>Total: ${dayTotal.toFixed(2)}h</strong>
      </div>
    `;

    container.appendChild(div);
  });

  document.getElementById("grandTotal").textContent =
    `Weekly Total: ${weeklyTotal.toFixed(2)} hours`;
})();
</script>
</body>
</html>
