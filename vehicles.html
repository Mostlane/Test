<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>Mostlane • Vehicle Details</title>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <link rel="icon" type="image/x-icon" href="favicon.ico">
  <script src="auth.js"></script>
  <style>
    :root{
      --ml-blue:#1e66ff;
      --text:#1f2937;
      --muted:#6b7280;
      --ok:#10b981;
      --warn:#f59e0b;
      --bad:#ef4444;
      --panel:rgba(255,255,255,0.80);
      --bg:#e6e8eb;
    }
    html,body{
      height:100%;margin:0;
      background:var(--bg) url('Mostlane_Embossed.png') no-repeat center center fixed;
      background-size:180%;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      color:var(--text);
    }
    body{
      display:flex;
      justify-content:center;
      align-items:flex-start;
    }
    .shell{
      width:100%;
      max-width:1280px;
      margin:20px;
      display:flex;
      gap:18px;
    }
    .sidebar{
      width:260px;
      background:var(--panel);
      border-radius:14px;
      box-shadow:0 10px 30px rgba(0,0,0,0.12);
      padding:16px 14px;
      box-sizing:border-box;
      display:flex;
      flex-direction:column;
      gap:12px;
    }
    .veh-header-reg{
      font-size:20px;
      font-weight:700;
      letter-spacing:0.08em;
    }
    .veh-header-meta{
      font-size:13px;
      color:var(--muted);
      margin-top:2px;
    }
    .veh-pill{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:4px 10px;
      border-radius:999px;
      font-size:11px;
      background:#eef2ff;
      color:#3730a3;
      margin-top:8px;
    }
    .nav-label{
      font-size:11px;
      text-transform:uppercase;
      letter-spacing:0.08em;
      color:var(--muted);
      margin-top:10px;
      margin-bottom:2px;
    }
    .nav-list{
      display:flex;
      flex-direction:column;
      gap:4px;
    }
    .nav-item{
      border-radius:8px;
      padding:8px 10px;
      font-size:14px;
      cursor:pointer;
      display:flex;
      justify-content:space-between;
      align-items:center;
    }
    .nav-item span.small{
      font-size:11px;
      color:var(--muted);
    }
    .nav-item.active{
      background:var(--ml-blue);
      color:#fff;
    }
    .nav-item:not(.active):hover{
      background:rgba(30,102,255,0.06);
    }
    .nav-footer{
      margin-top:auto;
      font-size:11px;
      color:var(--muted);
    }
    .nav-footer button{
      margin-top:8px;
      width:100%;
      border:none;
      padding:8px 10px;
      border-radius:8px;
      font-size:13px;
      font-weight:600;
      background:#fff;
      color:var(--ml-blue);
      cursor:pointer;
      border:1px solid rgba(30,102,255,0.4);
    }

    .content{
      flex:1;
      background:var(--panel);
      border-radius:14px;
      box-shadow:0 10px 30px rgba(0,0,0,0.12);
      padding:18px 18px 24px;
      box-sizing:border-box;
      min-width:0;
    }
    .content-head{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
      margin-bottom:14px;
    }
    .content-title{
      font-size:18px;
      font-weight:650;
    }
    .content-actions{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
    }
    .btn{
      border:none;
      border-radius:8px;
      padding:8px 11px;
      font-size:13px;
      font-weight:600;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      gap:6px;
      background:#fff;
      color:var(--ml-blue);
      border:1px solid rgba(30,102,255,0.5);
    }
    .btn.primary{
      background:var(--ml-blue);
      color:#fff;
      border-color:var(--ml-blue);
    }
    .btn.ghost{
      background:transparent;
      border:none;
      color:var(--muted);
    }

    .section{
      display:none;
    }
    .section.active{
      display:block;
    }

    .grid{
      display:grid;
      grid-template-columns:repeat(2,minmax(0,1fr));
      gap:14px;
    }
    .card{
      background:#fff;
      border-radius:12px;
      padding:12px 12px 10px;
      box-shadow:0 2px 8px rgba(0,0,0,0.08);
    }
    .card-head{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:6px;
    }
    .card-title{
      font-size:14px;
      font-weight:600;
    }
    .card-sub{
      font-size:11px;
      color:var(--muted);
    }
    .badge{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      padding:2px 8px;
      border-radius:999px;
      font-size:11px;
      font-weight:600;
    }
    .badge.ok{background:#ecfdf3;color:#166534;}
    .badge.warn{background:#fffbeb;color:#92400e;}
    .badge.bad{background:#fef2f2;color:#b91c1c;}
    .badge.info{background:#eef2ff;color:#3730a3;}

    .stats-row{
      display:flex;
      justify-content:space-between;
      font-size:13px;
      margin:2px 0;
    }
    .stats-row span.label{
      color:var(--muted);
    }
    .stats-row span.value{
      font-weight:600;
    }

    table{
      width:100%;
      border-collapse:collapse;
      font-size:13px;
      margin-top:4px;
    }
    th,td{
      text-align:left;
      padding:6px 4px;
    }
    th{
      font-size:11px;
      text-transform:uppercase;
      letter-spacing:0.06em;
      color:var(--muted);
      border-bottom:1px solid #e5e7eb;
    }
    tbody tr:nth-child(even){
      background:#f9fafb;
    }

    .tag-row{
      display:flex;
      flex-wrap:wrap;
      gap:6px;
      margin:6px 0 4px;
      font-size:11px;
    }
    .tag{
      padding:3px 8px;
      border-radius:999px;
      background:#f3f4f6;
      color:#374151;
      cursor:pointer;
    }
    .tag.active{
      background:#1e40af;
      color:#fff;
    }
    .gallery{
      display:grid;
      grid-template-columns:repeat(auto-fill,minmax(80px,1fr));
      gap:6px;
      margin-top:6px;
    }
    .gallery img{
      width:100%;
      height:70px;
      object-fit:cover;
      border-radius:8px;
      border:1px solid #e5e7eb;
      background:#e5e7eb;
    }

    .pill-list{
      display:flex;
      flex-wrap:wrap;
      gap:6px;
      margin-top:4px;
      font-size:11px;
    }
    .pill{
      padding:3px 8px;
      border-radius:999px;
      background:#f3f4f6;
      color:#111827;
    }

    .muted-text{
      font-size:12px;
      color:var(--muted);
    }

    /* Simple modal */
    .modal-backdrop{
      position:fixed;
      inset:0;
      background:rgba(15,23,42,0.45);
      display:none;
      justify-content:center;
      align-items:center;
      z-index:50;
    }
    .modal{
      background:#ffffff;
      border-radius:12px;
      padding:14px 14px 12px;
      max-width:420px;
      width:100%;
      box-shadow:0 20px 45px rgba(0,0,0,0.25);
      box-sizing:border-box;
    }
    .modal h3{
      margin:0 0 4px;
      font-size:15px;
    }
    .modal p{
      margin:0 0 8px;
      font-size:12px;
      color:var(--muted);
    }
    .modal form{
      display:flex;
      flex-direction:column;
      gap:8px;
      margin-top:6px;
    }
    .modal label{
      font-size:12px;
      font-weight:500;
    }
    .modal input,.modal select,.modal textarea{
      font-size:13px;
      padding:7px 8px;
      border-radius:8px;
      border:1px solid #d1d5db;
      width:100%;
      box-sizing:border-box;
    }
    .modal textarea{
      min-height:70px;
      resize:vertical;
    }
    .modal-actions{
      display:flex;
      justify-content:flex-end;
      gap:8px;
      margin-top:10px;
    }

    @media (max-width: 960px){
      .shell{
        flex-direction:column;
        margin:12px;
      }
      .sidebar{
        width:100%;
        flex-direction:column;
      }
      .sidebar-nav-row{
        display:flex;
        flex-wrap:wrap;
        gap:6px;
        margin-top:4px;
      }
      .nav-list{
        flex-direction:row;
        overflow-x:auto;
        padding-bottom:4px;
      }
      .nav-item{
        white-space:nowrap;
      }
      .content{
        margin-top:8px;
      }
      .grid{
        grid-template-columns:1fr;
      }
    }
  </style>
</head>
<body>

<div class="shell">
  <!-- SIDEBAR -->
  <aside class="sidebar">
    <div>
      <div class="veh-header-reg" id="vehReg">WP64 EJD</div>
      <div class="veh-header-meta" id="vehMeta">
        Transit Custom • Diesel • Euro 6
      </div>
      <div class="veh-pill" id="vehDriver">
        Driver: <strong>Jamie Line</strong>
      </div>
    </div>

    <div class="nav-label">Sections</div>
    <div class="nav-list">
      <div class="nav-item active" data-section="overview">
        Overview <span class="small">Summary</span>
      </div>
      <div class="nav-item" data-section="checks">
        Checks &amp; Photos <span class="small">JotForm / R2</span>
      </div>
      <div class="nav-item" data-section="services">
        Services &amp; Repairs <span class="small">History</span>
      </div>
      <div class="nav-item" data-section="fuel">
        Fuel &amp; MPG <span class="small">Performance</span>
      </div>
      <div class="nav-item" data-section="finance">
        Finance <span class="small">Lease / HP</span>
      </div>
      <div class="nav-item" data-section="drivers">
        Drivers &amp; Handover <span class="small">History</span>
      </div>
      <div class="nav-item" data-section="docs">
        Documents <span class="small">All files</span>
      </div>
    </div>

    <div class="nav-footer">
      <div>Vehicle config and limits will later come from your secure USER_CONFIG_KV / VEHICLE_CONFIG_KV worker.</div>
      <button onclick="window.location.href='vehicles.html'">Back to Fleet Dashboard</button>
    </div>
  </aside>

  <!-- MAIN CONTENT -->
  <main class="content">
    <div class="content-head">
      <div class="content-title" id="sectionTitle">Overview</div>
      <div class="content-actions">
        <button class="btn ghost" onclick="window.location.href='main.html'">Main Menu</button>
        <button class="btn" onclick="refreshView()">Refresh</button>
      </div>
    </div>

    <!-- OVERVIEW -->
    <section class="section active" data-section="overview">
      <div class="grid">
        <div class="card">
          <div class="card-head">
            <div>
              <div class="card-title">Service &amp; MOT Status</div>
              <div class="card-sub">Automatic reminders driven by KV</div>
            </div>
            <span class="badge ok" id="serviceBadge">OK</span>
          </div>
          <div class="stats-row">
            <span class="label">Next Service Date</span>
            <span class="value" id="nextServiceDate">01 Feb 2025</span>
          </div>
          <div class="stats-row">
            <span class="label">Next Service Mileage</span>
            <span class="value" id="nextServiceMiles">42,000</span>
          </div>
          <div class="stats-row">
            <span class="label">Next MOT Date</span>
            <span class="value" id="nextMOTDate">12 Sep 2025</span>
          </div>
          <div class="stats-row">
            <span class="label">Last Service</span>
            <span class="value" id="lastService">10 Aug 2024 @ 36,000</span>
          </div>
          <p class="muted-text">Service/MOT reminders will be sent by a daily cron Worker to you and the current driver.</p>
        </div>

        <div class="card">
          <div class="card-head">
            <div>
              <div class="card-title">Usage Snapshot</div>
              <div class="card-sub">Rolling picture from van checks + fuel</div>
            </div>
            <span class="badge info">Last 30 days</span>
          </div>
          <div class="stats-row">
            <span class="label">Total Miles</span>
            <span class="value" id="snapMiles">1,250</span>
          </div>
          <div class="stats-row">
            <span class="label">Average MPG</span>
            <span class="value" id="snapMPG">34.8</span>
          </div>
          <div class="stats-row">
            <span class="label">Fuel Spend</span>
            <span class="value" id="snapFuelCost">£410</span>
          </div>
          <div class="stats-row">
            <span class="label">Checks Completed</span>
            <span class="value" id="snapChecks">4</span>
          </div>
          <p class="muted-text">These numbers will eventually be calculated from fuel-card entries and odometer photos.</p>
        </div>
      </div>
    </section>

    <!-- CHECKS & PHOTOS -->
    <section class="section" data-section="checks">
      <div class="card">
        <div class="card-head">
          <div>
            <div class="card-title">Weekly Van Checks</div>
            <div class="card-sub">Pulled from JotForm + stored in R2</div>
          </div>
          <button class="btn" onclick="openLatestCheck()">Open Latest Check</button>
        </div>
        <table>
          <thead>
            <tr>
              <th>Date</th>
              <th>Odometer</th>
              <th>Issues</th>
              <th>Completed By</th>
              <th>View PDF</th>
            </tr>
          </thead>
          <tbody id="checksTable">
            <!-- rows populated by JS later -->
          </tbody>
        </table>
      </div>

      <div class="card" style="margin-top:10px;">
        <div class="card-head">
          <div>
            <div class="card-title">Photo Timeline</div>
            <div class="card-sub">Grouped by zone (e.g. NSF Wheel, Interior, Damage)</div>
          </div>
        </div>
        <div class="tag-row" id="photoFilters">
          <div class="tag active" data-tag="all">All</div>
          <div class="tag" data-tag="interior">Interior</div>
          <div class="tag" data-tag="nsf-wheel">NSF Wheel</div>
          <div class="tag" data-tag="osf-wheel">OSF Wheel</div>
          <div class="tag" data-tag="damage">Damage</div>
          <div class="tag" data-tag="tyres">Tyres</div>
        </div>
        <div class="gallery" id="photoGallery">
          <!-- images populated from R2 via Worker -->
        </div>
        <p class="muted-text">Later, each image will be tagged by JotForm ("Interior", "NSF Wheel", etc.) and displayed here newest-first.</p>
      </div>
    </section>

    <!-- SERVICES & REPAIRS -->
    <section class="section" data-section="services">
      <div class="card">
        <div class="card-head">
          <div>
            <div class="card-title">Service &amp; Repair History</div>
            <div class="card-sub">All invoices linked to SharePoint</div>
          </div>
          <button class="btn primary" onclick="openWorksModal()">Add Works</button>
        </div>
        <table>
          <thead>
            <tr>
              <th>Date</th>
              <th>Type</th>
              <th>Description</th>
              <th>Cost</th>
              <th>Centre</th>
              <th>Invoice</th>
            </tr>
          </thead>
          <tbody id="worksTable">
            <!-- JS populated -->
          </tbody>
        </table>
        <p class="muted-text">Types will be: Service, MOT, Tyres, Windscreen, Other. Each row will have a “View” button opening the stored invoice PDF.</p>
      </div>
    </section>

    <!-- FUEL & MPG -->
    <section class="section" data-section="fuel">
      <div class="grid">
        <div class="card">
          <div class="card-head">
            <div>
              <div class="card-title">Fuel Performance</div>
              <div class="card-sub">From fuel card entries and odometer</div>
            </div>
          </div>
          <div class="stats-row">
            <span class="label">Average MPG (last 90 days)</span>
            <span class="value" id="avgMPG">35.2</span>
          </div>
          <div class="stats-row">
            <span class="label">Best MPG Period</span>
            <span class="value" id="bestMPG">40.1</span>
          </div>
          <div class="stats-row">
            <span class="label">Worst MPG Period</span>
            <span class="value" id="worstMPG">29.4</span>
          </div>
          <p class="muted-text">This page will later cross-reference fuel card quantity/cost with mileage from van checks.</p>
        </div>
        <div class="card">
          <div class="card-head">
            <div>
              <div class="card-title">Fuel Entries</div>
              <div class="card-sub">Manual input from invoices</div>
            </div>
            <button class="btn" onclick="openFuelModal()">Add Fuel Entry</button>
          </div>
          <table>
            <thead>
              <tr>
                <th>Date</th>
                <th>Litres</th>
                <th>Cost</th>
                <th>Odometer</th>
                <th>Invoice</th>
              </tr>
            </thead>
            <tbody id="fuelTable">
              <!-- fuel rows here -->
            </tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- FINANCE -->
    <section class="section" data-section="finance">
      <div class="grid">
        <div class="card">
          <div class="card-head">
            <div>
              <div class="card-title">Finance Summary</div>
              <div class="card-sub">Lease / HP details</div>
            </div>
            <button class="btn" onclick="openFinanceModal()">Edit Finance</button>
          </div>
          <div class="stats-row">
            <span class="label">Finance Company</span>
            <span class="value" id="finCompany">Lex Autolease</span>
          </div>
          <div class="stats-row">
            <span class="label">Monthly Payment</span>
            <span class="value" id="finMonthly">£420</span>
          </div>
          <div class="stats-row">
            <span class="label">Balloon / Final</span>
            <span class="value" id="finBalloon">£9,500</span>
          </div>
          <div class="stats-row">
            <span class="label">Start / End</span>
            <span class="value" id="finTerm">01 Jan 2024 – 31 Dec 2027</span>
          </div>
          <div class="stats-row">
            <span class="label">Estimated Equity</span>
            <span class="value" id="finEquity">£2,800</span>
          </div>
          <p class="muted-text">We’ll later add a simple amortisation / equity estimator so you can quickly see which vans are cheap to keep or ripe to replace.</p>
        </div>
        <div class="card">
          <div class="card-head">
            <div>
              <div class="card-title">Running Cost Snapshot</div>
              <div class="card-sub">Finance + fuel + maintenance</div>
            </div>
          </div>
          <div class="stats-row">
            <span class="label">Monthly Finance</span>
            <span class="value">£420</span>
          </div>
          <div class="stats-row">
            <span class="label">Avg Monthly Fuel</span>
            <span class="value">£380</span>
          </div>
          <div class="stats-row">
            <span class="label">Avg Maintenance</span>
            <span class="value">£95</span>
          </div>
          <div class="stats-row">
            <span class="label">Total Running Cost</span>
            <span class="value">£895</span>
          </div>
          <p class="muted-text">These will later be driven from the works &amp; fuel tables plus the finance record.</p>
        </div>
      </div>
    </section>

    <!-- DRIVERS & HANDOVER -->
    <section class="section" data-section="drivers">
      <div class="card">
        <div class="card-head">
          <div>
            <div class="card-title">Driver History</div>
            <div class="card-sub">Who had this van and when</div>
          </div>
          <button class="btn primary" onclick="openAssignDriverModal()">Assign Driver</button>
        </div>
        <table>
          <thead>
            <tr>
              <th>Driver</th>
              <th>From</th>
              <th>To</th>
              <th>Handover</th>
            </tr>
          </thead>
          <tbody id="driverTable">
            <!-- JS -->
          </tbody>
        </table>
        <p class="muted-text">Each time you assign a new driver, you can optionally trigger the Van Handover JotForm. Zapier will save the signed PDF to SharePoint and we’ll show a “View” button here.</p>
      </div>
    </section>

    <!-- DOCUMENTS -->
    <section class="section" data-section="docs">
      <div class="card">
        <div class="card-head">
          <div>
            <div class="card-title">All Documents</div>
            <div class="card-sub">Central index of everything for this van</div>
          </div>
          <button class="btn" onclick="openUploadDocModal()">Upload Document</button>
        </div>
        <table>
          <thead>
            <tr>
              <th>Type</th>
              <th>Description</th>
              <th>Date</th>
              <th>Source</th>
              <th>Link</th>
            </tr>
          </thead>
          <tbody id="docsTable">
            <!-- JS -->
          </tbody>
        </table>
        <p class="muted-text">This will include: van checks, handover forms, service invoices, tyre invoices, windscreen, insurance docs, etc. All via SharePoint / R2 links.</p>
      </div>
    </section>
  </main>
</div>

<!-- MODALS (skeletons, to be wired later) -->
<div class="modal-backdrop" id="worksModal">
  <div class="modal">
    <h3>Add Works</h3>
    <p>Log a Service, MOT, Tyres, Windscreen or Other work item for this vehicle.</p>
    <form>
      <div>
        <label>Type</label>
        <select id="workType">
          <option value="Service">Service</option>
          <option value="MOT">MOT</option>
          <option value="Tyres">Tyres</option>
          <option value="Windscreen">Windscreen</option>
          <option value="Other">Other</option>
        </select>
      </div>
      <div>
        <label>Date</label>
        <input type="date" id="workDate">
      </div>
      <div>
        <label>Cost (£)</label>
        <input type="number" step="0.01" min="0" id="workCost">
      </div>
      <div>
        <label>Service Centre</label>
        <input type="text" id="workCentre" placeholder="Kwik Fit, Main Dealer, etc.">
      </div>
      <div>
        <label>Description</label>
        <textarea id="workDesc" placeholder="What was done?"></textarea>
      </div>
      <div>
        <label>SharePoint Invoice URL</label>
        <input type="url" id="workInvoiceURL" placeholder="https://...">
      </div>
    </form>
    <div class="modal-actions">
      <button class="btn ghost" onclick="closeModal('worksModal')">Cancel</button>
      <button class="btn primary" onclick="saveWorks()">Save</button>
    </div>
  </div>
</div>

<!-- (Other modals for fuel, finance, assign driver, upload doc etc. can follow same pattern) -->

<script>
  // Gate
  if (sessionStorage.getItem("mostlaneLoggedIn") !== "true") {
    window.location.href = "login.html";
  }

  function setActiveSection(section){
    document.querySelectorAll('.nav-item').forEach(el=>{
      el.classList.toggle('active', el.dataset.section===section);
    });
    document.querySelectorAll('.section').forEach(el=>{
      el.classList.toggle('active', el.dataset.section===section);
    });
    const mapTitle = {
      overview:"Overview",
      checks:"Checks & Photos",
      services:"Services & Repairs",
      fuel:"Fuel & MPG",
      finance:"Finance",
      drivers:"Drivers & Handover",
      docs:"Documents"
    };
    document.getElementById('sectionTitle').textContent = mapTitle[section] || "Vehicle";
  }

  document.querySelectorAll('.nav-item').forEach(el=>{
    el.addEventListener('click', ()=>{
      setActiveSection(el.dataset.section);
    });
  });

  function refreshView(){
    // later: re-fetch vehicle JSON and re-render
    console.log("Refresh requested");
  }

  function openWorksModal(){ document.getElementById('worksModal').style.display='flex'; }
  function closeModal(id){ document.getElementById(id).style.display='none'; }

  function saveWorks(){
    // placeholder: later call Worker to save
    alert("Works will be saved via vehicle Worker (to KV + link to SharePoint invoice).");
    closeModal('worksModal');
  }

  function openLatestCheck(){
    // later: open latest van check PDF or details
    alert("This will open the most recent Weekly Van Check PDF.");
  }

  function openFuelModal(){
    alert("Fuel entry modal to be wired later.");
  }

  function openFinanceModal(){
    alert("Finance edit modal to be wired later.");
  }

  function openAssignDriverModal(){
    alert("Assign driver + send handover form modal to be wired later.");
  }

  function openUploadDocModal(){
    alert("Upload document modal to be wired later (Zapier → SharePoint/R2).");
  }
</script>
</body>
</html>
