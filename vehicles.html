<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>Mostlane • Vehicles</title>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <link rel="icon" type="image/x-icon" href="favicon.ico">
  <script src="auth.js"></script>
  <style>
    :root{
      --ml-blue:#003b82;
      --ml-blue-light:#1e66ff;
      --text:#0f172a;
      --muted:#6b7280;
      --ok:#16a34a;
      --warn:#f97316;
      --bad:#dc2626;
      --panel:rgba(255,255,255,0.9);
    }
    html,body{
      height:100%;margin:0;
      background:#0b1930 url('Mostlane_Embossed.png') no-repeat center center fixed;
      background-size:180%;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      color:var(--text);
    }
    body{padding:16px;}
    .wrap{
      max-width:1200px;
      margin:0 auto;
      background:var(--panel);
      border-radius:16px;
      box-shadow:0 18px 45px rgba(0,0,0,0.35);
      overflow:hidden;
    }
    .header{
      background:linear-gradient(135deg,#001a3d,#003b82);
      color:#e5ecff;
      padding:16px 20px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:12px;
      flex-wrap:wrap;
    }
    .header-title{
      font-size:20px;
      font-weight:700;
      letter-spacing:0.04em;
      text-transform:uppercase;
    }
    .header-sub{
      font-size:12px;
      opacity:0.8;
    }
    .header-actions{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      align-items:center;
    }
    .btn{
      border:none;
      border-radius:999px;
      padding:8px 14px;
      font-size:13px;
      font-weight:600;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      gap:6px;
      white-space:nowrap;
    }
    .btn.primary{
      background:#1e66ff;
      color:#fff;
    }
    .btn.secondary{
      background:rgba(15,23,42,0.12);
      color:#e5ecff;
      border:1px solid rgba(148,163,184,0.4);
    }
    .btn.icon-only{
      padding:6px 8px;
      border-radius:999px;
    }
    .content{
      padding:14px 18px 18px;
    }
    .toolbar{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
      margin-bottom:10px;
    }
    .pill-field{
      display:flex;
      align-items:center;
      padding:6px 10px;
      border-radius:999px;
      background:#f1f5f9;
      border:1px solid #cbd5f5;
      gap:6px;
      font-size:13px;
    }
    .pill-field input{
      border:none;
      background:transparent;
      outline:none;
      font-size:13px;
      min-width:120px;
    }
    .pill-label{
      font-size:11px;
      text-transform:uppercase;
      letter-spacing:0.08em;
      color:#64748b;
    }
    .summary-strip{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      margin:4px 0 12px;
    }
    .summary-card{
      flex:1 1 120px;
      min-width:120px;
      background:#0f172a;
      color:#e5ecff;
      border-radius:12px;
      padding:10px 12px;
      position:relative;
      overflow:hidden;
    }
    .summary-card::after{
      content:"";
      position:absolute;
      right:-20px;top:-20px;
      width:60px;height:60px;
      background:radial-gradient(circle at center,rgba(129,140,248,0.45),transparent 70%);
      opacity:0.8;
    }
    .summary-label{
      font-size:11px;
      text-transform:uppercase;
      letter-spacing:0.08em;
      opacity:0.8;
    }
    .summary-value{
      font-size:18px;
      font-weight:700;
      margin-top:4px;
    }
    .summary-note{
      font-size:11px;
      opacity:0.7;
      margin-top:2px;
    }

    .grid{
      display:grid;
      grid-template-columns:repeat(auto-fill,minmax(260px,1fr));
      gap:12px;
    }
    .card{
      background:#ffffff;
      border-radius:14px;
      box-shadow:0 8px 18px rgba(15,23,42,0.12);
      padding:12px 12px 10px;
      display:flex;
      flex-direction:column;
      gap:6px;
      border:1px solid #e2e8f0;
      position:relative;
    }
    .reg-row{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:6px;
    }
    .reg{
      font-size:16px;
      font-weight:800;
      letter-spacing:0.15em;
      text-transform:uppercase;
      color:#0f172a;
      background:#e2e8f0;
      padding:4px 8px;
      border-radius:6px;
      border:1px solid #cbd5f5;
    }
    .driver{
      font-size:13px;
      color:#0f172a;
      font-weight:600;
    }
    .driver span{
      color:#64748b;
      font-weight:500;
    }
    .meta{
      font-size:12px;
      color:#475569;
      display:flex;
      flex-wrap:wrap;
      gap:6px 12px;
    }
    .meta span{
      display:flex;
      align-items:center;
      gap:4px;
    }
    .dot{
      width:6px;height:6px;border-radius:999px;background:#94a3b8;
    }
    .status-row{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:4px;
      margin-top:2px;
    }
    .tag{
      padding:2px 8px;
      border-radius:999px;
      font-size:11px;
      font-weight:600;
      display:inline-flex;
      align-items:center;
      gap:4px;
    }
    .tag.ok{background:#dcfce7;color:#166534;}
    .tag.warn{background:#fef3c7;color:#92400e;}
    .tag.bad{background:#fee2e2;color:#b91c1c;}
    .tag.info{background:#e0f2fe;color:#075985;}
    .tag-dot{
      width:6px;height:6px;border-radius:999px;
    }
    .tag-dot.ok{background:#16a34a;}
    .tag-dot.warn{background:#f97316;}
    .tag-dot.bad{background:#dc2626;}
    .tag-dot.info{background:#0284c7;}

    .card-actions{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:6px;
      margin-top:8px;
    }
    .btn-ghost{
      border:none;
      background:transparent;
      font-size:12px;
      color:#1e40af;
      display:inline-flex;
      align-items:center;
      gap:4px;
      padding:4px 6px;
      border-radius:999px;
      cursor:pointer;
    }
    .btn-ghost:hover{
      background:#e0ecff;
    }
    .btn-pill{
      border:none;
      border-radius:999px;
      font-size:12px;
      font-weight:600;
      padding:4px 10px;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      gap:6px;
    }
    .btn-pill.main{
      background:#1d4ed8;
      color:#fff;
    }
    .btn-pill.sub{
      background:#f8fafc;
      color:#1e293b;
      border:1px solid #cbd5f5;
    }

    .status-text{
      font-size:11px;
      color:#64748b;
      display:flex;
      align-items:center;
      gap:4px;
    }

    .pill-small{
      font-size:11px;
      padding:2px 6px;
      border-radius:999px;
      background:#f1f5f9;
      color:#475569;
    }

    .footer-line{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-top:12px;
      font-size:11px;
      color:#64748b;
      border-top:1px dashed #e2e8f0;
      padding-top:8px;
    }

    /* Modal */
    .modal-backdrop{
      position:fixed;
      inset:0;
      background:rgba(15,23,42,0.55);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:50;
    }
    .modal{
      background:#ffffff;
      border-radius:14px;
      max-width:420px;
      width:92%;
      padding:14px 16px;
      box-shadow:0 22px 50px rgba(15,23,42,0.4);
    }
    .modal-header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:8px;
    }
    .modal-title{
      font-size:15px;
      font-weight:700;
      color:#0f172a;
    }
    .modal-body{
      font-size:13px;
      color:#0f172a;
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    .modal-row label{
      font-size:12px;
      font-weight:600;
      color:#4b5563;
      display:block;
      margin-bottom:2px;
    }
    .modal-row input{
      width:100%;
      padding:7px 9px;
      border-radius:8px;
      border:1px solid #d1d5db;
      font-size:13px;
    }
    .modal-footer{
      display:flex;
      justify-content:flex-end;
      gap:8px;
      margin-top:10px;
    }
    .chip-role{
      display:inline-flex;
      align-items:center;
      gap:4px;
      padding:2px 8px;
      border-radius:999px;
      font-size:11px;
      background:#eff6ff;
      color:#1d4ed8;
      margin-right:4px;
    }
    .chip-role span{
      font-size:14px;
      cursor:pointer;
    }

    @media(max-width:720px){
      .header{
        align-items:flex-start;
      }
      .header-title{
        font-size:18px;
      }
      .summary-card{
        padding:8px 10px;
      }
      .reg{
        font-size:14px;
      }
      .driver{
        font-size:12px;
      }
      .btn-pill.main{
        padding:4px 8px;
        font-size:11px;
      }
      .btn-pill.sub{
        padding:3px 8px;
        font-size:11px;
      }
      .btn-ghost{
        font-size:11px;
      }
    }
  </style>
</head>
<body>

<div class="wrap">
  <div class="header">
    <div>
      <div class="header-title">Vehicle Fleet</div>
      <div class="header-sub">Live overview of all vans and their current drivers.</div>
    </div>
    <div class="header-actions">
      <button class="btn secondary" onclick="goMain()">← Main Menu</button>
      <button class="btn primary" onclick="reloadFleet()">
        ⟳ Refresh
      </button>
    </div>
  </div>

  <div class="content">
    <div class="toolbar">
      <div class="pill-field">
        <span class="pill-label">Search</span>
        <input id="searchInput" placeholder="Reg, driver, model..." oninput="renderFleet()">
      </div>
      <div class="pill-field">
        <span class="pill-label">Filter</span>
        <select id="filterActive" onchange="renderFleet()" style="border:none;background:transparent;font-size:13px;">
          <option value="all">All vehicles</option>
          <option value="active">Active only</option>
          <option value="inactive">Inactive only</option>
        </select>
      </div>
    </div>

    <div class="summary-strip">
      <div class="summary-card">
        <div class="summary-label">Total Vehicles</div>
        <div class="summary-value" id="sumTotal">0</div>
        <div class="summary-note">Across whole fleet</div>
      </div>
      <div class="summary-card">
        <div class="summary-label">Active</div>
        <div class="summary-value" id="sumActive">0</div>
        <div class="summary-note">Currently in service</div>
      </div>
      <div class="summary-card">
        <div class="summary-label">Unassigned</div>
        <div class="summary-value" id="sumUnassigned">0</div>
        <div class="summary-note">No primary driver set</div>
      </div>
    </div>

    <div class="grid" id="fleetGrid">
      <!-- cards injected here -->
    </div>

    <div class="footer-line">
      <span id="statusLine">Loading fleet…</span>
      <span>Mostlane • Vehicles</span>
    </div>
  </div>
</div>

<!-- Permissions Modal -->
<div class="modal-backdrop" id="permBackdrop">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title" id="permTitle">Permissions</div>
      <button class="btn icon-only" onclick="closePermModal()">✕</button>
    </div>
    <div class="modal-body">
      <div style="font-size:12px;color:#6b7280;">
        Viewers can see this vehicle. Editors can change details and history.
      </div>
      <div class="modal-row">
        <label>View Access (comma separated)</label>
        <input id="permViewInput" placeholder="director, admin, office, Jamie.Line">
        <div style="margin-top:4px;">
          <span class="chip-role" onclick="quickAddRole('director')">director <span>＋</span></span>
          <span class="chip-role" onclick="quickAddRole('admin')">admin <span>＋</span></span>
          <span class="chip-role" onclick="quickAddRole('office')">office <span>＋</span></span>
        </div>
      </div>
      <div class="modal-row">
        <label>Edit Access (comma separated)</label>
        <input id="permEditInput" placeholder="director, admin">
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn secondary" onclick="closePermModal()">Cancel</button>
      <button class="btn primary" onclick="savePermissions()">Save</button>
    </div>
  </div>
</div>

<script>
  // BASIC AUTH GATE
  if (sessionStorage.getItem("mostlaneLoggedIn") !== "true") {
    window.location.href = "login.html";
  }

  const VEHICLE_WORKER = "https://vehicles.jamie-def.workers.dev"; // <- set your worker URL
  const CURRENT_USER = sessionStorage.getItem("mostlaneUser") || "";
  const IS_ADMIN = CURRENT_USER === "Jamie.Line"; // adjust when you add roles

  let FLEET = [];
  let PERM_EDIT_REG = null;

  function goMain(){
    window.location.href = "main.html";
  }

  function setStatus(msg){
    document.getElementById("statusLine").textContent = msg;
  }

  async function loadFleet(){
    try{
      setStatus("Loading fleet…");
      const res = await fetch(`${VEHICLE_WORKER}/fleet`);
      if (!res.ok) throw new Error("Failed to load fleet");
      const data = await res.json();
      FLEET = Array.isArray(data) ? data : [];

      // update summary
      const total = FLEET.length;
      const active = FLEET.filter(v => v.active !== false).length;
      const unassigned = FLEET.filter(v => !v.driver || !String(v.driver).trim()).length;
      document.getElementById("sumTotal").textContent = total;
      document.getElementById("sumActive").textContent = active;
      document.getElementById("sumUnassigned").textContent = unassigned;

      renderFleet();
      setStatus("Fleet loaded.");
    }catch(e){
      console.error(e);
      setStatus("Could not load fleet.");
    }
  }

  function renderFleet(){
    const grid = document.getElementById("fleetGrid");
    grid.innerHTML = "";
    const q = (document.getElementById("searchInput").value || "").toLowerCase();
    const filt = document.getElementById("filterActive").value;

    let items = FLEET.slice();

    if (q){
      items = items.filter(v => {
        const reg = (v.reg || "").toLowerCase();
        const driver = (v.driver || "").toLowerCase();
        const model = (v.model || "").toLowerCase();
        const make = (v.make || "").toLowerCase();
        return reg.includes(q) || driver.includes(q) || model.includes(q) || make.includes(q);
      });
    }

    if (filt === "active"){
      items = items.filter(v => v.active !== false);
    }else if (filt === "inactive"){
      items = items.filter(v => v.active === false);
    }

    if (!items.length){
      grid.innerHTML = `<div style="font-size:13px;color:#64748b;">No vehicles match your filters.</div>`;
      return;
    }

    for (const v of items){
      const card = document.createElement("div");
      card.className = "card";

      const reg = v.reg || "UNKNOWN";
      const driverDisp = v.driver ? v.driver : "Unassigned";
      const make = v.make || "";
      const model = v.model || "";
      const fuel = v.fuel || "";
      const active = v.active !== false;

      const nextService = v.nextServiceDate || "";
      const motDue = v.motDue || "";
      const issues = v.issuesCount || 0;

      let motTag = `<span class="tag info"><span class="tag-dot info"></span>MOT: n/a</span>`;
      if (motDue){
        motTag = `<span class="tag ${v.motStatus === 'bad' ? 'bad':'warn'}">
          <span class="tag-dot ${v.motStatus === 'bad' ? 'bad':'warn'}"></span>
          MOT: ${motDue}
        </span>`;
      }

      let servTag = `<span class="tag info"><span class="tag-dot info"></span>Service: n/a</span>`;
      if (nextService){
        servTag = `<span class="tag ${v.serviceStatus === 'ok' ? 'ok':'warn'}">
          <span class="tag-dot ${v.serviceStatus === 'ok' ? 'ok':'warn'}"></span>
          Service: ${nextService}
        </span>`;
      }

      const issuesTag = issues > 0
        ? `<span class="tag bad"><span class="tag-dot bad"></span>${issues} issues</span>`
        : `<span class="tag ok"><span class="tag-dot ok"></span>No open issues</span>`;

      const driverLabel = driverDisp.replace(/\./g," ");

      card.innerHTML = `
        <div class="reg-row">
          <div class="reg">${reg}</div>
          <div class="driver"><span>Driver</span><br>${driverLabel}</div>
        </div>
        <div class="meta">
          <span><span class="dot"></span>${make} ${model}</span>
          ${fuel ? `<span><span class="dot"></span>${fuel}</span>` : ""}
          <span><span class="dot"></span>${active ? "Active" : "Inactive"}</span>
        </div>
        <div class="status-row">
          <div>${servTag}</div>
          <div>${motTag}</div>
        </div>
        <div class="status-row">
          <div>${issuesTag}</div>
          <div class="status-text">
            <span class="pill-small">Last updated: ${v.lastUpdated ? new Date(v.lastUpdated).toLocaleDateString() : "—"}</span>
          </div>
        </div>
        <div class="card-actions">
          <div>
            <button class="btn-ghost" onclick="openVehicle('${reg}')">
              Open vehicle
            </button>
          </div>
          <div>
            ${IS_ADMIN ? `
              <button class="btn-pill sub" onclick="openPermissions('${reg}')">
                Permissions
              </button>
            ` : ""}
            <button class="btn-pill main" onclick="openVehicle('${reg}')">
              Details →
            </button>
          </div>
        </div>
      `;

      grid.appendChild(card);
    }
  }

  function openVehicle(reg){
    window.location.href = `vehicle.html?reg=${encodeURIComponent(reg)}`;
  }

  // --- Permissions modal logic ---
  function openPermissions(reg){
    PERM_EDIT_REG = reg;
    const vehicle = FLEET.find(v => v.reg === reg);
    const viewArr = (vehicle && Array.isArray(vehicle.allowedViewers)) ? vehicle.allowedViewers : [];
    const editArr = (vehicle && Array.isArray(vehicle.allowedEditors)) ? vehicle.allowedEditors : [];

    document.getElementById("permTitle").textContent = `Permissions – ${reg}`;
    document.getElementById("permViewInput").value = viewArr.join(", ");
    document.getElementById("permEditInput").value = editArr.join(", ");

    document.getElementById("permBackdrop").style.display = "flex";
  }

  function closePermModal(){
    document.getElementById("permBackdrop").style.display = "none";
    PERM_EDIT_REG = null;
  }

  function quickAddRole(role){
    const inp = document.getElementById("permViewInput");
    const current = inp.value.split(",").map(x => x.trim()).filter(Boolean);
    if (!current.includes(role)){
      current.push(role);
      inp.value = current.join(", ");
    }
  }

  async function savePermissions(){
    if (!PERM_EDIT_REG) return;
    const viewStr = document.getElementById("permViewInput").value || "";
    const editStr = document.getElementById("permEditInput").value || "";
    const allowedViewers = viewStr.split(",").map(x => x.trim()).filter(Boolean);
    const allowedEditors = editStr.split(",").map(x => x.trim()).filter(Boolean);

    try{
      setStatus("Saving permissions…");
      const body = { reg: PERM_EDIT_REG, allowedViewers, allowedEditors };
      const res = await fetch(`${VEHICLE_WORKER}/update-permissions`, {
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body:JSON.stringify(body)
      });
      if (!res.ok) throw new Error("Failed to save");
      const updated = await res.json();
      // Update local FLEET entry
      const idx = FLEET.findIndex(v => v.reg === PERM_EDIT_REG);
      if (idx !== -1){
        FLEET[idx].allowedViewers = allowedViewers;
        FLEET[idx].allowedEditors = allowedEditors;
      }
      setStatus("Permissions saved.");
      closePermModal();
    }catch(e){
      console.error(e);
      setStatus("Failed to save permissions.");
      alert("Could not save permissions.");
    }
  }

  function reloadFleet(){
    loadFleet();
  }

  window.addEventListener("DOMContentLoaded", loadFleet);
</script>

</body>
</html>
