<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>Mostlane • Vehicles</title>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <link rel="icon" type="image/x-icon" href="favicon.ico">
  <script src="auth.js"></script>
  <style>
:root{
  --ml-blue:#003b82;
  --ml-blue-light:#1e66ff;
  --text:#0f172a;
  --muted:#6b7280;
  --ok:#16a34a;
  --warn:#f97316;
  --bad:#dc2626;
  --panel:rgba(255,255,255,0.9);
}

/* ----- FIXED BACKGROUND (FULLY SAFE) ----- */
html,body{
  height:100%;
  margin:0;
  font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
  color:var(--text);
  background:#0b1930; /* fallback */
}

/* fixed embossed background behind everything */
.bg-fixed{
  position:fixed;
  top:0; left:0; right:0; bottom:0;
  background:#0b1930 url('Mostlane_Embossed.png') no-repeat center center;
  background-size:180%;
  z-index:-9999;
  pointer-events:none;
}

/* Add spacing */
body{ padding:16px; }

/* MAIN WRAPPER */
.wrap{
  max-width:1200px;
  margin:0 auto;
  background:var(--panel);
  border-radius:16px;
  box-shadow:0 18px 45px rgba(0,0,0,0.35);
  overflow:hidden;
  min-height:100vh;
}

/* HEADER */
.header{
  background:linear-gradient(135deg,#001a3d,#003b82);
  color:#e5ecff;
  padding:16px 20px;
  display:flex;
  justify-content:space-between;
  align-items:center;
  gap:12px;
  flex-wrap:wrap;
}

.header-title{
  font-size:20px;
  font-weight:700;
  letter-spacing:0.04em;
  text-transform:uppercase;
}

.header-sub{
  font-size:12px;
  opacity:0.8;
}

.header-actions{
  display:flex;
  gap:8px;
  flex-wrap:wrap;
  align-items:center;
}

/* BUTTONS */
.btn{
  border:none;
  border-radius:999px;
  padding:8px 14px;
  font-size:13px;
  font-weight:600;
  cursor:pointer;
  display:inline-flex;
  align-items:center;
  gap:6px;
  white-space:nowrap;
}
.btn.primary{ background:#1e66ff; color:#fff; }
.btn.secondary{ background:rgba(15,23,42,0.12); color:#e5ecff; border:1px solid rgba(148,163,184,0.4); }

.content{ padding:14px 18px 18px; }

/* FILTERS */
.toolbar{ display:flex; flex-wrap:wrap; gap:10px; align-items:center; margin-bottom:10px; }
.pill-field{ display:flex; align-items:center; padding:6px 10px; border-radius:999px; background:#f1f5f9; border:1px solid #cbd5f5; gap:6px; font-size:13px; }

.pill-field input,
.pill-field select{
  border:none;
  background:transparent;
  outline:none;
  font-size:13px;
  min-width:120px;
}
.pill-label{ font-size:11px; text-transform:uppercase; letter-spacing:0.08em; color:#64748b; }

/* SUMMARY STRIP */
.summary-strip{ display:flex; flex-wrap:wrap; gap:10px; margin:4px 0 12px; }
.summary-card{
  flex:1 1 120px;
  min-width:120px;
  background:#0f172a;
  color:#e5ecff;
  border-radius:12px;
  padding:10px 12px;
  position:relative;
}

.summary-label{ font-size:11px; text-transform:uppercase; letter-spacing:0.08em; opacity:0.8; }
.summary-value{ font-size:18px; font-weight:700; margin-top:4px; }
.summary-note{ font-size:11px; opacity:0.7; margin-top:2px; }

/* GRID */
.grid{ display:grid; grid-template-columns:repeat(auto-fill,minmax(260px,1fr)); gap:12px; }

/* VEHICLE CARD */
.card{
  background:#ffffff;
  border-radius:14px;
  box-shadow:0 8px 18px rgba(15,23,42,0.12);
  padding:12px;
  display:flex;
  flex-direction:column;
  gap:6px;
  border:1px solid #e2e8f0;
}

.reg-row{ display:flex; justify-content:space-between; align-items:center; gap:6px; }
.reg{
  font-size:16px; font-weight:800; letter-spacing:0.15em;
  text-transform:uppercase; color:#0f172a;
  background:#e2e8f0; padding:4px 8px;
  border-radius:6px; border:1px solid #cbd5f5;
}

.driver{ font-size:13px; color:#0f172a; font-weight:600; text-align:right; }
.driver span{ color:#64748b; font-weight:500; }

.meta{ font-size:12px; color:#475569; display:flex; flex-wrap:wrap; gap:6px 12px; }
.dot{ width:6px; height:6px; border-radius:999px; background:#94a3b8; }

.status-row{ display:flex; justify-content:space-between; align-items:center; gap:4px; margin-top:2px; }

.tag{ padding:2px 8px; border-radius:999px; font-size:11px; font-weight:600; display:inline-flex; align-items:center; gap:4px; }
.tag.ok{ background:#dcfce7; color:#166534; }
.tag.warn{ background:#fef3c7; color:#92400e; }
.tag.bad{ background:#fee2e2; color:#b91c1c; }
.tag.info{ background:#e0f2fe; color:#075985; }

.card-actions{ display:flex; justify-content:space-between; align-items:center; gap:6px; margin-top:8px; }
.btn-pill{ border:none; border-radius:999px; font-size:12px; font-weight:600; padding:4px 10px; cursor:pointer; }
.btn-pill.main{ background:#1d4ed8; color:#fff; }
.btn-ghost{ border:none; background:transparent; font-size:12px; color:#1e40af; padding:4px 6px; cursor:pointer; }

.footer-line{ display:flex; justify-content:space-between; align-items:center; margin-top:12px; font-size:11px; color:#64748b; border-top:1px dashed #e2e8f0; padding-top:8px; }

/* MODALS */
.modal-backdrop{
  position:fixed; inset:0;
  background:rgba(0,0,0,0.55);
  display:none; align-items:center; justify-content:center;
  z-index:2000;
}
.modal{
  background:#fff;
  width:90%; max-width:420px;
  border-radius:14px;
  padding:20px 18px;
  box-shadow:0 10px 35px rgba(0,0,0,0.35);
}
.modal-header{
  display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;
}

.modal-row{ display:flex; flex-direction:column; gap:4px; margin-bottom:10px; }
.modal-row input, .modal-row select{
  padding:8px 10px; border-radius:8px; border:1px solid #d1d5db; font-size:14px;
}
.modal-footer{ display:flex; justify-content:flex-end; gap:10px; margin-top:10px; }
  </style>
</head>

<body>
  <div class="bg-fixed"></div>
  <div class="wrap">

    <!-- HEADER -->
    <div class="header">
      <div>
        <div class="header-title">Vehicle Fleet</div>
        <div class="header-sub">Live overview of all vans and their current drivers.</div>
      </div>
      <div class="header-actions">
        <button class="btn secondary" onclick="goMain()">← Main Menu</button>
        <button class="btn primary" onclick="loadFleet()">⟳ Refresh</button>
      </div>
    </div>

    <!-- CONTENT -->
    <div class="content">

      <!-- Filters -->
      <div class="toolbar">
        <div class="pill-field">
          <span class="pill-label">Search</span>
          <input id="searchInput" placeholder="Reg, driver, model..." oninput="renderFleet()">
        </div>

        <div class="pill-field">
          <span class="pill-label">Filter</span>
          <select id="filterActive" onchange="renderFleet()">
            <option value="all">All vehicles</option>
            <option value="active">Active only</option>
            <option value="inactive">Inactive only</option>
          </select>
        </div>
      </div>

      <!-- Summary -->
      <div class="summary-strip">
        <div class="summary-card">
          <div class="summary-label">Total Vehicles</div>
          <div class="summary-value" id="sumTotal">0</div>
          <div class="summary-note">Across whole fleet</div>
        </div>
        <div class="summary-card">
          <div class="summary-label">Active</div>
          <div class="summary-value" id="sumActive">0</div>
          <div class="summary-note">Currently in service</div>
        </div>
        <div class="summary-card">
          <div class="summary-label">Unassigned</div>
          <div class="summary-value" id="sumUnassigned">0</div>
          <div class="summary-note">No primary driver set</div>
        </div>
      </div>

      <!-- Cards -->
      <div class="grid" id="fleetGrid"></div>

      <div class="footer-line">
        <span id="statusLine">Loading fleet…</span>
        <span>Mostlane • Vehicles</span>
      </div>
    </div>

  </div>

  <!-- EDIT MODAL -->
  <div class="modal-backdrop" id="editBackdrop">
    <div class="modal">
      <div class="modal-header">
        <div class="modal-title" id="editTitle">Edit Vehicle</div>
        <button onclick="closeEditModal()">✕</button>
      </div>

      <div class="modal-body">

        <div class="modal-row">
          <label>Registration</label>
          <input id="editReg" readonly>
        </div>

        <div class="modal-row">
          <label>Make</label>
          <input id="editMake">
        </div>

        <div class="modal-row">
          <label>Model</label>
          <input id="editModel">
        </div>

        <div class="modal-row">
          <label>Fuel Type</label>
          <input id="editFuel">
        </div>

        <div class="modal-row">
          <label>Driver</label>
          <input id="editDriver">
        </div>

        <div class="modal-row">
          <label>Active?</label>
          <select id="editActive">
            <option value="true">Active</option>
            <option value="false">Inactive</option>
          </select>
        </div>

        <div class="modal-row">
          <label>Next Service</label>
          <input id="editService" type="date">
        </div>

        <div class="modal-row">
          <label>MOT Due</label>
          <input id="editMOT" type="date">
        </div>

        <div class="modal-row">
          <label>Notes</label>
          <input id="editNotes">
        </div>

      </div>

      <div class="modal-footer">
        <button class="btn secondary" onclick="closeEditModal()">Cancel</button>
        <button class="btn primary" onclick="saveVehicleEdits()">Save</button>
      </div>
    </div>
  </div>

<script>
  if (sessionStorage.getItem("mostlaneLoggedIn") !== "true") {
    window.location.href = "login.html";
  }

  const VEHICLE_WORKER = "https://vehicles.jamie-def.workers.dev";
  const CURRENT_USER = sessionStorage.getItem("mostlaneUser") || "";  // ← ADDED
  let FLEET = [];
  let EDIT_REG = null;

  function goMain(){ window.location.href="main.html"; }

  async function loadFleet(){
    try{
      document.getElementById("statusLine").textContent = "Loading fleet...";
      const res = await fetch(`${VEHICLE_WORKER}/fleet`);
      if (!res.ok) throw new Error("failed");
      FLEET = await res.json();
      updateSummary();
      renderFleet();
      document.getElementById("statusLine").textContent = "Fleet loaded.";
    }catch(e){
      console.error(e);
      document.getElementById("statusLine").textContent = "Failed to load fleet.";
    }
  }

  function updateSummary(){
    sumTotal.textContent = FLEET.length;
    sumActive.textContent = FLEET.filter(v => v.active !== false).length;
    sumUnassigned.textContent = FLEET.filter(v => !v.driver).length;
  }

  function renderFleet(){
    const grid = document.getElementById("fleetGrid");
    grid.innerHTML = "";

    const q = searchInput.value.toLowerCase();
    const filt = filterActive.value;

    let list = FLEET.slice();

    if (q){
      list = list.filter(v =>
        (v.reg||"").toLowerCase().includes(q) ||
        (v.driver||"").toLowerCase().includes(q) ||
        (v.make||"").toLowerCase().includes(q) ||
        (v.model||"").toLowerCase().includes(q)
      );
    }

    if (filt==="active") list = list.filter(v => v.active !== false);
    if (filt==="inactive") list = list.filter(v => v.active === false);

    if (!list.length){
      grid.innerHTML = `<div style="color:#64748b;font-size:13px;">No vehicles found.</div>`;
      return;
    }

    for (const v of list){
      const card = document.createElement("div");
      card.className="card";

      const reg = v.reg || "UNKNOWN";
      const driver = (v.driver||"Unassigned").replace(/\./g," ");

      let motTag = `<span class="tag info">MOT: n/a</span>`;
      if (v.motDue){
        const s = v.motStatus==="bad" ? "bad" : "warn";
        motTag = `<span class="tag ${s}">MOT: ${v.motDue}</span>`;
      }

      let serviceTag = `<span class="tag info">Service: n/a</span>`;
      if (v.nextServiceDate){
        const s = v.serviceStatus==="ok" ? "ok" : "warn";
        serviceTag = `<span class="tag ${s}">Service: ${v.nextServiceDate}</span>`;
      }

      const issuesTag = (v.issuesCount||0)>0
        ? `<span class="tag bad">${v.issuesCount} issues</span>`
        : `<span class="tag ok">No issues</span>`;

      card.innerHTML = `
        <div class="reg-row">
          <div class="reg">${reg}</div>
          <div class="driver"><span>Driver</span><br>${driver}</div>
        </div>

        <div class="meta">
          <span><span class="dot"></span>${v.make||""} ${v.model||""}</span>
          ${v.fuel ? `<span><span class="dot"></span>${v.fuel}</span>` : ""}
          <span><span class="dot"></span>${v.active!==false?"Active":"Inactive"}</span>
        </div>

        <div class="status-row">${serviceTag} ${motTag}</div>
        <div class="status-row">${issuesTag}</div>

        <div class="card-actions">
  <button class="btn-ghost" onclick="openVehicle('${reg}')">Open</button>

  <button class="btn-pill sub" onclick="openEditModal('${reg}')">Edit</button>

  <button class="btn-pill main" onclick="openVehicle('${reg}')">Details →</button>
</div>

      `;

      grid.appendChild(card);
    }
  }

  function openVehicle(reg){
    window.location.href=`vehicle.html?reg=${encodeURIComponent(reg)}`;
  }

  function openEditModal(reg){
    EDIT_REG = reg;
    const v = FLEET.find(x => x.reg===reg);
    if (!v) return;

    editReg.value = v.reg||"";
    editMake.value = v.make||"";
    editModel.value = v.model||"";
    editFuel.value = v.fuel||"";
    editDriver.value = v.driver||"";
    editActive.value = v.active===false ? "false" : "true";
    editService.value = v.nextServiceDate||"";
    editMOT.value = v.motDue||"";
    editNotes.value = v.notes||"";

    document.getElementById("editBackdrop").style.display="flex";
  }

  function closeEditModal(){
    document.getElementById("editBackdrop").style.display="none";
  }

  async function saveVehicleEdits(){
    if (!EDIT_REG) return;

    const updates = {
      make: editMake.value.trim(),
      model: editModel.value.trim(),
      fuel: editFuel.value.trim(),
      driver: editDriver.value.trim(),
      active: editActive.value==="true",
      nextServiceDate: editService.value,
      motDue: editMOT.value,
      notes: editNotes.value.trim(),
    };

    try{
      const res = await fetch(`${VEHICLE_WORKER}/update-vehicle`, {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body:JSON.stringify({ reg: EDIT_REG, updates })
      });

      if (!res.ok) throw new Error("fail");

      const newObj = await res.json();
      const idx = FLEET.findIndex(v => v.reg===EDIT_REG);
      if (idx!==-1) FLEET[idx] = newObj;

      closeEditModal();
      renderFleet();

    }catch(err){
      console.error(err);
      alert("Could not save changes.");
    }
  }

  window.addEventListener("DOMContentLoaded", loadFleet);
</script>

</body>
</html>
