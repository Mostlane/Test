
<!DOCTYPE html>
<html>
<head>
  <title>Check In</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="style.css" />
  <script>
    window.onload = function() {
      navigator.geolocation.getCurrentPosition(success, error);
      function success(position) {
        const data = {
          status: "Check In",
          lat: position.coords.latitude,
          lon: position.coords.longitude,
          device: (function() {
          let id = localStorage.getItem("mostlane_device_id");
          if (!id) {
            id = "dev-" + Math.random().toString(36).substring(2, 10);
            localStorage.setItem("mostlane_device_id", id);
          }
          return id;
        })(),
          engineer: localStorage.getItem("engineerName") || "Unknown"
        };
        fetch("https://hooks.zapier.com/hooks/catch/20261714/2nkzvev/", {
          method: "POST",
          headers: { "Content-Type": "application/x-www-form-urlencoded" },
          body: new URLSearchParams(data).toString()
        }).then(() => {

        setTimeout(() => {
          try {
            fetch("https://1d24d222-2e9f-4bd9-b4e3-650d8bcf24cf-00-ugqjxf7cv4sj.worf.replit.dev/", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                user: data.engineer,
                type: "checkin",
                datetime: new Date().toISOString(),
                location: "GPS: " + data.lat + "," + data.lon
              })
            });
          } catch (e) {
            console.warn("GitHub log error:", e);
          }
        }, 500);

          const now = new Date().toLocaleString();
          window.location.href = `confirm.html?status=${data.status}&lat=${data.lat}&lon=${data.lon}&time=${encodeURIComponent(now)}`;
        }).catch(() => alert("Error submitting data."));
      }
      function error() {
        alert("Please enable location to check in.");
      }
    }
  </script>
<script>
  if (sessionStorage.getItem("mostlaneLoggedIn") !== "true") {
    window.location.href = "login.html";
  }
</script>

</head>
<body class="checkin-body">

<div id="deviceWarning" style="display:none; padding: 20px; background-color: #ffdddd; border: 1px solid red; color: black; font-weight: bold; border-radius: 8px; margin-bottom: 20px;">
  Unable to Check In/Out.<br><br>
  This device is not recognised by Mostlane Portal. Either this device is being used in Incognito mode or the device has changed. Please ensure you are using your normal device and not in private browser. If you have recently changed device or cleared Cache, please follow “Sign Up” from login screen and proceed with “Change Device” steps.<br><br>
  If issues persist, please call Mostlane office on 02380 262000.
</div>

  <style>
  body.checkin-body {
    font-family: "Segoe UI", sans-serif;
    background: #e6e8eb url('Mostlane_Embossed.png') no-repeat center center fixed;
    background-size: 180%;
    margin: 0;
    padding: 40px 20px;
    min-height: 100vh;
    display: flex;
    flex-direction: column;
    align-items: center;
    text-align: center;
  }
  .button {
    display: block;
    margin: 10px auto;
    padding: 12px 20px;
    font-size: 16px;
    text-align: center;
    color: #ffffff;
    background-color: rgba(0, 74, 153, 0.6);
    text-decoration: none;
    border-radius: 6px;
    width: 90%;
    max-width: 300px;
  }

  h1 {
    background-color: rgba(0, 74, 153, 0.6);
    color: #ffffff;
    padding: 12px 20px;
    border-radius: 8px;
    font-weight: bold;
    font-size: 22px;
    margin-bottom: 30px;
    max-width: 90%;
    text-align: center;
  }

  </style>
  <h1>Checking In...</h1>

<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCvcvG15HB6XBJBbnHifjL8jZtsSE5m0i4&libraries=places"></script>
<script>
  function calculateAndSubmit(statusLabel) {
    if (!navigator.geolocation) {
      alert("Geolocation is not supported.");
      return;
    }

    navigator.geolocation.getCurrentPosition(function (position) {
      const lat = position.coords.latitude;
      const lon = position.coords.longitude;
      const origin = new google.maps.LatLng(50.8575, -1.2228); // PO15 5RQ
      const destination = new google.maps.LatLng(lat, lon);

      const service = new google.maps.DistanceMatrixService();
      service.getDistanceMatrix({
        origins: [origin],
        destinations: [destination],
        travelMode: 'DRIVING',
        unitSystem: google.maps.UnitSystem.IMPERIAL,
        drivingOptions: {
          departureTime: new Date(),
          trafficModel: 'bestguess'
        }
      }, function (response, status) {
        if (status !== 'OK') {
          alert("Error getting distance: " + status);
          return;
        }

        const element = response.rows[0].elements[0];
        const distance = element.distance.text;
        const duration = element.duration.text;
        const distanceMiles = parseFloat(distance.replace(" mi", ""));
        const paidMileage = distanceMiles > 10 ? (distanceMiles - 10).toFixed(1) + " mi" : "0 mi";

        const data = {
          status: statusLabel,
          lat: lat,
          lon: lon,
          distance: distance,
          duration: duration,
          paidMileage: paidMileage,
          device: (function() {
            let id = localStorage.getItem("mostlane_device_id");
            if (!id) {
              id = "dev-" + Math.random().toString(36).substring(2, 10);
              localStorage.setItem("mostlane_device_id", id);
            }
            return id;
          })(),
          engineer: localStorage.getItem("engineerName") || "Unknown"
        };

        fetch("https://hooks.zapier.com/hooks/catch/20261714/2nkzvev/", {
          method: "POST",
          headers: { "Content-Type": "application/x-www-form-urlencoded" },
          body: new URLSearchParams(data).toString()
        }).then(() => {
          setTimeout(() => {
            try {
              fetch("https://1d24d222-2e9f-4bd9-b4e3-650d8bcf24cf-00-ugqjxf7cv4sj.worf.replit.dev/", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                  user: data.engineer,
                  type: statusLabel.toLowerCase(),
                  datetime: new Date().toISOString(),
                  location: "GPS: " + data.lat + "," + data.lon,
                  distance: data.distance,
                  duration: data.duration,
                  paidMileage: data.paidMileage
                })
              });
            } catch (e) {
              console.warn("GitHub log error:", e);
            }
          }, 500);

          const now = new Date().toLocaleString();
          window.location.href = `confirm.html?status=${statusLabel}&lat=${data.lat}&lon=${data.lon}&time=${encodeURIComponent(now)}`;
        }).catch(() => alert("Error submitting data."));
      });
    }, function () {
      alert("Unable to access location.");
    });
  }

  window.onload = function () {
    const status = document.title.includes("Out") ? "Check Out" : "Check In";
    calculateAndSubmit(status);
  };
</script>

</body>
</html>

<script>
  if (!localStorage.getItem("mostlane_device_id")) {
    document.getElementById("deviceWarning").style.display = "block";
    // Stop script execution by removing geolocation handler
    window.onload = null;
  }
</script>
