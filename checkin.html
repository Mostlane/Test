<!DOCTYPE html>
<html>
<head>
<script src="auth.js"></script>
<title>Check In</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<link rel="stylesheet" href="style.css" />

<script>
  if (sessionStorage.getItem("mostlaneLoggedIn") !== "true") {
    window.location.href = "login.html";
  }
</script>

<style>
.device-warning {
  background-color: rgba(255, 255, 255, 0.9);
  color: #d00000;
  font-weight: bold;
  border-radius: 10px;
  padding: 20px;
  margin: 20px auto;
  max-width: 500px;
  text-align: center;
  box-shadow: 0 0 10px rgba(0,0,0,0.1);
  font-size: 18px;
  border: 2px solid #d00000;
  display: none;
}
</style>
</head>

<body class="checkin-body">

<!-- DEVICE WARNING -->
<div id="deviceWarning" style="display:none; padding: 20px; background-color: #ffdddd; border: 1px solid red; color: black; font-weight: bold; border-radius: 8px; margin-bottom: 20px;">
  Unable to Check In/Out.<br><br>
  This device is not recognised by Mostlane Portal. Either this device is being used in Incognito mode or the device has changed. Please ensure you are using your normal device and not in private browser. If you have recently changed device or cleared Cache, please follow “Sign Up” from login screen and proceed with “Change Device” steps.<br><br>
  If issues persist, please call Mostlane office on 02380 262000.
</div>

<style>
  body.checkin-body {
    font-family: "Segoe UI", sans-serif;
    background: #e6e8eb url('Mostlane_Embossed.png') no-repeat center center fixed;
    background-size: 180%;
    margin: 0;
    padding: 40px 20px;
    min-height: 100vh;
    display: flex;
    flex-direction: column;
    align-items: center;
    text-align: center;
  }

  .button {
    display: block;
    margin: 10px auto;
    padding: 12px 20px;
    font-size: 16px;
    text-align: center;
    color: #ffffff;
    background-color: rgba(0, 74, 153, 0.6);
    text-decoration: none;
    border-radius: 6px;
    width: 90%;
    max-width: 300px;
  }

  h1 {
    background-color: rgba(0, 74, 153, 0.6);
    color: #ffffff;
    padding: 12px 20px;
    border-radius: 8px;
    font-weight: bold;
    font-size: 22px;
    margin-bottom: 30px;
    max-width: 90%;
    text-align: center;
  }
</style>

<h1>Checking In...</h1>

<!-- DEVICE VERIFICATION -->
<script>
window.addEventListener('DOMContentLoaded', function () {
  const loggedInUser = sessionStorage.getItem('mostlaneLoggedInUser');
  const storedDeviceID = localStorage.getItem('deviceID');

  fetch('Users.txt')
    .then(response => response.text())
    .then(data => {
      const lines = data.split('\n');
      const userLine = lines.find(line => line.includes(loggedInUser));
      if (userLine) {
        const expectedDeviceID = userLine.split(',')[1].trim();
        if (expectedDeviceID !== storedDeviceID) {
          document.getElementById('deviceWarning').style.display = 'block';
          window.blockCheckIn = true;
        }
      }
    });
});
</script>

<!-- BLOCK IF NO DEVICE ID -->
<script>
if (!localStorage.getItem("mostlane_device_id")) {
  document.getElementById("deviceWarning").style.display = "block";
  window.blockCheckIn = true;
}
</script>


<!-- NEW CLOUDLARE WORKER CHECK-IN SYSTEM -->
<script>
const WORKER_URL = "https://ckeck-in-out.jamie-def.workers.dev/check";
const PENDING_KEY = "ml_pending_check_events_v1";

function getPendingChecks() {
  try {
    return JSON.parse(localStorage.getItem(PENDING_KEY) || "[]");
  } catch {
    return [];
  }
}

function savePendingChecks(list) {
  localStorage.setItem(PENDING_KEY, JSON.stringify(list));
}

async function sendToWorker(payload) {
  const res = await fetch(WORKER_URL, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(payload)
  });
  if (!res.ok) throw new Error("Worker error");
  return res.json();
}

async function flushPendingChecks() {
  const pending = getPendingChecks();
  if (!pending.length || !navigator.onLine) return;

  const remaining = [];

  for (const ev of pending) {
    try { await sendToWorker(ev); }
    catch { remaining.push(ev); }
  }

  savePendingChecks(remaining);
}

window.addEventListener("load", flushPendingChecks);
window.addEventListener("online", flushPendingChecks);

function startCheckIn() {
  if (window.blockCheckIn) return;

  const username = sessionStorage.getItem("mostlaneLoggedInUser") || "Unknown";
  const deviceID = localStorage.getItem("mostlane_device_id") || localStorage.getItem("deviceID") || "";

  navigator.geolocation.getCurrentPosition(async pos => {
    const lat = pos.coords.latitude;
    const lon = pos.coords.longitude;
    const datetime = new Date().toISOString();

    const payload = {
      type: "checkin",
      username,
      deviceID,
      datetime,
      lat,
      lon,
      fuelClaim: null,
      offlineEvent: !navigator.onLine
    };

    if (!navigator.onLine) {
      const pending = getPendingChecks();
      pending.push(payload);
      savePendingChecks(pending);
      window.location.href = `confirm.html?status=Check%20In&lat=${lat}&lon=${lon}&time=${encodeURIComponent(new Date().toLocaleString())}`;
      return;
    }

    try {
      await sendToWorker(payload);
    } catch {
      payload.offlineEvent = true;
      const pending = getPendingChecks();
      pending.push(payload);
      savePendingChecks(pending);
    }

    const now = new Date().toLocaleString();
    window.location.href = `confirm.html?status=Check%20In&lat=${lat}&lon=${lon}&time=${encodeURIComponent(now)}`;
  },
  err => {
    alert("Please enable location to check in.\n" + err.message);
  },
  { enableHighAccuracy: true, timeout: 20000 });
}

window.onload = startCheckIn;
</script>

</body>
</html>
