<!DOCTYPE html>
<html>
<head>
<script src="auth.js"></script>
<title>Check In</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<link rel="stylesheet" href="style.css" />

<script>
  if (sessionStorage.getItem("mostlaneLoggedIn") !== "true") {
    window.location.href = "login.html";
  }
</script>

<style>
  body.checkin-body {
    font-family: "Segoe UI", sans-serif;
    background: #e6e8eb url('Mostlane_Embossed.png') no-repeat center center fixed;
    background-size: 180%;
    margin: 0;
    padding: 40px 20px;
    min-height: 100vh;
    display: flex;
    flex-direction: column;
    align-items: center;
    text-align: center;
  }

  h1 {
    background-color: rgba(0, 74, 153, 0.6);
    color: #ffffff;
    padding: 12px 20px;
    border-radius: 8px;
    font-weight: bold;
    font-size: 22px;
    margin-bottom: 30px;
    max-width: 90%;
    text-align: center;
  }
</style>
</head>

<body class="checkin-body">
<h1>Checking In...</h1>

<script>
/* -------------------------------------------------
   DEVICE ID (must exist before verification)
------------------------------------------------- */
let deviceID = localStorage.getItem("mostlane_device_id");
if (!deviceID) {
  deviceID = "dev-" + Math.random().toString(36).substring(2, 10);
  localStorage.setItem("mostlane_device_id", deviceID);
}

/* -------------------------------------------------
   DEVICE VERIFICATION (BLOCKING)
------------------------------------------------- */
async function verifyDevice() {
  const username = sessionStorage.getItem("mostlaneUsername");
  if (!username) {
    alert("No user logged in.");
    window.location.href = "login.html";
    return false;
  }

  const localDevice = localStorage.getItem("mostlane_device_id");
  if (!localDevice) {
    alert("ðŸ”’ This device is not recognised on Mostlane Portal. Either this device is being used in Incognito mode or the device is different. Please ensure you are using your normal device and not in private browser.");
    window.location.href = "main.html";
    return false;
  }

  try {
    const res = await fetch(
      `https://mostlane-api.jamie-def.workers.dev/device/get?user=${username}`
    );
    const data = await res.json();

    if (!data.deviceID) {
      alert("No registered device found for this user. Please complete onboarding again.");
      window.location.href = "onboard.html";
      return false;
    }

    if (data.deviceID !== localDevice) {
      alert("ðŸ”’ This device is registered to a different user. You are not permitted to check in/out on this device. Please log in on your assigned device.");
      window.location.href = "main.html";
      return false;
    }

    return true;

  } catch (err) {
    alert("Error verifying device. Please try again.");
    window.location.href = "main.html";
    return false;
  }
}

/* -------------------------------------------------
   WORKER + OFFLINE QUEUE
------------------------------------------------- */
const WORKER_URL = "https://check-in-out.jamie-def.workers.dev/check";
const PENDING_KEY = "ml_pending_check_events_v1";

function getPendingChecks() {
  try { return JSON.parse(localStorage.getItem(PENDING_KEY) || "[]"); }
  catch { return []; }
}

function savePendingChecks(list) {
  localStorage.setItem(PENDING_KEY, JSON.stringify(list));
}

async function sendToWorker(payload) {
  const res = await fetch(WORKER_URL, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(payload)
  });
  if (!res.ok) throw new Error("Worker error");
  return res.json();
}

/* -------------------------------------------------
   CHECK-IN LOGIC
------------------------------------------------- */
function startCheckIn() {
  const username = sessionStorage.getItem("mostlaneUsername") || "Unknown";

  navigator.geolocation.getCurrentPosition(async pos => {
    const lat = pos.coords.latitude;
    const lon = pos.coords.longitude;
    const datetime = new Date().toISOString();

    const payload = {
      type: "checkin",
      username,
      deviceID,
      datetime,
      lat,
      lon,
      fuelClaim: null,
      offlineEvent: !navigator.onLine
    };

    if (!navigator.onLine) {
      const pending = getPendingChecks();
      pending.push(payload);
      savePendingChecks(pending);
      window.location.href = `confirm.html?status=Check%20In`;
      return;
    }

    try {
      await sendToWorker(payload);
    } catch {
      payload.offlineEvent = true;
      const pending = getPendingChecks();
      pending.push(payload);
      savePendingChecks(pending);
    }

    window.location.href = `confirm.html?status=Check%20In`;

  }, err => {
    alert("Please enable location to check in.\n" + err.message);
  }, { enableHighAccuracy: true, timeout: 20000 });
}

/* -------------------------------------------------
   ENTRY POINT (ORDER MATTERS)
------------------------------------------------- */
window.onload = async () => {
  const verified = await verifyDevice();
  if (verified) startCheckIn();
};
</script>

</body>
</html>
