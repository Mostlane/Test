<!DOCTYPE html>
<html lang="en">
<head>
  <script src="auth.js"></script>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Director Dashboard ‚Äì POs & Job Spend</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: 'Segoe UI', system-ui, -apple-system, Arial, sans-serif;
      background: #e6e8eb url('Mostlane_Embossed.png') no-repeat center center fixed;
      background-size: cover;
      margin: 0;
      padding: 16px;
      color: #1f2937;
    }
    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: rgba(255,255,255,0.9);
      padding: 18px 18px 28px;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    h1 {
      margin: 0 0 12px 0;
      color: #003366;
      text-align: center;
      font-size: 24px;
    }
    .top-bar, .filters {
      display: flex; flex-wrap: wrap; gap: 10px;
      justify-content: space-between; align-items: center;
      margin-bottom: 12px;
    }
    .btn {
      background: rgba(0,74,153,0.9);
      color: #fff; border: none; border-radius: 8px;
      padding: 10px 14px; cursor: pointer; font-size: 14px;
    }
    .btn.secondary { background: #7a8aa6; }
    label { font-size: 13px; color: #003366; margin-right: 6px; }
    select, input[type="search"] {
      background: #fff; color: #003366;
      border: 1px solid #cbd5e1; border-radius: 8px;
      padding: 8px 10px; font-size: 14px;
      min-width: 160px;
    }
    .kpis {
      display: grid;
      grid-template-columns: repeat(6, 1fr);
      gap: 10px; margin: 14px 0 6px;
    }
    .kpi {
      background: #f8fafc; border: 1px solid #e5e7eb;
      border-radius: 10px; padding: 10px;
      text-align: center;
    }
    .kpi .label { font-size: 12px; color: #475569; }
    .kpi .value { font-size: 18px; font-weight: 700; color: #0f172a; margin-top: 4px; }
    .section-title {
      background: #003366; color: #fff;
      padding: 8px 12px; border-radius: 6px; font-weight: bold;
      margin: 18px 0 8px;
    }
    .table-wrapper { overflow-x: auto; border-radius: 8px; }
    table { width: 100%; border-collapse: collapse; min-width: 800px; }
    th, td { padding: 10px 8px; border-bottom: 1px solid #e5e7eb; text-align: left; }
    th { background: #f1f5f9; color: #003366; font-weight: 600; }
    tr:hover { background: #f9fafb; }
    .right { text-align: right; }
    .nowrap { white-space: nowrap; }
    .link { color: #003366; text-decoration: none; }
    .charts {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin-top: 8px;
    }
    .chart-card {
      background: #f8fafc; border: 1px solid #e5e7eb; border-radius: 10px; padding: 10px;
    }
    .modal-backdrop {
      position: fixed; inset: 0; background: rgba(0,0,0,0.45);
      display: none; align-items: center; justify-content: center;
      z-index: 9999;
    }
    .modal {
      background: #fff; border-radius: 12px; padding: 16px;
      max-width: 900px; width: calc(100% - 24px);
      box-shadow: 0 10px 30px rgba(0,0,0,0.25);
    }
    .modal h2 { margin: 0 0 8px 0; color: #003366; font-size: 18px; }
    .modal .close { background: #7a8aa6; }
    .modal .table-wrapper { max-height: 65vh; overflow:auto; }
    .map-link { font-size: 18px; text-decoration: none; }
    @media (max-width: 900px) {
      .charts { grid-template-columns: 1fr; }
      .kpis { grid-template-columns: repeat(3, 1fr); }
    }
    @media (max-width: 540px) {
      .kpis { grid-template-columns: repeat(2, 1fr); }
      table { min-width: 640px; }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Director Dashboard ‚Äì POs & Job Spend</h1>
    <div class="top-bar">
      <button class="btn" onclick="window.location.href='main.html'">Main Menu</button>
      <div style="display:flex; gap:8px; flex-wrap:wrap;">
        <button class="btn secondary" id="exportCsvBtn">Export CSV</button>
        <span id="status" style="font-size:12px;color:#475569;align-self:center;"></span>
      </div>
    </div>

    <div class="filters">
      <div><label for="engineerFilter">Engineer</label><select id="engineerFilter"><option value="">All Engineers</option></select></div>
      <div><label for="supplierFilter">Supplier</label><select id="supplierFilter"><option value="">All Suppliers</option></select></div>
      <div><label for="jobFilter">Job / Site</label><select id="jobFilter"><option value="">All Jobs</option></select></div>
      <div><label for="dateRange">Show</label>
        <select id="dateRange">
          <option value="7">Last 7 Days</option>
          <option value="14">Last 14 Days</option>
          <option value="30">Last 30 Days</option>
          <option value="60">Last 60 Days</option>
          <option value="90">Last 90 Days</option>
          <option value="all" selected>All Time</option>
        </select>
      </div>
      <div style="flex:1; min-width: 200px;">
        <label for="searchBox">Search</label>
        <input id="searchBox" type="search" placeholder="PO number, description, or incident number‚Ä¶" />
      </div>
    </div>

    <div class="kpis">
      <div class="kpi"><div class="label">Total POs</div><div class="value" id="k_totalPOs">-</div></div>
      <div class="kpi"><div class="label">Unique Engineers</div><div class="value" id="k_uniqueEng">-</div></div>
      <div class="kpi"><div class="label">Unique Suppliers</div><div class="value" id="k_uniqueSup">-</div></div>
      <div class="kpi"><div class="label">Unique Jobs</div><div class="value" id="k_uniqueJobs">-</div></div>
      <div class="kpi"><div class="label">Total Net</div><div class="value" id="k_totalNet">-</div></div>
      <div class="kpi"><div class="label">Total Gross</div><div class="value" id="k_totalGross">-</div></div>
    </div>

    <div class="section-title">Job Cost Overview</div>
    <div class="table-wrapper">
      <table id="tblJobs">
        <thead>
          <tr>
            <th>Incident / Description</th>
            <th>POs</th>
            <th>Engineers</th>
            <th>Suppliers</th>
            <th class="right">Net</th>
            <th class="right">VAT</th>
            <th class="right">Gross</th>
            <th>Drill-down</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <div class="section-title">Engineer Spend Summary</div>
    <div class="table-wrapper">
      <table id="tblEngineers">
        <thead><tr><th>Engineer</th><th>POs</th><th>Suppliers</th><th class="right">Net</th><th class="right">Gross</th><th>Drill-down</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>

    <div class="section-title">Supplier Spend Analysis</div>
    <div class="table-wrapper">
      <table id="tblSuppliers">
        <thead><tr><th>Supplier</th><th>POs</th><th>Engineers</th><th class="right">Net</th><th class="right">Gross</th><th>Drill-down</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <div class="modal-backdrop" id="modalBackdrop">
    <div class="modal">
      <h2 id="modalTitle">Details</h2>
      <div class="table-wrapper">
        <table id="modalTable">
          <thead>
            <tr>
              <th>Date</th><th>PO Number</th><th>Engineer</th><th>Supplier</th>
              <th>Incident / Description</th><th class="right">Net</th><th class="right">Gross</th><th>Map</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      <div style="margin-top:10px;text-align:right;"><button class="btn close" id="modalClose">Close</button></div>
    </div>
  </div>

<script>
const GET_URL = 'https://mostlane-pos.jamie-def.workers.dev/get-po';
let ALL = [], FILTERED = [];
const fmtGBP = n => (n ? '¬£' + Number(n).toFixed(2) : '');
const dotToSpace = s => (s || '').replace(/\./g, ' ');

function parseUKDate(s){if(!s)return null;const[d,m,y]=s.split('/');return new Date(`${y}-${m}-${d}`);}
function dateInRange(d,days){if(days==='all')return true;const c=new Date();c.setDate(c.getDate()-Number(days));return d>=c;}

function populateFilters(list){
  const engSel=document.getElementById('engineerFilter');
  const supSel=document.getElementById('supplierFilter');
  const jobSel=document.getElementById('jobFilter');
  engSel.innerHTML='<option value="">All Engineers</option>';
  supSel.innerHTML='<option value="">All Suppliers</option>';
  jobSel.innerHTML='<option value="">All Jobs</option>';
  [...new Set(list.map(p=>p.engineer).filter(Boolean))].sort().forEach(v=>engSel.innerHTML+=`<option>${v}</option>`);
  [...new Set(list.map(p=>p.supplierName).filter(Boolean))].sort().forEach(v=>supSel.innerHTML+=`<option>${v}</option>`);
  [...new Set(list.map(p=>p.siteSegment||p.site||'')).filter(Boolean)].sort().forEach(v=>jobSel.innerHTML+=`<option>${v}</option>`);
}

function applyFilters(){
  const eng=document.getElementById('engineerFilter').value;
  const sup=document.getElementById('supplierFilter').value;
  const job=document.getElementById('jobFilter').value;
  const days=document.getElementById('dateRange').value;
  const search=(document.getElementById('searchBox').value||'').toLowerCase().trim();
  FILTERED=ALL.filter(p=>{
    const d=parseUKDate(p.date); if(!d)return false;
    if(!dateInRange(d,days))return false;
    if(eng&&p.engineer!==eng)return false;
    if(sup&&p.supplierName!==sup)return false;
    if(job&&(p.siteSegment||p.site||'')!==job)return false;
    if(search){
      const hay=[p.poNumber,p.description,p.engineer,p.supplierName,p.incidentNumber,(p.siteSegment||p.site||'')].join(' ').toLowerCase();
      if(!hay.includes(search))return false;
    }
    return true;
  });
  populateFilters(FILTERED);
  updateKpis(FILTERED);
  renderTables(FILTERED);
}

function updateKpis(list){
  document.getElementById('k_totalPOs').textContent=list.length;
  document.getElementById('k_uniqueEng').textContent=new Set(list.map(p=>p.engineer).filter(Boolean)).size;
  document.getElementById('k_uniqueSup').textContent=new Set(list.map(p=>p.supplierName).filter(Boolean)).size;
  document.getElementById('k_uniqueJobs').textContent=new Set(list.map(p=>p.siteSegment||p.site||'')).size;
  const net=list.reduce((a,b)=>a+Number(b.costNet||0),0);
  const gross=list.reduce((a,b)=>a+Number(b.costGross||0),0);
  document.getElementById('k_totalNet').textContent=fmtGBP(net);
  document.getElementById('k_totalGross').textContent=fmtGBP(gross);
}

function groupBy(arr,keyFn){const m=new Map();arr.forEach(i=>{const k=keyFn(i);if(!m.has(k))m.set(k,[]);m.get(k).push(i);});return m;}
function totalsFor(list){let net=0,gross=0;list.forEach(p=>{net+=Number(p.costNet||0);gross+=Number(p.costGross||0);});return{net,gross,vat:Math.max(gross-net,0)};}

function renderTables(list){
  // JOBS
  const jobsBody=document.querySelector('#tblJobs tbody');
  jobsBody.innerHTML='';
  const gJobs=groupBy(list,p=>p.siteSegment||p.site||'Unspecified');
  [...gJobs.entries()].sort((a,b)=>totalsFor(b[1]).gross-totalsFor(a[1]).gross)
  .forEach(([job,items])=>{
    const {net,gross,vat}=totalsFor(items);
    const engCount=new Set(items.map(p=>p.engineer).filter(Boolean)).size;
    const supCount=new Set(items.map(p=>p.supplierName).filter(Boolean)).size;
    const poCount=items.length;
    // ‚úÖ show incident number if present, else description
    const showText=items.find(p=>p.incidentNumber)?.incidentNumber || items[0].description || job;
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td>${showText}</td>
      <td>${poCount}</td>
      <td>${engCount}</td>
      <td>${supCount}</td>
      <td class="right">${fmtGBP(net)}</td>
      <td class="right">${fmtGBP(vat)}</td>
      <td class="right">${fmtGBP(gross)}</td>
      <td><a href="#" class="link" onclick='showModal(${JSON.stringify(items).replace(/'/g,"&#39;")}, "Job ${job} ‚Äì ${poCount} POs");return false;'>View</a></td>`;
    jobsBody.appendChild(tr);
  });

  // ENGINEERS
  const engBody=document.querySelector('#tblEngineers tbody');
  engBody.innerHTML='';
  const gEng=groupBy(list,p=>p.engineer||'Unknown');
  [...gEng.entries()].forEach(([eng,items])=>{
    const {net,gross}=totalsFor(items);
    const supCount=new Set(items.map(p=>p.supplierName).filter(Boolean)).size;
    const poCount=items.length;
    engBody.innerHTML+=`
      <tr><td>${eng}</td><td>${poCount}</td><td>${supCount}</td>
      <td class="right">${fmtGBP(net)}</td><td class="right">${fmtGBP(gross)}</td>
      <td><a href="#" class="link" onclick='showModal(${JSON.stringify(items).replace(/'/g,"&#39;")}, "Engineer ${eng} ‚Äì ${poCount} POs");return false;'>View</a></td></tr>`;
  });

  // SUPPLIERS
  const supBody=document.querySelector('#tblSuppliers tbody');
  supBody.innerHTML='';
  const gSup=groupBy(list,p=>p.supplierName||'Unknown');
  [...gSup.entries()].forEach(([sup,items])=>{
    const {net,gross}=totalsFor(items);
    const engCount=new Set(items.map(p=>p.engineer).filter(Boolean)).size;
    const poCount=items.length;
    supBody.innerHTML+=`
      <tr><td>${sup}</td><td>${poCount}</td><td>${engCount}</td>
      <td class="right">${fmtGBP(net)}</td><td class="right">${fmtGBP(gross)}</td>
      <td><a href="#" class="link" onclick='showModal(${JSON.stringify(items).replace(/'/g,"&#39;")}, "Supplier ${sup} ‚Äì ${poCount} POs");return false;'>View</a></td></tr>`;
  });
}

function showModal(items,title){
  const m=document.getElementById('modalBackdrop');
  document.getElementById('modalTitle').textContent=title;
  const tb=document.querySelector('#modalTable tbody');
  tb.innerHTML=items.map(p=>{
    const map=(p.latitude&&p.longitude)?`<a href="https://www.google.com/maps?q=${p.latitude},${p.longitude}" target="_blank">üìç</a>`:'';
    return `<tr>
      <td>${p.date||''}</td><td>${p.poNumber||''}</td><td>${p.engineer||''}</td><td>${p.supplierName||''}</td>
      <td>${p.incidentNumber||p.description||''}</td>
      <td class="right">${fmtGBP(p.costNet||0)}</td><td class="right">${fmtGBP(p.costGross||0)}</td><td>${map}</td>
    </tr>`;
  }).join('');
  m.style.display='flex';
}
document.getElementById('modalClose').onclick=()=>document.getElementById('modalBackdrop').style.display='none';

document.getElementById('exportCsvBtn').onclick=()=>{
  const rows=[],tables=['tblJobs','tblEngineers','tblSuppliers'];
  tables.forEach(id=>{
    const ths=[...document.querySelectorAll(`#${id} thead th`)].map(th=>th.innerText);
    rows.push(ths);
    [...document.querySelectorAll(`#${id} tbody tr`)].forEach(tr=>{
      rows.push([...tr.children].map(td=>td.innerText));
    });
    rows.push([]);
  });
  const csv=rows.map(r=>r.map(v=>`"${(v||'').replace(/"/g,'""')}"`).join(',')).join('\n');
  const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'});
  const a=document.createElement('a');
  a.href=URL.createObjectURL(blob);a.download='po-director-export.csv';
  a.click();
};

async function init(){
  try{
    const res=await fetch(GET_URL,{cache:'no-store'});
    ALL=await res.json();
    ALL=(ALL||[]).map(p=>({...p,engineer:p.engineer||'',supplierName:p.supplierName||'',date:p.date||''})).filter(p=>p.date);
    populateFilters(ALL);
    applyFilters();
    document.getElementById('status').textContent=`${ALL.length} POs loaded`;
  }catch(e){
    document.getElementById('status').textContent='Failed to load: '+e.message;
  }
  ['engineerFilter','supplierFilter','jobFilter','dateRange','searchBox'].forEach(id=>{
    document.getElementById(id).addEventListener('input',applyFilters);
    document.getElementById(id).addEventListener('change',applyFilters);
  });
}
document.addEventListener('DOMContentLoaded',init);
</script>
</body>
</html>
