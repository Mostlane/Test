<!doctype html>
<html lang="en">
<head>
  <script src="auth.js"></script>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Mostlane ‚Ä¢ Advanced Hours Dashboard v3.2 (Live)</title>
  <link rel="preconnect" href="https://cdn.jsdelivr.net" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <style>
    :root{
      --bg:#0f172a; --panel:#111827; --panelEdge:#0b1222; --text:#e5e7eb; --muted:#9ca3af;
      --ok:#10b981; --warn:#f59e0b; --bad:#ef4444;
      --blue:#3b82f6; --indigo:#6366f1; --cyan:#22d3ee; --yellow:#facc15; --teal:#14b8a6;
      --rowAlt:rgba(255,255,255,0.03);
      --tooltipBg:#0b1222; --tooltipBorder:#1f2a44; --tooltipShadow:0 12px 30px rgba(0,0,0,.45);
    }
    body{margin:0;background:linear-gradient(180deg,#0b132a,#0a0f1f);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
    .wrap{display:grid;grid-template-columns: 1fr 360px; gap:16px; padding:16px}
    .area{display:grid; grid-template-columns: repeat(2,minmax(0,1fr)); gap:16px}
    .panel{background:var(--panel); border:1px solid #1f2937; border-radius:10px; padding:14px; box-shadow:inset 0 0 0 1px var(--panelEdge), 0 6px 16px rgba(0,0,0,.35)}
    .title{font-weight:600; font-size:14px; color:var(--muted); margin-bottom:8px}
    .kpiGrid{display:grid; grid-template-columns: repeat(4,1fr); gap:16px; margin-bottom:16px}
    .kpi .num{font-size:28px; font-weight:800}
    .kpi .sub{color:var(--muted); font-size:12px}
    .topbar{grid-column:1/3; display:flex; justify-content:space-between; align-items:center; margin-bottom:4px}
    .btn{appearance:none; border:1px solid #334155; background:#0b132a; color:#fff; padding:8px 10px; border-radius:8px; cursor:pointer; text-decoration:none}
    .highlight{font-size:18px;font-weight:700;color:var(--blue)}
    .hint{font-size:12px;color:var(--muted);margin-top:4px}
    canvas{max-width:100%}

    /* Leaderboards */
    .leaderboard .sectionHeader{
      margin:16px -14px 6px -14px; padding:10px 14px;
      font-weight:700; color:#e5e7eb; background:rgba(59,130,246,0.08);
      border-top:1px solid #1f2937; border-bottom:1px solid #1f2937;
      display:flex; align-items:center; gap:8px;
    }
    .leaderboard .sectionHeader .small{font-weight:500;color:var(--muted);font-size:12px;margin-left:auto}
    .leaderboard .rows{margin-top:4px}
    .row{
      display:flex; justify-content:space-between; gap:10px; padding:8px 10px;
      border-bottom:1px dashed #334155; align-items:center; border-radius:6px;
    }
    .row:nth-child(odd){ background:var(--rowAlt); }
    .row:last-child{border-bottom:none}
    .metric{white-space:nowrap; font-variant-numeric:tabular-nums}
    .name{flex:1; overflow:hidden; text-overflow:ellipsis; white-space:nowrap}

    /* Severity highlights */
    .sev-ok .metric{color:var(--ok); font-weight:700}
    .sev-warn .metric{color:var(--warn); font-weight:700}
    .sev-bad{
      background:linear-gradient(90deg, rgba(239,68,68,0.18), transparent);
      border-left:3px solid var(--bad);
    }
    .sev-bad .metric{color:#fecaca; font-weight:800}

    /* Suggestions */
    .suggestions .item{display:flex; gap:8px; align-items:flex-start; padding:8px 0; border-bottom:1px dashed #334155}
    .suggestions .item:last-child{border-bottom:none}
    .suggestions .icon{width:22px; text-align:center}
    .suggestions .text{flex:1; color:#e5e7eb}
    .suggestions .text .small{color:var(--muted); font-size:12px}

    /* Header tooltip chip */
    .infoChip{
      display:inline-flex; align-items:center; gap:6px; font-weight:600;
      background:rgba(148,163,184,0.08); padding:3px 8px; border-radius:999px; border:1px solid #243044;
    }
    .infoChip .i{font-size:12px; color:#9ca3af}

    /* Pretty tooltips */
    .tooltip{
      position:fixed; z-index:9999; pointer-events:none; opacity:0; transform:translateY(-4px);
      background:var(--tooltipBg); color:#e5e7eb; border:1px solid var(--tooltipBorder);
      border-radius:10px; padding:10px 12px; box-shadow:var(--tooltipShadow);
      max-width:320px; line-height:1.4; font-size:13px; transition:opacity .12s ease, transform .12s ease;
    }
    .tooltip.show{opacity:1; transform:translateY(0)}
    .tooltip .tip{position:absolute; width:10px; height:10px; background:var(--tooltipBg); transform:rotate(45deg); border-left:1px solid var(--tooltipBorder); border-top:1px solid var(--tooltipBorder)}
    @media(max-width:1100px){ .wrap{grid-template-columns:1fr} .area{grid-template-columns:1fr} .kpiGrid{grid-template-columns:repeat(2,1fr)} }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="area">
      <div class="topbar" style="grid-column:1/2">
        <div>
          <div style="font-weight:700;font-size:20px">Advanced Hours Dashboard</div>
          <div class="hint">Week view based on Cloudflare Worker JSON</div>
          <div style="margin-top:6px">
            üèÜ Top Engineer ‚Äì This Week: <span class="highlight" id="topWeek">‚Äì</span><br>
            üèÜ Top Engineer ‚Äì Last 6 Weeks: <span class="highlight" id="topHist">‚Äì</span>
          </div>
        </div>
      </div>
      <div class="topbar" style="grid-column:2/3;justify-content:flex-end;gap:8px">
        <a href="hours-dashboard-simple-v2.html" class="btn">Simple View</a>
      </div>

      <!-- KPI TILES -->
      <div class="panel kpiGrid" style="grid-column:1/3">
        <div class="panel kpi"><div class="num" id="kpi-engineers">‚Äì</div><div class="sub">Engineers (active this week)</div></div>
        <div class="panel kpi"><div class="num" id="kpi-worked">‚Äì</div><div class="sub">Hours worked so far (team)</div></div>
        <div class="panel kpi"><div class="num" id="kpi-pred">‚Äì</div><div class="sub">Predicted total this week (team, Mon‚ÄìFri)</div></div>
        <div class="panel kpi"><div class="num" id="kpi-remaining">‚Äì</div><div class="sub">Team hours remaining vs cap</div></div>
      </div>

      <!-- Charts -->
      <div class="panel"><div class="title">Team progress (Worked vs Cap)</div><canvas id="progressTeam" height="100"></canvas></div>
      <div class="panel"><div class="title">Avg engineer vs 40h cap</div><canvas id="progressAvg" height="100"></canvas></div>
      <div class="panel"><div class="title">Risk distribution</div><canvas id="donutRisk" height="120"></canvas></div>
      <div class="panel"><div class="title">By engineer (worked, predicted & cap)</div><canvas id="stackedByEngineer" height="140"></canvas></div>
      <div class="panel" style="grid-column:1/3"><div class="title">Hours by day (current week)</div><canvas id="byDay" height="140"></canvas></div>
    </div>

    <!-- Right Column: Leaderboards + AI Suggestions -->
    <div class="panel leaderboard" style="max-height:calc(100vh - 32px);overflow:auto">
      <!-- Weekly -->
      <div class="sectionHeader" data-tooltip="Shows this week's live picture. Use these to spot who needs attention right now.">
        <span class="infoChip"><span>Weekly Leaderboards</span><span class="i">‚ìò</span></span>
        <span class="small">This week</span>
      </div>
      <div id="weekly-sections"></div>

      <!-- Historical -->
      <div class="sectionHeader" data-tooltip="Six-week trends. Helps you separate one-off spikes from consistent patterns.">
        <span class="infoChip"><span>6-Week Leaderboards</span><span class="i">‚ìò</span></span>
        <span class="small">Trends</span>
      </div>
      <div id="hist-sections"></div>

      <!-- Suggestions -->
      <div class="sectionHeader" data-tooltip="Highlights likely issues or stand-out positives based on hours, overtime, travel and van checks.">
        <span class="infoChip"><span>‚ö° Insights & Suggestions</span><span class="i">‚ìò</span></span>
        <span class="small">Analytical & factual</span>
      </div>
      <div id="suggestions" class="suggestions"></div>
    </div>
  </div>

  <!-- Pretty tooltip element -->
  <div id="tooltip" class="tooltip" role="tooltip" aria-hidden="true"><div class="tip" id="tooltip-tip"></div><div id="tooltip-text"></div></div>

<script>
/** ======= CONFIG ======= **/
const HOURS_URL = "https://odd-water-f78a.jamie-def.workers.dev/Hours";
const CAP_PER_ENGINEER = 40;
const WEEKDAYS_TARGET = 5; // projection uses Monday‚ÄìFriday only

// thresholds used for severity & suggestions
const OT_WARN = 2;           // hours this week
const OT_BAD = 4;
const PRED_NEAR = 0.9;       // % of cap
const LONG_WEEK_BAD = 45;    // worked/predicted consistently over this
const LONG_DAY_BAD = 12;     // avg daily hours current week
const VC_BAD = 0.80;         // van check pass ratio threshold across 6 weeks

/** ======= HELPERS ======= **/
const $ = (id) => document.getElementById(id);
const toFloat = (v) => v==null ? 0 : parseFloat(v)||0;

function parseISODate(s){
  const d = new Date(s + "T12:00:00Z");
  return isNaN(d) ? null : d;
}
function sum(arr){ return arr.reduce((a,b)=>a+toFloat(b),0); }
function avg(arr){ return arr.length ? sum(arr)/arr.length : 0; }
function fmtHours(n){ return (Math.round(n*100)/100).toFixed(2) + "h"; }
function weekLabel(weekKey){
  const sun = parseISODate(weekKey);
  if(!sun) return weekKey;
  const mon = new Date(sun); mon.setUTCDate(sun.getUTCDate()+1);
  return "w/c " + mon.toLocaleDateString("en-GB",{day:"2-digit", month:"short"});
}

/** ======= FETCH & SHAPE DATA ======= **/
async function loadHours(){
  const res = await fetch(HOURS_URL + "?t=" + Date.now(), { cache: "no-store" });
  if(!res.ok) throw new Error("Failed to load Hours JSON");
  return await res.json();
}

function flattenAndDedupe(json){
  const all = [];
  for(const k of Object.keys(json||{})){
    const arr = Array.isArray(json[k]) ? json[k] : [];
    for(const e of arr){
      if(e && typeof e === "object" && e.date && e.engineer){
        all.push(e);
      }
    }
  }
  // Dedupe by engineer+date, keep latest submittedAt
  const map = new Map();
  for(const e of all){
    const key = (e.engineer||"").trim() + "||" + e.date;
    const prev = map.get(key);
    if(!prev){ map.set(key, e); continue; }
    const pt = prev.submittedAt ? Date.parse(prev.submittedAt) : 0;
    const ct = e.submittedAt ? Date.parse(e.submittedAt) : 0;
    if(ct >= pt) map.set(key, e);
  }
  return Array.from(map.values());
}

function deriveWeekKey(dateStr){
  const d = parseISODate(dateStr);
  if(!d) return null;
  const sun = new Date(Date.UTC(d.getUTCFullYear(), d.getUTCMonth(), d.getUTCDate()));
  const day = sun.getUTCDay(); // 0=Sun..6=Sat
  sun.setUTCDate(sun.getUTCDate() - day);
  return sun.toISOString().split("T")[0];
}

function weekKeysFromEntries(entries){
  const keys = new Set();
  for(const e of entries){
    const wk = e.weekKey || deriveWeekKey(e.date);
    if(wk) keys.add(wk);
  }
  const sorted = [...keys].filter(k => /^\d{4}-\d{2}-\d{2}$/.test(k)).sort();
  return sorted;
}

/** ======= COMPUTE METRICS ======= **/
function aggregateWeek(entries, weekKey){
  const cur = entries.filter(e => (e.weekKey || deriveWeekKey(e.date)) === weekKey);

  const byEng = new Map();
  for(const e of cur){
    const name = (e.engineer||"").trim();
    if(!name) continue;

    if(!byEng.has(name)){
      byEng.set(name, {
        name,
        worked: 0,            // total paid hours (full week actual)
        overtime: 0,          // total OT (full week actual)
        travel: 0,            // total travel (full week actual)
        weekdayWorked: 0,     // Mon‚ÄìFri paid hours (for avg + prediction)
        weekdayDays: 0,       // Mon‚ÄìFri unique days worked
        predicted: 0,
        cap: CAP_PER_ENGINEER,
        vanCheck: null        // "Yes" / "No" / null
      });
    }
    const rec = byEng.get(name);

    const total = toFloat(e.totalHours);
    const overtime = toFloat(e.overtimeHours);
    const travel = toFloat(e.totalTravelHours);

    rec.worked += total;
    rec.overtime += overtime;
    rec.travel += travel;

    const d = parseISODate(e.date);
    if(d){
      const dow = d.getUTCDay();
      if(dow >= 1 && dow <= 5){
        rec.weekdayWorked += total;
        rec.weekdayDays += 1;
      }
    }

    const vc = ((e.vanCheckWeekStatus || e.vanCheck || "") + "").trim();
    if(vc === "Failed" || vc === "No"){ rec.vanCheck = "No"; }
    else if(vc === "Passed" || vc === "Yes"){
      if(rec.vanCheck !== "No") rec.vanCheck = "Yes";
    }
  }

  for(const rec of byEng.values()){
    const daysWorked = rec.weekdayDays || 0;
    const avgPerDay = daysWorked ? (rec.weekdayWorked / daysWorked) : 0;
    rec.predicted = avgPerDay * WEEKDAYS_TARGET;
  }
  return byEng;
}

function buildHistory(entries, weekKeys, limit=6){
  const last = weekKeys.slice(-limit);
  const out = new Map();
  for(const wk of last){
    const agg = aggregateWeek(entries, wk);
    agg.forEach((rec, name)=>{
      if(!out.has(name)) out.set(name, []);
      out.get(name).push({
        weekKey: wk,
        worked: rec.worked,
        overtime: rec.overtime,
        travel: rec.travel,
        predicted: rec.predicted,
        vanCheck: rec.vanCheck
      });
    });
  }
  return { weeks:last, history:out };
}

/** ======= SCORING ======= **/
function weeklyScore(rec){
  const worked = rec.worked;
  const overtime = rec.overtime;
  const travel = rec.travel;
  const eff = worked ? Math.max(0, (worked - travel) / worked) : 1;

  let s = 100;
  s -= 2 * Math.max(0, overtime);
  if(eff < 0.75) s -= 15; else if(eff < 0.85) s -= 7; else if(eff > 0.92) s += 5;
  if(rec.vanCheck === "No") s -= 20; else if(rec.vanCheck === "Yes") s += 2;
  const diff = Math.abs(CAP_PER_ENGINEER - Math.min(rec.predicted, 1e6));
  if(diff <= 4) s += 4;
  return Math.max(0, Math.min(100, s));
}
function historicScore(historyArr){
  if(!historyArr || !historyArr.length) return 0;
  const workedAvg = avg(historyArr.map(h=>h.worked));
  const otAvg = avg(historyArr.map(h=>h.overtime));
  const travelAvg = avg(historyArr.map(h=>h.travel));
  const eff = workedAvg ? Math.max(0,(workedAvg - travelAvg)/workedAvg) : 1;
  const checksGood = historyArr.filter(h=>h.vanCheck==="Yes").length / historyArr.length;

  let s = 100;
  const diff = Math.abs(CAP_PER_ENGINEER - workedAvg);
  if(diff <= 2) s += 5; else if(diff > 8) s -= 5;
  s -= 1.5 * otAvg;
  if(eff < 0.8) s -= 10; else if(eff > 0.92) s += 5;
  s += 10 * (checksGood - 0.8);
  return Math.max(0, Math.min(100, s));
}

/** ======= RENDER HELPERS ======= **/
function colorFor(pred,cap){
  if(pred>cap) return "#ef4444"; // bad
  if(pred>cap*0.9) return "#f59e0b"; // warn
  return "#10b981"; // ok
}
function rowSeverityByPred(pred){
  if(pred>CAP_PER_ENGINEER) return 'sev-bad';
  if(pred>CAP_PER_ENGINEER*PRED_NEAR) return 'sev-warn';
  return 'sev-ok';
}
function rowSeverityByOT(ot){
  if(ot>=OT_BAD) return 'sev-bad';
  if(ot>=OT_WARN) return 'sev-warn';
  return 'sev-ok';
}
function rowSeverityByEff(e){
  const eff = e.worked ? (e.worked-e.travel)/e.worked : 1;
  if(eff < 0.75) return 'sev-bad';
  if(eff < 0.85) return 'sev-warn';
  return 'sev-ok';
}
function emojiFor(sev){
  if(sev==='sev-bad') return 'üî¥';
  if(sev==='sev-warn') return 'üü†';
  return 'üü¢';
}

/* Build a header+rows inside a container and return the rows div */
function addSection(container, title, tooltip, subtitle){
  const header=document.createElement('div');
  header.className='sectionHeader';
  header.setAttribute('data-tooltip', tooltip || '');
  header.setAttribute('title', tooltip || ''); // native fallback
  header.innerHTML = `<span class="infoChip"><span>${title}</span><span class="i">‚ìò</span></span>${subtitle?`<span class="small">${subtitle}</span>`:''}`;
  container.appendChild(header);
  const rows=document.createElement('div');
  rows.className='rows';
  container.appendChild(rows);
  return rows;
}
function addRows(container, rows){
  rows.forEach(r=>{
    const div=document.createElement('div');
    div.className='row '+(r.sev||'');
    div.innerHTML=`<div class="name">${r.lead}</div><div class="metric">${r.tail}</div>`;
    container.appendChild(div);
  });
}

/** ======= SUGGESTION ENGINE (Analytical & factual) ======= **/
function buildSuggestions(engineers, hist){
  const items = [];
  const history = hist.history;

  // 1) Serial van-check offenders (pass ratio < 80% over last 6 weeks)
  history.forEach((arr, name)=>{
    const total = arr.length;
    if(!total) return;
    const pass = arr.filter(x=>x.vanCheck==="Yes").length;
    const ratio = total ? pass/total : 0;
    if(ratio < VC_BAD){
      items.push({
        icon:'üöö',
        text:`${name} van-check pass rate ${Math.round(ratio*100)}% across last ${total} week(s).`,
        small:`Threshold ${Math.round(VC_BAD*100)}%.`
      });
    }
  });

  // 2) Consistently high weekly hours (>45h worked or predicted) for >= 4 of last 6 weeks
  history.forEach((arr, name)=>{
    const count = arr.filter(x => (x.worked > LONG_WEEK_BAD) || (x.predicted > LONG_WEEK_BAD)).length;
    if(count >= 4){
      items.push({
        icon:'‚è±Ô∏è',
        text:`${name} exceeded ${LONG_WEEK_BAD}h in ${count} of the last ${arr.length} week(s).`,
        small:`Includes worked or predicted totals.`
      });
    }
  });

  // 3) Consistently high overtime (avg >= 4h/week across last 6)
  history.forEach((arr, name)=>{
    const otAvg = avg(arr.map(x=>x.overtime));
    if(otAvg >= OT_BAD){
      items.push({
        icon:'üî•',
        text:`${name} averages ${otAvg.toFixed(1)}h overtime per week across last ${arr.length} week(s).`,
        small:`Review workload or scheduling.`
      });
    }
  });

  // 4) Long days this week (avg > 12h/day across Mon‚ÄìFri actuals)
  engineers.forEach(e=>{
    const days = e.weekdayDays || 0;
    const avgDay = days ? e.weekdayWorked / days : 0;
    if(avgDay > LONG_DAY_BAD){
      items.push({
        icon:'‚ö†Ô∏è',
        text:`${e.name} averaging ${avgDay.toFixed(1)}h per working day this week.`,
        small:`Mon‚ÄìFri only.`
      });
    }
  });

  // 5) Positive notes (100% van checks with low overtime this week)
  engineers.forEach(e=>{
    const histArr = history.get(e.name) || [];
    const total = histArr.length;
    if(total){
      const pass = histArr.filter(x=>x.vanCheck==="Yes").length;
      const passRatio = pass/total;
      if(passRatio===1 && e.overtime < OT_WARN){
        items.push({
          icon:'‚úÖ',
          text:`${e.name} maintains 100% van-check compliance with ${e.overtime.toFixed(1)}h overtime this week.`,
          small:`Consistent good practice.`
        });
      }
    }
  });

  return items.slice(0,10);
}

/** ======= PRETTY TOOLTIP WIDGET ======= **/
(function enableTooltips(){
  const el = $("tooltip");
  const tip = $("tooltip-tip");
  const text = document.getElementById("tooltip-text");

  function showTooltip(target, content, evt){
    if(!content){ hideTooltip(); return; }
    el.setAttribute('aria-hidden','false');
    text.textContent = content;
    el.classList.add('show');

    const pad = 10;
    const rect = target.getBoundingClientRect();
    const ttRect = el.getBoundingClientRect();

    // Position below header, left-aligned
    let top = rect.bottom + 8 + window.scrollY;
    let left = rect.left + window.scrollX;

    // Avoid off-right
    if(left + ttRect.width + pad > window.scrollX + window.innerWidth){
      left = window.scrollX + window.innerWidth - ttRect.width - pad;
    }
    // Avoid off-left
    if(left < pad) left = pad;

    el.style.top = `${top}px`;
    el.style.left = `${left}px`;

    // little diamond tip
    tip.style.left = `${Math.min(Math.max(rect.left + rect.width/2 - left - 5, 12), ttRect.width - 22)}px`;
    tip.style.top = `-5px`;
  }
  function hideTooltip(){
    el.classList.remove('show');
    el.setAttribute('aria-hidden','true');
  }

  // Delegate over headers with data-tooltip
  document.addEventListener('mouseover', (e)=>{
    const header = e.target.closest('.sectionHeader');
    if(header && header.dataset.tooltip){
      showTooltip(header, header.dataset.tooltip, e);
    } else {
      hideTooltip();
    }
  });
  document.addEventListener('scroll', hideTooltip, {passive:true});
  document.addEventListener('mouseout', (e)=>{
    const to = e.relatedTarget;
    if(!to || !to.closest || !e.target.closest('.sectionHeader')) return;
  });
})();

/** ======= MAIN ======= **/
(async function init(){
  try{
    const json = await loadHours();
    const entries = flattenAndDedupe(json);
    if(!entries.length){
      ["topWeek","topHist","kpi-engineers","kpi-worked","kpi-pred","kpi-remaining"].forEach(id=>$(id).textContent="‚Äì");
      $("suggestions").innerHTML = `<div class="item"><div class="icon">‚ÑπÔ∏è</div><div class="text">No entries found in the Hours feed.</div></div>`;
      return;
    }

    const weeks = weekKeysFromEntries(entries);
    if(!weeks.length){
      ["topWeek","topHist","kpi-engineers","kpi-worked","kpi-pred","kpi-remaining"].forEach(id=>$(id).textContent="‚Äì");
      $("suggestions").innerHTML = `<div class="item"><div class="icon">‚ÑπÔ∏è</div><div class="text">No week keys found.</div></div>`;
      return;
    }
    const currentWeekKey = weeks[weeks.length-1];

    const curAgg = aggregateWeek(entries, currentWeekKey);
    const engineers = [...curAgg.values()].sort((a,b)=>a.name.localeCompare(b.name));

    // History (last 6 weeks) for trends/leaderboards & suggestions
    const hist = buildHistory(entries, weeks, 6);

    // KPIs
    const teamWorked = sum(engineers.map(e=>e.worked));
    const teamPred = sum(engineers.map(e=>e.predicted));
    const teamCap = engineers.length * CAP_PER_ENGINEER;

    $("kpi-engineers").textContent = String(engineers.length);
    $("kpi-worked").textContent = fmtHours(teamWorked);
    $("kpi-pred").textContent = fmtHours(teamPred);
    $("kpi-remaining").textContent = fmtHours(Math.max(0,teamCap - teamPred));

    // Top engineer (week & historic)
    const weekRank = engineers
      .map(e=>({ name:e.name, score: weeklyScore(e)}))
      .sort((a,b)=>b.score-a.score);
    $("topWeek").textContent = weekRank.length? `${weekRank[0].name} (${weekRank[0].score.toFixed(0)})` : "‚Äì";

    const histRank = [...hist.history.entries()]
      .map(([name,arr])=>({ name, score: historicScore(arr) }))
      .sort((a,b)=>b.score-a.score);
    $("topHist").textContent = histRank.length? `${histRank[0].name} (${histRank[0].score.toFixed(0)})` : "‚Äì";

    /** ===== Build Leaderboards with human tooltips ===== **/
    const weekly = $("weekly-sections");
    const histBox = $("hist-sections");

    // Weekly ‚Ä¢ Highest Predicted
    const w1 = addSection(
      weekly,
      "This Week ‚Ä¢ Highest Predicted",
      "Shows who‚Äôs expected to log the most hours by Friday based on their current average. Green = steady, red = likely over cap."
    );
    addRows(w1,
      [...engineers].sort((a,b)=>b.predicted-a.predicted).map(e=>{
        const sev=rowSeverityByPred(e.predicted);
        return { sev, lead:`${emojiFor(sev)} ${e.name}`, tail:`${e.predicted.toFixed(2)}h` };
      })
    );

    // Weekly ‚Ä¢ Overtime
    const w2 = addSection(
      weekly,
      "This Week ‚Ä¢ Overtime",
      "Engineers working beyond normal paid hours. Small bits are fine, but regular red here means someone‚Äôs over-stretching."
    );
    addRows(w2,
      [...engineers].sort((a,b)=>b.overtime-a.overtime).map(e=>{
        const sev=rowSeverityByOT(e.overtime);
        return { sev, lead:`${emojiFor(sev)} ${e.name}`, tail:`${e.overtime.toFixed(2)}h` };
      })
    );

    // Weekly ‚Ä¢ Efficiency
    const w3 = addSection(
      weekly,
      "This Week ‚Ä¢ Efficiency",
      "How much of their time is productive vs travel. Higher is better ‚Äî red usually means long journeys or wasted time."
    );
    addRows(w3,
      [...engineers].sort((a,b)=>((b.worked-b.travel)/Math.max(0.1,b.worked)) - ((a.worked-a.travel)/Math.max(0.1,a.worked)))
      .map(e=>{
        const eff = e.worked ? 100*(e.worked-e.travel)/e.worked : 100;
        const sev = eff<75? 'sev-bad' : eff<85? 'sev-warn' : 'sev-ok';
        return { sev, lead:`${emojiFor(sev)} ${e.name}`, tail:`${eff.toFixed(0)}%` };
      })
    );

    // Weekly ‚Ä¢ Van Checks
    const w4 = addSection(
      weekly,
      "This Week ‚Ä¢ Van Checks",
      "Quick look at vehicle compliance for the week. Red = missed checks, which need chasing."
    );
    addRows(w4,
      engineers.map(e=>{
        const icon = e.vanCheck==="Yes" ? 'üü¢' : (e.vanCheck==="No" ? 'üî¥' : '‚ö™');
        const sev = e.vanCheck==="No" ? 'sev-bad' : (e.vanCheck==="Yes" ? 'sev-ok' : '');
        return { sev, lead:`${icon} ${e.name}`, tail:(e.vanCheck==="Yes"?'Passed':e.vanCheck==="No"?'Failed':'‚Äî') };
      })
    );

    // 6-Week ‚Ä¢ Avg Weekly Hours
    const h1 = addSection(
      histBox,
      "6-Week ‚Ä¢ Avg Weekly Hours",
      "Average total hours per week over the last six weeks. Red means they‚Äôre consistently over 45h ‚Äî possible burnout or mis-tracking."
    );
    addRows(h1,
      [...hist.history.entries()].sort((a,b)=>{
        const avga = avg(a[1].map(x=>x.worked));
        const avgb = avg(b[1].map(x=>x.worked));
        return avgb-avga;
      }).map(([name,arr])=>{
        const a = avg(arr.map(x=>x.worked));
        const sev = a>LONG_WEEK_BAD ? 'sev-bad' : a>CAP_PER_ENGINEER ? 'sev-warn' : 'sev-ok';
        return { sev, lead:`${emojiFor(sev)} ${name}`, tail:`${a.toFixed(1)}h` };
      })
    );

    // 6-Week ‚Ä¢ Total Overtime
    const h2 = addSection(
      histBox,
      "6-Week ‚Ä¢ Total Overtime",
      "Sum of all overtime over six weeks. If it‚Äôs high, either the workload‚Äôs too heavy or someone‚Äôs logging late finishes every week."
    );
    addRows(h2,
      [...hist.history.entries()].sort((a,b)=>{
        const sa = sum(a[1].map(x=>x.overtime));
        const sb = sum(b[1].map(x=>x.overtime));
        return sb-sa;
      }).map(([name,arr])=>{
        const tot = sum(arr.map(x=>x.overtime));
        const sev = tot/(arr.length||1) >= OT_BAD ? 'sev-bad' : tot/(arr.length||1) >= OT_WARN ? 'sev-warn' : 'sev-ok';
        return { sev, lead:`${emojiFor(sev)} ${name}`, tail:`${tot.toFixed(1)}h` };
      })
    );

    // 6-Week ‚Ä¢ Efficiency Avg
    const h3 = addSection(
      histBox,
      "6-Week ‚Ä¢ Efficiency Avg",
      "Average efficiency over the last six weeks. A dip here can flag someone with heavy travel or low productivity."
    );
    addRows(h3,
      [...hist.history.entries()].sort((a,b)=>{
        const effA = (()=>{ const w=sum(a[1].map(x=>x.worked)), t=sum(a[1].map(x=>x.travel)); return w? (w-t)/w : 1; })();
        const effB = (()=>{ const w=sum(b[1].map(x=>x.worked)), t=sum(b[1].map(x=>x.travel)); return w? (w-t)/w : 1; })();
        return effB-effA;
      }).map(([name,arr])=>{
        const w=sum(arr.map(x=>x.worked)), t=sum(arr.map(x=>x.travel));
        const eff = w? 100*(w-t)/w : 100;
        const sev = eff<75? 'sev-bad' : eff<85? 'sev-warn' : 'sev-ok';
        return { sev, lead:`${emojiFor(sev)} ${name}`, tail:`${eff.toFixed(0)}%` };
      })
    );

    // 6-Week ‚Ä¢ Van-Check Pass Rate
    const h4 = addSection(
      histBox,
      "6-Week ‚Ä¢ Van-Check Pass Rate",
      "Percentage of weeks each engineer completed their van checks properly. Red = repeatedly missed, needs a reminder."
    );
    addRows(h4,
      [...hist.history.entries()].sort((a,b)=>{
        const ra = a[1].filter(x=>x.vanCheck==="Yes").length / (a[1].length||1);
        const rb = b[1].filter(x=>x.vanCheck==="Yes").length / (b[1].length||1);
        return rb-ra;
      }).map(([name,arr])=>{
        const r = 100 * (arr.filter(x=>x.vanCheck==="Yes").length/(arr.length||1));
        const sev = (r/100)<VC_BAD ? 'sev-bad' : (r<95? 'sev-warn':'sev-ok');
        return { sev, lead:`${emojiFor(sev)} ${name}`, tail:`${r.toFixed(0)}%` };
      })
    );

    /** ===== Charts ===== **/
    const labelWeek = weekLabel(currentWeekKey);
    new Chart($("progressTeam").getContext("2d"),{
      type:"bar",
      data:{ labels:[labelWeek],
        datasets:[
          { label:"Worked (so far)", data:[teamWorked], backgroundColor:"#2563eb" },
          { label:"Team Cap", data:[teamCap], backgroundColor:"#334155" }
        ]
      },
      options:{ plugins:{ legend:{ position:"bottom" } }, scales:{ y:{ beginAtZero:true } } }
    });

    const avgPred = engineers.length ? teamPred/engineers.length : 0;
    new Chart($("progressAvg").getContext("2d"),{
      type:"bar",
      data:{ labels:["Avg engineer (predicted)"],
        datasets:[
          { label:"Predicted (Mon‚ÄìFri)", data:[avgPred], backgroundColor:colorFor(avgPred,CAP_PER_ENGINEER) },
          { label:"Cap", data:[CAP_PER_ENGINEER], backgroundColor:"#334155" }
        ]
      },
      options:{ plugins:{ legend:{ position:"bottom" } }, scales:{ y:{ beginAtZero:true } } }
    });

    const ok = engineers.filter(e=>e.predicted<=0.9*e.cap).length;
    const warn = engineers.filter(e=>e.predicted>0.9*e.cap && e.predicted<=e.cap).length;
    const bad = engineers.filter(e=>e.predicted>e.cap).length;
    new Chart($("donutRisk").getContext("2d"),{
      type:"doughnut",
      data:{ labels:["On track","Close","Over"],
        datasets:[{ data:[ok,warn,bad], backgroundColor:["#10b981","#f59e0b","#ef4444"] }]
      },
      options:{ plugins:{ legend:{ position:"bottom" } }, cutout:"60%" }
    });

    new Chart($("stackedByEngineer").getContext("2d"),{
      type:"bar",
      data:{
        labels: engineers.map(e=>e.name),
        datasets:[
          { label:"Worked (so far)", data: engineers.map(e=>+e.worked.toFixed(2)), backgroundColor: engineers.map(e=>colorFor(e.predicted,e.cap)) },
          { type:"line", label:"Cap (40h)", data: engineers.map(()=>CAP_PER_ENGINEER), borderColor:"#3b82f6", borderWidth:2, pointRadius:0 },
          { type:"line", label:"Predicted (Mon‚ÄìFri)", data: engineers.map(e=>+e.predicted.toFixed(2)), borderColor:"#f59e0b", borderWidth:2, pointRadius:3 }
        ]
      },
      options:{ plugins:{ legend:{ position:"bottom" } }, scales:{ y:{ beginAtZero:true } } }
    });

    const curEntries = entries.filter(e => (e.weekKey||deriveWeekKey(e.date)) === currentWeekKey);
    const byDayTotals = {Mon:0,Tue:0,Wed:0,Thu:0,Fri:0};
    for(const e of curEntries){
      const d = parseISODate(e.date); if(!d) continue;
      const dow = d.getUTCDay();
      if(dow===1) byDayTotals.Mon += toFloat(e.totalHours);
      if(dow===2) byDayTotals.Tue += toFloat(e.totalHours);
      if(dow===3) byDayTotals.Wed += toFloat(e.totalHours);
      if(dow===4) byDayTotals.Thu += toFloat(e.totalHours);
      if(dow===5) byDayTotals.Fri += toFloat(e.totalHours);
    }
    new Chart($("byDay").getContext("2d"),{
      type:"bar",
      data:{ labels:["Mon","Tue","Wed","Thu","Fri"],
        datasets:[{ label:"Team hours", data:[byDayTotals.Mon,byDayTotals.Tue,byDayTotals.Wed,byDayTotals.Thu,byDayTotals.Fri], backgroundColor: "#14b8a6" } ]
      },
      options:{ plugins:{ legend:{ position:"bottom" } }, scales:{ y:{ beginAtZero:true } } }
    });

    /** ===== Suggestions ===== **/
    const suggestions = buildSuggestions(engineers, hist);
    const sug = $("suggestions");
    sug.innerHTML = suggestions.length ? "" : `<div class="item"><div class="icon">‚ÑπÔ∏è</div><div class="text">No notable patterns detected this week.</div></div>`;
    suggestions.forEach(s=>{
      const row = document.createElement('div');
      row.className='item';
      row.innerHTML = `<div class="icon">${s.icon}</div><div class="text">${s.text}<div class="small">${s.small||""}</div></div>`;
      sug.appendChild(row);
    });

  }catch(err){
    console.error(err);
    ["topWeek","topHist","kpi-engineers","kpi-worked","kpi-pred","kpi-remaining"].forEach(id=>$(id).textContent="‚Äì");
    $("suggestions").innerHTML = `<div class="item"><div class="icon">‚ùå</div><div class="text">Failed to load hours: ${err.message}</div></div>`;
  }
})();
</script>
</body>
</html>
