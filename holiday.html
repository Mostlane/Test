<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Mostlane • Holiday Request</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="auth.js"></script>

  <style>
    body{
      margin:0;
      font-family: "Segoe UI", sans-serif;
      background:#e6e8eb url('Mostlane_Embossed.png') no-repeat center center fixed;
      background-size:180%;
      padding:30px 16px;
    }

    .container{
      max-width:1100px;
      margin:auto;
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:20px;
    }

    .card{
      background:rgba(255,255,255,0.75);
      backdrop-filter: blur(6px);
      border-radius:10px;
      padding:24px;
    }

    h2{
      margin-top:0;
      color:#003b82;
      text-align:center;
    }

    label{
      display:block;
      margin-top:14px;
      font-weight:600;
    }

    input, select{
      width:100%;
      padding:10px;
      margin-top:6px;
      font-size:15px;
      border-radius:6px;
      border:1px solid #ccc;
    }

    button{
      margin-top:22px;
      width:100%;
      padding:12px;
      font-size:16px;
      background:#004a99;
      color:white;
      border:none;
      border-radius:6px;
      cursor:pointer;
    }

    button:disabled{
      opacity:.6;
      cursor:not-allowed;
    }

    ul{
      padding-left:18px;
      font-size:14px;
    }

    .top-bar{
      max-width:1100px;
      margin:0 auto 20px;
      display:flex;
      justify-content:space-between;
      align-items:center;
    }

    .top-bar button{
      width:auto;
      padding:8px 14px;
      font-size:14px;
    }

    .stat{
      font-size:15px;
      margin:6px 0;
    }

    .approved{ color:#15803d; }
    .pending{ color:#b45309; }
  </style>
</head>

<body>

<div class="top-bar">
  <strong id="userLabel"></strong>
  <button onclick="location.href='main.html'">Main Menu</button>
</div>

<div class="container">

  <!-- REQUEST FORM -->
  <div class="card">
    <h2>Holiday Request</h2>

    <form id="holidayForm">
      <label>Engineer</label>
      <input id="engineer" readonly>

      <label>Start Date</label>
      <input type="date" id="start" required>

      <label>End Date</label>
      <input type="date" id="end" required>

      <label>Leave Type</label>
      <select id="type">
        <option>Annual Leave</option>
        <option>Sick Leave</option>
        <option>Compulsory Leave</option>
        <option>Unpaid Leave</option>
      </select>

      <label>Notes</label>
      <input id="notes" placeholder="Optional">

      <button id="submitBtn">Submit Request</button>
    </form>
  </div>

  <!-- SUMMARY -->
  <div class="card">
    <h2>My Holiday Summary</h2>

    <div id="summary">
      <p class="stat">Allowance: <strong id="allowance">–</strong></p>
      <p class="stat">Used: <strong id="used">–</strong></p>
      <p class="stat">Remaining: <strong id="remaining">–</strong></p>
    </div>

    <hr>

    <h3>My Requests</h3>
    <ul id="myList"></ul>
  </div>

</div>

<script>
const API = "https://mostlane-holidays.jamie-def.workers.dev";
const user = sessionStorage.getItem("mostlaneUser");
const role = sessionStorage.getItem("mostlaneRole");

document.getElementById("engineer").value = user.replace(".", " ");
document.getElementById("userLabel").innerText = "Logged in as: " + user.replace(".", " ");

async function loadSummary(){
  const res = await fetch(API + "/holiday/summary", {
    headers: { "X-User": user }
  });
  const s = await res.json();
  allowance.innerText = s.allowance;
  used.innerText = s.used;
  remaining.innerText = s.remaining;
}

async function loadMyHolidays(){
  const res = await fetch(API + "/holiday/my", {
    headers: { "X-User": user }
  });
  const data = await res.json();
  myList.innerHTML = "";

  data.sort((a,b)=>new Date(a.start)-new Date(b.start));

  data.forEach(h=>{
    const li = document.createElement("li");
    li.innerHTML = `
      ${h.start} → ${h.end}
      (${h.days} days)
      <strong class="${h.status.toLowerCase()}">– ${h.status}</strong>
    `;
    myList.appendChild(li);
  });
}

holidayForm.addEventListener("submit", async e=>{
  e.preventDefault();
  submitBtn.disabled = true;

  const payload = {
    start: start.value,
    end: end.value,
    type: type.value,
    notes: notes.value
  };

  const res = await fetch(API + "/holiday/request", {
    method:"POST",
    headers:{
      "Content-Type":"application/json",
      "X-User":user,
      "X-Role":role
    },
    body:JSON.stringify(payload)
  });

  submitBtn.disabled = false;

  if(!res.ok){
    alert("Failed to submit request");
    return;
  }

  alert("Holiday request submitted");
  holidayForm.reset();
  loadMyHolidays();
  loadSummary();
});

loadSummary();
loadMyHolidays();
</script>

</body>
</html>
