<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Engineer Hours Entry ‚Äì Mostlane (v4)</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<style>
  *,*::before,*::after{box-sizing:border-box}
  :root{
    --ml-blue:#003366;--ml-accent:#1a73e8;--ml-ink:#27313a;--ml-bg:#e6e8eb;
    --card:#ffffffee;--muted:#718096;--ok:#0c7d27;--bad:#b00020;--warn:#b36b00;--border:#e8edf3;
  }
  html,body{width:100%;max-width:100%;overflow-x:hidden;}
  body{
    font-family:"Segoe UI",system-ui,Roboto,Arial,sans-serif;
    background:var(--ml-bg) url('Mostlane_Embossed.png') no-repeat center center fixed;
    background-size:180% auto;margin:0;padding:40px;color:var(--ml-ink);
  }
  .shell{max-width:1200px;margin:0 auto;background:rgba(255,255,255,0.94);
    border-radius:14px;box-shadow:0 12px 28px rgba(0,0,0,0.12);overflow:hidden;}
  header{display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;
    background:linear-gradient(90deg,#fff,#f7f9fc);border-bottom:1px solid var(--border);padding:18px 24px;gap:10px;}
  header h1{font-size:22px;margin:0;color:var(--ml-blue);}
  header a{background:var(--ml-accent);color:#fff;text-decoration:none;padding:8px 16px;border-radius:8px;font-weight:600;font-size:14px;white-space:nowrap;}
  .contentWrap{display:grid;grid-template-columns: 1fr 300px;gap:18px;align-items:start;}
  .content{padding:22px 24px 28px;}
  .sidebar{padding:22px 18px;border-left:1px solid var(--border);background:#fcfdff;position:sticky;top:0;max-height:100vh;overflow:auto;}
  .sidebar h3{margin:0 0 10px 0;color:var(--ml-blue);font-size:16px;}
  .side-muted{color:var(--muted);font-size:12px;margin-bottom:10px;}
  .checklist{list-style:none;margin:0;padding:0;display:flex;flex-direction:column;gap:6px;}
  .check-item{display:flex;align-items:center;justify-content:space-between;border:1px solid var(--border);border-radius:8px;padding:8px 10px;background:#fff;}
  .check-name{font-size:14px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:210px;}
  .tick{font-size:16px;} .tick.ok{color:#198754;} .tick.missing{color:#94a3b8;}
  .side-bar-top{display:flex;align-items:center;justify-content:space-between;gap:8px;margin-bottom:8px;}
  .side-badge{font-size:12px;border:1px solid var(--border);background:#fff;border-radius:999px;padding:4px 8px;}
  .side-refresh{background:#eef2f9;border:1px solid var(--border);border-radius:8px;padding:6px 8px;cursor:pointer;font-size:12px;}
  .side-refresh:hover{filter:brightness(0.98);}
.grid{display:grid;grid-template-columns:repeat(12,1fr);gap:14px;}
  .card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:16px;}
  .title{font-weight:600;color:var(--ml-blue);margin-bottom:10px;}
  label{font-size:13px;color:#334155;display:block;margin-bottom:6px;}
  input,select,textarea{width:100%;font-size:15px;border:1px solid #cbd5e1;border-radius:10px;padding:10px 12px;background:#fff;}
  input[type="time"],input[type="date"],select{height:40px;}
  textarea{min-height:90px;resize:vertical;}
  .row{display:flex;align-items:flex-start;gap:14px;flex-wrap:wrap;}
  .row>div{flex:1 1 260px;min-width:240px;}
  .toggle-row{display:flex;align-items:center;gap:8px;font-size:15px;cursor:pointer;line-height:1.4;}
  .toggle-row input[type="checkbox"],.toggle-row input[type="radio"]{width:18px;height:18px;accent-color:var(--ml-accent);margin:0;}
  .muted{color:var(--muted);font-size:12px;}
  .divider{height:1px;background:#edf2f7;margin:12px 0;}
  .radio-group{display:flex;gap:16px;align-items:center;flex-wrap:wrap;}

  .totals{display:flex;flex-wrap:wrap;gap:10px;font-weight:600;align-items:center;}
  .pill{padding:8px 12px;border-radius:999px;border:1px solid #d7e1ee;background:#f8fbff;color:#0f172a;display:inline-flex;align-items:center;gap:6px;}
  .pill.ok{border-color:#bfe7ca;background:#effaf3;color:#074e1a;}
  .pill.bad{border-color:#ffc7ce;background:#fff1f3;color:#6b0011;}
  .pill.warn{border-color:#ffd18b;background:#fff6e5;color:#5c3a00;}

  .actions{display:flex;gap:14px;align-items:center;justify-content:flex-end;margin-top:10px;flex-wrap:wrap;}
  button{font-size:15px;font-weight:600;border:0;border-radius:10px;padding:12px 18px;cursor:pointer;}
  .btn-primary{background:var(--ml-accent);color:#fff;}
  .btn-secondary{background:#eef2f9;color:#0f172a;border:1px solid #d7e1ee;}
  .btn-link{background:transparent;color:var(--ml-accent);padding:8px 10px;white-space:nowrap;}

  .col-12{grid-column:span 12;}
  .col-6{grid-column:span 6;}
  @media(max-width:980px){.col-6{grid-column:span 12;}}
  @media(max-width:900px){.contentWrap{grid-template-columns: 1fr;} .sidebar{display:none;}}

  .banner{margin-top:8px;padding:8px 12px;border-radius:10px;border:1px solid var(--border);background:#f7fbff;}
  .overrides{display:flex;flex-wrap:wrap;gap:12px;margin-top:10px;}
  .override-btn{flex:1 1 30%;min-width:160px;text-align:center;padding:10px 12px;border:1px solid #d7e1ee;border-radius:8px;background:#f9fafb;cursor:pointer;font-weight:500;user-select:none;}
  .override-btn.active{background:#eaf1ff;border-color:var(--ml-accent);color:var(--ml-accent);}

  .elog{border:1px dashed #e2e8f0;border-radius:12px;margin-bottom:16px;padding:10px;}
  .elog-head{display:flex;align-items:center;justify-content:space-between;gap:10px;margin-bottom:6px;}
  .elog-title{font-weight:600;color:#0f172a;}
  .elog-actions{display:flex;gap:8px;}
  .elog-actions button{padding:6px 10px;border-radius:8px;font-size:13px;}
  .elog-body{transition:max-height .2s ease;overflow:hidden;}
  .elog.collapsed .elog-body{max-height:0;padding-top:0;padding-bottom:0;border:0;}
  .elog .small-muted{font-size:12px;color:#6b7280;}
</style>
</head>
<body>
<div class="shell">
  <header>
    <h1>Engineer Hours Entry</h1>
    <a href="main.html">Main Menu</a>
  </header>
  <div class="contentWrap">
    <div class="content">
      <!-- Date & Navigation -->
      <div class="card col-12" id="dateCard">
        <div class="title">Day</div>
        <div class="row">
          <div>
            <label>Date</label>
            <input type="date" id="date" required />
            <div id="dateHint" class="muted" style="margin-top:4px;"></div>
            <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:8px;">
              <button type="button" class="btn-link" id="prevDayBtn">‚óÄ Previous</button>
              <button type="button" class="btn-link" id="nextDayBtn">Next ‚ñ∂</button>
              <span class="muted" id="dowHint"></span>
            </div>
            <div id="weekBanner" class="banner" style="display:none;"></div>
          </div>
        </div>
      </div>

      <div id="logsContainer"></div>
      <div class="actions">
        <button type="button" class="btn-secondary" id="addLogBtn">+ Add Engineer Log</button>
        <span class="muted" id="statusMsg"></span>
        <button type="button" class="btn-primary" id="submitAllBtn">Submit All to Payroll</button>
      </div>
      <div class="muted" id="restoreBanner" style="margin-top:10px;display:none;">
        ‚ö†Ô∏è Restored unsent entries from last session. These will clear after a successful submission.
      </div>
    </div>

    <aside class="sidebar">
      <div class="side-bar-top">
        <h3>üìã Daily Checklist</h3>
        <button class="side-refresh" id="refreshChecklistBtn" type="button">Refresh</button>
      </div>
      <div class="side-muted" id="checklistDate">Loading‚Ä¶</div>
      <div class="side-muted" id="checklistCounts"></div>
      <ul class="checklist" id="checklist"></ul>
    </aside>
  </div>
</div>

<script>
/* ====== NEW HELPER FOR DATE FORMATTING ====== */
function formatDateUK(dateStr, short=false){
  if(!dateStr) return "";
  const [y,m,d] = dateStr.split("-");
  return short ? `${d}-${m}-${y.slice(-2)}` : `${d}-${m}-${y}`;
}

/* ====== EXISTING CODE CONTINUES ====== */
const ZAPIER_WEBHOOK="https://hooks.zapier.com/hooks/catch/20261714/u5ibaoi/";
const USERS_JSON_PATH="./users.json";
const HOURS_LOG_URL="https://raw.githubusercontent.com/Mostlane/Test/main/json_logs/hours/hours-log.json";
const DRAFT_KEY="hourEntryDraft_v4";
let USERS_RAW=[],ENGINEERS=[],VEHICLE_SET=new Set();let HOURS_LOG_CACHE={};let LOG_COUNTER=0;
const $=id=>document.getElementById(id);
const OFFICE_BLOCKLIST=new Set(["Chloe Line","Greg Line","Jamie Line","Joanna Marcinkowska","Joe Line","Megan Line","Tanya Chinnery"]);
function timeToMin(t){if(!t||!t.includes(":"))return null;const[h,m]=t.split(":").map(Number);return h*60+m;}
function minsToHr(m){return Math.round((m/60)*100)/100;}
function fmtDate(d){return d.toISOString().split("T")[0];}
function shiftDate(delta){const d=new Date($("date").value+"T12:00");d.setDate(d.getDate()+delta);$("date").value=fmtDate(d);updateDayForAll();}
function dow(d){return new Date(d+"T12:00").toLocaleDateString(undefined,{weekday:"long"});}
function dayNum(d){return new Date(d+"T12:00").getDay();}
function getWeekKey(dateStr){const d=new Date(dateStr+"T12:00");const sun=new Date(d);sun.setDate(d.getDate()-d.getDay());return sun.toISOString().split("T")[0];}
function debounce(fn,ms=300){let t;return(...args)=>{clearTimeout(t);t=setTimeout(()=>fn(...args),ms);};}

/* Update hint display */
function updateDateHint(){
  const v = $("date").value;
  $("dateHint").textContent = v ? `üìÖ ${formatDateUK(v,false)}` : "";
}

/* UpdateDayForAll will also update hint */
function updateDayForAll(){
  const d=$("date").value;if(!d)return;
  updateDateHint();  // new line
  $("dowHint").textContent="Selected: "+dow(d);
  const day=dayNum(d);
  const banner=$("weekBanner");
  if(day!==1){banner.style.display="block";banner.textContent="Enhanced overtime auto-calculates if van-check passed on Monday.";}
  else{banner.style.display="none";banner.textContent="";}
  document.querySelectorAll(".elog").forEach(el=>{
    const id=el.id;
    $(`${id}_mondayBlock`).style.display=day===1?"block":"none";
    $(`${id}_fridayBlock`).style.display=day===5?"block":"none";
    calcTotalsFor(id);
  });
  renderChecklistForDate(d);
}

/* Modify renderChecklistForDate() for formatted date */
function renderChecklistForDate(dateStr){
  const ul=$("checklist");
  const dateNice=new Date(dateStr+"T12:00").toLocaleDateString("en-GB",{weekday:"short",day:"2-digit",month:"short"});
  $("checklistDate").textContent=`For: ${dateNice} (${formatDateUK(dateStr,true)})`;
  const logged=new Set((HOURS_LOG_CACHE?.[dateStr]||[]).map(n=>String(n).trim().toLowerCase()));
  document.querySelectorAll(".elog select[id$='_engineer']").forEach(sel=>{
    const val=sel.value?.trim().toLowerCase();if(val)logged.add(val+" (draft)");
  });
  ul.innerHTML="";let done=0;
  ENGINEERS.forEach(e=>{
    const match=Array.from(logged).find(n=>n===e.name.toLowerCase()||n===e.name.toLowerCase()+" (draft)");
    const isDone=Boolean(match);if(isDone)done++;
    const li=document.createElement("li");li.className="check-item";
    li.innerHTML=`<div class="check-name">${e.name}${match&&match.endsWith("(draft)")?" ‚Ä¢ draft":""}</div><div class="tick ${isDone?"ok":"missing"}">${isDone?"‚úÖ":"‚ö™"}</div>`;
    ul.appendChild(li);
  });
  $("checklistCounts").textContent=`${done} of ${ENGINEERS.length} submitted`;
}

/* Everything else remains unchanged */
window.addEventListener("DOMContentLoaded",init);
</script>
</body>
</html>
