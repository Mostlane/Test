<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Engineer Hours Entry ‚Äì Mostlane (v4)</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<style>
  *,*::before,*::after{box-sizing:border-box}
  :root{
    --ml-blue:#003366;--ml-accent:#1a73e8;--ml-ink:#27313a;--ml-bg:#e6e8eb;
    --card:#ffffffee;--muted:#718096;--ok:#0c7d27;--bad:#b00020;--warn:#b36b00;--border:#e8edf3;
  }
  html,body{width:100%;max-width:100%;overflow-x:hidden;}
  body{
    font-family:"Segoe UI",system-ui,Roboto,Arial,sans-serif;
    background:var(--ml-bg) url('Mostlane_Embossed.png') no-repeat center center fixed;
    background-size:180% auto;margin:0;padding:40px;color:var(--ml-ink);
  }
  .shell{max-width:1200px;margin:0 auto;background:rgba(255,255,255,0.94);
    border-radius:14px;box-shadow:0 12px 28px rgba(0,0,0,0.12);overflow:hidden;}
  header{display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;
    background:linear-gradient(90deg,#fff,#f7f9fc);border-bottom:1px solid var(--border);padding:18px 24px;gap:10px;}
  header h1{font-size:22px;margin:0;color:var(--ml-blue);}
  header a{background:var(--ml-accent);color:#fff;text-decoration:none;padding:8px 16px;border-radius:8px;font-weight:600;font-size:14px;white-space:nowrap;}

  .contentWrap{display:grid;grid-template-columns: 1fr 300px;gap:18px;align-items:start;}
  .content{padding:22px 24px 28px;}
  .sidebar{padding:22px 18px;border-left:1px solid var(--border);background:#fcfdff;position:sticky;top:0;max-height:100vh;overflow:auto;}
  .sidebar h3{margin:0 0 10px 0;color:var(--ml-blue);font-size:16px;}
  .side-muted{color:var(--muted);font-size:12px;margin-bottom:10px;}
  .checklist{list-style:none;margin:0;padding:0;display:flex;flex-direction:column;gap:6px;}
  .check-item{display:flex;align-items:center;justify-content:space-between;border:1px solid var(--border);border-radius:8px;padding:8px 10px;background:#fff;}
  .check-name{font-size:14px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:210px;}
  .tick{font-size:16px;} .tick.ok{color:#198754;} .tick.missing{color:#94a3b8;}
  .side-bar-top{display:flex;align-items:center;justify-content:space-between;gap:8px;margin-bottom:8px;}
  .side-badge{font-size:12px;border:1px solid var(--border);background:#fff;border-radius:999px;padding:4px 8px;}
  .side-refresh{background:#eef2f9;border:1px solid var(--border);border-radius:8px;padding:6px 8px;cursor:pointer;font-size:12px;}
  .side-refresh:hover{filter:brightness(0.98);}

  .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:14px;}
  .card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:16px;}
  .title{font-weight:600;color:var(--ml-blue);margin-bottom:10px;}
  label{font-size:13px;color:#334155;display:block;margin-bottom:6px;}
  input,select,textarea{width:100%;font-size:15px;border:1px solid #cbd5e1;border-radius:10px;padding:10px 12px;background:#fff;}
  input[type="time"],input[type="date"],select{height:40px;}
  textarea{min-height:90px;resize:vertical;}
  .row{display:flex;align-items:flex-start;gap:14px;flex-wrap:wrap;}
  .row>div{flex:1 1 260px;min-width:240px;}
  .toggle-row{display:flex;align-items:center;gap:8px;font-size:15px;cursor:pointer;line-height:1.4;}
  .toggle-row input[type="checkbox"],.toggle-row input[type="radio"]{width:18px;height:18px;accent-color:var(--ml-accent);margin:0;}
  .muted{color:var(--muted);font-size:12px;}
  .divider{height:1px;background:#edf2f7;margin:12px 0;}
  .radio-group{display:flex;gap:16px;align-items:center;flex-wrap:wrap;}

  .totals{display:flex;flex-wrap:wrap;gap:10px;font-weight:600;align-items:center;}
  .pill{padding:8px 12px;border-radius:999px;border:1px solid #d7e1ee;background:#f8fbff;color:#0f172a;display:inline-flex;align-items:center;gap:6px;}
  .pill.ok{border-color:#bfe7ca;background:#effaf3;color:#074e1a;}
  .pill.bad{border-color:#ffc7ce;background:#fff1f3;color:#6b0011;}
  .pill.warn{border-color:#ffd18b;background:#fff6e5;color:#5c3a00;}

  .actions{display:flex;gap:14px;align-items:center;justify-content:flex-end;margin-top:10px;flex-wrap:wrap;}
  button{font-size:15px;font-weight:600;border:0;border-radius:10px;padding:12px 18px;cursor:pointer;}
  .btn-primary{background:var(--ml-accent);color:#fff;}
  .btn-secondary{background:#eef2f9;color:#0f172a;border:1px solid #d7e1ee;}
  .btn-link{background:transparent;color:var(--ml-accent);padding:8px 10px;white-space:nowrap;}

  .col-12{grid-column:span 12;}
  .col-6{grid-column:span 6;}
  @media(max-width:980px){.col-6{grid-column:span 12;}}
  @media(max-width:900px){.contentWrap{grid-template-columns: 1fr;} .sidebar{display:none;}}

  .banner{margin-top:8px;padding:8px 12px;border-radius:10px;border:1px solid var(--border);background:#f7fbff;}
  .overrides{display:flex;flex-wrap:wrap;gap:12px;margin-top:10px;}
  .override-btn{flex:1 1 30%;min-width:160px;text-align:center;padding:10px 12px;border:1px solid #d7e1ee;border-radius:8px;background:#f9fafb;cursor:pointer;font-weight:500;user-select:none;}
  .override-btn.active{background:#eaf1ff;border-color:var(--ml-accent);color:var(--ml-accent);}

  /* Engineer log wrapper (collapsible) */
  .elog{border:1px dashed #e2e8f0;border-radius:12px;margin-bottom:16px;padding:10px;}
  .elog-head{display:flex;align-items:center;justify-content:space-between;gap:10px;margin-bottom:6px;}
  .elog-title{font-weight:600;color:#0f172a;}
  .elog-actions{display:flex;gap:8px;}
  .elog-actions button{padding:6px 10px;border-radius:8px;font-size:13px;}
  .elog-body{transition:max-height .2s ease;overflow:hidden;}
  .elog.collapsed .elog-body{max-height:0;padding-top:0;padding-bottom:0;border:0;}
  .elog .small-muted{font-size:12px;color:#6b7280;}
</style>
</head>
<body>
<div class="shell">
  <header>
    <h1>Engineer Hours Entry</h1>
    <a href="main.html">Main Menu</a>
  </header>

  <div class="contentWrap">
    <!-- LEFT -->
    <div class="content">
      <!-- Date & Navigation -->
      <div class="card col-12" id="dateCard">
        <div class="title">Day</div>
        <div class="row">
          <div>
            <label>Date</label>
            <input type="date" id="date" required />
            <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:8px;">
              <button type="button" class="btn-link" id="prevDayBtn">‚óÄ Previous</button>
              <button type="button" class="btn-link" id="nextDayBtn">Next ‚ñ∂</button>
              <span class="muted" id="dowHint"></span>
            </div>
            <div id="weekBanner" class="banner" style="display:none;"></div>
          </div>
        </div>
      </div>

      <!-- Engineer Logs container -->
      <div id="logsContainer"></div>

      <!-- Add / Submit -->
      <div class="actions">
        <button type="button" class="btn-secondary" id="addLogBtn">+ Add Engineer Log</button>
        <span class="muted" id="statusMsg"></span>
        <button type="button" class="btn-primary" id="submitAllBtn">Submit All to Payroll</button>
      </div>

      <div class="muted" id="restoreBanner" style="margin-top:10px;display:none;">
        ‚ö†Ô∏è Restored unsent entries from last session. These will clear after a successful submission.
      </div>
    </div>

    <!-- RIGHT: CHECKLIST -->
    <aside class="sidebar">
      <div class="side-bar-top">
        <h3>üìã Daily Checklist</h3>
        <button class="side-refresh" id="refreshChecklistBtn" type="button">Refresh</button>
      </div>
      <div class="side-muted" id="checklistDate">Loading‚Ä¶</div>
      <div class="side-muted" id="checklistCounts"></div>
      <ul class="checklist" id="checklist"></ul>
    </aside>
  </div>
</div>

<script>
/* ====== CONFIG ====== */
const ZAPIER_WEBHOOK = "https://hooks.zapier.com/hooks/catch/20261714/u5ibaoi/";
const USERS_JSON_PATH = "./users.json";
const HOURS_LOG_URL = "https://raw.githubusercontent.com/Mostlane/Test/main/json_logs/hours/hours-log.json";
const DRAFT_KEY = "hourEntryDraft_v4";

/* ====== STATE ====== */
let USERS_RAW = [], ENGINEERS = [], VEHICLE_SET = new Set();
let HOURS_LOG_CACHE = {}; // { "YYYY-MM-DD": ["Name", ...] }
let LOG_COUNTER = 0;
const $ = id => document.getElementById(id);

/* === Office staff blocklist (exclude from engineers & checklist) === */
const OFFICE_BLOCKLIST = new Set([
  "Chloe Line",
  "Greg Line",
  "Jamie Line",
  "Joanna Marcinkowska",
  "Joe Line",
  "Megan Line",
  "Tanya Chinnery"
]);

/* ====== HELPERS ====== */
function timeToMin(t){ if(!t||!t.includes(":")) return null; const [h,m]=t.split(":").map(Number); return h*60+m; }
function minsToHr(m){ return Math.round((m/60)*100)/100; }
function fmtDate(d){ return d.toISOString().split("T")[0]; }
function shiftDate(delta){ const d=new Date($("date").value+"T12:00"); d.setDate(d.getDate()+delta); $("date").value=fmtDate(d); updateDayForAll(); }
function dow(d){ return new Date(d+"T12:00").toLocaleDateString(undefined,{weekday:"long"}); }
function dayNum(d){ return new Date(d+"T12:00").getDay(); }
function getWeekKey(dateStr){ const d=new Date(dateStr+"T12:00"); const sun=new Date(d); sun.setDate(d.getDate()-d.getDay()); return sun.toISOString().split("T")[0]; }
function debounce(fn,ms=300){ let t; return (...args)=>{ clearTimeout(t); t=setTimeout(()=>fn(...args),ms); }; }

/* ====== INIT ====== */
async function init(){
  // Load users.json cache-busted
  try{
    const r=await fetch(USERS_JSON_PATH + "?t=" + Date.now(), {cache:"no-store"});
    const j=await r.json(); USERS_RAW=j.Users||j;
  }catch{ USERS_RAW=[]; }

  // Build ENGINEERS list: Active and NOT in office blocklist
  ENGINEERS = USERS_RAW
    .filter(u=>u.Status==="Active")
    .map(u=>({name:`${u.FirstName} ${u.LastName}`.trim(), username:u.Username, vehicle:u.VehicleAssigned||""}))
    .filter(e=>!OFFICE_BLOCKLIST.has(e.name))
    .sort((a,b)=>a.name.localeCompare(b.name));

  USERS_RAW.forEach(u=>{ if(u.VehicleAssigned) VEHICLE_SET.add(u.VehicleAssigned); });

  // Default date = yesterday
  const y=new Date(); y.setDate(y.getDate()-1); $("date").value=fmtDate(y);
  document.getElementById("prevDayBtn").onclick=()=>shiftDate(-1);
  document.getElementById("nextDayBtn").onclick=()=>shiftDate(1);
  document.getElementById("date").addEventListener("change", ()=>{ updateDayForAll(); saveDraft(); });

  // Add first log
  addEngineerLog();
  // Restore draft if exists
  restoreDraftIfAny();

  // Checklist hooks
  $("refreshChecklistBtn").onclick=()=>refreshChecklist();
  await refreshChecklist(); // initial

  // Submission
  $("addLogBtn").onclick=()=>addEngineerLog();
  $("submitAllBtn").onclick=()=>submitAll();

  // Initial banner
  updateDayForAll();
}

/* ====== CREATE A LOG BLOCK ====== */
function addEngineerLog(initial={}){
  LOG_COUNTER++;
  const id = "elog_" + LOG_COUNTER;

  const wrapper = document.createElement("div");
  wrapper.className = "elog";
  wrapper.id = id;

  wrapper.innerHTML = `
    <div class="elog-head">
      <div class="elog-title">Engineer Log #${LOG_COUNTER} <span class="small-muted" id="${id}_engLabel"></span></div>
      <div class="elog-actions">
        <button type="button" class="btn-secondary" id="${id}_toggleBtn">Collapse</button>
        <button type="button" class="btn-secondary" id="${id}_removeBtn">Remove</button>
      </div>
    </div>
    <div class="elog-body">
      <div class="card">
        <div class="title">Engineer & Vehicle</div>
        <div class="row">
          <div>
            <label>Engineer</label>
            <select id="${id}_engineer" required></select>
            <div class="muted">Active users from users.json</div>
          </div>
          <div>
            <label>Vehicle Used</label>
            <input type="text" id="${id}_vehicle" list="${id}_vehicleList" placeholder="e.g. LA70 FPJ" />
            <datalist id="${id}_vehicleList"></datalist>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="title">Times (24h)</div>
        <div class="grid" style="grid-template-columns:repeat(12,1fr);gap:10px;">
          <div style="grid-column:span 3;"><label>Leave Home</label><input type="time" id="${id}_leaveHome" required></div>
          <div style="grid-column:span 3;"><label>Arrive First</label><input type="time" id="${id}_arriveFirst" required></div>
          <div style="grid-column:span 3;"><label>Leave Last</label><input type="time" id="${id}_leaveLast" required></div>
          <div style="grid-column:span 3;"><label>Arrive Home</label><input type="time" id="${id}_arriveHome" required></div>
        </div>
        <div class="divider"></div>
        <label class="toggle-row"><input type="checkbox" id="${id}_deductLunch" checked> Deduct 30m lunch</label>
      </div>

      <div class="card">
        <div class="title">Vehicle, Mileage & Notes</div>
        <div id="${id}_mondayBlock" style="display:none;margin-bottom:10px;">
          <label>Monday ‚Äì Van check?</label>
          <div class="radio-group">
            <label class="toggle-row"><input type="radio" name="${id}_vanCheck" value="Yes">Yes</label>
            <label class="toggle-row"><input type="radio" name="${id}_vanCheck" value="No">No</label>
            <label class="toggle-row"><input type="radio" name="${id}_vanCheck" value="N/A">N/A</label>
          </div>
          <div class="muted">If ‚ÄúNo‚Äù, payroll will pay standard rate only for the whole week.</div>
        </div>
        <div id="${id}_fridayBlock" style="display:none;margin-bottom:10px;">
          <label>Friday ‚Äì Van score (0‚Äì100)</label>
          <input type="number" id="${id}_vanScore" min="0" max="100">
          <label style="margin-top:8px;">Personal mileage (weekly)</label>
          <input type="number" id="${id}_personalMileage" min="0" step="1">
        </div>
        <div class="divider"></div>
        <div class="row" style="align-items:flex-start;">
          <div>
            <label>Office notes</label>
            <textarea id="${id}_notes" placeholder="e.g. traffic delay, extra stop..."></textarea>
          </div>
          <div style="max-width:360px;">
            <label>Visibility</label>
            <label class="toggle-row"><input type="checkbox" id="${id}_noteVisible"> Visible to engineer</label>
            <div class="muted">Default off</div>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="title">Calculated Totals</div>
        <div class="totals">
          <span class="pill">Total: <span id="${id}_t_total">0.00</span>h</span>
          <span class="pill ok">Standard: <span id="${id}_t_std">0.00</span>h</span>
          <span class="pill" id="${id}_otPill">Overtime: <span id="${id}_t_ot">0.00</span>h</span>
          <span class="pill" id="${id}_enhPill">Enhanced OT: <span id="${id}_t_enh">Yes</span></span>
          <span class="pill">Travel ‚ûú <span id="${id}_t_travel">0.00</span>h <span class="muted" id="${id}_t_travel_parts"></span></span>
        </div>
        <div class="divider"></div>
        <label class="toggle-row"><input type="checkbox" id="${id}_manualOverride"> Override automatic overtime</label>
        <div id="${id}_manualEntry" style="display:none;margin-top:6px;">
          <label>Enter manual overtime hours</label>
          <input type="number" id="${id}_manualOTHours" min="0" step="0.25" placeholder="e.g. 2.0">
          <div class="muted">Standard hours will adjust to keep Total = Standard + Overtime.</div>
        </div>
        <div class="divider"></div>
        <div class="title" style="font-size:15px;">Override Options</div>
        <div class="overrides">
          <div class="override-btn" id="${id}_btnOneOff">One-Off Overtime</div>
          <div class="override-btn" id="${id}_btnForceEnh">Force Enhanced OT</div>
          <div class="override-btn" id="${id}_btnExclude">Exclude from Pay</div>
        </div>
        <div class="muted" id="${id}_logicNote" style="margin-top:8px;"></div>
      </div>
    </div>
  `;

  $("logsContainer").appendChild(wrapper);

  // Fill engineer select and vehicle datalist
  const engSel = $(`${id}_engineer`);
  ENGINEERS.forEach(e=>{ const o=document.createElement("option"); o.value=e.name; o.textContent=e.name; o.dataset.vehicle=e.vehicle; engSel.appendChild(o); });
  const vdl = $(`${id}_vehicleList`);
  Array.from(VEHICLE_SET).sort().forEach(v=>{ const o=document.createElement("option"); o.value=v; vdl.appendChild(o); });

  // Events
  $(`${id}_removeBtn`).onclick=()=>{ wrapper.remove(); saveDraft(); renderChecklistForDate($("date").value); };
  $(`${id}_toggleBtn`).onclick=()=>{ wrapper.classList.toggle("collapsed"); $(`${id}_toggleBtn`).textContent = wrapper.classList.contains("collapsed") ? "Expand" : "Collapse"; };
  engSel.onchange=()=>{ const v=engSel.options[engSel.selectedIndex]?.dataset.vehicle||""; $(`${id}_vehicle`).value=v; $(`${id}_engLabel`).textContent = "‚Äì " + engSel.value; saveDraft(); renderChecklistForDate($("date").value); };

[
  "_leaveHome","_arriveFirst","_leaveLast","_arriveHome",
  "_deductLunch","_manualOTHours","_vanScore","_personalMileage",
  "_notes","_noteVisible"
].forEach(suffix=>{
  const el = $(`${id}${suffix}`);
  if(!el) return;
  // Trigger autosave & recalculation on both input & change
  el.addEventListener("input", ()=>{ calcTotalsFor(id); saveDraftDebounced(); });
  el.addEventListener("change", ()=>{ calcTotalsFor(id); saveDraft(); });
});

  Array.from(wrapper.querySelectorAll(`input[name="${id}_vanCheck"]`)).forEach(r=>{
    r.addEventListener("change", ()=>{ calcTotalsFor(id); saveDraft(); });
  });
  $(`${id}_manualOverride`).onchange=()=>{ $(`${id}_manualEntry`).style.display = $(`${id}_manualOverride`).checked ? "block" : "none"; calcTotalsFor(id); saveDraft(); };
  $(`${id}_btnOneOff`).onclick=()=>{ toggleOverrideBtn(`${id}_btnOneOff`); calcTotalsFor(id); saveDraft(); };
  $(`${id}_btnForceEnh`).onclick=()=>{ toggleOverrideBtn(`${id}_btnForceEnh`); calcTotalsFor(id); saveDraft(); };
  $(`${id}_btnExclude`).onclick=()=>{ toggleOverrideBtn(`${id}_btnExclude`); calcTotalsFor(id); saveDraft(); };

  // --- NEW: Default first engineer auto-select (unless initial provided) + auto-populate vehicle ---
  if (!initial.engineer && engSel.options.length) {
    engSel.selectedIndex = 0;
    engSel.dispatchEvent(new Event("change")); // sets vehicle & label immediately
  }

  // Init values (if provided)
  if(initial.engineer){ engSel.value = initial.engineer; engSel.dispatchEvent(new Event("change")); }
  if(initial.vehicle){ $(`${id}_vehicle`).value = initial.vehicle; }
  ["leaveHome","arriveFirst","leaveLast","arriveHome","notes","vanScore","personalMileage","manualOTHours"].forEach(k=>{
    if(initial[k]!=null) $(`${id}_${k}`).value = initial[k];
  });
  if(initial.noteVisible) $(`${id}_noteVisible`).checked = true;
  if(initial.deductLunch===false) $(`${id}_deductLunch`).checked = false;
  if(initial.manualOverride) $(`${id}_manualOverride`).checked = true, $(`${id}_manualEntry`).style.display="block";
  if(initial.oneOff) $(`${id}_btnOneOff`).classList.add("active");
  if(initial.forceEnhanced) $(`${id}_btnForceEnh`).classList.add("active");
  if(initial.excludeFromPay) $(`${id}_btnExclude`).classList.add("active");
  if(initial.vanCheck){ const r=wrapper.querySelector(`input[name="${id}_vanCheck"][value="${initial.vanCheck}"]`); if(r) r.checked = true; }

  // Show/hide Mon/Fri sections
  toggleMonFriForLog(id);
  // Calc once
  calcTotalsFor(id);
  // Update checklist with draft engineer
  renderChecklistForDate($("date").value);
}

function toggleOverrideBtn(domId){ $(domId).classList.toggle("active"); }

/* ====== PER-LOG CALC ====== */
function calcTotalsFor(id){
  const get = s => $(`${id}_${s}`);

  const t1=timeToMin(get("leaveHome").value),
        t2=timeToMin(get("arriveFirst").value),
        t3=timeToMin(get("leaveLast").value),
        t4=timeToMin(get("arriveHome").value);

  if([t1,t2,t3,t4].some(v=>v==null)){
    get("t_total").textContent="0.00"; get("t_std").textContent="0.00"; get("t_ot").textContent="0.00";
    get("t_travel").textContent="0.00"; get("t_travel_parts").textContent=""; get("t_enh").textContent="Yes";
    get("enhPill").className="pill"; get("logicNote").textContent=""; return;
  }

  // Core totals
  let totalMins = t4 - t1;
  if (get("deductLunch").checked) totalMins -= 30;
  if (totalMins < 0) totalMins = 0;

  let total = minsToHr(totalMins);
  let std   = Math.min(10, total);
  let ot    = Math.max(0, +(total - 10).toFixed(2));

  // Travel
  const toMins = Math.max(0, t2 - t1);
  const fromMins = Math.max(0, t4 - t3);
  const travelTo = minsToHr(toMins);
  const travelFrom = minsToHr(fromMins);
  const travelTotal = minsToHr(toMins + fromMins);

  // Enhanced OT (preview)
  const d=$("date").value; const isMonday = dayNum(d)===1;
  let enhanced = true, msg="Enhanced overtime if total > 10h.";
  if(isMonday){
    const v = document.querySelector(`input[name="${id}_vanCheck"]:checked`);
    if(v){
      if(v.value==="No"){ enhanced=false; msg="Van check = No ‚Üí this Monday paid at standard rate only."; }
      if(v.value==="Yes" || v.value==="N/A"){ enhanced=true; msg="Van check completed ‚Üí enhanced OT applies if >10h."; }
    }else{ msg="Select Monday van check status."; }
  }else{
    msg="Overtime preview shown. Payroll will apply weekly van-check rule.";
  }

  // Overrides
  const oneOff = get("btnOneOff").classList.contains("active");
  const forceEnh = get("btnForceEnh").classList.contains("active");
  const exclude = get("btnExclude").classList.contains("active");
  const manualOn = get("manualOverride").checked;
  const manualVal = parseFloat(get("manualOTHours").value);

  if (oneOff) { ot = total; std = 0; }
  else if (manualOn && !isNaN(manualVal)) { ot = Math.max(0, Math.min(total, +manualVal)); std = Math.max(0, +(total - ot).toFixed(2)); }

  if (forceEnh) enhanced = true;

  // Display
  get("t_total").textContent = total.toFixed(2);
  get("t_std").textContent   = std.toFixed(2);
  get("t_ot").textContent    = ot.toFixed(2);
  get("t_travel").textContent = travelTotal.toFixed(2);
  get("t_travel_parts").textContent = `(${travelTo.toFixed(2)}h to ‚Ä¢ ${travelFrom.toFixed(2)}h from)`;

  // Pill styles & note
  const otPill = get("otPill");
  if (exclude) {
    otPill.className = "pill warn"; get("enhPill").className = "pill warn";
    msg = "Day marked to be excluded from pay. Totals shown for reference only.";
  } else if (oneOff || manualOn) {
    otPill.className = "pill warn";
    msg = (oneOff ? "One-Off Overtime applied. " : "Manual overtime override in effect. ") + (isMonday ? "" : "Payroll will still apply weekly van-check rule.");
  } else {
    otPill.className = "pill";
  }
  get("t_enh").textContent = enhanced ? "Yes" : "No";
  get("enhPill").className = enhanced ? "pill ok" : "pill bad";
  get("logicNote").textContent = msg;
}

/* ====== DAY CHANGES (apply to all logs) ====== */
function updateDayForAll(){
  const d = $("date").value; if(!d) return;
  $("dowHint").textContent = "Selected: " + dow(d);
  const day = dayNum(d);
  const banner = $("weekBanner");
  if(day!==1){ banner.style.display="block"; banner.textContent="Enhanced overtime for this day is automatically calculated if the engineer qualifies by the van check being completed on Monday‚Äôs submission."; }
  else { banner.style.display="none"; banner.textContent=""; }

  document.querySelectorAll(".elog").forEach(el=>{
    const id = el.id;
    $(`${id}_mondayBlock`).style.display = day===1 ? "block" : "none";
    $(`${id}_fridayBlock`).style.display = day===5 ? "block" : "none";
    calcTotalsFor(id);
  });

  renderChecklistForDate(d);
}

/* ====== CHECKLIST ====== */
async function refreshChecklist(){
  try{
    const res = await fetch(HOURS_LOG_URL + "?t=" + Date.now(), {cache:"no-store"});
    HOURS_LOG_CACHE = await res.json();
  }catch{ HOURS_LOG_CACHE = {}; }
  renderChecklistForDate($("date").value);
}
function renderChecklistForDate(dateStr){
  const ul = $("checklist");
  const dateNice = new Date(dateStr+"T12:00").toLocaleDateString("en-GB",{weekday:"short", day:"2-digit", month:"short"});
  $("checklistDate").textContent = `For: ${dateNice} (${dateStr})`;

  // From log
  const logged = new Set((HOURS_LOG_CACHE?.[dateStr] || []).map(n=>String(n).trim().toLowerCase()));
  // From current draft (engineers selected)
  document.querySelectorAll(".elog select[id$='_engineer']").forEach(sel=>{
    const val = sel.value?.trim().toLowerCase(); if(val) logged.add(val+" (draft)");
  });

  ul.innerHTML = "";
  let done=0;
  // Use ENGINEERS (already filtered ‚Äì office excluded)
  ENGINEERS.forEach(e=>{
    const match = Array.from(logged).find(n=>n===e.name.toLowerCase() || n===e.name.toLowerCase()+" (draft)");
    const isDone = Boolean(match);
    if(isDone) done++;
    const li = document.createElement("li");
    li.className = "check-item";
    const left = document.createElement("div");
    left.className = "check-name";
    left.textContent = e.name + (match && match.endsWith("(draft)") ? " ‚Ä¢ draft" : "");
    const right = document.createElement("div");
    right.className = "tick " + (isDone ? "ok" : "missing");
    right.textContent = isDone ? "‚úÖ" : "‚ö™";
    li.appendChild(left); li.appendChild(right);
    ul.appendChild(li);
  });
  $("checklistCounts").textContent = `${done} of ${ENGINEERS.length} submitted`;
}

/* ====== AUTOSAVE (localStorage) ====== */
const saveDraftDebounced = debounce(saveDraft, 400);
function saveDraft(){
  const date = $("date").value;
  const entries = serializeAllLogs();
  const draft = { date, entries, savedAt:new Date().toISOString() };
  localStorage.setItem(DRAFT_KEY, JSON.stringify(draft));
}
function restoreDraftIfAny(){
  const raw = localStorage.getItem(DRAFT_KEY);
  if(!raw) return;

  try{
    const draft = JSON.parse(raw);
    if(!draft || !draft.entries || !draft.entries.length) return;

    $("logsContainer").innerHTML = "";
    LOG_COUNTER = 0;
    $("date").value = draft.date || $("date").value;

    // Rebuild each engineer block fully and then apply stored values
    draft.entries.forEach(saved => {
      addEngineerLog(); // create a fresh log
      const id = "elog_" + LOG_COUNTER; // matches the most recent one
      const get = s => $(`${id}_${s}`);
      if(!get("engineer")) return;

      get("engineer").value = saved.engineer || "";
      get("engineer").dispatchEvent(new Event("change"));
      get("vehicle").value = saved.vehicle || "";

      ["leaveHome","arriveFirstSite","leaveLastSite","arriveHome"].forEach(k=>{
        if(saved[k]) get(k.replace("Site","")).value = saved[k];
      });

      if(saved.notes) get("notes").value = saved.notes;
      if(saved.noteVisible) get("noteVisible").checked = true;
      if(saved.deductLunch === false) get("deductLunch").checked = false;
      if(saved.vanCheck){
        const r=document.querySelector(`input[name="${id}_vanCheck"][value="${saved.vanCheck}"]`);
        if(r) r.checked = true;
      }
      if(saved.vanScore) get("vanScore").value = saved.vanScore;
      if(saved.personalMileage) get("personalMileage").value = saved.personalMileage;
      if(saved.manualOvertimeHours) get("manualOTHours").value = saved.manualOvertimeHours;
      if(saved.manualOvertimeApplied) get("manualOverride").checked = true, get("manualEntry").style.display="block";
      if(saved.forceEnhanced) get("btnForceEnh").classList.add("active");
      if(saved.excludeFromPay) get("btnExclude").classList.add("active");
      if(saved.oneOff) get("btnOneOff").classList.add("active");

      calcTotalsFor(id);
    });

    $("restoreBanner").style.display = "block";
    $("restoreBanner").innerHTML = `<span style="color:green;">‚úÖ Restored unsent entries from last session.</span>`;
    updateDayForAll();
  }catch(e){
    console.error("Restore error:", e);
  }
}

function clearDraft(){ localStorage.removeItem(DRAFT_KEY); $("restoreBanner").style.display="none"; }

/* ====== GATHER / SUBMIT ====== */
function serializeAllLogs(){
  const d = $("date").value;
  const weekKey = getWeekKey(d);
  const day = dow(d);
  const arr = [];
  document.querySelectorAll(".elog").forEach(el=>{
    const id = el.id;
    const get = s => $(`${id}_${s}`);

    const engineer = get("engineer").value;
    if(!engineer) return; // skip incomplete
    const vehicle = get("vehicle").value;

    const leaveHome = get("leaveHome").value;
    const arriveFirst = get("arriveFirst").value;
    const leaveLast = get("leaveLast").value;
    const arriveHome = get("arriveHome").value;

    const t1=timeToMin(leaveHome), t2=timeToMin(arriveFirst), t3=timeToMin(leaveLast), t4=timeToMin(arriveHome);
    const travelTo = (t1!=null && t2!=null) ? minsToHr(Math.max(0, t2 - t1)) : 0;
    const travelFrom = (t3!=null && t4!=null) ? minsToHr(Math.max(0, t4 - t3)) : 0;
    const travelTotal = +(travelTo + travelFrom).toFixed(2);

    const totalHours = get("t_total").textContent;
    const standardHours = get("t_std").textContent;
    const overtimeHours = get("t_ot").textContent;
    const enhancedOvertimePreview = get("t_enh").textContent;

    let vanCheck=null, vanCheckWeekStatus="";
    if(dayNum(d)===1){
      const v = document.querySelector(`input[name="${id}_vanCheck"]:checked`);
      vanCheck = v ? v.value : null;
      if(v){
        if(v.value==="No") vanCheckWeekStatus="Failed";
        if(v.value==="Yes" || v.value==="N/A") vanCheckWeekStatus="Passed";
      }
    }
    const vanScore = get("vanScore")?.value || "";
    const personalMileage = (dayNum(d)===5) ? (get("personalMileage")?.value || "") : "";

    const notes = get("notes").value.trim();
    const noteVisible = get("noteVisible").checked;

    const manualOvertimeApplied = get("manualOverride").checked || get("btnOneOff").classList.contains("active");
    const manualOvertimeHours = get("btnOneOff").classList.contains("active")
      ? totalHours
      : (get("manualOverride").checked ? (get("manualOTHours").value || "") : "");
    const forceEnhanced = get("btnForceEnh").classList.contains("active");
    const excludeFromPay = get("btnExclude").classList.contains("active");

    arr.push({
      date: d,
      day,
      weekKey,
      vanCheckWeekStatus,
      engineer,
      vehicle,
      leaveHome,
      arriveFirstSite: arriveFirst,
      leaveLastSite: leaveLast,
      arriveHome,
      deductLunch: get("deductLunch").checked,
      totalHours,
      standardHours,
      overtimeHours,
      enhancedOvertimePreview,
      travelToHours: travelTo,
      travelFromHours: travelFrom,
      totalTravelHours: travelTotal,
      vanCheck,
      vanScore,
      personalMileage,
      notes,
      noteVisible,
      manualOvertimeApplied,
      manualOvertimeHours,
      forceEnhanced,
      excludeFromPay,
      submittedAt: new Date().toISOString()
    });
  });
  return arr;
}

async function submitAll(){
  $("statusMsg").style.color="#475569";
  $("statusMsg").textContent="Validating‚Ä¶";

  const entries = serializeAllLogs();
  if(entries.length===0){
    $("statusMsg").style.color="var(--bad)";
    $("statusMsg").textContent="‚ùå No complete engineer logs to submit.";
    return;
  }

  const invalid = entries.find(e=>!e.engineer || !e.leaveHome || !e.arriveFirstSite || !e.leaveLastSite || !e.arriveHome);
  if(invalid){
    $("statusMsg").style.color="var(--bad)";
    $("statusMsg").textContent="‚ùå Some logs are incomplete. Please fill all time fields and engineer.";
    return;
  }

  $("statusMsg").textContent="Submitting‚Ä¶";

  const payload = new URLSearchParams();
 // Ensure booleans remain booleans (not strings)
entries.forEach(e => {
  e.deductLunch = !!e.deductLunch;
});
  payload.append("entries", JSON.stringify(entries));

  try{
    const r=await fetch(ZAPIER_WEBHOOK,{
      method:"POST",
      headers:{ "Content-Type":"application/x-www-form-urlencoded;charset=UTF-8" },
      body: payload
    });
    if(r.ok){
      $("statusMsg").style.color="var(--ok)";
      $("statusMsg").textContent="‚úÖ Submitted all logs";
      const d = $("date").value;
      if(!HOURS_LOG_CACHE[d]) HOURS_LOG_CACHE[d] = [];
      entries.forEach(e=>{
        if(!HOURS_LOG_CACHE[d].includes(e.engineer)) HOURS_LOG_CACHE[d].push(e.engineer);
      });
      renderChecklistForDate(d);
      clearDraft();
    }else{
      $("statusMsg").style.color="var(--bad)";
      $("statusMsg").textContent="‚ùå Submission failed ‚Äî data kept locally.";
    }
  }catch(err){
    $("statusMsg").style.color="var(--bad)";
    $("statusMsg").textContent="‚ùå Network error ‚Äî data kept locally.";
  }
}

/* ====== UTIL ====== */
function toggleMonFriForLog(id){
  const day = dayNum($("date").value);
  $(`${id}_mondayBlock`).style.display = day===1 ? "block" : "none";
  $(`${id}_fridayBlock`).style.display = day===5 ? "block" : "none";
}

/* ====== BOOT ====== */
window.addEventListener("DOMContentLoaded", init);
</script>
</body>
</html>
