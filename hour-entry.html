function calcTotalsFor(id){
  const get = s => $(`${id}_${s}`);

  const t1=timeToMin(get("leaveHome").value),
        t2=timeToMin(get("arriveFirst").value),
        t3=timeToMin(get("leaveLast").value),
        t4=timeToMin(get("arriveHome").value);

  if([t1,t2,t3,t4].some(v=>v==null)){
    get("t_total").textContent="0.00"; get("t_std").textContent="0.00"; get("t_ot").textContent="0.00";
    get("t_travel").textContent="0.00"; get("t_travel_parts").textContent=""; get("t_enh").textContent="Yes";
    get("enhPill").className="pill"; get("logicNote").textContent=""; return;
  }

  // Core totals
  let totalMins = t4 - t1;
  if (get("deductLunch").checked) totalMins -= 30;
  if (totalMins < 0) totalMins = 0;

  let total = minsToHr(totalMins);
  let std   = Math.min(10, total);
  let ot    = Math.max(0, +(total - 10).toFixed(2));

  // Travel
  const toMins = Math.max(0, t2 - t1);
  const fromMins = Math.max(0, t4 - t3);
  const travelTo = minsToHr(toMins);
  const travelFrom = minsToHr(fromMins);
  const travelTotal = minsToHr(toMins + fromMins);

  // Enhanced OT (preview)
  const d=$("date").value; 
  const isMonday = dayNum(d)===1;
  let enhanced = true, msg="Enhanced overtime if total > 10h.";

  if(isMonday){
    const v = document.querySelector(`input[name="${id}_vanCheck"]:checked`);
    if(v){
      if(v.value==="No"){ enhanced=false; msg="Van check = No → this Monday paid at standard rate only."; }
      if(v.value==="Yes" || v.value==="N/A"){ enhanced=true; msg="Van check completed → enhanced OT applies if >10h."; }
    }else{ msg="Select Monday van check status."; }
  }else{
    // ---- NEW WEEKLY VAN CHECK LOGIC ----
    const engineerName = get("engineer").value?.trim();
    if (engineerName && HOURS_LOG_CACHE && Object.keys(HOURS_LOG_CACHE).length) {
      // Find Monday of the current week
      const dObj = new Date(d + "T00:00:00");
      const monday = new Date(dObj);
      const dayIndex = dObj.getDay();
      monday.setDate(dObj.getDate() - (dayIndex - 1));
      const mondayStr = monday.toISOString().split("T")[0];

      // Try to locate engineer's Monday record
      const mondayEntries = HOURS_LOG_CACHE[mondayStr] || [];
      // HOURS_LOG_CACHE may store either array of names or array of objects with engineer + vanCheck
      let mondayStatus = null;

      if (Array.isArray(mondayEntries)) {
        // support both old [names] and new [{engineer, vanCheck}]
        const match = mondayEntries.find(e => 
          (typeof e === "string" && e.trim().toLowerCase() === engineerName.toLowerCase()) ||
          (e.engineer && e.engineer.trim().toLowerCase() === engineerName.toLowerCase())
        );
        if (match && typeof match === "object" && match.vanCheck) mondayStatus = match.vanCheck;
      }

      if (mondayStatus) {
        const check = String(mondayStatus).toLowerCase();
        if (check === "no" || check === "false") {
          enhanced = false;
          msg = "Van check failed on Monday – standard rate only for this week.";
        } else {
          enhanced = true;
          msg = "Monday van check passed – enhanced OT applies if >10h.";
        }
      } else {
        msg = "No Monday van check found – enhanced OT pending verification.";
      }
    } else {
      msg = "Overtime preview shown. Payroll will apply weekly van-check rule.";
    }
  }

  // Overrides
  const oneOff = get("btnOneOff").classList.contains("active");
  const forceEnh = get("btnForceEnh").classList.contains("active");
  const exclude = get("btnExclude").classList.contains("active");
  const manualOn = get("manualOverride").checked;
  const manualVal = parseFloat(get("manualOTHours").value);

  if (oneOff) { ot = total; std = 0; }
  else if (manualOn && !isNaN(manualVal)) { ot = Math.max(0, Math.min(total, +manualVal)); std = Math.max(0, +(total - ot).toFixed(2)); }

  if (forceEnh) enhanced = true;

  // Display
  get("t_total").textContent = total.toFixed(2);
  get("t_std").textContent   = std.toFixed(2);
  get("t_ot").textContent    = ot.toFixed(2);
  get("t_travel").textContent = travelTotal.toFixed(2);
  get("t_travel_parts").textContent = `(${travelTo.toFixed(2)}h to • ${travelFrom.toFixed(2)}h from)`;

  // Pill styles & note
  const otPill = get("otPill");
  if (exclude) {
    otPill.className = "pill warn"; get("enhPill").className = "pill warn";
    msg = "Day marked to be excluded from pay. Totals shown for reference only.";
  } else if (oneOff || manualOn) {
    otPill.className = "pill warn";
    msg = (oneOff ? "One-Off Overtime applied. " : "Manual overtime override in effect. ") + (isMonday ? "" : "Payroll will still apply weekly van-check rule.");
  } else {
    otPill.className = "pill";
  }
  get("t_enh").textContent = enhanced ? "Yes" : "No";
  get("enhPill").className = enhanced ? "pill ok" : "pill bad";
  get("logicNote").textContent = msg;
}
