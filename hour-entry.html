<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Engineer Hours Entry ‚Äì Mostlane</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<style>
  :root{
    --ml-blue:#003366;
    --ml-accent:#1a73e8;
    --ml-ink:#27313a;
    --ml-bg:#e6e8eb;
    --card:#ffffffee;
    --muted:#718096;
    --ok:#0c7d27;
    --bad:#b00020;
  }
  body{
    font-family:"Segoe UI",system-ui,Roboto,Arial,sans-serif;
    background:var(--ml-bg) url('Mostlane_Embossed.png') no-repeat center center fixed;
    background-size:180% auto;
    margin:0;padding:40px;color:var(--ml-ink);
  }
  .shell{max-width:1100px;margin:0 auto;background:rgba(255,255,255,0.92);
    border-radius:14px;box-shadow:0 12px 28px rgba(0,0,0,0.12);}
  header{display:flex;align-items:center;justify-content:space-between;
    background:linear-gradient(90deg,#fff,#f7f9fc);
    border-bottom:1px solid #e5e9f2;padding:18px 24px;}
  header img{height:42px;}
  header h1{font-size:22px;margin:0;color:var(--ml-blue);}
  header a{background:var(--ml-accent);color:#fff;text-decoration:none;
    padding:8px 16px;border-radius:8px;font-weight:600;font-size:14px;}
  .content{padding:22px 24px 28px;}
  .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:14px;}
  .card{background:var(--card);border:1px solid #e8edf3;border-radius:12px;padding:16px;}
  .title{font-weight:600;color:var(--ml-blue);margin-bottom:10px;}
  label{font-size:13px;color:#334155;display:block;margin-bottom:6px;}
  input,select,textarea{width:100%;font-size:15px;border:1px solid #cbd5e1;
    border-radius:10px;padding:10px 12px;background:#fff;}
  textarea{min-height:90px;resize:vertical;}
  .row{display:flex;align-items:center;gap:14px;flex-wrap:wrap;}
  .muted{color:var(--muted);font-size:12px;}
  .divider{height:1px;background:#edf2f7;margin:12px 0;}
  .toggle-row{display:flex;align-items:center;gap:10px;font-size:14px;}
  .radio-group{display:flex;gap:16px;align-items:center;flex-wrap:wrap;}
  .totals{display:flex;gap:10px;flex-wrap:wrap;font-weight:600;}
  .pill{padding:8px 12px;border-radius:999px;border:1px solid #d7e1ee;
    background:#f8fbff;color:#0f172a;}
  .pill.ok{border-color:#bfe7ca;background:#effaf3;color:#074e1a;}
  .pill.bad{border-color:#ffc7ce;background:#fff1f3;color:#6b0011;}
  .actions{display:flex;gap:14px;align-items:center;justify-content:flex-end;margin-top:10px;}
  button{font-size:15px;font-weight:600;border:0;border-radius:10px;padding:12px 18px;cursor:pointer;}
  .btn-primary{background:var(--ml-accent);color:#fff;}
  .btn-secondary{background:#eef2f9;color:#0f172a;border:1px solid #d7e1ee;}
  .btn-link{background:transparent;color:var(--ml-accent);padding:8px 10px;}
  .col-12{grid-column:span 12;}
  .col-6{grid-column:span 6;}
  @media(max-width:980px){.col-6{grid-column:span 12;}}
  .date-controls{display:flex;align-items:center;gap:8px;margin-top:8px;}
</style>
</head>
<body>
<div class="shell">
<header>
  <div class="row" style="gap:16px;">
    <img src="mostlane-logo.jpeg" alt="Mostlane Logo" />
    <h1>Engineer Hours Entry</h1>
  </div>
  <a href="main.html">Main Menu</a>
</header>

<div class="content">
<form id="hoursForm" class="grid" novalidate>

<!-- Day & Engineer -->
<div class="card col-12">
  <div class="title">Day & Engineer</div>
  <div class="row">
    <div style="min-width:260px;">
      <label>Date</label>
      <input type="date" id="date" required />
      <div class="date-controls">
        <button type="button" class="btn-link" id="prevDayBtn">‚óÄ Previous</button>
        <button type="button" class="btn-link" id="nextDayBtn">Next ‚ñ∂</button>
        <span class="muted" id="dowHint"></span>
      </div>
    </div>
    <div style="min-width:260px;flex:1;">
      <label>Engineer</label>
      <select id="engineer" required></select>
    </div>
    <div style="min-width:220px;">
      <label>Vehicle Used</label>
      <input type="text" id="vehicleUsed" list="vehicleList" placeholder="e.g. LA70 FPJ" />
      <datalist id="vehicleList"></datalist>
    </div>
  </div>
</div>

<!-- Times -->
<div class="card col-6">
  <div class="title">Times (24h)</div>
  <div class="grid" style="grid-template-columns:repeat(12,1fr);gap:10px;">
    <div style="grid-column:span 3;"><label>Leave Home</label><input type="time" id="leaveHome" required></div>
    <div style="grid-column:span 3;"><label>Arrive First</label><input type="time" id="arriveFirst" required></div>
    <div style="grid-column:span 3;"><label>Leave Last</label><input type="time" id="leaveLast" required></div>
    <div style="grid-column:span 3;"><label>Arrive Home</label><input type="time" id="arriveHome" required></div>
  </div>
  <div class="divider"></div>
  <label class="toggle-row"><input type="checkbox" id="deductLunch" checked> Deduct 30m lunch</label>
</div>

<!-- Vehicle / Notes -->
<div class="card col-6">
  <div class="title">Vehicle, Mileage & Notes</div>
  <div id="mondayBlock" style="display:none;margin-bottom:10px;">
    <label>Monday ‚Äì Van check?</label>
    <div class="radio-group">
      <label><input type="radio" name="vanCheck" value="Yes">Yes</label>
      <label><input type="radio" name="vanCheck" value="No">No</label>
      <label><input type="radio" name="vanCheck" value="N/A">N/A</label>
    </div>
    <div class="muted">If ‚ÄúNo‚Äù, all hours at standard rate.</div>
  </div>
  <div id="fridayBlock" style="display:none;margin-bottom:10px;">
    <label>Friday ‚Äì Van score (0‚Äì100)</label>
    <input type="number" id="vanScore" min="0" max="100">
  </div>
  <label>Personal mileage (weekly)</label>
  <input type="number" id="personalMileage" min="0" step="1">
  <div class="divider"></div>
  <div class="row" style="align-items:flex-start;">
    <div style="flex:1;">
      <label>Office notes</label>
      <textarea id="notes" placeholder="e.g. traffic delay, extra stop..."></textarea>
    </div>
    <div style="min-width:220px;">
      <label>Visibility</label>
      <label class="toggle-row"><input type="checkbox" id="noteVisible"> ü™® Visible to engineer</label>
      <div class="muted">Default off</div>
    </div>
  </div>
</div>

<!-- Totals -->
<div class="card col-12">
  <div class="title">Calculated Totals</div>
  <div class="totals">
    <span class="pill">Total: <span id="t_total">0.00</span> h</span>
    <span class="pill ok">Standard: <span id="t_std">0.00</span> h</span>
    <span class="pill">Overtime: <span id="t_ot">0.00</span> h</span>
    <span class="pill" id="enhPill">Enhanced OT: <span id="t_enh">Yes</span></span>
  </div>
  <div class="muted" id="logicNote" style="margin-top:6px;"></div>
</div>

<!-- Actions -->
<div class="col-12 actions">
  <span class="muted" id="statusMsg"></span>
  <button type="reset" class="btn-secondary">Clear</button>
  <button type="submit" class="btn-primary">Submit to Payroll</button>
</div>

</form>
</div>
</div>

<script>
const ZAPIER_WEBHOOK="https://hooks.zapier.com/hooks/catch/20261714/u5ibaoi/";
const USERS_JSON_PATH="./users.json";
let USERS_RAW=[],ENGINEERS=[],VEHICLE_SET=new Set();
const $=id=>document.getElementById(id);
function timeToMin(t){if(!t)return null;const[h,m]=t.split(":").map(Number);return h*60+m;}
function minsToHr(m){return Math.round((m/60)*100)/100;}
function fmtDate(d){return d.toISOString().split("T")[0];}
function shiftDate(delta){const d=new Date($("date").value+"T12:00");d.setDate(d.getDate()+delta);$("date").value=fmtDate(d);updateDay();}
function dow(d){return new Date(d+"T12:00").toLocaleDateString(undefined,{weekday:"long"});}
function dayNum(d){return new Date(d+"T12:00").getDay();}

async function init(){
 try{
   const r=await fetch(USERS_JSON_PATH,{cache:"no-store"});
   const j=await r.json();USERS_RAW=j.Users||j;
 }catch{USERS_RAW=[];}
 ENGINEERS=USERS_RAW.filter(u=>u.Status==="Active").map(u=>({name:`${u.FirstName} ${u.LastName}`,username:u.Username,vehicle:u.VehicleAssigned||""}));
 const sel=$("engineer");
 ENGINEERS.forEach(e=>{
   const o=document.createElement("option");
   o.value=e.name;o.textContent=e.name;
   o.dataset.username=e.username;o.dataset.vehicle=e.vehicle;
   sel.appendChild(o);
 });
 USERS_RAW.forEach(u=>{if(u.VehicleAssigned)VEHICLE_SET.add(u.VehicleAssigned);});
 const dl=$("vehicleList");VEHICLE_SET.forEach(v=>{const o=document.createElement("option");o.value=v;dl.appendChild(o);});
 $("engineer").onchange=()=>{const s=$("engineer");const v=s.options[s.selectedIndex].dataset.vehicle;$("vehicleUsed").value=v||"";};
 $("prevDayBtn").onclick=()=>shiftDate(-1);$("nextDayBtn").onclick=()=>shiftDate(1);
 ["leaveHome","arriveFirst","leaveLast","arriveHome","deductLunch"].forEach(i=>$(i).addEventListener("input",calcTotals));
 document.querySelectorAll('input[name="vanCheck"]').forEach(r=>r.addEventListener("change",calcTotals));
 $("hoursForm").onsubmit=submitForm;
 const y=new Date();y.setDate(y.getDate()-1);$("date").value=fmtDate(y);
 updateDay();calcTotals();
}

function updateDay(){
 const d=$("date").value;if(!d)return;
 $("dowHint").textContent="Selected: "+dow(d);
 $("mondayBlock").style.display=dayNum(d)===1?"block":"none";
 $("fridayBlock").style.display=dayNum(d)===5?"block":"none";
 calcTotals();
}

function calcTotals(){
 const t1=timeToMin($("leaveHome").value),t2=timeToMin($("arriveFirst").value),
       t3=timeToMin($("leaveLast").value),t4=timeToMin($("arriveHome").value);
 if([t1,t2,t3,t4].some(v=>v==null))return;
 let total=t4-t1;if($("deductLunch").checked)total-=30;if(total<0)return;
 let h=minsToHr(total),std=Math.min(10,h),ot=Math.max(0,h-10);
 const d=$("date").value,isMon=dayNum(d)===1;
 let enh=true,msg="Enhanced overtime if >10h.";
 if(isMon){const v=document.querySelector('input[name="vanCheck"]:checked');
   if(v){if(v.value==="No"){enh=false;msg="Van check No ‚Üí all hours standard rate.";}else msg=`Van check ${v.value}`;}}
 $("t_total").textContent=h.toFixed(2);$("t_std").textContent=std.toFixed(2);
 $("t_ot").textContent=ot.toFixed(2);$("t_enh").textContent=enh?"Yes":"No";
 $("enhPill").className=enh?"pill ok":"pill bad";$("logicNote").textContent=msg;
}

async function submitForm(e){
 e.preventDefault();
 $("statusMsg").textContent="Submitting‚Ä¶";
 const data=gather();
 const body=new URLSearchParams();Object.entries(data).forEach(([k,v])=>body.append(k,v??""));
 try{
   const r=await fetch(ZAPIER_WEBHOOK,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body});
   $("statusMsg").textContent=r.ok?"‚úÖ Submitted":"‚ùå Error";
 }catch{$("statusMsg").textContent="‚ùå Network error";}
}

function gather(){
 const d=$("date").value,eng=$("engineer").value,veh=$("vehicleUsed").value;
 const l1=$("leaveHome").value,a1=$("arriveFirst").value,l2=$("leaveLast").value,a2=$("arriveHome").value;
 const n=$("notes").value,nv=$("noteVisible").checked,vs=$("vanScore").value,pm=$("personalMileage").value;
 let vc=null;if(dayNum(d)===1){const v=document.querySelector('input[name="vanCheck"]:checked');vc=v?v.value:null;}
 return{date:d,day:dow(d),engineer:eng,vehicle:veh,leaveHome:l1,arriveFirst:a1,leaveLast:l2,arriveHome:a2,
   total:$("t_total").textContent,std:$("t_std").textContent,ot:$("t_ot").textContent,
   enhanced:$("t_enh").textContent,vanCheck:vc,vanScore:vs,personalMileage:pm,
   notes:n,noteVisible:nv,submittedAt:new Date().toISOString()};
}

window.onload=init;
</script>
</body>
</html>
