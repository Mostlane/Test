<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1.0"
  />
  <title>Timesheet – Hours Entry (v3)</title>

  <!-- Cache-busting asset loader (uses TODAY-YYYYMMDD-HHMMSS as version) -->
  <script>
    (function() {
      const pad = n => (n < 10 ? "0" + n : "" + n);
      const d = new Date();
      const VERSION =
        d.getFullYear().toString() +
        pad(d.getMonth() + 1) +
        pad(d.getDate()) +
        "-" +
        pad(d.getHours()) +
        pad(d.getMinutes()) +
        pad(d.getSeconds());

      // Inject CSS with ?v=
      const cssHref = "styles/timesheet.css?v=" + VERSION;
      const link = document.createElement("link");
      link.rel = "stylesheet";
      link.href = cssHref;
      document.head.appendChild(link);

      // Expose a helper for later JS loads
      window.__cacheBust = function(path) {
        return path + (path.includes("?") ? "&" : "?") + "v=" + VERSION;
      };
    })();
  </script>

  <style>
    /* Minimal inline safety styles; your full theme should be in styles/timesheet.css (cache-busted above). */
    :root {
      --ml-primary: #003366;
      --ml-bg: #e6e8eb;
      --ml-card: rgba(255, 255, 255, 0.9);
      --ml-accent: #0a66c2;
      --ml-ok: #1f9d55;
      --ml-warn: #b7791f;
      --ml-danger: #c53030;
    }
    * { box-sizing: border-box; }
    body {
      font-family: "Segoe UI", Arial, sans-serif;
      background: var(--ml-bg) url("Mostlane_Embossed.png") no-repeat center center fixed;
      background-size: cover;
      margin: 0;
      color: var(--ml-primary);
    }
    .container {
      max-width: 980px;
      margin: 60px auto 100px;
      background: var(--ml-card);
      padding: 28px 28px 34px;
      border-radius: 16px;
      box-shadow: 0 6px 18px rgba(0,0,0,0.12);
      backdrop-filter: blur(2px);
    }
    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
      margin-bottom: 18px;
    }
    .title {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .title img {
      height: 38px;
      width: auto;
      border-radius: 6px;
    }
    h1 {
      font-size: 1.35rem;
      margin: 0;
      letter-spacing: 0.2px;
    }
    .actions {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }
    button, .btn {
      appearance: none;
      border: none;
      background: var(--ml-accent);
      color: #fff;
      padding: 10px 14px;
      border-radius: 10px;
      font-weight: 600;
      cursor: pointer;
      box-shadow: 0 2px 8px rgba(10,102,194,0.25);
      transition: transform .05s ease, box-shadow .2s ease;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }
    button:hover, .btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 6px 14px rgba(10,102,194,0.25);
    }
    .btn-secondary {
      background: #fff;
      color: var(--ml-primary);
      border: 1px solid #cfd6df;
      box-shadow: 0 2px 6px rgba(0,0,0,0.06);
    }
    .toolbar {
      display: grid;
      grid-template-columns: 1fr auto auto;
      gap: 12px;
      margin: 6px 0 18px;
      align-items: center;
    }
    .field {
      display: grid;
      gap: 6px;
    }
    .field label {
      font-size: 0.9rem;
      font-weight: 600;
    }
    input[type="week"], input[type="text"], input[type="time"], input[type="number"] {
      border: 1px solid #cfd6df;
      border-radius: 10px;
      padding: 10px 12px;
      background: #fff;
      color: #1d2a3a;
      outline: none;
    }
    .table-wrap {
      overflow-x: auto;
      border: 1px solid #d9e0ea;
      border-radius: 12px;
      background: #fff;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      min-width: 820px;
    }
    thead th {
      background: #f3f6fb;
      position: sticky;
      top: 0;
      z-index: 1;
    }
    th, td {
      text-align: left;
      padding: 12px 10px;
      border-bottom: 1px solid #eef2f7;
      font-size: 0.95rem;
    }
    tfoot td {
      font-weight: 700;
      background: #f9fbff;
    }
    .totals {
      display: grid;
      grid-template-columns: repeat(4, minmax(0,1fr));
      gap: 12px;
      margin: 16px 0 8px;
    }
    .chip {
      background: #fff;
      border: 1px solid #d9e0ea;
      border-radius: 12px;
      padding: 10px 12px;
      font-weight: 600;
    }
    .status {
      margin-top: 10px;
      font-size: 0.9rem;
    }
    .muted { opacity: 0.8; font-weight: 500; }
    .fine { color: var(--ml-ok); }
    .warn { color: var(--ml-warn); }
    .danger { color: var(--ml-danger); }
    .note {
      font-size: 0.86rem;
      margin-top: 8px;
      opacity: 0.9;
    }
    .footer {
      margin-top: 28px;
      font-size: 0.85rem;
      text-align: center;
      opacity: 0.75;
    }
    .right { text-align: right; }
    .center { text-align: center; }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div class="title">
        <img src="Mostlane Logo - Copy.jpeg" alt="Mostlane" />
        <h1>Timesheet – Hours Entry (v3)</h1>
      </div>
      <div class="actions">
        <a class="btn-secondary" href="main.html">Main Menu</a>
        <button id="createTimesheetBtn" title="Sends summary to Zapier for PDF (per your existing Zap)">
          Create Timesheet
        </button>
      </div>
    </header>

    <div class="toolbar">
      <div class="field">
        <label for="weekPicker">Week (Mon–Sun)</label>
        <input id="weekPicker" type="week" />
      </div>
      <div class="field">
        <label for="employeeName">Employee</label>
        <input id="employeeName" type="text" placeholder="Auto from login (e.g., Jamie Line)" />
      </div>
      <div class="field">
        <label for="deviceId">Device ID</label>
        <input id="deviceId" type="text" placeholder="dev-xxxxxxx (from onboarding)" />
      </div>
    </div>

    <div class="table-wrap">
      <table id="hoursTable" aria-label="Timesheet Hours">
        <thead>
          <tr>
            <th style="width:140px;">Day</th>
            <th>Start Time</th>
            <th>End Time</th>
            <th>Unpaid Break (mins)</th>
            <th>Notes</th>
            <th class="right">Hours</th>
          </tr>
        </thead>
        <tbody id="hoursBody">
          <!-- Rows injected by JS for Mon–Sun -->
        </tbody>
        <tfoot>
          <tr>
            <td colspan="5" class="right">Total (hh:mm)</td>
            <td class="right" id="totalHoursCell">00:00</td>
          </tr>
        </tfoot>
      </table>
    </div>

    <div class="totals">
      <div class="chip">Days Counted: <span id="daysCount">0</span></div>
      <div class="chip">Total Hours: <span id="totalHoursChip">00:00</span></div>
      <div class="chip">Std Hours (<=10h/day): <span id="stdHours">00:00</span></div>
      <div class="chip">Overtime (>10h/day): <span id="otHours">00:00</span></div>
    </div>

    <div class="status muted" id="saveStatus">Autosaved.</div>
    <div class="note">
      Note: Page autosaves locally. “Create Timesheet” compiles this week’s data and sends it to your existing Zapier flow for PDF generation (as per your <em>Create Timesheet</em> Zap).
    </div>

    <div class="footer">
      © Mostlane — Styled with embossed background. Cache-busting enabled for CSS/JS.
    </div>
  </div>

  <!-- Core logic (cache-busted load) -->
  <script>
    (function attachScript() {
      const s = document.createElement("script");
      s.type = "module";
      s.src = window.__cacheBust ? window.__cacheBust("scripts/timesheet-core.js") : "scripts/timesheet-core.js";
      document.body.appendChild(s);
    })();
  </script>

  <!-- Inline fallback core (in case external JS not found). Remove if you provide scripts/timesheet-core.js -->
  <script type="module">
    // ======== CONFIG ========
    const ZAP_TIMESHEET_URL = "https://hooks.zapier.com/hooks/catch/20261714/273lt6z/"; // Your confirmed Zap for Create Timesheet
    const STORAGE_KEY = "mostlane.hoursEntry.v3";

    // ======== UTIL ========
    const qs = sel => document.querySelector(sel);
    const qsa = sel => Array.from(document.querySelectorAll(sel));
    const toMinutes = (hhmm) => {
      if (!hhmm || !/^\d{2}:\d{2}$/.test(hhmm)) return 0;
      const [h, m] = hhmm.split(":").map(Number);
      return h * 60 + m;
    };
    const minutesToHHMM = (mins) => {
      const sign = mins < 0 ? "-" : "";
      mins = Math.abs(mins);
      const h = Math.floor(mins / 60);
      const m = mins % 60;
      return `${sign}${String(h).padStart(2,"0")}:${String(m).padStart(2,"0")}`;
    };
    const dayNames = ["Monday","Tuesday","Wednesday","Thursday","Friday","Saturday","Sunday"];

    // ======== DOM BUILD ========
    const tbody = qs("#hoursBody");
    function buildRows() {
      tbody.innerHTML = "";
      dayNames.forEach((name, i) => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td><strong>${name}</strong></td>
          <td><input type="time" class="start" aria-label="${name} start time"></td>
          <td><input type="time" class="end" aria-label="${name} end time"></td>
          <td><input type="number" class="break" min="0" step="5" placeholder="0" aria-label="${name} unpaid break minutes" style="max-width:120px"></td>
          <td><input type="text" class="note" placeholder="Notes (optional)"></td>
          <td class="right"><span class="dayTotal">00:00</span></td>
        `;
        tbody.appendChild(tr);
      });
    }
    buildRows();

    // ======== AUTOFILL WEEK + EMPLOYEE ========
    const weekPicker = qs("#weekPicker");
    const employeeName = qs("#employeeName");
    const deviceId = qs("#deviceId");

    // Try default week = current week (ISO)
    if (!weekPicker.value) {
      const now = new Date();
      const firstThursday = new Date(now.getFullYear(), 0, 4);
      const dayOfYear = (date) => Math.floor((date - new Date(date.getFullYear(),0,1)) / 86400000) + 1;
      const week = (date) => {
        const d = new Date(date);
        d.setHours(0,0,0,0);
        d.setDate(d.getDate() + 3 - ((d.getDay() + 6) % 7));
        const week1 = new Date(d.getFullYear(),0,4);
        return 1 + Math.round(((d - week1) / 86400000 - 3 + ((week1.getDay() + 6)%7)) / 7);
      };
      const w = week(now);
      weekPicker.value = `${now.getFullYear()}-W${String(w).padStart(2,"0")}`;
    }

    // Pull login name & device from session/local if present (per your portal pattern)
    try {
      const login = sessionStorage.getItem("mostlaneUsername");
      if (login && !employeeName.value) employeeName.value = login.replace(".", " ");
    } catch {}
    try {
      const dev = localStorage.getItem("mostlaneDeviceId");
      if (dev && !deviceId.value) deviceId.value = dev;
    } catch {}

    // ======== CALC & SAVE ========
    const status = qs("#saveStatus");
    const totalHoursCell = qs("#totalHoursCell");
    const totalHoursChip = qs("#totalHoursChip");
    const daysCountEl = qs("#daysCount");
    const stdHoursEl = qs("#stdHours");
    const otHoursEl = qs("#otHours");

    function calc() {
      let totalMins = 0;
      let dayCount = 0;
      let stdMins = 0;
      let otMins = 0;

      qsa("#hoursBody tr").forEach((tr) => {
        const start = tr.querySelector(".start").value;
        const end = tr.querySelector(".end").value;
        const brk = parseInt(tr.querySelector(".break").value || "0", 10);
        const out = tr.querySelector(".dayTotal");

        let mins = 0;
        if (start && end) {
          let s = toMinutes(start);
          let e = toMinutes(end);
          if (e < s) e += 24*60; // cross midnight support
          mins = Math.max(0, e - s - (isNaN(brk) ? 0 : brk));
          if (mins > 0) {
            dayCount++;
            // Split std vs overtime using your 10h/day rule (as referenced in prior chats)
            const tenH = 10 * 60;
            stdMins += Math.min(tenH, mins);
            otMins  += Math.max(0, mins - tenH);
          }
        }
        out.textContent = minutesToHHMM(mins);
        totalMins += mins;
      });

      totalHoursCell.textContent = minutesToHHMM(totalMins);
      totalHoursChip.textContent = minutesToHHMM(totalMins);
      daysCountEl.textContent = String(dayCount);
      stdHoursEl.textContent = minutesToHHMM(stdMins);
      otHoursEl.textContent = minutesToHHMM(otMins);
    }

    function save() {
      const rows = qsa("#hoursBody tr").map((tr, idx) => ({
        day: dayNames[idx],
        start: tr.querySelector(".start").value || "",
        end: tr.querySelector(".end").value || "",
        breakMins: tr.querySelector(".break").value || "",
        note: tr.querySelector(".note").value || "",
      }));
      const payload = {
        week: weekPicker.value || "",
        employee: employeeName.value || "",
        deviceId: deviceId.value || "",
        rows,
        metaVersion: "hours-entry-v3",
        savedAt: new Date().toISOString(),
      };
      localStorage.setItem(STORAGE_KEY, JSON.stringify(payload));
      status.textContent = "Autosaved.";
      status.className = "status muted";
    }

    function load() {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (!raw) return;
      try {
        const data = JSON.parse(raw);
        if (data.week) weekPicker.value = data.week;
        if (data.employee) employeeName.value = data.employee;
        if (data.deviceId) deviceId.value = data.deviceId;
        if (Array.isArray(data.rows)) {
          const trs = qsa("#hoursBody tr");
          data.rows.forEach((row, i) => {
            const tr = trs[i];
            if (!tr) return;
            tr.querySelector(".start").value = row.start || "";
            tr.querySelector(".end").value = row.end || "";
            tr.querySelector(".break").value = row.breakMins || "";
            tr.querySelector(".note").value = row.note || "";
          });
        }
      } catch {}
    }

    function bind() {
      document.addEventListener("input", (e) => {
        if (e.target.matches(".start, .end, .break, #weekPicker, #employeeName, #deviceId, .note")) {
          calc();
          save();
        }
      });
      document.addEventListener("change", (e) => {
        if (e.target.matches("input")) {
          calc();
          save();
        }
      });
    }

    // ======== SUBMIT TO ZAPIER ("Create Timesheet") ========
    async function submitToZapier() {
      const raw = localStorage.getItem(STORAGE_KEY);
      let payload;
      try {
        payload = JSON.parse(raw || "{}");
      } catch {
        payload = {};
      }

      // Basic validation
      if (!payload.employee || !payload.week) {
        status.textContent = "Please set Employee and Week before creating timesheet.";
        status.className = "status danger";
        return;
      }

      // Compose a lean summary (Zap builds PDF)
      const summary = {
        employee: payload.employee,
        week: payload.week,
        deviceId: payload.deviceId || "",
        totals: {
          daysCount: Number(qs("#daysCount").textContent || 0),
          totalHours: qs("#totalHoursChip").textContent || "00:00",
          stdHours: qs("#stdHours").textContent || "00:00",
          otHours: qs("#otHours").textContent || "00:00",
        },
        rows: qsa("#hoursBody tr").map((tr, idx) => ({
          day: dayNames[idx],
          start: tr.querySelector(".start").value || "",
          end: tr.querySelector(".end").value || "",
          breakMins: tr.querySelector(".break").value || "0",
          note: tr.querySelector(".note").value || "",
          total: tr.querySelector(".dayTotal").textContent || "00:00",
        })),
        submittedAt: new Date().toISOString(),
        source: "hours-entry-v3.html",
      };

      try {
        status.textContent = "Submitting…";
        status.className = "status muted";

        const form = new URLSearchParams();
        form.append("employee", summary.employee);
        form.append("week", summary.week);
        form.append("deviceId", summary.deviceId);
        form.append("totals", JSON.stringify(summary.totals));
        form.append("rows", JSON.stringify(summary.rows));
        form.append("submittedAt", summary.submittedAt);
        form.append("source", summary.source);

        const res = await fetch(ZAP_TIMESHEET_URL, {
          method: "POST",
          headers: {"Content-Type": "application/x-www-form-urlencoded"},
          body: form.toString(),
        });

        if (!res.ok) throw new Error("Non-200 from Zapier");
        status.textContent = "Timesheet sent to Zapier successfully.";
        status.className = "status fine";
      } catch (err) {
        status.textContent = "Failed to submit. Please try again.";
        status.className = "status danger";
        console.error(err);
      }
    }

    // ======== INIT ========
    load();
    calc();
    bind();
    qs("#createTimesheetBtn").addEventListener("click", submitToZapier);
  </script>
</body>
</html>
