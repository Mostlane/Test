<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1.0"
  />
  <title>Hours Entry – Day by Day (v3)</title>

  <!-- Cache-busting version helper -->
  <script>
    (function () {
      const pad = n => (n < 10 ? "0" + n : "" + n);
      const d = new Date();
      const VERSION =
        d.getFullYear().toString() +
        pad(d.getMonth() + 1) +
        pad(d.getDate()) +
        "-" +
        pad(d.getHours()) +
        pad(d.getMinutes()) +
        pad(d.getSeconds());

      window.__cacheBust = function (path) {
        return path + (path.includes("?") ? "&" : "?") + "v=" + VERSION;
      };
      // If you create an external CSS, uncomment:
      // const link = document.createElement("link");
      // link.rel = "stylesheet";
      // link.href = __cacheBust("styles/hours-entry-daily.css");
      // document.head.appendChild(link);
    })();
  </script>

  <style>
    :root {
      --ml-primary: #003366;
      --ml-bg: #e6e8eb;
      --ml-card: rgba(255,255,255,0.92);
      --ml-accent: #0a66c2;
      --ml-border: #d9e0ea;
      --ml-soft: #f3f6fb;
      --ml-ok: #1f9d55;
      --ml-warn: #b7791f;
      --ml-bad: #c53030;
    }
    * { box-sizing: border-box; }
    body {
      font-family: "Segoe UI", Arial, sans-serif;
      background: var(--ml-bg) url("Mostlane_Embossed.png") no-repeat center center fixed;
      background-size: cover;
      margin: 0;
      color: var(--ml-primary);
    }
    .container {
      max-width: 1100px;
      margin: 60px auto 100px;
      background: var(--ml-card);
      padding: 28px;
      border-radius: 16px;
      box-shadow: 0 6px 18px rgba(0,0,0,0.12);
      backdrop-filter: blur(2px);
    }
    header {
      display: flex; align-items: center; justify-content: space-between; gap: 16px; margin-bottom: 12px;
    }
    .title { display: flex; align-items: center; gap: 12px; }
    .title img { height: 36px; border-radius: 6px; }
    h1 { font-size: 1.28rem; margin: 0; letter-spacing: 0.2px; }
    .actions { display: flex; gap: 10px; flex-wrap: wrap; }
    a.btn, button.btn {
      appearance: none; border: none; background: var(--ml-accent); color: #fff;
      padding: 10px 14px; border-radius: 10px; font-weight: 600; cursor: pointer;
      text-decoration: none; display: inline-flex; align-items: center; gap: 8px;
      box-shadow: 0 2px 8px rgba(10,102,194,0.25);
    }
    .btn.secondary { background: #fff; color: var(--ml-primary); border: 1px solid var(--ml-border); }
    .toolbar {
      display: grid; grid-template-columns: 1fr auto auto; gap: 12px; align-items: end;
      margin: 10px 0 18px;
    }
    .field { display: grid; gap: 6px; }
    label { font-size: 0.92rem; font-weight: 650; }
    input[type="date"], select, input[type="time"], textarea {
      border: 1px solid var(--ml-border); border-radius: 10px; padding: 10px 12px; background: #fff; color: #1d2a3a;
    }
    textarea { min-height: 44px; resize: vertical; }
    .note-check { display: inline-flex; align-items: center; gap: 8px; font-size: 0.92rem; }
    .card {
      border: 1px solid var(--ml-border); border-radius: 12px; background: #fff;
      padding: 14px; margin-bottom: 14px;
    }
    .row-grid {
      display: grid;
      grid-template-columns: 220px 160px repeat(4, 140px) 120px 1fr 160px;
      gap: 10px; align-items: center;
    }
    .row-grid .remove {
      justify-self: end;
      background: #fff; color: var(--ml-bad); border: 1px solid #f0c7c7;
    }
    .subtle {
      font-size: 0.85rem; color: #335; opacity: 0.85; margin: 2px 0 10px;
    }
    .status { margin-top: 8px; font-size: 0.9rem; }
    .ok { color: var(--ml-ok); }
    .warn { color: var(--ml-warn); }
    .bad { color: var(--ml-bad); }
    .footer { margin-top: 24px; text-align: center; font-size: 0.86rem; opacity: 0.8; }
    .table-legend {
      display: grid; grid-template-columns: 220px 160px repeat(4, 140px) 120px 1fr 160px; gap: 10px;
      font-size: 0.85rem; padding: 8px 12px; background: var(--ml-soft); border-radius: 10px; border: 1px solid var(--ml-border);
      font-weight: 650; margin-bottom: 8px;
    }
    .total-cell { font-weight: 700; text-align: center; }
    @media (max-width: 1100px) {
      .row-grid, .table-legend { grid-template-columns: 1fr; }
      .row-grid > * { width: 100%; }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div class="title">
        <img src="Mostlane Logo - Copy.jpeg" alt="Mostlane" />
        <h1>Hours Entry – Day by Day (v3)</h1>
      </div>
      <div class="actions">
        <a class="btn secondary" href="main.html">Main Menu</a>
        <button class="btn" id="submitAll">Submit Day’s Entries</button>
      </div>
    </header>

    <div class="toolbar">
      <div class="field">
        <label for="dayDate">Date</label>
        <input id="dayDate" type="date" />
      </div>
      <div class="field">
        <label>&nbsp;</label>
        <button class="btn" id="addEngineer">+ Add another engineer</button>
      </div>
      <div class="field">
        <label>&nbsp;</label>
        <button class="btn secondary" id="clearAll">Clear All</button>
      </div>
    </div>

    <div class="subtle">Tip: Select the date, add engineers, fill times (Leave Home → Arrive First Site → Leave Last Site → Arrive Home). Totals calculate automatically. Notes are internal by default; tick “visible” if engineers should see them.</div>

    <div class="table-legend">
      <div>Engineer</div>
      <div>Van</div>
      <div>Leave Home</div>
      <div>Arrive First Site</div>
      <div>Leave Last Site</div>
      <div>Arrive Home</div>
      <div class="total-cell">Total</div>
      <div>Notes</div>
      <div>Visibility / Actions</div>
    </div>

    <div id="rows"></div>

    <div class="status" id="saveStatus">Autosave ready.</div>
    <div class="footer">© Mostlane — Embossed theme • Cache-busting enabled</div>
  </div>

  <template id="rowTemplate">
    <div class="card engineer-row">
      <div class="row-grid">
        <select class="engineer"></select>
        <select class="van"></select>

        <input type="time" class="leaveHome" />
        <input type="time" class="arriveFirst" />
        <input type="time" class="leaveLast" />
        <input type="time" class="arriveHome" />

        <div class="total total-cell">00:00</div>

        <textarea class="notes" placeholder="Notes (internal by default)"></textarea>

        <div class="controls">
          <label class="note-check">
            <input type="checkbox" class="notesVisible" />
            Make notes visible to engineers
          </label>
          <div style="height:8px"></div>
          <button class="btn remove">Remove</button>
        </div>
      </div>
    </div>
  </template>

  <script>
    // ======== CONFIG ========
    const USERS_JSON_URL = "users.json"; // <-- adjust if needed (e.g. "data/users.json")
    const ZAP_URL = "https://hooks.zapier.com/hooks/catch/20261714/u5ibaoi/";
    const STORAGE_KEY = "mostlane.hoursEntry.daily.v3";

    // ======== STATE ========
    let users = [];
    let engineerOptions = []; // [{label, value, van}]
    let vanOptions = []; // unique vans from users.json, non-empty

    // ======== HELPERS ========
    const qs = (sel, el) => (el || document).querySelector(sel);
    const qsa = (sel, el) => Array.from((el || document).querySelectorAll(sel));

    function timeToMinutes(t) {
      if (!t || !/^\d{2}:\d{2}$/.test(t)) return null;
      const [hh, mm] = t.split(":").map(Number);
      return hh * 60 + mm;
    }
    function minutesToHHMM(mins) {
      mins = Math.max(0, Math.floor(mins || 0));
      const h = Math.floor(mins / 60);
      const m = mins % 60;
      return String(h).padStart(2, "0") + ":" + String(m).padStart(2, "0");
    }
    function spanMinutes(t1, t2) {
      // Supports cross-midnight: if t2 < t1, assume next day
      const m1 = timeToMinutes(t1);
      const m2 = timeToMinutes(t2);
      if (m1 == null || m2 == null) return 0;
      return m2 >= m1 ? (m2 - m1) : (m2 + 24*60 - m1);
    }
    function calcTotalRow(rowEl) {
      const leaveHome = qs(".leaveHome", rowEl).value;
      const arriveFirst = qs(".arriveFirst", rowEl).value;
      const leaveLast = qs(".leaveLast", rowEl).value;
      const arriveHome = qs(".arriveHome", rowEl).value;

      // Total day span: Leave Home -> Arrive Home
      const total = spanMinutes(leaveHome, arriveHome);
      qs(".total", rowEl).textContent = minutesToHHMM(total);
    }
    function setStatus(text, cls = "") {
      const el = qs("#saveStatus");
      el.textContent = text;
      el.className = "status " + cls;
    }

    // ======== USERS.json LOAD ========
    async function loadUsers() {
      const res = await fetch(USERS_JSON_URL, { cache: "no-store" });
      if (!res.ok) throw new Error("Failed to load users.json");
      const data = await res.json();
      users = Array.isArray(data.Users) ? data.Users : [];

      engineerOptions = users
        .filter(u => (u.Status || "").toLowerCase() === "active")
        .map(u => ({
          label: (u.FirstName + " " + u.LastName).trim(),
          value: u.Username,
          van: (u.VehicleAssigned || "").trim(),
        }))
        .sort((a, b) => a.label.localeCompare(b.label));

      const vans = new Set(
        users
          .map(u => (u.VehicleAssigned || "").trim())
          .filter(Boolean)
      );
      // Add a blank/none option
      vanOptions = ["", ...Array.from(vans).sort()];
    }

    function buildEngineerSelect(selectEl, selectedValue = "") {
      selectEl.innerHTML = "";
      const opt0 = document.createElement("option");
      opt0.value = "";
      opt0.textContent = "Select engineer…";
      selectEl.appendChild(opt0);

      engineerOptions.forEach(o => {
        const opt = document.createElement("option");
        opt.value = o.value;
        opt.textContent = o.label;
        if (o.value === selectedValue) opt.selected = true;
        selectEl.appendChild(opt);
      });
    }

    function buildVanSelect(selectEl, selectedVan = "") {
      selectEl.innerHTML = "";
      vanOptions.forEach(v => {
        const opt = document.createElement("option");
        opt.value = v;
        opt.textContent = v || "—";
        if (v === selectedVan) opt.selected = true;
        selectEl.appendChild(opt);
      });
    }

    function addRow(prefill = {}) {
      const tpl = qs("#rowTemplate");
      const node = tpl.content.cloneNode(true);
      const row = node.querySelector(".engineer-row");

      const engineerSel = qs(".engineer", row);
      const vanSel = qs(".van", row);

      buildEngineerSelect(engineerSel, prefill.username || "");
      // If prefilled username has a known van, use that; else prefill provided van
      let autoVan = "";
      if (prefill.username) {
        const found = engineerOptions.find(e => e.value === prefill.username);
        autoVan = found?.van || "";
      }
      buildVanSelect(vanSel, autoVan || prefill.van || "");

      // Times
      qs(".leaveHome", row).value = prefill.leaveHome || "";
      qs(".arriveFirst", row).value = prefill.arriveFirst || "";
      qs(".leaveLast", row).value = prefill.leaveLast || "";
      qs(".arriveHome", row).value = prefill.arriveHome || "";
      qs(".notes", row).value = prefill.notes || "";
      qs(".notesVisible", row).checked = !!prefill.notesVisible;

      // Events
      engineerSel.addEventListener("change", () => {
        const selUser = engineerOptions.find(e => e.value === engineerSel.value);
        if (selUser) {
          // Auto-fill van to the engineer's assigned one IF current van is blank
          if (!vanSel.value) {
            buildVanSelect(vanSel, selUser.van || "");
          }
        }
        saveAll();
      });

      qsa("input[type='time']", row).forEach(inp => {
        inp.addEventListener("input", () => {
          calcTotalRow(row);
          saveAll();
        });
      });
      vanSel.addEventListener("change", saveAll);
      qs(".notes", row).addEventListener("input", saveAll);
      qs(".notesVisible", row).addEventListener("change", saveAll);

      qs(".remove", row).addEventListener("click", () => {
        row.remove();
        saveAll();
      });

      calcTotalRow(row);
      qs("#rows").appendChild(row);
    }

    function collect() {
      const date = qs("#dayDate").value;
      const rows = qsa(".engineer-row").map(row => {
        const username = qs(".engineer", row).value;
        const engineerLabel = qs(".engineer", row).selectedOptions[0]?.textContent || "";
        return {
          date,
          username,
          engineer: engineerLabel,
          van: qs(".van", row).value || "",
          leaveHome: qs(".leaveHome", row).value || "",
          arriveFirst: qs(".arriveFirst", row).value || "",
          leaveLast: qs(".leaveLast", row).value || "",
          arriveHome: qs(".arriveHome", row).value || "",
          total: qs(".total", row).textContent || "00:00",
          notes: qs(".notes", row).value || "",
          notesVisible: qs(".notesVisible", row).checked ? "Yes" : "No",
        };
      });
      return { date, rows };
    }

    function saveAll() {
      const payload = collect();
      localStorage.setItem(STORAGE_KEY, JSON.stringify(payload));
      setStatus("Autosaved.", "ok");
    }

    function loadAll() {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (!raw) return;
      try {
        const data = JSON.parse(raw);
        if (data.date) qs("#dayDate").value = data.date;
        const rows = Array.isArray(data.rows) ? data.rows : [];
        if (!rows.length) return;
        rows.forEach(r => addRow({
          username: r.username || "",
          van: r.van || "",
          leaveHome: r.leaveHome || "",
          arriveFirst: r.arriveFirst || "",
          leaveLast: r.leaveLast || "",
          arriveHome: r.arriveHome || "",
          notes: r.notes || "",
          notesVisible: r.notesVisible === "Yes",
        }));
        setStatus("Loaded from autosave.", "ok");
      } catch {
        /* ignore */
      }
    }

    async function submitAll() {
      const { date, rows } = collect();
      if (!date) {
        setStatus("Please select a Date first.", "bad");
        return;
      }
      if (!rows.length) {
        setStatus("Please add at least one engineer row.", "bad");
        return;
      }
      // Basic validation (engineer + minimal times)
      const invalid = rows.find(r => !r.username || !r.leaveHome || !r.arriveHome);
      if (invalid) {
        setStatus("Each row needs an Engineer, Leave Home and Arrive Home time.", "warn");
        return;
      }

      try {
        setStatus("Submitting…");
        const form = new URLSearchParams();
        form.append("date", date);
        form.append("entries", JSON.stringify(rows));
        form.append("source", "hours-entry-daily-v3");
        form.append("submittedAt", new Date().toISOString());

        const res = await fetch(ZAP_URL, {
          method: "POST",
          headers: { "Content-Type": "application/x-www-form-urlencoded" },
          body: form.toString(),
        });
        if (!res.ok) throw new Error("Non-200 from Zapier");

        setStatus("Submitted successfully.", "ok");
      } catch (e) {
        console.error(e);
        setStatus("Failed to submit. Please try again.", "bad");
      }
    }

    // ======== INIT ========
    (async function init() {
      // Default date today
      const dateEl = qs("#dayDate");
      if (!dateEl.value) {
        const today = new Date();
        const y = today.getFullYear();
        const m = String(today.getMonth() + 1).padStart(2, "0");
        const d = String(today.getDate()).padStart(2, "0");
        dateEl.value = `${y}-${m}-${d}`;
      }

      try {
        await loadUsers();
      } catch (e) {
        console.error(e);
        setStatus("Could not load users.json. Engineer/van lists may be empty.", "bad");
      }

      // Preload one row (optionally set logged-in username if available)
      const login = (() => {
        try { return sessionStorage.getItem("mostlaneUsername"); } catch { return null; }
      })();
      addRow({ username: login || "" });

      // Load autosaved (overrides the single default row if present)
      loadAll();

      // Events
      qs("#addEngineer").addEventListener("click", () => addRow());
      qs("#clearAll").addEventListener("click", () => {
        qs("#rows").innerHTML = "";
        saveAll();
      });
      qs("#dayDate").addEventListener("change", saveAll);
      qs("#submitAll").addEventListener("click", submitAll);
    })();
  </script>
</body>
</html>
