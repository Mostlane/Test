<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Engineer Hours Entry ‚Äì Mostlane</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<style>
  /* --- Layout stability baseline --- */
  *, *::before, *::after { box-sizing: border-box; }
  html, body { width:100%; max-width:100%; overflow-x:hidden; }

  :root{
    --ml-blue:#003366;
    --ml-accent:#1a73e8;
    --ml-ink:#27313a;
    --ml-bg:#e6e8eb;
    --card:#ffffffee;
    --muted:#718096;
    --ok:#0c7d27;
    --bad:#b00020;
  }
  body{
    font-family:"Segoe UI",system-ui,Roboto,Arial,sans-serif;
    background:var(--ml-bg) url('Mostlane_Embossed.png') no-repeat center center fixed;
    background-size:180% auto;
    margin:0;padding:40px;color:var(--ml-ink);
  }
  .shell{max-width:1100px;margin:0 auto;background:rgba(255,255,255,0.92);
    border-radius:14px;box-shadow:0 12px 28px rgba(0,0,0,0.12);min-width:0;}
  header{display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;
    background:linear-gradient(90deg,#fff,#f7f9fc);
    border-bottom:1px solid #e5e9f2;padding:18px 24px;gap:10px;}
  header h1{font-size:22px;margin:0;color:var(--ml-blue);}
  header a{background:var(--ml-accent);color:#fff;text-decoration:none;
    padding:8px 16px;border-radius:8px;font-weight:600;font-size:14px;white-space:nowrap;}
  .content{padding:22px 24px 28px;}
  .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:14px;min-width:0;}
  .card{background:var(--card);border:1px solid #e8edf3;border-radius:12px;padding:16px;min-width:0;}
  .title{font-weight:600;color:var(--ml-blue);margin-bottom:10px;}
  label{font-size:13px;color:#334155;display:block;margin-bottom:6px;}
  input,select,textarea{
    width:100%; max-width:100%;
    font-size:15px; border:1px solid #cbd5e1; border-radius:10px;
    padding:10px 12px; background:#fff; line-height:1.2;
  }
  input[type="time"], input[type="date"] { height:40px; }
  select { height:42px; }
  textarea{min-height:90px;resize:vertical;}
  .row{display:flex;align-items:flex-start;gap:14px;flex-wrap:wrap;min-width:0;}
  /* Make row children grow evenly but never shrink into overlap */
  .row > div{flex:1 1 260px; min-width:240px; max-width:100%;}

  .muted{color:var(--muted);font-size:12px;}
  .divider{height:1px;background:#edf2f7;margin:12px 0;}
  .toggle-row{display:flex;align-items:center;gap:10px;font-size:14px;user-select:none;}
  .radio-group{display:flex;gap:16px;align-items:center;flex-wrap:wrap;}

  .totals{display:flex;gap:10px;flex-wrap:wrap;font-weight:600;}
  .pill{padding:8px 12px;border-radius:999px;border:1px solid #d7e1ee;
    background:#f8fbff;color:#0f172a;display:inline-flex;align-items:center;gap:6px;}
  .pill.ok{border-color:#bfe7ca;background:#effaf3;color:#074e1a;}
  .pill.bad{border-color:#ffc7ce;background:#fff1f3;color:#6b0011;}

  .actions{display:flex;gap:14px;align-items:center;justify-content:flex-end;margin-top:10px;flex-wrap:wrap;}
  button{font-size:15px;font-weight:600;border:0;border-radius:10px;padding:12px 18px;cursor:pointer;}
  .btn-primary{background:var(--ml-accent);color:#fff;}
  .btn-secondary{background:#eef2f9;color:#0f172a;border:1px solid #d7e1ee;}
  .btn-link{background:transparent;color:var(--ml-accent);padding:8px 10px;white-space:nowrap;}

  .col-12{grid-column:span 12;}
  .col-6{grid-column:span 6;}

  /* Make nested grids resilient on smaller widths */
  @media (max-width: 1120px){
    .row > div{flex:1 1 300px;}
  }
  @media(max-width:980px){
    .col-6{grid-column:span 12;}
    .row > div{min-width:260px;flex:1 1 100%;}
  }
  .date-controls{display:flex;align-items:center;gap:8px;margin-top:8px;flex-wrap:wrap;}
  .banner{margin-top:8px;padding:8px 12px;border-radius:10px;border:1px solid #e5e9f2;background:#f7fbff;}

  /* Keep long helper text from pushing layout */
  #dowHint, .muted { overflow:hidden; text-overflow:ellipsis; white-space:nowrap; max-width:100%; display:inline-block; }

  /* Prevent nested grid overflow in time section */
  .card .grid { min-width:0; }
</style>
</head>
<body>
<div class="shell">
<header>
  <h1>Engineer Hours Entry</h1>
  <a href="main.html">Main Menu</a>
</header>

<div class="content">
<form id="hoursForm" class="grid" novalidate>

<!-- Day & Engineer -->
<div class="card col-12">
  <div class="title">Day & Engineer</div>
  <div class="row">
    <div>
      <label>Date</label>
      <input type="date" id="date" required />
      <div class="date-controls">
        <button type="button" class="btn-link" id="prevDayBtn">‚óÄ Previous</button>
        <button type="button" class="btn-link" id="nextDayBtn">Next ‚ñ∂</button>
        <span class="muted" id="dowHint"></span>
      </div>
      <div id="weekBanner" class="banner" style="display:none;"></div>
    </div>
    <div>
      <label>Engineer</label>
      <select id="engineer" required></select>
      <div class="muted">Active users from users.json</div>
    </div>
    <div>
      <label>Vehicle Used</label>
      <input type="text" id="vehicleUsed" list="vehicleList" placeholder="e.g. LA70 FPJ" />
      <datalist id="vehicleList"></datalist>
    </div>
  </div>
</div>

<!-- Times -->
<div class="card col-6">
  <div class="title">Times (24h)</div>
  <div class="grid" style="grid-template-columns:repeat(12,1fr);gap:10px;">
    <div style="grid-column:span 3;"><label>Leave Home</label><input type="time" id="leaveHome" required></div>
    <div style="grid-column:span 3;"><label>Arrive First</label><input type="time" id="arriveFirst" required></div>
    <div style="grid-column:span 3;"><label>Leave Last</label><input type="time" id="leaveLast" required></div>
    <div style="grid-column:span 3;"><label>Arrive Home</label><input type="time" id="arriveHome" required></div>
  </div>
  <div class="divider"></div>
  <label class="toggle-row"><input type="checkbox" id="deductLunch" checked> Deduct 30m lunch</label>
</div>

<!-- Vehicle / Notes -->
<div class="card col-6">
  <div class="title">Vehicle, Mileage & Notes</div>
  <div id="mondayBlock" style="display:none;margin-bottom:10px;">
    <label>Monday ‚Äì Van check?</label>
    <div class="radio-group">
      <label><input type="radio" name="vanCheck" value="Yes">Yes</label>
      <label><input type="radio" name="vanCheck" value="No">No</label>
      <label><input type="radio" name="vanCheck" value="N/A">N/A</label>
    </div>
    <div class="muted">If ‚ÄúNo‚Äù, payroll will pay standard rate only for the whole week.</div>
  </div>
  <div id="fridayBlock" style="display:none;margin-bottom:10px;">
    <label>Friday ‚Äì Van score (0‚Äì100)</label>
    <input type="number" id="vanScore" min="0" max="100">
    <label style="margin-top:8px;">Personal mileage (weekly)</label>
    <input type="number" id="personalMileage" min="0" step="1">
  </div>
  <div class="divider"></div>
  <div class="row" style="align-items:flex-start;">
    <div>
      <label>Office notes</label>
      <textarea id="notes" placeholder="e.g. traffic delay, extra stop..."></textarea>
    </div>
    <div style="max-width:360px;">
      <label>Visibility</label>
      <label class="toggle-row"><input type="checkbox" id="noteVisible"> ü™® Visible to engineer</label>
      <div class="muted">Default off</div>
    </div>
  </div>
</div>

<!-- Totals -->
<div class="card col-12">
  <div class="title">Calculated Totals</div>
  <div class="totals">
    <span class="pill">Total: <span id="t_total">0.00</span> h</span>
    <span class="pill ok">Standard: <span id="t_std">0.00</span> h</span>
    <span class="pill">Overtime: <span id="t_ot">0.00</span> h</span>
    <span class="pill" id="enhPill">Enhanced OT: <span id="t_enh">Yes</span></span>
  </div>
  <div class="muted" id="logicNote" style="margin-top:6px;"></div>
</div>

<!-- Actions -->
<div class="col-12 actions">
  <span class="muted" id="statusMsg"></span>
  <button type="reset" class="btn-secondary" id="resetBtn">Clear</button>
  <button type="submit" class="btn-primary" id="submitBtn">Submit to Payroll</button>
</div>

</form>
</div>
</div>

<script>
/* ====== CONFIG ====== */
const ZAPIER_WEBHOOK="https://hooks.zapier.com/hooks/catch/20261714/u5ibaoi/";
const USERS_JSON_PATH="./users.json";

/* ====== STATE ====== */
let USERS_RAW=[],ENGINEERS=[],VEHICLE_SET=new Set();

/* ====== HELPERS ====== */
const $=id=>document.getElementById(id);
function timeToMin(t){if(!t||!t.includes(":"))return null;const[h,m]=t.split(":").map(Number);return h*60+m;}
function minsToHr(m){return Math.round((m/60)*100)/100;}
function fmtDate(d){return d.toISOString().split("T")[0];}
function shiftDate(delta){const d=new Date($("date").value+"T12:00");d.setDate(d.getDate()+delta);$("date").value=fmtDate(d);updateDay();}
function dow(d){return new Date(d+"T12:00").toLocaleDateString(undefined,{weekday:"long"});}
function dayNum(d){return new Date(d+"T12:00").getDay();} // 0=Sun..6=Sat
function getWeekKey(dateStr){
  // Using Sunday-start week key
  const d = new Date(dateStr+"T12:00");
  const sunday = new Date(d);
  sunday.setDate(d.getDate() - d.getDay());
  return sunday.toISOString().split("T")[0];
}

/* ====== INIT ====== */
async function init(){
  // Load users.json
  try{
    const r=await fetch(USERS_JSON_PATH,{cache:"no-store"});
    const j=await r.json();USERS_RAW=j.Users||j;
  }catch{USERS_RAW=[];}

  // Populate engineers (Active)
  ENGINEERS=USERS_RAW
    .filter(u=>u.Status==="Active")
    .map(u=>({name:`${u.FirstName} ${u.LastName}`.trim(),username:u.Username,vehicle:u.VehicleAssigned||""}))
    .sort((a,b)=>a.name.localeCompare(b.name));

  const sel=$("engineer");
  ENGINEERS.forEach(e=>{
    const o=document.createElement("option");
    o.value=e.name;
    o.textContent=e.name; // visible name
    o.dataset.username=e.username;
    o.dataset.vehicle=e.vehicle;
    sel.appendChild(o);
  });

  // Vehicle list datalist
  USERS_RAW.forEach(u=>{if(u.VehicleAssigned)VEHICLE_SET.add(u.VehicleAssigned);});
  const dl=$("vehicleList");
  Array.from(VEHICLE_SET).sort().forEach(v=>{const o=document.createElement("option");o.value=v;dl.appendChild(o);});

  // Events
  $("engineer").onchange=()=>{const s=$("engineer");const v=s.options[s.selectedIndex]?.dataset.vehicle || "";$("vehicleUsed").value=v;};
  $("prevDayBtn").onclick=()=>shiftDate(-1);
  $("nextDayBtn").onclick=()=>shiftDate(1);
  ["leaveHome","arriveFirst","leaveLast","arriveHome","deductLunch"].forEach(id=>{
    $(id).addEventListener("input",calcTotals);
    $(id).addEventListener("change",calcTotals);
  });
  document.querySelectorAll('input[name="vanCheck"]').forEach(r=>r.addEventListener("change",calcTotals));
  $("hoursForm").onsubmit=submitForm;
  $("resetBtn").onclick=()=>{$("statusMsg").textContent="";};

  // Default to yesterday
  const y=new Date();y.setDate(y.getDate()-1);$("date").value=fmtDate(y);
  updateDay();calcTotals();
}

/* ====== UI DAY CONTEXT ====== */
function updateDay(){
  const d=$("date").value;if(!d)return;
  const day=dayNum(d);
  $("dowHint").textContent="Selected: "+dow(d);

  // Monday block (van check)
  $("mondayBlock").style.display = day===1 ? "block" : "none";

  // Friday block (van score + mileage only on Fridays)
  $("fridayBlock").style.display = day===5 ? "block" : "none";

  // Banner reminder: On non-Mondays, OT is subject to weekly van-check rule handled in payroll
  const banner = $("weekBanner");
  if(day!==1){
    banner.style.display="block";
    banner.textContent = "Note: Enhanced overtime for this day will be confirmed by payroll based on this week's Monday van-check status.";
  }else{
    banner.style.display="none";
    banner.textContent = "";
  }

  calcTotals();
}

/* ====== CALCULATIONS (client-side preview only) ====== */
function calcTotals(){
  const t1=timeToMin($("leaveHome").value),
        t2=timeToMin($("arriveFirst").value),
        t3=timeToMin($("leaveLast").value),
        t4=timeToMin($("arriveHome").value);

  if([t1,t2,t3,t4].some(v=>v==null)){
    $("t_total").textContent="0.00";
    $("t_std").textContent="0.00";
    $("t_ot").textContent="0.00";
    $("t_enh").textContent="Yes";
    $("enhPill").className="pill ok";
    $("logicNote").textContent="";
    return;
  }

  let totalMins = t4 - t1;
  if ($("deductLunch").checked) totalMins -= 30;
  if (totalMins < 0) totalMins = 0;

  const total = minsToHr(totalMins);
  const std = Math.min(10, total);
  const ot  = Math.max(0, +(total - 10).toFixed(2));

  // Enhanced overtime logic preview:
  const d=$("date").value;
  const isMonday = dayNum(d)===1;

  let enhanced = true;
  let msg = "Enhanced overtime if total > 10h.";

  if(isMonday){
    const v = document.querySelector('input[name="vanCheck"]:checked');
    if(v){
      if(v.value==="No"){ enhanced=false; msg="Van check = No ‚Üí this Monday paid at standard rate only."; }
      if(v.value==="Yes"){ enhanced=true;  msg="Van check = Yes ‚Üí enhanced OT applies if >10h."; }
      if(v.value==="N/A"){ enhanced=true;  msg="Van check = N/A ‚Üí enhanced OT applies if >10h."; }
    } else {
      msg="Select Monday van check status.";
    }
  } else {
    // Non-Monday: payroll will enforce based on week flag stored in Zapier
    msg="Overtime preview shown. Payroll will apply weekly van-check rule.";
  }

  $("t_total").textContent = total.toFixed(2);
  $("t_std").textContent   = std.toFixed(2);
  $("t_ot").textContent    = ot.toFixed(2);
  $("t_enh").textContent   = enhanced ? "Yes" : "No";
  $("enhPill").className   = enhanced ? "pill ok" : "pill bad";
  $("logicNote").textContent = msg;
}

/* ====== GATHER + SUBMIT ====== */
function gather(){
  const d=$("date").value;
  const engineer=$("engineer").value;
  const vehicle=$("vehicleUsed").value;
  const leaveHome=$("leaveHome").value;
  const arriveFirst=$("arriveFirst").value;
  const leaveLast=$("leaveLast").value;
  const arriveHome=$("arriveHome").value;
  const notes=$("notes").value.trim();
  const noteVisible=$("noteVisible").checked;
  const vanScore=$("vanScore").value || "";
  const personalMileage = (dayNum(d)===5) ? ($("personalMileage").value || "") : "";

  // Monday van-check ‚Üí compute weekly flag to send to Zapier
  let vanCheck=null;
  let vanCheckWeekStatus="";
  if(dayNum(d)===1){
    const v=document.querySelector('input[name="vanCheck"]:checked');
    vanCheck = v ? v.value : null;
    if(v){
      if(v.value==="No") vanCheckWeekStatus="Failed";
      if(v.value==="Yes" || v.value==="N/A") vanCheckWeekStatus="Passed";
    }
  }

  const payload = {
    // Core
    date: d,
    day: dow(d),
    weekKey: getWeekKey(d),
    vanCheckWeekStatus,
    engineer,
    vehicle,
    leaveHome,
    arriveFirstSite: arriveFirst,
    leaveLastSite: leaveLast,
    arriveHome,
    deductLunch: document.getElementById("deductLunch").checked,

    // Calculated preview
    totalHours: document.getElementById("t_total").textContent,
    standardHours: document.getElementById("t_std").textContent,
    overtimeHours: document.getElementById("t_ot").textContent,
    enhancedOvertimePreview: document.getElementById("t_enh").textContent,

    // Monday-only field
    vanCheck,

    // Friday-only data
    vanScore,
    personalMileage,

    // Notes
    notes,
    noteVisible,

    // Audit
    submittedAt: new Date().toISOString()
  };

  return payload;
}

async function submitForm(e){
  e.preventDefault();
  $("statusMsg").style.color="#475569";
  $("statusMsg").textContent="Submitting‚Ä¶";

  const data = gather();

  const body=new URLSearchParams();
  Object.entries(data).forEach(([k,v])=>body.append(k, v==null ? "" : String(v)));

  try{
    const r=await fetch(ZAPIER_WEBHOOK,{
      method:"POST",
      headers:{ "Content-Type":"application/x-www-form-urlencoded;charset=UTF-8" },
      body
    });
    $("statusMsg").style.color = r.ok ? "var(--ok)" : "var(--bad)";
    $("statusMsg").textContent = r.ok ? "‚úÖ Submitted" : "‚ùå Error submitting";
  }catch(err){
    $("statusMsg").style.color = "var(--bad)";
    $("statusMsg").textContent = "‚ùå Network error";
  }
}

window.addEventListener("DOMContentLoaded", init);
</script>
</body>
</html>
