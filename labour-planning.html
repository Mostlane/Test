<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Mostlane • Labour Planning</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="auth.js"></script>

  <style>
    :root{
      --ml-blue:#003b82;
      --bg:#e6e8eb;
      --panel:rgba(255,255,255,0.95);
      --border:#d1d5db;
      --muted:#6b7280;
      --danger:#b91c1c;
      --success:#15803d;
    }

    body{
      margin:0;
      padding:0;
      font-family:"Segoe UI",system-ui,-apple-system,sans-serif;
      background:var(--bg) url('Mostlane_Embossed.png') no-repeat center center fixed;
      background-size:cover;
    }

    .panel{
      max-width:1200px;
      margin:30px auto;
      background:var(--panel);
      border-radius:12px;
      padding:20px;
      box-shadow:0 4px 12px rgba(0,0,0,0.18);
    }

    h1, h2{
      text-align:center;
      color:var(--ml-blue);
      margin:0 0 10px;
    }

    .subheading{
      text-align:center;
      color:var(--muted);
      margin-bottom:20px;
      font-size:14px;
    }

    .form-row{
      display:flex;
      flex-wrap:wrap;
      gap:12px;
      margin-bottom:10px;
    }

    .form-group{
      flex:1 1 160px;
      min-width:150px;
    }

    label{
      display:block;
      font-weight:600;
      margin-bottom:4px;
      font-size:13px;
    }

    input, select{
      width:100%;
      padding:8px 10px;
      border-radius:8px;
      border:1px solid var(--border);
      font-size:14px;
      box-sizing:border-box;
    }

    button{
      padding:10px 16px;
      border-radius:8px;
      border:none;
      background:var(--ml-blue);
      color:#fff;
      font-weight:600;
      cursor:pointer;
      margin-top:8px;
    }

    button.secondary{
      background:#4b5563;
    }

    .summary{
      margin-top:15px;
      padding:10px 12px;
      border-radius:10px;
      background:#f3f4f6;
      font-size:13px;
      line-height:1.5;
    }

    .status-good{ color:var(--success); font-weight:700; }
    .status-bad{ color:var(--danger); font-weight:700; }

    table{
      width:100%;
      border-collapse:collapse;
      margin-top:18px;
      font-size:12px;
    }

    thead{
      position:sticky;
      top:0;
      background:#f9fafb;
      z-index:1;
    }

    th,td{
      border:1px solid var(--border);
      padding:4px 6px;
      text-align:center;
    }

    td input[type="number"]{
      width:60px;
      padding:4px;
      text-align:right;
      font-size:11px;
    }

    .night-label{
      display:flex;
      align-items:center;
      gap:3px;
      font-size:10px;
      justify-content:center;
    }

    .scroll-box{
      max-height:420px;
      overflow:auto;
      border-radius:10px;
      border:1px solid var(--border);
      background:white;
      margin-top:10px;
    }

    #saveStatus{
      margin-left:10px;
      font-size:12px;
      color:var(--muted);
    }

    .extra-engineer{
      background:#f9fafb;
      padding:10px;
      border:1px solid #d1d5db;
      border-radius:8px;
      margin-bottom:10px;
    }

    .project-meta{
      font-size:12px;
      color:var(--muted);
      margin-top:4px;
    }
  </style>
</head>
<body>

<!-- MAIN PANEL -->
<div class="panel">
  <h1>Labour Planning & Job Costing</h1>
  <div class="subheading">Track daily engineer hours, subcontractors, project cost & schedule performance.</div>

  <!-- LOAD EXISTING PROJECTS -->
  <div class="form-row">
    <div class="form-group">
      <label>Load Existing Project</label>
      <select id="projectSelect">
        <option value="">-- New Project --</option>
      </select>
      <div class="project-meta" id="projectMeta"></div>
    </div>
    <div class="form-group" style="align-self:flex-end;">
      <button id="loadProjectBtn" class="secondary">Load Selected</button>
    </div>
  </div>

  <!-- PROJECT SETUP -->
  <div class="form-row">
    <div class="form-group">
      <label>Project Name</label>
      <input id="projectName">
    </div>
    <div class="form-group">
      <label>Start Date</label>
      <input id="startDate" type="date">
    </div>
    <div class="form-group">
      <label>End Date</label>
      <input id="endDate" type="date">
    </div>
    <div class="form-group">
      <label>Total Planned Hours</label>
      <input id="totalHours" type="number" min="0">
    </div>
  </div>

  <button id="buildPlanBtn">Create / Rebuild Plan (Mon–Fri only)</button>
  <button id="saveBtn" class="secondary" disabled>Save Plan to Server</button>
  <span id="saveStatus"></span>

  <div id="summary" class="summary" style="display:none;"></div>

  <div id="tableContainer" class="scroll-box" style="display:none;">
    <table>
      <thead id="tableHead"></thead>
      <tbody id="planBody"></tbody>
    </table>
  </div>
</div>

<!-- SUBCONTRACTOR PANEL -->
<div class="panel">
  <h2>Additional Engineers / Subcontractors</h2>

  <div id="extra-engineer-list"></div>

  <button id="addExtraBtn">Add Additional Engineer</button>
</div>


<script>
/* --------------------------------------------
   CONFIG
---------------------------------------------*/
const API_BASE_URL = "https://mostlane-labour-api.jamie-def.workers.dev";
const API_SAVE_URL = `${API_BASE_URL}/save`;
const API_LIST_URL = `${API_BASE_URL}/list`;
const API_LOAD_URL = `${API_BASE_URL}/load`;

/* --------------------------------------------
   NAMED ENGINEERS (fixed)
---------------------------------------------*/
const engineers = [
  { key:"Connor", name:"Connor", rate:20 },
  { key:"Brad",   name:"Brad",   rate:22 },
  { key:"JT",     name:"JT",     rate:25 },
  { key:"Ryan",   name:"Ryan",   rate:15 }
];

/* --------------------------------------------
   ADDITIONAL ENGINEERS
---------------------------------------------*/
let extraEngineers = [];   // each = { id, name, rate }
let nextExtraId = 1;

/* --------------------------------------------
   PROJECT STATE
---------------------------------------------*/
let projectState = {
  projectName:"",
  startDate:null,
  endDate:null,
  totalHours:0,
  plannedPerDay:0,
  days:[],
  metrics:{}
};

let currentKey = null;

/* --------------------------------------------
   DOM ELEMENTS
---------------------------------------------*/
const buildBtn      = document.getElementById("buildPlanBtn");
const saveBtn       = document.getElementById("saveBtn");
const saveStatus    = document.getElementById("saveStatus");
const planBody      = document.getElementById("planBody");
const tableHead     = document.getElementById("tableHead");
const tableWrap     = document.getElementById("tableContainer");
const summaryEl     = document.getElementById("summary");
const projectSelect = document.getElementById("projectSelect");
const projectMeta   = document.getElementById("projectMeta");
const loadProjectBtn= document.getElementById("loadProjectBtn");

/* --------------------------------------------
   EVENT HANDLERS
---------------------------------------------*/
buildBtn.addEventListener("click", buildPlan);
document.getElementById("addExtraBtn").addEventListener("click", addExtraEngineer);
saveBtn.addEventListener("click", savePlan);
loadProjectBtn.addEventListener("click", () => {
  const key = projectSelect.value;
  if (!key) {
    // New project – clear everything
    currentKey = null;
    projectMeta.textContent = "";
    projectState = {
      projectName:"",
      startDate:null,
      endDate:null,
      totalHours:0,
      plannedPerDay:0,
      days:[],
      metrics:{}
    };
    extraEngineers = [];
    renderExtraEngineers();
    renderTable();
    summaryEl.style.display = "none";
    saveBtn.disabled = true;
    return;
  }
  loadProject(key);
});

document.addEventListener("DOMContentLoaded", () => {
  loadProjectList();
});

/* --------------------------------------------
   LOAD PROJECT LIST FROM KV
---------------------------------------------*/
async function loadProjectList(){
  try{
    const res = await fetch(API_LIST_URL);
    if(!res.ok) throw new Error("List failed");
    const data = await res.json();

    projectSelect.innerHTML = `<option value="">-- New Project --</option>`;

    (data.projects || []).forEach(p => {
      const opt = document.createElement("option");
      opt.value = p.key;
      let label = p.projectName || p.key;
      if(p.startDate && p.endDate){
        label += ` (${p.startDate} → ${p.endDate})`;
      }
      opt.textContent = label;
      projectSelect.appendChild(opt);
    });

  }catch(err){
    console.error("Error loading project list:", err);
    projectMeta.textContent = "⚠ Could not load project list.";
  }
}

/* --------------------------------------------
   LOAD SINGLE PROJECT FROM KV
---------------------------------------------*/
async function loadProject(key){
  try{
    saveStatus.textContent = "Loading…";
    const res = await fetch(`${API_LOAD_URL}?key=${encodeURIComponent(key)}`);
    const data = await res.json();

    if(!res.ok){
      console.error("Load error:", data);
      saveStatus.textContent = "❌ Error loading project";
      return;
    }

    currentKey = data.key || key;

    // Populate form
    document.getElementById("projectName").value = data.projectName || "";
    document.getElementById("startDate").value   = data.startDate || "";
    document.getElementById("endDate").value     = data.endDate || "";
    document.getElementById("totalHours").value  = data.totalPlannedHours || 0;

    // Rebuild state
    projectState = {
      projectName: data.projectName || "",
      startDate: data.startDate ? new Date(data.startDate) : null,
      endDate:   data.endDate   ? new Date(data.endDate)   : null,
      totalHours: data.totalPlannedHours || 0,
      plannedPerDay: data.plannedPerDay || 0,
      days: (data.days || []).map(d => ({ dateISO: d.date })),
      metrics: data.metrics || {}
    };

    // Extra engineers
    extraEngineers = data.extraEngineers || [];
    // Ensure nextExtraId is ahead
    let maxId = 0;
    extraEngineers.forEach(e => { if(e.id > maxId) maxId = e.id; });
    nextExtraId = maxId + 1;

    renderExtraEngineers();
    renderTable();

    // Now inject hours/night flags from saved days
    (data.days || []).forEach(day => {
      const row = planBody.querySelector(`tr[data-date="${day.date}"]`);
      if(!row) return;

      // Main engineers
      if(day.mainEngineers){
        Object.entries(day.mainEngineers).forEach(([engKey, info]) => {
          const input = row.querySelector(`.hours-input[data-eng="main_${engKey}"]`);
          const chk   = row.querySelector(`.night-checkbox[data-eng="main_${engKey}"]`);
          if(input)  input.value  = info.hours ?? 0;
          if(chk)    chk.checked  = !!info.night;
        });
      }

      // Extra engineers
      if(day.extraEngineers){
        Object.entries(day.extraEngineers).forEach(([id, info]) => {
          const keyStr = `extra_${id}`;
          const input = row.querySelector(`.hours-input[data-eng="${keyStr}"]`);
          const chk   = row.querySelector(`.night-checkbox[data-eng="${keyStr}"]`);
          if(input)  input.value = info.hours ?? 0;
          if(chk)    chk.checked = !!info.night;
        });
      }
    });

    recalcAll();
    saveBtn.disabled = false;
    saveStatus.textContent = "";
    projectMeta.textContent = `Loaded key: ${currentKey}`;

  }catch(err){
    console.error("Network error loading project:", err);
    saveStatus.textContent = "❌ Network error loading project";
  }
}

/* --------------------------------------------
   ADD ADDITIONAL ENGINEERS
---------------------------------------------*/
function addExtraEngineer(){
  const id = nextExtraId++;

  extraEngineers.push({
    id,
    name: `Engineer ${id}`,
    rate: 20
  });

  renderExtraEngineers();
  renderTable();
  recalcAll();
}

function renderExtraEngineers(){
  const container = document.getElementById("extra-engineer-list");
  container.innerHTML = "";

  extraEngineers.forEach(e => {
    const div = document.createElement("div");
    div.className = "extra-engineer";

    div.innerHTML = `
      <label>Name:</label>
      <input type="text" value="${e.name}" onchange="updateExtraName(${e.id}, this.value)">
      <label>Hourly Rate (£):</label>
      <input type="number" step="0.5" min="0" value="${e.rate}" onchange="updateExtraRate(${e.id}, this.value)">
      <button onclick="removeExtraEngineer(${e.id})"
              style="background:#b91c1c;color:white;padding:4px 10px;border:none;border-radius:6px;margin-left:8px;">
        Remove
      </button>
    `;
    container.appendChild(div);
  });
}

// expose updates to window
window.updateExtraName = function(id, value){
  const e = extraEngineers.find(x => x.id === id);
  if(e){ e.name = value; renderTable(); recalcAll(); }
};

window.updateExtraRate = function(id, value){
  const e = extraEngineers.find(x => x.id === id);
  if(e){ e.rate = Number(value); renderTable(); recalcAll(); }
};

window.removeExtraEngineer = function(id){
  extraEngineers = extraEngineers.filter(x => x.id !== id);
  renderExtraEngineers();
  renderTable();
  recalcAll();
};

/* --------------------------------------------
   BUILD PROJECT PLAN  (Mon–Fri only)
---------------------------------------------*/
function buildPlan(){
  const name = document.getElementById("projectName").value.trim();
  const startStr = document.getElementById("startDate").value;
  const endStr   = document.getElementById("endDate").value;
  const totalHours = Number(document.getElementById("totalHours").value);

  if(!name || !startStr || !endStr || !totalHours){
    alert("Please complete all fields.");
    return;
  }

  const start = new Date(startStr);
  const end   = new Date(endStr);
  if(end < start){
    alert("End date cannot be before start date.");
    return;
  }

  const days = [];
  let d = new Date(start);

  // MONDAY–FRIDAY ONLY
  while(d <= end){
    const dayOfWeek = d.getDay(); // 0=Sun, 6=Sat
    if(dayOfWeek !== 0 && dayOfWeek !== 6){
      days.push({ dateISO: d.toISOString().slice(0,10) });
    }
    d.setDate(d.getDate() + 1);
  }

  if(days.length === 0){
    alert("No weekdays in the selected range.");
    return;
  }

  projectState = {
    projectName:name,
    startDate:start,
    endDate:end,
    totalHours,
    plannedPerDay: totalHours / days.length,
    days,
    metrics:{}
  };

  renderTable();
  recalcAll();
  saveBtn.disabled = false;
}

/* --------------------------------------------
   RENDER TABLE WITH MAIN + EXTRA ENGINEERS
---------------------------------------------*/
function renderTable(){

  if(projectState.days.length === 0){
    tableWrap.style.display = "none";
    planBody.innerHTML = "";
    tableHead.innerHTML = "";
    return;
  }

  tableWrap.style.display = "block";

  /* Build Table Header */
  let headHTML = `
    <tr>
      <th rowspan="2">Date</th>
      <th rowspan="2">Planned<br>Hours</th>
  `;

  // Main engineers
  engineers.forEach(e=>{
    headHTML += `<th colspan="2">${e.name} (£${e.rate})</th>`;
  });

  // Extra engineers
  extraEngineers.forEach(e=>{
    headHTML += `<th colspan="2">${e.name} (£${e.rate})</th>`;
  });

  headHTML += `
      <th rowspan="2">Total<br>Hours</th>
      <th rowspan="2">Daily<br>Cost (£)</th>
    </tr>
    <tr>
  `;

  // Night columns
  [...engineers, ...extraEngineers].forEach(()=>{
    headHTML += `<th>Hrs</th><th>Night?</th>`;
  });

  headHTML += `</tr>`;
  tableHead.innerHTML = headHTML;

  /* Build Rows */
  planBody.innerHTML = "";

  projectState.days.forEach(day => {
    const dateISO = day.dateISO;
    const dateObj = new Date(dateISO);

    const pretty = dateObj.toLocaleDateString("en-GB", {
      weekday:"short", day:"2-digit", month:"2-digit"
    });

    const tr = document.createElement("tr");
    tr.dataset.date = dateISO;

    tr.innerHTML = `
      <td>${pretty}</td>
      <td class="planned-cell">${projectState.plannedPerDay.toFixed(1)}</td>
    `;

    function appendEngineerCells(e, prefix, id=null){
      const engKey = prefix + (id ? id : e.key);

      tr.innerHTML += `
        <td><input type="number" min="0" step="0.5"
              class="hours-input"
              data-eng="${engKey}" data-rate="${e.rate}" data-date="${dateISO}"></td>
        <td><label class="night-label">
              <input type="checkbox"
                     class="night-checkbox"
                     data-eng="${engKey}" data-rate="${e.rate}" data-date="${dateISO}">
              Night
            </label></td>
      `;
    }

    // Named engineers
    engineers.forEach(e => appendEngineerCells(e, "main_"));

    // Extra engineers
    extraEngineers.forEach(e => appendEngineerCells(e, "extra_", e.id));

    tr.innerHTML += `
      <td class="day-total-hours">0.0</td>
      <td class="day-cost">0.00</td>
    `;

    planBody.appendChild(tr);
  });
}

/* --------------------------------------------
   COST LOGIC (same rules for all engineers)
---------------------------------------------*/
function calcCost(hours, rate, isWeekend, isNight){
  if(hours <= 0) return { normal:0, ot:0, cost:0 };

  // Weekend OR night → all OT
  if(isWeekend || isNight){
    return {
      normal:0,
      ot:hours,
      cost: hours * rate * 1.5
    };
  }

  // Weekday normal rules (OT after 10h)
  if(hours > 10){
    return {
      normal:10,
      ot: hours - 10,
      cost: (10 * rate) + ((hours - 10) * rate * 1.5)
    };
  }

  return {
    normal:hours,
    ot:0,
    cost: hours * rate
  };
}

/* --------------------------------------------
   RECALCULATE EVERYTHING
---------------------------------------------*/
function recalcAll(){
  if(!projectState.days.length) return;

  let cumPlanned = 0;
  let cumActual  = 0;
  let cumCost    = 0;

  let lastDateWithData = null;
  let daysWithHours    = 0;

  [...planBody.querySelectorAll("tr")].forEach(row => {
    const dateISO = row.dataset.date;
    const dateObj = new Date(dateISO);
    const isWeekend = (dateObj.getDay() === 0 || dateObj.getDay() === 6);

    const planned = Number(row.querySelector(".planned-cell").textContent);

    cumPlanned += planned;

    let dayHours = 0;
    let dayCost  = 0;

    // ALL ENGINEERS (main + extra)
    row.querySelectorAll(".hours-input").forEach(input => {
      const hrs = Number(input.value) || 0;
      const engRate = Number(input.dataset.rate);
      const engKey  = input.dataset.eng;
      const nightCheckbox = row.querySelector(`.night-checkbox[data-eng="${engKey}"]`);
      const isNight = nightCheckbox && nightCheckbox.checked;

      const costObj = calcCost(hrs, engRate, isWeekend, isNight);
      dayHours += hrs;
      dayCost  += costObj.cost;
    });

    if(dayHours > 0){
      lastDateWithData = dateObj;
      daysWithHours++;
    }

    cumActual += dayHours;
    cumCost   += dayCost;

    row.querySelector(".day-total-hours").textContent = dayHours.toFixed(1);
    row.querySelector(".day-cost").textContent = dayCost.toFixed(2);
  });

  // SPI + forecast
  let statusText = "No hours entered yet.";
  let statusClass = "";
  let spi = null;

  if(cumActual > 0 && cumPlanned > 0){
    spi = cumActual / cumPlanned;
    if(spi > 1.05){
      statusText = "Ahead of schedule";
      statusClass = "status-good";
    } else if (spi < 0.95){
      statusText = "Behind schedule";
      statusClass = "status-bad";
    } else {
      statusText = "On schedule";
      statusClass = "status-good";
    }
  }

  let forecastLine = "Not enough data to forecast.";
  let forecastEndISO = null;

  if(daysWithHours > 0 && cumActual > 0){
    const avg = cumActual / daysWithHours;
    const remaining = Math.max(projectState.totalHours - cumActual, 0);

    if(avg > 0 && remaining > 0){
      const daysLeft = Math.ceil(remaining / avg);
      const start = lastDateWithData || projectState.startDate;
      const f = new Date(start);
      f.setDate(f.getDate() + daysLeft);
      forecastEndISO = f.toISOString().slice(0,10);

      if(projectState.endDate && f > projectState.endDate){
        forecastLine = `⚠ Project will finish late (${f.toLocaleDateString("en-GB")}).`;
      } else {
        forecastLine = `✅ Project expected to finish by ${f.toLocaleDateString("en-GB")}.`;
      }
    }
  }

  summaryEl.style.display = "block";
  summaryEl.innerHTML = `
    <div><b>Total Planned:</b> ${projectState.totalHours}h</div>
    <div><b>Actual Hours:</b> ${cumActual.toFixed(1)}h</div>
    <div><b>Total Cost So Far:</b> £${cumCost.toFixed(2)}</div>
    <div><b>SPI:</b> ${spi ? spi.toFixed(2) : "N/A"} 
      <span class="${statusClass}"> – ${statusText}</span></div>
    <div>${forecastLine}</div>
  `;

  projectState.metrics = {
    cumPlanned,
    cumActual,
    cumCost,
    spi,
    forecastEndISO
  };
}

/* --------------------------------------------
   SAVE PAYLOAD → Worker /save
---------------------------------------------*/
async function savePlan() {
  saveBtn.disabled = true;
  saveStatus.textContent = "Saving…";

  const rows = [...planBody.querySelectorAll("tr")];

  const days = rows.map(row => {
    const dateISO = row.dataset.date;
    const dateObj = new Date(dateISO);
    const isWeekend = (dateObj.getDay() === 0 || dateObj.getDay() === 6);

    const planned = Number(row.querySelector(".planned-cell").textContent);
    const totalHours = Number(row.querySelector(".day-total-hours").textContent);
    const totalCost  = Number(row.querySelector(".day-cost").textContent);

    // MAIN ENGINEERS
    const main = {};
    engineers.forEach(e => {
      const hrs = Number(row.querySelector(`.hours-input[data-eng="main_${e.key}"]`)?.value || 0);
      const night = row.querySelector(`.night-checkbox[data-eng="main_${e.key}"]`)?.checked || false;
      const costObj = calcCost(hrs, e.rate, isWeekend, night);

      main[e.key] = {
        name: e.name,
        rate: e.rate,
        hours: hrs,
        night,
        normalHours: costObj.normal,
        otHours: costObj.ot,
        cost: costObj.cost
      };
    });

    // EXTRA ENGINEERS
    const extra = {};
    extraEngineers.forEach(ex => {
      const keyStr = `extra_${ex.id}`;
      const hrs = Number(row.querySelector(`.hours-input[data-eng="${keyStr}"]`)?.value || 0);
      const night = row.querySelector(`.night-checkbox[data-eng="${keyStr}"]`)?.checked || false;
      const costObj = calcCost(hrs, ex.rate, isWeekend, night);

      extra[ex.id] = {
        name: ex.name,
        rate: ex.rate,
        hours: hrs,
        night,
        normalHours: costObj.normal,
        otHours: costObj.ot,
        cost: costObj.cost
      };
    });

    return {
      date: dateISO,
      isWeekend,
      plannedHours: planned,
      totalHours,
      totalCost,
      mainEngineers: main,
      extraEngineers: extra
    };
  });

  const payload = {
    key: currentKey || undefined,
    projectName: projectState.projectName,
    startDate: document.getElementById("startDate").value,
    endDate: document.getElementById("endDate").value,
    totalPlannedHours: projectState.totalHours,
    plannedPerDay: projectState.plannedPerDay,
    namedEngineers: engineers,
    extraEngineers,
    metrics: projectState.metrics,
    days,
    savedAt: new Date().toISOString()
  };

  if (!payload.projectName) {
    saveStatus.textContent = "❌ Project name required";
    saveBtn.disabled = false;
    return;
  }

  try{
    const res = await fetch(API_SAVE_URL, {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body:JSON.stringify(payload)
    });

    const data = await res.json();

    if(!res.ok){
      console.error("Save error:", data);
      saveStatus.textContent = "❌ Error saving (Worker rejected request)";
      saveBtn.disabled = false;
      return;
    }

    currentKey = data.key || currentKey;
    saveStatus.textContent = "✅ Plan saved successfully!";
    projectMeta.textContent = currentKey ? `Last saved as: ${currentKey}` : "";
    // Refresh project list so new jobs appear
    loadProjectList();

  } catch(err){
    console.error("Network error:", err);
    saveStatus.textContent = "❌ Error saving (network issue)";
  }

  saveBtn.disabled = false;
}
</script>

</body>
</html>
