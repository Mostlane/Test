<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Mostlane • Labour Planning</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="auth.js"></script>

  <style>
    :root{
      --ml-blue:#003b82;
      --bg:#e6e8eb;
      --panel:rgba(255,255,255,0.95);
      --border:#d1d5db;
      --muted:#6b7280;
      --danger:#b91c1c;
      --success:#15803d;
    }

    body{
      margin:0;
      padding:0;
      font-family:"Segoe UI",system-ui,-apple-system,sans-serif;
      background:var(--bg) url('Mostlane_Embossed.png') no-repeat center center fixed;
      background-size:cover;
    }

    .panel{
      max-width:1200px;
      margin:30px auto;
      background:var(--panel);
      border-radius:12px;
      padding:20px;
      box-shadow:0 4px 12px rgba(0,0,0,0.18);
    }

    h1, h2{
      text-align:center;
      color:var(--ml-blue);
      margin:0 0 10px;
    }

    .subheading{
      text-align:center;
      color:var(--muted);
      margin-bottom:20px;
      font-size:14px;
    }

    .form-row{
      display:flex;
      flex-wrap:wrap;
      gap:12px;
      margin-bottom:10px;
    }

    .form-group{
      flex:1 1 160px;
      min-width:150px;
    }

    label{
      display:block;
      font-weight:600;
      margin-bottom:4px;
      font-size:13px;
    }

    input{
      width:100%;
      padding:8px 10px;
      border-radius:8px;
      border:1px solid var(--border);
      font-size:14px;
      box-sizing:border-box;
    }

    button{
      padding:10px 16px;
      border-radius:8px;
      border:none;
      background:var(--ml-blue);
      color:#fff;
      font-weight:600;
      cursor:pointer;
      margin-top:8px;
    }

    button.secondary{
      background:#4b5563;
    }

    .summary{
      margin-top:15px;
      padding:10px 12px;
      border-radius:10px;
      background:#f3f4f6;
      font-size:13px;
      line-height:1.5;
    }

    .status-good{ color:var(--success); font-weight:700; }
    .status-bad{ color:var(--danger); font-weight:700; }

    table{
      width:100%;
      border-collapse:collapse;
      margin-top:18px;
      font-size:12px;
    }

    thead{
      position:sticky;
      top:0;
      background:#f9fafb;
      z-index:1;
    }

    th,td{
      border:1px solid var(--border);
      padding:4px 6px;
      text-align:center;
    }

    td input[type="number"]{
      width:60px;
      padding:4px;
      text-align:right;
      font-size:11px;
    }

    .night-label{
      display:flex;
      align-items:center;
      gap:3px;
      font-size:10px;
      justify-content:center;
    }

    .scroll-box{
      max-height:420px;
      overflow:auto;
      border-radius:10px;
      border:1px solid var(--border);
      background:white;
      margin-top:10px;
    }

    #saveStatus{
      margin-left:10px;
      font-size:12px;
      color:var(--muted);
    }

    .extra-engineer{
      background:#f9fafb;
      padding:10px;
      border:1px solid #d1d5db;
      border-radius:8px;
      margin-bottom:10px;
    }
  </style>
</head>
<body>

<!-- MAIN PANEL -->
<div class="panel">
  <h1>Labour Planning & Job Costing</h1>
  <div class="subheading">Track daily engineer hours, subcontractors, project cost & schedule performance.</div>

  <div class="form-row">
    <div class="form-group">
      <label>Project Name</label>
      <input id="projectName">
    </div>
    <div class="form-group">
      <label>Start Date</label>
      <input id="startDate" type="date">
    </div>
    <div class="form-group">
      <label>End Date</label>
      <input id="endDate" type="date">
    </div>
    <div class="form-group">
      <label>Total Planned Hours</label>
      <input id="totalHours" type="number" min="0">
    </div>
  </div>

  <button id="buildPlanBtn">Create / Rebuild Plan</button>
  <button id="saveBtn" class="secondary" disabled>Save Plan to Server</button>
  <span id="saveStatus"></span>

  <div id="summary" class="summary" style="display:none;"></div>

  <div id="tableContainer" class="scroll-box" style="display:none;">
    <table>
      <thead id="tableHead"></thead>
      <tbody id="planBody"></tbody>
    </table>
  </div>
</div>

<!-- SUBCONTRACTOR PANEL -->
<div class="panel">
  <h2>Additional Engineers / Subcontractors</h2>

  <div id="extra-engineer-list"></div>

  <button id="addExtraBtn">Add Additional Engineer</button>
</div>


<script>
/* --------------------------------------------
   CONFIG
---------------------------------------------*/
const API_SAVE_URL = "https://mostlane-labour-api.jamie-def.workers.dev/save";

/* --------------------------------------------
   NAMED ENGINEERS
---------------------------------------------*/
const engineers = [
  { key:"Connor", name:"Connor", rate:20 },
  { key:"Brad", name:"Brad", rate:22 },
  { key:"JT", name:"JT", rate:25 },
  { key:"Ryan", name:"Ryan", rate:15 }
];

/* --------------------------------------------
   EXTRA ENGINEERS / SUBCONTRACTORS
---------------------------------------------*/
let extraEngineers = [];
let nextExtraId = 1;

/* --------------------------------------------
   PROJECT STATE
---------------------------------------------*/
let projectState = {
  projectName:"",
  startDate:null,
  endDate:null,
  totalHours:0,
  plannedPerDay:0,
  days:[],
  metrics:{}
};

/* DOM */
const buildBtn     = document.getElementById("buildPlanBtn");
const saveBtn      = document.getElementById("saveBtn");
const saveStatus   = document.getElementById("saveStatus");
const planBody     = document.getElementById("planBody");
const tableHead    = document.getElementById("tableHead");
const tableWrap    = document.getElementById("tableContainer");
const summaryEl    = document.getElementById("summary");

/* EVENTS */
buildBtn.addEventListener("click", buildPlan);
document.getElementById("addExtraBtn").addEventListener("click", addExtraEngineer);

/* --------------------------------------------
   ADD EXTRA ENGINEERS
---------------------------------------------*/
function addExtraEngineer(){
  const id = nextExtraId++;
  extraEngineers.push({ id, name:`Engineer ${id}`, rate:20 });

  renderExtraEngineers();
  renderTable();
  recalcAll();
}

function renderExtraEngineers(){
  const box = document.getElementById("extra-engineer-list");
  box.innerHTML = "";

  extraEngineers.forEach(e=>{
    const div = document.createElement("div");
    div.className = "extra-engineer";
    div.innerHTML = `
      <label>Name:</label>
      <input type="text" value="${e.name}" onchange="updateExtraName(${e.id}, this.value)">
      <label>Rate (£):</label>
      <input type="number" value="${e.rate}" step="0.5" onchange="updateExtraRate(${e.id}, this.value)">
      <button onclick="removeExtraEngineer(${e.id})" style="background:#b91c1c;color:#fff;margin-left:6px;">Remove</button>
    `;
    box.appendChild(div);
  });
}

window.updateExtraName = function(id, val){
  const ex = extraEngineers.find(x=>x.id===id);
  if(ex){ ex.name = val; renderTable(); recalcAll(); }
}

window.updateExtraRate = function(id, val){
  const ex = extraEngineers.find(x=>x.id===id);
  if(ex){ ex.rate = Number(val); renderTable(); recalcAll(); }
}

window.removeExtraEngineer = function(id){
  extraEngineers = extraEngineers.filter(x=>x.id !== id);
  renderExtraEngineers();
  renderTable();
  recalcAll();
}

/* --------------------------------------------
   BUILD PLAN
---------------------------------------------*/
function buildPlan(){
  const name = document.getElementById("projectName").value.trim();
  const startStr = document.getElementById("startDate").value;
  const endStr   = document.getElementById("endDate").value;
  const totalHours = Number(document.getElementById("totalHours").value);

  if(!name || !startStr || !endStr || !totalHours){
    alert("Complete all fields.");
    return;
  }

  const start = new Date(startStr);
  const end   = new Date(endStr);
  if(end < start){
    alert("End cannot be before start.");
    return;
  }

  const days = [];
  let d = new Date(start);
  while(d <= end){
    days.push({ dateISO:d.toISOString().slice(0,10) });
    d.setDate(d.getDate()+1);
  }

  projectState = {
    projectName:name,
    startDate:start,
    endDate:end,
    totalHours,
    plannedPerDay: totalHours / days.length,
    days,
    metrics:{}
  };

  renderTable();
  recalcAll();
  saveBtn.disabled = false;
}

/* --------------------------------------------
   RENDER TABLE
---------------------------------------------*/
function renderTable(){
  if(projectState.days.length === 0){
    tableWrap.style.display = "none";
    return;
  }

  tableWrap.style.display = "block";

  let headHTML = `
    <tr>
      <th rowspan="2">Date</th>
      <th rowspan="2">Planned<br>Hours</th>
  `;

  engineers.forEach(e=>{
    headHTML += `<th colspan="2">${e.name} (£${e.rate})</th>`;
  });

  extraEngineers.forEach(e=>{
    headHTML += `<th colspan="2">${e.name} (£${e.rate})</th>`;
  });

  headHTML += `
      <th rowspan="2">Total<br>Hours</th>
      <th rowspan="2">Cost (£)</th>
    </tr><tr>
  `;

  [...engineers, ...extraEngineers].forEach(()=>{
    headHTML += `<th>Hrs</th><th>Night?</th>`;
  });

  headHTML += `</tr>`;
  tableHead.innerHTML = headHTML;

  planBody.innerHTML = "";

  projectState.days.forEach(day=>{
    const dateISO = day.dateISO;
    const dateObj = new Date(dateISO);
    const pretty = dateObj.toLocaleDateString("en-GB",{weekday:"short", day:"2-digit", month:"2-digit"});

    const tr = document.createElement("tr");
    tr.dataset.date = dateISO;

    tr.innerHTML = `
      <td>${pretty}</td>
      <td class="planned-cell">${projectState.plannedPerDay.toFixed(1)}</td>
    `;

    function addCells(e, prefix, id=null){
      const key = prefix + (id ?? e.key);
      tr.innerHTML += `
        <td><input type="number" step="0.5" min="0" class="hours-input"
              data-eng="${key}" data-rate="${e.rate}"></td>
        <td><label class="night-label">
              <input type="checkbox" class="night-checkbox" data-eng="${key}">
              Night
            </label></td>
      `;
    }

    engineers.forEach(e=> addCells(e,"main_"));
    extraEngineers.forEach(e=> addCells(e,"extra_",e.id));

    tr.innerHTML += `
      <td class="day-total-hours">0.0</td>
      <td class="day-cost">0.00</td>
    `;

    planBody.appendChild(tr);
  });
}

/* --------------------------------------------
   COST LOGIC
---------------------------------------------*/
function calcCost(hours, rate, isWeekend, isNight){
  if(hours <= 0) return { normal:0, ot:0, cost:0 };

  if(isWeekend || isNight){
    return { normal:0, ot:hours, cost:hours*rate*1.5 };
  }

  if(hours > 10){
    return {
      normal:10,
      ot:hours-10,
      cost:(10*rate) + ((hours-10)*rate*1.5)
    };
  }

  return { normal:hours, ot:0, cost:hours*rate };
}

/* --------------------------------------------
   RECALCULATE
---------------------------------------------*/
function recalcAll(){
  let cumPlanned = 0, cumActual = 0, cumCost = 0;
  let lastDate = null, activeDays = 0;

  [...planBody.querySelectorAll("tr")].forEach(row=>{
    const dateISO = row.dataset.date;
    const dateObj = new Date(dateISO);
    const isWeekend = (dateObj.getDay()===0 || dateObj.getDay()===6);

    const planned = Number(row.querySelector(".planned-cell").textContent);
    cumPlanned += planned;

    let hrs = 0, cost = 0;

    row.querySelectorAll(".hours-input").forEach(input=>{
      const h = Number(input.value)||0;
      const rate = Number(input.dataset.rate);
      const key = input.dataset.eng;
      const night = row.querySelector(`.night-checkbox[data-eng="${key}"]`).checked;

      const c = calcCost(h, rate, isWeekend, night);
      hrs += h;
      cost += c.cost;
    });

    if(hrs>0){ lastDate = dateObj; activeDays++; }

    cumActual += hrs;
    cumCost   += cost;

    row.querySelector(".day-total-hours").textContent = hrs.toFixed(1);
    row.querySelector(".day-cost").textContent        = cost.toFixed(2);
  });

  let spi = cumActual>0 ? cumActual/cumPlanned : null;
  let status = "No hours yet";
  let css = "";

  if(spi){
    if(spi>1.05){ status="Ahead"; css="status-good"; }
    else if(spi<0.95){ status="Behind"; css="status-bad"; }
    else { status="On track"; css="status-good"; }
  }

  let forecast = "Not enough data";
  if(activeDays>0 && cumActual>0){
    const avg = cumActual/activeDays;
    const remain = Math.max(projectState.totalHours-cumActual,0);

    if(avg>0){
      const daysLeft = Math.ceil(remain/avg);
      const f = new Date(lastDate);
      f.setDate(f.getDate()+daysLeft);

      forecast = f>projectState.endDate
        ? `⚠ Finishes late (${f.toLocaleDateString("en-GB")})`
        : `✔ Expected finish ${f.toLocaleDateString("en-GB")}`;
    }
  }

  summaryEl.style.display="block";
  summaryEl.innerHTML = `
    <div><b>Total Planned:</b> ${projectState.totalHours}h</div>
    <div><b>Actual Hours:</b> ${cumActual.toFixed(1)}h</div>
    <div><b>Total Cost So Far:</b> £${cumCost.toFixed(2)}</div>
    <div><b>SPI:</b> ${spi ? spi.toFixed(2) : "N/A"} <span class="${css}">– ${status}</span></div>
    <div>${forecast}</div>
  `;

  projectState.metrics = { cumPlanned, cumActual, cumCost, spi };
}

/* --------------------------------------------
   SAVE PLAN → WORKER (correct payload)
---------------------------------------------*/
async function savePlan(){
  saveBtn.disabled = true;
  saveStatus.textContent = "Saving…";

  const rows = [...planBody.querySelectorAll("tr")];

  const days = rows.map(row=>{
    const dateISO = row.dataset.date;
    const dateObj = new Date(dateISO);
    const isWeekend = (dateObj.getDay()===0||dateObj.getDay()===6);

    const planned = Number(row.querySelector(".planned-cell").textContent);
    const totalHours = Number(row.querySelector(".day-total-hours").textContent);
    const totalCost  = Number(row.querySelector(".day-cost").textContent);

    const main = {};
    engineers.forEach(e=>{
      const hrs = Number(row.querySelector(`.hours-input[data-eng="main_${e.key}"]`)?.value||0);
      const night = row.querySelector(`.night-checkbox[data-eng="main_${e.key}"]`)?.checked||false;
      const c = calcCost(hrs,e.rate,isWeekend,night);

      main[e.key] = {
        name:e.name,
        rate:e.rate,
        hours:hrs,
        night,
        normalHours:c.normal,
        otHours:c.ot,
        cost:c.cost
      };
    });

    const extra = {};
    extraEngineers.forEach(ex=>{
      const key = `extra_${ex.id}`;
      const hrs = Number(row.querySelector(`.hours-input[data-eng="${key}"]`)?.value||0);
      const night = row.querySelector(`.night-checkbox[data-eng="${key}"]`)?.checked||false;
      const c = calcCost(hrs,ex.rate,isWeekend,night);

      extra[ex.id] = {
        name:ex.name,
        rate:ex.rate,
        hours:hrs,
        night,
        normalHours:c.normal,
        otHours:c.ot,
        cost:c.cost
      };
    });

    return {
      date:dateISO,
      isWeekend,
      planned,
      totalHours,
      totalCost,
      mainEngineers:main,
      extraEngineers:extra
    };
  });

  const payload = {
    projectName: document.getElementById("projectName").value.trim(),
    startDate:   document.getElementById("startDate").value,
    endDate:     document.getElementById("endDate").value,
    days
  };

  if(!payload.projectName){
    saveStatus.textContent = "❌ Project name required";
    saveBtn.disabled = false;
    return;
  }

  try {
    const res = await fetch(API_SAVE_URL, {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body:JSON.stringify(payload)
    });

    const data = await res.json();
    if(!res.ok){
      console.error(data);
      saveStatus.textContent = "❌ Worker rejected request";
    } else {
      saveStatus.textContent = "✅ Saved successfully!";
    }

  } catch(err){
    console.error(err);
    saveStatus.textContent = "❌ Network error";
  }

  saveBtn.disabled = false;
}

saveBtn.addEventListener("click", savePlan);
</script>

</body>
</html>
