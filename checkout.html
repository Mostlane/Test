<!DOCTYPE html>
<html>
<head>
<script src="auth.js"></script>
<title>Check Out</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<link rel="stylesheet" href="style.css" />

<script>
  if (sessionStorage.getItem("mostlaneLoggedIn") !== "true") {
    window.location.href = "login.html";
  }
</script>

<style>
  body.checkout-body {
    font-family: "Segoe UI", sans-serif;
    background: #e6e8eb url('Mostlane_Embossed.png') no-repeat center center fixed;
    background-size: 180%;
    margin: 0;
    padding: 40px 20px;
    min-height: 100vh;
    display: flex;
    flex-direction: column;
    align-items: center;
    text-align: center;
  }

  h1 {
    background-color: rgba(0, 74, 153, 0.6);
    color: white;
    padding: 12px 20px;
    border-radius: 8px;
    font-size: 22px;
    font-weight: bold;
    margin-bottom: 30px;
  }
</style>
</head>

<body class="checkout-body">

<h1>Checking Out...</h1>

<script>
/* ------------------------------------------------------------------------
   Device ID (still stored but NOT validated)
------------------------------------------------------------------------ */
let deviceID = localStorage.getItem("mostlane_device_id");
if (!deviceID) {
  deviceID = "dev-" + Math.random().toString(36).substring(2, 10);
  localStorage.setItem("mostlane_device_id", deviceID);
}

/* ------------------------------------------------------------------------
   Cloudflare Worker + Offline Queue
------------------------------------------------------------------------ */
const WORKER_URL = "https://ckeck-in-out.jamie-def.workers.dev/check";
const PENDING_KEY = "ml_pending_check_events_v1";

function getPendingChecks() {
  try {
    return JSON.parse(localStorage.getItem(PENDING_KEY) || "[]");
  } catch {
    return [];
  }
}

function savePendingChecks(list) {
  localStorage.setItem(PENDING_KEY, JSON.stringify(list));
}

async function sendToWorker(payload) {
  const res = await fetch(WORKER_URL, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(payload)
  });
  if (!res.ok) throw new Error("Worker error");
  return res.json();
}

async function flushPendingChecks() {
  const pending = getPendingChecks();
  if (!pending.length || !navigator.onLine) return;

  const remaining = [];

  for (const ev of pending) {
    try { await sendToWorker(ev); }
    catch { remaining.push(ev); }
  }

  savePendingChecks(remaining);
}

window.addEventListener("load", flushPendingChecks);
window.addEventListener("online", flushPendingChecks);

/* ------------------------------------------------------------------------
   AUTO CHECK-OUT
------------------------------------------------------------------------ */
function startCheckOut() {
  const username = sessionStorage.getItem("mostlaneLoggedInUser") || "Unknown";

  navigator.geolocation.getCurrentPosition(async pos => {

    const lat = pos.coords.latitude;
    const lon = pos.coords.longitude;
    const datetime = new Date().toISOString();

    const payload = {
      type: "checkout",
      username,
      deviceID,
      datetime,
      lat,
      lon,
      fuelClaim: null,
      offlineEvent: !navigator.onLine
    };

    // OFFLINE → Queue event
    if (!navigator.onLine) {
      const pending = getPendingChecks();
      pending.push(payload);
      savePendingChecks(pending);

      window.location.href =
        `confirm.html?status=Check%20Out&lat=${lat}&lon=${lon}&time=${encodeURIComponent(new Date().toLocaleString())}`;
      return;
    }

    // ONLINE → Send to Worker
    try { await sendToWorker(payload); }
    catch {
      payload.offlineEvent = true;
      const pending = getPendingChecks();
      pending.push(payload);
      savePendingChecks(pending);
    }

    const now = new Date().toLocaleString();
    window.location.href =
      `confirm.html?status=Check%20Out&lat=${lat}&lon=${lon}&time=${encodeURIComponent(now)}`;

  }, err => {
    alert("Please enable location to check out.\n" + err.message);
  }, { enableHighAccuracy: true, timeout: 20000 });
}

window.onload = startCheckOut;
</script>

</body>
</html>
