<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>All Sites</title>
  <style>
    body {
      font-family: 'Segoe UI', Arial, sans-serif;
      background: #e6e8eb url('Mostlane_Embossed.png') no-repeat center center fixed;
      background-size: cover;
      margin: 0;
      color: #333;
    }
    .container {
      max-width: 960px;
      margin: 24px auto;
      background: rgba(255,255,255,0.9);
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      padding: 20px;
    }
    h1 {
      text-align: center;
      color: #004a99;
      margin: 6px 0 16px 0;
    }
    .controls {
      display: flex;
      flex-direction: column;
      gap: 12px;
      margin-bottom: 16px;
    }
    #search {
      width: 100%;
      padding: 10px;
      font-size: 16px;
      border: 1px solid #ccc;
      border-radius: 6px;
    }
    .filters {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 12px 18px;
    }
    .filters label {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      white-space: nowrap; /* keep checkbox next to its text */
      font-size: 15px;
      cursor: pointer;
    }
    .site-list {
      max-height: 60vh;
      overflow-y: auto;
    }
    .site-card {
      background: #f4f6f8;
      padding: 14px;
      margin-bottom: 12px;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.50);
    }
    .site-card p {
      margin: 4px 0;
    }
    .muted { color: #666; }
  </style>
</head>
<body>
  <div class="container">
    <h1>All Sites</h1>

    <div class="controls">
      <input id="search" type="text" placeholder="Search by job number, name, type, address, mileage, drive time…">
      <div class="filters" id="filters">
        <label><input type="checkbox" class="filter" value="Retail">Retail</label>
        <label><input type="checkbox" class="filter" value="ELS">ELS</label>
        <label><input type="checkbox" class="filter" value="COBRA">COBRA</label>
        <label><input type="checkbox" class="filter" value="Wenzel’s">Wenzel’s</label>
        <label><input type="checkbox" class="filter" value="Site">Site</label>
      </div>
    </div>

    <div class="site-list" id="siteList"></div>
  </div>

  <script>
    const GITHUB_BASE = 'https://raw.githubusercontent.com/Mostlane/Test/main/';
    const SITES_URL = GITHUB_BASE + 'sites.json';
    const EMPLOYMENT_URL = GITHUB_BASE + 'employment.txt';
    const ROLE_URL = GITHUB_BASE + 'role-type.txt';

    function currency(n) {
      return '£' + Number(n).toFixed(2);
    }

    function calcSubbieDailyFuel(mileage) {
      const m = Number(mileage);
      if (isNaN(m)) return '';
      const result = (m * 2 - 20) * 0.25;
      return result > 0 ? currency(result) : 'Within 10 mile radius';
    }

    function calcMostlaneFuel(mileage) {
      const m = Number(mileage);
      if (isNaN(m)) return '';
      return currency(m * 2 * 0.25);
    }

    async function fetchJSON(url) {
      const res = await fetch(url + '?v=' + Date.now());
      if (!res.ok) throw new Error('Failed to fetch ' + url);
      return res.json();
    }

    async function fetchText(url) {
      const res = await fetch(url + '?v=' + Date.now());
      if (!res.ok) throw new Error('Failed to fetch ' + url);
      return res.text();
    }

    function parseEmployment(txt) {
      // Lines like: "Jamie.Line - Employed"
      const map = {};
      txt.split(/\r?\n/).forEach(line => {
        const clean = line.trim();
        if (!clean) return;
        const parts = clean.split('-');
        if (parts.length >= 2) {
          const user = parts[0].trim();            // e.g., "Jamie.Line"
          const type = parts[1].trim();            // e.g., "Employed" or "SelfEmployed"
          map[user] = type;
        }
      });
      return map;
    }

    function isAdminOrOffice(roleTxt, username) {
      // Treat lines containing the username and containing "Admin" or "Office" as having admin-like permissions.
      const lines = roleTxt.split(/\r?\n/);
      for (const line of lines) {
        if (line.includes(username) && (/(Admin|Office)/i).test(line)) {
          return true;
        }
      }
      return false;
    }

    function renderSites(sites, vis) {
      const list = document.getElementById('siteList');
      list.innerHTML = '';
      if (!sites || !sites.length) {
        list.innerHTML = '<p class="muted">No sites found.</p>';
        return;
      }
      for (const site of sites) {
        const card = document.createElement('div');
        card.className = 'site-card';
        const jobNumber = site.jobNumber ?? 'N/A';
        const siteName = site.siteName ?? '';
        const siteType = site.siteType ?? '';
        const address = site.address ?? '';
        const lat = (site.lat ?? '').toString();
        const lon = (site.lon ?? '').toString();
        const mileage = site.mileage ?? '';
        const driveTime = site.driveTime ?? '';

        let subbieHTML = '';
        if (vis.showSubbie) {
          subbieHTML = `<p><strong>Sub-Contractor Daily Fuel:</strong> ${calcSubbieDailyFuel(mileage)}</p>`;
        }

        let mostlaneHTML = '';
        if (vis.showMostlane) {
          mostlaneHTML = `<p><strong>Mostlane Fuel:</strong> ${calcMostlaneFuel(mileage)}</p>`;
        }

        card.innerHTML = `
          <p><strong>Job Number:</strong> ${jobNumber}</p>
          <p><strong>Site Name:</strong> ${siteName}</p>
          <p><strong>Site Type:</strong> ${siteType}</p>
          <p><strong>Address:</strong> ${address}</p>
          <p><strong>Lat:</strong> ${lat}</p>
          <p><strong>Lon:</strong> ${lon}</p>
          <p><strong>Mileage:</strong> ${mileage !== '' ? mileage + ' miles' : ''}</p>
          <p><strong>Drive Time:</strong> ${driveTime}</p>
          ${subbieHTML}
          ${mostlaneHTML}
        `;
        list.appendChild(card);
      }
    }

    function filterAndSearch(allSites, vis) {
      const q = document.getElementById('search').value.trim().toLowerCase();
      const activeTypes = Array.from(document.querySelectorAll('.filter:checked')).map(x => x.value);
      const out = allSites.filter(site => {
        const hay = [
          site.jobNumber, site.siteName, site.siteType,
          site.address, site.lat, site.lon, site.mileage, site.driveTime
        ].map(v => (v ?? '').toString().toLowerCase()).join(' | ');

        const matchesText = hay.includes(q);
        const matchesType = activeTypes.length === 0 || (site.siteType && activeTypes.includes(site.siteType));
        return matchesText && matchesType;
      });
      renderSites(out, vis);
    }

    (async () => {
      try {
        const username = sessionStorage.getItem('mostlaneUser') || '';
        // Load data
        const [sites, employmentTxt, roleTxt] = await Promise.all([
          fetchJSON(SITES_URL),
          fetchText(EMPLOYMENT_URL),
          fetchText(ROLE_URL)
        ]);

        // Determine employment and admin/office
        const empMap = parseEmployment(employmentTxt);
        const employmentType = empMap[username] || 'Employed'; // default to Employed
        const adminLike = isAdminOrOffice(roleTxt, username);   // Admin or Office

        // Visibility rules per your spec:
        // - Admin/Office: see BOTH
        // - Employed (field): see NEITHER
        // - SelfEmployed (field): see ONLY Sub-Contractor Daily Fuel
        const visibility = {
          showSubbie: adminLike || employmentType === 'SelfEmployed',
          showMostlane: adminLike
        };

        // Initial render + wire up UI
        window._allSites = sites;
        window._visibility = visibility;
        renderSites(sites, visibility);

        document.getElementById('search').addEventListener('input', () => {
          filterAndSearch(window._allSites, window._visibility);
        });
        document.getElementById('filters').addEventListener('change', () => {
          filterAndSearch(window._allSites, window._visibility);
        });
      } catch (e) {
        document.getElementById('siteList').innerHTML = '<p class="muted">Unable to load sites at this time.</p>';
      }
    })();
  </script>
</body>
</html>
