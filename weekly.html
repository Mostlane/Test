<!DOCTYPE html>
<html lang="en">
<head>
<script src="auth.js"></script>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Weekly Summary</title>
<link rel="stylesheet" href="style.css"/>

<style>
  body {
    font-family: "Segoe UI", sans-serif;
    background: #e6e8eb url('Mostlane_Embossed.png') no-repeat center center fixed;
    background-size: 180%;
    margin: 0;
    padding: 0;
  }
  .content-box {
    background: rgba(255,255,255,0.6);
    margin: 60px auto;
    padding: 20px;
    max-width: 900px;
    border-radius: 10px;
  }
  .header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    background-color: #004a99;
    color: white;
    padding: 10px 20px;
    border-radius: 6px;
  }
  .arrow {
    font-size: 20px;
    cursor: pointer;
    user-select: none;
  }
  .week-range {
    font-size: 18px;
    font-weight: bold;
  }
  .activity {
    background: white;
    border-left: 5px solid #004a99;
    padding: 10px;
    margin-top: 10px;
    border-radius: 6px;
  }
  .mileage {
    color: #004a99;
    font-style: italic;
    margin-top: 5px;
  }
  .portal-btn {
    background-color: #004a99;
    color: #fff;
    padding: 10px 20px;
    border-radius: 6px;
    text-decoration: none;
    font-weight: bold;
    font-size: 16px;
    border: none;
    cursor: pointer;
  }
</style>
</head>

<body>

<div style="display:flex;justify-content:center;gap:15px;margin-bottom:20px;">
  <a class="portal-btn" href="main.html">Main Menu</a>
  <span id="actionButtons"></span>
</div>

<div class="content-box">
  <div class="header">
    <div class="arrow" onclick="changeWeek(-1)">←</div>
    <div class="week-range" id="weekRange">Loading…</div>
    <div class="arrow" onclick="changeWeek(1)">→</div>
  </div>
  <div id="activityLog"></div>
</div>

<script>
let user = sessionStorage.getItem("mostlaneUser") || "admin";
let offset = 0;
let dataStore = [];
let sites = [];

const RATE = 0.25;
const FREE_MILES = 10;

/* --------------------------------------------------
   HELPERS
-------------------------------------------------- */
function getOrdinal(n) {
  const s=["th","st","nd","rd"],v=n%100;
  return s[(v-20)%10]||s[v]||s[0];
}

function getWeekRange(baseDate){
  const monday=new Date(baseDate);
  monday.setDate(monday.getDate()-((monday.getDay()+6)%7)+offset*7);
  const sunday=new Date(monday);
  sunday.setDate(monday.getDate()+6);
  sunday.setHours(23,59,59,999);

  const fmt=d=>{
    const day=d.getDate();
    return `${day}${getOrdinal(day)} ${d.toLocaleDateString("en-GB",{month:"short"})}${String(d.getFullYear()).slice(-2)}`;
  };

  return {start:monday,end:sunday,label:`${fmt(monday)} – ${fmt(sunday)}`};
}

function changeWeek(delta){
  offset+=delta;
  loadWeek();
}

function haversine(lat1,lon1,lat2,lon2){
  const R=6371000;
  const toRad=d=>d*Math.PI/180;
  const dLat=toRad(lat2-lat1);
  const dLon=toRad(lon2-lon1);
  const a=Math.sin(dLat/2)**2+
    Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)**2;
  return R*2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
}

/* --------------------------------------------------
   LOAD EVENTS FROM WORKER (FIXED)
-------------------------------------------------- */
async function loadEventsForMonth(range){
  const ym = range.start.toISOString().slice(0,7);

  const res = await fetch(
    `https://ckeck-in-out.jamie-def.workers.dev/events?user=${encodeURIComponent(user)}&month=${ym}`
  );
  if(!res.ok) throw new Error("Failed to load events");

  const events = await res.json();

  // NORMALISE EVENT TYPES
  return events.map(e=>({
    ...e,
    type: e.type==="checkin" ? "check in"
         : e.type==="checkout" ? "check out"
         : e.type
  }));
}

/* --------------------------------------------------
   LOAD WEEK
-------------------------------------------------- */
async function loadWeek(){
  const range=getWeekRange(new Date());
  document.getElementById("weekRange").textContent=range.label;

  dataStore = await loadEventsForMonth(range);

  const filtered=dataStore.filter(log=>{
    const d=new Date(log.datetime);
    return d>=range.start && d<=range.end;
  });

  const container=document.getElementById("activityLog");
  container.innerHTML="";

  for(const log of filtered){
    const div=document.createElement("div");
    div.className="activity";

    const d=new Date(log.datetime);
    const dateStr=`${d.toLocaleDateString("en-GB",{weekday:"short"})} ${d.getDate()}${getOrdinal(d.getDate())} ${d.getHours().toString().padStart(2,"0")}:${d.getMinutes().toString().padStart(2,"0")}`;

    let location="";
    if(log.location_coords){
      const {lat,lon}=log.location_coords;
      location=`<a href="https://maps.google.com/?q=${lat},${lon}" target="_blank">View location</a>`;
    }

    div.innerHTML=`<strong>${log.type.toUpperCase()}</strong><br>${dateStr}<br>${location}`;
    container.appendChild(div);
  }

  if(!filtered.length){
    container.innerHTML="<p>No activity this week.</p>";
  }
}

/* --------------------------------------------------
   INIT
-------------------------------------------------- */
fetch("https://raw.githubusercontent.com/Mostlane/Test/main/sites.json")
  .then(r=>r.json())
  .then(siteData=>{
    sites=siteData;
    loadWeek();
  })
  .catch(err=>{
    document.getElementById("activityLog").innerHTML="<p style='color:red'>Failed to load data</p>";
    console.error(err);
  });
</script>

<footer style="text-align:center;font-size:11px;color:#999;margin-top:40px;">
Weekly Summary • Mostlane Portal © 2025
</footer>

</body>
</html>
