
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Weekly Summary</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    body {
      font-family: "Segoe UI", sans-serif;
      background: #e6e8eb url('Mostlane_Embossed.png') no-repeat center center fixed;
      background-size: 180%;
      margin: 0;
      padding: 0;
    }
    .button-container {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 10px;
      margin-bottom: 20px;
    }
    .portal-btn {
      background-color: #004a99;
      color: #fff;
      padding: 10px 16px;
      border-radius: 6px;
      text-decoration: none;
      font-weight: bold;
      font-size: 14px;
      border: none;
      cursor: pointer;
      white-space: nowrap;
    }
    .portal-btn:hover {
      background-color: #003366;
    }
  </style>
</head>
<body>

<div class="button-container">
  <a href="main.html" class="portal-btn">Main Menu</a>
  <span id="actionButtons"></span>
</div>

<!-- Mileage Claim Popup -->
<div id="mileagePopup" style="display:none; position:fixed; top:20%; left:50%; transform:translateX(-50%);
 background:#fff; border:1px solid #ccc; padding:20px; border-radius:10px; z-index:1000; max-width:300px; box-shadow:0 0 10px rgba(0,0,0,0.2);">
  <h3>Select Days</h3>
  <label><input type="checkbox" value="All" checked> All Week</label><br>
  <label><input type="checkbox" value="Mon"> Monday</label><br>
  <label><input type="checkbox" value="Tue"> Tuesday</label><br>
  <label><input type="checkbox" value="Wed"> Wednesday</label><br>
  <label><input type="checkbox" value="Thu"> Thursday</label><br>
  <label><input type="checkbox" value="Fri"> Friday</label><br>
  <label><input type="checkbox" value="Sat"> Saturday</label><br>
  <label><input type="checkbox" value="Sun"> Sunday</label><br><br>
  <button onclick="processMileage()">Calculate</button>
  <button onclick="document.getElementById('mileagePopup').style.display='none'">Cancel</button>
</div>

<!-- Result Display -->
<div id="mileageResult" style="margin:20px; font-weight:bold; text-align:center;"></div>

<script>
let dataStore = {};

function showMileagePopup() {
  document.getElementById("mileagePopup").style.display = "block";
}

async function eligibleForMileage(user) {
  const [emp, travel] = await Promise.all([
    fetch("https://raw.githubusercontent.com/Mostlane/Test/main/employment.txt").then(r => r.text()),
    fetch("https://raw.githubusercontent.com/Mostlane/Test/main/travel-time.txt").then(r => r.text())
  ]);
  return (
    emp.includes(user + " - SelfEmployed") &&
    travel.includes(user + " - No")
  );
}

async function showCorrectButton() {
  const user = sessionStorage.getItem("mostlaneUser") || "admin";
  const container = document.getElementById("actionButtons");
  const empTxt = await fetch("https://raw.githubusercontent.com/Mostlane/Test/main/employment.txt").then(r => r.text());
  const type = empTxt.includes(`${user} - SelfEmployed`) ? 'SelfEmployed' : 'Employed';
  const eligibleMileage = await eligibleForMileage(user);
  let html = '';

  if (type === 'SelfEmployed') {
    html += '<button onclick="createInvoice()" class="portal-btn">Create Invoice</button>';
  } else {
    html += '<button onclick="createTimesheet()" class="portal-btn">Create Timesheet</button>';
  }

  if (eligibleMileage) {
    html += '<button onclick="showMileagePopup()" class="portal-btn">Calculate Mileage</button>';
  }

  container.innerHTML = html;
}

function processMileage() {
  const selected = Array.from(document.querySelectorAll('#mileagePopup input[type=checkbox]:checked')).map(cb => cb.value);
  const days = ["Mon", "Tue", "Wed", "Thu", "Fri", "Sat", "Sun"];
  const filterDays = selected.includes("All") ? days : selected;

  const user = sessionStorage.getItem("mostlaneUser") || "admin";
  const logs = dataStore[user] || [];
  let totalMiles = 0;

  for (const log of logs) {
    if (!log.datetime || !log.miles) continue;
    const d = new Date(log.datetime);
    const day = d.toLocaleDateString('en-GB', { weekday: 'short' });
    if (!filterDays.includes(day)) continue;

    const trip = parseFloat(log.miles || 0);
    const chargeable = Math.max(0, trip - 10);
    totalMiles += chargeable;
  }

  const reimbursed = (totalMiles * 0.25).toFixed(2);
  document.getElementById("mileagePopup").style.display = "none";
  document.getElementById("mileageResult").innerText =
    `Paid Miles: ${totalMiles.toFixed(1)} mi | Reimbursement: £${reimbursed}`;
}

showCorrectButton();
</script>


<script>
async function calculateMileageSummary() {
  const user = sessionStorage.getItem("mostlaneUser") || "Unknown";
  const [logData, usersTxt, travelTxt, employmentTxt] = await Promise.all([
    fetch("https://raw.githubusercontent.com/Mostlane/Test/main/logs/activity-log.json").then(r => r.json()),
    fetch("https://raw.githubusercontent.com/Mostlane/Test/main/Users.txt").then(r => r.text()),
    fetch("https://raw.githubusercontent.com/Mostlane/Test/main/travel-time.txt").then(r => r.text()),
    fetch("https://raw.githubusercontent.com/Mostlane/Test/main/employment.txt").then(r => r.text())
  ]);

  const eligible = employmentTxt.includes(user + " - SelfEmployed") && travelTxt.includes(user + " - No");
  if (!eligible) return;

  const line = usersTxt.split("\n").find(l => l.startsWith(user + "|"));
  const homePostcode = line ? line.split("|").pop().trim() : "PO15 5RQ";
  const logs = logData[user] || [];

  const service = new google.maps.DistanceMatrixService();
  let totalMiles = 0;

  const requests = logs.map(log => {
    if (!log.location_coords) return Promise.resolve(0);
    const dest = log.location_coords;
    return new Promise(resolve => {
      service.getDistanceMatrix({
        origins: [homePostcode],
        destinations: [{ lat: dest.lat, lng: dest.lon }],
        travelMode: google.maps.TravelMode.DRIVING
      }, (res, status) => {
        if (status !== "OK") return resolve(0);
        const miles = res.rows[0].elements[0].distance.value / 1609.34;
        resolve(Math.max(0, miles - 10));
      });
    });
  });

  const results = await Promise.all(requests);
  totalMiles = results.reduce((a, b) => a + b, 0);
  const cost = totalMiles * 0.25;

  const div = document.createElement("p");
  div.innerHTML = `<strong>Paid Miles:</strong> ${totalMiles.toFixed(1)} mi | <strong>Reimbursement:</strong> £${cost.toFixed(2)}`;
  document.querySelector(".content-box").appendChild(div);
}

window.addEventListener("load", () => {
  if (typeof google !== "undefined") {
    calculateMileageSummary();
  }
});
</script>
<script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAGqOm3qfyYqOx7WXhMzyNZ7kcKNlcWgQM"></script>

</body>
</html>
