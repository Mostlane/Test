<!DOCTYPE html>
<html lang="en">
<head>
<script src="auth.js"></script>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>Weekly Summary</title>
<link href="style.css" rel="stylesheet"/>

<style>
/* UNCHANGED STYLES */
body {
  font-family: "Segoe UI", sans-serif;
  background: #e6e8eb url('Mostlane_Embossed.png') no-repeat center center fixed;
  background-size: 180%;
  margin: 0;
  padding: 0;
}
.content-box {
  background: rgba(255,255,255,0.6);
  margin: 60px auto;
  padding: 20px;
  max-width: 900px;
  border-radius: 10px;
}
.header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  background-color: #004a99;
  color: white;
  padding: 10px 20px;
  border-radius: 6px;
}
.arrow { font-size: 20px; cursor: pointer; user-select: none; }
.week-range { font-size: 18px; font-weight: bold; }
.activity {
  background: white;
  border-left: 5px solid #004a99;
  padding: 10px;
  margin-top: 10px;
  border-radius: 6px;
}
.mileage { color: #004a99; font-style: italic; margin-top: 5px; }
.portal-btn {
  background-color: #004a99;
  color: #fff;
  padding: 10px 20px;
  border-radius: 6px;
  text-decoration: none;
  font-weight: bold;
  font-size: 16px;
  border: none;
  cursor: pointer;
}
.portal-btn:hover { background-color: #003366; }
.unknown { color: red; font-weight: bold; }
</style>
</head>

<body>

<div style="display:flex;justify-content:center;gap:15px;margin-bottom:20px;">
  <a class="portal-btn" href="main.html">Main Menu</a>
  <span id="actionButtons"></span>
</div>

<div class="content-box">
  <div class="header">
    <div class="arrow" onclick="changeWeek(-1)">←</div>
    <div class="week-range" id="weekRange">Loading…</div>
    <div class="arrow" onclick="changeWeek(1)">→</div>
  </div>
  <div id="activityLog"></div>
</div>

<script>
/* ------------------------------------------------------------------
   CORE STATE
------------------------------------------------------------------ */
let user = sessionStorage.getItem("mostlaneUser") || "admin";
let offset = 0;
let dataStore = [];
const RATE = 0.25;
const FREE_MILES = 10;

/* ------------------------------------------------------------------
   DATE HELPERS (UNCHANGED)
------------------------------------------------------------------ */
function getOrdinal(n){
  const s=["th","st","nd","rd"],v=n%100;
  return s[(v-20)%10]||s[v]||s[0];
}

function getWeekRange(date){
  const monday=new Date(date);
  monday.setDate(monday.getDate()-((monday.getDay()+6)%7)+offset*7);
  const sunday=new Date(monday);
  sunday.setDate(monday.getDate()+6);
  sunday.setHours(23,59,59,999);

  const format=d=>{
    const day=d.getDate();
    const suffix=getOrdinal(day);
    const month=d.toLocaleDateString("en-UK",{month:"short"});
    const year=String(d.getFullYear()).slice(-2);
    return `${day}${suffix} ${month}${year}`;
  };

  return {start:monday,end:sunday,label:`${format(monday)} – ${format(sunday)}`};
}

function changeWeek(delta){ offset+=delta; loadWeek(); }

/* ------------------------------------------------------------------
   FETCH EVENTS FROM CHECK-IN WORKER (NEW)
------------------------------------------------------------------ */
async function loadEventsForMonth(){
  const d=new Date();
  d.setMonth(d.getMonth()+offset);
  const ym=d.toISOString().slice(0,7);

  const res=await fetch(
    `https://ckeck-in-out.jamie-def.workers.dev/events?user=${encodeURIComponent(user)}&month=${ym}`
  );
  if(!res.ok) throw new Error("Failed to load events");
  return res.json();
}

/* ------------------------------------------------------------------
   FUEL ELIGIBILITY (UNCHANGED)
------------------------------------------------------------------ */
async function eligibleForFuel(username){
  const [employment,role,travel]=await Promise.all([
    fetch("https://raw.githubusercontent.com/Mostlane/Test/main/employment.txt").then(r=>r.text()),
    fetch("https://raw.githubusercontent.com/Mostlane/Test/main/role-type.txt").then(r=>r.text()),
    fetch("https://raw.githubusercontent.com/Mostlane/Test/main/travel-time.txt").then(r=>r.text())
  ]);
  return (
    employment.includes(`${username} - SelfEmployed`) &&
    role.includes(`${username} - Field`) &&
    travel.includes(`${username} - No`)
  );
}

/* ------------------------------------------------------------------
   MAIN RENDER
------------------------------------------------------------------ */
async function loadWeek(){
  const range=getWeekRange(new Date());
  document.getElementById("weekRange").textContent=range.label;

  dataStore=await loadEventsForMonth();

  const filtered=dataStore.filter(log=>{
    const d=new Date(log.datetime);
    return d>=range.start && d<=range.end;
  });

  const container=document.getElementById("activityLog");
  container.innerHTML="";
  const fuelOK=await eligibleForFuel(user);

  for(const log of filtered){
    const div=document.createElement("div");
    div.className="activity";

    const d=new Date(log.datetime);
    const day=d.toLocaleDateString("en-GB",{weekday:"short"});
    const date=d.getDate();
    const suffix=getOrdinal(date);
    const hour=String(d.getHours()).padStart(2,"0");
    const min=String(d.getMinutes()).padStart(2,"0");

    let locationHTML="";
    if(log.recognised && log.matchedSite){
      locationHTML=`<strong>Location:</strong> ${log.matchedSite.siteName}`;
      if(fuelOK && log.matchedSite.mileageFromHQ!=null){
        locationHTML+=`
          <br><span class="mileage">
          Distance from office: ${log.matchedSite.mileageFromHQ.toFixed(1)} miles
          </span>
          <br>
          <label>
            <input type="checkbox" class="claim-mileage"
                   data-miles="${log.matchedSite.mileageFromHQ}">
            Claim mileage for this trip
          </label>`;
      }
    } else if(log.lat && log.lon){
      locationHTML=`<span class="unknown">
        Location not known –
        <a target="_blank" href="https://maps.google.com/?q=${log.lat},${log.lon}">View map</a>
      </span>`;
    }

    div.innerHTML=`
      <strong>${log.type.toUpperCase()}</strong><br>
      ${day} ${date}${suffix} ${hour}:${min}<br>
      ${locationHTML}
    `;
    container.appendChild(div);
  }

  if(!filtered.length){
    container.innerHTML="<p>No activity this week.</p>";
  }
}

/* ------------------------------------------------------------------
   INITIAL LOAD
------------------------------------------------------------------ */
loadWeek();
</script>

</body>
</html>
