<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Weekly Summary</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    body {
      font-family: "Segoe UI", sans-serif;
      background: #e6e8eb url('Mostlane_Embossed.png') no-repeat center center fixed;
      background-size: 180%;
      margin: 0;
      padding: 0;
    }
    .content-box {
      background: rgba(255,255,255,0.6);
      margin: 60px auto;
      padding: 20px;
      max-width: 900px;
      border-radius: 10px;
    }
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background-color: #004a99;
      color: white;
      padding: 10px 20px;
      border-radius: 6px;
    }
    .arrow {
      font-size: 20px;
      cursor: pointer;
      user-select: none;
    }
    .week-range {
      font-size: 18px;
      font-weight: bold;
    }
    .activity {
      background: white;
      border-left: 5px solid #004a99;
      padding: 10px;
      margin-top: 10px;
      border-radius: 6px;
    }
  </style>
</head>
<body>

<div style="display: flex; justify-content: center; gap: 15px; margin-bottom: 20px;">
  <a href="main.html" class="portal-btn">Main Menu</a>
  <button onclick="createTimesheet()" class="portal-btn">Create Invoice</button>
</div>
<style>
  .portal-btn {
    background-color: #004a99;
    color: #fff;
    padding: 10px 20px;
    border-radius: 6px;
    text-decoration: none;
    font-weight: bold;
    font-size: 16px;
    border: none;
    cursor: pointer;
  }
  .portal-btn:hover {
    background-color: #003366;
  }
</style>
<script>
function createTimesheet() {
  alert("Invoice creation logic will go here.");
}
</script>

  <div class="content-box">
    <div class="header">
      <div class="arrow" onclick="changeWeek(-1)">←</div>
      <div class="week-range" id="weekRange">Loading…</div>
      <div class="arrow" onclick="changeWeek(1)">→</div>
    </div>
    <div id="activityLog"></div>
  </div>

  <script>
    let user = sessionStorage.getItem("mostlaneUser") || "admin";
    let offset = 0;
    let dataStore = null;

    function getOrdinal(n) {
      const s = ["th", "st", "nd", "rd"], v = n % 100;
      return s[(v - 20) % 10] || s[v] || s[0];
    }

    function getWeekRange(date) {
      const monday = new Date(date);
      monday.setDate(monday.getDate() - ((monday.getDay() + 6) % 7) + offset * 7);
      const friday = new Date(monday);
      friday.setDate(monday.getDate() + 6);
      friday.setHours(23, 59, 59, 999); // include all of Friday

      const format = d => {
        const day = d.getDate();
        const suffix = getOrdinal(day);
        const month = d.toLocaleDateString("en-UK", { month: 'short' });
        const year = String(d.getFullYear()).slice(-2);
        return `${day}${suffix} ${month}${year}`;
      };

      return { start: monday, end: friday, label: `${format(monday)} – ${format(friday)}` };
    }

    function changeWeek(delta) {
      offset += delta;
      loadWeek();
    }

    function loadWeek() {
      const range = getWeekRange(new Date());
      document.getElementById("weekRange").textContent = range.label;

      const logs = dataStore[user] || [];
      const filtered = logs.filter(log => {
        const d = new Date(log.datetime);
        return d >= range.start && d <= range.end;
      });

      const container = document.getElementById("activityLog");
      container.innerHTML = "";
      filtered.forEach(log => {
        const div = document.createElement("div");
        div.className = "activity";
        
const d = new Date(log.datetime);
const day = d.toLocaleDateString('en-GB', { weekday: 'short' });
const date = d.getDate();
const suffix = getOrdinal(date);
const hour = d.getHours().toString().padStart(2, '0');
const minute = d.getMinutes().toString().padStart(2, '0');
const formatted = `${day} ${date}${suffix} ${hour}:${minute}`;

let locationDisplay = "";
if (log.location) {
  const lat = log.location.match(/Latitude:\s*([^L]+)/i);
  const lon = log.location.match(/Longitude:\s*([^\s]+)/i);
  if (lat) locationDisplay += `Latitude: ${lat[1]}<br>`;
  if (lon) locationDisplay += `Longitude: ${lon[1]}`;
}

div.innerHTML = `<strong>${log.type.toUpperCase()}</strong><br>${formatted}<br>${locationDisplay || log.reference || log.description || ""}`;

        container.appendChild(div);
      });

      summarizeWeeklyHours(filtered);

      if (filtered.length === 0) {
        container.innerHTML = "<p>No activity this week.</p>";
      }
    }

    fetch("https://raw.githubusercontent.com/Mostlane/Test/main/logs/activity-log.json")
      .then(response => response.json())
      .then(json => {
        dataStore = json;
        loadWeek();
      })
      .catch(error => {
        document.getElementById("weekRange").textContent = "Error loading data";
        document.getElementById("activityLog").innerHTML = "<p style='color:red;'>Could not load activity log.</p>";
        console.error("Fetch error:", error);
      });
  

</script>

<script>
function formatTime(minutes) {
  const hrs = Math.floor(minutes / 60);
  const mins = minutes % 60;
  return `${hrs} Hours, ${mins} Mins`;
}

function summarizeWeeklyHours(logs) {
  const dailyMinutes = {};

  logs.forEach(log => {
    if (!log.datetime || !log.type) return;
    const dayKey = new Date(log.datetime).toISOString().split("T")[0];
    if (!dailyMinutes[dayKey]) dailyMinutes[dayKey] = [];
    dailyMinutes[dayKey].push({ type: log.type.toLowerCase(), time: new Date(log.datetime) });
  });

  let totalStandard = 0;
  let totalOvertime = 0;

  for (const day in dailyMinutes) {
    const dayLogs = dailyMinutes[day];
    const checkIns = dayLogs.filter(e => e.type === "check in").sort((a, b) => a.time - b.time);
    const checkOuts = dayLogs.filter(e => e.type === "check out").sort((a, b) => b.time - a.time);
    if (checkIns.length && checkOuts.length) {
      const workedMins = Math.floor((checkOuts[0].time - checkIns[0].time) / 60000);
      const standard = Math.min(600, workedMins);
      const overtime = Math.max(0, workedMins - 600);
      totalStandard += standard;
      totalOvertime += overtime;
    }
  }

  const summary = document.createElement("div");
  summary.style.marginTop = "20px";
  summary.style.padding = "10px";
  summary.style.borderTop = "2px solid #004a99";
  summary.innerHTML = `
    <strong>Total standard rate hours:</strong> ${formatTime(totalStandard)}<br>
    <strong>Total overtime rate hours:</strong> ${formatTime(totalOvertime)}
  `;
  document.getElementById("activityLog").appendChild(summary);
}
</script>


<script>
function renderLogsGroupedByDay(logs) {
  const logContainer = document.getElementById("activityLog");
  logContainer.innerHTML = ""; // clear existing

  const days = {};

  logs.forEach(entry => {
    if (!entry.datetime) return;
    const date = new Date(entry.datetime);
    const dayKey = date.toISOString().split("T")[0];
    if (!days[dayKey]) days[dayKey] = [];
    days[dayKey].push({ ...entry, parsed: date });
  });

  const sortedDays = Object.keys(days).sort();

  sortedDays.forEach(day => {
    const header = document.createElement("h3");
    const dateObj = new Date(day);
    const weekday = dateObj.toLocaleDateString("en-GB", { weekday: "long", day: "numeric", month: "short" });
    header.textContent = weekday;
    header.style.marginTop = "20px";
    header.style.color = "#004a99";
    logContainer.appendChild(header);

    days[day]
      .sort((a, b) => a.parsed - b.parsed)
      .forEach(log => {
        const div = document.createElement("div");
        div.className = "log-entry";
        const d = log.parsed;
        const time = d.getHours().toString().padStart(2, '0') + ":" + d.getMinutes().toString().padStart(2, '0');

        const lat = log.location?.match(/Latitude:\s*([^L]+)/i);
        const lon = log.location?.match(/Longitude:\s*([^\s]+)/i);

        let locationDisplay = "";
        if (lat) locationDisplay += `Latitude: ${lat[1].trim()}<br>`;
        if (lon) locationDisplay += `Longitude: ${lon[1].trim()}`;

        div.innerHTML = `
          <strong>${log.type?.toUpperCase() || "UNKNOWN"}</strong><br>
          ${time}<br>
          ${locationDisplay || ""}<br>
          ${log.distance ? "Distance: " + log.distance + "<br>" : ""}
          ${log.duration ? "Duration: " + log.duration + "<br>" : ""}
          ${log.paidMileage ? "Paid Mileage: " + log.paidMileage : ""}
        `;
        logContainer.appendChild(div);
      });
  });
}
</script>

</body>
</html>
