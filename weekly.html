<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Weekly Summary</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    body {
      font-family: "Segoe UI", sans-serif;
      background: #e6e8eb url('Mostlane_Embossed.png') no-repeat center center fixed;
      background-size: 180%;
      margin: 0;
      padding: 0;
    }
    .content-box {
      background: rgba(255,255,255,0.6);
      margin: 60px auto;
      padding: 20px;
      max-width: 900px;
      border-radius: 10px;
    }
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background-color: #004a99;
      color: white;
      padding: 10px 20px;
      border-radius: 6px;
    }
    .arrow {
      font-size: 20px;
      cursor: pointer;
      user-select: none;
    }
    .week-range {
      font-size: 18px;
      font-weight: bold;
    }
    .activity {
      background: white;
      border-left: 5px solid #004a99;
      padding: 10px;
      margin-top: 10px;
      border-radius: 6px;
    }
  </style>
</head>
<body>
  <div class="content-box">
    <div class="header">
      <div class="arrow" onclick="changeWeek(-1)">←</div>
      <div class="week-range" id="weekRange">Loading…</div>
      <div class="arrow" onclick="changeWeek(1)">→</div>
    </div>
    <div id="activityLog"></div>
  </div>

  <script>
    let user = sessionStorage.getItem("mostlaneUser") || "admin";
    let offset = 0;
    let dataStore = null;

    function getOrdinal(n) {
      const s = ["th", "st", "nd", "rd"], v = n % 100;
      return s[(v - 20) % 10] || s[v] || s[0];
    }

    function getWeekRange(date) {
      const monday = new Date(date);
      monday.setDate(monday.getDate() - ((monday.getDay() + 6) % 7) + offset * 7);
      const friday = new Date(monday);
      friday.setDate(monday.getDate() + 6);
      friday.setHours(23, 59, 59, 999); // include all of Friday

      const format = d => {
        const day = d.getDate();
        const suffix = getOrdinal(day);
        const month = d.toLocaleDateString("en-UK", { month: 'short' });
        const year = String(d.getFullYear()).slice(-2);
        return `${day}${suffix} ${month}${year}`;
      };

      return { start: monday, end: friday, label: `${format(monday)} – ${format(friday)}` };
    }

    function changeWeek(delta) {
      offset += delta;
      loadWeek();
    }

    function loadWeek() {
      const range = getWeekRange(new Date());
      document.getElementById("weekRange").textContent = range.label;

      const logs = dataStore[user] || [];
      const filtered = logs.filter(log => {
        const d = new Date(log.datetime);
        return d >= range.start && d <= range.end;
      });

      const container = document.getElementById("activityLog");
      container.innerHTML = "";
      filtered.forEach(log => {
        const div = document.createElement("div");
        div.className = "activity";
        
const d = new Date(log.datetime);
const day = d.toLocaleDateString('en-GB', { weekday: 'short' });
const date = d.getDate();
const suffix = getOrdinal(date);
const hour = d.getHours().toString().padStart(2, '0');
const minute = d.getMinutes().toString().padStart(2, '0');
const formatted = `${day} ${date}${suffix} ${hour}:${minute}`;

let locationDisplay = "";
if (log.location) {
  const lat = log.location.match(/Latitude:\s*([^L]+)/i);
  const lon = log.location.match(/Longitude:\s*([^\s]+)/i);
  if (lat) locationDisplay += `Latitude: ${lat[1]}<br>`;
  if (lon) locationDisplay += `Longitude: ${lon[1]}`;
}

div.innerHTML = `<strong>${log.type.toUpperCase()}</strong><br>${formatted}<br>${locationDisplay || log.reference || log.description || ""}`;

        container.appendChild(div);
      });

      summarizeWeeklyHours(filtered);
appendFinancialSummary(user, totalStandard, totalOvertime);

      if (filtered.length === 0) {
        container.innerHTML = "<p>No activity this week.</p>";
      }
    }

    fetch("https://raw.githubusercontent.com/Mostlane/Test/main/logs/activity-log.json")
      .then(response => response.json())
      .then(json => {
        dataStore = json;
        loadWeek();
      })
      .catch(error => {
        document.getElementById("weekRange").textContent = "Error loading data";
        document.getElementById("activityLog").innerHTML = "<p style='color:red;'>Could not load activity log.</p>";
        console.error("Fetch error:", error);
      });
  





// --- Financial Summary Injection ---
async function appendFinancialSummary(user, totalStandard, totalOvertime) {
  try {
    const [rates, employment, roleType] = await Promise.all([
      fetch('https://raw.githubusercontent.com/Mostlane/Test/main/logs/rates.txt').then(r => r.text()),
      fetch('https://raw.githubusercontent.com/Mostlane/Test/main/employment.txt').then(r => r.text()),
      fetch('https://raw.githubusercontent.com/Mostlane/Test/main/role-type.txt').then(r => r.text())
    ]);

    const rateLine = rates.split('\n').find(l => l.includes(user)) || "";
    const rate = parseFloat(rateLine.split('£')[1]) || 0;
    const employmentType = (employment.split('\n').find(l => l.includes(user)) || "").split(' - ')[1] || "SelfEmployed";
    const role = (roleType.split('\n').find(l => l.includes(user)) || "").split(' - ')[1] || "Field";

    const stdHours = (totalStandard / 60).toFixed(2);
    const otHours = (totalOvertime / 60).toFixed(2);
    const stdPay = (stdHours * rate).toFixed(2);
    const otPay = (otHours * rate * 1.5).toFixed(2);

    // Use Google Maps values if calculated earlier
    let paidMileage = window._paidMiles || 0;
    let mileagePay = (paidMileage * 0.25).toFixed(2);
    let total = (parseFloat(stdPay) + parseFloat(otPay) + parseFloat(mileagePay)).toFixed(2);

    const fin = document.createElement("div");
    fin.style.marginTop = "20px";
    fin.style.padding = "10px";
    fin.style.borderTop = "2px solid #004a99";
    fin.innerHTML = \`
      <h3>\${employmentType === "SelfEmployed" ? "Invoice Summary" : "Weekly Timesheet Summary"}</h3>
      <strong>Standard Hours:</strong> \${stdHours} hrs – £\${stdPay}<br>
      <strong>Overtime Hours:</strong> \${otHours} hrs – £\${otPay}<br>
      <strong>Paid Mileage:</strong> £\${mileagePay} (\${paidMileage.toFixed(1)} miles)<br>
      <strong>Total Weekly Pay:</strong> <strong>£\${total}</strong>
    \`;

    document.getElementById("activityLog").appendChild(fin);
  } catch (err) {
    document.getElementById("activityLog").innerHTML += "<p style='color:red;'>Error loading financial data. Please check log formatting or connection.</p>";
    console.error("Finance summary error:", err);
  }
}

  } catch (err) {
    document.getElementById("activityLog").innerHTML += "<p style='color:red;'>Error loading financial data. Please check log formatting or connection.</p>";
    console.error("Finance summary error:", err);
  }
}

}

}

</script>

<script>
function formatTime(minutes) {
  const hrs = Math.floor(minutes / 60);
  const mins = minutes % 60;
  return `${hrs} Hours, ${mins} Mins`;
}

function summarizeWeeklyHours(logs) {
  const dailyMinutes = {};

  logs.forEach(log => {
    if (!log.datetime || !log.type) return;
    const dayKey = new Date(log.datetime).toISOString().split("T")[0];
    if (!dailyMinutes[dayKey]) dailyMinutes[dayKey] = [];
    dailyMinutes[dayKey].push({ type: log.type.toLowerCase(), time: new Date(log.datetime) });
  });

  let totalStandard = 0;
  let totalOvertime = 0;

  for (const day in dailyMinutes) {
    const dayLogs = dailyMinutes[day];
    const checkIns = dayLogs.filter(e => e.type === "check in").sort((a, b) => a.time - b.time);
    const checkOuts = dayLogs.filter(e => e.type === "check out").sort((a, b) => b.time - a.time);
    if (checkIns.length && checkOuts.length) {
      const workedMins = Math.floor((checkOuts[0].time - checkIns[0].time) / 60000);
      const standard = Math.min(600, workedMins);
      const overtime = Math.max(0, workedMins - 600);
      totalStandard += standard;
      totalOvertime += overtime;
    }
  }

  const summary = document.createElement("div");
  summary.style.marginTop = "20px";
  summary.style.padding = "10px";
  summary.style.borderTop = "2px solid #004a99";
  summary.innerHTML = `
    <strong>Total standard rate hours:</strong> ${formatTime(totalStandard)}<br>
    <strong>Total overtime rate hours:</strong> ${formatTime(totalOvertime)}
  `;
  document.getElementById("activityLog").appendChild(summary);
}
</script>

</body>
</html>
