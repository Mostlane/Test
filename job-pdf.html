<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Generate Job PDF</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body{
  font-family: Arial, Helvetica, sans-serif;
  background:#f3f4f6;
  padding:20px;
}
.loading{
  font-size:14px;
  color:#334155;
}
</style>
</head>
<body>

<div class="loading" id="status">Preparing job document…</div>

<script>
/* ===============================
   CONFIG
================================ */
const SLA_API = "https://mostlane-sla.jamie-def.workers.dev";

/* ===============================
   HELPERS
================================ */
const qs = new URLSearchParams(window.location.search);
const jobId = qs.get("id");
const type = qs.get("type") || "client";

if(!jobId){
  document.getElementById("status").textContent = "Missing job ID";
  throw new Error("Missing job ID");
}

function esc(str){
  return (str || "").toString()
    .replace(/&/g,"&amp;")
    .replace(/</g,"&lt;")
    .replace(/>/g,"&gt;");
}

function fmt(dt){
  if(!dt) return "—";
  const d = new Date(dt);
  return isNaN(d) ? "—" : d.toLocaleString("en-GB");
}

/* ===============================
   LOAD ALL DATA
================================ */
async function loadAll(){
  const jobRes = await fetch(`${SLA_API}/jobs/${jobId}`);
  if(!jobRes.ok) throw new Error("Failed to load job");

  const job = await jobRes.json();

  const photosRes = await fetch(`${SLA_API}/jobs/${jobId}/files`);
  const photos = photosRes.ok ? await photosRes.json() : [];

  const sigRes = await fetch(`${SLA_API}/jobs/${jobId}/signature`);
  const signature = sigRes.ok ? await sigRes.json() : null;

  return { job, photos, signature };
}

/* ===============================
   BUILD HTML DOCUMENT
================================ */
function buildHtml({ job, photos, signature }){
  const timeline = (job.history || []).map(h => `
    <tr>
      <td>${fmt(h.at)}</td>
      <td>${esc(h.user || "System")}</td>
      <td>${esc(h.note || "")}</td>
    </tr>
  `).join("");

  const images = photos.map(p => `
    <div style="margin-bottom:10px;">
      <img src="${p.url}" style="width:100%;border:1px solid #ccc;">
      <div style="font-size:11px;color:#475569;">${esc(p.name || "")}</div>
    </div>
  `).join("");

  const signatureHtml = signature?.image
    ? `<img src="${signature.image}" style="max-width:300px;border-top:1px solid #000;margin-top:10px;">`
    : "<em>No signature captured</em>";

  return `
<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<style>
body{font-family:Arial,Helvetica,sans-serif;font-size:13px;color:#0f172a;}
h1{font-size:20px;margin-bottom:5px;}
h2{font-size:16px;margin-top:25px;border-bottom:2px solid #e5e7eb;padding-bottom:4px;}
table{width:100%;border-collapse:collapse;margin-top:8px;}
td,th{border:1px solid #e5e7eb;padding:6px;vertical-align:top;}
th{background:#f1f5f9;text-align:left;}
.small{font-size:11px;color:#475569;}
</style>
</head>

<body>

<h1>Job Sheet – ${esc(job.reference)}</h1>
<div class="small">Generated: ${fmt(new Date())}</div>

<h2>Job Details</h2>
<table>
<tr><th>Reference</th><td>${esc(job.reference)}</td></tr>
<tr><th>Status</th><td>${esc(job.status)}</td></tr>
<tr><th>Priority</th><td>${esc(job.priority)}</td></tr>
<tr><th>Engineer</th><td>${esc(job.engineer || "Unassigned")}</td></tr>
<tr><th>Site</th><td>${esc(job.site)}</td></tr>
<tr><th>Description</th><td>${esc(job.description)}</td></tr>
<tr><th>Raised</th><td>${fmt(job.raisedAt)}</td></tr>
<tr><th>SLA Target</th><td>${fmt(job.slaTarget)}</td></tr>
</table>

<h2>Photos</h2>
${images || "<em>No photos uploaded</em>"}

<h2>Work History</h2>
<table>
<tr><th>Date</th><th>User</th><th>Note</th></tr>
${timeline || "<tr><td colspan='3'>No history entries</td></tr>"}
</table>

<h2>Signature</h2>
${signatureHtml}

</body>
</html>
`;
}

/* ===============================
   SEND TO WORKER & DOWNLOAD
================================ */
async function generatePdf(){
  const data = await loadAll();
  const html = buildHtml(data);

  document.getElementById("status").textContent = "Generating PDF…";

  const res = await fetch(`${SLA_API}/pdf`, {
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify({
      html,
      filename: `Job-${data.job.reference}-${type}.pdf`
    })
  });

  if(!res.ok){
    throw new Error("Failed to generate job pdf");
  }

  const blob = await res.blob();
  const url = URL.createObjectURL(blob);

  const a = document.createElement("a");
  a.href = url;
  a.download = `Job-${data.job.reference}-${type}.pdf`;
  document.body.appendChild(a);
  a.click();
  a.remove();

  URL.revokeObjectURL(url);

  document.getElementById("status").textContent = "Download complete";
}

/* ===============================
   START
================================ */
generatePdf().catch(err => {
  console.error(err);
  document.getElementById("status").textContent = "❌ Failed to generate job PDF";
});
</script>

</body>
</html>
