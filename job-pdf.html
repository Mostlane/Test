<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Generating Job PDF…</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
body{
  font-family:Arial,Helvetica,sans-serif;
  background:#f3f4f6;
  margin:0;
  padding:0;
}
#status{
  padding:40px;
  text-align:center;
  font-size:14px;
  color:#374151;
}
</style>
</head>
<body>

<div id="status">Preparing job document…</div>

<script>
/* ===============================
   CONFIG
================================ */
const SLA_API = "https://mostlane-sla.jamie-def.workers.dev";

/* ===============================
   HELPERS
================================ */
const $ = id => document.getElementById(id);

function qs(name){
  return new URLSearchParams(window.location.search).get(name);
}

function fmtDate(d){
  if(!d) return "—";
  const dt = new Date(d);
  if(isNaN(dt)) return "—";
  return dt.toLocaleString("en-GB", {
    day:"2-digit", month:"short", year:"numeric",
    hour:"2-digit", minute:"2-digit"
  });
}

/* ===============================
   MAIN
================================ */
(async function(){
  const jobId = qs("id");
  const type  = qs("type") || "client";

  if(!jobId){
    $("status").textContent = "❌ Missing job ID.";
    return;
  }

  try{
    $("status").textContent = "Loading job data…";

    /* ---------- LOAD JOB ---------- */
    const jobRes = await fetch(`${SLA_API}/jobs/${encodeURIComponent(jobId)}`);
    if(!jobRes.ok) throw new Error("Job not found");
    const job = await jobRes.json();

    /* ---------- LOAD FILES (PHOTOS) ---------- */
    let photos = [];
    try{
      const fileRes = await fetch(`${SLA_API}/jobs/${encodeURIComponent(jobId)}/files`);
      if(fileRes.ok){
        const fileJson = await fileRes.json();
        photos = Array.isArray(fileJson.files)
          ? fileJson.files.map(f => f.publicURL)
          : [];
      }
    }catch{}

    /* ---------- BUILD PDF HTML ---------- */
    const html = `
<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<style>
body{
  font-family:Arial,Helvetica,sans-serif;
  font-size:12px;
  color:#111827;
  margin:30px;
}
h1{
  font-size:18px;
  margin-bottom:4px;
}
h2{
  font-size:14px;
  margin-top:20px;
  border-bottom:1px solid #d1d5db;
  padding-bottom:4px;
}
.small{font-size:11px;color:#4b5563}
.section{margin-bottom:14px}
.grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.label{font-size:10px;color:#6b7280;text-transform:uppercase}
.value{font-size:12px}
.timeline-item{
  border-left:2px solid #1e66ff;
  padding-left:8px;
  margin-bottom:8px;
}
.photos{
  display:grid;
  grid-template-columns:repeat(3,1fr);
  gap:6px;
}
.photos img{
  width:100%;
  height:140px;
  object-fit:cover;
  border:1px solid #d1d5db;
}
.signature img{
  width:220px;
  border:1px solid #d1d5db;
}
.footer{
  position:fixed;
  bottom:20px;
  left:30px;
  right:30px;
  font-size:10px;
  color:#6b7280;
  text-align:center;
}
</style>
</head>
<body>

<h1>${type === "client" ? "Job Completion Sheet" : "Internal Job Sheet"}</h1>
<div class="small">Reference: ${job.helpdeskRef || job.reference || job.id}</div>

<div class="section grid">
  <div>
    <div class="label">Site</div>
    <div class="value">${job.siteName || job.site || "—"}</div>
  </div>
  <div>
    <div class="label">Engineer</div>
    <div class="value">${job.assignedTo || "—"}</div>
  </div>
  <div>
    <div class="label">Status</div>
    <div class="value">${job.status || "—"}</div>
  </div>
  <div>
    <div class="label">SLA Target</div>
    <div class="value">${fmtDate(job.targetAt)}</div>
  </div>
</div>

<h2>Description</h2>
<div class="section">${job.description || "—"}</div>

<h2>Timeline</h2>
<div class="section">
  ${(job.history || []).map(e => `
    <div class="timeline-item">
      <div class="small">${fmtDate(e.at)} – ${e.by || ""}</div>
      <div>${e.note || e.status || ""}</div>
    </div>
  `).join("") || "No history recorded."}
</div>

${photos.length ? `
<h2>Photos</h2>
<div class="photos">
  ${photos.map(p => `<img src="${p}">`).join("")}
</div>
` : ""}

${job.signature ? `
<h2>Customer Sign-Off</h2>
<div class="section signature">
  <div class="small">Signed by ${job.signature.signedBy} on ${fmtDate(job.signature.signedAt)}</div>
  <img src="${job.signature.signatureBase64}">
</div>
` : ""}

<div class="footer">
  ${type === "client" ? "Mostlane Construction Ltd" : "Internal document – not for client use"}
</div>

</body>
</html>
`;

    /* ---------- REQUEST PDF DOWNLOAD ---------- */
    $("status").textContent = "Generating PDF…";

    const pdfRes = await fetch(`${SLA_API}/pdf`, {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({
        html,
        filename: `Job-${job.helpdeskRef || job.id}.pdf`
      })
    });

    if(!pdfRes.ok) throw new Error("PDF generation failed");

    const blob = await pdfRes.blob();
    const url = URL.createObjectURL(blob);

    const a = document.createElement("a");
    a.href = url;
    a.download = `Job-${job.helpdeskRef || job.id}.pdf`;
    document.body.appendChild(a);
    a.click();
    a.remove();

    URL.revokeObjectURL(url);

    $("status").textContent = "✅ Download started.";
  }
  catch(err){
    console.error(err);
    $("status").textContent = "❌ Failed to generate job PDF.";
  }
})();
</script>
</body>
</html>
