<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Job Sheet</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
:root{
  --ml-blue:#003b82;
  --ml-grey:#6b7280;
  --ok:#16a34a;
  --bad:#dc2626;
  --border:#e5e7eb;
}

*{box-sizing:border-box}

body{
  font-family: "Segoe UI", system-ui, Arial, sans-serif;
  margin:0;
  padding:24px;
  background:#fff;
  color:#111827;
}

.header{
  display:flex;
  align-items:center;
  justify-content:space-between;
  border-bottom:2px solid var(--border);
  padding-bottom:12px;
  margin-bottom:18px;
}

.logo{
  height:34px;
}

.h-meta{
  text-align:right;
  font-size:12px;
  color:var(--ml-grey);
}

.section{
  margin-bottom:22px;
}

.section h2{
  margin:0 0 10px;
  font-size:15px;
  color:var(--ml-blue);
  border-bottom:1px solid var(--border);
  padding-bottom:4px;
}

.grid{
  display:grid;
  grid-template-columns:repeat(2,1fr);
  gap:8px 18px;
  font-size:13px;
}

.label{
  color:var(--ml-grey);
  font-size:12px;
}

.value{
  font-weight:600;
}

.sla-ok{color:var(--ok);font-weight:600}
.sla-bad{color:var(--bad);font-weight:600}

/* ---- PHOTOS (FIXED) ---- */
.photos{
  display:grid;
  grid-template-columns:repeat(auto-fill,minmax(120px,1fr));
  gap:8px;
}

.photo{
  position:relative;
  width:100%;
  aspect-ratio:4 / 3;
  overflow:hidden;
  border-radius:6px;
  border:1px solid var(--border);
  background:#f3f4f6;
}

.photo img{
  width:100%;
  height:100%;
  object-fit:cover;
  display:block;
}

.notes{
  font-size:13px;
}

.note{
  padding:8px;
  border-left:3px solid var(--ml-blue);
  background:#f9fafb;
  margin-bottom:6px;
}

.signature{
  display:flex;
  gap:14px;
  align-items:center;
}

.signature img{
  max-height:80px;
  border:1px solid var(--border);
}

/* ---- TIMELINE ---- */
.timeline{
  position:relative;
  margin-left:10px;
}

.timeline::before{
  content:"";
  position:absolute;
  left:4px;
  top:0;
  bottom:0;
  width:2px;
  background:#e5e7eb;
}

.tl-item{
  position:relative;
  padding-left:18px;
  margin-bottom:10px;
  font-size:12px;
}

.tl-dot{
  position:absolute;
  left:0;
  top:3px;
  width:10px;
  height:10px;
  border-radius:50%;
  background:var(--ml-blue);
}

.tl-time{
  color:var(--ml-grey);
  font-size:11px;
}

.footer{
  margin-top:30px;
  font-size:11px;
  color:var(--ml-grey);
  text-align:center;
}
</style>
</head>
<body>

<div class="header">
  <img src="Mostlane Logo.jpg" class="logo" alt="Mostlane">
  <div class="h-meta" id="headerMeta"></div>
</div>

<div class="section">
  <h2>Job Details</h2>
  <div class="grid" id="jobDetails"></div>
</div>

<div class="section">
  <h2>SLA</h2>
  <div id="slaBlock"></div>
</div>

<div class="section">
  <h2>Timeline</h2>
  <div class="timeline" id="timeline"></div>
</div>

<div class="section">
  <h2>Notes</h2>
  <div class="notes" id="notes"></div>
</div>

<div class="section">
  <h2>Photos</h2>
  <div class="photos" id="photos"></div>
</div>

<div class="section">
  <h2>Customer Sign-Off</h2>
  <div class="signature" id="signature"></div>
</div>

<div class="footer">
  Generated by Mostlane Portal
</div>

<script>
const API = "https://mostlane-sla.jamie-def.workers.dev";

const params = new URLSearchParams(location.search);
const jobId = params.get("id");

function cleanName(n){
  return (n||"").replace(/\./g," ");
}

async function load(){
  const job = await fetch(`${API}/jobs/${jobId}`).then(r=>r.json());
  const files = await fetch(`${API}/jobs/${jobId}/files`).then(r=>r.json());

  document.getElementById("headerMeta").innerHTML =
    `Ref: <strong>${job.helpdeskRef}</strong><br>${new Date().toLocaleString()}`;

  document.getElementById("jobDetails").innerHTML = `
    <div><span class="label">Site</span><div class="value">${job.site || "-"}</div></div>
    <div><span class="label">Engineer</span><div class="value">${cleanName(job.assignedTo)}</div></div>
    <div><span class="label">Priority</span><div class="value">${job.priority}</div></div>
    <div><span class="label">Status</span><div class="value">${job.status}</div></div>
  `;

  const slaMet = job.sla?.state !== "BREACHED";
  document.getElementById("slaBlock").innerHTML = `
    Target: ${new Date(job.targetAt).toLocaleString()} —
    <span class="${slaMet?"sla-ok":"sla-bad"}">
      ${slaMet?"✔ SLA Met":"✖ SLA Breached"}
    </span>
  `;

  document.getElementById("timeline").innerHTML =
    (job.statusHistory||[]).map(e=>`
      <div class="tl-item">
        <div class="tl-dot"></div>
        <div><strong>${e.status}</strong></div>
        <div class="tl-time">${new Date(e.at).toLocaleString()} — ${cleanName(e.by)}</div>
      </div>
    `).join("");

  document.getElementById("notes").innerHTML =
    (job.events||[]).map(n=>`
      <div class="note">
        <strong>${cleanName(n.by)}</strong> — ${new Date(n.at).toLocaleString()}<br>
        ${n.note}
      </div>
    `).join("") || "<em>No notes</em>";

  document.getElementById("photos").innerHTML =
    (files.files||[]).map(f=>`
      <div class="photo">
        <img src="${f.publicURL}">
      </div>
    `).join("") || "—";

  if(job.signature){
    document.getElementById("signature").innerHTML = `
      <img src="https://pub-0a9aac7bfc6749bbbdbf9660503968e6.r2.dev/${job.signature.fileKey}">
      <div>
        <strong>${job.signature.signedBy}</strong><br>
        ${new Date(job.signature.signedAt).toLocaleString()}
      </div>
    `;
  }else{
    document.getElementById("signature").innerHTML = "<em>Not signed</em>";
  }

  setTimeout(() => {
    const blob = new Blob([document.documentElement.outerHTML], {type:"text/html"});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = `Job-${job.helpdeskRef}.html`;
    a.click();
  }, 800);
}

load();
</script>
</body>
</html>
