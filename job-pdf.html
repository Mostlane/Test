<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Generate Job PDF</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- PDF libs -->
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

<style>
body{
  margin:0;
  font-family:Segoe UI,Roboto,Arial,sans-serif;
  background:#f3f4f6;
}
#pdf{
  width:794px;
  padding:32px;
  background:#fff;
  color:#111827;
}
h1{margin:0;font-size:22px;color:#003b82;}
h2{margin:20px 0 8px;font-size:16px;border-bottom:2px solid #e5e7eb;padding-bottom:4px;}
.small{font-size:12px;color:#4b5563;}
.grid{
  display:grid;
  grid-template-columns:repeat(2,1fr);
  gap:12px;
}
.box{
  border:1px solid #e5e7eb;
  border-radius:8px;
  padding:10px;
  font-size:13px;
}
.timeline{
  border-left:3px solid #003b82;
  padding-left:10px;
}
.timeline-item{
  margin-bottom:10px;
}
.photos{
  display:grid;
  grid-template-columns:repeat(3,1fr);
  gap:8px;
}
.photos img{
  width:100%;
  border-radius:6px;
  border:1px solid #e5e7eb;
}
.signature{
  max-width:260px;
  border:1px solid #e5e7eb;
  border-radius:6px;
}
.footer{
  margin-top:24px;
  font-size:11px;
  color:#6b7280;
  text-align:center;
}
</style>
</head>

<body>
<div id="pdf"></div>

<script>
const SLA_API = "https://mostlane-sla.jamie-def.workers.dev";

const params = new URLSearchParams(location.search);
const jobId = params.get("id");
const type = params.get("type") || "client";

if(!jobId){
  alert("Missing job ID");
  throw new Error("Missing job ID");
}

async function fetchJSON(url){
  const r = await fetch(url);
  if(!r.ok) throw new Error(url + " failed");
  return r.json();
}

function fmt(d){
  if(!d) return "—";
  const x = new Date(d);
  return isNaN(x) ? "—" : x.toLocaleString("en-GB");
}

(async () => {

  // 1️⃣ Load job
  const job = await fetchJSON(`${SLA_API}/jobs/${jobId}`);
  const files = await fetchJSON(`${SLA_API}/jobs/${jobId}/files`);

  // 2️⃣ Build HTML
  const el = document.getElementById("pdf");
  el.innerHTML = `
    <div style="display:flex;justify-content:space-between;align-items:center;">
      <div>
        <h1>Job Sheet</h1>
        <div class="small">${type === "client" ? "Client Copy" : "Mostlane Internal Copy"}</div>
      </div>
      <img src="Mostlane Logo.jpg" style="height:38px;">
    </div>

    <h2>Job Details</h2>
    <div class="grid">
      <div class="box"><strong>Reference</strong><br>${job.helpdeskRef || job.id}</div>
      <div class="box"><strong>Status</strong><br>${job.status}</div>
      <div class="box"><strong>Priority</strong><br>${job.priority}</div>
      <div class="box"><strong>Engineer</strong><br>${job.assignedTo || "—"}</div>
      <div class="box"><strong>Raised</strong><br>${fmt(job.raisedAt)}</div>
      <div class="box"><strong>Scheduled</strong><br>${fmt(job.scheduledAt)}</div>
    </div>

    <div class="box" style="margin-top:12px;">
      <strong>Description</strong><br>${job.description || ""}
    </div>

    <h2>Timeline & Notes</h2>
    <div class="timeline">
      ${(job.statusHistory || []).map(s => `
        <div class="timeline-item">
          <strong>${s.status}</strong><br>
          <span class="small">${fmt(s.at)} – ${s.by || "system"}</span>
        </div>
      `).join("")}

      ${(job.events || []).map(e => `
        <div class="timeline-item">
          <strong>Note</strong><br>
          ${e.note}<br>
          <span class="small">${fmt(e.at)} – ${e.by}</span>
        </div>
      `).join("")}
    </div>

    <h2>Photos</h2>
    <div class="photos">
      ${(files.files || []).map(f => `<img src="${f.publicURL}">`).join("") || "<div class='small'>No photos</div>"}
    </div>

    <h2>Customer Sign-Off</h2>
    ${
      job.signature
        ? `
          <div class="box">
            <strong>Signed by:</strong> ${job.signature.signedBy}<br>
            <strong>Date:</strong> ${fmt(job.signature.signedAt)}<br><br>
            <img class="signature" src="https://pub-0a9aac7bfc6749bbbdbf9660503968e6.r2.dev/${job.signature.fileKey}">
          </div>
        `
        : `<div class="small">No signature recorded</div>`
    }

    <div class="footer">
      Generated ${new Date().toLocaleString("en-GB")} • Mostlane Portal
    </div>
  `;

  // 3️⃣ Render to PDF
  await new Promise(r => setTimeout(r, 400)); // image settle

  const canvas = await html2canvas(el, { scale:2, useCORS:true });
  const img = canvas.toDataURL("image/png");

  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF("p","pt","a4");

  const w = pdf.internal.pageSize.getWidth();
  const h = canvas.height * (w / canvas.width);

  pdf.addImage(img, "PNG", 0, 0, w, h);

  const name =
    `Mostlane-Job-${job.helpdeskRef || job.id}-${type}.pdf`;

  pdf.save(name);

  // 4️⃣ Auto-close
  setTimeout(() => window.close(), 800);

})().catch(err => {
  console.error(err);
  alert("Failed to generate job PDF");
});
</script>
</body>
</html>
