<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Mostlane â€¢ Confirm</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="auth.js"></script>

  <style>
    body.confirmation-body {
      font-family: "Segoe UI", sans-serif;
      background: #e6e8eb url('Mostlane_Embossed.png') no-repeat center center fixed;
      background-size: 180%;
      margin: 0;
      padding: 0;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      text-align: center;
    }

    .content-box {
      background: rgba(255, 255, 255, 0.70);
      padding: 30px 20px;
      width: 90%;
      max-width: 430px;
      border-radius: 14px;
      box-shadow: 0 0 10px rgba(0,0,0,0.08);
    }

    h1 {
      color: #004a99;
      margin-bottom: 10px;
      font-size: 24px;
      font-weight: 700;
    }

    p {
      font-size: 16px;
      color: #1f2937;
      margin: 6px 0;
    }

    .label {
      font-weight: 600;
      color: #004a99;
    }

    .button {
      display: inline-block;
      margin-top: 25px;
      padding: 12px 20px;
      background-color: #004a99;
      color: white;
      text-decoration: none;
      border-radius: 8px;
      font-size: 16px;
      width: 80%;
      max-width: 260px;
    }

    #staticMap {
      margin-top: 16px;
      width: 100%;
      max-width: 390px;
      border-radius: 10px;
      border: 1px solid #ccc;
    }
  </style>
</head>

<body class="confirmation-body">

  <div class="content-box">
    <img src="mostlane-logo.jpg" style="height:60px; margin-bottom:15px;">

    <h1 id="statusText">Success</h1>

    <p><span class="label">Time:</span> <span id="timeText"></span></p>
    <p><span class="label">Latitude:</span> <span id="latText"></span></p>
    <p><span class="label">Longitude:</span> <span id="lonText"></span></p>

    <p><span class="label">Nearest Site:</span> <span id="siteNameText">Loadingâ€¦</span></p>

    <img id="staticMap" src="">

    <a class="button" href="main.html">Return to Main Menu</a>
  </div>


<script>
(async function() {
  const params = new URLSearchParams(window.location.search);

  const status = params.get("status") || "Completed";
  const lat = parseFloat(params.get("lat") || "");
  const lon = parseFloat(params.get("lon") || "");
  const time = params.get("time") || "";

  document.getElementById("statusText").textContent = status;
  document.getElementById("timeText").textContent = time;
  document.getElementById("latText").textContent = lat;
  document.getElementById("lonText").textContent = lon;

  // STATIC MAP
  if (lat && lon) {
    const apiKey = "AIzaSyANo2Q7OehYzHTTgMTxRr5ISamf5IradcM";
    const mapURL =
      "https://maps.googleapis.com/maps/api/staticmap" +
      `?center=${lat},${lon}` +
      `&zoom=17&size=600x400&maptype=roadmap` +
      `&markers=color:red%7C${lat},${lon}` +
      `&key=${apiKey}`;
    document.getElementById("staticMap").src = mapURL;
  }

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // ğŸ” FIND NEAREST SITE WITHIN 100M
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  const siteNameEl = document.getElementById("siteNameText");

  try {
    const res = await fetch("https://mostlane-sites.jamie-def.workers.dev/get-sites?category=all");
    const sites = await res.json();

    let nearest = null;
    let nearestDist = Infinity;

    function distanceMeters(aLat, aLon, bLat, bLon) {
      const R = 6371000; // metres
      const dLat = (bLat - aLat) * Math.PI/180;
      const dLon = (bLon - aLon) * Math.PI/180;
      const sLat = Math.sin(dLat/2);
      const sLon = Math.sin(dLon/2);
      const c = sLat*sLat + Math.cos(aLat*Math.PI/180)*Math.cos(bLat*Math.PI/180)*sLon*sLon;
      return 2 * R * Math.atan2(Math.sqrt(c), Math.sqrt(1-c));
    }

    for (const s of sites) {
      if (!s.lat || !s.lon) continue;

      const d = distanceMeters(lat, lon, s.lat, s.lon);

      if (d < nearestDist) {
        nearestDist = d;
        nearest = s;
      }
    }

    if (nearest && nearestDist <= 100) {
      // Show site number & name in Mostlane style
      const num = nearest.siteNumber ? ` (${nearest.siteNumber})` : "";
      siteNameEl.textContent = `${nearest.siteName}${num}`;
    } else {
      siteNameEl.textContent = "Unrecognised Location";
    }

  } catch (err) {
    console.error("Site matching failed:", err);
    siteNameEl.textContent = "Unavailable";
  }

})();
</script>

</body>
</html>
