<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>Mostlane • SLA Tracker</title>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <script src="auth.js"></script>
  <style>
    :root{
      --ml-blue:#003b82;
      --ml-blue-light:#1e66ff;
      --text:#0f172a;
      --muted:#6b7280;
      --ok:#16a34a;
      --warn:#f97316;
      --bad:#dc2626;
      --panel:rgba(255,255,255,0.9);
    }
    html,body{
      height:100%;margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      color:var(--text);
      background:#e6e8eb url('Mostlane_Embossed.png') no-repeat center center fixed;
      background-size:cover;
    }
    .shell{
      max-width:1200px;
      margin:32px auto;
      padding:0 16px;
    }
    .card{
      background:var(--panel);
      border-radius:14px;
      box-shadow:0 12px 28px rgba(0,0,0,0.12);
      overflow:hidden;
    }
    header{
      display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;
      padding:16px 20px;border-bottom:1px solid #d1d5db;
      background:linear-gradient(90deg,#fff,#f7f9fc);
    }
    header h1{margin:0;font-size:22px;color:var(--ml-blue);}
    .btn{
      border:1px solid #cbd5e1;
      border-radius:999px;
      padding:8px 14px;
      font-size:14px;
      font-weight:600;
      cursor:pointer;
      background:#fff;
      color:var(--text);
    }
    .btn.primary{
      background:var(--ml-blue-light);
      color:#fff;
      border-color:var(--ml-blue-light);
    }
    .btn + .btn{margin-left:8px;}
    .filters{
      padding:12px 20px;
      display:flex;flex-wrap:wrap;gap:10px;align-items:center;
      border-bottom:1px solid #e5e7eb;
    }
    .filters label{
      font-size:13px;color:var(--muted);
    }
    .filters select{
      padding:6px 10px;
      border-radius:999px;
      border:1px solid #cbd5e1;
      font-size:14px;
    }
    table{
      width:100%;
      border-collapse:collapse;
      font-size:14px;
      background:#fff;
    }
    thead{
      background:#f3f4f6;
    }
    th,td{
      padding:10px 12px;
      border-bottom:1px solid #e5e7eb;
      text-align:left;
    }
    tbody tr:hover{
      background:#f9fafb;
      cursor:pointer;
    }
    .status-pill{
      display:inline-flex;
      align-items:center;
      padding:2px 10px;
      border-radius:999px;
      font-size:12px;
      font-weight:600;
    }
    .status-open{background:#eff6ff;color:#1d4ed8;}
    .status-with-eng{background:#ecfdf3;color:#166534;}
    .status-completed{background:#f3f4f6;color:#4b5563;}
    .priority-pill{
      display:inline-flex;
      padding:2px 8px;
      border-radius:999px;
      font-size:12px;
      font-weight:600;
    }
    .p1{background:#fef2f2;color:#b91c1c;}
    .p2{background:#fffbeb;color:#92400e;}
    .p3{background:#ecfeff;color:#0f766e;}
    .p4,.p5{background:#eff6ff;color:#1d4ed8;}
    .sla-badge{
      display:inline-flex;
      align-items:center;
      padding:2px 8px;
      border-radius:999px;
      font-size:12px;
      font-weight:600;
    }
    .sla-ok{background:#ecfdf3;color:#166534;}
    .sla-warn{background:#fffbeb;color:#92400e;}
    .sla-bad{background:#fef2f2;color:#b91c1c;}
    .sla-done{background:#e5e7eb;color:#4b5563;}
    .muted{color:var(--muted);font-size:13px;}
    #statusMsg{padding:10px 20px;color:var(--muted);font-size:13px;}
    @media(max-width:800px){
      header{flex-direction:column;align-items:flex-start;gap:8px;}
      table{font-size:13px;}
      th,td{padding:8px 8px;}
    }
  </style>
</head>
<body>
<div class="shell">
  <div class="card">
    <header>
      <h1>SLA Tracker</h1>
      <div>
        <a href="sla-settings.html" class="btn">⚙ SLA Settings</a>
        <a href="assign-job.html" class="btn primary">＋ Create Job</a>
        <a href="main.html" class="btn">Main Menu</a>
      </div>
    </header>
    <div class="filters">
      <label>Priority
        <select id="priorityFilter">
          <option value="">All</option>
          <option value="P1">P1</option>
          <option value="P2">P2</option>
          <option value="P3">P3</option>
          <option value="P4">P4</option>
          <option value="P5">P5</option>
        </select>
      </label>
      <label>Status
        <select id="statusFilter">
          <option value="">All</option>
          <option value="Open">Open</option>
          <option value="With Engineer">With Engineer</option>
          <option value="Completed">Completed</option>
        </select>
      </label>
      <span class="muted" id="summary"></span>
    </div>
    <div style="overflow-x:auto;">
      <table>
        <thead>
          <tr>
            <th>Ref</th>
            <th>Site</th>
            <th>Priority</th>
            <th>Status</th>
            <th>Raised</th>
            <th>Target</th>
            <th>Remaining</th>
          </tr>
        </thead>
        <tbody id="jobsBody">
          <!-- rows -->
        </tbody>
      </table>
    </div>
    <div id="statusMsg"></div>
  </div>
</div>

<script>
const API_BASE = "https://YOUR_SLA_WORKER_DOMAIN"; // e.g. https://mostlane-sla.jamie-def.workers.dev

let JOBS = [];

function fmtDT(iso){
  if (!iso) return "–";
  const d = new Date(iso);
  if (isNaN(d)) return "–";
  return d.toLocaleString("en-GB", {
    day:"2-digit", month:"short", year:"numeric",
    hour:"2-digit", minute:"2-digit"
  });
}
function fmtRemaining(targetIso, status){
  if (!targetIso) return { text:"–", cls:"sla-done" };
  if (status === "Completed") return { text:"Completed", cls:"sla-done" };

  const now = new Date();
  const t = new Date(targetIso);
  if (isNaN(t)) return { text:"–", cls:"sla-done" };

  const diffMs = t - now;
  const diffMin = Math.round(diffMs / 60000);

  if (diffMin <= 0) {
    const lateMin = Math.abs(diffMin);
    const h = Math.floor(lateMin/60);
    const m = lateMin % 60;
    const txt = h ? `Overdue ${h}h ${m}m` : `Overdue ${m}m`;
    return { text:txt, cls:"sla-bad" };
  }

  const h = Math.floor(diffMin/60);
  const m = diffMin % 60;
  let txt = "";
  if (h) txt += `${h}h `;
  txt += `${m}m`;

  let cls = "sla-ok";
  if (diffMin <= 60*4) cls = "sla-warn"; // < 4h
  return { text:txt, cls };
}

function priorityClass(p){
  p = String(p || "").toUpperCase();
  if (p === "P1") return "p1";
  if (p === "P2") return "p2";
  if (p === "P3") return "p3";
  if (p === "P4") return "p4";
  if (p === "P5") return "p5";
  return "p4";
}
function statusClass(s){
  if (s === "Open") return "status-open";
  if (s === "With Engineer") return "status-with-eng";
  if (s === "Completed") return "status-completed";
  return "status-open";
}

async function loadJobs(){
  document.getElementById("statusMsg").textContent = "Loading jobs…";
  try{
    const res = await fetch(API_BASE + "/sla/jobs");
    const j = await res.json();
    if (!j.ok) throw new Error(j.error || "Error");
    JOBS = j.jobs || [];
    renderJobs();
    document.getElementById("statusMsg").textContent = "";
  }catch(e){
    console.error(e);
    document.getElementById("statusMsg").textContent = "❌ Could not load SLA jobs.";
  }
}

function renderJobs(){
  const body = document.getElementById("jobsBody");
  body.innerHTML = "";

  const pf = document.getElementById("priorityFilter").value;
  const sf = document.getElementById("statusFilter").value;

  const filtered = JOBS.filter(j=>{
    if (pf && j.priority !== pf) return false;
    if (sf && j.status !== sf) return false;
    return true;
  });

  filtered.forEach(job=>{
    const tr = document.createElement("tr");
    tr.onclick = () => {
      window.location.href = "sla-job-view.html?id=" + encodeURIComponent(job.id);
    };

    const rem = fmtRemaining(job.targetDueAt, job.status);
    const priCls = priorityClass(job.priority);
    const statCls = statusClass(job.status);

    tr.innerHTML = `
      <td>${job.id}</td>
      <td>
        <div>${job.siteName || "–"}</div>
        <div class="muted">${job.siteCode || ""}</div>
      </td>
      <td><span class="priority-pill ${priCls}">${job.priority || "–"}</span></td>
      <td><span class="status-pill ${statCls}">${job.status || "Open"}</span></td>
      <td>${fmtDT(job.raisedAt)}</td>
      <td>${fmtDT(job.targetDueAt)}</td>
      <td>
        <span class="sla-badge ${rem.cls}" data-target="${job.targetDueAt}" data-status="${job.status}">
          ${rem.text}
        </span>
      </td>
    `;
    body.appendChild(tr);
  });

  document.getElementById("summary").textContent =
    `${filtered.length} jobs shown (of ${JOBS.length})`;
}

// Live countdown updater
function tickCountdowns(){
  const now = new Date();
  document.querySelectorAll(".sla-badge").forEach(el=>{
    const targetIso = el.getAttribute("data-target");
    const status = el.getAttribute("data-status");
    const res = fmtRemaining(targetIso, status);
    el.textContent = res.text;
    el.className = "sla-badge " + res.cls;
  });
}

document.getElementById("priorityFilter").addEventListener("change", renderJobs);
document.getElementById("statusFilter").addEventListener("change", renderJobs);

loadJobs();
setInterval(tickCountdowns, 1000);
</script>
</body>
</html>
