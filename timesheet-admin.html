<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Timesheet Admin – Weekly</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>

<style>
body{
  margin:0;
  padding:16px;
  font-family:Segoe UI,system-ui,Arial;
  background:#e6e8eb;
}
.shell{
  max-width:1000px;
  margin:auto;
  background:#fff;
  border-radius:14px;
  box-shadow:0 10px 25px rgba(0,0,0,.15);
}
header{
  padding:16px;
  text-align:center;
  border-bottom:1px solid #e5e7eb;
}
header h1{margin:0;color:#003366}
header a{
  display:block;
  margin-top:8px;
  padding:8px;
  background:#1a73e8;
  color:#fff;
  text-decoration:none;
  border-radius:8px;
  font-weight:600;
}
.content{padding:16px}

.controls{
  display:grid;
  gap:10px;
  margin-bottom:16px;
}
.controls select, .controls button{
  padding:10px;
  border-radius:10px;
  border:1px solid #d1d5db;
  font-weight:600;
}

.week-row{
  display:grid;
  grid-template-columns:auto 1fr auto;
  gap:10px;
  align-items:center;
}

.day{
  border:1px solid #e5e7eb;
  border-radius:12px;
  padding:12px;
  margin-bottom:12px;
}
.day h3{margin:0 0 8px 0}

.kv{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(140px,1fr));
  gap:8px;
  font-size:14px;
}

.week-total{
  margin-top:16px;
  padding:12px;
  background:#f8fafc;
  border-radius:12px;
  font-weight:700;
}

.muted{color:#6b7280;font-size:13px}
</style>
</head>

<body>
<div class="shell">
<header>
  <h1>Weekly Timesheet (Admin)</h1>
  <a href="main.html">Main Menu</a>
</header>

<div class="content">

<div class="controls">
  <select id="userSelect">
    <!-- Explicit list for now (matches KV users) -->
    <option value="Jamie.Line">Jamie Line</option>
    <option value="Tanya.Line">Tanya Line</option>
    <option value="Ryan.Diggins">Ryan Diggins</option>
  </select>

  <div class="week-row">
    <button id="prev">◀</button>
    <div id="weekLabel" style="text-align:center;font-weight:700"></div>
    <button id="next">▶</button>
  </div>
</div>

<div id="output"></div>
<div id="status" class="muted">Ready</div>

</div>
</div>

<script>
const WORKER = "https://ckeck-in-out.jamie-def.workers.dev";

let weekStart = startOfWeek(new Date());

function startOfWeek(d){
  d=new Date(d);
  const day=d.getDay()||7;
  d.setDate(d.getDate()-day+1);
  d.setHours(0,0,0,0);
  return d;
}
function iso(d){return d.toISOString().slice(0,10);}
function isoMonth(d){return d.toISOString().slice(0,7);}
function nice(d){
  return d.toLocaleDateString("en-GB",{weekday:"long",day:"numeric",month:"short"});
}

async function load(){
  const user=document.getElementById("userSelect").value;
  const year=weekStart.getFullYear();
  const month=String(weekStart.getMonth()+1).padStart(2,"0");

  document.getElementById("weekLabel").textContent =
    `Week commencing ${iso(weekStart)}`;

  const out=document.getElementById("output");
  out.innerHTML="";
  document.getElementById("status").textContent="Loading…";

  const res=await fetch(
    `${WORKER}/admin/timesheet?user=${encodeURIComponent(user)}&year=${year}&month=${month}`
  );
  const data=await res.json();

  const weekEnd=new Date(weekStart);weekEnd.setDate(weekEnd.getDate()+6);

  const days=(data.days||[]).filter(d=>{
    const dt=new Date(d.date+"T00:00:00");
    return dt>=weekStart && dt<=weekEnd;
  });

  if(!days.length){
    out.innerHTML=`<div class="day"><h3>No check in / outs recorded</h3></div>`;
    document.getElementById("status").textContent="Ready";
    return;
  }

  let tOn=0,tTrav=0,tFuel=0;

  for(const d of days){
    tOn+=d.onsiteHours;
    tTrav+=d.travelHours;
    tFuel+=d.fuelMiles;

    out.innerHTML+=`
      <div class="day">
        <h3>${nice(new Date(d.date+"T00:00:00"))}</h3>
        <div class="kv">
          <span><b>On-site:</b> ${d.onsiteHours.toFixed(2)} h</span>
          <span><b>Travel:</b> ${d.travelHours.toFixed(2)} h</span>
          <span><b>Fuel:</b> ${d.fuelMiles.toFixed(1)} mi</span>
          <span><b>First site:</b> ${d.firstSite||"—"}</span>
          <span><b>Last site:</b> ${d.lastSite||"—"}</span>
        </div>
      </div>`;
  }

  out.innerHTML =
    `<div class="week-total">
      Week totals — On-site ${tOn.toFixed(2)} h | Travel ${tTrav.toFixed(2)} h | Fuel ${tFuel.toFixed(1)} mi
     </div>` + out.innerHTML;

  document.getElementById("status").textContent="Ready";
}

document.getElementById("prev").onclick=()=>{weekStart.setDate(weekStart.getDate()-7);load();};
document.getElementById("next").onclick=()=>{weekStart.setDate(weekStart.getDate()+7);load();};
document.getElementById("userSelect").onchange=load;

load();
</script>
</body>
</html>
