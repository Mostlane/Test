<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Timesheet Admin – Weekly</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>

<style>
:root{
  --ml-blue:#003366;
  --ml-accent:#1a73e8;
  --ml-bg:#e6e8eb;
  --border:#e5e7eb;
  --ok:#15803d;
  --warn:#b91c1c;
  --muted:#6b7280;
}

body{
  margin:0;
  padding:16px;
  font-family:"Segoe UI",system-ui,Roboto,Arial,sans-serif;
  background:var(--ml-bg) url('Mostlane_Embossed.png') no-repeat center center fixed;
  background-size:180% auto;
}

.shell{
  max-width:1000px;
  margin:auto;
  background:rgba(255,255,255,0.95);
  border-radius:16px;
  box-shadow:0 12px 28px rgba(0,0,0,0.12);
  overflow:hidden;
}

header{
  padding:18px;
  text-align:center;
}

header h1{
  margin:0 0 12px 0;
  color:var(--ml-blue);
}

header a{
  display:block;
  margin-top:8px;
  padding:10px;
  border-radius:10px;
  background:var(--ml-accent);
  color:#fff;
  text-decoration:none;
  font-weight:600;
}

.content{padding:18px;}

.controls{
  display:grid;
  gap:10px;
  margin-bottom:16px;
}

.controls select,
.controls button{
  padding:10px;
  border-radius:12px;
  border:1px solid var(--border);
  background:#f8fafc;
  font-weight:600;
}

.week-row{
  display:grid;
  grid-template-columns:1fr auto 1fr;
  gap:10px;
}

.day-card{
  background:#fff;
  border:1px solid #eef2f7;
  border-radius:14px;
  padding:14px;
  margin-bottom:12px;
}

.day-title{
  font-weight:800;
  color:#111827;
  margin-bottom:8px;
}

.kv{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(140px,1fr));
  gap:8px;
  font-size:14px;
}

.kv b{color:#111827;}

.badge-ok{
  color:var(--ok);
  font-weight:700;
}

.badge-warn{
  color:var(--warn);
  font-weight:700;
}

.week-summary{
  margin-top:18px;
  padding:14px;
  border-radius:14px;
  background:#f8fafc;
  border:1px solid var(--border);
  font-weight:700;
}

.note{
  margin-top:12px;
  font-size:13px;
  color:var(--muted);
}
</style>
</head>

<body>
<div class="shell">
  <header>
    <h1>Weekly Timesheet – Admin</h1>
    <a href="main.html">Main Menu</a>
  </header>

  <div class="content">
    <div class="controls">
      <select id="userSelect"></select>

      <div class="week-row">
        <button id="prevWeek">◀ Previous</button>
        <div style="text-align:center;font-weight:700" id="weekLabel">—</div>
        <button id="nextWeek">Next ▶</button>
      </div>
    </div>

    <div id="output"></div>
    <div id="status" class="note">Ready</div>
  </div>
</div>

<script>
const WORKER = "https://ckeck-in-out.jamie-def.workers.dev";

const userSelect = document.getElementById("userSelect");
const output = document.getElementById("output");
const weekLabel = document.getElementById("weekLabel");
const statusEl = document.getElementById("status");

let currentWeek = startOfWeek(new Date());

function startOfWeek(d){
  d=new Date(d);
  const day=d.getDay()||7;
  d.setDate(d.getDate()-day+1);
  d.setHours(0,0,0,0);
  return d;
}

function iso(d){ return d.toISOString().slice(0,10); }
function isoMonth(d){ return d.toISOString().slice(0,7); }

function friendly(d){
  return d.toLocaleDateString("en-GB",{weekday:"long",day:"numeric",month:"short"});
}

async function loadUsers(){
  // simple approach: ask worker for a known month’s users
  const now = new Date();
  const res = await fetch(`${WORKER}/admin/timesheet?user=__list__&year=${now.getFullYear()}&month=${String(now.getMonth()+1).padStart(2,"0")}`);
  const j = await res.json().catch(()=>null);
  if(!j || !j.users){
    userSelect.innerHTML = `<option>Jamie.Line</option>`;
    return;
  }
  userSelect.innerHTML = j.users.map(u=>`<option>${u}</option>`).join("");
}

async function loadWeek(){
  const user = userSelect.value;
  if(!user) return;

  const year = currentWeek.getFullYear();
  const month = String(currentWeek.getMonth()+1).padStart(2,"0");

  weekLabel.textContent = `Week commencing ${iso(currentWeek)}`;
  output.innerHTML = "";
  statusEl.textContent = "Loading…";

  const res = await fetch(`${WORKER}/admin/timesheet?user=${encodeURIComponent(user)}&year=${year}&month=${month}`);
  const data = await res.json();

  if(!data.days || !data.days.length){
    output.innerHTML = `<div class="day-card"><div class="day-title">No check in / outs recorded</div></div>`;
    statusEl.textContent = "Ready";
    return;
  }

  const weekEnd = new Date(currentWeek);
  weekEnd.setDate(weekEnd.getDate()+6);

  let totals = { onsite:0, travel:0, fuel:0 };

  data.days
    .filter(d=>{
      const dt=new Date(d.date+"T00:00:00");
      return dt>=currentWeek && dt<=weekEnd;
    })
    .forEach(d=>{
      totals.onsite += d.onsiteHours||0;
      totals.travel += d.travelHours||0;
      totals.fuel += d.fuelMiles||0;

      output.innerHTML += `
        <div class="day-card">
          <div class="day-title">${friendly(new Date(d.date+"T00:00:00"))}</div>
          <div class="kv">
            <span><b>On-site:</b> ${d.onsiteHours.toFixed(2)} h</span>
            <span><b>Travel:</b> ${d.travelHours.toFixed(2)} h</span>
            <span><b>Fuel:</b> ${d.fuelMiles.toFixed(1)} mi</span>
            <span><b>First site:</b> ${d.firstSite||"—"}</span>
            <span><b>Last site:</b> ${d.lastSite||"—"}</span>
          </div>
        </div>
      `;
    });

  output.innerHTML =
    `<div class="week-summary">
      Week totals — On-site: ${totals.onsite.toFixed(2)} h |
      Travel: ${totals.travel.toFixed(2)} h |
      Fuel: ${totals.fuel.toFixed(1)} mi
     </div>` + output.innerHTML;

  statusEl.textContent = "Ready";
}

document.getElementById("prevWeek").onclick=()=>{
  currentWeek.setDate(currentWeek.getDate()-7);
  loadWeek();
};
document.getElementById("nextWeek").onclick=()=>{
  currentWeek.setDate(currentWeek.getDate()+7);
  loadWeek();
};

userSelect.onchange = loadWeek;

loadUsers().then(loadWeek);
</script>
</body>
</html>
