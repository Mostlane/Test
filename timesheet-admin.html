<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Timesheet Admin – Mostlane</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
:root{
  --ml-blue:#003366;
  --ml-accent:#1a73e8;
  --ml-bg:#e6e8eb;
  --border:#e5e7eb;
}
body{
  margin:0;padding:16px;
  font-family:"Segoe UI",system-ui,Arial;
  background:var(--ml-bg) url('Mostlane_Embossed.png') no-repeat center center fixed;
  background-size:180% auto;
}
.shell{
  max-width:1000px;margin:auto;
  background:rgba(255,255,255,.96);
  border-radius:16px;
  box-shadow:0 12px 28px rgba(0,0,0,.12);
}
header{padding:18px;text-align:center}
header h1{margin:0 0 12px;color:var(--ml-blue)}
header a{
  display:block;background:var(--ml-accent);color:#fff;
  text-decoration:none;padding:12px;border-radius:12px;font-weight:700;
}
.content{padding:18px}
select,button,input{
  padding:10px;border-radius:10px;border:1px solid var(--border);
}
button{background:var(--ml-blue);color:#fff;border:none;font-weight:700}
.week-nav{display:grid;grid-template-columns:1fr auto 1fr;gap:10px;margin:10px 0}
.day{
  border:1px solid #eef2f7;border-radius:14px;
  padding:14px;margin-bottom:12px;background:#fff;
}
.day h3{margin:0 0 8px}
.grid{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(140px,1fr));
  gap:8px;font-size:14px;
}
.grid label{font-weight:700;font-size:12px}
.total{background:#f8fafc;font-weight:800}
.note{font-size:13px;color:#6b7280}
</style>
</head>

<body>
<div class="shell">
<header>
  <h1>Timesheet Admin</h1>
  <a href="main.html">Main Menu</a>
</header>

<div class="content">

<select id="userSelect"></select>

<div class="week-nav">
  <button id="prevWeek">◀</button>
  <div id="weekLabel" style="text-align:center;font-weight:800"></div>
  <button id="nextWeek">▶</button>
</div>

<button id="loadBtn">Load Timesheet</button>

<div id="output"></div>
<div id="status" class="note"></div>

</div>
</div>

<script>
const TIMESHEET_WORKER="https://timesheet-admin.jamie-def.workers.dev";
const USERS_WORKER="https://mostlane-users.jamie-def.workers.dev";

const RATE_FUEL=0.25;        // £/mile
const RATE_TRAVEL=12.00;    // £/hour
const RATE_STANDARD=12.00;
const RATE_OT=18.00;

function startOfWeek(d){
  d=new Date(d);const day=d.getDay()||7;
  d.setDate(d.getDate()-day+1);d.setHours(0,0,0,0);return d;
}
function endOfWeek(d){
  const x=new Date(d);x.setDate(x.getDate()+6);
  x.setHours(23,59,59,999);return x;
}
function iso(d){return d.toISOString().slice(0,10)}
function nice(d){
  return d.toLocaleDateString("en-GB",{weekday:"long",day:"numeric",month:"short"});
}

let weekStart=startOfWeek(new Date());

const userSelect=document.getElementById("userSelect");
const output=document.getElementById("output");
const statusEl=document.getElementById("status");
const weekLabel=document.getElementById("weekLabel");

async function loadUsers(){
  const r=await fetch(`${USERS_WORKER}/users`);
  const j=await r.json();
  userSelect.innerHTML=j.Users
    .filter(u=>(u.Status||"Active")==="Active")
    .map(u=>`<option>${u.Username}</option>`).join("");
}

async function loadWeek(){
  const user=userSelect.value;
  if(!user) return;

  const year=weekStart.getFullYear();
  const month=String(weekStart.getMonth()+1).padStart(2,"0");

  weekLabel.textContent=`${nice(weekStart)} → ${nice(endOfWeek(weekStart))}`;
  output.innerHTML="";statusEl.textContent="Loading…";

  const r=await fetch(`${TIMESHEET_WORKER}/admin/timesheet?user=${user}&year=${year}&month=${month}`);
  const j=await r.json();

  const days=(j.days||[]).filter(d=>{
    const x=new Date(d.date+"T00:00:00");
    return x>=weekStart&&x<=endOfWeek(weekStart);
  });

  if(!days.length){
    statusEl.textContent="No check-ins / outs recorded for this week.";
    return;
  }

  let totOn=0,totTrav=0,totFuel=0,totPay=0;

  days.forEach(d=>{
    const fuelPay=d.fuelMiles*RATE_FUEL;
    const travelPay=d.travelHours*RATE_TRAVEL;
    const onsitePay=d.onsiteHours*RATE_STANDARD;

    totOn+=d.onsiteHours;
    totTrav+=d.travelHours;
    totFuel+=d.fuelMiles;
    totPay+=fuelPay+travelPay+onsitePay;

    output.innerHTML+=`
      <div class="day">
        <h3>${nice(new Date(d.date+"T00:00:00"))}</h3>
        <div class="grid">
          <div><label>On-site (h)</label><input type="number" step="0.01" value="${d.onsiteHours}"></div>
          <div><label>Travel (h)</label><input type="number" step="0.01" value="${d.travelHours}"></div>
          <div><label>Fuel (mi)</label><input type="number" step="0.1" value="${d.fuelMiles}"></div>
          <div><label>Fuel £</label>£${fuelPay.toFixed(2)}</div>
          <div><label>Travel £</label>£${travelPay.toFixed(2)}</div>
          <div><label>On-site £</label>£${onsitePay.toFixed(2)}</div>
        </div>
        <div class="note">${d.firstSite||"—"} → ${d.lastSite||"—"}</div>
      </div>
    `;
  });

  output.innerHTML+=`
    <div class="day total">
      <h3>Week totals</h3>
      <div class="grid">
        <div>On-site: ${totOn.toFixed(2)} h</div>
        <div>Travel: ${totTrav.toFixed(2)} h</div>
        <div>Fuel: ${totFuel.toFixed(1)} mi</div>
        <div>Total pay: £${totPay.toFixed(2)}</div>
      </div>
      <div class="note">Travel is paid but does not count toward overtime.</div>
    </div>
  `;

  statusEl.textContent="Ready";
}

document.getElementById("prevWeek").onclick=()=>{weekStart.setDate(weekStart.getDate()-7);loadWeek();}
document.getElementById("nextWeek").onclick=()=>{weekStart.setDate(weekStart.getDate()+7);loadWeek();}
document.getElementById("loadBtn").onclick=loadWeek;

(async()=>{
  await loadUsers();
  loadWeek();
})();
</script>
</body>
</html>
