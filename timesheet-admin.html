<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Timesheet Admin – Mostlane</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>

<style>
:root{
  --ml-blue:#003366;
  --ml-accent:#1a73e8;
  --ml-bg:#e6e8eb;
  --ink:#27313a;
  --border:#e5e7eb;
  --muted:#6b7280;
}

body{
  margin:0;
  font-family:"Segoe UI",system-ui,Arial,sans-serif;
  background:var(--ml-bg) url('Mostlane_Embossed.png') no-repeat center center fixed;
  background-size:180% auto;
  padding:16px;
  color:var(--ink);
}

.shell{
  max-width:1000px;
  margin:0 auto;
  background:rgba(255,255,255,.95);
  border-radius:16px;
  box-shadow:0 12px 28px rgba(0,0,0,.12);
  overflow:hidden;
}

header{
  padding:18px;
  text-align:center;
}

header h1{
  margin:0 0 10px;
  color:var(--ml-blue);
}

header a{
  display:block;
  padding:10px;
  border-radius:10px;
  background:var(--ml-accent);
  color:#fff;
  font-weight:700;
  text-decoration:none;
}

.content{padding:18px;}

.controls{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(180px,1fr));
  gap:10px;
  margin-bottom:18px;
}

.controls select,
.controls input,
.controls button{
  padding:10px;
  border-radius:12px;
  border:1px solid var(--border);
  font-weight:600;
  background:#f8fafc;
}

.controls button{
  background:#003366;
  color:#fff;
  cursor:pointer;
}

.card{
  background:#fff;
  border:1px solid #eef2f7;
  border-radius:14px;
  padding:14px;
  margin-bottom:12px;
}

.day-title{
  font-weight:800;
  margin-bottom:8px;
}

.kv{
  display:flex;
  flex-wrap:wrap;
  gap:12px;
  font-size:14px;
}

.kv span{
  min-width:160px;
}

.total{
  background:#f8fafc;
  border:1px solid var(--border);
}

.small{
  font-size:12px;
  color:var(--muted);
}

.badge{
  padding:4px 10px;
  border-radius:999px;
  font-size:12px;
  font-weight:700;
  border:1px solid var(--border);
  background:#f8fafc;
}

</style>
</head>

<body>
<div class="shell">
  <header>
    <h1>Timesheet Admin</h1>
    <a href="main.html">Main Menu</a>
  </header>

  <div class="content">

    <!-- CONTROLS -->
    <div class="controls">
      <select id="userSelect"></select>
      <input id="yearInput" type="number" min="2024" value="2026">
      <select id="monthInput">
        <option value="01">January</option><option value="02">February</option>
        <option value="03">March</option><option value="04">April</option>
        <option value="05">May</option><option value="06">June</option>
        <option value="07">July</option><option value="08">August</option>
        <option value="09">September</option><option value="10">October</option>
        <option value="11">November</option><option value="12">December</option>
      </select>
      <button id="loadBtn">Load Timesheet</button>
    </div>

    <!-- OUTPUT -->
    <div id="output"></div>
    <div id="status" class="small"></div>

  </div>
</div>

<script>
/* ===============================
   CONFIG
=============================== */
const WORKER = "https://timesheet-admin.jamie-def.workers.dev";

/* ===============================
   DOM
=============================== */
const userSelect = document.getElementById("userSelect");
const yearInput = document.getElementById("yearInput");
const monthInput = document.getElementById("monthInput");
const output = document.getElementById("output");
const statusEl = document.getElementById("status");

/* ===============================
   HELPERS
=============================== */
async function getJSON(url){
  const r = await fetch(url);
  if(!r.ok) throw new Error("Fetch failed");
  return r.json();
}

/* ===============================
   LOAD USERS (simple heuristic)
   Uses existing users from main portal
=============================== */
async function loadUsers(){
  const res = await fetch("https://mostlane-users.jamie-def.workers.dev/users");
  const data = await res.json();
  const users = data.Users || [];
  userSelect.innerHTML = users.map(u =>
    `<option value="${u.Username}">${u.Username}</option>`
  ).join("");
}

/* ===============================
   LOAD TIMESHEET
=============================== */
async function loadTimesheet(){
  const user = userSelect.value;
  const year = yearInput.value;
  const month = monthInput.value;

  if(!user) return;

  statusEl.textContent = "Loading…";
  output.innerHTML = "";

  try{
    const url = `${WORKER}/admin/timesheet?user=${encodeURIComponent(user)}&year=${year}&month=${month}`;
    const data = await getJSON(url);

    if(!data.days || !data.days.length){
      output.innerHTML = `<div class="card">No data for this period.</div>`;
      statusEl.textContent = "Ready";
      return;
    }

    let totOn=0, totTravel=0, totFuel=0;

    data.days.forEach(d=>{
      totOn += d.onsiteHours;
      totTravel += d.travelHours;
      totFuel += d.fuelMiles;

      output.innerHTML += `
        <div class="card">
          <div class="day-title">${d.date}</div>
          <div class="kv">
            <span><b>On-site:</b> ${d.onsiteHours.toFixed(2)} h</span>
            <span><b>Travel:</b> ${d.travelHours.toFixed(2)} h</span>
            <span><b>Fuel:</b> ${d.fuelMiles.toFixed(2)} mi</span>
            <span><b>First site:</b> ${d.firstSite || "—"}</span>
            <span><b>Last site:</b> ${d.lastSite || "—"}</span>
          </div>
        </div>
      `;
    });

    output.innerHTML =
      `<div class="card total">
        <div class="day-title">Totals</div>
        <div class="kv">
          <span><b>On-site:</b> ${totOn.toFixed(2)} h</span>
          <span><b>Travel:</b> ${totTravel.toFixed(2)} h</span>
          <span><b>Fuel:</b> ${totFuel.toFixed(2)} mi</span>
        </div>
        <div class="small">Travel time does not count toward overtime.</div>
      </div>` + output.innerHTML;

    statusEl.textContent = "Ready";
  }
  catch(e){
    console.error(e);
    output.innerHTML = `<div class="card">Failed to load data.</div>`;
    statusEl.textContent = "Error";
  }
}

/* ===============================
   INIT
=============================== */
document.getElementById("loadBtn").onclick = loadTimesheet;

(async()=>{
  await loadUsers();
  loadTimesheet();
})();
</script>
</body>
</html>
