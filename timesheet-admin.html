<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Timesheet Admin – Mostlane</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
:root{
  --ml-blue:#003366;
  --ml-accent:#1a73e8;
  --ml-bg:#e6e8eb;
  --border:#e5e7eb;
}

body{
  margin:0;
  padding:16px;
  font-family:"Segoe UI",system-ui,Arial;
  background:var(--ml-bg) url('Mostlane_Embossed.png') no-repeat center center fixed;
  background-size:180% auto;
}

.shell{
  max-width:900px;
  margin:auto;
  background:rgba(255,255,255,.96);
  border-radius:16px;
  box-shadow:0 12px 28px rgba(0,0,0,.12);
  overflow:hidden;
}

header{
  padding:18px;
  text-align:center;
}

header h1{
  margin:0 0 12px;
  color:var(--ml-blue);
}

header a{
  display:block;
  background:var(--ml-accent);
  color:#fff;
  text-decoration:none;
  padding:12px;
  border-radius:12px;
  font-weight:700;
}

.content{padding:18px;}

select,button{
  width:100%;
  padding:12px;
  border-radius:12px;
  border:1px solid var(--border);
  font-weight:700;
}

button{
  background:var(--ml-blue);
  color:#fff;
  border:none;
}

.week-nav{
  display:grid;
  grid-template-columns:1fr auto 1fr;
  gap:10px;
  margin:10px 0;
}

.day{
  background:#fff;
  border:1px solid #eef2f7;
  border-radius:14px;
  padding:14px;
  margin-bottom:12px;
}

.day h3{
  margin:0 0 6px;
}

.kv{
  display:flex;
  flex-wrap:wrap;
  gap:10px;
  font-size:14px;
}

.note{
  font-size:13px;
  color:#6b7280;
}
</style>
</head>

<body>
<div class="shell">
<header>
  <h1>Timesheet Admin</h1>
  <a href="main.html">Main Menu</a>
</header>

<div class="content">

  <select id="userSelect"></select>

  <div class="week-nav">
    <button id="prevWeek">◀</button>
    <div id="weekLabel" style="text-align:center;font-weight:800;"></div>
    <button id="nextWeek">▶</button>
  </div>

  <button id="loadBtn">Load Timesheet</button>

  <div id="output"></div>
  <div id="status" class="note"></div>

</div>
</div>

<script>
/* ================= CONFIG ================= */
const TIMESHEET_WORKER = "https://timesheet-admin.jamie-def.workers.dev";
const USERS_WORKER     = "https://mostlane-users.jamie-def.workers.dev";

/* ================= HELPERS ================= */
function startOfWeek(d){
  d=new Date(d);
  const day=d.getDay()||7;
  d.setDate(d.getDate()-day+1);
  d.setHours(0,0,0,0);
  return d;
}
function endOfWeek(d){
  const x=new Date(d);
  x.setDate(x.getDate()+6);
  x.setHours(23,59,59,999);
  return x;
}
function iso(d){return d.toISOString().slice(0,10);}
function nice(d){
  return d.toLocaleDateString("en-GB",{weekday:"long",day:"numeric",month:"short"});
}

/* ================= STATE ================= */
let weekStart = startOfWeek(new Date());

const userSelect = document.getElementById("userSelect");
const output = document.getElementById("output");
const statusEl = document.getElementById("status");
const weekLabel = document.getElementById("weekLabel");

/* ================= LOAD USERS ================= */
async function loadUsers(){
  const r = await fetch(`${USERS_WORKER}/users`);
  const j = await r.json();

  const users = (j.Users || [])
    .filter(u => (u.Status || "Active") === "Active")
    .map(u => u.Username)
    .sort();

  userSelect.innerHTML = users.map(u=>`<option>${u}</option>`).join("");
}

/* ================= LOAD WEEK ================= */
async function loadWeek(){
  const user = userSelect.value;
  if(!user) return;

  const year = weekStart.getFullYear();
  const month = String(weekStart.getMonth()+1).padStart(2,"0");

  weekLabel.textContent =
    `${nice(weekStart)} → ${nice(endOfWeek(weekStart))}`;

  output.innerHTML="";
  statusEl.textContent="Loading…";

  const r = await fetch(
    `${TIMESHEET_WORKER}/admin/timesheet?user=${encodeURIComponent(user)}&year=${year}&month=${month}`
  );
  const j = await r.json();

  if(!j.days || !j.days.length){
    statusEl.textContent="No check-ins or check-outs recorded.";
    return;
  }

  const weekDays = j.days.filter(d=>{
    const x=new Date(d.date+"T00:00:00");
    return x>=weekStart && x<=endOfWeek(weekStart);
  });

  if(!weekDays.length){
    statusEl.textContent="No check-ins or check-outs recorded for this week.";
    return;
  }

  let totOn=0, totTrav=0, totFuel=0;

  weekDays.forEach(d=>{
    totOn+=d.onsiteHours;
    totTrav+=d.travelHours;
    totFuel+=d.fuelMiles;

    output.innerHTML+=`
      <div class="day">
        <h3>${nice(new Date(d.date+"T00:00:00"))}</h3>
        <div class="kv">
          <span><b>On-site:</b> ${d.onsiteHours.toFixed(2)} h</span>
          <span><b>Travel:</b> ${d.travelHours.toFixed(2)} h</span>
          <span><b>Fuel:</b> ${d.fuelMiles.toFixed(1)} mi</span>
        </div>
        <div class="kv">
          <span><b>First site:</b> ${d.firstSite||"—"}</span>
          <span><b>Last site:</b> ${d.lastSite||"—"}</span>
        </div>
      </div>
    `;
  });

  output.innerHTML+=`
    <div class="day">
      <h3>Week totals</h3>
      <div class="kv">
        <span><b>On-site:</b> ${totOn.toFixed(2)} h</span>
        <span><b>Travel:</b> ${totTrav.toFixed(2)} h</span>
        <span><b>Fuel:</b> ${totFuel.toFixed(1)} mi</span>
      </div>
      <div class="note">
        Travel is paid at standard rate and does not count toward the 10-hour overtime threshold.
      </div>
    </div>
  `;

  statusEl.textContent="Ready";
}

/* ================= EVENTS ================= */
document.getElementById("prevWeek").onclick=()=>{weekStart.setDate(weekStart.getDate()-7);loadWeek();};
document.getElementById("nextWeek").onclick=()=>{weekStart.setDate(weekStart.getDate()+7);loadWeek();};
document.getElementById("loadBtn").onclick=loadWeek;

/* ================= INIT ================= */
(async()=>{
  await loadUsers();
  loadWeek();
})();
</script>
</body>
</html>
