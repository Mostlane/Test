<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Timesheet Admin – Mostlane</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
:root{
  --ml-blue:#003366;
  --ml-accent:#1a73e8;
  --ml-bg:#e6e8eb;
  --ink:#27313a;
  --border:#e5e7eb;
  --ok:#15803d;
  --warn:#b91c1c;
}

html,body{margin:0;padding:0;background:var(--ml-bg);font-family:"Segoe UI",system-ui,Arial;}

body{
  background:var(--ml-bg) url('Mostlane_Embossed.png') no-repeat center center fixed;
  background-size:180% auto;
  padding:16px;
}

.shell{
  max-width:900px;
  margin:0 auto;
  background:rgba(255,255,255,0.96);
  border-radius:16px;
  box-shadow:0 12px 28px rgba(0,0,0,.12);
  overflow:hidden;
}

header{
  padding:18px;
  text-align:center;
}

header h1{
  margin:0 0 12px;
  color:var(--ml-blue);
}

header a{
  display:block;
  background:var(--ml-accent);
  color:#fff;
  text-decoration:none;
  padding:12px;
  border-radius:12px;
  font-weight:700;
}

.content{padding:18px;}

.controls{
  display:grid;
  gap:10px;
  margin-bottom:16px;
}

.controls select,
.controls button{
  padding:12px;
  border-radius:12px;
  border:1px solid var(--border);
  font-weight:700;
}

button{
  background:var(--ml-blue);
  color:#fff;
  border:none;
}

.week-nav{
  display:grid;
  grid-template-columns:1fr auto 1fr;
  gap:10px;
}

.day-card{
  background:#fff;
  border:1px solid #eef2f7;
  border-radius:14px;
  padding:14px;
  margin-bottom:14px;
}

.day-title{
  font-weight:800;
  color:#111827;
  margin-bottom:8px;
}

.kv{
  display:flex;
  flex-wrap:wrap;
  gap:10px;
  font-size:14px;
}

.kv span{
  min-width:140px;
}

.badge{
  padding:4px 10px;
  border-radius:999px;
  font-size:12px;
  font-weight:800;
}

.badge.ok{background:#ecfdf3;color:var(--ok);}
.badge.warn{background:#fef2f2;color:var(--warn);}

.summary{
  background:#f8fafc;
  border:1px solid var(--border);
  border-radius:14px;
  padding:14px;
  margin-top:16px;
}

.note{
  margin-top:10px;
  font-size:13px;
  color:#6b7280;
}
</style>
</head>

<body>
<div class="shell">
<header>
  <h1>Timesheet Admin</h1>
  <a href="main.html">Main Menu</a>
</header>

<div class="content">

  <div class="controls">
    <select id="userSelect"></select>

    <div class="week-nav">
      <button id="prevWeek">◀</button>
      <div id="weekLabel" style="text-align:center;font-weight:800;">—</div>
      <button id="nextWeek">▶</button>
    </div>

    <button id="loadBtn">Load Timesheet</button>
  </div>

  <div id="output"></div>
  <div id="status" class="note"></div>

</div>
</div>

<script>
const WORKER = "https://ckeck-in-out.jamie-def.workers.dev";

const output = document.getElementById("output");
const statusEl = document.getElementById("status");
const weekLabel = document.getElementById("weekLabel");
const userSelect = document.getElementById("userSelect");

let currentWeekStart = startOfWeek(new Date());

function startOfWeek(d){
  d=new Date(d);
  const day=d.getDay()||7;
  d.setDate(d.getDate()-day+1);
  d.setHours(0,0,0,0);
  return d;
}

function endOfWeek(d){
  const x=new Date(d);
  x.setDate(x.getDate()+6);
  x.setHours(23,59,59,999);
  return x;
}

function iso(d){return d.toISOString().slice(0,10);}

function niceDate(d){
  return d.toLocaleDateString("en-GB",{weekday:"long",day:"numeric",month:"short"});
}

async function loadUsers(){
  // simple static list for now (same as your system behaviour)
  const me = sessionStorage.getItem("mostlaneUser");
  userSelect.innerHTML = `<option>${me}</option>`;
}

async function loadWeek(){
  const user = userSelect.value;
  if(!user) return;

  const year = currentWeekStart.getFullYear();
  const month = String(currentWeekStart.getMonth()+1).padStart(2,"0");

  weekLabel.textContent =
    niceDate(currentWeekStart) + " → " + niceDate(endOfWeek(currentWeekStart));

  output.innerHTML = "";
  statusEl.textContent = "Loading…";

  try{
    const res = await fetch(
      `${WORKER}/admin/timesheet?user=${encodeURIComponent(user)}&year=${year}&month=${month}`
    );
    const data = await res.json();

    if(!data.days || !data.days.length){
      statusEl.textContent = "No check-ins or check-outs recorded for this user in this period.";
      return;
    }

    const weekDays = data.days.filter(d=>{
      const x=new Date(d.date+"T00:00:00");
      return x>=currentWeekStart && x<=endOfWeek(currentWeekStart);
    });

    if(!weekDays.length){
      statusEl.textContent = "No check-ins or check-outs recorded for this week.";
      return;
    }

    let totOn=0, totTrav=0, totFuel=0;

    weekDays.forEach(d=>{
      totOn+=d.onsiteHours;
      totTrav+=d.travelHours;
      totFuel+=d.fuelMiles;

      output.innerHTML += `
        <div class="day-card">
          <div class="day-title">${niceDate(new Date(d.date+"T00:00:00"))}</div>
          <div class="kv">
            <span><b>On-site:</b> ${d.onsiteHours.toFixed(2)} h</span>
            <span><b>Travel:</b> ${d.travelHours.toFixed(2)} h</span>
            <span><b>Fuel:</b> ${d.fuelMiles.toFixed(1)} mi</span>
            <span class="badge ok">✔ Processed</span>
          </div>
          <div class="kv">
            <span><b>First site:</b> ${d.firstSite||"—"}</span>
            <span><b>Last site:</b> ${d.lastSite||"—"}</span>
          </div>
        </div>
      `;
    });

    output.innerHTML += `
      <div class="summary">
        <div class="kv">
          <span><b>Total on-site:</b> ${totOn.toFixed(2)} h</span>
          <span><b>Total travel:</b> ${totTrav.toFixed(2)} h</span>
          <span><b>Total fuel:</b> ${totFuel.toFixed(1)} mi</span>
        </div>
        <div class="note">
          Travel is paid at standard rate and does not count toward the 10-hour overtime threshold.
        </div>
      </div>
    `;

    statusEl.textContent = "Ready";

  }catch(e){
    statusEl.textContent = "Unable to load data.";
    console.error(e);
  }
}

document.getElementById("prevWeek").onclick=()=>{
  currentWeekStart.setDate(currentWeekStart.getDate()-7);
  loadWeek();
};
document.getElementById("nextWeek").onclick=()=>{
  currentWeekStart.setDate(currentWeekStart.getDate()+7);
  loadWeek();
};
document.getElementById("loadBtn").onclick=loadWeek;

loadUsers();
loadWeek();
</script>
</body>
</html>
